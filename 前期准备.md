## å‰æœŸå‡†å¤‡

åœ¨åšä¸‹é¢ğŸ‘‡çš„é¢˜ç›®ä¹‹å‰ï¼Œæˆ‘å¸Œæœ›ä½ èƒ½æ¸…æ¥šå‡ ä¸ªçŸ¥è¯†ç‚¹ã€‚

(å¦‚æœä½ æ„Ÿè§‰ä¸€ä¸Šæ¥ä¸æƒ³çœ‹è¿™äº›åˆ—ä¸¾çš„çŸ¥è¯†ç‚¹çš„è¯ï¼Œç›´æ¥çœ‹åé¢çš„ä¾‹å­å†æ¥ç†è§£å®ƒä»¬ä¹Ÿå¯ä»¥)

**`event loop`å®ƒçš„æ‰§è¡Œé¡ºåºï¼š**

- ä¸€å¼€å§‹æ•´ä¸ªè„šæœ¬ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œ
- æ‰§è¡Œè¿‡ç¨‹ä¸­åŒæ­¥ä»£ç ç›´æ¥æ‰§è¡Œï¼Œå®ä»»åŠ¡è¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¾®ä»»åŠ¡è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œå‡ºé˜Ÿï¼Œæ£€æŸ¥å¾®ä»»åŠ¡åˆ—è¡¨ï¼Œæœ‰åˆ™ä¾æ¬¡æ‰§è¡Œï¼Œç›´åˆ°å…¨éƒ¨æ‰§è¡Œå®Œ
- æ‰§è¡Œæµè§ˆå™¨UIçº¿ç¨‹çš„æ¸²æŸ“å·¥ä½œ
- æ£€æŸ¥æ˜¯å¦æœ‰`Web Worker`ä»»åŠ¡ï¼Œæœ‰åˆ™æ‰§è¡Œ
- æ‰§è¡Œå®Œæœ¬è½®çš„å®ä»»åŠ¡ï¼Œå›åˆ°2ï¼Œä¾æ­¤å¾ªç¯ï¼Œç›´åˆ°å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—éƒ½ä¸ºç©º

**å¾®ä»»åŠ¡åŒ…æ‹¬ï¼š**`MutationObserver`ã€`Promise.then()æˆ–catch()`ã€`Promiseä¸ºåŸºç¡€å¼€å‘çš„å…¶å®ƒæŠ€æœ¯ï¼Œæ¯”å¦‚fetch API`ã€`V8`çš„åƒåœ¾å›æ”¶è¿‡ç¨‹ã€`Nodeç‹¬æœ‰çš„process.nextTick`ã€‚

**å®ä»»åŠ¡åŒ…æ‹¬**ï¼š`script` ã€`setTimeout`ã€`setInterval` ã€`setImmediate` ã€`I/O` ã€`UI rendering`ã€‚

**æ³¨æ„**âš ï¸ï¼šåœ¨æ‰€æœ‰ä»»åŠ¡å¼€å§‹çš„æ—¶å€™ï¼Œç”±äºå®ä»»åŠ¡ä¸­åŒ…æ‹¬äº†`script`ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¼šå…ˆæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä½ çœ‹åˆ°çš„å»¶è¿Ÿä»»åŠ¡(ä¾‹å¦‚`setTimeout`)å°†è¢«æ”¾åˆ°ä¸‹ä¸€è½®å®ä»»åŠ¡ä¸­æ¥æ‰§è¡Œã€‚

### 1. Promiseçš„å‡ é“åŸºç¡€é¢˜

#### 1.1 é¢˜ç›®ä¸€

```arcade
const promise1 = new Promise((resolve, reject) => {
  console.log('promise1')
})
console.log('1', promise1);å¤åˆ¶ä»£ç 
```

è¿‡ç¨‹åˆ†æï¼š

- ä»ä¸Šè‡³ä¸‹ï¼Œå…ˆé‡åˆ°`new Promise`ï¼Œæ‰§è¡Œè¯¥æ„é€ å‡½æ•°ä¸­çš„ä»£ç `promise1`
- ç„¶åæ‰§è¡ŒåŒæ­¥ä»£ç `1`ï¼Œæ­¤æ—¶`promise1`æ²¡æœ‰è¢«`resolve`æˆ–è€…`reject`ï¼Œå› æ­¤çŠ¶æ€è¿˜æ˜¯`pending`

ç»“æœï¼š

```coffeescript
'promise1'
'1' Promise{<pending>}å¤åˆ¶ä»£ç 
```

#### 1.2 é¢˜ç›®äºŒ

```arcade
const promise = new Promise((resolve, reject) => {
  console.log(1);
  resolve('success')
  console.log(2);
});
promise.then(() => {
  console.log(3);
});
console.log(4);å¤åˆ¶ä»£ç 
```

è¿‡ç¨‹åˆ†æï¼š

- ä»ä¸Šè‡³ä¸‹ï¼Œå…ˆé‡åˆ°`new Promise`ï¼Œæ‰§è¡Œå…¶ä¸­çš„åŒæ­¥ä»£ç `1`
- å†é‡åˆ°`resolve('success')`ï¼Œ å°†`promise`çš„çŠ¶æ€æ”¹ä¸ºäº†`resolved`å¹¶ä¸”å°†å€¼ä¿å­˜ä¸‹æ¥
- ç»§ç»­æ‰§è¡ŒåŒæ­¥ä»£ç `2`
- è·³å‡º`promise`ï¼Œå¾€ä¸‹æ‰§è¡Œï¼Œç¢°åˆ°`promise.then`è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œå°†å…¶åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- æ‰§è¡ŒåŒæ­¥ä»£ç `4`
- æœ¬è½®å®ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œæ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç°`promise.then`è¿™ä¸ªå¾®ä»»åŠ¡ä¸”çŠ¶æ€ä¸º`resolved`ï¼Œæ‰§è¡Œå®ƒã€‚

ç»“æœï¼š

```basic
1 2 4 3å¤åˆ¶ä»£ç 
```

#### 1.3 é¢˜ç›®ä¸‰

```arcade
const promise = new Promise((resolve, reject) => {
  console.log(1);
  console.log(2);
});
promise.then(() => {
  console.log(3);
});
console.log(4);å¤åˆ¶ä»£ç 
```

è¿‡ç¨‹åˆ†æ

- å’Œé¢˜ç›®äºŒç›¸ä¼¼ï¼Œåªä¸è¿‡åœ¨`promise`ä¸­å¹¶æ²¡æœ‰`resolve`æˆ–è€…`reject`
- å› æ­¤`promise.then`å¹¶ä¸ä¼šæ‰§è¡Œï¼Œå®ƒåªæœ‰åœ¨è¢«æ”¹å˜äº†çŠ¶æ€ä¹‹åæ‰ä¼šæ‰§è¡Œã€‚

ç»“æœï¼š

```basic
1 2 4å¤åˆ¶ä»£ç 
```

#### 1.4 é¢˜ç›®å››

```arcade
const promise1 = new Promise((resolve, reject) => {
  console.log('promise1')
  resolve('resolve1')
})
const promise2 = promise1.then(res => {
  console.log(res)
})
console.log('1', promise1);
console.log('2', promise2);å¤åˆ¶ä»£ç 
```

è¿‡ç¨‹åˆ†æï¼š

- ä»ä¸Šè‡³ä¸‹ï¼Œå…ˆé‡åˆ°`new Promise`ï¼Œæ‰§è¡Œè¯¥æ„é€ å‡½æ•°ä¸­çš„ä»£ç `promise1`
- ç¢°åˆ°`resolve`å‡½æ•°, å°†`promise1`çš„çŠ¶æ€æ”¹å˜ä¸º`resolved`, å¹¶å°†ç»“æœä¿å­˜ä¸‹æ¥
- ç¢°åˆ°`promise1.then`è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œå°†å®ƒæ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- `promise2`æ˜¯ä¸€ä¸ªæ–°çš„çŠ¶æ€ä¸º`pending`çš„`Promise`
- æ‰§è¡ŒåŒæ­¥ä»£ç `1`ï¼Œ åŒæ—¶æ‰“å°å‡º`promise1`çš„çŠ¶æ€æ˜¯`resolved`
- æ‰§è¡ŒåŒæ­¥ä»£ç `2`ï¼ŒåŒæ—¶æ‰“å°å‡º`promise2`çš„çŠ¶æ€æ˜¯`pending`
- å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼ŒæŸ¥æ‰¾å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç°`promise1.then`è¿™ä¸ªå¾®ä»»åŠ¡ä¸”çŠ¶æ€ä¸º`resolved`ï¼Œæ‰§è¡Œå®ƒã€‚

ç»“æœï¼š

```coffeescript
'promise1'
'1' Promise{<resolved>: 'resolve1'}
'2' Promise{<pending>}
'resolve1'å¤åˆ¶ä»£ç 
```

#### 1.5 é¢˜ç›®äº”

æ¥ä¸‹æ¥çœ‹çœ‹è¿™é“é¢˜ï¼š

```arcade
const fn = () => (new Promise((resolve, reject) => {
  console.log(1);
  resolve('success')
}))
fn().then(res => {
  console.log(res)
})
console.log('start')å¤åˆ¶ä»£ç 
```

è¿™é“é¢˜é‡Œæœ€å…ˆæ‰§è¡Œçš„æ˜¯`'start'`å— ğŸ¤”ï¸ ï¼Ÿ

è¯·ä»”ç»†çœ‹çœ‹å“¦ï¼Œ`fn`å‡½æ•°å®ƒæ˜¯ç›´æ¥è¿”å›äº†ä¸€ä¸ª`new Promise`çš„ï¼Œè€Œä¸”`fn`å‡½æ•°çš„è°ƒç”¨æ˜¯åœ¨`start`ä¹‹å‰ï¼Œæ‰€ä»¥å®ƒé‡Œé¢çš„å†…å®¹åº”è¯¥ä¼šå…ˆæ‰§è¡Œã€‚

ç»“æœï¼š

```scheme
1
'start'
'success'å¤åˆ¶ä»£ç 
```

#### 1.6 é¢˜ç›®å…­

å¦‚æœæŠŠ`fn`çš„è°ƒç”¨æ”¾åˆ°`start`ä¹‹åå‘¢ï¼Ÿ

```arcade
const fn = () =>
  new Promise((resolve, reject) => {
    console.log(1);
    resolve("success");
  });
console.log("start");
fn().then(res => {
  console.log(res);
});å¤åˆ¶ä»£ç 
```

æ˜¯çš„ï¼Œç°åœ¨`start`å°±åœ¨`1`ä¹‹å‰æ‰“å°å‡ºæ¥äº†ï¼Œå› ä¸º`fn`å‡½æ•°æ˜¯ä¹‹åæ‰§è¡Œçš„ã€‚

**æ³¨æ„âš ï¸**ï¼šä¹‹å‰æˆ‘ä»¬å¾ˆå®¹æ˜“å°±ä»¥ä¸ºçœ‹åˆ°new Promise()å°±æ‰§è¡Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°å‡½æ•°äº†ï¼Œå…¶å®è¿™æ˜¯ä¸å¯¹çš„ï¼Œå°±åƒè¿™ä¸¤é“é¢˜ä¸­ï¼Œæˆ‘ä»¬å¾—æ³¨æ„å®ƒæ˜¯ä¸æ˜¯è¢«åŒ…è£¹åœ¨å‡½æ•°å½“ä¸­ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåªæœ‰åœ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œã€‚

ç­”æ¡ˆï¼š

```1c
"start"
1
"success"å¤åˆ¶ä»£ç 
```

å¥½å˜ï¼Œå­¦å®Œäº†è¿™å‡ é“åŸºç¡€é¢˜ï¼Œè®©æˆ‘ä»¬æ¥ç”¨ä¸ªè¡¨æƒ…åŒ…å‹å‹æƒŠã€‚



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708bb6c5b5d2a70~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



### 2. Promiseç»“åˆsetTimeout

#### 2.1 é¢˜ç›®ä¸€

```arcade
console.log('start')
setTimeout(() => {
  console.log('time')
})
Promise.resolve().then(() => {
  console.log('resolve')
})
console.log('end')å¤åˆ¶ä»£ç 
```

è¿‡ç¨‹åˆ†æï¼š

- åˆšå¼€å§‹æ•´ä¸ªè„šæœ¬ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡æ¥æ‰§è¡Œï¼Œå¯¹äºåŒæ­¥ä»£ç ç›´æ¥å‹å…¥æ‰§è¡Œæ ˆè¿›è¡Œæ‰§è¡Œï¼Œå› æ­¤å…ˆæ‰“å°å‡º`start`å’Œ`end`ã€‚
- `setTimout`ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡è¢«æ”¾å…¥å®ä»»åŠ¡é˜Ÿåˆ—(ä¸‹ä¸€ä¸ª)
- `Promise.then`ä½œä¸ºä¸€ä¸ªå¾®ä»»åŠ¡è¢«æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- æœ¬æ¬¡å®ä»»åŠ¡æ‰§è¡Œå®Œï¼Œæ£€æŸ¥å¾®ä»»åŠ¡ï¼Œå‘ç°`Promise.then`ï¼Œæ‰§è¡Œå®ƒ
- æ¥ä¸‹æ¥è¿›å…¥ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼Œå‘ç°`setTimeout`ï¼Œæ‰§è¡Œã€‚

ç»“æœï¼š

```scheme
'start'
'end'
'resolve'
'time'å¤åˆ¶ä»£ç 
```

#### 2.2 é¢˜ç›®äºŒ

```arcade
const promise = new Promise((resolve, reject) => {
  console.log(1);
  setTimeout(() => {
    console.log("timerStart");
    resolve("success");
    console.log("timerEnd");
  }, 0);
  console.log(2);
});
promise.then((res) => {
  console.log(res);
});
console.log(4);å¤åˆ¶ä»£ç 
```

è¿‡ç¨‹åˆ†æï¼š

å’Œé¢˜ç›®`1.2`å¾ˆåƒï¼Œä¸è¿‡åœ¨`resolve`çš„å¤–å±‚åŠ äº†ä¸€å±‚`setTimeout`å®šæ—¶å™¨ã€‚

- ä»ä¸Šè‡³ä¸‹ï¼Œå…ˆé‡åˆ°`new Promise`ï¼Œæ‰§è¡Œè¯¥æ„é€ å‡½æ•°ä¸­çš„ä»£ç `1`
- ç„¶åç¢°åˆ°äº†å®šæ—¶å™¨ï¼Œå°†è¿™ä¸ªå®šæ—¶å™¨ä¸­çš„å‡½æ•°æ”¾åˆ°ä¸‹ä¸€ä¸ªå®ä»»åŠ¡çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ
- æ‰§è¡ŒåŒæ­¥ä»£ç `2`
- è·³å‡º`promise`å‡½æ•°ï¼Œé‡åˆ°`promise.then`ï¼Œä½†å…¶çŠ¶æ€è¿˜æ˜¯ä¸º`pending`ï¼Œè¿™é‡Œç†è§£ä¸ºå…ˆä¸æ‰§è¡Œ
- æ‰§è¡ŒåŒæ­¥ä»£ç `4`
- ä¸€è½®å¾ªç¯è¿‡åï¼Œè¿›å…¥ç¬¬äºŒæ¬¡å®ä»»åŠ¡ï¼Œå‘ç°å»¶è¿Ÿé˜Ÿåˆ—ä¸­æœ‰`setTimeout`å®šæ—¶å™¨ï¼Œæ‰§è¡Œå®ƒ
- é¦–å…ˆæ‰§è¡Œ`timerStart`ï¼Œç„¶åé‡åˆ°äº†`resolve`ï¼Œå°†`promise`çš„çŠ¶æ€æ”¹ä¸º`resolved`ä¸”ä¿å­˜ç»“æœå¹¶å°†ä¹‹å‰çš„`promise.then`æ¨å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- ç»§ç»­æ‰§è¡ŒåŒæ­¥ä»£ç `timerEnd`
- å®ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼ŒæŸ¥æ‰¾å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç°`promise.then`è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œæ‰§è¡Œå®ƒã€‚

å› æ­¤æ‰§è¡Œç»“æœä¸ºï¼š

```1c
1
2
4
"timerStart"
"timerEnd"
"success"å¤åˆ¶ä»£ç 
```

#### 2.3 é¢˜ç›®ä¸‰

é¢˜ç›®ä¸‰åˆ†äº†ä¸¤ä¸ªé¢˜ç›®ï¼Œå› ä¸ºçœ‹ç€éƒ½å·®ä¸å¤šï¼Œä¸è¿‡æ‰§è¡Œçš„ç»“æœå´ä¸ä¸€æ ·ï¼Œå¤§å®¶ä¸å¦¨å…ˆçŒœçŒœä¸‹é¢ä¸¤ä¸ªé¢˜ç›®åˆ†åˆ«æ‰§è¡Œä»€ä¹ˆï¼š

**(1)**:

```arcade
setTimeout(() => {
  console.log('timer1');
  setTimeout(() => {
    console.log('timer3')
  }, 0)
}, 0)
setTimeout(() => {
  console.log('timer2')
}, 0)
console.log('start')å¤åˆ¶ä»£ç 
```

**(2)**:

```arcade
setTimeout(() => {
  console.log('timer1');
  Promise.resolve().then(() => {
    console.log('promise')
  })
}, 0)
setTimeout(() => {
  console.log('timer2')
}, 0)
console.log('start')å¤åˆ¶ä»£ç 
```

**æ‰§è¡Œç»“æœï¼š**

```scheme
'start'
'timer1'
'timer2'
'timer3'å¤åˆ¶ä»£ç 
'start'
'timer1'
'promise'
'timer2'å¤åˆ¶ä»£ç 
```

è¿™ä¸¤ä¸ªä¾‹å­ï¼Œçœ‹ç€å¥½åƒåªæ˜¯æŠŠç¬¬ä¸€ä¸ªå®šæ—¶å™¨ä¸­çš„å†…å®¹æ¢äº†ä¸€ä¸‹è€Œå·²ã€‚

ä¸€ä¸ªæ˜¯ä¸ºå®šæ—¶å™¨`timer3`ï¼Œä¸€ä¸ªæ˜¯ä¸º`Promise.then`

ä½†æ˜¯å¦‚æœæ˜¯å®šæ—¶å™¨`timer3`çš„è¯ï¼Œå®ƒä¼šåœ¨`timer2`åæ‰§è¡Œï¼Œè€Œ`Promise.then`å´æ˜¯åœ¨`timer2`ä¹‹å‰æ‰§è¡Œã€‚

ä½ å¯ä»¥è¿™æ ·ç†è§£ï¼Œ`Promise.then`æ˜¯å¾®ä»»åŠ¡ï¼Œå®ƒä¼šè¢«åŠ å…¥åˆ°æœ¬è½®ä¸­çš„å¾®ä»»åŠ¡åˆ—è¡¨ï¼Œè€Œå®šæ—¶å™¨`timer3`æ˜¯å®ä»»åŠ¡ï¼Œå®ƒä¼šè¢«åŠ å…¥åˆ°ä¸‹ä¸€è½®çš„å®ä»»åŠ¡ä¸­ã€‚

ç†è§£å®Œè¿™ä¸¤ä¸ªæ¡ˆä¾‹ï¼Œå¯ä»¥æ¥çœ‹çœ‹ä¸‹é¢ä¸€é“æ¯”è¾ƒéš¾çš„é¢˜ç›®äº†ã€‚

#### 2.3 é¢˜ç›®ä¸‰

```arcade
Promise.resolve().then(() => {
  console.log('promise1');
  const timer2 = setTimeout(() => {
    console.log('timer2')
  }, 0)
});
const timer1 = setTimeout(() => {
  console.log('timer1')
  Promise.resolve().then(() => {
    console.log('promise2')
  })
}, 0)
console.log('start');å¤åˆ¶ä»£ç 
```

è¿™é“é¢˜ç¨å¾®çš„éš¾ä¸€äº›ï¼Œåœ¨`promise`ä¸­æ‰§è¡Œå®šæ—¶å™¨ï¼Œåˆåœ¨å®šæ—¶å™¨ä¸­æ‰§è¡Œ`promise`ï¼›

å¹¶ä¸”è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„`Promise`æ˜¯ç›´æ¥`resolve`çš„ï¼Œè€Œä¹‹å‰çš„`new Promise`ä¸ä¸€æ ·ã€‚

(å·å·å‘Šè¯‰ä½ ï¼Œè¿™é“é¢˜å¾€ä¸‹ä¸€ç‚¹æœ‰æµç¨‹å›¾)

å› æ­¤è¿‡ç¨‹åˆ†æä¸ºï¼š

- åˆšå¼€å§‹æ•´ä¸ªè„šæœ¬ä½œä¸ºç¬¬ä¸€æ¬¡å®ä»»åŠ¡æ¥æ‰§è¡Œï¼Œæˆ‘ä»¬å°†å®ƒæ ‡è®°ä¸º**å®1**ï¼Œä»ä¸Šè‡³ä¸‹æ‰§è¡Œ
- é‡åˆ°`Promise.resolve().then`è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œå°†`then`ä¸­çš„å†…å®¹åŠ å…¥ç¬¬ä¸€æ¬¡çš„å¾®ä»»åŠ¡é˜Ÿåˆ—æ ‡è®°ä¸º**å¾®1**
- é‡åˆ°å®šæ—¶å™¨`timer1`ï¼Œå°†å®ƒåŠ å…¥ä¸‹ä¸€æ¬¡å®ä»»åŠ¡çš„å»¶è¿Ÿåˆ—è¡¨ï¼Œæ ‡è®°ä¸º**å®2**ï¼Œç­‰å¾…æ‰§è¡Œ(å…ˆä¸ç®¡é‡Œé¢æ˜¯ä»€ä¹ˆå†…å®¹)
- æ‰§è¡Œ**å®1**ä¸­çš„åŒæ­¥ä»£ç `start`
- ç¬¬ä¸€æ¬¡å®ä»»åŠ¡(**å®1**)æ‰§è¡Œå®Œæ¯•ï¼Œæ£€æŸ¥ç¬¬ä¸€æ¬¡çš„å¾®ä»»åŠ¡é˜Ÿåˆ—(**å¾®1**)ï¼Œå‘ç°æœ‰ä¸€ä¸ª`promise.then`è¿™ä¸ªå¾®ä»»åŠ¡éœ€è¦æ‰§è¡Œ
- æ‰§è¡Œæ‰“å°å‡º**å¾®1**ä¸­åŒæ­¥ä»£ç `promise1`ï¼Œç„¶åå‘ç°å®šæ—¶å™¨`timer2`ï¼Œå°†å®ƒåŠ å…¥**å®2**çš„åé¢ï¼Œæ ‡è®°ä¸º**å®3**
- ç¬¬ä¸€æ¬¡å¾®ä»»åŠ¡é˜Ÿåˆ—(**å¾®1**)æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œç¬¬äºŒæ¬¡å®ä»»åŠ¡(**å®2**)ï¼Œé¦–å…ˆæ‰§è¡ŒåŒæ­¥ä»£ç `timer1`
- ç„¶åé‡åˆ°äº†`promise2`è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œå°†å®ƒåŠ å…¥æ­¤æ¬¡å¾ªç¯çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ ‡è®°ä¸º**å¾®2**
- **å®2**ä¸­æ²¡æœ‰åŒæ­¥ä»£ç å¯æ‰§è¡Œäº†ï¼ŒæŸ¥æ‰¾æœ¬æ¬¡å¾ªç¯çš„å¾®ä»»åŠ¡é˜Ÿåˆ—(**å¾®2**)ï¼Œå‘ç°äº†`promise2`ï¼Œæ‰§è¡Œå®ƒ
- ç¬¬äºŒè½®æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œ**å®3**ï¼Œæ‰“å°å‡º`timer2`

æ‰€ä»¥ç»“æœä¸ºï¼š

```scheme
'start'
'promise1'
'timer1'
'promise2'
'timer2'å¤åˆ¶ä»£ç 
```

å¦‚æœæ„Ÿè§‰æœ‰ç‚¹ç»•çš„è¯ï¼Œå¯ä»¥çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼Œå°±ä¸€ç›®äº†ç„¶äº†ã€‚



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708b0d8489e5732~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



#### 2.4 é¢˜ç›®å››

```coffeescript
const promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('success')
  }, 1000)
})
const promise2 = promise1.then(() => {
  throw new Error('error!!!')
})
console.log('promise1', promise1)
console.log('promise2', promise2)
setTimeout(() => {
  console.log('promise1', promise1)
  console.log('promise2', promise2)
}, 2000)å¤åˆ¶ä»£ç 
```

è¿‡ç¨‹åˆ†æï¼š

- ä»ä¸Šè‡³ä¸‹ï¼Œå…ˆæ‰§è¡Œç¬¬ä¸€ä¸ª`new Promise`ä¸­çš„å‡½æ•°ï¼Œç¢°åˆ°`setTimeout`å°†å®ƒåŠ å…¥ä¸‹ä¸€ä¸ªå®ä»»åŠ¡åˆ—è¡¨
- è·³å‡º`new Promise`ï¼Œç¢°åˆ°`promise1.then`è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œä½†å…¶çŠ¶æ€è¿˜æ˜¯ä¸º`pending`ï¼Œè¿™é‡Œç†è§£ä¸ºå…ˆä¸æ‰§è¡Œ
- `promise2`æ˜¯ä¸€ä¸ªæ–°çš„çŠ¶æ€ä¸º`pending`çš„`Promise`
- æ‰§è¡ŒåŒæ­¥ä»£ç `console.log('promise1')`ï¼Œä¸”æ‰“å°å‡ºçš„`promise1`çš„çŠ¶æ€ä¸º`pending`
- æ‰§è¡ŒåŒæ­¥ä»£ç `console.log('promise2')`ï¼Œä¸”æ‰“å°å‡ºçš„`promise2`çš„çŠ¶æ€ä¸º`pending`
- ç¢°åˆ°ç¬¬äºŒä¸ªå®šæ—¶å™¨ï¼Œå°†å…¶æ”¾å…¥ä¸‹ä¸€ä¸ªå®ä»»åŠ¡åˆ—è¡¨
- ç¬¬ä¸€è½®å®ä»»åŠ¡æ‰§è¡Œç»“æŸï¼Œå¹¶ä¸”æ²¡æœ‰å¾®ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œå› æ­¤æ‰§è¡Œç¬¬äºŒè½®å®ä»»åŠ¡
- å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ªå®šæ—¶å™¨é‡Œçš„å†…å®¹ï¼Œå°†`promise1`çš„çŠ¶æ€æ”¹ä¸º`resolved`ä¸”ä¿å­˜ç»“æœå¹¶å°†ä¹‹å‰çš„`promise1.then`æ¨å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- è¯¥å®šæ—¶å™¨ä¸­æ²¡æœ‰å…¶å®ƒçš„åŒæ­¥ä»£ç å¯æ‰§è¡Œï¼Œå› æ­¤æ‰§è¡Œæœ¬è½®çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯`promise1.then`ï¼Œå®ƒæŠ›å‡ºäº†ä¸€ä¸ªé”™è¯¯ï¼Œä¸”å°†`promise2`çš„çŠ¶æ€è®¾ç½®ä¸ºäº†`rejected`
- ç¬¬ä¸€ä¸ªå®šæ—¶å™¨æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ‰§è¡Œç¬¬äºŒä¸ªå®šæ—¶å™¨ä¸­çš„å†…å®¹
- æ‰“å°å‡º`'promise1'`ï¼Œä¸”æ­¤æ—¶`promise1`çš„çŠ¶æ€ä¸º`resolved`
- æ‰“å°å‡º`'promise2'`ï¼Œä¸”æ­¤æ—¶`promise2`çš„çŠ¶æ€ä¸º`rejected`

å®Œæ•´çš„ç»“æœä¸ºï¼š

```erlang-repl
'promise1' Promise{<pending>}
'promise2' Promise{<pending>}
test5.html:102 Uncaught (in promise) Error: error!!! at test.html:102
'promise1' Promise{<resolved>: "success"}
'promise2' Promise{<rejected>: Error: error!!!}å¤åˆ¶ä»£ç 
```

#### 2.5 é¢˜ç›®äº”

å¦‚æœä½ ä¸Šé¢è¿™é“é¢˜ææ‡‚äº†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥åšåšè¿™é“äº†ï¼Œä½ åº”è¯¥èƒ½å¾ˆå¿«å°±ç»™å‡ºç­”æ¡ˆï¼š

```arcade
const promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve("success");
    console.log("timer1");
  }, 1000);
  console.log("promise1é‡Œçš„å†…å®¹");
});
const promise2 = promise1.then(() => {
  throw new Error("error!!!");
});
console.log("promise1", promise1);
console.log("promise2", promise2);
setTimeout(() => {
  console.log("timer2");
  console.log("promise1", promise1);
  console.log("promise2", promise2);
}, 2000);å¤åˆ¶ä»£ç 
```

ç»“æœï¼š

```erlang-repl
'promise1é‡Œçš„å†…å®¹'
'promise1' Promise{<pending>}
'promise2' Promise{<pending>}
'timer1'
test5.html:102 Uncaught (in promise) Error: error!!! at test.html:102
'timer2'
'promise1' Promise{<resolved>: "success"}
'promise2' Promise{<rejected>: Error: error!!!}å¤åˆ¶ä»£ç 
```

### 3. Promiseä¸­çš„thenã€catchã€finally

é¢ï¼Œå¯èƒ½ä½ çœ‹åˆ°ä¸‹é¢ğŸ‘‡è¿™ä¹ˆå¤šçš„`1ï¼Œ2ï¼Œ3`è„¾æ°”å°±ä¸Šæ¥äº†ï¼Œä¸æ˜¯è¯´å¥½äº†æœ¬ç¯‡æ–‡ç« æ²¡ä»€ä¹ˆå±è¯å˜›ï¼Œæ€ä¹ˆè¿˜æ˜¯è¿™ä¹ˆå¤šä¸€äºŒä¸‰å››ã€‚

ğŸ˜‚ï¼Œä½ è¦ç†è§£æˆ‘çš„ç”¨å¿ƒè‰¯è‹¦å•Šï¼Œæˆ‘è¿™æ˜¯å¸®ä½ æŠŠçŸ¥è¯†ç‚¹éƒ½åˆ—ä¸¾å‡ºæ¥ï¼Œåšä¸ªæ€»ç»“è€Œå·²ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥å…ˆä¸çœ‹ï¼Œå…ˆå»åšåé¢çš„é¢˜ï¼Œç„¶åå†å›è¿‡å¤´æ¥çœ‹è¿™äº›ï¼Œä½ å°±è§‰å¾—è¿™äº›ç‚¹éƒ½å¥½å¥½æ‡‚å•Šï¼Œç”šè‡³éƒ½ä¸éœ€è¦è®°ã€‚

**æ€»ç»“ï¼š**

1. `Promise`çš„çŠ¶æ€ä¸€ç»æ”¹å˜å°±ä¸èƒ½å†æ”¹å˜ã€‚(è§3.1)
2. `.then`å’Œ`.catch`éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„`Promise`ã€‚(ä¸Šé¢çš„ğŸ‘†1.4è¯æ˜äº†)
3. `catch`ä¸ç®¡è¢«è¿æ¥åˆ°å“ªé‡Œï¼Œéƒ½èƒ½æ•è·ä¸Šå±‚æœªæ•æ‰è¿‡çš„é”™è¯¯ã€‚(è§3.2)
4. åœ¨`Promise`ä¸­ï¼Œè¿”å›ä»»æ„ä¸€ä¸ªé `promise` çš„å€¼éƒ½ä¼šè¢«åŒ…è£¹æˆ `promise` å¯¹è±¡ï¼Œä¾‹å¦‚`return 2`ä¼šè¢«åŒ…è£…ä¸º`return Promise.resolve(2)`ã€‚
5. `Promise` çš„ `.then` æˆ–è€… `.catch` å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡, ä½†å¦‚æœ`Promise`å†…éƒ¨çš„çŠ¶æ€ä¸€ç»æ”¹å˜ï¼Œå¹¶ä¸”æœ‰äº†ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆåç»­æ¯æ¬¡è°ƒç”¨`.then`æˆ–è€…`.catch`çš„æ—¶å€™éƒ½ä¼šç›´æ¥æ‹¿åˆ°è¯¥å€¼ã€‚(è§3.5)
6. `.then` æˆ–è€… `.catch` ä¸­ `return` ä¸€ä¸ª `error` å¯¹è±¡å¹¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œæ‰€ä»¥ä¸ä¼šè¢«åç»­çš„ `.catch` æ•è·ã€‚(è§3.6)
7. `.then` æˆ– `.catch` è¿”å›çš„å€¼ä¸èƒ½æ˜¯ promise æœ¬èº«ï¼Œå¦åˆ™ä¼šé€ æˆæ­»å¾ªç¯ã€‚(è§3.7)
8. `.then` æˆ–è€… `.catch` çš„å‚æ•°æœŸæœ›æ˜¯å‡½æ•°ï¼Œä¼ å…¥éå‡½æ•°åˆ™ä¼šå‘ç”Ÿå€¼é€ä¼ ã€‚(è§3.8)
9. `.then`æ–¹æ³•æ˜¯èƒ½æ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„ï¼Œç¬¬ä¸€ä¸ªæ˜¯å¤„ç†æˆåŠŸçš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªæ˜¯å¤„ç†å¤±è´¥çš„å‡½æ•°ï¼Œå†æŸäº›æ—¶å€™ä½ å¯ä»¥è®¤ä¸º`catch`æ˜¯`.then`ç¬¬äºŒä¸ªå‚æ•°çš„ç®€ä¾¿å†™æ³•ã€‚(è§3.9)
10. `.finally`æ–¹æ³•ä¹Ÿæ˜¯è¿”å›ä¸€ä¸ª`Promise`ï¼Œä»–åœ¨`Promise`ç»“æŸçš„æ—¶å€™ï¼Œæ— è®ºç»“æœä¸º`resolved`è¿˜æ˜¯`rejected`ï¼Œéƒ½ä¼šæ‰§è¡Œé‡Œé¢çš„å›è°ƒå‡½æ•°ã€‚

#### 3.1 é¢˜ç›®ä¸€

```arcade
const promise = new Promise((resolve, reject) => {
  resolve("success1");
  reject("error");
  resolve("success2");
});
promise
.then(res => {
    console.log("then: ", res);
  }).catch(err => {
    console.log("catch: ", err);
  })å¤åˆ¶ä»£ç 
```

ç»“æœï¼š

```1c
"then: success1"å¤åˆ¶ä»£ç 
```

æ„é€ å‡½æ•°ä¸­çš„ `resolve` æˆ– `reject` åªæœ‰ç¬¬ä¸€æ¬¡æ‰§è¡Œæœ‰æ•ˆï¼Œå¤šæ¬¡è°ƒç”¨æ²¡æœ‰ä»»ä½•ä½œç”¨ ã€‚éªŒè¯äº†ç¬¬ä¸€ä¸ªç»“è®ºï¼Œ`Promise`çš„çŠ¶æ€ä¸€ç»æ”¹å˜å°±ä¸èƒ½å†æ”¹å˜ã€‚

#### 3.2 é¢˜ç›®äºŒ

```arcade
const promise = new Promise((resolve, reject) => {
  reject("error");
  resolve("success2");
});
promise
.then(res => {
    console.log("then1: ", res);
  }).then(res => {
    console.log("then2: ", res);
  }).catch(err => {
    console.log("catch: ", err);
  }).then(res => {
    console.log("then3: ", res);
  })å¤åˆ¶ä»£ç 
```

ç»“æœï¼š

```actionscript
"catch: " "error"
"then3: " undefinedå¤åˆ¶ä»£ç 
```

éªŒè¯äº†ç¬¬ä¸‰ä¸ªç»“è®ºï¼Œ`catch`ä¸ç®¡è¢«è¿æ¥åˆ°å“ªé‡Œï¼Œéƒ½èƒ½æ•è·ä¸Šå±‚æœªæ•æ‰è¿‡çš„é”™è¯¯ã€‚

è‡³äº`then3`ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œé‚£æ˜¯å› ä¸º`catch()`ä¹Ÿä¼šè¿”å›ä¸€ä¸ª`Promise`ï¼Œä¸”ç”±äºè¿™ä¸ª`Promise`æ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥æ‰“å°å‡ºæ¥çš„æ˜¯`undefined`ã€‚

#### 3.3 é¢˜ç›®ä¸‰

```arcade
Promise.resolve(1)
  .then(res => {
    console.log(res);
    return 2;
  })
  .catch(err => {
    return 3;
  })
  .then(res => {
    console.log(res);
  });å¤åˆ¶ä»£ç 
```

ç»“æœï¼š

```
1
2å¤åˆ¶ä»£ç 
```

`Promise`å¯ä»¥é“¾å¼è°ƒç”¨ï¼Œä¸è¿‡`promise` æ¯æ¬¡è°ƒç”¨ `.then` æˆ–è€… `.catch` éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ `promise`ï¼Œä»è€Œå®ç°äº†é“¾å¼è°ƒç”¨, å®ƒå¹¶ä¸åƒä¸€èˆ¬æˆ‘ä»¬ä»»åŠ¡çš„é“¾å¼è°ƒç”¨ä¸€æ ·`return this`ã€‚

ä¸Šé¢çš„è¾“å‡ºç»“æœä¹‹æ‰€ä»¥ä¾æ¬¡æ‰“å°å‡º`1`å’Œ`2`ï¼Œé‚£æ˜¯å› ä¸º`resolve(1)`ä¹‹åèµ°çš„æ˜¯ç¬¬ä¸€ä¸ª`then`æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰èµ°`catch`é‡Œï¼Œæ‰€ä»¥ç¬¬äºŒä¸ª`then`ä¸­çš„`res`å¾—åˆ°çš„å®é™…ä¸Šæ˜¯ç¬¬ä¸€ä¸ª`then`çš„è¿”å›å€¼ã€‚

ä¸”`return 2`ä¼šè¢«åŒ…è£…æˆ`resolve(2)`ã€‚

#### 3.4 é¢˜ç›®å››

å¦‚æœæŠŠ`3.3`ä¸­çš„`Promise.resolve(1)`æ”¹ä¸º`Promise.reject(1)`åˆä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ

```arcade
Promise.reject(1)
  .then(res => {
    console.log(res);
    return 2;
  })
  .catch(err => {
    console.log(err);
    return 3
  })
  .then(res => {
    console.log(res);
  });å¤åˆ¶ä»£ç 
```

ç»“æœï¼š

```
1
3å¤åˆ¶ä»£ç 
```

ç»“æœæ‰“å°çš„å½“ç„¶æ˜¯ `1 å’Œ 3`å•¦ï¼Œå› ä¸º`reject(1)`æ­¤æ—¶èµ°çš„å°±æ˜¯`catch`ï¼Œä¸”ç¬¬äºŒä¸ª`then`ä¸­çš„`res`å¾—åˆ°çš„å°±æ˜¯`catch`ä¸­çš„è¿”å›å€¼ã€‚

#### 3.5 é¢˜ç›®äº”

```arcade
const promise = new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log('timer')
    resolve('success')
  }, 1000)
})
const start = Date.now();
promise.then(res => {
  console.log(res, Date.now() - start)
})
promise.then(res => {
  console.log(res, Date.now() - start)
})å¤åˆ¶ä»£ç 
```

æ‰§è¡Œç»“æœï¼š

```scheme
'timer'
'success' 1001
'success' 1002å¤åˆ¶ä»£ç 
```

å½“ç„¶ï¼Œå¦‚æœä½ è¶³å¤Ÿå¿«çš„è¯ï¼Œä¹Ÿå¯èƒ½ä¸¤ä¸ªéƒ½æ˜¯`1001`ã€‚

`Promise` çš„ `.then` æˆ–è€… `.catch` å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡ï¼Œä½†è¿™é‡Œ `Promise` æ„é€ å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ã€‚æˆ–è€…è¯´ `promise` å†…éƒ¨çŠ¶æ€ä¸€ç»æ”¹å˜ï¼Œå¹¶ä¸”æœ‰äº†ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆåç»­æ¯æ¬¡è°ƒç”¨ `.then` æˆ–è€… `.catch` éƒ½ä¼šç›´æ¥æ‹¿åˆ°è¯¥å€¼ã€‚

#### 3.6 é¢˜ç›®å…­

```arcade
Promise.resolve().then(() => {
  return new Error('error!!!')
}).then(res => {
  console.log("then: ", res)
}).catch(err => {
  console.log("catch: ", err)
})å¤åˆ¶ä»£ç 
```

çŒœçŒœè¿™é‡Œçš„ç»“æœè¾“å‡ºçš„æ˜¯ä»€ä¹ˆ ğŸ¤”ï¸ ï¼Ÿ

ä½ å¯èƒ½æƒ³åˆ°çš„æ˜¯è¿›å…¥`.catch`ç„¶åè¢«æ•è·äº†é”™è¯¯ã€‚

ç»“æœå¹¶ä¸æ˜¯è¿™æ ·çš„ï¼Œå®ƒèµ°çš„æ˜¯`.then`é‡Œé¢ï¼š

```1c
"then: " "Error: error!!!"å¤åˆ¶ä»£ç 
```

è¿™ä¹ŸéªŒè¯äº†ç¬¬4ç‚¹å’Œç¬¬6ç‚¹ï¼Œè¿”å›ä»»æ„ä¸€ä¸ªé `promise` çš„å€¼éƒ½ä¼šè¢«åŒ…è£¹æˆ `promise` å¯¹è±¡ï¼Œå› æ­¤è¿™é‡Œçš„`return new Error('error!!!')`ä¹Ÿè¢«åŒ…è£¹æˆäº†`return Promise.resolve(new Error('error!!!'))`ã€‚

å½“ç„¶å¦‚æœä½ æŠ›å‡ºä¸€ä¸ªé”™è¯¯çš„è¯ï¼Œå¯ä»¥ç”¨ä¸‹é¢ğŸ‘‡ä¸¤çš„ä»»æ„ä¸€ç§ï¼š

```javascript
return Promise.reject(new Error('error!!!'));
// or
throw new Error('error!!!')å¤åˆ¶ä»£ç 
```

#### 3.7 é¢˜ç›®ä¸ƒ

```coffeescript
const promise = Promise.resolve().then(() => {
  return promise;
})
promise.catch(console.err)å¤åˆ¶ä»£ç 
```

`.then` æˆ– `.catch` è¿”å›çš„å€¼ä¸èƒ½æ˜¯ promise æœ¬èº«ï¼Œå¦åˆ™ä¼šé€ æˆæ­»å¾ªç¯ã€‚

å› æ­¤ç»“æœä¼šæŠ¥é”™ï¼š

```cpp
Uncaught (in promise) TypeError: Chaining cycle detected for promise #<Promise>å¤åˆ¶ä»£ç 
```

#### 3.8 é¢˜ç›®å…«

```sas
Promise.resolve(1)
  .then(2)
  .then(Promise.resolve(3))
  .then(console.log)å¤åˆ¶ä»£ç 
```

è¿™é“é¢˜çœ‹ç€å¥½åƒå¾ˆç®€å•ï¼Œåˆæ„Ÿè§‰å¾ˆå¤æ‚çš„æ ·å­ï¼Œæ€ä¹ˆè¿™ä¹ˆå¤šä¸ª`.then`å•Š... ğŸ˜…



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708baaf2b1e9075~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



å…¶å®ä½ åªè¦è®°ä½**åŸåˆ™8**ï¼š`.then` æˆ–è€… `.catch` çš„å‚æ•°æœŸæœ›æ˜¯å‡½æ•°ï¼Œä¼ å…¥éå‡½æ•°åˆ™ä¼šå‘ç”Ÿå€¼é€ä¼ ã€‚

ç¬¬ä¸€ä¸ª`then`å’Œç¬¬äºŒä¸ª`then`ä¸­ä¼ å…¥çš„éƒ½ä¸æ˜¯å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯æ•°å­—ç±»å‹ï¼Œä¸€ä¸ªæ˜¯å¯¹è±¡ç±»å‹ï¼Œå› æ­¤å‘ç”Ÿäº†é€ä¼ ï¼Œå°†`resolve(1)` çš„å€¼ç›´æ¥ä¼ åˆ°æœ€åä¸€ä¸ª`then`é‡Œã€‚

æ‰€ä»¥è¾“å‡ºç»“æœä¸ºï¼š

```
1å¤åˆ¶ä»£ç 
```

#### 3.9 é¢˜ç›®ä¹

ä¸‹é¢æ¥ä»‹ç»ä¸€ä¸‹`.then`å‡½æ•°ä¸­çš„ä¸¤ä¸ªå‚æ•°ã€‚

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨æ¥å¤„ç†`Promise`æˆåŠŸçš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯å¤„ç†å¤±è´¥çš„å‡½æ•°ã€‚

ä¹Ÿå°±æ˜¯è¯´`Promise.resolve('1')`çš„å€¼ä¼šè¿›å…¥æˆåŠŸçš„å‡½æ•°ï¼Œ`Promise.reject('2')`çš„å€¼ä¼šè¿›å…¥å¤±è´¥çš„å‡½æ•°ã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªä¾‹å­ğŸŒ°ï¼š

```arcade
Promise.reject('err!!!')
  .then((res) => {
    console.log('success', res)
  }, (err) => {
    console.log('error', err)
  }).catch(err => {
    console.log('catch', err)
  })å¤åˆ¶ä»£ç 
```

è¿™é‡Œçš„æ‰§è¡Œç»“æœæ˜¯ï¼š

```scheme
'error' 'error!!!'å¤åˆ¶ä»£ç 
```

å®ƒè¿›å…¥çš„æ˜¯`then()`ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°é‡Œé¢ï¼Œè€Œå¦‚æœæŠŠç¬¬äºŒä¸ªå‚æ•°å»æ‰ï¼Œå°±è¿›å…¥äº†`catch()`ä¸­ï¼š

```arcade
Promise.reject('error!!!')
  .then((res) => {
    console.log('success', res)
  }).catch(err => {
    console.log('catch', err)
  })å¤åˆ¶ä»£ç 
```

æ‰§è¡Œç»“æœï¼š

```scheme
'catch' 'error!!!'å¤åˆ¶ä»£ç 
```

ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ˜¯è¿™ä¸ªæ¡ˆä¾‹å‘¢ï¼Ÿ

```qml
Promise.resolve()
  .then(function success (res) {
    throw new Error('error!!!')
  }, function fail1 (err) {
    console.log('fail1', err)
  }).catch(function fail2 (err) {
    console.log('fail2', err)
  })å¤åˆ¶ä»£ç 
```

ç”±äº`Promise`è°ƒç”¨çš„æ˜¯`resolve()`ï¼Œå› æ­¤`.then()`æ‰§è¡Œçš„åº”è¯¥æ˜¯`success()`å‡½æ•°ï¼Œå¯æ˜¯`success()`å‡½æ•°æŠ›å‡ºçš„æ˜¯ä¸€ä¸ªé”™è¯¯ï¼Œå®ƒä¼šè¢«åé¢çš„`catch()`ç»™æ•è·åˆ°ï¼Œè€Œä¸æ˜¯è¢«`fail1`å‡½æ•°æ•è·ã€‚

å› æ­¤æ‰§è¡Œç»“æœä¸ºï¼š

```erlang-repl
fail2 Error: error!!!
			at successå¤åˆ¶ä»£ç 
```

#### 3.10 é¢˜ç›®å

æ¥ç€æ¥çœ‹çœ‹`.finally()`ï¼Œè¿™ä¸ªåŠŸèƒ½ä¸€èˆ¬ä¸å¤ªç”¨åœ¨é¢è¯•ä¸­ï¼Œä¸è¿‡å¦‚æœç¢°åˆ°äº†ä½ ä¹Ÿåº”è¯¥çŸ¥é“è¯¥å¦‚ä½•å¤„ç†ã€‚

å…¶å®ä½ åªè¦è®°ä½å®ƒä¸‰ä¸ªå¾ˆé‡è¦çš„çŸ¥è¯†ç‚¹å°±å¯ä»¥äº†ï¼š

1. `.finally()`æ–¹æ³•ä¸ç®¡`Promise`å¯¹è±¡æœ€åçš„çŠ¶æ€å¦‚ä½•éƒ½ä¼šæ‰§è¡Œ
2. `.finally()`æ–¹æ³•çš„å›è°ƒå‡½æ•°ä¸æ¥å—ä»»ä½•çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ åœ¨`.finally()`å‡½æ•°ä¸­æ˜¯æ²¡æ³•çŸ¥é“`Promise`æœ€ç»ˆçš„çŠ¶æ€æ˜¯`resolved`è¿˜æ˜¯`rejected`çš„
3. å®ƒæœ€ç»ˆè¿”å›çš„é»˜è®¤ä¼šæ˜¯ä¸€ä¸ª**ä¸Šä¸€æ¬¡çš„Promiseå¯¹è±¡å€¼**ï¼Œä¸è¿‡å¦‚æœæŠ›å‡ºçš„æ˜¯ä¸€ä¸ªå¼‚å¸¸åˆ™è¿”å›å¼‚å¸¸çš„`Promise`å¯¹è±¡ã€‚

æ¥çœ‹çœ‹è¿™ä¸ªç®€å•çš„ä¾‹å­ğŸŒ°ï¼š

```arcade
Promise.resolve('1')
  .then(res => {
    console.log(res)
  })
  .finally(() => {
    console.log('finally')
  })
Promise.resolve('2')
  .finally(() => {
    console.log('finally2')
  	return 'æˆ‘æ˜¯finally2è¿”å›çš„å€¼'
  })
  .then(res => {
    console.log('finally2åé¢çš„thenå‡½æ•°', res)
  })å¤åˆ¶ä»£ç 
```

è¿™ä¸¤ä¸ª`Promise`çš„`.finally`éƒ½ä¼šæ‰§è¡Œï¼Œä¸”å°±ç®—`finally2`è¿”å›äº†æ–°çš„å€¼ï¼Œå®ƒåé¢çš„`then()`å‡½æ•°æ¥æ”¶åˆ°çš„ç»“æœå´è¿˜æ˜¯`'2'`ï¼Œå› æ­¤æ‰“å°ç»“æœä¸ºï¼š

```scheme
'1'
'finally2'
'finally'
'finally2åé¢çš„thenå‡½æ•°' '2'å¤åˆ¶ä»£ç 
```

è‡³äºä¸ºä»€ä¹ˆ`finally2`çš„æ‰“å°è¦åœ¨`finally`å‰é¢ï¼Œè¯·çœ‹ä¸‹ä¸€ä¸ªä¾‹å­ä¸­çš„è§£æã€‚

ä¸è¿‡åœ¨æ­¤ä¹‹å‰è®©æˆ‘ä»¬å†æ¥ç¡®è®¤ä¸€ä¸‹ï¼Œ`finally`ä¸­è¦æ˜¯æŠ›å‡ºçš„æ˜¯ä¸€ä¸ªå¼‚å¸¸æ˜¯æ€æ ·çš„ï¼š

```arcade
Promise.resolve('1')
  .finally(() => {
    console.log('finally1')
    throw new Error('æˆ‘æ˜¯finallyä¸­æŠ›å‡ºçš„å¼‚å¸¸')
  })
  .then(res => {
    console.log('finallyåé¢çš„thenå‡½æ•°', res)
  })
  .catch(err => {
    console.log('æ•è·é”™è¯¯', err)
  })å¤åˆ¶ä»£ç 
```

æ‰§è¡Œç»“æœä¸ºï¼š

```javascript
'finally1'
'æ•è·é”™è¯¯' Error: æˆ‘æ˜¯finallyä¸­æŠ›å‡ºçš„å¼‚å¸¸å¤åˆ¶ä»£ç 
```

ä½†æ˜¯å¦‚æœæ”¹ä¸º`return new Error('æˆ‘æ˜¯finallyä¸­æŠ›å‡ºçš„å¼‚å¸¸')`ï¼Œæ‰“å°å‡ºæ¥çš„å°±æ˜¯`'finallyåé¢çš„thenå‡½æ•° 1'`

OKï¼ŒğŸ‘Œï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¯”è¾ƒéš¾çš„ä¾‹å­ğŸŒ°ï¼š

```arcade
function promise1 () {
  let p = new Promise((resolve) => {
    console.log('promise1');
    resolve('1')
  })
  return p;
}
function promise2 () {
  return new Promise((resolve, reject) => {
    reject('error')
  })
}
promise1()
  .then(res => console.log(res))
  .catch(err => console.log(err))
  .finally(() => console.log('finally1'))

promise2()
  .then(res => console.log(res))
  .catch(err => console.log(err))
  .finally(() => console.log('finally2'))å¤åˆ¶ä»£ç 
```

æ‰§è¡Œè¿‡ç¨‹ï¼š

- é¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°`promise1`å’Œ`promise2`ï¼Œå…ˆä¸ç®¡æ¥ç€å¾€ä¸‹çœ‹ã€‚
- `promise1`å‡½æ•°å…ˆè¢«è°ƒç”¨äº†ï¼Œç„¶åæ‰§è¡Œé‡Œé¢`new Promise`çš„åŒæ­¥ä»£ç æ‰“å°å‡º`promise1`
- ä¹‹åé‡åˆ°äº†`resolve(1)`ï¼Œå°†`p`çš„çŠ¶æ€æ”¹ä¸ºäº†`resolved`å¹¶å°†ç»“æœä¿å­˜ä¸‹æ¥ã€‚
- æ­¤æ—¶`promise1`å†…çš„å‡½æ•°å†…å®¹å·²ç»æ‰§è¡Œå®Œäº†ï¼Œè·³å‡ºè¯¥å‡½æ•°
- ç¢°åˆ°äº†`promise1().then()`ï¼Œç”±äº`promise1`çš„çŠ¶æ€å·²ç»å‘ç”Ÿäº†æ”¹å˜ä¸”ä¸º`resolved`å› æ­¤å°†`promise1().then()`è¿™æ¡å¾®ä»»åŠ¡åŠ å…¥æœ¬è½®çš„å¾®ä»»åŠ¡åˆ—è¡¨(**è¿™æ˜¯ç¬¬ä¸€ä¸ªå¾®ä»»åŠ¡**)
- è¿™æ—¶å€™è¦æ³¨æ„äº†ï¼Œä»£ç å¹¶ä¸ä¼šæ¥ç€å¾€é“¾å¼è°ƒç”¨çš„ä¸‹é¢èµ°ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šå…ˆå°†`.finally`åŠ å…¥å¾®ä»»åŠ¡åˆ—è¡¨ï¼Œé‚£æ˜¯å› ä¸º`.then`æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œå®ƒé“¾å¼åé¢çš„å†…å®¹å¿…é¡»å¾—ç­‰å½“å‰è¿™ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œå®Œæ‰ä¼šæ‰§è¡Œï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬å…ˆä¸ç®¡`.finally()`
- å†å¾€ä¸‹èµ°ç¢°åˆ°äº†`promise2()`å‡½æ•°ï¼Œå…¶ä¸­è¿”å›çš„`new Promise`ä¸­å¹¶æ²¡æœ‰åŒæ­¥ä»£ç éœ€è¦æ‰§è¡Œï¼Œæ‰€ä»¥æ‰§è¡Œ`reject('error')`çš„æ—¶å€™å°†`promise2`å‡½æ•°ä¸­çš„`Promise`çš„çŠ¶æ€å˜ä¸ºäº†`rejected`
- è·³å‡º`promise2`å‡½æ•°ï¼Œé‡åˆ°äº†`promise2().catch()`ï¼Œå°†å…¶åŠ å…¥å½“å‰çš„å¾®ä»»åŠ¡é˜Ÿåˆ—(**è¿™æ˜¯ç¬¬äºŒä¸ªå¾®ä»»åŠ¡**)ï¼Œä¸”é“¾å¼è°ƒç”¨åé¢çš„å†…å®¹å¾—ç­‰è¯¥ä»»åŠ¡æ‰§è¡Œå®Œåæ‰æ‰§è¡Œï¼Œå’Œ`.then()`ä¸€æ ·ã€‚
- OKï¼Œ æœ¬è½®çš„å®ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œäº†ï¼Œæ¥çœ‹çœ‹å¾®ä»»åŠ¡åˆ—è¡¨ï¼Œå­˜åœ¨`promise1().then()`ï¼Œæ‰§è¡Œå®ƒï¼Œæ‰“å°å‡º`1`ï¼Œç„¶åé‡åˆ°äº†`.finally()`è¿™ä¸ªå¾®ä»»åŠ¡å°†å®ƒåŠ å…¥å¾®ä»»åŠ¡åˆ—è¡¨(**è¿™æ˜¯ç¬¬ä¸‰ä¸ªå¾®ä»»åŠ¡**)ç­‰å¾…æ‰§è¡Œ
- å†æ‰§è¡Œ`promise2().catch()`æ‰“å°å‡º`error`ï¼Œæ‰§è¡Œå®Œåå°†`finally2`åŠ å…¥å¾®ä»»åŠ¡åŠ å…¥å¾®ä»»åŠ¡åˆ—è¡¨(**è¿™æ˜¯ç¬¬å››ä¸ªå¾®ä»»åŠ¡**)
- OKï¼Œ æœ¬è½®åˆå…¨éƒ¨æ‰§è¡Œå®Œäº†ï¼Œä½†æ˜¯å¾®ä»»åŠ¡åˆ—è¡¨è¿˜æœ‰ä¸¤ä¸ªæ–°çš„å¾®ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå› æ­¤ä¾æ¬¡æ‰§è¡Œ`finally1`å’Œ`finally2`ã€‚

ç»“æœï¼š

```scheme
'promise1'
'1'
'error'
'finally1'
'finally2'å¤åˆ¶ä»£ç 
```

åœ¨è¿™é“é¢˜ä¸­å…¶å®èƒ½æ‹“å±•çš„ä¸œè¥¿æŒºå¤šçš„ï¼Œä¹‹å‰æ²¡æœ‰æåˆ°ï¼Œé‚£å°±æ˜¯ä½ å¯ä»¥ç†è§£ä¸º**é“¾å¼è°ƒç”¨**åé¢çš„å†…å®¹éœ€è¦ç­‰å‰ä¸€ä¸ªè°ƒç”¨æ‰§è¡Œå®Œæ‰ä¼šæ‰§è¡Œã€‚

å°±åƒæ˜¯è¿™é‡Œçš„`finally()`ä¼šç­‰`promise1().then()`æ‰§è¡Œå®Œæ‰ä¼šå°†`finally()`åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå…¶å®å¦‚æœè¿™é“é¢˜ä¸­ä½ æŠŠ`finally()`æ¢æˆæ˜¯`then()`ä¹Ÿæ˜¯è¿™æ ·çš„:

```arcade
function promise1 () {
  let p = new Promise((resolve) => {
    console.log('promise1');
    resolve('1')
  })
  return p;
}
function promise2 () {
  return new Promise((resolve, reject) => {
    reject('error')
  })
}
promise1()
  .then(res => console.log(res))
  .catch(err => console.log(err))
  .then(() => console.log('finally1'))

promise2()
  .then(res => console.log(res))
  .catch(err => console.log(err))
  .then(() => console.log('finally2'))å¤åˆ¶ä»£ç 
```

### 4. Promiseä¸­çš„allå’Œrace

åœ¨åšä¸‹é¢ğŸ‘‡çš„é¢˜ç›®ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹`Promise.all()`å’Œ`Promise.race()`çš„ç”¨æ³•ã€‚

é€šä¿—æ¥è¯´ï¼Œ`.all()`çš„ä½œç”¨æ˜¯æ¥æ”¶ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œåæ‰æ‰§è¡Œå›è°ƒã€‚

`.race()`çš„ä½œç”¨ä¹Ÿæ˜¯æ¥æ”¶ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œåªä¿ç•™å–ç¬¬ä¸€ä¸ªæ‰§è¡Œå®Œæˆçš„å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå…¶ä»–çš„æ–¹æ³•ä»åœ¨æ‰§è¡Œï¼Œä¸è¿‡æ‰§è¡Œç»“æœä¼šè¢«æŠ›å¼ƒã€‚

æ¥çœ‹çœ‹é¢˜ç›®ä¸€ã€‚

#### 4.1 é¢˜ç›®ä¸€

æˆ‘ä»¬çŸ¥é“å¦‚æœç›´æ¥åœ¨è„šæœ¬æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ª`Promise`ï¼Œå®ƒæ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¼šç«‹å³æ‰§è¡Œçš„ï¼Œå°±åƒè¿™æ ·ï¼š

```arcade
const p1 = new Promise(r => console.log('ç«‹å³æ‰“å°'))å¤åˆ¶ä»£ç 
```

æ§åˆ¶å°ä¸­ä¼šç«‹å³æ‰“å°å‡º â€œç«‹å³æ‰“å°â€ã€‚

å› æ­¤ä¸ºäº†æ§åˆ¶å®ƒä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªå‡½æ•°åŒ…è£¹ç€å®ƒï¼Œåœ¨éœ€è¦å®ƒæ‰§è¡Œçš„æ—¶å€™ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°å°±å¯ä»¥äº†ï¼š

```arcade
function runP1 () {
    const p1 = new Promise(r => console.log('ç«‹å³æ‰“å°'))
    return p1
}

runP1() // è°ƒç”¨æ­¤å‡½æ•°æ—¶æ‰æ‰§è¡Œå¤åˆ¶ä»£ç 
```

OK ğŸ‘Œï¼Œ è®©æˆ‘ä»¬å›å½’æ­£é¢˜ã€‚

ç°åœ¨æ¥æ„å»ºè¿™ä¹ˆä¸€ä¸ªå‡½æ•°ï¼š

```arcade
function runAsync (x) {
    const p = new Promise(r => setTimeout(() => r(x, console.log(x)), 1000))
    return p
}å¤åˆ¶ä»£ç 
```

è¯¥å‡½æ•°ä¼ å…¥ä¸€ä¸ªå€¼`x`ï¼Œç„¶åé—´éš”ä¸€ç§’åæ‰“å°å‡ºè¿™ä¸ª`x`ã€‚

å¦‚æœæˆ‘ç”¨`.all()`æ¥æ‰§è¡Œå®ƒä¼šæ€æ ·å‘¢ï¼Ÿ

```arcade
function runAsync (x) {
    const p = new Promise(r => setTimeout(() => r(x, console.log(x)), 1000))
    return p
}
Promise.all([runAsync(1), runAsync(2), runAsync(3)])
  .then(res => console.log(res))å¤åˆ¶ä»£ç 
```

å…ˆæ¥æƒ³æƒ³æ­¤æ®µä»£ç åœ¨æµè§ˆå™¨ä¸­ä¼šå¦‚ä½•æ‰§è¡Œï¼Ÿ

æ²¡é”™ï¼Œå½“ä½ æ‰“å¼€é¡µé¢çš„æ—¶å€™ï¼Œåœ¨é—´éš”ä¸€ç§’åï¼Œæ§åˆ¶å°ä¼šåŒæ—¶æ‰“å°å‡º`1, 2, 3`ï¼Œè¿˜æœ‰ä¸€ä¸ªæ•°ç»„`[1, 2, 3]`ã€‚

```angelscript
1
2
3
[1, 2, 3]å¤åˆ¶ä»£ç 
```

æ‰€ä»¥ä½ ç°åœ¨èƒ½ç†è§£è¿™å¥è¯çš„æ„æ€äº†å—ï¼š**æœ‰äº†allï¼Œä½ å°±å¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå¼‚æ­¥æ“ä½œï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªå›è°ƒä¸­å¤„ç†æ‰€æœ‰çš„è¿”å›æ•°æ®ã€‚**

`.all()`åé¢çš„`.then()`é‡Œçš„å›è°ƒå‡½æ•°æ¥æ”¶çš„å°±æ˜¯æ‰€æœ‰å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚

è€Œä¸”è¿™ä¸ªç»“æœä¸­æ•°ç»„çš„é¡ºåºå’Œ`Promise.all()`æ¥æ”¶åˆ°çš„æ•°ç»„é¡ºåºä¸€è‡´ï¼ï¼ï¼

> æœ‰ä¸€ä¸ªåœºæ™¯æ˜¯å¾ˆé€‚åˆç”¨è¿™ä¸ªçš„ï¼Œä¸€äº›æ¸¸æˆç±»çš„ç´ ææ¯”è¾ƒå¤šçš„åº”ç”¨ï¼Œæ‰“å¼€ç½‘é¡µæ—¶ï¼Œé¢„å…ˆåŠ è½½éœ€è¦ç”¨åˆ°çš„å„ç§èµ„æºå¦‚å›¾ç‰‡ã€flashä»¥åŠå„ç§é™æ€æ–‡ä»¶ã€‚æ‰€æœ‰çš„éƒ½åŠ è½½å®Œåï¼Œæˆ‘ä»¬å†è¿›è¡Œé¡µé¢çš„åˆå§‹åŒ–ã€‚

#### 4.2 é¢˜ç›®äºŒ

æˆ‘æ–°å¢äº†ä¸€ä¸ª`runReject`å‡½æ•°ï¼Œå®ƒç”¨æ¥åœ¨`1000 * x`ç§’å`reject`ä¸€ä¸ªé”™è¯¯ã€‚

åŒæ—¶`.catch()`å‡½æ•°èƒ½å¤Ÿæ•è·åˆ°`.all()`é‡Œæœ€å…ˆçš„é‚£ä¸ªå¼‚å¸¸ï¼Œå¹¶ä¸”åªæ‰§è¡Œä¸€æ¬¡ã€‚

æƒ³æƒ³è¿™é“é¢˜ä¼šæ€æ ·æ‰§è¡Œå‘¢ ğŸ¤”ï¸ï¼Ÿ

```arcade
function runAsync (x) {
  const p = new Promise(r => setTimeout(() => r(x, console.log(x)), 1000))
  return p
}
function runReject (x) {
  const p = new Promise((res, rej) => setTimeout(() => rej(`Error: ${x}`, console.log(x)), 1000 * x))
  return p
}
Promise.all([runAsync(1), runReject(4), runAsync(3), runReject(2)])
  .then(res => console.log(res))
  .catch(err => console.log(err))å¤åˆ¶ä»£ç 
```

ä¸å–å…³å­äº† ğŸ˜ï¼Œè®©æˆ‘æ¥å…¬å¸ƒç­”æ¡ˆï¼š

```subunit
// 1såè¾“å‡º
1
3
// 2såè¾“å‡º
2
Error: 2
// 4såè¾“å‡º
4å¤åˆ¶ä»£ç 
```

æ²¡é”™ï¼Œå°±åƒæˆ‘ä¹‹å‰è¯´çš„ï¼Œ`.catch`æ˜¯ä¼šæ•è·æœ€å…ˆçš„é‚£ä¸ªå¼‚å¸¸ï¼Œåœ¨è¿™é“é¢˜ç›®ä¸­æœ€å…ˆçš„å¼‚å¸¸å°±æ˜¯`runReject(2)`çš„ç»“æœã€‚

å¦å¤–ï¼Œå¦‚æœä¸€ç»„å¼‚æ­¥æ“ä½œä¸­æœ‰ä¸€ä¸ªå¼‚å¸¸éƒ½ä¸ä¼šè¿›å…¥`.then()`çš„ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°å‚æ•°ä¸­ã€‚

æ³¨æ„ï¼Œä¸ºä»€ä¹ˆä¸è¯´æ˜¯ä¸è¿›å…¥`.then()`ä¸­å‘¢ ğŸ¤”ï¸ï¼Ÿ

å“ˆå“ˆï¼Œå¤§å®¶åˆ«å¿˜äº†`.then()`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿæ˜¯å¯ä»¥æ•è·é”™è¯¯çš„ï¼š

```arcade
Promise.all([runAsync(1), runReject(4), runAsync(3), runReject(2)])
  .then(res => console.log(res), 
  err => console.log(err))å¤åˆ¶ä»£ç 
```

#### 4.3 é¢˜ç›®ä¸‰

æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹å¦ä¸€ä¸ªæœ‰è¶£çš„æ–¹æ³•`.race`ã€‚

è®©æˆ‘çœ‹çœ‹ä½ ä»¬çš„è‹±è¯­æ°´å¹³å¦‚ä½•ï¼Ÿ

å¿«ï¼ä¸€ç§’é’Ÿå‘Šè¯‰æˆ‘`race`æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708bb15866277a4~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



å¥½å§...ä½ ä»¬æœç„¶å¾ˆå¼º...

`race`ï¼Œæ¯”èµ›ï¼Œèµ›è·‘çš„æ„æ€ã€‚

æ‰€ä»¥ä½¿ç”¨`.race()`æ–¹æ³•ï¼Œå®ƒåªä¼šè·å–æœ€å…ˆæ‰§è¡Œå®Œæˆçš„é‚£ä¸ªç»“æœï¼Œå…¶å®ƒçš„å¼‚æ­¥ä»»åŠ¡è™½ç„¶ä¹Ÿä¼šç»§ç»­è¿›è¡Œä¸‹å»ï¼Œä¸è¿‡`race`å·²ç»ä¸ç®¡é‚£äº›ä»»åŠ¡çš„ç»“æœäº†ã€‚

æ¥ï¼Œæ”¹é€ ä¸€ä¸‹`4.1`è¿™é“é¢˜ï¼š

```arcade
function runAsync (x) {
  const p = new Promise(r => setTimeout(() => r(x, console.log(x)), 1000))
  return p
}
Promise.race([runAsync(1), runAsync(2), runAsync(3)])
  .then(res => console.log('result: ', res))
  .catch(err => console.log(err))å¤åˆ¶ä»£ç 
```

æ‰§è¡Œç»“æœä¸ºï¼š

```scheme
1
'result: ' 1
2
3å¤åˆ¶ä»£ç 
```

> è¿™ä¸ªraceæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿä½¿ç”¨åœºæ™¯è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç”¨raceç»™æŸä¸ªå¼‚æ­¥è¯·æ±‚è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¹¶ä¸”åœ¨è¶…æ—¶åæ‰§è¡Œç›¸åº”çš„æ“ä½œ

#### 4.4 é¢˜ç›®å››

æ”¹é€ ä¸€ä¸‹é¢˜ç›®`4.2`ï¼š

```arcade
function runAsync(x) {
  const p = new Promise(r =>
    setTimeout(() => r(x, console.log(x)), 1000)
  );
  return p;
}
function runReject(x) {
  const p = new Promise((res, rej) =>
    setTimeout(() => rej(`Error: ${x}`, console.log(x)), 1000 * x)
  );
  return p;
}
Promise.race([runReject(0), runAsync(1), runAsync(2), runAsync(3)])
  .then(res => console.log("result: ", res))
  .catch(err => console.log(err));å¤åˆ¶ä»£ç 
```

é‡åˆ°é”™è¯¯çš„è¯ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåœ¨è¿™é“é¢˜ä¸­ï¼Œ`runReject(0)`æœ€å…ˆæ‰§è¡Œå®Œï¼Œæ‰€ä»¥è¿›å…¥äº†`catch()`ä¸­ï¼š

```scheme
0
'Error: 0'
1
2
3å¤åˆ¶ä»£ç 
```

#### æ€»ç»“

å¥½çš„ï¼Œè®©æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹`.then()`å’Œ`.race()`å§ï¼ŒğŸ˜„

- `Promise.all()`çš„ä½œç”¨æ˜¯æ¥æ”¶ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œåæ‰æ‰§è¡Œå›è°ƒã€‚
- `.race()`çš„ä½œç”¨ä¹Ÿæ˜¯æ¥æ”¶ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œåªä¿ç•™å–ç¬¬ä¸€ä¸ªæ‰§è¡Œå®Œæˆçš„å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå…¶ä»–çš„æ–¹æ³•ä»åœ¨æ‰§è¡Œï¼Œä¸è¿‡æ‰§è¡Œç»“æœä¼šè¢«æŠ›å¼ƒã€‚
- `Promise.all().then()`ç»“æœä¸­æ•°ç»„çš„é¡ºåºå’Œ`Promise.all()`æ¥æ”¶åˆ°çš„æ•°ç»„é¡ºåºä¸€è‡´ã€‚
- `allå’Œrace`ä¼ å…¥çš„æ•°ç»„ä¸­å¦‚æœæœ‰ä¼šæŠ›å‡ºå¼‚å¸¸çš„å¼‚æ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆåªæœ‰æœ€å…ˆæŠ›å‡ºçš„é”™è¯¯ä¼šè¢«æ•è·ï¼Œå¹¶ä¸”æ˜¯è¢«`then`çš„ç¬¬äºŒä¸ªå‚æ•°æˆ–è€…åé¢çš„`catch`æ•è·ï¼›ä½†å¹¶ä¸ä¼šå½±å“æ•°ç»„ä¸­å…¶å®ƒçš„å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œã€‚

### 5. async/awaitçš„å‡ é“é¢˜

æ—¢ç„¶è°ˆåˆ°äº†`Promise`ï¼Œé‚£å°±è‚¯å®šå¾—å†è¯´è¯´`async/await`ï¼Œåœ¨å¾ˆå¤šæ—¶å€™`async`å’Œ`Promise`çš„è§£æ³•å·®ä¸å¤šï¼Œåˆæœ‰äº›ä¸ä¸€æ ·ã€‚ä¸ä¿¡ä½ æ¥çœ‹çœ‹é¢˜ç›®ä¸€ã€‚

#### 5.1 é¢˜ç›®ä¸€

```arcade
async function async1() {
  console.log("async1 start");
  await async2();
  console.log("async1 end");
}
async function async2() {
  console.log("async2");
}
async1();
console.log('start')å¤åˆ¶ä»£ç 
```

è¿™é“åŸºç¡€é¢˜è¾“å‡ºçš„æ˜¯å•¥ï¼Ÿ

ç­”æ¡ˆï¼š

```sml
'async1 start'
'async2'
'start'
'async1 end'å¤åˆ¶ä»£ç 
```

è¿‡ç¨‹åˆ†æï¼š

- é¦–å…ˆä¸€è¿›æ¥æ˜¯åˆ›å»ºäº†ä¸¤ä¸ªå‡½æ•°çš„ï¼Œæˆ‘ä»¬å…ˆä¸çœ‹å‡½æ•°çš„åˆ›å»ºä½ç½®ï¼Œè€Œæ˜¯çœ‹å®ƒçš„è°ƒç”¨ä½ç½®
- å‘ç°`async1`å‡½æ•°è¢«è°ƒç”¨äº†ï¼Œç„¶åå»çœ‹çœ‹è°ƒç”¨çš„å†…å®¹
- æ‰§è¡Œå‡½æ•°ä¸­çš„åŒæ­¥ä»£ç `async1 start`ï¼Œä¹‹åç¢°åˆ°äº†`await`ï¼Œå®ƒä¼šé˜»å¡`async1`åé¢ä»£ç çš„æ‰§è¡Œï¼Œå› æ­¤ä¼šå…ˆå»æ‰§è¡Œ`async2`ä¸­çš„åŒæ­¥ä»£ç `async2`ï¼Œç„¶åè·³å‡º`async1`
- è·³å‡º`async1`å‡½æ•°åï¼Œæ‰§è¡ŒåŒæ­¥ä»£ç `start`
- åœ¨ä¸€è½®å®ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œä¹‹åï¼Œå†æ¥æ‰§è¡Œåˆšåˆš`await`åé¢çš„å†…å®¹`async1 end`ã€‚

åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥ç†è§£ä¸ºã€Œç´§è·Ÿç€awaitåé¢çš„è¯­å¥ç›¸å½“äºæ”¾åˆ°äº†new Promiseä¸­ï¼Œä¸‹ä¸€è¡ŒåŠä¹‹åçš„è¯­å¥ç›¸å½“äºæ”¾åœ¨Promise.thenä¸­ã€ã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹å°†`await`è½¬æ¢ä¸º`Promise.then`çš„ä¼ªä»£ç ï¼š

```arcade
async function async1() {
  console.log("async1 start");
  // åŸæ¥ä»£ç 
  // await async2();
  // console.log("async1 end");
  
  // è½¬æ¢åä»£ç 
  new Promise(resolve => {
    console.log("async2")
    resolve()
  }).then(res => console.log("async1 end"))
}
async function async2() {
  console.log("async2");
}
async1();
console.log("start")å¤åˆ¶ä»£ç 
```

è½¬æ¢åçš„ä¼ªä»£ç å’Œå‰é¢çš„æ‰§è¡Œç»“æœæ˜¯ä¸€æ ·çš„ã€‚(æ„Ÿè°¢è¯„è®ºåŒº[Wing93](https://juejin.cn/user/3421335914314061)å’Œ[Jexxie](https://juejin.cn/user/1926000100012317)å°ä¼™ä¼´çš„æŒ‡å‡º)

å¦å¤–å…³äº`await`å’Œ`Promise`çš„åŒºåˆ«ï¼Œå¦‚æœæˆ‘ä»¬æŠŠ`await async2()`æ¢æˆä¸€ä¸ª`new Promise`å‘¢ï¼Ÿ

```arcade
async function async1() {
  console.log("async1 start");
  new Promise(resolve => {
    console.log('promise')
  })
  console.log("async1 end");
}
async1();
console.log("start")å¤åˆ¶ä»£ç 
```

æ­¤æ—¶çš„æ‰§è¡Œç»“æœä¸ºï¼š

```sml
'async start'
'promise'
'async1 end'
'start'å¤åˆ¶ä»£ç 
```

å¯ä»¥çœ‹åˆ°`new Promise()`å¹¶ä¸ä¼šé˜»å¡åé¢çš„åŒæ­¥ä»£ç `async1 end`çš„æ‰§è¡Œã€‚

#### 5.2 é¢˜ç›®äºŒ

ç°åœ¨å°†`async`ç»“åˆå®šæ—¶å™¨çœ‹çœ‹ã€‚

ç»™é¢˜ç›®ä¸€ä¸­çš„ `async2`å‡½æ•°ä¸­åŠ ä¸Šä¸€ä¸ªå®šæ—¶å™¨ï¼š

```arcade
async function async1() {
  console.log("async1 start");
  await async2();
  console.log("async1 end");
}
async function async2() {
  setTimeout(() => {
    console.log('timer')
  }, 0)
  console.log("async2");
}
async1();
console.log("start")å¤åˆ¶ä»£ç 
```

æ²¡é”™ï¼Œå®šæ—¶å™¨å§‹ç»ˆè¿˜æ˜¯æœ€åæ‰§è¡Œçš„ï¼Œå®ƒè¢«æ”¾åˆ°ä¸‹ä¸€æ¡å®ä»»åŠ¡çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­ã€‚

ç­”æ¡ˆï¼š

```sml
'async1 start'
'async2'
'start'
'async1 end'
'timer'å¤åˆ¶ä»£ç 
```

#### 5.3 é¢˜ç›®ä¸‰

æ¥å§ï¼Œå°ä¼™ä¼´ä»¬ï¼Œè®©æˆ‘ä»¬å¤šåŠ å‡ ä¸ªå®šæ—¶å™¨çœ‹çœ‹ã€‚ğŸ˜

```arcade
async function async1() {
  console.log("async1 start");
  await async2();
  console.log("async1 end");
  setTimeout(() => {
    console.log('timer1')
  }, 0)
}
async function async2() {
  setTimeout(() => {
    console.log('timer2')
  }, 0)
  console.log("async2");
}
async1();
setTimeout(() => {
  console.log('timer3')
}, 0)
console.log("start")å¤åˆ¶ä»£ç 
```

æ€è€ƒä¸€ä¸‹ğŸ¤”ï¼Œæ‰§è¡Œç»“æœä¼šæ˜¯ä»€ä¹ˆï¼Ÿ

å…¶å®å¦‚æœä½ èƒ½åšåˆ°è¿™é‡Œäº†ï¼Œè¯´æ˜ä½ å‰é¢çš„é‚£äº›çŸ¥è¯†ç‚¹ä¹Ÿéƒ½æŒæ¡äº†ï¼Œæˆ‘å°±ä¸éœ€è¦å¤ªè¿‡è¯¦ç»†çš„æ­¥éª¤åˆ†æäº†ã€‚

ç›´æ¥å…¬å¸ƒç­”æ¡ˆå§ï¼š

```sml
'async1 start'
'async2'
'start'
'async1 end'
'timer2'
'timer3'
'timer1'å¤åˆ¶ä»£ç 
```

å®šæ—¶å™¨è°å…ˆæ‰§è¡Œï¼Œä½ åªéœ€è¦å…³æ³¨è°å…ˆè¢«è°ƒç”¨çš„ä»¥åŠå»¶è¿Ÿæ—¶é—´æ˜¯å¤šå°‘ï¼Œè¿™é“é¢˜ä¸­å»¶è¿Ÿæ—¶é—´éƒ½æ˜¯`0`ï¼Œæ‰€ä»¥åªè¦å…³æ³¨è°å…ˆè¢«è°ƒç”¨çš„ã€‚ã€‚

#### 5.4 é¢˜ç›®å››

æ­£å¸¸æƒ…å†µä¸‹ï¼Œ`async`ä¸­çš„`await`å‘½ä»¤æ˜¯ä¸€ä¸ª`Promise`å¯¹è±¡ï¼Œè¿”å›è¯¥å¯¹è±¡çš„ç»“æœã€‚

ä½†å¦‚æœä¸æ˜¯`Promise`å¯¹è±¡çš„è¯ï¼Œå°±ä¼šç›´æ¥è¿”å›å¯¹åº”çš„å€¼ï¼Œç›¸å½“äº`Promise.resolve()`

```arcade
async function fn () {
  // return await 1234
  // ç­‰åŒäº
  return 123
}
fn().then(res => console.log(res))å¤åˆ¶ä»£ç 
```

ç»“æœï¼š

```
123å¤åˆ¶ä»£ç 
```

#### 5.5 é¢˜ç›®äº”

```arcade
async function async1 () {
  console.log('async1 start');
  await new Promise(resolve => {
    console.log('promise1')
  })
  console.log('async1 success');
  return 'async1 end'
}
console.log('srcipt start')
async1().then(res => console.log(res))
console.log('srcipt end')å¤åˆ¶ä»£ç 
```

è¿™é“é¢˜ç›®æ¯”è¾ƒæœ‰æ„æ€ï¼Œå¤§å®¶è¦æ³¨æ„äº†ã€‚

åœ¨`async1`ä¸­`await`åé¢çš„`Promise`æ˜¯æ²¡æœ‰è¿”å›å€¼çš„ï¼Œä¹Ÿå°±æ˜¯å®ƒçš„çŠ¶æ€å§‹ç»ˆæ˜¯`pending`çŠ¶æ€ï¼Œå› æ­¤ç›¸å½“äºä¸€ç›´åœ¨`await`ï¼Œ`await`ï¼Œ`await`å´å§‹ç»ˆæ²¡æœ‰å“åº”...



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708bb1987d7181b~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



æ‰€ä»¥åœ¨`await`ä¹‹åçš„å†…å®¹æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œä¹ŸåŒ…æ‹¬`async1`åé¢çš„ `.then`ã€‚

ç­”æ¡ˆä¸ºï¼š

```sml
'script start'
'async1 start'
'promise1'
'script end'å¤åˆ¶ä»£ç 
```

#### 5.6 é¢˜ç›®å…­

è®©æˆ‘ä»¬ç»™`5.5`ä¸­çš„`Promise`åŠ ä¸Š`resolve`ï¼š

```arcade
async function async1 () {
  console.log('async1 start');
  await new Promise(resolve => {
    console.log('promise1')
    resolve('promise1 resolve')
  }).then(res => console.log(res))
  console.log('async1 success');
  return 'async1 end'
}
console.log('srcipt start')
async1().then(res => console.log(res))
console.log('srcipt end')å¤åˆ¶ä»£ç 
```

ç°åœ¨`Promise`æœ‰äº†è¿”å›å€¼äº†ï¼Œå› æ­¤`await`åé¢çš„å†…å®¹å°†ä¼šè¢«æ‰§è¡Œï¼š

```sml
'script start'
'async1 start'
'promise1'
'script end'
'promise1 resolve'
'async1 success'
'async1 end'å¤åˆ¶ä»£ç 
```

#### 5.7 é¢˜ç›®ä¸ƒ

```arcade
async function async1 () {
  console.log('async1 start');
  await new Promise(resolve => {
    console.log('promise1')
    resolve('promise resolve')
  })
  console.log('async1 success');
  return 'async1 end'
}
console.log('srcipt start')
async1().then(res => {
  console.log(res)
})
new Promise(resolve => {
  console.log('promise2')
  setTimeout(() => {
    console.log('timer')
  })
})å¤åˆ¶ä»£ç 
```

è¿™é“é¢˜åº”è¯¥ä¹Ÿä¸éš¾ï¼Œä¸è¿‡æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„ï¼Œåœ¨`async1`ä¸­çš„`new Promise`å®ƒçš„`resovle`çš„å€¼å’Œ`async1().then()`é‡Œçš„å€¼æ˜¯æ²¡æœ‰å…³ç³»çš„ï¼Œå¾ˆå¤šå°ä¼™ä¼´å¯èƒ½çœ‹åˆ°`resovle('promise resolve')`å°±ä¼šè¯¯ä»¥ä¸ºæ˜¯`async1().then()`ä¸­çš„è¿”å›å€¼ã€‚

å› æ­¤è¿™é‡Œçš„æ‰§è¡Œç»“æœä¸ºï¼š

```sml
'script start'
'async1 start'
'promise1'
'promise2'
'async1 success'
'async1 end'
'timer'å¤åˆ¶ä»£ç 
```

#### 5.8 é¢˜ç›®å…«

æˆ‘ä»¬å†æ¥çœ‹ä¸€é“å¤´æ¡æ›¾ç»çš„é¢è¯•é¢˜ï¼š

```arcade
async function async1() {
  console.log("async1 start");
  await async2();
  console.log("async1 end");
}

async function async2() {
  console.log("async2");
}

console.log("script start");

setTimeout(function() {
  console.log("setTimeout");
}, 0);

async1();

new Promise(function(resolve) {
  console.log("promise1");
  resolve();
}).then(function() {
  console.log("promise2");
});
console.log('script end')å¤åˆ¶ä»£ç 
```

æœ‰äº†ä¸Šé¢ğŸ‘†å‡ é¢˜åšåŸºç¡€ï¼Œç›¸ä¿¡ä½ å¾ˆå¿«ä¹Ÿèƒ½ç­”ä¸Šæ¥äº†ã€‚



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708bb005aa667c3~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



è‡ªä¿¡çš„å†™ä¸‹ä½ ä»¬çš„ç­”æ¡ˆå§ã€‚

```sml
'script start'
'async1 start'
'async2'
'promise1'
'script end'
'async1 end'
'promise2'
'setTimeout'å¤åˆ¶ä»£ç 
```

(è¿™é“é¢˜æœ€å`async1 end`å’Œ`promise2`çš„é¡ºåºå…¶å®åœ¨ç½‘ä¸Šé¥±å—äº‰è®®ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨æµè§ˆå™¨`Chrome V80`ï¼Œ`Node v12.16.1`çš„æ‰§è¡Œç»“æœéƒ½æ˜¯ä¸Šé¢è¿™ä¸ªç­”æ¡ˆ)

#### 5.9 é¢˜ç›®ä¹

å¥½çš„ğŸ‘Œï¼Œ`async/await`å¤§æ³•å·²ç»ƒæˆï¼Œå’±ä»¬ç»§ç»­ï¼š

```arcade
async function testSometing() {
  console.log("æ‰§è¡ŒtestSometing");
  return "testSometing";
}

async function testAsync() {
  console.log("æ‰§è¡ŒtestAsync");
  return Promise.resolve("hello async");
}

async function test() {
  console.log("test start...");
  const v1 = await testSometing();
  console.log(v1);
  const v2 = await testAsync();
  console.log(v2);
  console.log(v1, v2);
}

test();

var promise = new Promise(resolve => {
  console.log("promise start...");
  resolve("promise");
});
promise.then(val => console.log(val));

console.log("test end...");å¤åˆ¶ä»£ç 
```

ç­”æ¡ˆï¼š

```1c
'test start...'
'æ‰§è¡ŒtestSometing'
'promise start...'
'test end...'
'testSometing'
'æ‰§è¡ŒtestAsync'
'promise'
'hello async'
'testSometing' 'hello async'å¤åˆ¶ä»£ç 
```

### 6. asyncå¤„ç†é”™è¯¯

#### 6.1 é¢˜ç›®ä¸€

åœ¨`async`ä¸­ï¼Œå¦‚æœ `await`åé¢çš„å†…å®¹æ˜¯ä¸€ä¸ªå¼‚å¸¸æˆ–è€…é”™è¯¯çš„è¯ï¼Œä¼šæ€æ ·å‘¢ï¼Ÿ

```arcade
async function async1 () {
  await async2();
  console.log('async1');
  return 'async1 success'
}
async function async2 () {
  return new Promise((resolve, reject) => {
    console.log('async2')
    reject('error')
  })
}
async1().then(res => console.log(res))å¤åˆ¶ä»£ç 
```

ä¾‹å¦‚è¿™é“é¢˜ä¸­ï¼Œ`await`åé¢è·Ÿç€çš„æ˜¯ä¸€ä¸ªçŠ¶æ€ä¸º`rejected`çš„`promise`ã€‚

**å¦‚æœåœ¨asyncå‡½æ•°ä¸­æŠ›å‡ºäº†é”™è¯¯ï¼Œåˆ™ç»ˆæ­¢é”™è¯¯ç»“æœï¼Œä¸ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚**

æ‰€ä»¥ç­”æ¡ˆä¸ºï¼š

```aspectj
'async2'
Uncaught (in promise) errorå¤åˆ¶ä»£ç 
```

å¦‚æœæ”¹ä¸º`throw new Error`ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼š

```arcade
async function async1 () {
  console.log('async1');
  throw new Error('error!!!')
  return 'async1 success'
}
async1().then(res => console.log(res))å¤åˆ¶ä»£ç 
```

ç»“æœä¸ºï¼š

```erlang-repl
'async1'
Uncaught (in promise) Error: error!!!å¤åˆ¶ä»£ç 
```

#### 6.2 é¢˜ç›®äºŒ

å¦‚æœæƒ³è¦ä½¿å¾—é”™è¯¯çš„åœ°æ–¹ä¸å½±å“`async`å‡½æ•°åç»­çš„æ‰§è¡Œçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨`try catch`

```arcade
async function async1 () {
  try {
    await Promise.reject('error!!!')
  } catch(e) {
    console.log(e)
  }
  console.log('async1');
  return Promise.resolve('async1 success')
}
async1().then(res => console.log(res))
console.log('script start')å¤åˆ¶ä»£ç 
```

è¿™é‡Œçš„ç»“æœä¸ºï¼š

```1c
'script start'
'error!!!'
'async1'
'async1 success'å¤åˆ¶ä»£ç 
```

æˆ–è€…ä½ å¯ä»¥ç›´æ¥åœ¨`Promise.reject`åé¢è·Ÿç€ä¸€ä¸ª`catch()`æ–¹æ³•ï¼š

```arcade
async function async1 () {
  // try {
  //   await Promise.reject('error!!!')
  // } catch(e) {
  //   console.log(e)
  // }
  await Promise.reject('error!!!')
    .catch(e => console.log(e))
  console.log('async1');
  return Promise.resolve('async1 success')
}
async1().then(res => console.log(res))
console.log('script start')å¤åˆ¶ä»£ç 
```

è¿è¡Œç»“æœæ˜¯ä¸€æ ·çš„ã€‚

### 7. ç»¼åˆé¢˜

ä¸Šé¢ğŸ‘†çš„é¢˜ç›®éƒ½æ˜¯è¢«æˆ‘æ‹†åˆ†ç€è¯´ä¸€äº›åŠŸèƒ½ç‚¹ï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥åšä¸€äº›æ¯”è¾ƒéš¾çš„ç»¼åˆé¢˜å§ã€‚

#### 7.1 é¢˜ç›®ä¸€

```arcade
const first = () => (new Promise((resolve, reject) => {
    console.log(3);
    let p = new Promise((resolve, reject) => {
        console.log(7);
        setTimeout(() => {
            console.log(5);
            resolve(6);
            console.log(p)
        }, 0)
        resolve(1);
    });
    resolve(2);
    p.then((arg) => {
        console.log(arg);
    });
}));
first().then((arg) => {
    console.log(arg);
});
console.log(4);å¤åˆ¶ä»£ç 
```

è¿‡ç¨‹åˆ†æï¼š

- ç¬¬ä¸€æ®µä»£ç å®šä¹‰çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—çœ‹çœ‹å®ƒæ˜¯åœ¨å“ªæ‰§è¡Œçš„ï¼Œå‘ç°å®ƒåœ¨`4`ä¹‹å‰ï¼Œæ‰€ä»¥å¯ä»¥æ¥çœ‹çœ‹`first`å‡½æ•°é‡Œé¢çš„å†…å®¹äº†ã€‚(è¿™ä¸€æ­¥æœ‰ç‚¹ç±»ä¼¼äºé¢˜ç›®`1.5`)
- å‡½æ•°`first`è¿”å›çš„æ˜¯ä¸€ä¸ª`new Promise()`ï¼Œå› æ­¤å…ˆæ‰§è¡Œé‡Œé¢çš„åŒæ­¥ä»£ç `3`
- æ¥ç€åˆé‡åˆ°äº†ä¸€ä¸ª`new Promise()`ï¼Œç›´æ¥æ‰§è¡Œé‡Œé¢çš„åŒæ­¥ä»£ç `7`
- æ‰§è¡Œå®Œ`7`ä¹‹åï¼Œåœ¨`p`ä¸­ï¼Œé‡åˆ°äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå…ˆå°†å®ƒæ”¾åˆ°ä¸‹ä¸€ä¸ªå®ä»»åŠ¡é˜Ÿåˆ—é‡Œä¸ç®¡å®ƒï¼Œæ¥ç€å‘ä¸‹èµ°
- ç¢°åˆ°äº†`resolve(1)`ï¼Œè¿™é‡Œå°±æŠŠ`p`çš„çŠ¶æ€æ”¹ä¸ºäº†`resolved`ï¼Œä¸”è¿”å›å€¼ä¸º`1`ï¼Œä¸è¿‡è¿™é‡Œä¹Ÿå…ˆä¸æ‰§è¡Œ
- è·³å‡º`p`ï¼Œç¢°åˆ°äº†`resolve(2)`ï¼Œè¿™é‡Œçš„`resolve(2)`ï¼Œè¡¨ç¤ºçš„æ˜¯æŠŠ`first`å‡½æ•°è¿”å›çš„é‚£ä¸ª`Promise`çš„çŠ¶æ€æ”¹äº†ï¼Œä¹Ÿå…ˆä¸ç®¡å®ƒã€‚
- ç„¶åç¢°åˆ°äº†`p.then`ï¼Œå°†å®ƒåŠ å…¥æœ¬æ¬¡å¾ªç¯çš„å¾®ä»»åŠ¡åˆ—è¡¨ï¼Œç­‰å¾…æ‰§è¡Œ
- è·³å‡º`first`å‡½æ•°ï¼Œé‡åˆ°äº†`first().then()`ï¼Œå°†å®ƒåŠ å…¥æœ¬æ¬¡å¾ªç¯çš„å¾®ä»»åŠ¡åˆ—è¡¨(`p.then`çš„åé¢æ‰§è¡Œ)
- ç„¶åæ‰§è¡ŒåŒæ­¥ä»£ç `4`
- æœ¬è½®çš„åŒæ­¥ä»£ç å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼ŒæŸ¥æ‰¾å¾®ä»»åŠ¡åˆ—è¡¨ï¼Œå‘ç°`p.then`å’Œ`first().then()`ï¼Œä¾æ¬¡æ‰§è¡Œï¼Œæ‰“å°å‡º`1å’Œ2`
- æœ¬è½®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•äº†ï¼Œå‘ç°è¿˜æœ‰ä¸€ä¸ªå®šæ—¶å™¨æ²¡æœ‰è·‘å®Œï¼Œæ¥ç€æ‰§è¡Œè¿™ä¸ªå®šæ—¶å™¨é‡Œçš„å†…å®¹ï¼Œæ‰§è¡ŒåŒæ­¥ä»£ç `5`
- ç„¶ååˆé‡åˆ°äº†ä¸€ä¸ª`resolve(6)`ï¼Œå®ƒæ˜¯æ”¾åœ¨`p`é‡Œçš„ï¼Œä½†æ˜¯`p`çš„çŠ¶æ€åœ¨ä¹‹å‰å·²ç»å‘ç”Ÿè¿‡æ”¹å˜äº†ï¼Œå› æ­¤è¿™é‡Œå°±ä¸ä¼šå†æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯è¯´`resolve(6)`ç›¸å½“äºæ²¡ä»»ä½•ç”¨å¤„ï¼Œå› æ­¤æ‰“å°å‡ºæ¥çš„`p`ä¸º`Promise{: 1}`ã€‚(è¿™ä¸€æ­¥ç±»ä¼¼äºé¢˜ç›®`3.1`)

ç»“æœï¼š

```apache
3
7
4
1
2
5
Promise{<resolved>: 1}å¤åˆ¶ä»£ç 
```

åšå¯¹äº†çš„å°ä¼™ä¼´å¥–åŠ±è‡ªå·±ä¸€æœµå°`(å¤§)`çº¢`(å˜´)`èŠ±`(å·´)`å§ï¼ŒğŸ˜„



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708bb1c9abe9b51~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



#### 7.2 é¢˜ç›®äºŒ

```arcade
const async1 = async () => {
  console.log('async1');
  setTimeout(() => {
    console.log('timer1')
  }, 2000)
  await new Promise(resolve => {
    console.log('promise1')
  })
  console.log('async1 end')
  return 'async1 success'
} 
console.log('script start');
async1().then(res => console.log(res));
console.log('script end');
Promise.resolve(1)
  .then(2)
  .then(Promise.resolve(3))
  .catch(4)
  .then(res => console.log(res))
setTimeout(() => {
  console.log('timer2')
}, 1000)å¤åˆ¶ä»£ç 
```

æ³¨æ„çš„çŸ¥è¯†ç‚¹ï¼š

- `async`å‡½æ•°ä¸­`await`çš„`new Promise`è¦æ˜¯æ²¡æœ‰è¿”å›å€¼çš„è¯åˆ™ä¸æ‰§è¡Œåé¢çš„å†…å®¹(ç±»ä¼¼é¢˜`5.5`)
- `.then`å‡½æ•°ä¸­çš„å‚æ•°æœŸå¾…çš„æ˜¯å‡½æ•°ï¼Œå¦‚æœä¸æ˜¯å‡½æ•°çš„è¯ä¼šå‘ç”Ÿé€ä¼ (ç±»ä¼¼é¢˜`3.8` )
- æ³¨æ„å®šæ—¶å™¨çš„å»¶è¿Ÿæ—¶é—´

å› æ­¤æœ¬é¢˜ç­”æ¡ˆä¸ºï¼š

```sml
'script start'
'async1'
'promise1'
'script end'
1
'timer2'
'timer1'å¤åˆ¶ä»£ç 
```

#### 7.3 é¢˜ç›®ä¸‰

```arcade
const p1 = new Promise((resolve) => {
  setTimeout(() => {
    resolve('resolve3');
    console.log('timer1')
  }, 0)
  resolve('resovle1');
  resolve('resolve2');
}).then(res => {
  console.log(res)
  setTimeout(() => {
    console.log(p1)
  }, 1000)
}).finally(res => {
  console.log('finally', res)
})å¤åˆ¶ä»£ç 
```

æ³¨æ„çš„çŸ¥è¯†ç‚¹ï¼š

- `Promise`çš„çŠ¶æ€ä¸€æ—¦æ”¹å˜å°±æ— æ³•æ”¹å˜(ç±»ä¼¼é¢˜ç›®`3.5`)
- `finally`ä¸ç®¡`Promise`çš„çŠ¶æ€æ˜¯`resolved`è¿˜æ˜¯`rejected`éƒ½ä¼šæ‰§è¡Œï¼Œä¸”å®ƒçš„å›è°ƒå‡½æ•°æ˜¯æ¥æ”¶ä¸åˆ°`Promise`çš„ç»“æœçš„ï¼Œæ‰€ä»¥`finally()`ä¸­çš„`res`æ˜¯ä¸€ä¸ªè¿·æƒ‘é¡¹(ç±»ä¼¼`3.10`)ã€‚
- æœ€åä¸€ä¸ªå®šæ—¶å™¨æ‰“å°å‡ºçš„`p1`å…¶å®æ˜¯`.finally`çš„è¿”å›å€¼ï¼Œæˆ‘ä»¬çŸ¥é“`.finally`çš„è¿”å›å€¼å¦‚æœåœ¨æ²¡æœ‰æŠ›å‡ºé”™è¯¯çš„æƒ…å†µä¸‹é»˜è®¤ä¼šæ˜¯ä¸Šä¸€ä¸ª`Promise`çš„è¿”å›å€¼(`3.10`ä¸­ä¹Ÿæœ‰æåˆ°), è€Œè¿™é“é¢˜ä¸­`.finally`ä¸Šä¸€ä¸ª`Promise`æ˜¯`.then()`ï¼Œä½†æ˜¯è¿™ä¸ª`.then()`å¹¶æ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥`p1`æ‰“å°å‡ºæ¥çš„`Promise`çš„å€¼ä¼šæ˜¯`undefined`ï¼Œå¦‚æœä½ åœ¨å®šæ—¶å™¨çš„**ä¸‹é¢**åŠ ä¸Šä¸€ä¸ª`return 1`ï¼Œåˆ™å€¼å°±ä¼šå˜æˆ`1`(æ„Ÿè°¢æ˜å‹[JSä¸›ä¸­è¿‡](https://juejin.cn/user/2260251637193639)çš„æŒ‡å‡º)ã€‚

ç­”æ¡ˆï¼š

```coffeescript
'resolve1'
'finally' undefined
'timer1'
Promise{<resolved>: undefined}å¤åˆ¶ä»£ç 
```

### 8. å‡ é“å¤§å‚çš„é¢è¯•é¢˜

#### 8.1 ä½¿ç”¨Promiseå®ç°æ¯éš”1ç§’è¾“å‡º1,2,3

è¿™é“é¢˜æ¯”è¾ƒç®€å•çš„ä¸€ç§åšæ³•æ˜¯å¯ä»¥ç”¨`Promise`é…åˆç€`reduce`ä¸åœçš„åœ¨`promise`åé¢å åŠ `.then`ï¼Œè¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼š

```coffeescript
const arr = [1, 2, 3]
arr.reduce((p, x) => {
  return p.then(() => {
    return new Promise(r => {
      setTimeout(() => r(console.log(x)), 1000)
    })
  })
}, Promise.resolve())å¤åˆ¶ä»£ç 
```

æˆ–è€…ä½ å¯ä»¥æ›´ç®€å•ä¸€ç‚¹å†™ï¼š

```coffeescript
const arr = [1, 2, 3]
arr.reduce((p, x) => p.then(() => new Promise(r => setTimeout(() => r(console.log(x)), 1000))), Promise.resolve())å¤åˆ¶ä»£ç 
```

å‚è€ƒé“¾æ¥ï¼š[å¦‚ä½•è®©å¼‚æ­¥æ“ä½œé¡ºåºæ‰§è¡Œ](https://link.juejin.cn?target=https%3A%2F%2Fsegmentfault.com%2Fq%2F1010000010748967)

**æ‹“å±•é¢˜**

è¿™é“æ‹“å±•é¢˜æ¥è‡ªäºâ€œä¸‡ç‰©çš†å¯çˆ±çš„[LINGLONG](https://juejin.cn/user/2436173498955032) â€å°å§å§ï¼Œç‚’é¸¡æ£’ ğŸ˜ğŸ‘ã€‚

é¢˜ç›®æ˜¯è¿™æ ·çš„ï¼Œå¥¹æŠŠæˆ‘ä¸Šé¢ğŸ‘†å†™çš„ç®­å¤´å‡½æ•°ç‰ˆæœ¬æ”¹é€ äº†ä¸€ä¸‹ï¼š

```javascript
const arr = [1, 2, 3];
const result = arr.reduce((p, x) => p.then(new Promise(r => setTimeout(() => r(console.log(x)), 1000))), Promise.resolve());å¤åˆ¶ä»£ç 
```

çœ¼å°–çš„å°ä¼™ä¼´çœ‹å‡ºåŒºåˆ«äº†å—ï¼ŸğŸ˜

`p.then`é‡Œçš„ä»£ç ç”±`() => new Promise(...)`å˜æˆäº†`new Promise(...)`ã€‚

ç°åœ¨æ‰§è¡Œç»“æœå°±å¤§ä¸ç›¸åŒäº†ã€‚

**åœ¨ä¸€ç§’åæŒ‰é¡ºåºåŒæ—¶æ‰“å°å‡º`1ã€2ã€3`:**

```
1
2
3å¤åˆ¶ä»£ç 
```

å’¦ ğŸ¤”ï¸ï¼Ÿä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ ğŸ¤”ï¸ï¼Ÿ

åªæ˜¯ä¸€ä¸ªå°å°çš„æ”¹å˜å´æœ‰å¤§å¤§çš„åŒºåˆ«ã€‚

å…¶å®åˆšå¼€å§‹çœ‹åˆ°çš„æ—¶å€™éœ–å‘†å‘†æˆ‘ä¹Ÿæ„£äº†é‚£ä¹ˆå‡ ç§’ğŸ˜‚ã€‚ä¸è¿‡ç­‰æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ‹†åˆ†å¹¶å¯¹æƒ³ä¸é€šçš„åœ°æ–¹å†™äº†å‡ ä¸ªæ¡ˆä¾‹æ¥çœ‹å°±ç†è§£äº†ã€‚

è¯„è®ºåŒºå’Œå°å§å§æ‰¯äº†ä¸€å¤§å †ï¼Œç»“æœæŠŠå¥¹è¶Šå¼„è¶Šç³ŠğŸ˜‚ã€‚åæ¥æˆ‘æ”¹å˜äº†ä¸€ç§æ€è·¯æ¥æè¿°ï¼Œè§‰å¾—åº”è¯¥ç›´æ¥ä¸Šä¼ªä»£ç ï¼š

```coffeescript
const arr = [1, 2, 3]
arr.reduce((p, x) => p.then(() => new Promise(r => setTimeout(() => r(console.log(x)), 1000))), Promise.resolve())å¤åˆ¶ä»£ç 
```

è½¬æ¢ä¸ºä¼ªä»£ç å°±æ˜¯è¿™æ ·ï¼š

(ç›¸å½“äºæ˜¯ç”¨`reduce`ä¸åœçš„å¾€åé¢å åŠ `.then`)

```arcade
Promise.resolve()
  .then(() => {
    return new Promise(r => {
      setTimeout(() => {
        r(console.log(1))
      }, 1000)
    })
  })
  .then(r => {
    return new Promise(r => {
      setTimeout(() => {
        r(console.log(2))
      }, 1000)
    })
  })
  .then(r => {
    return new Promise(r => {
      setTimeout(() => {
        r(console.log(3))
      }, 1000)
    })
  })å¤åˆ¶ä»£ç 
```

å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€ä¸ª`.then`éƒ½æ˜¯ä¾èµ–äºä¸Šä¸€ä¸ª`new Promise`ä½•æ—¶è¢«`resolve`äº†æ‰ä¼šæ‰§è¡Œçš„ï¼Œä¾‹å¦‚ç¬¬äºŒä¸ª`.then()`ï¼Œå®ƒè¦ç­‰`r(console.log(1)`è¿™æ®µä»£ç æ‰§è¡Œäº†ï¼Œæ‰ä¼šæ‰§è¡Œã€‚

é‚£ä¹ˆ`r(console.log(1))`ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‘¢ï¼Ÿå°±æ˜¯åœ¨ç¬¬ä¸€ä¸ªå®šæ—¶å™¨(ä¹Ÿå°±æ˜¯ä¸€ç§’å)è§¦å‘çš„æ—¶å€™æ‰æ‰§è¡Œã€‚è¿™æ ·å°±ä¿è¯äº†åé¢æ¥ç€çš„`.then()`è¦ç­‰å‰ä¸€ä¸ªå®šæ—¶å™¨æ‰§è¡Œå®Œæ‰èƒ½æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯éš”ä¸€ç§’è¾“å‡ºã€‚

è€Œå¦‚æœæ˜¯è¿™æ ·å†™çš„è¯ï¼š

```javascript
const arr = [1, 2, 3];
const result = arr.reduce((p, x) => p.then(new Promise(r => setTimeout(() => r(console.log(x)), 1000))), Promise.resolve());å¤åˆ¶ä»£ç 
```

å®ƒçš„ä¼ªä»£ç å°±æ˜¯è¿™æ ·ï¼š

(æ¯ä¸ª`then`é‡Œé¢çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯ä¸€ä¸ªå‡½æ•°)

```arcade
Promise.resolve()
  .then(new Promise(r => {
    setTimeout(() => {
      r(console.log(1))
    }, 1000)
  }))
  .then(new Promise(r => {
    setTimeout(() => {
      r(console.log(2))
    }, 1000)
  }))
  .then(new Promise(r => {
    setTimeout(() => {
      r(console.log(3))
    }, 1000)
  }))å¤åˆ¶ä»£ç 
```

`p.then()`é‡Œé¢çš„å‚æ•°å¦‚æœä¸æ˜¯å‡½æ•°çš„è¯ï¼Œä¼šå‘ç”Ÿé€ä¼ ï¼Œè¿™ä¸ªåœ¨`3.8`ä¸­å·²ç»æè¿‡äº†ã€‚ä½†æ˜¯å‘ç”Ÿé€ä¼ ï¼Œ`.then()`é‡Œçš„ä»£ç å°±ä¸æ‰§è¡Œäº†å—ï¼Ÿ

å¹¶ä¸æ˜¯çš„ï¼Œæˆ‘ä»¬æ¥çœ‹è¿™ä¸ªä¾‹å­ï¼š

```arcade
const p = Promise.resolve(1).then(console.log('æˆ‘ä¸å…³å¿ƒç»“æœ'))
console.log(p)
p.then((res) => console.log(res))å¤åˆ¶ä»£ç 
```

å¾ˆæ˜æ˜¾è¿™é‡Œä¹Ÿå‘ç”Ÿäº†é€ä¼ ï¼Œä½†æ˜¯`'æˆ‘ä¸å…³å¿ƒç»“æœ'`ä¹Ÿè¿˜æ˜¯è¢«æ‰“å°å‡ºæ¥äº†ï¼Œå¹¶ä¸”ç”±äºé€ä¼ ï¼Œ`p.then()`é‡Œè·å–åˆ°çš„`res`å°±æ˜¯`1`ï¼Œå› æ­¤ä¼šæ‰“å°å‡ºï¼š

```lua
'æˆ‘ä¸å…³å¿ƒç»“æœ'
Promise{
[[PromiseStatus]]: "resolved"
[[PromiseValue]]: 1
}
1å¤åˆ¶ä»£ç 
```

(ç¬¬äºŒè¡Œæ‰“å°å‡º`Promise{}`çš„å°ä¼™ä¼´è¯·æŠŠè¿™ä¸ªå¯¹è±¡å±•å¼€æ¥çœ‹)

è¿™ä¸ªä¾‹å­è¡¨æ˜ï¼Œå°±ç®—å‘ç”Ÿäº†é€ä¼ ï¼Œ`p.then()`ä¸­çš„ä»£ç ä¾æ—§ä¹Ÿæ˜¯ä¼šæ‰§è¡Œçš„ã€‚

æ‰€ä»¥å›åˆ°

```arcade
.then(new Promise(r => {
    setTimeout(() => {
      r(console.log(1))
    }, 1000)
  }))å¤åˆ¶ä»£ç 
```

ä¸­ï¼Œç°åœ¨`.then()`ä¸­å°±ç›¸å½“äºæ˜¯æ‰§è¡Œä¸€æ®µåŒæ­¥ä»£ç ï¼š

```arcade
new Promise(r => {
    setTimeout(() => {
      r(console.log(1))
    }, 1000)
  })å¤åˆ¶ä»£ç 
```

è€Œè¿™æ®µä»£ç çš„ä½œç”¨æ˜¯å‘å»¶è¿Ÿé˜Ÿåˆ—ä¸­`push`ä¸€ä¸ªä¸€ç§’åæ‰§è¡Œçš„å®šæ—¶å™¨ä»»åŠ¡ã€‚

å¹¶ä¸”åœ¨`push`å®Œå®šæ—¶å™¨ä¹‹åï¼Œä»£ç å°±é©¬ä¸Šè¿›å…¥äº†ä¸‹ä¸€ä¸ª`.then`(å› ä¸ºæ—¢ç„¶ç¬¬ä¸€ä¸ª`.then`å·²ç»æ˜¯é€ä¼ çš„äº†å°±æ²¡æœ‰å¿…è¦ç­‰å®ƒçš„æ‰§è¡Œç»“æœäº†)

ä¸‹ä¸€ä¸ª`.then`ç«Ÿç„¶ä¹Ÿæ˜¯ä¸€ä¸ªé€ä¼ ï¼ŒOKï¼Œé‚£æˆ‘ç»§ç»­`push`è¿™ä¸ªå®šæ—¶å™¨ï¼Œç„¶åå†æ‰§è¡Œç¬¬ä¸‰ä¸ª`.then`ã€‚

ä¸‰ä¸ª`.then`å·²ç»æ‰§è¡Œå®Œæˆäº†ï¼Œç°åœ¨æˆ‘ä»¬çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­å·²ç»æœ‰äº†ä¸‰ä¸ªå®šæ—¶å™¨ç­‰å¾…æ‰§è¡Œï¼Œ**å¹¶ä¸”ä¸‰ä¸ªå®šæ—¶å™¨çš„å»¶è¿Ÿæ—¶é—´éƒ½æ˜¯1000ms!!!**ã€‚

æ‰€ä»¥ç­‰åˆ°äº†æ—¶é—´ä¹‹åï¼Œå°±ä¼šåŒæ—¶æ‰“å°å‡ºæ¥äº†`1ã€2ã€3`ã€‚ï¼ˆå…¶å®å‡†ç¡®æ¥è¯´ï¼Œä¸æ˜¯åŒæ—¶æ‰“å°çš„ï¼Œä¸è¿‡ä¸­é—´ç›¸å·®çš„æ—¶é—´éå¸¸éå¸¸çŸ­ï¼Œå¤§å¯å¿½ç•¥å®ƒï¼‰

ç°åœ¨ä½ æ˜¯å¦ç†è§£äº†å…¶ä¸­çš„åŒºåˆ«å‘¢ ğŸ˜ã€‚

#### 8.2 ä½¿ç”¨Promiseå®ç°çº¢ç»¿ç¯äº¤æ›¿é‡å¤äº®

çº¢ç¯3ç§’äº®ä¸€æ¬¡ï¼Œé»„ç¯2ç§’äº®ä¸€æ¬¡ï¼Œç»¿ç¯1ç§’äº®ä¸€æ¬¡ï¼›å¦‚ä½•è®©ä¸‰ä¸ªç¯ä¸æ–­äº¤æ›¿é‡å¤äº®ç¯ï¼Ÿï¼ˆç”¨Promiseå®ç°ï¼‰ä¸‰ä¸ªäº®ç¯å‡½æ•°å·²ç»å­˜åœ¨ï¼š

```arcade
function red() {
    console.log('red');
}
function green() {
    console.log('green');
}
function yellow() {
    console.log('yellow');
}å¤åˆ¶ä»£ç 
```

ç­”æ¡ˆï¼š

```arcade
function red() {
  console.log("red");
}
function green() {
  console.log("green");
}
function yellow() {
  console.log("yellow");
}
const light = function (timer, cb) {
  return new Promise(resolve => {
    setTimeout(() => {
      cb()
      resolve()
    }, timer)
  })
}
const step = function () {
  Promise.resolve().then(() => {
    return light(3000, red)
  }).then(() => {
    return light(2000, green)
  }).then(() => {
    return light(1000, yellow)
  }).then(() => {
    return step()
  })
}

step();å¤åˆ¶ä»£ç 
```

#### 8.3 å®ç°mergePromiseå‡½æ•°

å®ç°mergePromiseå‡½æ•°ï¼ŒæŠŠä¼ è¿›å»çš„æ•°ç»„æŒ‰é¡ºåºå…ˆåæ‰§è¡Œï¼Œå¹¶ä¸”æŠŠè¿”å›çš„æ•°æ®å…ˆåæ”¾åˆ°æ•°ç»„dataä¸­ã€‚

```arcade
const time = (timer) => {
  return new Promise(resolve => {
    setTimeout(() => {
      resolve()
    }, timer)
  })
}
const ajax1 = () => time(2000).then(() => {
  console.log(1);
  return 1
})
const ajax2 = () => time(1000).then(() => {
  console.log(2);
  return 2
})
const ajax3 = () => time(1000).then(() => {
  console.log(3);
  return 3
})

function mergePromise () {
  // åœ¨è¿™é‡Œå†™ä»£ç 
}

mergePromise([ajax1, ajax2, ajax3]).then(data => {
  console.log("done");
  console.log(data); // data ä¸º [1, 2, 3]
});

// è¦æ±‚åˆ†åˆ«è¾“å‡º
// 1
// 2
// 3
// done
// [1, 2, 3]å¤åˆ¶ä»£ç 
```

è¿™é“é¢˜æœ‰ç‚¹ç±»ä¼¼äº`Promise.all()`ï¼Œä¸è¿‡`.all()`ä¸éœ€è¦ç®¡æ‰§è¡Œé¡ºåºï¼Œåªéœ€è¦å¹¶å‘æ‰§è¡Œå°±è¡Œäº†ã€‚ä½†æ˜¯è¿™é‡Œéœ€è¦ç­‰ä¸Šä¸€ä¸ªæ‰§è¡Œå®Œæ¯•ä¹‹åæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªã€‚

è§£é¢˜æ€è·¯ï¼š

- å®šä¹‰ä¸€ä¸ªæ•°ç»„`data`ç”¨äºä¿å­˜æ‰€æœ‰å¼‚æ­¥æ“ä½œçš„ç»“æœ
- åˆå§‹åŒ–ä¸€ä¸ª`const promise = Promise.resolve()`ï¼Œç„¶åå¾ªç¯éå†æ•°ç»„ï¼Œåœ¨`promise`åé¢æ·»åŠ æ‰§è¡Œ`ajax`ä»»åŠ¡ï¼ŒåŒæ—¶è¦å°†æ·»åŠ çš„ç»“æœé‡æ–°èµ‹å€¼åˆ°`promise`ä¸Šã€‚

ç­”æ¡ˆï¼š

```arcade
function mergePromise (ajaxArray) {
  // å­˜æ”¾æ¯ä¸ªajaxçš„ç»“æœ
  const data = [];
  let promise = Promise.resolve();
  ajaxArray.forEach(ajax => {
  	// ç¬¬ä¸€æ¬¡çš„thenä¸ºäº†ç”¨æ¥è°ƒç”¨ajax
  	// ç¬¬äºŒæ¬¡çš„thenæ˜¯ä¸ºäº†è·å–ajaxçš„ç»“æœ
    promise = promise.then(ajax).then(res => {
      data.push(res);
      return data; // æŠŠæ¯æ¬¡çš„ç»“æœè¿”å›
    })
  })
  // æœ€åå¾—åˆ°çš„promiseå®ƒçš„å€¼å°±æ˜¯data
  return promise;
}å¤åˆ¶ä»£ç 
```

#### 8.4 æ ¹æ®promiseA+å®ç°ä¸€ä¸ªè‡ªå·±çš„promise

è¯´çœŸçš„ï¼Œè¿™é“é¢˜è¢«é—®åˆ°çš„æ¦‚ç‡è¿˜æ˜¯æŒºé«˜çš„ï¼Œè€Œä¸”è¦è¯´çš„å†…å®¹ä¹Ÿå¾ˆå¤š...

éœ–å‘†å‘†è¿™é‡Œå·ä¸ªæ‡’ï¼Œä¸æƒ³ç»†è¯´äº†...

ä¸è¿‡å“ˆï¼Œæˆ‘ä¿è¯ï¼Œä¸‹ä¸‹é¢˜æˆ‘ä¸€å®šä»”ç»†è¯´ ğŸ˜¼.



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708bb0d2846ea40~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



æ¥å§ï¼Œç»™ä½ ä»¬ä¸€äº›å¥½çš„å®å…¸ï¼š

- [ã€ŠPromiseä¸ä¼šï¼Ÿï¼Ÿçœ‹è¿™é‡Œï¼ï¼ï¼å²ä¸Šæœ€é€šä¿—æ˜“æ‡‚çš„Promiseï¼ï¼ï¼ã€‹](https://juejin.cn/post/6844903607968481287#heading-7)
- [ã€Šå†™ä¸€ä¸ªç¬¦åˆ Promises/A+ è§„èŒƒå¹¶å¯é…åˆ ES7 async/await ä½¿ç”¨çš„ Promiseã€‹](https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F23312442)

#### 8.5 å°è£…ä¸€ä¸ªå¼‚æ­¥åŠ è½½å›¾ç‰‡çš„æ–¹æ³•

è¿™ä¸ªç›¸å¯¹ç®€å•ä¸€äº›ï¼Œåªéœ€è¦åœ¨å›¾ç‰‡çš„`onload`å‡½æ•°ä¸­ï¼Œä½¿ç”¨`resolve`è¿”å›ä¸€ä¸‹å°±å¯ä»¥äº†ã€‚

æ¥çœ‹çœ‹å…·ä½“ä»£ç ï¼š

```reasonml
function loadImg(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = function() {
      console.log("ä¸€å¼ å›¾ç‰‡åŠ è½½å®Œæˆ");
      resolve(img);
    };
    img.onerror = function() {
    	reject(new Error('Could not load image at' + url));
    };
    img.src = url;
  });å¤åˆ¶ä»£ç 
```

#### 8.6 é™åˆ¶å¼‚æ­¥æ“ä½œçš„å¹¶å‘ä¸ªæ•°å¹¶å°½å¯èƒ½å¿«çš„å®Œæˆå…¨éƒ¨

æœ‰8ä¸ªå›¾ç‰‡èµ„æºçš„urlï¼Œå·²ç»å­˜å‚¨åœ¨æ•°ç»„`urls`ä¸­ã€‚

```
urls`ç±»ä¼¼äº`['https://image1.png', 'https://image2.png', ....]
```

è€Œä¸”å·²ç»æœ‰ä¸€ä¸ªå‡½æ•°`function loadImg`ï¼Œè¾“å…¥ä¸€ä¸ª`url`é“¾æ¥ï¼Œè¿”å›ä¸€ä¸ª`Promise`ï¼Œè¯¥`Promise`åœ¨å›¾ç‰‡ä¸‹è½½å®Œæˆçš„æ—¶å€™`resolve`ï¼Œä¸‹è½½å¤±è´¥åˆ™`reject`ã€‚

ä½†æœ‰ä¸€ä¸ªè¦æ±‚ï¼Œä»»ä½•æ—¶åˆ»åŒæ—¶ä¸‹è½½çš„é“¾æ¥**æ•°é‡ä¸å¯ä»¥è¶…è¿‡3ä¸ª**ã€‚

è¯·å†™ä¸€æ®µä»£ç å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œè¦æ±‚**å°½å¯èƒ½å¿«é€Ÿ**åœ°å°†æ‰€æœ‰å›¾ç‰‡ä¸‹è½½å®Œæˆã€‚

```javascript
var urls = [
  "https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/AboutMe-painting1.png",
  "https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/AboutMe-painting2.png",
  "https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/AboutMe-painting3.png",
  "https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/AboutMe-painting4.png",
  "https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/AboutMe-painting5.png",
  "https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/bpmn6.png",
  "https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/bpmn7.png",
  "https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/bpmn8.png",
];
function loadImg(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = function() {
      console.log("ä¸€å¼ å›¾ç‰‡åŠ è½½å®Œæˆ");
      resolve(img);
    };
    img.onerror = function() {
    	reject(new Error('Could not load image at' + url));
    };
    img.src = url;
  });å¤åˆ¶ä»£ç 
```

çœ‹åˆ°è¿™é“é¢˜æ—¶ï¼Œæˆ‘æœ€å¼€å§‹çš„æƒ³æ³•æ˜¯ï¼š

- æ‹¿åˆ°`urls`ï¼Œç„¶åå°†è¿™ä¸ªæ•°ç»„æ¯3ä¸ª`url`ä¸€ç»„åˆ›å»ºæˆä¸€ä¸ªäºŒç»´æ•°ç»„
- ç„¶åç”¨`Promise.all()`æ¯æ¬¡åŠ è½½ä¸€ç»„`url`ï¼ˆä¹Ÿå°±æ˜¯å¹¶å‘3ä¸ªï¼‰ï¼Œè¿™ä¸€ç»„åŠ è½½å®Œå†åŠ è½½ä¸‹ä¸€ç»„ã€‚

è¿™ä¸ªæƒ³æ³•ä»æŠ€æœ¯ä¸Šè¯´å¹¶ä¸éš¾å®ç°ï¼Œæœ‰ç‚¹ç±»ä¼¼äºç¬¬ä¸‰é¢˜ã€‚ä¸è¿‡ç¼ºç‚¹ä¹Ÿæ˜æ˜¾ï¼Œé‚£å°±æ˜¯æ¯æ¬¡éƒ½è¦ç­‰åˆ°ä¸Šä¸€ç»„å…¨éƒ¨åŠ è½½å®Œä¹‹åï¼Œæ‰åŠ è½½ä¸‹ä¸€ç»„ï¼Œé‚£å¦‚æœä¸Šä¸€ç»„æœ‰`2`ä¸ªå·²ç»åŠ è½½å®Œäº†ï¼Œè¿˜æœ‰`1`ä¸ªç‰¹åˆ«æ…¢ï¼Œè¿˜åœ¨åŠ è½½ï¼Œè¦ç­‰è¿™ä¸ªæ…¢çš„ä¹ŸåŠ è½½å®Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€ç»„ã€‚è¿™æ˜æ˜¾ä¼šç…§å¸¸å¡é¡¿ï¼Œå½±å“åŠ è½½æ•ˆç‡ã€‚

ä½†æ˜¯å¼€å§‹æ²¡æœ‰è€ƒè™‘è¿™ä¹ˆå¤šï¼Œå› æ­¤æœ‰äº†ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚

**å¦‚æœä½ æœ‰å…´è¶£å¯ä»¥çœ‹çœ‹æƒ³æ³•ä¸€çš„ä»£ç ï¼Œè™½ç„¶å¯¹ä½ æ²¡ä»€ä¹ˆå¸®åŠ©ï¼Œæƒ³ç›´æ¥çŸ¥é“æ¯”è¾ƒå¥½çš„åšæ³•çš„å°ä¼™ä¼´è¯·è·³åˆ°æƒ³æ³•äºŒ**



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708bb10eebdcc6e~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



**æƒ³æ³•ä¸€**ğŸ’¡ï¼š

```arcade
function limitLoad (urls, handler, limit) {
  const data = []; // å­˜å‚¨æ‰€æœ‰çš„åŠ è½½ç»“æœ
  let p = Promise.resolve();
  const handleUrls = (urls) => { // è¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†ç”Ÿæˆ3ä¸ªurlä¸ºä¸€ç»„çš„äºŒç»´æ•°ç»„
    const doubleDim = [];
    const len = Math.ceil(urls.length / limit); // Math.ceil(8 / 3) = 3
    console.log(len) // 3, è¡¨ç¤ºäºŒç»´æ•°ç»„çš„é•¿åº¦ä¸º3
    for (let i = 0; i < len; i++) {
      doubleDim.push(urls.slice(i * limit, (i + 1) * limit))
    }
    return doubleDim;
  }
  const ajaxImage = (urlCollect) => { // å°†ä¸€ç»„å­—ç¬¦ä¸²url è½¬æ¢ä¸ºä¸€ä¸ªåŠ è½½å›¾ç‰‡çš„æ•°ç»„
    console.log(urlCollect)
    return urlCollect.map(url => handler(url))
  }
  const doubleDim = handleUrls(urls); // å¾—åˆ°3ä¸ªurlä¸ºä¸€ç»„çš„äºŒç»´æ•°ç»„
  doubleDim.forEach(urlCollect => {
    p = p.then(() => Promise.all(ajaxImage(urlCollect))).then(res => {
      data.push(...res); // å°†æ¯æ¬¡çš„ç»“æœå±•å¼€ï¼Œå¹¶å­˜å‚¨åˆ°dataä¸­ (resä¸ºï¼š[img, img, img])
      return data;
    })
  })
  return p;
}
limitLoad(urls, loadImg, 3).then(res => {
  console.log(res); // æœ€ç»ˆå¾—åˆ°çš„æ˜¯é•¿åº¦ä¸º8çš„imgæ•°ç»„: [img, img, img, ...]
  res.forEach(img => {
    document.body.appendChild(img);
  })
});å¤åˆ¶ä»£ç 
```

**æƒ³æ³•äºŒ**ğŸ’¡ï¼š

å‚è€ƒ[LHHå¤§ç¿°ä»”ä»”-Promiseé¢è¯•é¢˜](https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2F4bb1521343ba)

æ—¢ç„¶é¢˜ç›®çš„è¦æ±‚æ˜¯ä¿è¯æ¯æ¬¡å¹¶å‘è¯·æ±‚çš„æ•°é‡ä¸º3ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…ˆè¯·æ±‚`urls`ä¸­çš„å‰é¢ä¸‰ä¸ª(ä¸‹æ ‡ä¸º`0,1,2`)ï¼Œå¹¶ä¸”è¯·æ±‚çš„æ—¶å€™ä½¿ç”¨`Promise.race()`æ¥åŒæ—¶è¯·æ±‚ï¼Œä¸‰ä¸ªä¸­æœ‰ä¸€ä¸ªå…ˆå®Œæˆäº†(ä¾‹å¦‚ä¸‹æ ‡ä¸º`1`çš„å›¾ç‰‡)ï¼Œæˆ‘ä»¬å°±æŠŠè¿™ä¸ªå½“å‰æ•°ç»„ä¸­å·²ç»å®Œæˆçš„é‚£ä¸€é¡¹(ç¬¬`1`é¡¹)æ¢æˆè¿˜æ²¡æœ‰è¯·æ±‚çš„é‚£ä¸€é¡¹(`urls`ä¸­ä¸‹æ ‡ä¸º`3`)ã€‚

ç›´åˆ°`urls`å·²ç»éå†å®Œäº†ï¼Œç„¶åå°†æœ€åä¸‰ä¸ªæ²¡æœ‰å®Œæˆçš„è¯·æ±‚(ä¹Ÿå°±æ˜¯çŠ¶æ€æ²¡æœ‰æ”¹å˜çš„`Promise`)ç”¨`Promise.all()`æ¥åŠ è½½å®ƒä»¬ã€‚

ä¸å¤šè¯´ï¼Œæµç¨‹å›¾éƒ½ç»™ä½ ç”»å¥½äº†ï¼Œä½ å¯ä»¥ç»“åˆæµç¨‹å›¾å†æ¥çœ‹ä»£ç ã€‚



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708b0d2d7baa165~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



ä¸ºäº†æ–¹ä¾¿ä½ æŸ¥çœ‹ï¼Œæˆ‘æˆªäº†ä¸ªå›¾ï¼Œä¸è¿‡ä»£ç åœ¨åé¢ä¹Ÿæœ‰

(è¯´çœŸçš„ï¼Œè¦æˆ‘çœ‹è¿™ä¸€å¤§é•¿ä¸²ä»£ç æˆ‘ä¹Ÿä¸æ„¿æ„...)



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708b0e23417a9ec~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



ä»£ç ï¼š

```arcade
function limitLoad(urls, handler, limit) {
  let sequence = [].concat(urls); // å¤åˆ¶urls
  // è¿™ä¸€æ­¥æ˜¯ä¸ºäº†åˆå§‹åŒ– promises è¿™ä¸ª"å®¹å™¨"
  let promises = sequence.splice(0, limit).map((url, index) => {
    return handler(url).then(() => {
      // è¿”å›ä¸‹æ ‡æ˜¯ä¸ºäº†çŸ¥é“æ•°ç»„ä¸­æ˜¯å“ªä¸€é¡¹æœ€å…ˆå®Œæˆ
      return index;
    });
  });
  // æ³¨æ„è¿™é‡Œè¦å°†æ•´ä¸ªå˜é‡è¿‡ç¨‹è¿”å›ï¼Œè¿™æ ·å¾—åˆ°çš„å°±æ˜¯ä¸€ä¸ªPromiseï¼Œå¯ä»¥åœ¨å¤–é¢é“¾å¼è°ƒç”¨
  return sequence
    .reduce((pCollect, url) => {
      return pCollect
        .then(() => {
          return Promise.race(promises); // è¿”å›å·²ç»å®Œæˆçš„ä¸‹æ ‡
        })
        .then(fastestIndex => { // è·å–åˆ°å·²ç»å®Œæˆçš„ä¸‹æ ‡
        	// å°†"å®¹å™¨"å†…å·²ç»å®Œæˆçš„é‚£ä¸€é¡¹æ›¿æ¢
          promises[fastestIndex] = handler(url).then(
            () => {
              return fastestIndex; // è¦ç»§ç»­å°†è¿™ä¸ªä¸‹æ ‡è¿”å›ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡å˜é‡
            }
          );
        })
        .catch(err => {
          console.error(err);
        });
    }, Promise.resolve()) // åˆå§‹åŒ–ä¼ å…¥
    .then(() => { // æœ€åä¸‰ä¸ªç”¨.allæ¥è°ƒç”¨
      return Promise.all(promises);
    });
}
limitLoad(urls, loadImg, 3)
  .then(res => {
    console.log("å›¾ç‰‡å…¨éƒ¨åŠ è½½å®Œæ¯•");
    console.log(res);
  })
  .catch(err => {
    console.error(err);
  });å¤åˆ¶ä»£ç 
```

## åè¯­

çŸ¥è¯†æ— ä»·ï¼Œæ”¯æŒåŸåˆ›ã€‚

å‚è€ƒæ–‡ç« ï¼š

- [ã€ŠES6ä¹‹Promiseå¸¸è§é¢è¯•é¢˜ã€‹](https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_37719279%2Farticle%2Fdetails%2F80950713)
- [ã€Šå¦‚ä½•è®©å¼‚æ­¥æ“ä½œé¡ºåºæ‰§è¡Œã€‹](https://link.juejin.cn?target=https%3A%2F%2Fsegmentfault.com%2Fq%2F1010000010748967)
- [ã€Šå¤§ç™½è¯è®²è§£Promiseï¼ˆä¸€ï¼‰](https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Flvdabao%2Fp%2Fes6-promise-1.html)
- [ã€ŠLHHå¤§ç¿°ä»”ä»”-Promiseé¢è¯•é¢˜ã€‹](https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2F4bb1521343ba)
- [ã€Šä»Šæ—¥å¤´æ¡async/awaité¢è¯•é¢˜æ‰§è¡Œé¡ºåºã€‹](https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fguolinengineer%2Farticle%2Fdetails%2F85067924)
- [ ã€Š(2.4wå­—,å»ºè®®æ”¶è—)ğŸ˜‡åŸç”ŸJSçµé­‚ä¹‹é—®(ä¸‹), å†²åˆºğŸš€è¿›é˜¶æœ€åä¸€å…¬é‡Œ(é™„ä¸ªäººæˆé•¿ç»éªŒåˆ†äº«)ã€‹](https://juejin.cn/post/6844904004007247880)

ä½ ç›¼ä¸–ç•Œï¼Œ æˆ‘ç›¼æœ›ä½ æ— bugã€‚è¿™ç¯‡æ–‡ç« å°±ä»‹ç»åˆ°è¿™é‡Œï¼Œä¸€å£æ°”åˆ·å®Œäº†`45`é“é¢˜ï¼ŒçœŸçš„å¾ˆçˆ½æœ‰æ²¡æœ‰...



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708bb814bdc2570~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



åæ­£æˆ‘åšåˆ°åé¢æ˜¯è¶Šæ¥è¶Šæœ‰åŠ²ï¼Œä¹Ÿè¶Šæ¥è¶Šè‡ªä¿¡äº†(æœ‰ç‚¹é£˜ï¼Œæ”¶ä¸€ä¸‹...)

å–œæ¬¢**éœ–å‘†å‘†**çš„å°ä¼™è¿˜å¸Œæœ›å¯ä»¥å…³æ³¨éœ–å‘†å‘†çš„å…¬ä¼—å· `LinDaiDai` æˆ–è€…æ‰«ä¸€æ‰«ä¸‹é¢çš„äºŒç»´ç ğŸ‘‡ğŸ‘‡ğŸ‘‡.



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/28/1708bca9d251131d~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



æˆ‘ä¼šä¸å®šæ—¶çš„æ›´æ–°ä¸€äº›å‰ç«¯æ–¹é¢çš„çŸ¥è¯†å†…å®¹ä»¥åŠè‡ªå·±çš„åŸåˆ›æ–‡ç« ğŸ‰

ä½ çš„é¼“åŠ±å°±æ˜¯æˆ‘æŒç»­åˆ›ä½œçš„ä¸»è¦åŠ¨åŠ› ğŸ˜Š.



ä½œè€…ï¼šLinDaiDai_éœ–å‘†å‘†
é“¾æ¥ï¼šhttps://juejin.cn/post/6844904077537574919
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

# å‰è¨€

> â€ƒâ€ƒä¸çŸ¥ä¸è§‰å·²ç»ä¸€ä¸ªåŠæœˆæ²¡æœ‰åšæŒå†™åšå®¢äº†ï¼Œäº‹å‘çªç„¶è¿™æ®µæ—¶é—´ç»å†äº†è£å‘˜ï¼Œé¢äº†æŸå¤§å‚ï¼Œä»Šå¤©ä¹Ÿæ˜¯äºŒåä¸‰å‘¨å² 

## 1. æ—©æœŸå¼‚æ­¥ä»£ç å›°å¢ƒ

- ä¼—æ‰€å‘¨çŸ¥ï¼Œjsæ˜¯å•çº¿ç¨‹çš„ï¼Œè€—æ—¶æ“ä½œéƒ½æ˜¯äº¤ç»™æµè§ˆå™¨æ¥å¤„ç†ï¼Œç­‰æ—¶é—´åˆ°äº†ä»é˜Ÿåˆ—ä¸­å–å‡ºæ‰§è¡Œï¼Œè®¾è®¡åˆ°äº‹ä»¶å¾ªç¯çš„æ¦‚å¿µï¼Œç¬”è€…ä¹Ÿåˆ†äº«è¿‡ï¼Œå¯ä»¥çœ‹ä»¥ä¸‹ï¼Œç†è§£äº†å¯ä»¥æ›´å¥½çš„ç†è§£`promise`ã€‚
- æˆ‘ä»¥ä¸€ä¸ªéœ€æ±‚ä¸ºåˆ‡å…¥ç‚¹ï¼Œæˆ‘æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚(å¼‚æ­¥æ“ä½œ) 
  - å¦‚æœç½‘ç»œè¯·æ±‚æˆåŠŸäº†ï¼Œä½ å‘ŠçŸ¥æˆ‘æˆåŠŸäº†
  - å¦‚æœç½‘ç»œè¯·æ±‚å¤±è´¥äº†ï¼Œä½ å‘ŠçŸ¥æˆ‘å¤±è´¥äº†

### 1.1 å¤§èªæ˜åšæ³•

```javascript
function requestData(url) {
  setTimeout(() => {
    if (url === 'iceweb.io') {
      return 'è¯·æ±‚æˆåŠŸ'
    }
    return 'è¯·æ±‚å¤±è´¥'
  }, 3000)
}

const result = requestData('iceweb.io')

console.log(result) //undefined
å¤åˆ¶ä»£ç 
```

- é¦–å…ˆä½ è¦ç†è§£`js`ä»£ç çš„æ‰§è¡Œé¡ºåºï¼Œè€Œä¸æ˜¯æ˜¯æƒ³å½“ç„¶çš„ï¼Œä»£ç å…¶å®å¹¶ä¸æ˜¯æŒ‰ç…§ä½ ä¹¦å†™çš„é¡ºåºæ‰§è¡Œçš„ã€‚

- é‚£ä¹ˆä¸ºä»€ä¹ˆæ˜¯ 

  ```
  undefinedå‘¢
  ```

  ï¼Ÿ 

  - é¦–å…ˆå½“æˆ‘æ‰§è¡Œ`requestData`å‡½æ•°ï¼Œå¼€å§‹æ‰§è¡Œå‡½æ•°ã€‚é‡åˆ°äº†å¼‚æ­¥æ“ä½œä¸ä¼šé˜»å¡åé¢ä»£ç æ‰§è¡Œçš„ï¼Œå› ä¸ºjsæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥ä½ å†™çš„`return`æˆåŠŸæˆ–è€…å¤±è´¥å¹¶æ²¡æœ‰è¿”å›ç»™`requestData`ï¼Œé‚£æˆ‘è¿™ä¸ªå‡½æ•°ä¸­ï¼ŒæŠ›å¼€å¼‚æ­¥æ“ä½œï¼Œé‡Œé¢å¹¶æ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥å€¼ä¸º`undefined`ã€‚

### 2.2 æ—©æœŸæ­£ç¡®åšæ³•

```javascript
function requestData(url, successCB, failureCB) {
  setTimeout(() => {
    if (url === 'iceweb.io') {
      successCB('æˆ‘æˆåŠŸäº†,æŠŠè·å–åˆ°çš„æ•°æ®ä¼ å‡ºå»', [{name:'ice', age:22}])
    } else {
      failureCB('urlé”™è¯¯ï¼Œè¯·æ±‚å¤±è´¥')
    }
  }, 3000)
}

//3så å›è°ƒsuccessCB 
//æˆ‘æˆåŠŸäº†,æŠŠè·å–åˆ°çš„æ•°æ®ä¼ å‡ºå» [ { name: 'ice', age: 22 } ]
requestData('iceweb.io', (res, data) => console.log(res, data), rej => console.log(rej))

//3såå›è°ƒfailureCB
//urlé”™è¯¯ï¼Œè¯·æ±‚å¤±è´¥
requestData('icexxx.io', res => console.log(res) ,rej => console.log(rej))
å¤åˆ¶ä»£ç 
```

- æ—©æœŸè§£å†³æ–¹æ¡ˆéƒ½æ˜¯ä¼ å…¥ä¸¤ä¸ªå›è°ƒï¼Œä¸€ä¸ªå¤±è´¥çš„ï¼Œä¸€ä¸ªæˆåŠŸçš„ã€‚é‚£å¾ˆå¤šå¼€å‘è€…ä¼šé—®è¿™ä¸æ˜¯æŒºå¥½çš„å—ï¼ŸæŒºç®€å•çš„ï¼Œjsä¸­å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œå¯ä»¥ä¼ æ¥ä¼ å»ï¼Œä½†æ˜¯è¿™æ ·å¤ªçµæ´»äº†ï¼Œæ²¡æœ‰è§„èŒƒã€‚
- å¦‚æœä½¿ç”¨çš„æ˜¯æ¡†æ¶ï¼Œè¿˜è¦é˜…è¯»ä¸€ä¸‹æ¡†æ¶æºç ï¼Œæ­£ç¡®å¤±è´¥çš„ä¼ å®å‚çš„é¡ºåºï¼Œå¦‚æœä¼ å‚é¡ºåºé”™è¯¯è¿™æ ·æ˜¯éå¸¸å±é™©çš„ã€‚

## 2. Promise

- `Promise`(æ‰¿è¯º)ï¼Œç»™äºˆè°ƒç”¨è€…ä¸€ä¸ªæ‰¿è¯ºï¼Œè¿‡ä¸€ä¼šè¿”å›æ•°æ®ç»™ä½ ï¼Œå°±å¯ä»¥åˆ›å»ºä¸€ä¸ªpromiseå¯¹è±¡

- å½“æˆ‘ä»¬`new`ä¸€ä¸ª`promise`ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦ä¼ é€’ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸ºç«‹å³æ‰§è¡Œçš„ï¼Œç§°ä¹‹ä¸ºï¼ˆexecutorï¼‰

- è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°å›è°ƒå‡½æ•°ï¼Œ

  ```
  reslove
  ```

  ,

  ```
  reject
  ```

  (å‡½æ•°å¯ä»¥è¿›è¡Œä¼ å‚) 

  - å½“æ‰§è¡Œäº†`reslove`å‡½æ•°ï¼Œä¼šå›è°ƒpromiseå¯¹è±¡çš„.thenå‡½æ•°
  - å½“æ‰§è¡Œäº†`reject`å‡½æ•°ï¼Œä¼šå›è°ƒpromiseå¯¹è±¡çš„.catcheå‡½æ•°

### 2.1 Executorç«‹å³æ‰§è¡Œ

```javascript
new Promise((resolve, reject) => {
  console.log(`executor ç«‹å³æ‰§è¡Œ`)
})
å¤åˆ¶ä»£ç 
```

- ä¼ å…¥çš„`executor`æ˜¯ç«‹å³æ‰§è¡Œçš„

### 2.2 requestData é‡æ„

```javascript
function requestData(url) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (url === 'iceweb.io') {
        //åªèƒ½ä¼ é€’ä¸€ä¸ªå‚æ•°
        resolve('æˆ‘æˆåŠŸäº†,æŠŠè·å–åˆ°çš„æ•°æ®ä¼ å‡ºå»')
      } else {
        reject('urlé”™è¯¯ï¼Œè¯·æ±‚å¤±è´¥')
      }
    }, 3000)    
  })
}

//1. è¯·æ±‚æˆåŠŸ
requestData('iceweb.io').then(res => {
  //æˆ‘æˆåŠŸäº†,æŠŠè·å–åˆ°çš„æ•°æ®ä¼ å‡ºå»
  console.log(res)
})

//2. è¯·æ±‚å¤±è´¥

//2.2 ç¬¬ä¸€ç§å†™æ³•
//urlé”™è¯¯ï¼Œè¯·æ±‚å¤±è´¥
requestData('iceweb.org').then(res => {},rej => console.log(rej))

//2.2 ç¬¬äºŒç§å†™æ³•
//urlé”™è¯¯ï¼Œè¯·æ±‚å¤±è´¥
requestData('iceweb.org').catch(e => console.log(e))
å¤åˆ¶ä»£ç 
```

- åœ¨å‡½æ•°ä¸­ï¼Œnewè¿™ä¸ªç±»çš„æ—¶å€™ï¼Œä¼ å…¥çš„å›è°ƒå‡½æ•°ç§°ä¹‹ä¸º`executor`ï¼ˆä¼šè¢«Promiseç±»ä¸­è‡ªåŠ¨æ‰§è¡Œï¼‰

- åœ¨æ­£ç¡®çš„æ—¶å€™è°ƒç”¨`resolve`å‡½æ•°ï¼Œå¤±è´¥çš„æ—¶å€™è°ƒç”¨`reject`å‡½æ•°ï¼ŒæŠŠéœ€è¦çš„å‚æ•°ä¼ é€’å‡ºå»ã€‚

- å¼‚å¸¸å¤„ç† 

  - å…¶ä¸­åœ¨

    ```
    .then
    ```

    æ–¹æ³•ä¸­å¯ä»¥ä¼ å…¥ä¸¤ä¸ªå›è°ƒï¼Œæ‚¨ä¹Ÿå¯ä»¥æŸ¥çœ‹

    Promise/A+

    è§„èŒƒ 

    - ç¬¬ä¸€ä¸ªåˆ™æ˜¯`fulfilled`çš„å›è°ƒ
    - ç¬¬äºŒä¸ªåˆ™æ˜¯`rejected`çš„å›è°ƒ

- é‚£è¿™æ ·æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ çœ‹èµ·æ¥æ¯”æ—©æœŸå¤„ç†çš„æ–¹æ¡ˆè¿˜è¦ç¹çå‘¢? 

  1. ç»Ÿä¸€è§„èŒƒï¼Œå¯ä»¥å¢å¼ºé˜…è¯»æ€§å’Œæ‰©å±•æ€§
  2. å°å¹…åº¦å‡å°‘å›è°ƒåœ°ç‹±

### 2.3 promiseçš„çŠ¶æ€

- é¦–å…ˆå…ˆç»™å¤§å®¶ä¸¾ä¸ªæ —å­ï¼ŒæŠŠä»£ç æŠ½è±¡ä¸ºç°å®çš„æ —å­ 

  - ä½ ç­”åº”ä½ å¥³æœ‹å‹ï¼Œä¸‹å‘¨æœ«å¸¦å¥¹å»åƒå¥½åƒçš„ (è¿˜æœªåˆ°ä¸‹å‘¨æœ«ï¼Œæ­¤æ—¶çŠ¶æ€ä¸º**å¾…å®šçŠ¶æ€**)
  - æ—¶é—´é£å¿«ï¼Œä»Šå¤©å°±æ˜¯å‘¨æœ«äº†ï¼Œä½ å’Œä½ å¥³å‹ä¸€èµ·åƒäº†çƒ¤è‚‰ã€ç”œç‚¹ã€å¥¶èŒ¶...ï¼ˆ**å·²å…‘ç°çŠ¶æ€**ï¼‰
  - æ—¶é—´é£å¿«ï¼Œä»Šå¤©å°±æ˜¯å‘¨æœ«äº†ï¼Œæ­£æ‰“ç®—å‡ºé—¨ã€‚ä¸å·§äº§å“ç»ç†ï¼Œå› ä¸ºçº¿ä¸Šå‡ºç°çš„ç´§æ€¥é—®é¢˜ï¼Œéœ€è¦å›å…¬å¸è§£å†³ä¸€ä¸‹ï¼Œä½ (ä¸ºäº†ç”Ÿæ´»)åªèƒ½å§”å©‰çš„æ‹’ç»ä¸€ä¸‹å¥³å‹ï¼Œå¹¶ä¸”è¯´æ˜ä¸€ä¸‹ç¼˜ç”±(**å·²æ‹’ç»çŠ¶æ€**)

- ä½¿ç”¨

  ```
  promise
  ```

  çš„æ—¶å€™ï¼Œç»™å®ƒä¸€ä¸ªæ‰¿è¯ºï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»–åˆ’åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ 

  - pending(å¾…å®š)ï¼Œæ‰§è¡Œäº†executorï¼ŒçŠ¶æ€è¿˜åœ¨ç­‰å¾…ä¸­ï¼Œæ²¡æœ‰è¢«å…‘ç°ï¼Œä¹Ÿæ²¡æœ‰è¢«æ‹’ç»
  - fulfilled(å·²å…‘ç°)ï¼Œæ‰§è¡Œäº†`resolve`å‡½æ•°åˆ™ä»£è¡¨äº†å·²å…‘ç°çŠ¶æ€
  - rejected(å·²æ‹’ç»)ï¼Œæ‰§è¡Œäº†`reject`å‡½æ•°åˆ™ä»£è¡¨äº†å·²æ‹’ç»çŠ¶æ€

- é¦–å…ˆï¼ŒçŠ¶æ€åªè¦ä»å¾…å®šçŠ¶æ€ï¼Œå˜ä¸ºå…¶ä»–çŠ¶æ€ï¼Œåˆ™çŠ¶æ€ä¸èƒ½å†æ”¹å˜

æ€è€ƒä»¥ä¸‹ä»£ç :

```javascript
const promise = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('å¤±è´¥')
    resolve('æˆåŠŸ')
  }, 3000);
})

promise.then(res => console.log(res)).catch(err => console.log(err))

//å¤±è´¥ 
å¤åˆ¶ä»£ç 
```

- å½“æˆ‘è°ƒç”¨`reject`ä¹‹åï¼Œåœ¨è°ƒç”¨`resolve`æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºçŠ¶æ€å·²ç»å‘ç”Ÿæ”¹å˜ï¼Œå¹¶ä¸”æ˜¯ä¸å¯é€†çš„ã€‚

### 2.4 resolveä¸åŒå€¼çš„åŒºåˆ«

- å¦‚æœ`resolve`ä¼ å…¥ä¸€ä¸ªæ™®é€šçš„å€¼æˆ–è€…å¯¹è±¡ï¼Œ**åªèƒ½ä¼ é€’æ¥å—ä¸€ä¸ªå‚æ•°**ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼ä¼šä½œä¸º`then`å›è°ƒçš„å‚æ•°

```javascript
const promise = new Promise((resolve, reject) => {
  resolve({name: 'ice', age: 22})
})

promise.then(res => console.log(res))

// {name: 'ice', age: 22}
å¤åˆ¶ä»£ç 
```

- å¦‚æœ`resolve`ä¸­ä¼ å…¥çš„æ˜¯å¦å¤–ä¸€ä¸ª`Promise`ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–°`Promise`ä¼šå†³å®šåŸ`Promise`çš„çŠ¶æ€

```javascript
const promise = new Promise((resolve, reject) => {
  resolve(new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve('ice')
    }, 3000);
  }))
})

promise.then(res => console.log(res))

//3så ice
å¤åˆ¶ä»£ç 
```

- å¦‚æœ`resolve`ä¸­ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ªå¯¹è±¡æœ‰å®ç°`then`æ–¹æ³•ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œè¯¥`then`æ–¹æ³•ï¼Œ`then`æ–¹æ³•ä¼šä¼ å…¥`resolve`ï¼Œ`reject`å‡½æ•°ã€‚æ­¤æ—¶çš„`promise`çŠ¶æ€å–å†³äºä½ è°ƒç”¨äº†`resolve`ï¼Œè¿˜æ˜¯`reject`å‡½æ•°ã€‚è¿™ç§æ¨¡å¼ä¹Ÿç§°ä¹‹ä¸º: **thenable**

```javascript
const promise = new Promise((resolve, reject) => {
  resolve({
    then(res, rej) {
      res('hi ice')
    }
  })
})

promise.then(res => console.log(res))

// hi ice
å¤åˆ¶ä»£ç 
```

### 2.5 Promiseçš„å®ä¾‹æ–¹æ³•

- å®ä¾‹æ–¹æ³•ï¼Œå­˜æ”¾åœ¨`Promise.prototype`ä¸Šçš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯Promiseçš„æ˜¾ç¤ºåŸå‹ä¸Šï¼Œå½“æˆ‘new Promiseçš„æ—¶å€™ï¼Œä¼šæŠŠè¿”å›çš„æ”¹å¯¹è±¡çš„ promise[[prototype]]ï¼ˆéšå¼åŸå‹ï¼‰ === Promise.prototype (æ˜¾ç¤ºåŸå‹)
- å³newè¿”å›çš„å¯¹è±¡çš„éšå¼åŸå‹æŒ‡å‘äº†Promiseçš„æ˜¾ç¤ºåŸå‹

#### 2.5.1 thenæ–¹æ³•

##### 2.5.1.1 thençš„å‚æ•°

- `then`æ–¹æ³•å¯ä»¥æ¥å—å‚æ•°ï¼Œä¸€ä¸ªå‚æ•°ä¸ºæˆåŠŸçš„å›è°ƒï¼Œå¦ä¸€ä¸ªå‚æ•°ä¸ºå¤±è´¥çš„å›è°ƒï¼Œå‰é¢é‡æ„`requestData`ä¸­æœ‰æ¼”ç»ƒè¿‡ã€‚

```javascript
const promise = new Promise((resolve, reject) => {
  resolve('request success')
  // reject('request error')
})

promise.then(res => console.log(res), rej => console.log(rej))

//request success
å¤åˆ¶ä»£ç 
```

- å¦‚æœåªæ•è·é”™è¯¯ï¼Œè¿˜å¯ä»¥è¿™æ ·å†™ 
  - å› ä¸ºç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•è·å¼‚å¸¸çš„ï¼Œç¬¬ä¸€ä¸ªå¯ä»¥å†™ä¸ª`null`æˆ–`""`å ä½

```javascript
const promise = new Promise((resolve, reject) => {
  // resolve('request success')
  reject('request error')
})

promise.then(null, rej => console.log(rej))

//request error
å¤åˆ¶ä»£ç 
```

##### 2.5.1.2 thençš„å¤šæ¬¡è°ƒç”¨

```javascript
const promise = new Promise((resolve, reject) => {
  resolve('hi ice')
})

promise.then(res => console.log(res))
promise.then(res => console.log(res))
promise.then(res => console.log(res))
å¤åˆ¶ä»£ç 
```

- è°ƒç”¨å¤šæ¬¡åˆ™ä¼šæ‰§è¡Œå¤šæ¬¡

##### 2.5.1.3 thençš„è¿”å›å€¼

- `then`æ–¹æ³•æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œå®ƒçš„è¿”å›å€¼æ˜¯`promise`ï¼Œä½†æ˜¯æ˜¯`promise`é‚£å®ƒçš„çŠ¶æ€å¦‚ä½•å†³å®šå‘¢ï¼Ÿæ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€æ¢ç©¶ç«Ÿã€‚

###### 2.5.1.3.1 è¿”å›ä¸€ä¸ªæ™®é€šå€¼ ***çŠ¶æ€:fulfilled***

```javascript
const promise = new Promise((resolve, reject) => {
  resolve('hi ice')
})

promise.then(res => ({name:'ice', age:22}))
       .then(res => console.log(res))
       
//{name:'ice', age:22}
å¤åˆ¶ä»£ç 
```

- è¿”å›ä¸€ä¸ªæ™®é€šå€¼ï¼Œåˆ™ç›¸å½“äºä¸»åŠ¨è°ƒç”¨`Promise.resolve`ï¼Œå¹¶ä¸”æŠŠè¿”å›å€¼ä½œä¸ºå®å‚ä¼ é€’åˆ°`then`æ–¹æ³•ä¸­ã€‚
- å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œåˆ™ç›¸å½“äºè¿”å›`undefined`

###### 2.5.1.3.2 æ˜ç¡®è¿”å›ä¸€ä¸ªpromise ***çŠ¶æ€:fulfilled***

```javascript
const promise = new Promise((resolve, reject) => {
  resolve('hi ice')
})

promise.then(res => {
  return new Promise((resolve, reject) => {
    resolve('then çš„è¿”å›å€¼')
  })
}).then(res => console.log(res))

//then çš„è¿”å›å€¼
å¤åˆ¶ä»£ç 
```

- ä¸»åŠ¨è¿”å›ä¸€ä¸ª`promise`å¯¹è±¡ï¼ŒçŠ¶æ€å’Œä½ è°ƒç”¨`resolve`ï¼Œè¿˜æ˜¯`reject`æœ‰å…³

###### 2.5.1.3.3 è¿”å›ä¸€ä¸ªthenableå¯¹è±¡ ***çŠ¶æ€ï¼šfulfilled***

```javascript
const promise = new Promise((resolve, reject) => {
  resolve('hi ice')
})

promise.then(res => {
  return {
    then(resolve, reject) {
      resolve('hi webice')
    }
  }
}).then(res => console.log(res))

//hi webice
å¤åˆ¶ä»£ç 
```

- è¿”å›äº†ä¸€ä¸ªthenableå¯¹è±¡ï¼Œå…¶çŠ¶æ€å–å†³äºä½ æ˜¯è°ƒç”¨äº†`resolve`,è¿˜æ˜¯`reject`

#### 2.5.2 catchæ–¹æ³•

##### 2.5.2.1 catchçš„å¤šæ¬¡è°ƒç”¨

```javascript
const promise = new Promise((resolve, reject) => {
  reject('ice error')
})

promise.catch(err => console.log(err))
promise.catch(err => console.log(err))
promise.catch(err => console.log(err))

//ice error
//ice error
//ice error
å¤åˆ¶ä»£ç 
```

##### 2.5.2.2 catchçš„è¿”å›å€¼

- catchæ–¹æ³•æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œå®ƒçš„è¿”å›å€¼æ˜¯promiseï¼Œä½†æ˜¯æ˜¯promiseé‚£å®ƒçš„çŠ¶æ€å¦‚ä½•å†³å®šå‘¢ï¼Ÿæ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€æ¢ç©¶ç«Ÿã€‚
- å¦‚æœè¿”å›å€¼æ˜ç¡®ä¸€ä¸ªpromiseæˆ–è€…thenableå¯¹è±¡ï¼Œå–å†³äºä½ è°ƒç”¨äº†`resolve`è¿˜æ˜¯`reject`

###### 2.5.2.2.1 è¿”å›ä¸€ä¸ªæ™®é€šå¯¹è±¡

```javascript
const promise = new Promise((resolve, reject) => {
  reject('ice error')
})

promise.catch(err => ({name:'ice', age: 22})).then(res => console.log(res))

//{name:'ice', age: 22}
å¤åˆ¶ä»£ç 
```

###### 2.5.2.2.2 æ˜ç¡®è¿”å›ä¸€ä¸ªpromise

```javascript
const promise = new Promise((resolve, reject) => {
  reject('ice error')
})

promise.catch(err => {
  return new Promise((resolve, reject) => {
    reject('ice error promise')
  })
}).catch(res => console.log(res))

//ice error promise
å¤åˆ¶ä»£ç 
```

- æ­¤æ—¶`new Promise() `è°ƒç”¨äº†`reject`å‡½æ•°ï¼Œåˆ™ä¼šè¢«`catch`æ•è·åˆ°

###### 2.5.2.2.3 è¿”å›thenableå¯¹è±¡

```javascript
const promise = new Promise((resolve, reject) => {
  reject('ice error')
})

promise.catch(err => {
  return {
    then(resolve, reject) {
      reject('ice error then')
    }
  }
}).catch(res => console.log(res))

//ice error then
å¤åˆ¶ä»£ç 
```

#### 2.5.3 finallyæ–¹æ³•

- ES9ï¼ˆ2018ï¼‰æ–°å®ä¾‹æ–¹æ³•
- finally(æœ€å)ï¼Œæ— è®ºpromiseçŠ¶æ€æ˜¯fulfilledè¿˜æ˜¯rejectedéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡`finally`æ–¹æ³•

```javascript
const promise = new Promise((resolve, reject) => {
  resolve('hi ice')
})

promise.then(res => console.log(res)).finally(() => console.log('finally execute'))

//finally execute
å¤åˆ¶ä»£ç 
```

### 2.6 Promiseä¸­çš„ç±»æ–¹æ³•/é™æ€æ–¹æ³•

#### 2.6.1 Promise.reslove

```javascript
Promise.resolve('ice')
//ç­‰ä»·äº
new Promise((resolve, reject) => resolve('ice'))
å¤åˆ¶ä»£ç 
```

- æœ‰çš„æ—¶å€™ï¼Œä½ å·²ç»é¢„çŸ¥äº†çŠ¶æ€çš„ç»“æœä¸ºfulfilledï¼Œåˆ™å¯ä»¥ç”¨è¿™ç§ç®€å†™æ–¹å¼

#### 2.6.2 Promise.reject

```javascript
Promise.reject('ice error')
//ç­‰ä»·äº
new Promise((resolve, reject) => reject('ice error'))
å¤åˆ¶ä»£ç 
```

- æœ‰çš„æ—¶å€™ï¼Œä½ å·²ç»é¢„çŸ¥äº†çŠ¶æ€çš„ç»“æœä¸ºrejectedï¼Œåˆ™å¯ä»¥ç”¨è¿™ç§ç®€å†™æ–¹å¼

#### 2.6.3 Promise.all

**fulfilled çŠ¶æ€**

```javascript
const promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('hi ice')
  }, 1000);
})

const promise2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('hi panda')
  }, 2000);
})

const promise3 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('hi grizzly')
  }, 3000);
})


Promise.all([promise1, promise2, promise3]).then(res => console.log(res))

//[ 'hi ice', 'hi panda', 'hi grizzly' ]
å¤åˆ¶ä»£ç 
```

- allæ–¹æ³•çš„å‚æ•°ä¼ å…¥ä¸ºä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªpromiseï¼Œåªæœ‰ä¸‰ä¸ªéƒ½ä¸º`resolve`çŠ¶æ€çš„æ—¶å€™æ‰ä¼šè°ƒç”¨`.then`æ–¹æ³•ã€‚
- åªè¦æœ‰ä¸€ä¸ªpromiseçš„çŠ¶æ€ä¸ºrejectedï¼Œåˆ™ä¼šå›è°ƒ`.catch`æ–¹æ³•

**rejectedçŠ¶æ€**

```javascript
const promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('hi ice')
  }, 1000);
})

const promise2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('hi panda')
  }, 2000);
})

const promise3 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('hi grizzly')
  }, 3000);
})

Promise.all([promise1, promise2, promise3]).then(res => console.log(res)).catch(err => console.log(err))

//hi panda
å¤åˆ¶ä»£ç 
```

- å½“é‡åˆ°rejectdçš„æ—¶å€™ï¼Œåç»­çš„promiseç»“æœæˆ‘ä»¬æ˜¯è·å–ä¸åˆ°ï¼Œå¹¶ä¸”ä¼šæŠŠrejectçš„å®å‚ï¼Œä¼ é€’ç»™catchçš„errå½¢å‚ä¸­

#### 2.6.4 Promise.allSettled

- ä¸Šé¢çš„`Promise.all`æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œå°±æ˜¯å½“é‡åˆ°ä¸€ä¸ªrejectedçš„çŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹äºåé¢æ˜¯`resolve`æˆ–è€…`reject`çš„ç»“æœæˆ‘ä»¬æ˜¯æ‹¿ä¸åˆ°çš„
- ES11 æ–°å¢è¯­æ³•`Promise.allSettled`ï¼Œæ— è®ºçŠ¶æ€æ˜¯fulfilled/rejectedéƒ½ä¼šæŠŠå‚æ•°è¿”å›ç»™æˆ‘ä»¬

------

**æ‰€æœ‰promiseéƒ½æœ‰ç»“æœ**

```javascript
const promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('hi ice')
  }, 1000);
})

const promise2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('hi panda')
  }, 2000);
})

const promise3 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('hi grizzly')
  }, 3000);
})

Promise.allSettled([promise1, promise2, promise3]).then(res => console.log(res))

/* [
  { status: 'rejected', reason: 'hi ice' },
  { status: 'fulfilled', value: 'hi panda' },
  { status: 'rejected', reason: 'hi grizzly' }
] */
å¤åˆ¶ä»£ç 
```

- è¯¥æ–¹æ³•ä¼šåœ¨æ‰€æœ‰çš„Promiseéƒ½æœ‰ç»“æœï¼Œæ— è®ºæ˜¯fulfilledï¼Œè¿˜æ˜¯rejectedï¼Œæ‰ä¼šæœ‰æœ€ç»ˆçš„ç»“æœ

**å…¶ä¸­ä¸€ä¸ªpromiseæ²¡æœ‰ç»“æœ**

```javascript
const promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('hi ice')
  }, 1000);
})

const promise2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('hi panda')
  }, 2000);
})

const promise3 = new Promise((resolve, reject) => {})


Promise.allSettled([promise1, promise2, promise3]).then(res => console.log(res))
// ä»€ä¹ˆéƒ½ä¸æ‰“å°
å¤åˆ¶ä»£ç 
```

- å…¶ä¸­ä¸€ä¸ªpromiseæ²¡æœ‰ç»“æœï¼Œåˆ™ä»€ä¹ˆéƒ½ç»“æœéƒ½æ‹¿ä¸åˆ°

#### 2.6.5 Promise.race

- race(ç«äº‰ç«èµ›)
- ä¼˜å…ˆè·å–ç¬¬ä¸€ä¸ªè¿”å›çš„ç»“æœï¼Œæ— è®ºç»“æœæ˜¯fulfilledè¿˜æ˜¯rejectd

```javascript
const promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('hi error')
  }, 1000);
})

const promise2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('hi panda')
  }, 2000);
})


Promise.race([promise1, promise2])
       .then(res => console.log(res))
       .catch(e => console.log(e))
       
//hi error
å¤åˆ¶ä»£ç 
```

#### 2.6.6 Promise.any

- ä¸raceç±»ä¼¼ï¼Œåªè·å–ç¬¬ä¸€ä¸ªçŠ¶æ€ä¸ºfulfilledï¼Œå¦‚æœå…¨éƒ¨ä¸ºrejectedåˆ™æŠ¥é”™`AggregateError`

```javascript
const promise1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('hi error')
  }, 1000);
})

const promise2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('hi panda')
  }, 2000);
})


Promise.any([promise1, promise2])
       .then(res => console.log(res))
       .catch(e => console.log(e))
       
//hi panda
å¤åˆ¶ä»£ç 
```

## 3. Promiseçš„å›è°ƒåœ°ç‹± (è¿›é˜¶)

- æˆ‘è¿˜æ˜¯ä»¥ä¸€ä¸ªéœ€æ±‚ä½œä¸ºåˆ‡å…¥ç‚¹ï¼ŒæŠŠçŸ¥è¯†ç‚¹åš¼ç¢äº†ï¼Œä¸€ç‚¹ä¸€ç‚¹å–‚è¿›ä½ ä»¬å˜´é‡Œã€‚ 
  - å½“æˆ‘å‘é€ç½‘ç»œè¯·æ±‚çš„æ—¶å€™ï¼Œéœ€è¦æ‹¿åˆ°è¿™æ¬¡ç½‘ç»œè¯·æ±‚çš„æ•°æ®ï¼Œå†å‘é€ç½‘ç»œè¯·æ±‚ï¼Œå°±è¿™æ ·é‡å¤ä¸‰æ¬¡ï¼Œæ‰èƒ½æ‹¿åˆ°æˆ‘æœ€ç»ˆçš„ç»“æœã€‚

### 3.1 å§é¾™è§£æ³•

```javascript
function requestData(url) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (url.includes('iceweb')) {
        resolve(url)
      } else {
        reject('è¯·æ±‚é”™è¯¯')
      }
    }, 1000);
  })
}


requestData('iceweb.io').then(res => {
  requestData(`iceweb.org ${res}`).then(res => {
    requestData(`iceweb.com ${res}`).then(res => {
      console.log(res)
    })
  })
})

//iceweb.com iceweb.org iceweb.io
å¤åˆ¶ä»£ç 
```

- è™½ç„¶èƒ½å¤Ÿå®ç°ï¼Œä½†æ˜¯å¤šå±‚ä»£ç çš„åµŒå¥—ï¼Œå¯è¯»æ€§éå¸¸å·®ï¼Œæˆ‘ä»¬æŠŠè¿™ç§å¤šå±‚æ¬¡ä»£ç åµŒå¥—ç§°ä¹‹ä¸ºå›è°ƒåœ°ç‹±

### 3.2 å‡¤é›è§£æ³•

```javascript
function requestData(url) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (url.includes('iceweb')) {
        resolve(url)
      } else {
        reject('è¯·æ±‚é”™è¯¯')
      }
    }, 1000);
  })
}

requestData('iceweb.io').then(res => {
  return requestData(`iceweb.org ${res}`)
}).then(res => {
  return requestData(`iceweb.com ${res}`)
}).then(res => {
  console.log(res)
})

//iceweb.com iceweb.org iceweb.io
å¤åˆ¶ä»£ç 
```

- åˆ©ç”¨äº†thené“¾å¼è°ƒç”¨è¿™ä¸€ç‰¹æ€§ï¼Œè¿”å›äº†ä¸€ä¸ªæ–°çš„promiseï¼Œä½†æ˜¯ä¸å¤Ÿä¼˜é›…ï¼Œæ€è€ƒä¸€ä¸‹èƒ½ä¸èƒ½å†™æˆåŒæ­¥çš„æ–¹å¼å‘¢ï¼Ÿ

### 3.3 ç”Ÿæˆå™¨+Promiseè§£æ³•

```javascript
function requestData(url) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (url.includes('iceweb')) {
        resolve(url)
      } else {
        reject('è¯·æ±‚é”™è¯¯')
      }
    }, 1000);
  })
}

function* getData(url) {
  const res1 = yield requestData(url)
  const res2 = yield requestData(res1)
  const res3 = yield requestData(res2)

  console.log(res3)
}

const generator = getData('iceweb.io')

generator.next().value.then(res1 => {
  generator.next(`iceweb.org ${res1}`).value.then(res2 => {
    generator.next(`iceweb.com ${res2}`).value.then(res3 => {
      generator.next(res3)
    })
  })
})

//iceweb.com iceweb.org iceweb.io
å¤åˆ¶ä»£ç 
```

- å¤§å®¶å¯ä»¥å‘ç°æˆ‘ä»¬çš„`getData`å·²ç»å˜ä¸ºåŒæ­¥çš„å½¢å¼ï¼Œå¯ä»¥æ‹¿åˆ°æˆ‘æœ€ç»ˆçš„ç»“æœäº†ã€‚é‚£ä¹ˆå¾ˆå¤šåŒå­¦ä¼šé—®ï¼Œgeneratorä¸€ç›´è°ƒç”¨`.next`ä¸æ˜¯ä¹Ÿäº§ç”Ÿäº†å›è°ƒåœ°ç‹±å—ï¼Ÿ
- å…¶å®ä¸ç”¨å…³å¿ƒè¿™ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å®ƒè¿™ä¸ªæ˜¯æœ‰è§„å¾‹çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°è£…æˆä¸€ä¸ªè‡ªåŠ¨åŒ–æ‰§è¡Œçš„å‡½æ•°ï¼Œæˆ‘ä»¬å°±ä¸ç”¨å…³å¿ƒå†…éƒ¨æ˜¯å¦‚ä½•è°ƒç”¨çš„äº†ã€‚

### 3.4 è‡ªåŠ¨åŒ–æ‰§è¡Œå‡½æ•°å°è£…

```javascript
function requestData(url) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (url.includes('iceweb')) {
        resolve(url)
      } else {
        reject('è¯·æ±‚é”™è¯¯')
      }
    }, 1000);
  })
}

function* getData() {
  const res1 = yield requestData('iceweb.io')
  const res2 = yield requestData(`iceweb.org ${res1}`)
  const res3 = yield requestData(`iceweb.com ${res2}`)

  console.log(res3)
}

//è‡ªåŠ¨åŒ–æ‰§è¡Œ async awaitç›¸å½“äºè‡ªåŠ¨å¸®æˆ‘ä»¬æ‰§è¡Œ.next
function asyncAutomation(genFn) {
  const generator = genFn()

  const _automation = (result) => {
    let nextData = generator.next(result)
    if(nextData.done) return

    nextData.value.then(res => {
      _automation(res)
    })
  }

  _automation()
}

asyncAutomation(getData)

//iceweb.com iceweb.org iceweb.io
å¤åˆ¶ä»£ç 
```

- åˆ©ç”¨promise+ç”Ÿæˆå™¨çš„æ–¹å¼å˜ç›¸å®ç°è§£å†³å›è°ƒåœ°ç‹±é—®é¢˜ï¼Œå…¶å®å°±æ˜¯`async await`çš„ä¸€ä¸ªå˜ç§è€Œå·²
- æœ€æ—©ä¸º**TJ**å®ç°ï¼Œ**å‰ç«¯å¤§ç¥äººç‰©**
- async awaitæ ¸å¿ƒä»£ç å°±ç±»ä¼¼è¿™äº›ï¼Œå†…éƒ¨ä¸»åŠ¨å¸®æˆ‘ä»¬è°ƒç”¨`.next`æ–¹æ³•

### 3.5 æœ€ç»ˆè§£å†³å›è°ƒåœ°ç‹±çš„åŠæ³•

```javascript
function requestData(url) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (url.includes('iceweb')) {
        resolve(url)
      } else {
        reject('è¯·æ±‚é”™è¯¯')
      }
    }, 1000);
  })
}

async function getData() {
  const res1 = await requestData('iceweb.io')
  const res2 = await requestData(`iceweb.org ${res1}`)
  const res3 = await requestData(`iceweb.com ${res2}`)

  console.log(res3)
}

getData()

//iceweb.com iceweb.org iceweb.io
å¤åˆ¶ä»£ç 
```

- ä½ ä¼šæƒŠå¥‡çš„å‘ç°ï¼Œåªè¦æŠŠ`getData`ç”Ÿæˆå™¨å‡½æ•°å‡½æ•°ï¼Œæ”¹ä¸º`async`å‡½æ•°ï¼Œ`yeild`çš„å…³é”®å­—æ›¿æ¢ä¸º`await`å°±å¯ä»¥å®ç°å¼‚æ­¥ä»£ç åŒæ­¥å†™æ³•äº†ã€‚

## 4. async/await å‰–æ

- asyncï¼ˆå¼‚æ­¥çš„ï¼‰
- async ç”¨äºç”³æ˜ä¸€ä¸ªå¼‚æ­¥å‡½æ•°

### 4.1 asyncå†…éƒ¨ä»£ç åŒæ­¥æ‰§è¡Œ

- å¼‚æ­¥å‡½æ•°çš„å†…éƒ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹å’Œæ™®é€šçš„å‡½æ•°æ˜¯ä¸€è‡´çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¼šè¢«åŒæ­¥æ‰§è¡Œ

```javascript
async function sayHi() {
  console.log('hi ice')
}

sayHi()

//hi ice
å¤åˆ¶ä»£ç 
```

### 4.2 å¼‚æ­¥å‡½æ•°çš„è¿”å›å€¼

- å¼‚æ­¥å‡½æ•°çš„è¿”å›å€¼å’Œæ™®é€šè¿”å›å€¼æœ‰æ‰€åŒºåˆ«
  - æ™®é€šå‡½æ•°ä¸»åŠ¨è¿”å›ä»€ä¹ˆå°±è¿”å›ä»€ä¹ˆï¼Œä¸è¿”å›ä¸º`undefined`
  - å¼‚æ­¥å‡½æ•°çš„è¿”å›å€¼ç‰¹ç‚¹ 
    - æ˜ç¡®æœ‰è¿”å›ä¸€ä¸ªæ™®é€šå€¼ï¼Œç›¸å½“äº`Promise.resolve`(è¿”å›å€¼)
    - è¿”å›ä¸€ä¸ªthenableå¯¹è±¡åˆ™ç”±ï¼Œthenæ–¹æ³•ä¸­çš„`resolve`,æˆ–è€…`reject`æœ‰å…³
    - æ˜ç¡®è¿”å›ä¸€ä¸ªpromiseï¼Œåˆ™ç”±è¿™ä¸ªpromiseå†³å®š
- å¼‚æ­¥å‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨`await`å…³é”®å­—ï¼Œç°åœ¨åœ¨å…¨å±€ä¹Ÿå¯ä»¥è¿›è¡Œ`await`ï¼Œä½†æ˜¯ä¸æ¨èã€‚ä¼šé˜»å¡ä¸»è¿›ç¨‹çš„ä»£ç æ‰§è¡Œ

### 4.3 å¼‚æ­¥å‡½æ•°çš„å¼‚å¸¸å¤„ç†

- å¦‚æœå‡½æ•°å†…éƒ¨ä¸­é€”å‘ç”Ÿé”™è¯¯ï¼Œå¯ä»¥é€šè¿‡try catchçš„æ–¹å¼æ•è·å¼‚å¸¸
- å¦‚æœå‡½æ•°å†…éƒ¨ä¸­é€”å‘ç”Ÿé”™è¯¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‡½æ•°çš„è¿”å›å€¼.catchè¿›è¡Œæ•è·

```js
async function sayHi() {
  console.log(res)
}
sayHi().catch(e => console.log(e))

//æˆ–è€…

async function sayHi() {
  try {
    console.log(res)
  }catch(e) {
    console.log(e)
  }
}

sayHi()

//ReferenceError: res is not defined
å¤åˆ¶ä»£ç 
```

### 4.4 await å…³é”®å­—

- å¼‚æ­¥å‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨`await`å…³é”®å­—ï¼Œæ™®é€šå‡½æ•°ä¸è¡Œ
- awaitç‰¹ç‚¹ 
  - é€šå¸¸awaitå…³é”®å­—åé¢éƒ½æ˜¯è·Ÿä¸€ä¸ªPromise 
    - å¯ä»¥æ˜¯æ™®é€šå€¼
    - å¯ä»¥æ˜¯thenable
    - å¯ä»¥æ˜¯Promiseä¸»åŠ¨è°ƒç”¨`resolveæˆ–è€…reject`
  - è¿™ä¸ªpromiseçŠ¶æ€å˜ä¸ºfulfilledæ‰ä¼šæ‰§è¡Œ`await`åç»­çš„ä»£ç ï¼Œæ‰€ä»¥`await`åé¢çš„ä»£ç ï¼Œç›¸å½“äºåŒ…æ‹¬åœ¨`.then`æ–¹æ³•çš„å›è°ƒä¸­ï¼Œå¦‚æœçŠ¶æ€å˜ä¸ºrejectedï¼Œä½ åˆ™éœ€è¦åœ¨å‡½æ•°å†…éƒ¨`try catch`ï¼Œæˆ–è€…è¿›è¡Œé“¾å¼è°ƒç”¨è¿›è¡Œ`.catch`æ“ä½œ

```javascript
function requestData(url) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (url.includes('iceweb')) {
        resolve(url)
      } else {
        reject('è¯·æ±‚é”™è¯¯')
      }
    }, 1000);
  })
}

async function getData() {
  const res = await requestData('iceweb.io')
  console.log(res)
}

getData()

// iceweb.io
å¤åˆ¶ä»£ç 
```

## 5. ç»“è¯­

- å¦‚æœç°åœ¨çœŸçš„çœ‹ä¸åˆ°æœªæ¥æ˜¯æ€æ ·ï¼Œä½ å°±ä¸å¦‚ä¸€ç›´å¾€å‰èµ°ï¼Œä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å¤©äº®ï¼Œå»å¥”è·‘å°±å¥½ï¼Œè·‘ç€è·‘ç€å¤©å°±äº®äº†ã€‚



ä½œè€…ï¼šä¸Šå±±äºº
é“¾æ¥ï¼šhttps://juejin.cn/post/7144308012952322084
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

# å‰è¨€

**å¦‚æœä½ é—®æˆ‘æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥è®©è‡ªå·±JSçš„æŠ€æœ¯æ´»ç”Ÿç”Ÿåœ°æå‡ä¸€ä¸ªç­‰çº§ï¼Ÿ** ğŸ™€

**`é‚£å°±æ˜¯æ‰‹å†™Promiseäº†ï¼ï¼ï¼`** ğŸ˜º

æ‰‹å†™Promise æœ‰ä¸€ä¸ªéš¾ç‚¹å°±åœ¨äºæœ‰å¾ˆå¤šåœ°æ–¹éœ€è¦å’ŒåŸç”Ÿä¸€æ ·ä¸¥è°¨ï¼Œä¹Ÿå°±æ˜¯è¯´åŸç”Ÿçš„Promiseä¼šè€ƒè™‘å¾ˆå¤šç‰¹æ®Šæƒ…å†µ~ğŸ§

æˆ‘ä»¬åœ¨å®é™…è¿ç”¨æ—¶å¯èƒ½æš‚æ—¶ä¸ä¼šç¢°åˆ°è¿™äº›æƒ…å†µï¼Œå¯æ˜¯å½“æˆ‘ä»¬é‡åˆ°çš„æ—¶å€™ **å´ä¸çŸ¥åº•å±‚çš„åŸç†ï¼Œæ— æ³•ç²¾å‡†å®šä½å’Œè§£å†³é—®é¢˜ï¼Œ`è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦çŸ¥é“å¦‚ä½•æ‰‹å†™Promise`**

å¦‚æœä½ é—®æˆ‘ä¸ºä»€ä¹ˆçœ‹äº†è¿™ä¹ˆå¤šæ•™ç¨‹è¿˜æ˜¯ä¸æ‡‚å¦‚ä½•æ‰‹å†™Promiseï¼Œé‚£å°±æ˜¯å› ä¸ºè¿™é‡Œå¤´æœ‰å¾ˆå¤šç»†èŠ‚éš¾ç‚¹ï¼Œå¾ˆå°‘äººæœ‰äººæ„¿æ„æŠŠè¿™äº›éƒ½è®²å‡ºæ¥ï¼Œä¸è¿‡æˆ‘ä»Šå¤©å°±è¦æŠŠè¿™é‡Œå¤´çš„ç»†èŠ‚ä¸€ä¸ªä¸ªç»™æŠ å‡ºæ¥ï¼Œ*æ‰€ä»¥è¯·å¤§å®¶åŠ¡å¿…å…ˆæ”¶è—å†è§‚çœ‹ ~* å¥¥åŠ›ç»™ğŸ˜¸ğŸ˜¸ğŸ˜¸

æ‰‹å†™PromiseåŒ…å«ä»¥ä¸‹çŸ¥è¯†ç‚¹ ğŸ‘‡ï¼š

- Promise
- Class ç±»
- æ”¹å˜thisæŒ‡å‘ (callã€applyå’Œbind)
- äº‹ä»¶å¾ªç¯ Event Loop
- ç­‰

ä¸å¿…æ‹…å¿ƒå› ä¸ºä¸Šé¢çš„çŸ¥è¯†ç‚¹ä¸ç†Ÿç»ƒè€Œæ— æ³•è¿›è¡Œ"æ‰‹å†™Promise"çš„å­¦ä¹ ï¼Œå› ä¸ºæœ¬æ–‡é™„å¸¦ `åŒ…ä¼šå¥—é¤` ğŸ‘‡ï¼š

- ğŸ” å¦‚æœä½ ä¸å¤ªç†Ÿæ‚‰Promiseçš„è¯ï¼Œå»ºè®®å…ˆçœ‹æˆ‘ä¹‹å‰å‘çš„é‚£ç¯‡Promiseæ–‡ç« ï¼š[é€šä¿—æ˜“æ‡‚çš„PromiseçŸ¥è¯†ç‚¹æ€»ç»“ï¼Œæ£€éªŒä¸€ä¸‹ä½ æ˜¯å¦çœŸçš„å®Œå…¨æŒæ¡äº†promiseï¼Ÿ](https://juejin.cn/post/7020335414980378655)
- ğŸ” å¦‚æœä¸çŸ¥é“ `ç±» class` æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œå»ºè®®å‚è€ƒæˆ‘å‘çš„è¿™ç¯‡æ–‡ç« ï¼š[ES6æ–°ç‰¹æ€§ Class ç±»çš„å…¨æ–¹é¢ç†è§£](https://juejin.cn/post/7021069095336411166)
- ğŸ” å…¶ä»–çŸ¥è¯†ç‚¹è®²è§£æ–‡ç« ï¼Œä¼šåœ¨æ–‡ä¸­åˆ—å‡ºï¼Œä¸ç”¨æ‹…å¿ƒï¼Œä½ åªéœ€è¦è·Ÿç€è¿™ç¯‡æ–‡ä¸­èµ°å°±å®Œäº†~

æ‰‹å†™ä¹‹å‰å…ˆç®€è¦çš„å¤ä¹ ä¸€ä¸‹ Promiseï¼Œç°åœ¨æˆ‘ä»¬å°±æ¥ä¸€è¾¹å›å¿†ä¸€è¾¹å®ç°Promiseå§ ğŸª~

> *å¦‚æœå¾ˆç†Ÿæ‚‰ Promsie å¯ä»¥è·³è¿‡ä¸‹é¢è¿™ä¸€èŠ‚`(ä¸å»ºè®®)`*

**â—¾ promise æ ¸å¿ƒè¦ç‚¹**

> æœ¬ç« èŠ‚å†…å®¹å…¶å®å¹¶ä¸å¤šï¼Œè€Œä¸”é€šä¿—æ˜“æ‡‚ï¼Œå»ºè®®ä¸å¤ªç†Ÿæ‚‰Promiseçš„åŒå­¦è¿˜æ˜¯å¾ªåºæ¸è¿›çš„çœ‹å®Œæœ¬ç« å†é€æ­¥å­¦ä¹ Promiseæ ¸å¿ƒæ‰‹å†™~

`Promise`å¯¹è±¡ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæœ‰ä¸‰ç§çŠ¶æ€ï¼š`pending`ï¼ˆè¿›è¡Œä¸­ï¼‰ã€`fulfilled`ï¼ˆå·²æˆåŠŸï¼‰å’Œ`rejected`ï¼ˆå·²å¤±è´¥ï¼‰

ä¸€ä¸ª `Promise` å¿…ç„¶å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ä¹‹ä¸€ ğŸ‘‡ï¼š

- å¾…å®š `(pending)`: åˆå§‹çŠ¶æ€ï¼Œæ—¢æ²¡æœ‰è¢«å…‘ç°ï¼Œä¹Ÿæ²¡æœ‰è¢«æ‹’ç»ã€‚
- å·²æˆåŠŸ `(fulfilled)`: æ„å‘³ç€æ“ä½œæˆåŠŸå®Œæˆã€‚
- å·²æ‹’ç» `(rejected)`: æ„å‘³ç€æ“ä½œå¤±è´¥ã€‚

å½“ promise è¢«è°ƒç”¨åï¼Œå®ƒä¼šä»¥**å¤„ç†ä¸­çŠ¶æ€** `(pending)` å¼€å§‹ã€‚ è¿™æ„å‘³ç€è°ƒç”¨çš„å‡½æ•°ä¼šç»§ç»­æ‰§è¡Œï¼Œè€Œ promise ä»å¤„äºå¤„ç†ä¸­ç›´åˆ°è§£å†³ä¸ºæ­¢ï¼Œä»è€Œä¸ºè°ƒç”¨çš„å‡½æ•°æä¾›æ‰€è¯·æ±‚çš„ä»»ä½•æ•°æ®ã€‚

è¢«åˆ›å»ºçš„ promise æœ€ç»ˆä¼šä»¥**è¢«è§£å†³çŠ¶æ€** `(fulfilled)` æˆ– **è¢«æ‹’ç»çŠ¶æ€** `(rejected)` ç»“æŸï¼Œå¹¶åœ¨å®Œæˆæ—¶è°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°ï¼ˆä¼ ç»™ **then** å’Œ **catch**ï¼‰ã€‚

â—¾ ä¸ºäº†è®©è¯»è€…å°½å¿«å¯¹promiseæœ‰ä¸€ä¸ªæ•´ä½“çš„ç†è§£ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µpromiseçš„ä¾‹å­ ğŸŒ°ï¼š

```javascript
let p1 = new Promise((resolve, reject) => {
    resolve('æˆåŠŸ')
    reject('å¤±è´¥')
})
console.log('p1', p1)

let p2 = new Promise((resolve, reject) => {
    reject('å¤±è´¥')
    resolve('æˆåŠŸ')
})
console.log('p2', p2)

let p3 = new Promise((resolve, reject) => {
    throw('æŠ¥é”™')
})
console.log('p3', p3)
å¤åˆ¶ä»£ç 
```

è¾“å‡ºç»“æœä¸ºï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/850f66b296cb4c9582a8711c4955db67~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

**è¿™é‡ŒåŒ…å«äº†å››ä¸ªçŸ¥è¯†ç‚¹ ğŸ‘‡ï¼š**

- 1ã€æ‰§è¡Œäº†`resolve()`ï¼ŒPromiseçŠ¶æ€ä¼šå˜æˆ`fulfilled`ï¼Œå³ **å·²å®ŒæˆçŠ¶æ€**
- 2ã€æ‰§è¡Œäº†`reject()`ï¼ŒPromiseçŠ¶æ€ä¼šå˜æˆ`rejected`ï¼Œå³ **è¢«æ‹’ç»çŠ¶æ€**
- 3ã€Promiseåªä»¥`ç¬¬ä¸€æ¬¡ä¸ºå‡†`ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸå°±`æ°¸ä¹…`ä¸º`fulfilled`ï¼Œç¬¬ä¸€æ¬¡å¤±è´¥å°±æ°¸è¿œçŠ¶æ€ä¸º`rejected`
- 4ã€Promiseä¸­æœ‰`throw`çš„è¯ï¼Œå°±ç›¸å½“äºæ‰§è¡Œäº†`reject()`

â—¾ æ¥ä¸‹æ¥çœ‹ä¸‹é¢ä¸€æ®µä»£ç ï¼Œå­¦ä¹ æ–°çš„çŸ¥è¯†ç‚¹ï¼š

```javascript
let myPromise1 = new Promise(() => {});

console.log('myPromise1 :>> ', myPromise1);

let myPromise2 = new Promise((resolve, reject) => {
    let a = 1;
    for (let index = 0; index < 5; index++) {
        a++;
    }
})

console.log('myPromise2 :>> ', myPromise2)

myPromise2.then(() => {
    console.log("myPromise2æ‰§è¡Œäº†then");
})
å¤åˆ¶ä»£ç 
```

è¾“å‡ºç»“æœä¸ºï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40c613f7a4534fda80b6c13c346dba15~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**è¿™é‡ŒåŒ…å«äº†ä¸‰ä¸ªçŸ¥è¯†ç‚¹** ğŸ‘‡ï¼š

- 1ã€Promiseçš„åˆå§‹çŠ¶æ€æ˜¯`pending`
- 2ã€Promiseé‡Œæ²¡æœ‰æ‰§è¡Œ`resolve()`ã€`reject()`ä»¥åŠ`throw`çš„è¯ï¼Œè¿™ä¸ª**promiseçš„çŠ¶æ€ä¹Ÿæ˜¯`pending`**
- 3ã€åŸºäºä¸Šä¸€æ¡ï¼Œ`pending`çŠ¶æ€ä¸‹çš„promiseä¸ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°`then()`

**â—¾ æœ€åä¸€ç‚¹ï¼š**

```javascript
let myPromise0 = new Promise();
console.log('myPromise0 :>> ', myPromise0);
å¤åˆ¶ä»£ç 
```

è¾“å‡ºç»“æœï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b95ce2e9ddc74e4eae9eb80d8dd54ba8~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

è¿™ä¸ªé‡ŒåŒ…å«äº†ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š

- è§„å®šå¿…é¡»ç»™`Promise`å¯¹è±¡ä¼ å…¥ä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼Œå¦åˆ™å°†ä¼šæŠ¥é”™ã€‚

# ä¸€ã€å®šä¹‰åˆå§‹ç»“æ„

åŸç”Ÿçš„promiseæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šç”¨newæ¥åˆ›å»ºå®ä¾‹ ğŸ‘‡ ï¼š

```javascript
let promise = new Promise()
å¤åˆ¶ä»£ç 
```

æ‰€ä»¥æˆ‘ä»¬æ‰‹å†™çš„æ—¶å€™å¯ä»¥ç”¨æ„é€ å‡½æ•°æˆ–è€…classæ¥åˆ›å»ºï¼Œä¸ºäº†æ–¹ä¾¿ä»£ç çš„æ•´ä½“è§‚çœ‹å°±ç”¨classã€‚

ğŸ” å¦‚æœä¸çŸ¥é“ `ç±» class` æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œå»ºè®®å‚è€ƒæˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[ES6æ–°ç‰¹æ€§ Class ç±»çš„å…¨æ–¹é¢ç†è§£](https://juejin.cn/post/7021069095336411166)

æŠŠæˆ‘ä»¬æ‰‹å†™çš„Promiseå‘½åä¸ºmyPromiseï¼Œ*å…·ä½“åå­—å¯ä»¥æŒ‰è‡ªå·±æƒ³æ³•ï¼Œéƒ½å¯ä»¥*

é¦–å…ˆåˆ›å»ºä¸€ä¸ª`myPromise`ç±»

```javascript
class myPromise {}
å¤åˆ¶ä»£ç 
```

åœ¨newä¸€ä¸ªpromiseå®ä¾‹çš„æ—¶å€™è‚¯å®šæ˜¯éœ€è¦ä¼ å…¥å‚æ•°çš„

```javascript
let promise = new Promise(() => {})
å¤åˆ¶ä»£ç 
```

ä¸ç„¶è¿™ä¸ªå®ä¾‹ç”¨å¤„ä¸å¤§ï¼›è€Œè¿™ä¸ªå‚æ•°æˆ‘ä»¬çŸ¥é“æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å½“æˆ‘ä»¬ä¼ å…¥è¿™ä¸ªå‡½æ•°å‚æ•°çš„æ—¶å€™ï¼Œè¿™ä¸ªå‡½æ•°å‚æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç±»çš„`æ„é€ å‡½æ•°constructor`é‡Œé¢æ·»åŠ ä¸€ä¸ªå‚æ•°ï¼Œè¿™é‡Œå°±ç”¨funcæ¥åšå½¢å‚ï¼Œå¹¶ä¸”æ‰§è¡Œä¸€ä¸‹è¿™ä¸ªå‚æ•°

```javascript
class myPromise {
+    constructor(func) {
+       func();
+   }
}
å¤åˆ¶ä»£ç 
```

# äºŒã€å®ç° resolve å’Œ reject

æ¥ä¸‹æ¥ï¼Œå¤§å®¶éƒ½çŸ¥é“éœ€è¦ä¸ºè¿™ä¸ªå‡½æ•°å‚æ•°ä¼ å…¥å®ƒè‡ªå·±çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯`resolve()`å’Œ`reject()`

åŸç”Ÿçš„promiseé‡Œé¢å¯ä»¥ä¼ å…¥`resolve`å’Œ`reject`ä¸¤ä¸ªå‚æ•°

```javascript
let promise = new Promise((resolve, reject) => {})
å¤åˆ¶ä»£ç 
```

é‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¾—å…è®¸æ‰‹å†™è¿™è¾¹å¯ä»¥ä¼ å…¥è¿™ä¸¤ä¸ªå‚æ•°ï¼š

```javascript
class myPromise {
    constructor(func) {
+       func(resolve, reject);
    }
}
å¤åˆ¶ä»£ç 
```

è¿™é‡Œè¿™æ ·å†™æ˜æ˜¾æœ‰ä¸€ä¸ªé—®é¢˜ ğŸ¤¨ï¼Œé‚£å°±æ˜¯æ‰‹å†™è¿™è¾¹ä¸çŸ¥é“å“ªé‡Œè°ƒç”¨`resolve()`å’Œ`reject()`è¿™ä¸¤ä¸ªå‚æ•°ï¼Œæ¯•ç«Ÿ`resolve()`å’Œ`reject()`è¿˜æ²¡æœ‰å®šä¹‰

å› æ­¤å°±éœ€è¦åˆ›é€ å‡ºè¿™ä¸¤ä¸ªå¯¹è±¡ ğŸ˜€

æœ‰ä¸€ç‚¹æˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯`resolve()`å’Œ`reject()`ä¹Ÿæ˜¯ä»¥å‡½æ•°çš„å½¢å¼æ¥æ‰§è¡Œçš„ï¼Œæˆ‘ä»¬åœ¨åŸç”Ÿ`promise`é‡Œä¹Ÿæ˜¯åœ¨`resolve`å’Œ`reject`åé¢åŠ æ‹¬å·`()`æ¥æ‰§è¡Œçš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨ç±»æ–¹æ³•çš„å½¢å¼æ¥åˆ›å»ºè¿™ä¸¤ä¸ªå‡½æ•°ï¼š

```javascript
class myPromise {
    constructor(func) {
        func(resolve, reject);
    }
+   resolve() {}
+   reject() {}
}
å¤åˆ¶ä»£ç 
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3f6b473ae29e4418a9998a3b3dedcd04~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

åˆ›å»ºè¿™ä¸¤ä¸ªæ–¹æ³•ä»¥åæˆ‘ä»¬å‘ç°`func`é‡Œé¢çš„ä¸¤ä¸ªå‚æ•°é¢œè‰²è¿˜æ˜¯åŸæ¥çš„é¢œè‰²ï¼Œç¼–è¾‘å™¨å°±æ˜¯åœ¨å‘Šè¯‰æˆ‘ä»¬ï¼šè¿™ä¸¤ä¸ªå‚æ•°è¿˜æ²¡æœ‰åˆ›å»ºå™¢~ğŸ˜²

ç­‰ä¸‹ï¼Œåˆšåˆšä¸æ˜¯å·²ç»åˆ›å»ºäº†å—ï¼ŸğŸ¦

æ˜¯çš„ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ç”¨`this`æ¥è°ƒç”¨è‡ªèº«`class`çš„æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æ„é€ å‡½æ•°é‡ŒæŠŠä¸¤ä¸ªå‚æ•°å‰åŠ ä¸Š`this`ï¼š

```javascript
class myPromise {
    constructor(func) {
+       func(this.resolve, this.reject);
    }
    resolve() {}
    reject() {}
}
å¤åˆ¶ä»£ç 
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87e4027549bd40e5b9a647493e0b44dd~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

é‚£ä¹ˆè¿™é‡Œçš„`resolve()`å’Œ`reject()`æ–¹æ³•åº”è¯¥å¦‚ä½•æ‰§è¡Œå‘¢ï¼Ÿé‡Œé¢åº”è¯¥å†™ä»€ä¹ˆå†…å®¹å‘¢ï¼ŸğŸ˜¯

è¿™å°±éœ€è¦ç”¨åˆ°çŠ¶æ€äº† ğŸ˜›

## 1. ç®¡ç†çŠ¶æ€å’Œç»“æœ

promiseæœ‰ä¸‰ç§çŠ¶æ€ï¼šåˆ†åˆ«æ˜¯`pending`ï¼Œ`fulfilled`å’Œ`rejected`

- åˆå§‹çš„æ—¶å€™æ˜¯`pending`
- `pending`å¯ä»¥è½¬ä¸º`fulfilled`çŠ¶æ€ï¼Œä½†æ˜¯ä¸èƒ½é€†è½¬
- `pending`ä¹Ÿå¯ä»¥è½¬ä¸º`rejected`çŠ¶æ€ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½é€†è½¬
- è¿™é‡Œ`fulfilled`å’Œ`rejected`ä¹Ÿä¸èƒ½äº’è½¬

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bcaccbc6d596491cbcd2c5715e8a14d6~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å› æ­¤æˆ‘ä»¬éœ€è¦æå‰å…ˆæŠŠè¿™äº›çŠ¶æ€å®šä¹‰å¥½ï¼Œå¯ä»¥ç”¨`const`æ¥åˆ›å»ºå¤–éƒ¨çš„å›ºå®šå˜é‡ï¼Œä½†æ˜¯è¿™é‡Œä¸ºäº†ç»Ÿä¸€å°±ç”¨`static`æ¥åˆ›å»º`é™æ€å±æ€§`ï¼š

```javascript
class myPromise {
+   static PENDING = 'pending';
+   static FULFILLED = 'fulfilled';
+   static REJECTED = 'rejected';
    constructor(func) {
        func(this.resolve, this.reject);
    }
    resolve() {}
    reject() {}
}
å¤åˆ¶ä»£ç 
```

åˆ›å»ºäº†çŠ¶æ€å±æ€§ä»¥åï¼Œè¿˜éœ€è¦ä¸ºæ¯ä¸€ä¸ªå®ä¾‹æ·»åŠ ä¸€ä¸ª`çŠ¶æ€å±æ€§`ï¼Œåœ¨å‰é¢è®²åˆ°å¾— `â€œPromise æ ¸å¿ƒè¦ç‚¹â€` ç« èŠ‚ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“åŸç”ŸPromiseç”¨`PromiseState`è¿™ä¸ªå­—æ®µæ¥ä¿å­˜å®ä¾‹çš„çŠ¶æ€å±æ€§ï¼Œè¿™é‡Œå°±ä¹Ÿç”¨ `this.PromiseState` æ¥ä¿å­˜å®ä¾‹çš„çŠ¶æ€å±æ€§ï¼Œè¿™ä¸ªçŠ¶æ€å±æ€§é»˜è®¤å°±æ˜¯ `å¾…å®špending` çŠ¶æ€ï¼Œ**è¿™æ ·åœ¨æ¯ä¸€ä¸ªå®ä¾‹è¢«åˆ›å»ºä»¥åå°±ä¼šæœ‰è‡ªèº«çš„çŠ¶æ€å±æ€§å¯ä»¥è¿›è¡Œåˆ¤æ–­å’Œå˜åŠ¨äº†**

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
+       this.PromiseState = myPromise.PENDING;
        func(this.resolve, this.reject);
    }
    resolve() {}
    reject() {}
}
å¤åˆ¶ä»£ç 
```

é‚£ä¹ˆåœ¨æ‰§è¡Œ`resolve()`çš„æ—¶å€™å°±éœ€è¦åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸º `å¾…å®š pending`ï¼Œå¦‚æœæ˜¯ `å¾…å®š pending`çš„è¯å°±æŠŠçŠ¶æ€æ”¹ä¸º `æˆåŠŸ fulfilled`:

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        func(this.resolve, this.reject);
    }
    resolve() {
+       if (this.PromiseState === myPromise.PENDING) {
+           this.PromiseState = myPromise.FULFILLED;
+       }
    }
    reject() {}
}
å¤åˆ¶ä»£ç 
```

åŒæ ·ï¼Œä¸ºç»™`reject`æ·»åŠ å‚æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•°èµ‹å€¼ç»™å®ä¾‹çš„`PromiseResult`å±æ€§:

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        func(this.resolve, this.reject);
    }
    resolve() {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
        }
    }
    reject() {
+       if (this.PromiseState === myPromise.PENDING) {
+           this.PromiseState = myPromise.REJECT;
+       }
    }
}
å¤åˆ¶ä»£ç 
```

**â—¾ æ‰§è¡Œ `resolve()` å’Œ `reject()` å¯ä»¥ä¼ å‚**

ç°åœ¨æˆ‘ä»¬å†å›å¿†ä¸€ä¸‹åŸç”Ÿ`Promise` ğŸ™‚ï¼Œåœ¨æ‰§è¡Œ`resolve()`æˆ–è€…`reject()`çš„æ—¶å€™éƒ½æ˜¯å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œè¿™æ ·æˆ‘ä»¬åé¢å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‚æ•°äº†

```javascript
let promise = new Promise((resolve, reject) => {
    resolve('è¿™æ¬¡ä¸€å®š')
})
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªç»“æœå‚æ•°å‘½åä¸º`PromiseResult` *(å’ŒåŸç”ŸPromiseä¿æŒä¸€è‡´)*ï¼Œä¸ç®¡æ˜¯æˆåŠŸè¿˜æ˜¯æ‹’ç»çš„ç»“æœï¼Œä¸¤è€…é€‰å…¶ä¸€ï¼Œæˆ‘ä»¬è®©æ¯ä¸ªå®ä¾‹éƒ½æœ‰`PromiseResult`å±æ€§ï¼Œå¹¶ä¸”ç»™ä»–ä»¬éƒ½èµ‹å€¼`null`ï¼Œè¿™é‡Œç»™ç©ºå€¼`null`æ˜¯å› ä¸ºæ‰§è¡Œ`resolve()`æˆ–è€…`reject()`çš„æ—¶å€™ä¼šç»™ç»“æœèµ‹å€¼ï¼š

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
+       this.PromiseResult = null;
        func(this.resolve, this.reject);
    }
    resolve() {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
        }
    }
    reject() {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECT;
        }
    }
}
å¤åˆ¶ä»£ç 
```

æ¥ç€æˆ‘ä»¬å°±å¯ä»¥ç»™`resolve()`æ·»åŠ å‚æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•°èµ‹å€¼ç»™å®ä¾‹çš„`PromiseResult`å±æ€§:

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        func(this.resolve, this.reject);
    }
+   resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
+           this.PromiseResult = result;
        }
    }
    reject() {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECT;
        }
    }
}
å¤åˆ¶ä»£ç 
```

åŒæ ·ï¼Œä¸ºç»™`reject()`æ·»åŠ å‚æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•°èµ‹å€¼ç»™å®ä¾‹çš„`PromiseResult`å±æ€§:

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        func(this.resolve, this.reject);
    }
    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
        }
    }
+   reject(reason) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECT;
+           this.PromiseResult = reason;
        }
    }
}
å¤åˆ¶ä»£ç 
```

## 2. this æŒ‡å‘é—®é¢˜

ç°åœ¨çš„ä»£ç çœ‹èµ·æ¥é£å¹³æµªé™çš„ï¼Œä½†å¾ˆå¤šäººä¼šåœ¨è¿™é‡ŒçŠ¯é”™~ğŸ˜¥

å¤§å®¶è§‰å¾—è¿™é‡Œæœ‰ä»€ä¹ˆé”™è¯¯ï¼ŸğŸ§

æˆ‘ä»¬æ¥`new`ä¸€ä¸ªå®ä¾‹ ğŸŒ° æ‰§è¡Œä¸€ä¸‹ä»£ç å°±çŸ¥é“æœ‰æ²¡æœ‰é—®é¢˜äº†

```javascript
class myPromise {
    ...
}

// æµ‹è¯•ä»£ç 
+  let promise1 = new myPromise((resolve, reject) => {
+      resolve('è¿™æ¬¡ä¸€å®š');
+  })
å¤åˆ¶ä»£ç 
```

è¿è¡Œä¸Šé¢ä»£ç ï¼ŒæŠ¥é”™ ğŸ¦ï¼š

```
Uncaught TypeError: Cannot read property 'PromiseState ' of undefined
```

å¯ä»æŠ¥é”™çš„ä¿¡æ¯é‡Œé¢æˆ‘ä»¬è²Œä¼¼å‘ç°ä¸äº†æœ‰ä»€ä¹ˆé”™è¯¯ğŸ¤¨ï¼Œå› ä¸º`PromiseState `å±æ€§æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ï¼Œä¸åº”è¯¥æ˜¯`undefined`~

ğŸ” ä½†æˆ‘ä»¬ä»”ç»†çœ‹çœ‹`resolve()`å’Œ`reject()`æ–¹æ³•é‡Œè°ƒç”¨`PromiseState `ï¼Œå‰é¢æ˜¯æœ‰`this`å…³é”®å­—çš„ğŸ˜²

```javascript
    resolve(result) {
â¡      if (this.PromiseState === myPromise.PENDING) {
â¡          this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
        }
    }
    reject(reason) {
â¡      if (this.PromiseState === myPromise.PENDING) {
â¡          this.PromiseState = myPromise.REJECT;
            this.PromiseResult = reason;
        }
    }
å¤åˆ¶ä»£ç 
```

é‚£ä¹ˆåªæœ‰ä¸€ç§å¯èƒ½ğŸ§ï¼Œè°ƒç”¨`this.PromiseState `çš„æ—¶å€™å¹¶æ²¡æœ‰è°ƒç”¨`constructor`é‡Œçš„`this.PromiseState `ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„`this`å·²ç»è·Ÿä¸¢äº†~

æˆ‘ä»¬åœ¨`new`ä¸€ä¸ªæ–°å®ä¾‹çš„æ—¶å€™æ‰§è¡Œçš„æ˜¯`constructor`é‡Œçš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯`constructor`é‡Œçš„`this`ç¡®å®æ˜¯æ–°å®ä¾‹çš„ï¼Œä½†ç°åœ¨æˆ‘ä»¬æ˜¯åœ¨æ–°å®ä¾‹è¢«åˆ›å»ºåå†åœ¨å¤–éƒ¨ç¯å¢ƒä¸‹æ‰§è¡Œ`resolve()`æ–¹æ³•çš„ï¼Œè¿™é‡Œçš„`resolve()`çœ‹ç€åƒæ˜¯å’Œå®ä¾‹ä¸€èµ·æ‰§è¡Œçš„ï¼Œå…¶å®ä¸ç„¶ï¼Œä¹Ÿå°±**ç›¸å½“äºä¸åœ¨`class`å†…éƒ¨ä½¿ç”¨è¿™ä¸ª`this`**ï¼Œè€Œ**æˆ‘ä»¬æ²¡æœ‰åœ¨å¤–éƒ¨å®šä¹‰ä»»ä½•`PromiseState `å˜é‡ï¼Œå› æ­¤è¿™é‡Œä¼šæŠ¥é”™**

è§£å†³`class`çš„`this`æŒ‡å‘é—®é¢˜ä¸€èˆ¬ä¼šç”¨ç®­å¤´å‡½æ•°ï¼Œ`bind`æˆ–è€…`proxy`ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨`bind`æ¥ç»‘å®š`this`ï¼Œåªéœ€è¦åœ¨æ„é€ å‡½æ•°`constructor`ä¸­çš„`this.resolve`å’Œ`this.reject`ååŠ ä¸Šï¼Œ`.bindï¼ˆthisï¼‰`å°±å¯ä»¥äº† ğŸ˜º:

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
+       func(this.resolve.bind(this), this.reject.bind(this));
    }
    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult  = result;
        }
    }
    reject(reason) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECT;
            this.PromiseResult = reason;
        }
    }
}

// æµ‹è¯•ä»£ç 
let promise1 = new myPromise((resolve, reject) => {
    resolve('è¿™æ¬¡ä¸€å®š');
})
å¤åˆ¶ä»£ç 
```

ğŸ” å¦‚æœè¿™é‡Œæœ‰ç‚¹è’™åœˆï¼Œä¸å¤ªæ‡‚ä¸ºä»€ä¹ˆè¿™æ ·å†™ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„å…³äº`this`æŒ‡å‘çš„æ–‡ç« ï¼š

- [JavaScript åŸºç¡€ç³»åˆ—ä¹‹ callã€apply å’Œ bind æ–¹æ³•çš„ç”¨æ³•ã€åŒºåˆ«å’Œä½¿ç”¨åœºæ™¯](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyuanyuanbyte%2FBlog%2Fissues%2F115)
- [JavaScript æ·±å…¥ç³»åˆ—ä¹‹ callã€apply å’Œ bind æ–¹æ³•çš„æ¨¡æ‹Ÿå®ç°](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyuanyuanbyte%2FBlog%2Fissues%2F109)

æˆ‘ä»¬æ¥ç€å¾€ä¸‹å†™~

å¯¹äº`resolve`æ¥è¯´ï¼Œè¿™é‡Œå°±æ˜¯ç»™å®ä¾‹çš„`resolve()`æ–¹æ³•ç»‘å®šè¿™ä¸ª`this`ä¸ºå½“å‰çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”æ‰§è¡Œ`this.resolve()`æ–¹æ³•ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c4f15ab1711462892c301caee12191b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp) å¯¹äº`reject`æ¥è¯´ï¼Œè¿™é‡Œå°±æ˜¯ç»™å®ä¾‹çš„`reject`æ–¹æ³•ç»‘å®šè¿™ä¸ª`this`ä¸ºå½“å‰çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”æ‰§è¡Œ`this.reject`æ–¹æ³•ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/753b61f4ae814801a5ebaafc5c8a3a94~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp) å’±ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ä»£ç å§ï¼š

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        func(this.resolve.bind(this), this.reject.bind(this));
    }
    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
        }
    }
    reject(reason) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECTED;
            this.PromiseResult = reason;
        }
    }
}


// æµ‹è¯•ä»£ç 
let promise1 = new myPromise((resolve, reject) => {
    resolve('è¿™æ¬¡ä¸€å®š');
})
console.log(promise1); 
// myPromise {PromiseState: 'fulfilled', PromiseResult: 'è¿™æ¬¡ä¸€å®š'}
let promise2 = new myPromise((resolve, reject) => {
    reject('ä¸‹æ¬¡ä¸€å®š');
})
console.log(promise2); 
// myPromise {PromiseState: 'rejected', PromiseResult: 'ä¸‹æ¬¡ä¸€å®š'}
å¤åˆ¶ä»£ç 
```

ä¸Šé¢æ˜¯æˆ‘ä»¬æ‰‹å†™çš„ `myPromise`çš„æ‰§è¡Œæƒ…å†µï¼Œçœ‹çœ‹åŸç”ŸPromiseçš„æ‰§è¡Œæƒ…å†µï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/816ff5396d424f96ad4ce694b6a6c910~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

è¯´æ˜æ‰§è¡Œç»“æœç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œæ˜¯ä¸æ˜¯è§‰å¾—ç¦»æˆåŠŸåˆè¿›äº†ä¸€æ­¥å•¦~ ğŸ‘ğŸ‘ğŸ‘

é‚£ä¹ˆå¤§å®¶è§‰å¾—ä¸‹ä¸€æ­¥æˆ‘ä»¬è¦åšä»€ä¹ˆï¼Ÿæ˜¯ä¸æ˜¯å¾ˆå¤šåŒå­¦è§‰å¾—éœ€è¦å†™`then`äº†ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬å°±å…ˆæ¥æ»¡è¶³æƒ³è¦å†™`then`çš„åŒå­¦ä»¬~

# ä¸‰ã€å®ç° then æ–¹æ³•

**å› ä¸º`then`æ˜¯åœ¨åˆ›å»ºå®ä¾‹åå†è¿›è¡Œè°ƒç”¨çš„ï¼Œå› æ­¤æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ª ç±»æ–¹æ³•ï¼Œå¯åƒä¸‡ä¸è¦åˆ›å»ºåœ¨ `constructor` é‡Œé¢äº†~** ğŸ˜›

æˆ‘æƒ³åº”è¯¥æœ‰äº›åŒå­¦çªç„¶å¤±å¿†ğŸ˜¶ï¼Œä¸è®°å¾—`then`æ€ä¹ˆç”¨äº†ï¼Œæˆ‘ä»¬å°±æ¥ç¨å¾®å†™ä¸€ä¸‹åŸç”Ÿçš„`then`æ–¹æ³•ï¼š

```javascript
let promise = new Promise((resolve, reject) => {
    resolve('è¿™æ¬¡ä¸€å®š')
})

+  promise.then(
+      result => {
+          console.log(result);
+      },
+      reason => {
+          console.log(reason.message);
+      }
+  )
å¤åˆ¶ä»£ç 
```

`then`æ–¹æ³•å¯ä»¥ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯å½“çŠ¶æ€ä¸º`fulfilled æˆåŠŸ` æ—¶æ‰§è¡Œçš„ä»£ç ï¼Œå¦ä¸€ä¸ªæ˜¯å½“çŠ¶æ€ä¸º `rejected æ‹’ç»` æ—¶æ‰§è¡Œçš„ä»£ç ã€‚

è™½ç„¶å¾ˆå¤šäººå¯èƒ½ä¸€ç›´åªç”¨ä¸€ä¸ªå‡½æ•°å‚æ•°ï¼Œä½†ä¸è¦å¿˜è®°è¿™é‡Œæ˜¯ä¸¤ä¸ªå‡½æ•°å‚æ•°ğŸ§ã€‚

å› æ­¤æˆ‘ä»¬å°±å¯ä»¥å…ˆç»™æ‰‹å†™çš„`then`é‡Œé¢æ·»åŠ  **ä¸¤ä¸ªå‚æ•°**ï¼š

- ä¸€ä¸ªæ˜¯ `onFulfilled` è¡¨ç¤º `â€œå½“çŠ¶æ€ä¸ºæˆåŠŸæ—¶â€`
- å¦ä¸€ä¸ªæ˜¯ `onRejected` è¡¨ç¤º `â€œå½“çŠ¶æ€ä¸ºæ‹’ç»æ—¶â€`

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        func(this.resolve.bind(this), this.reject.bind(this));
    }
    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
        }
    }
    reject(reason) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECTED;
            this.PromiseResult = reason;
        }
    }
+   then(onFulfilled, onRejected) {}
}
å¤åˆ¶ä»£ç 
```

## 1. çŠ¶æ€ä¸å¯å˜

è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹çœ‹`åŸç”Ÿ Promise` äº§ç”Ÿçš„ç»“æœï¼š

```javascript
let promise = new Promise((resolve, reject) => {
    resolve('è¿™æ¬¡ä¸€å®š')
    reject('ä¸‹æ¬¡ä¸€å®š')
})

promise.then(
    result => {
        console.log('fulfilled', result);
    },
    reason => {
        console.log('rejected', reason.message);
    }
)
å¤åˆ¶ä»£ç 
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89a7957b5ca14038bcff46ff8601aaf8~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å¯ä»¥çœ‹åˆ°æ§åˆ¶å°åªæ˜¾ç¤ºäº†ä¸€ä¸ª`console.log`çš„ç»“æœï¼Œ**è¯æ˜ `Promise` åªä¼šæ‰§è¡Œ`æˆåŠŸçŠ¶æ€` æˆ–è€… `æ‹’ç»çŠ¶æ€` çš„å…¶ä¸­ä¸€ä¸ª**

ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰æ–‡è®²åˆ°çš„ï¼Œ`Promise`  åªä»¥ `ç¬¬ä¸€æ¬¡ä¸ºå‡†`ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸå°±`æ°¸ä¹…`ä¸º`fulfilled`ï¼Œç¬¬ä¸€æ¬¡å¤±è´¥å°±`æ°¸è¿œ`çŠ¶æ€ä¸º`rejected`

å› æ­¤æˆ‘ä»¬åœ¨æ‰‹å†™çš„æ—¶å€™å°±å¿…é¡»è¿›è¡Œåˆ¤æ–­ ğŸ¤–ï¼š

â—¾ å¦‚æœå½“å‰å®ä¾‹çš„ `PromiseState` çŠ¶æ€å±æ€§ä¸º `fulfilled æˆåŠŸ ` çš„è¯ï¼Œæˆ‘ä»¬å°±æ‰§è¡Œä¼ è¿›æ¥çš„ `onFulfilled` å‡½æ•°ï¼Œå¹¶ä¸”ä¸º`onFulfilled`å‡½æ•°ä¼ å…¥å‰é¢ä¿ç•™çš„`PromiseResult`å±æ€§å€¼ï¼š

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        func(this.resolve.bind(this), this.reject.bind(this));
    }
    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
        }
    }
    reject(reason) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECTED;
            this.PromiseResult = reason;
        }
    }
    then(onFulfilled, onRejected) {
+       if (this.PromiseState === myProise.FULFILLED) {
+           onFulfilled(this.PromiseResult);
+       }
    }
}
å¤åˆ¶ä»£ç 
```

â—¾ å¦‚æœå½“å‰å®ä¾‹çš„ `PromiseState` çŠ¶æ€å±æ€§ä¸º `rejected æ‹’ç»` çš„è¯ï¼Œæˆ‘ä»¬å°±æ‰§è¡Œä¼ è¿›æ¥çš„ `onRejected` å‡½æ•°ï¼Œå¹¶ä¸”ä¸º`onRejected`å‡½æ•°ä¼ å…¥å‰é¢ä¿ç•™çš„`PromiseResult`å±æ€§å€¼ï¼š

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        func(this.resolve.bind(this), this.reject.bind(this));
    }
    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
        }
    }
    reject(reason) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECTED;
            this.PromiseResult = reason;
        }
    }
    then(onFulfilled, onRejected) {
        if (this.PromiseState === myProise.FULFILLED) {
            onFulfilled(this.PromiseResult);
        }
+       if (this.PromiseState === myPromise.REJECTED) {
+           onRejected(this.PromiseResult);
+       }
    }
}
å¤åˆ¶ä»£ç 
```

å®šä¹‰å¥½äº†åˆ¤æ–­æ¡ä»¶ä»¥åï¼Œæˆ‘ä»¬å°±æ¥æµ‹è¯•ä¸€ä¸‹ä»£ç ï¼Œä¹Ÿæ˜¯ä¸€æ ·ï¼Œåœ¨å®ä¾‹ ğŸŒ° ä¸Šä½¿ç”¨`then`æ–¹æ³•ï¼š

```javascript
class myPromise {
    ...
}


// æµ‹è¯•ä»£ç 
let promise1 = new myPromise((resolve, reject) => {
    resolve('è¿™æ¬¡ä¸€å®š');
+   reject('ä¸‹æ¬¡ä¸€å®š');
})
+   promise1.then(
+       result => {
+           console.log(result)
+       },
+       reason => {
+           console.log(reason.message)
+       }
+   )
å¤åˆ¶ä»£ç 
```

æ‰§è¡Œä¸Šé¢çš„æµ‹è¯•ä»£ç ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e174ad9029c648b49d71be4a809fbc89~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å¯ä»¥çœ‹åˆ°æ§åˆ¶å°åªæ˜¾ç¤ºäº†ä¸€ä¸ª`console.log`çš„ç»“æœï¼š`è¿™æ¬¡ä¸€å®š` ğŸ˜ï¼Œè¯æ˜æˆ‘ä»¬å·²ç»å®ç°äº† `promiseçš„çŠ¶æ€ä¸å¯å˜` ğŸ‘ğŸ‘ğŸ‘

å†™åˆ°è¿™é‡Œå¹¶æ²¡æœ‰æŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬`æš‚æ—¶å®‰å…¨`äº†ï¼Œä¸ºä»€ä¹ˆè¯´`æš‚æ—¶å®‰å…¨`å‘¢ï¼Ÿ

å› ä¸ºè¿™é‡Œè¿˜æœ‰å¾ˆå¤šæ²¡æœ‰å®Œå–„çš„åœ°æ–¹ï¼Œæ‰‹å†™Promiseçš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªéš¾ç‚¹å°±åœ¨äºæœ‰å¾ˆå¤šåœ°æ–¹éœ€è¦å’ŒåŸç”Ÿä¸€æ ·ä¸¥è°¨ï¼Œä¹Ÿå°±æ˜¯è¯´åŸç”Ÿçš„Promiseä¼šè€ƒè™‘å¾ˆå¤šç‰¹æ®Šæƒ…å†µ~

æˆ‘ä»¬åœ¨å®é™…è¿ç”¨æ—¶å¯èƒ½æš‚æ—¶ä¸ä¼šç¢°åˆ°è¿™äº›æƒ…å†µï¼Œå¯æ˜¯å½“æˆ‘ä»¬é‡åˆ°çš„æ—¶å€™ **å´ä¸çŸ¥åº•å±‚çš„åŸç†ï¼Œ`è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦çŸ¥é“å¦‚ä½•æ‰‹å†™Promise`**

æ¥ç€å†™ ğŸ’ª

## 2. æ‰§è¡Œå¼‚å¸¸ throw

åœ¨`new Promise`çš„æ—¶å€™ï¼Œæ‰§è¡Œå‡½æ•°é‡Œé¢å¦‚æœæŠ›å‡ºé”™è¯¯ï¼Œæ˜¯ä¼šè§¦å‘`then`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³`rejected`çŠ¶æ€çš„å›è°ƒå‡½æ•°

ä¹Ÿå°±æ˜¯åœ¨åŸç”Ÿçš„Promiseé‡Œé¢ï¼Œ`then`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³`rejected`çŠ¶æ€çš„å›è°ƒå‡½æ•°å¯ä»¥æŠŠé”™è¯¯çš„ä¿¡æ¯ä½œä¸ºå†…å®¹è¾“å‡ºå‡ºæ¥

åˆ°è¿™é‡Œï¼Œæœ‰çš„åŒå­¦å¯èƒ½ä¼šè¯´ï¼Œæ‰§è¡Œå¼‚å¸¸æŠ›é”™ï¼Œä¸æ˜¯ç”¨`catch()`æ–¹æ³•å»æ¥å—ï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œåˆè¯´ `æ˜¯ä¼šè§¦å‘thenæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³rejectedçŠ¶æ€çš„å›è°ƒå‡½æ•°`ï¼ŸğŸ˜µ

é‚£æˆ‘ä»¬å°±è¯´é“è¯´é“å§ğŸ§ï¼š

`catch()` æ–¹æ³•è¿”å›ä¸€ä¸ª`Promise`ï¼Œå¹¶ä¸”å¤„ç†æ‹’ç»çš„æƒ…å†µã€‚å®ƒçš„è¡Œä¸ºä¸è°ƒç”¨`Promise.prototype.then(undefined, onRejected)` ç›¸åŒã€‚

äº‹å®ä¸Š, calling `obj.catch(onRejected)` å†…éƒ¨calls `obj.then(undefined, onRejected)`ã€‚(è¿™å¥è¯çš„æ„æ€æ˜¯ï¼Œæˆ‘ä»¬æ˜¾å¼ä½¿ç”¨`obj.catch(onRejected)`ï¼Œå†…éƒ¨å®é™…è°ƒç”¨çš„æ˜¯`obj.then(undefined, onRejected)`)

`Promise.prototype.catch()`æ–¹æ³•æ˜¯`.then(null, rejection)`æˆ–`.then(undefined, rejection)`çš„åˆ«åï¼Œç”¨äºæŒ‡å®šå‘ç”Ÿé”™è¯¯æ—¶çš„å›è°ƒå‡½æ•°ã€‚

```javascript
p.then((val) => console.log('fulfilled:', val))
  .catch((err) => console.log('rejected', err));

// ç­‰åŒäº
p.then(
    null,
    err=> {console.log(err)}
) 

// ç­‰åŒäº
p.then((val) => console.log('fulfilled:', val))
  .then(null, (err) => console.log("rejected:", err));
å¤åˆ¶ä»£ç 
```

â—¾ æ³¨æ„çœ‹ä¸‹é¢çš„ä¾‹å­ ğŸŒ°ï¼š

```javascript
const promise = new Promise(function(resolve, reject) {
  throw new Error('test');
});
promise.catch(function(error) {
  console.log(error);
});
// Error: test
å¤åˆ¶ä»£ç 
```

ä¸Šé¢ä»£ç ä¸­ï¼ŒpromiseæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå°±è¢«`catch()`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°æ•è·ã€‚æ³¨æ„ï¼Œä¸Šé¢çš„å†™æ³•ä¸ä¸‹é¢ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„ã€‚

```javascript
// å†™æ³•ä¸€
const promise = new Promise(function(resolve, reject) {
  try {
    throw new Error('test');
  } catch(e) {
    reject(e);
  }
});
promise.catch(function(error) {
  console.log(error);
});
// å†™æ³•äºŒ
const promise = new Promise(function(resolve, reject) {
  reject(new Error('test'));
});
promise.catch(function(error) {
  console.log(error);
});
å¤åˆ¶ä»£ç 
```

æ¯”è¾ƒä¸Šé¢ä¸¤ç§å†™æ³•ï¼Œå¯ä»¥å‘ç°`reject()`æ–¹æ³•çš„ä½œç”¨ï¼Œç­‰åŒäºæŠ›å‡ºé”™è¯¯ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬æ‰‹å†™Promiseå°±æ˜¯ç”¨`try/catch`æ¥å¤„ç†å¼‚å¸¸ï¼Œç”¨çš„å°±æ˜¯ä¸Šé¢çš„æ€æƒ³ã€‚

â—¾ **ä¸€èˆ¬æ¥è¯´ï¼Œä¸è¦åœ¨`then()`æ–¹æ³•é‡Œé¢å®šä¹‰ Reject çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ˆå³`then`çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œæ€»æ˜¯ä½¿ç”¨`catch`æ–¹æ³•ã€‚**

```javascript
// bad
promise
  .then(function(data) {
    // success
  }, function(err) {
    // error
  });
  
// good
promise
  .then(function(data) { //cb
    // success
  })
  .catch(function(err) {
    // error
  });
å¤åˆ¶ä»£ç 
```

ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒç§å†™æ³•è¦å¥½äºç¬¬ä¸€ç§å†™æ³•ï¼Œç†ç”±æ˜¯ç¬¬äºŒç§å†™æ³•å¯ä»¥æ•è·å‰é¢`then`æ–¹æ³•æ‰§è¡Œä¸­çš„é”™è¯¯ï¼Œä¹Ÿæ›´æ¥è¿‘åŒæ­¥çš„å†™æ³•ï¼ˆ`try/catch`ï¼‰ã€‚å› æ­¤ï¼Œå»ºè®®æ€»æ˜¯ä½¿ç”¨`catch()`æ–¹æ³•ï¼Œè€Œä¸ä½¿ç”¨`then()`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚

**å›åˆ°æ­£é¢˜**

åŸç”ŸPromiseåœ¨`new Promise`çš„æ—¶å€™ï¼Œæ‰§è¡Œå‡½æ•°é‡Œé¢å¦‚æœæŠ›å‡ºé”™è¯¯ï¼Œæ˜¯ä¼šè§¦å‘`then`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•° `(å³rejectedçŠ¶æ€çš„å›è°ƒå‡½æ•°)`ï¼ŒæŠŠé”™è¯¯çš„ä¿¡æ¯ä½œä¸ºå†…å®¹è¾“å‡ºå‡ºæ¥:

```javascript
let promise = new Promise((resolve, reject) => {
    throw new Error('ç™½å«–ä¸æˆåŠŸ');
})

promise.then(
    result => {
        console.log('fulfiiled:', result)
    },
    reason => {
        console.log('rejected:', reason)
    }
)
å¤åˆ¶ä»£ç 
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4afbee05224a4eb99674007130dabf24~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨æ‰‹å†™è¿™è¾¹å†™ä¸ŠåŒæ ·é“ç†çš„æµ‹è¯•ä»£ç ï¼Œå¾ˆå¤šäººå°±ä¼šå¿½ç•¥è¿™ä¸ªç»†èŠ‚ğŸ˜¥ï¼š

```javascript
class myPromise {
    ...
}


// æµ‹è¯•ä»£ç 
let promise1 = new myPromise((resolve, reject) => {
+   throw new Error('ç™½å«–ä¸æˆåŠŸ');
})
promise1.then(
+   result => {
+       console.log('fulfiiled:', result)
+   },
+   reason => {
+       console.log('rejected:', reason)
+   }
)
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬çœ‹çœ‹æ§åˆ¶å°

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/315d46ffbd8b4a9cb4959ad4437e43b3~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

> `Uncaught`  æœªæ•è·

å¯ä»¥å‘ç°æŠ¥é”™äº†ğŸ˜°ï¼Œæ²¡æœ‰æ•è·åˆ°é”™è¯¯ï¼Œæ²¡æœ‰æŠŠå†…å®¹è¾“å‡ºå‡ºæ¥

â—¾ æˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œ`resolve()`å’Œ`reject()`ä¹‹å‰ç”¨`try/catch`è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨`æ„é€ å‡½æ•° constructor`é‡Œé¢å®Œå–„ä»£ç ï¼Œåˆ¤æ–­ç”Ÿæˆå®ä¾‹çš„æ—¶å€™æ˜¯å¦æœ‰æŠ¥é”™ ğŸ”ï¼š

- å¦‚æœæ²¡æœ‰æŠ¥é”™çš„è¯ï¼Œå°±æŒ‰ç…§æ­£å¸¸æ‰§è¡Œ`resolve()`å’Œ`reject()`æ–¹æ³•
- å¦‚æœæŠ¥é”™çš„è¯ï¼Œå°±æŠŠé”™è¯¯ä¿¡æ¯ä¼ å…¥ç»™`reject()`æ–¹æ³•ï¼Œå¹¶ä¸”ç›´æ¥æ‰§è¡Œ`reject()`æ–¹æ³•

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
+       try {
            func(this.resolve.bind(this), this.reject.bind(this));
+       } catch (error) {
+           this.reject(error)
+       }
    }
    resolve(result) {
        ...
    }
    reject(reason) {
        ...
    }
    then(onFulfilled, onRejected) {
        ...
    }
}
å¤åˆ¶ä»£ç 
```

â—¾ **æ³¨æ„è¿™é‡Œä¸éœ€è¦ç»™`reject()`æ–¹æ³•è¿›è¡Œ`this`çš„ç»‘å®šäº†ï¼Œå› ä¸ºè¿™é‡Œæ˜¯ç›´æ¥æ‰§è¡Œï¼Œè€Œä¸æ˜¯åˆ›å»ºå®ä¾‹åå†æ‰§è¡Œã€‚**

â–ª `func(this.resolve.bind(this), this.reject.bind(this));` è¿™é‡Œçš„`this.reject`æ„æ€æ˜¯ï¼šæŠŠç±»æ–¹æ³•`reject()`ä½œä¸ºå‚æ•° ä¼ åˆ°æ„é€ å‡½æ•°`constructor` é‡Œè¦æ‰§è¡Œçš„`func()`æ–¹æ³•é‡Œï¼Œåªæ˜¯ä¸€ä¸ªå‚æ•°ï¼Œå¹¶ä¸æ‰§è¡Œï¼Œåªæœ‰åˆ›å»ºå®ä¾‹åè°ƒç”¨`reject()`æ–¹æ³•çš„æ—¶å€™æ‰æ‰§è¡Œï¼Œæ­¤æ—¶`this`çš„æŒ‡å‘å·²ç»å˜äº†ï¼Œæ‰€ä»¥æƒ³è¦æ­£ç¡®è°ƒç”¨`myPromise`çš„`reject()`æ–¹æ³•å°±è¦é€šè¿‡`.bind(this))`æ”¹å˜`this`æŒ‡å‘ã€‚

â–ª `this.reject(error)`ï¼Œè¿™é‡Œçš„`this.reject()`ï¼Œæ˜¯ç›´æ¥åœ¨æ„é€ å‡½æ•°é‡Œæ‰§è¡Œç±»æ–¹æ³•ï¼Œ`this`æŒ‡å‘ä¸å˜ï¼Œ`this.reject()`å°±æ˜¯ç›´æ¥è°ƒç”¨ç±»æ–¹æ³•`reject()`ï¼Œæ‰€ä»¥ä¸ç”¨å†è¿›è¡Œ`this`ç»‘å®šã€‚

â—¾ è¿™é‡Œè€ƒå¯Ÿäº†`this`ç»‘å®šçš„ä¸€ä¸ªç»†èŠ‚ğŸ”ï¼š

`call`ã€`apply`å’Œ`bind`éƒ½å¯ä»¥æ”¹å˜å‡½æ•°ä½“å†…éƒ¨ this çš„æŒ‡å‘ï¼Œ**ä½†æ˜¯ `bind` å’Œ `call/apply` æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åŒºåˆ«ï¼šä¸€ä¸ªå‡½æ•°è¢« `call/apply` çš„æ—¶å€™ï¼Œä¼šç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œä½†æ˜¯ `bind` ä¼šåˆ›å»ºä¸€ä¸ªæ–°å‡½æ•°ï¼Œä¸ä¼šç«‹å³æ‰§è¡Œã€‚**

è¿™å°±æ˜¯å‰é¢ä¸ºä»€ä¹ˆè¯´ï¼Œ` this.reject.bind(this)`åªæ˜¯ä½œä¸ºå‚æ•°ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æ‰§è¡Œçš„åŸå› äº†~ğŸ˜€

**å›åˆ°æ­£æ–‡**

ç»“åˆå‰é¢çš„è®²è§£ï¼Œåˆ·æ–°ä¸€ä¸‹æ§åˆ¶å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰‹å†™è¿™è¾¹å·²ç»æ²¡æœ‰æŠ¥é”™äº†ğŸ‘ğŸ‘ğŸ‘: ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f4ccf8aaeace432dbe5c9879d2f65ff8~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

## 3. å‚æ•°æ ¡éªŒ

å¤§å®¶è§‰å¾—ç›®å‰ä»£ç æ˜¯ä¸æ˜¯æ²¡é—®é¢˜äº†ï¼Ÿå¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥äº†ï¼Ÿ

å¦‚æœä½ è§‰å¾—æ˜¯çš„è¯å°±åˆæ‰å‘äº†~ğŸ¦

åŸç”ŸPromiseé‡Œ**è§„å®š`then`æ–¹æ³•é‡Œé¢çš„ä¸¤ä¸ªå‚æ•°å¦‚æœä¸æ˜¯å‡½æ•°çš„è¯å°±è¦è¢«å¿½ç•¥**ï¼Œæˆ‘ä»¬å°±æ•…æ„åœ¨åŸç”Ÿä»£ç è¿™é‡Œä¸ä¼ å…¥å‡½æ•°ä½œä¸ºå‚æ•°ï¼š

```javascript
let promise = new Promise((resolve, reject) => {
    throw new Error('ç™½å«–ä¸æˆåŠŸ');
})

promise.then(
    undefined,
    reason => {
        console.log('rejected:', reason)
    }
)
å¤åˆ¶ä»£ç 
```

è¿è¡Œä»¥åæˆ‘ä»¬å‘ç°åœ¨è¿™é‡Œæ‰§è¡Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2bea1e40f6cf4b86abb33233196791b4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

æˆ‘ä»¬å†ä»¥åŒæ ·ç±»ä¼¼çš„ä¸ä¼  **å‡½æ•°å‚æ•°** çš„ä»£ç åº”ç”¨åœ¨ **æ‰‹å†™ä»£ç ** ä¸Šé¢ï¼š

```javascript
class myPromise {
	...
}

let promise1 = new myPromise((resolve, reject) => {
    resolve('è¿™æ¬¡ä¸€å®š');
})

promise1.then(
    undefined,
    reason => {
        console.log('rejected:', reason)
    }
)
å¤åˆ¶ä»£ç 
```

å¤§å®¶æƒ³æƒ³ä¼šä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿæ¥çœ‹çœ‹ç»“æœä¼šæ€æ ·ï¼ŸğŸ§

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/840804fc6bab4c71b95f75d9c99f1de3~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ç»“æœå°±æ˜¯ `Uncaught TypeError: onFulfilled is not a function`ã€‚æµè§ˆå™¨å¸®ä½ æŠ¥é”™äº†ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„~ğŸ˜¥

æˆ‘ä»¬åªæƒ³è¦è‡ªå·±æ¥æŠ›å‡ºé”™è¯¯ï¼Œå†æ¥çœ‹çœ‹åˆšåˆšçš„æ‰‹å†™`then`éƒ¨åˆ†ï¼š

```javascript
then(onFulfilled, onRejected) {
    if (this.PromiseState === myPromise.FULFILLED) {
        onFulfilled(this.PromiseResult);
    }
    if (this.PromiseState === myPromise.REJECTED) {
        onRejected(this.PromiseResult);
    }
}
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬ä¼šåœ¨é‡Œé¢åˆ†åˆ«æ‰§è¡ŒæˆåŠŸå’Œæ‹’ç»ä¸¤ä¸ªå‚æ•°ï¼Œå¯æ˜¯æˆ‘ä»¬ä¸æƒ³ä¿®æ”¹è¿™é‡Œçš„ä»£ç ï¼Œé‚£ä¹ˆå°±åªèƒ½æŠŠä¸æ˜¯å‡½æ•°çš„å‚æ•°æ”¹ä¸ºå‡½æ•°

**`Promise` è§„èŒƒå¦‚æœ `onFulfilled` å’Œ `onRejected` ä¸æ˜¯å‡½æ•°ï¼Œå°±å¿½ç•¥ä»–ä»¬**ã€‚æ‰€è°“â€œå¿½ç•¥â€å¹¶ä¸æ˜¯ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œå¯¹äº`onFulfilled`æ¥è¯´â€œå¿½ç•¥â€å°±æ˜¯å°†`value`åŸå°ä¸åŠ¨çš„è¿”å›ï¼Œå¯¹äº`onRejected`æ¥è¯´å°±æ˜¯è¿”å›`reason`ï¼Œ`onRejected`å› ä¸ºæ˜¯é”™è¯¯åˆ†æ”¯ï¼Œæˆ‘ä»¬è¿”å›`reason`åº”è¯¥`throw`ä¸€ä¸ª`Error`:

è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ `æ¡ä»¶è¿ç®—ç¬¦`ï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œ`if`åˆ¤æ–­ä¹‹å‰è¿›è¡Œé¢„å…ˆåˆ¤æ–­ï¼š

â–ª å¦‚æœ`onFulfilled`å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æŠŠåŸæ¥çš„`onFulfilled`å†…å®¹é‡æ–°èµ‹å€¼ç»™å®ƒï¼Œå¦‚æœ`onFulfilled`å‚æ•°ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±å°†`value`åŸå°ä¸åŠ¨çš„è¿”å›

```javascript
class myPromise {
	...
    then(onFulfilled, onRejected) {
+       onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        if (this.PromiseState === myPromise.FULFILLED) {
            onFulfilled(this.PromiseResult);
        }
        if (this.PromiseState === myPromise.REJECTED) {
            onRejected(this.PromiseResult);
        }
    }
}
å¤åˆ¶ä»£ç 
```

â–ª å¦‚æœ`onRejected`å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æŠŠåŸæ¥çš„`onRejected`å†…å®¹é‡æ–°èµ‹å€¼ç»™å®ƒï¼Œå¦‚æœ`onRejected`å‚æ•°ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±`throw`ä¸€ä¸ª`Error`

```javascript
class myPromise {
	...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
+       onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };
        if (this.PromiseState === myPromise.FULFILLED) {
            onFulfilled(this.PromiseResult);
        }
        if (this.PromiseState === myPromise.REJECTED) {
            onRejected(this.PromiseResult);
        }
    }
}
å¤åˆ¶ä»£ç 
```

ç°åœ¨æˆ‘ä»¬å†æ¥æµ‹è¯•ä¸€ä¸‹ä»£ç ï¼š

```javascript
class myPromise {
	...
}

let promise1 = new myPromise((resolve, reject) => {
    resolve('è¿™æ¬¡ä¸€å®š');
})
promise1.then(
    undefined,
    reason => {
        console.log('rejected:', reason)
    }
)
å¤åˆ¶ä»£ç 
```

æŸ¥çœ‹æ§åˆ¶å°ï¼Œå‘ç°æ²¡æœ‰æŠ¥é”™äº†ğŸ‘ğŸ‘ğŸ‘ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d831063ec55e424691019c6039fa4fd2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**å½“å‰å®ç°çš„å®Œæ•´ä»£ç ï¼š**

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        try {
            func(this.resolve.bind(this), this.reject.bind(this));
        } catch (error) {
            this.reject(error)
        }
    }
    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
        }
    }
    reject(reason) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECTED;
            this.PromiseResult = reason;
        }
    }
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };
        if (this.PromiseState === myPromise.FULFILLED) {
            onFulfilled(this.PromiseResult);
        }
        if (this.PromiseState === myPromise.REJECTED) {
            onRejected(this.PromiseResult);
        }
    }
}
å¤åˆ¶ä»£ç 
```

# å››ã€å®ç°å¼‚æ­¥

## 1. æ·»åŠ å®šæ—¶å™¨

åœ¨å¯¹ä»£ç è¿›è¡Œä¸€äº›åŸºæœ¬ä¿®è¡¥ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥è¿›è¡Œä¸‹ä¸€ä¸ªå¤§åŠŸèƒ½äº†ï¼Œä¹Ÿå°±æ˜¯Promiseçš„ **å¼‚æ­¥åŠŸèƒ½** âœ¨ã€‚

å¯ä»¥è¯´æˆ‘ä»¬åœ¨æ‰‹å†™çš„ä»£ç é‡Œé¢ä¾æ—§æ²¡æœ‰æ¤å…¥å¼‚æ­¥åŠŸèƒ½ï¼Œæ¯•ç«Ÿæœ€åŸºæœ¬çš„`setTimeout`æˆ‘ä»¬éƒ½æ²¡æœ‰ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»å…ˆäº†è§£ä¸€ä¸‹åŸç”ŸPromiseçš„ä¸€äº›`è¿è¡Œé¡ºåºè§„åˆ™`ã€‚

åœ¨è¿™é‡Œæˆ‘ä¸ºåŸç”Ÿä»£ç æ·»åŠ ä¸Šæ­¥éª¤ä¿¡æ¯ï¼š

```javascript
console.log(1);

let promise = new Promise((resolve, reject) => {
    console.log(2);
    resolve('è¿™æ¬¡ä¸€å®š');
})

promise.then(
    result => {
        console.log('fulfilled:', result);
    },
    reason => {
        console.log('rejected:', reason)
    }
)

console.log(3);
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬é…åˆè¿™æ®µåŸç”ŸPromiseä»£ç ï¼Œç»“åˆæ§åˆ¶å°ä¸€èµ·çœ‹çœ‹

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39fcb5dff169440985ce764c281c3b8c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

è¾“å‡ºé¡ºåºä¸ºï¼š

```javascript
1
2
3
fulfilled: è¿™æ¬¡ä¸€å®š
å¤åˆ¶ä»£ç 
```

- é¦–å…ˆæ‰§è¡Œ`console.log(1)`ï¼Œè¾“å‡º`1`
- æ¥ç€åˆ›å»º`promiseå®ä¾‹`ï¼Œè¾“å‡º`2`ï¼Œå› ä¸ºè¿™é‡Œä¾æ—§æ˜¯åŒæ­¥
- ç„¶åç¢°åˆ°`resolve`çš„æ—¶å€™ï¼Œä¿®æ”¹ç»“æœå€¼
- åˆ°äº†`promise.then`ä¼šè¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ **éœ€è¦å…ˆæŠŠæ‰§è¡Œæ ˆçš„å†…å®¹æ¸…ç©º**ï¼Œäºæ˜¯å°±æ‰§è¡Œ`console.log(3)`ï¼Œè¾“å‡º`3`
- æ¥ç€æ‰ä¼šæ‰§è¡Œ`promise.then`é‡Œé¢çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æœ€åè¾“å‡º`â€œfulfilled: è¿™æ¬¡ä¸€å®šâ€`

â–ª æˆ‘ä»¬ç”¨åŒæ ·çš„æµ‹è¯•ä»£ç åº”ç”¨åœ¨ **æ‰‹å†™ä»£ç ** ä¸Šé¢ï¼š

```javascript
class myPromise {
	...
}

// æµ‹è¯•ä»£ç 
console.log(1);
let promise1 = new myPromise((resolve, reject) => {
    console.log(2);
    resolve('è¿™æ¬¡ä¸€å®š');
})
promise1.then(
    result => {
        console.log('fulfilled:', result);
    },
    reason => {
        console.log('rejected:', reason)
    }
)
console.log(3);
å¤åˆ¶ä»£ç 
```

è¿™æ¬¡æˆ‘ä»¬å‘ç°æœ‰äº›ä¸åŒäº†ğŸ˜¯ï¼Œè¾“å‡ºé¡ºåºä¸ºï¼š

```javascript
1
2
fulfilled: è¿™æ¬¡ä¸€å®š
3
å¤åˆ¶ä»£ç 
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/da97821d707844529e81ee0882071271~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

`1` å’Œ `2` éƒ½æ²¡æœ‰é—®é¢˜ï¼Œé—®é¢˜å°±æ˜¯`â€œfulfilled: è¿™æ¬¡ä¸€å®šâ€`å’Œ`3`è¿™é‡Œçš„é¡ºåºä¸å¯¹

â—¾ å…¶å®é—®é¢˜å¾ˆç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬åˆšåˆšè¯´çš„ **æ²¡æœ‰è®¾ç½®å¼‚æ­¥æ‰§è¡Œ** ğŸ˜¶

æˆ‘ä»¬äºŒè¯ä¸è¯´ç›´æ¥ç»™`then`æ–¹æ³•é‡Œé¢æ·»åŠ `setTimeout`å°±å¯ä»¥äº†ğŸ˜ï¼Œ**éœ€è¦åœ¨è¿›è¡Œ`if`åˆ¤æ–­ä»¥åå†æ·»åŠ `setTimeout`ï¼Œè¦ä¸ç„¶çŠ¶æ€ä¸ç¬¦åˆæ·»åŠ å¼‚æ­¥ä¹Ÿæ˜¯æ²¡æœ‰æ„ä¹‰çš„**ï¼Œç„¶ååœ¨`setTimeout`é‡Œæ‰§è¡Œä¼ å…¥çš„å‡½æ•°å‚æ•°ï¼š

```javascript
class myPromise {
	...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };
        if (this.PromiseState === myPromise.FULFILLED) {
+           setTimeout(() => {
                onFulfilled(this.PromiseResult);
+           });
        }
        if (this.PromiseState === myPromise.REJECTED) {
+           setTimeout(() => {
                onRejected(this.PromiseResult);
+           });
        }
    }
}
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬ä½¿ç”¨å‰é¢çš„ç”¨ä¾‹é‡æ–°æµ‹è¯•ä¸€ä¸‹ä»£ç ï¼š

```javascript
class myPromise {
	...
}

// æµ‹è¯•ä»£ç 
console.log(1);
let promise1 = new myPromise((resolve, reject) => {
    console.log(2);
    resolve('è¿™æ¬¡ä¸€å®š');
})
promise1.then(
    result => {
        console.log('fulfilled:', result);
    },
    reason => {
        console.log('rejected:', reason)
    }
)
console.log(3);
å¤åˆ¶ä»£ç 
```

è¾“å‡ºé¡ºåºä¸º:

```javascript
1
2
3
fulfilled: è¿™æ¬¡ä¸€å®š
å¤åˆ¶ä»£ç 
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/937722da9c724fbea2a732000aeb8911~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

è¿™æ¬¡çš„é¡ºåºå°±æ¯”è¾ƒé¡ºçœ¼äº†~ğŸ‘ğŸ‘ğŸ‘

**åœ¨è¿™é‡Œæˆ‘ä»¬è§£å†³å¼‚æ­¥çš„æ–¹æ³•æ˜¯ç»™`onFulfilled`å’Œ`onRejected`æ·»åŠ `setTimeout`ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿ**

â—¾ è¿™å°±è¦è®²åˆ°  [**`Promises/A+` è§„èŒƒ**](https://link.juejin.cn?target=https%3A%2F%2Fpromisesaplus.com%2F%23notes)  äº†

è§„èŒƒ `2.2.4`  ï¼š

> `onFulfilled` or `onRejected` must not be called until the `execution context` stack contains only platform code. [3.1].

è¯‘æ–‡ï¼š

2.2.4 `onFulfilled` å’Œ `onRejected` åªæœ‰åœ¨`æ‰§è¡Œç¯å¢ƒ`å †æ ˆä»…åŒ…å«å¹³å°ä»£ç æ—¶æ‰å¯è¢«è°ƒç”¨ `æ³¨1`

è§„èŒƒå¯¹2.2.4åšäº†æ³¨é‡Šï¼š

> 3.1 Here â€œplatform codeâ€ means engine, environment, and promise implementation code. In practice, this requirement ensures that `onFulfilled` and `onRejected` execute asynchronously, after the event loop turn in which `then` is called, and with a fresh stack. This can be implemented with either a â€œmacro-taskâ€ mechanism such as setTimeout or `setImmediate`, or with a â€œmicro-taskâ€ mechanism such as MutationObserver or process.nextTick. Since the promise implementation is considered platform code, it may itself contain a task-scheduling queue or â€œtrampolineâ€ in which the handlers are called.

è¯‘æ–‡ï¼š

**3.1 è¿™é‡Œçš„å¹³å°ä»£ç æŒ‡çš„æ˜¯å¼•æ“ã€ç¯å¢ƒä»¥åŠ promise çš„å®æ–½ä»£ç ã€‚å®è·µä¸­è¦ç¡®ä¿ `onFulfilled` å’Œ `onRejected` æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ `then` æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚è¿™ä¸ªäº‹ä»¶é˜Ÿåˆ—å¯ä»¥é‡‡ç”¨â€œå®ä»»åŠ¡ï¼ˆmacro-taskï¼‰â€æœºåˆ¶ï¼Œæ¯”å¦‚`setTimeout` æˆ–è€… `setImmediate`ï¼› ä¹Ÿå¯ä»¥é‡‡ç”¨â€œå¾®ä»»åŠ¡ï¼ˆmicro-taskï¼‰â€æœºåˆ¶æ¥å®ç°ï¼Œ æ¯”å¦‚ `MutationObserver` æˆ–è€…`process.nextTick`ã€‚** ç”±äº promise çš„å®æ–½ä»£ç æœ¬èº«å°±æ˜¯å¹³å°ä»£ç ï¼ˆè¯‘è€…æ³¨ï¼š å³éƒ½æ˜¯ JavaScriptï¼‰ï¼Œæ•…ä»£ç è‡ªèº«åœ¨å¤„ç†åœ¨å¤„ç†ç¨‹åºæ—¶å¯èƒ½å·²ç»åŒ…å«ä¸€ä¸ªä»»åŠ¡è°ƒåº¦é˜Ÿåˆ—æˆ–ã€è·³æ¿ã€)ã€‚

**è¿™é‡Œæˆ‘ä»¬ç”¨çš„å°±æ˜¯è§„èŒƒé‡Œè®²åˆ°çš„ â€œå®ä»»åŠ¡â€ `setTimeout`**ã€‚

## 2. å›è°ƒä¿å­˜

å¼‚æ­¥çš„é—®é¢˜çœŸçš„è§£å†³äº†å—ï¼Ÿç°åœ¨åˆè¦è¿›å…¥Promiseå¦ä¸€ä¸ªéš¾ç‚¹äº†ï¼Œå¤§å®¶åŠ¡å¿…ç«–èµ·è€³æœµå•¦ğŸ˜›

æˆ‘ä»¬æ¥ç»™åŸç”Ÿçš„Promiseé‡Œæ·»åŠ `setTimeout`ï¼Œä½¿å¾—`resolve`ä¹Ÿå¼‚æ­¥æ‰§è¡Œï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜äº†ï¼Œ`resolve`æ˜¯å¼‚æ­¥çš„ï¼Œ`then`ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œç©¶ç«Ÿè°ä¼šå…ˆè¢«è°ƒç”¨å‘¢ï¼Ÿ

```javascript
console.log(1);
let promise = new Promise((resolve, reject) => {
    console.log(2);
+   setTimeout(() => {
        resolve('è¿™æ¬¡ä¸€å®š');
+       console.log(4);
+   });
})
promise.then(
    result => {
        console.log('fulfilled:', result);
    },
    reason => {
        console.log('rejected:', reason)
    }
)
console.log(3);
å¤åˆ¶ä»£ç 
```

è¾“å‡ºé¡ºåºä¸ºï¼š

```javascript
1
2
3
4
fulfilled: è¿™æ¬¡ä¸€å®š
å¤åˆ¶ä»£ç 
```

ç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯å½“é‡åˆ°`setTimeout`çš„æ—¶å€™è¢«å¼‚æ­¥æ‰§è¡Œäº†ï¼Œè€Œ`resolve('è¿™æ¬¡ä¸€å®š')`æ²¡æœ‰è¢«é©¬ä¸Šæ‰§è¡Œï¼Œè€Œæ˜¯å…ˆæ‰§è¡Œ`console.log(4)`ï¼Œç­‰åˆ°`then`çš„æ—¶å€™å†æ‰§è¡Œ`resolve`é‡Œä¿å­˜çš„å€¼ã€‚

è¿™é‡Œæ¶‰åŠåˆ°äº†æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯ï¼Œ`promise.then()` å’Œ `setTimeout()` éƒ½æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Œä½†å®é™…ä¸Šå¼‚æ­¥ä»»åŠ¡ä¹‹é—´å¹¶ä¸ç›¸åŒï¼Œå› æ­¤ä»–ä»¬çš„æ‰§è¡Œä¼˜å…ˆçº§ä¹Ÿæœ‰åŒºåˆ«ã€‚ä¸åŒçš„å¼‚æ­¥ä»»åŠ¡è¢«åˆ†ä¸ºä¸¤ç±»ï¼š`å¾®ä»»åŠ¡ (micro task)` å’Œ `å®ä»»åŠ¡ (macro task`)ã€‚

- `setTimeout()`å±äºå®ä»»åŠ¡
- `promise.then()`å±äºå¾®ä»»åŠ¡

åœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ï¼Œå¼‚æ­¥äº‹ä»¶è¿”å›ç»“æœåä¼šè¢«æ”¾åˆ°ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚ç„¶è€Œï¼Œæ ¹æ®è¿™ä¸ªå¼‚æ­¥äº‹ä»¶çš„ç±»å‹ï¼Œè¿™ä¸ªäº‹ä»¶å®é™…ä¸Šä¼šè¢«å¯¹åº”çš„å®ä»»åŠ¡é˜Ÿåˆ—æˆ–è€…å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­å»ã€‚å¹¶ä¸”åœ¨å½“å‰æ‰§è¡Œæ ˆä¸ºç©ºçš„æ—¶å€™ï¼Œä¸»çº¿ç¨‹ä¼š æŸ¥çœ‹å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœ‰äº‹ä»¶å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå†å»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶å¹¶æŠŠå¯¹åº”çš„å›åˆ°åŠ å…¥å½“å‰æ‰§è¡Œæ ˆï¼›å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼šä¾æ¬¡æ‰§è¡Œé˜Ÿåˆ—ä¸­äº‹ä»¶å¯¹åº”çš„å›è°ƒï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œç„¶åå»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºæœ€å‰é¢çš„ä¸€ä¸ªäº‹ä»¶ï¼ŒæŠŠå¯¹åº”çš„å›è°ƒåŠ å…¥å½“å‰æ‰§è¡Œæ ˆâ€¦å¦‚æ­¤åå¤ï¼Œè¿›å…¥å¾ªç¯ã€‚

æˆ‘ä»¬åªéœ€è®°ä½ **å½“ å½“å‰æ‰§è¡Œæ ˆæ‰§è¡Œå®Œæ¯•æ—¶ä¼šç«‹åˆ»å…ˆå¤„ç†æ‰€æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼Œç„¶åå†å»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶ã€‚åŒä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¾®ä»»åŠ¡æ°¸è¿œåœ¨å®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œã€‚**

> ğŸ” å¦‚æœæƒ³è¦å­¦ä¹ äº‹ä»¶å¾ªç¯ã€å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[JavaScript æ·±å…¥ç³»åˆ—ä¹‹å®ä»»åŠ¡ã€å¾®ä»»åŠ¡å’Œäº‹ä»¶å¾ªç¯ Event Loop](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyuanyuanbyte%2FBlog%2Fissues%2F92)

**å›åˆ°æ­£æ–‡**

æˆ‘ä»¬ç”¨åŒæ ·çš„ä»£ç åº”ç”¨åˆ°æ‰‹å†™çš„éƒ¨åˆ†ï¼š

```javascript
class myPromise {
	...
}

// æµ‹è¯•ä»£ç 
console.log(1);
let promise1 = new myPromise((resolve, reject) => {
    console.log(2);
    setTimeout(() => {
        resolve('è¿™æ¬¡ä¸€å®š');
        console.log(4);
    });
})
promise1.then(
    result => {
        console.log('fulfilled:', result);
    },
    reason => {
        console.log('rejected:', reason)
    }
)
console.log(3);
å¤åˆ¶ä»£ç 
```

æ§åˆ¶å°è¾“å‡ºï¼š

```javascript
1
2
3
4
å¤åˆ¶ä»£ç 
```

å¯ä»¥å‘ç° `fulfilled: è¿™æ¬¡ä¸€å®š` å¹¶æ²¡æœ‰è¾“å‡º

æˆ‘ä»¬å¯ä»¥å…ˆçŒœæµ‹ä¸€ä¸‹ï¼Œæ²¡æœ‰è¾“å‡ºçš„åŸå› å¾ˆå¯èƒ½æ˜¯å› ä¸º`then`æ–¹æ³•æ²¡æœ‰è¢«æ‰§è¡Œï¼Œçœ‹çœ‹`then`æ–¹æ³•é‡Œé¢æ˜¯æ ¹æ®æ¡ä»¶åˆ¤æ–­æ¥æ‰§è¡Œä»£ç çš„ï¼š

```javascript
class myPromise {
	...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };
        if (this.PromiseState === myPromise.FULFILLED) {
            setTimeout(() => {
                onFulfilled(this.PromiseResult);
            });
        }
        if (this.PromiseState === myPromise.REJECTED) {
            setTimeout(() => {
                onRejected(this.PromiseResult);
            });
        }
    }
}
å¤åˆ¶ä»£ç 
```

ä¹Ÿå°±æ˜¯è¯´å¾ˆå¯èƒ½æ²¡æœ‰ç¬¦åˆçš„æ¡ä»¶ï¼Œå†æ¢å¥è¯è¯´å¯èƒ½æ²¡æœ‰ç¬¦åˆçš„çŠ¶æ€

é‚£ä¹ˆæˆ‘ä»¬å°±åœ¨ä¸‰ä¸ªä½ç½®åˆ†åˆ«è¾“å‡ºå½“å‰çš„çŠ¶æ€ï¼Œè¿™æ ·åˆ†åˆ«æ¥åˆ¤æ–­å“ªä¸ªä½ç½®å‡ºäº†é—®é¢˜:

```javascript
class myPromise {
	...
}

// æµ‹è¯•ä»£ç 
console.log(1);
let promise1 = new myPromise((resolve, reject) => {
    console.log(2);
    setTimeout(() => {
+       console.log('A',promise1.PromiseState);
        resolve('è¿™æ¬¡ä¸€å®š');
+       console.log('B',promise1.PromiseState);
        console.log(4);
    });
})
promise1.then(
    result => {
+       console.log('C',promise1.PromiseState);
        console.log('fulfilled:', result);
    },
    reason => {
        console.log('rejected:', reason)
    }
)
console.log(3);
å¤åˆ¶ä»£ç 
```

è¾“å‡ºç»“æœä¸ºï¼š

```javascript
1
2
3
A pending
B fulfilled
4
å¤åˆ¶ä»£ç 
```

å‘ç°åªæœ‰ä¸¤ç»„çŠ¶æ€è¢«è¾“å‡ºï¼Œè¿™ä¸¤ç»„éƒ½åœ¨`console.log(4)`å‰è¢«è¾“å‡ºï¼Œè¯æ˜`setTimeout`é‡Œé¢çš„çŠ¶æ€éƒ½è¢«è¾“å‡ºäº†ï¼Œåªæœ‰`then`é‡Œé¢çš„çŠ¶æ€æ²¡æœ‰è¢«è¾“å‡º

è¿™åŸºæœ¬å°±å¯ä»¥ç¡®å®šæ˜¯å› ä¸º`then`é‡Œçš„çŠ¶æ€åˆ¤æ–­å‡ºäº†é—®é¢˜

è¿™é‡Œæ¶‰åŠåˆ°äº‹ä»¶å¾ªç¯ï¼Œæˆ‘ä»¬è¯¦ç»†è§£è¯»ä¸€ä¸‹ï¼š

â–ª **é¦–å…ˆ**ï¼Œæ‰§è¡Œ`console.log(1)`ï¼Œè¾“å‡º`1`

â–ª **ç¬¬äºŒæ­¥**ï¼Œåˆ›å»ºpromiseï¼Œæ‰§è¡Œå‡½æ•°ä½“é‡Œçš„`console.log(2)`ï¼Œè¾“å‡º`2`

â–ª **ç¬¬ä¸‰æ­¥**ï¼Œé‡åˆ°`setTimeout`ï¼Œ`setTimeout`æ˜¯å®ä»»åŠ¡ï¼Œå°†`setTimeout`åŠ å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ

â–ª **ç¬¬å››æ­¥**ï¼Œé‡åˆ°`promise.then()`ï¼Œ`promise.then()`æ˜¯å¾®ä»»åŠ¡ï¼Œå°†`promise.then()`åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ

â–ª **ç¬¬äº”æ­¥**ï¼Œæ‰§è¡Œ`console.log(3)`ï¼Œè¾“å‡º`3`ï¼Œæ­¤æ—¶å½“å‰æ‰§è¡Œæ ˆå·²ç»æ¸…ç©º

â–ª **ç¬¬å…­æ­¥**ï¼Œå½“å‰æ‰§è¡Œæ ˆå·²ç»æ¸…ç©ºï¼Œå…ˆæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ `promise.then()`ï¼Œå‘ç°promiseçš„çŠ¶æ€å¹¶æ²¡æœ‰æ”¹å˜ï¼Œè¿˜æ˜¯`pending`ï¼Œæ‰€ä»¥æ²¡æœ‰è¾“å‡ºã€‚çŠ¶æ€å¹¶æ²¡æœ‰æ”¹å˜çš„åŸå› æ˜¯ï¼š`resolve('è¿™æ¬¡ä¸€å®š')`æ˜¯åœ¨`setTimeout`é‡Œçš„ï¼Œä½†æ­¤æ—¶è¿˜æ²¡å¼€å§‹æ‰§è¡Œ`setTimeout`ï¼Œå› ä¸º`setTimeout`æ˜¯å®ä»»åŠ¡ï¼Œå®ä»»åŠ¡åœ¨å¾®ä»»åŠ¡åé¢æ‰§è¡Œ

â–ª **ç¬¬ä¸ƒæ­¥**ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ¸…ç©ºï¼Œå¼€å§‹æ‰§è¡Œå®ä»»åŠ¡ `setTimeout`ï¼š

```javascript
 setTimeout(() => {
     console.log('A',promise1.PromiseState);
     resolve('è¿™æ¬¡ä¸€å®š');
     console.log('B',promise1.PromiseState);
     console.log(4);
 });
å¤åˆ¶ä»£ç 
```

â–ª **ç¬¬å…«æ­¥**ï¼Œæ‰§è¡Œ `console.log('A',promise1.PromiseState)`ï¼Œæ­¤æ—¶promiseçŠ¶æ€è¿˜æ²¡å‘ç”Ÿå˜åŒ–ï¼Œè¿˜æ˜¯`pending`ï¼Œæ‰€ä»¥è¾“å‡º `A pending`

â–ª **ç¬¬ä¹æ­¥**ï¼Œæ‰§è¡Œ `resolve('è¿™æ¬¡ä¸€å®š');`ï¼Œæ”¹å˜promiseçš„çŠ¶æ€ä¸º`fulfilled`

â–ª **ç¬¬åæ­¥**ï¼Œæ‰§è¡Œ `console.log('B',promise1.PromiseState)`ï¼Œè¾“å‡º `B fulfilled`

â–ª **ç¬¬åä¸€æ­¥**ï¼Œæ‰§è¡Œ `console.log(4)`ï¼Œè¾“å‡º`4`

> è¿™é‡Œæš‚ä¸”è®¤ä¸ºæˆ‘ä»¬å†™çš„promise.then()å’ŒåŸç”Ÿä¸€æ ·ï¼Œæ–¹ä¾¿ç†è§£

â—¾ åˆ†æå®Œä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“äº†ï¼Œå› ä¸ºå…ˆæ‰§è¡Œäº†`then`æ–¹æ³•ï¼Œä½†å‘ç°è¿™ä¸ªæ—¶å€™çŠ¶æ€ä¾æ—§æ˜¯ `pending`ï¼Œè€Œæˆ‘ä»¬æ‰‹å†™éƒ¨åˆ†æ²¡æœ‰å®šä¹‰`pending`å¾…å®šçŠ¶æ€çš„æ—¶å€™åº”è¯¥åšä»€ä¹ˆï¼Œå› æ­¤å°±å°‘äº†`fulfilled: è¿™æ¬¡ä¸€å®š` è¿™å¥è¯çš„è¾“å‡º

æ‰€ä»¥æˆ‘ä»¬å°± **ç›´æ¥ç»™`then`æ–¹æ³•é‡Œé¢æ·»åŠ å¾…å®šçŠ¶æ€çš„æƒ…å†µå°±å¯ä»¥äº†**ï¼Œä¹Ÿå°±æ˜¯ç”¨`if`è¿›è¡Œåˆ¤æ–­:

```javascript
class myPromise {
	...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };
+       if (this.PromiseState === myPromise.PENDING) {
+ 		
+ 		}
        if (this.PromiseState === myPromise.FULFILLED) {
            setTimeout(() => {
                onFulfilled(this.PromiseResult);
            });
        }
        if (this.PromiseState === myPromise.REJECTED) {
            setTimeout(() => {
                onRejected(this.PromiseResult);
            });
        }
    }
}
å¤åˆ¶ä»£ç 
```

â—¾ ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œå½“`then`é‡Œé¢åˆ¤æ–­åˆ° `pending` å¾…å®šçŠ¶æ€æ—¶æˆ‘ä»¬è¦å¹²ä»€ä¹ˆï¼Ÿ

å› ä¸ºè¿™ä¸ªæ—¶å€™`resolve`æˆ–è€…`reject`è¿˜æ²¡è·å–åˆ°ä»»ä½•å€¼ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è®©`then`é‡Œçš„å‡½æ•°ç¨åå†æ‰§è¡Œï¼Œç­‰`resolve`æ‰§è¡Œäº†ä»¥åï¼Œå†æ‰§è¡Œ`then`

ä¸ºäº†ä¿ç•™`then`é‡Œçš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»º `æ•°ç»„` æ¥ **ä¿å­˜å‡½æ•°**ã€‚

**ä¸ºä»€ä¹ˆç”¨ `æ•°ç»„` æ¥ä¿å­˜è¿™äº›å›è°ƒå‘¢ï¼Ÿå› ä¸ºä¸€ä¸ªpromiseå®ä¾‹å¯èƒ½ä¼šå¤šæ¬¡ `then`ï¼Œä¹Ÿå°±æ˜¯ç»å…¸çš„ `é“¾å¼è°ƒç”¨`**ï¼Œè€Œä¸”æ•°ç»„æ˜¯å…ˆå…¥å…ˆå‡ºçš„é¡ºåº

åœ¨å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™å°±è®©æ¯ä¸ªå®ä¾‹éƒ½æœ‰è¿™ä¸¤ä¸ªæ•°ç»„ï¼š

- `onFulfilledCallbacks` ï¼šç”¨æ¥ **ä¿å­˜æˆåŠŸå›è°ƒ**
- `onRejectedCallbacks` ï¼šç”¨æ¥ **ä¿å­˜å¤±è´¥å›è°ƒ**

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
+       this.onFulfilledCallbacks = []; // ä¿å­˜æˆåŠŸå›è°ƒ
+       this.onRejectedCallbacks = []; // ä¿å­˜å¤±è´¥å›è°ƒ
        try {
            func(this.resolve.bind(this), this.reject.bind(this));
        } catch (error) {
            this.reject(error)
        }
    }
}
å¤åˆ¶ä»£ç 
```

â—¾ æ¥ç€å°±å®Œå–„`then`é‡Œé¢çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯å½“åˆ¤æ–­åˆ°çŠ¶æ€ä¸º `pending` å¾…å®šæ—¶ï¼Œæš‚æ—¶ä¿å­˜ä¸¤ä¸ªå›è°ƒï¼Œä¹Ÿå°±æ˜¯è¯´æš‚ä¸”æŠŠ`then`é‡Œçš„ä¸¤ä¸ªå‡½æ•°å‚æ•°åˆ†åˆ«æ”¾åœ¨ä¸¤ä¸ªæ•°ç»„é‡Œé¢ï¼š

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        this.onFulfilledCallbacks = []; // ä¿å­˜æˆåŠŸå›è°ƒ
        this.onRejectedCallbacks = []; // ä¿å­˜å¤±è´¥å›è°ƒ
        try {
            func(this.resolve.bind(this), this.reject.bind(this));
        } catch (error) {
            this.reject(error)
        }
    }
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : () => {};
        onRejected = typeof onRejected === 'function' ? onRejected : () => {};
        if (this.PromiseState === myPromise.PENDING) {
+           this.onFulfilledCallbacks.push(onFulfilled);
+           this.onRejectedCallbacks.push(onRejected);
        }
        if (this.PromiseState === myPromise.FULFILLED) {
            setTimeout(() => {
                onFulfilled(this.PromiseResult);
            });
        }
        if (this.PromiseState === myPromise.REJECTED) {
            setTimeout(() => {
                onRejected(this.PromiseResult);
            });
        }
    }
}
å¤åˆ¶ä»£ç 
```

â—¾ æ•°ç»„é‡Œé¢æ”¾å®Œå‡½æ•°ä»¥åï¼Œå°±å¯ä»¥å®Œå–„`resolve`å’Œ`reject`çš„ä»£ç äº†

**åœ¨æ‰§è¡Œ`resolve`æˆ–è€…`reject`çš„æ—¶å€™ï¼Œéå†è‡ªèº«çš„`callbacks`æ•°ç»„**ï¼Œçœ‹çœ‹æ•°ç»„é‡Œé¢æœ‰æ²¡æœ‰`then`é‚£è¾¹ **ä¿ç•™** è¿‡æ¥çš„ **å¾…æ‰§è¡Œå‡½æ•°**ï¼Œ**ç„¶åé€ä¸ªæ‰§è¡Œæ•°ç»„é‡Œé¢çš„å‡½æ•°**ï¼Œæ‰§è¡Œçš„æ—¶å€™ä¼šä¼ å…¥ç›¸åº”çš„å‚æ•°ï¼š

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        this.onFulfilledCallbacks = []; // ä¿å­˜æˆåŠŸå›è°ƒ
        this.onRejectedCallbacks = []; // ä¿å­˜å¤±è´¥å›è°ƒ
        try {
            func(this.resolve.bind(this), this.reject.bind(this));
        } catch (error) {
            this.reject(error)
        }
    }
    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
+           this.onFulfilledCallbacks.forEach(callback => {
+               callback(result)
+           })
        }
    }
    reject(reason) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECTED;
            this.PromiseResult = reason;
 +          this.onRejectedCallbacks.forEach(callback => {
 +              callback(reason)
 +          })
        }
    }
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };
        if (this.PromiseState === myPromise.PENDING) {
            this.onFulfilledCallbacks.push(onFulfilled);
            this.onRejectedCallbacks.push(onRejected);
        }
        if (this.PromiseState === myPromise.FULFILLED) {
            setTimeout(() => {
                onFulfilled(this.PromiseResult);
            });
        }
        if (this.PromiseState === myPromise.REJECTED) {
            setTimeout(() => {
                onRejected(this.PromiseResult);
            });
        }
    }
}
å¤åˆ¶ä»£ç 
```

å®Œå–„å¥½ä»£ç åï¼Œè®©æˆ‘ä»¬å†æ¥æµ‹è¯•ä»¥ä¸‹åˆšæ‰çš„å®ä¾‹ï¼š

```javascript
class myPromise {
	...
}


// æµ‹è¯•ä»£ç 
console.log(1);
let promise1 = new myPromise((resolve, reject) => {
    console.log(2);
    setTimeout(() => {
        console.log('A', promise1.PromiseState);
        resolve('è¿™æ¬¡ä¸€å®š');
        console.log('B', promise1.PromiseState);
        console.log(4);
    });
})
promise1.then(
    result => {
        console.log('C', promise1.PromiseState);
        console.log('fulfilled:', result);
    },
    reason => {
        console.log('rejected:', reason)
    }
)
console.log(3);
å¤åˆ¶ä»£ç 
```

è¾“å‡ºç»“æœï¼š

```javascript
1
2
3
A pending
C fulfilled
fulfilled: è¿™æ¬¡ä¸€å®š
B fulfilled
4
å¤åˆ¶ä»£ç 
```

**ä»ä¸Šé¢çš„ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ° `fulfilled: è¿™æ¬¡ä¸€å®š` æ‰“å°å‡ºæ¥å•¦ï¼Œ`promise1.then()`æ–¹æ³•ä¹Ÿæ­£å¸¸æ‰§è¡Œï¼Œæ‰“å°å‡ºäº†å½“å‰çš„çŠ¶æ€ï¼š`B fulfilled`**

**ä½†æ˜¯**

ç»†å¿ƒçš„åŒå­¦å¯èƒ½å·²ç»å‘ç°äº†ï¼Œä»£ç è¾“å‡ºé¡ºåºè¿˜æ˜¯ä¸å¤ªå¯¹ï¼ŒåŸç”ŸPromiseä¸­ï¼Œ`fulfilled: è¿™æ¬¡ä¸€å®š` æ˜¯æœ€åè¾“å‡ºçš„

â—¾ è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆå¤šäººå¿½ç•¥çš„å°ç»†èŠ‚ï¼Œ**è¦ç¡®ä¿ onFulfilled å’Œ onRejected æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ then æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œ**ã€‚å› æ­¤ï¼Œ**åœ¨ä¿å­˜æˆåŠŸå’Œå¤±è´¥å›è°ƒæ—¶ä¹Ÿè¦æ·»åŠ  `setTimeout`**

```javascript
class myPromise {
    ...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };
        if (this.PromiseState === myPromise.PENDING) {
+           this.onFulfilledCallbacks.push(() => {
+               setTimeout(() => {
+                   onFulfilled(this.PromiseResult);
+               });
+           });
+           this.onRejectedCallbacks.push(() => {
+               setTimeout(() => {
+                   onRejected(this.PromiseResult);
+               });
+           });
        }
        if (this.PromiseState === myPromise.FULFILLED) {
            setTimeout(() => {
                onFulfilled(this.PromiseResult);
            });
        }
        if (this.PromiseState === myPromise.REJECTED) {
            setTimeout(() => {
                onRejected(this.PromiseResult);
            });
        }
    }
}
å¤åˆ¶ä»£ç 
```

ç»†èŠ‚è¡¥å……å¥½äº†ï¼Œ**å½“å‰å®ç°çš„å®Œæ•´ä»£ç ï¼š**

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';
    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        this.onFulfilledCallbacks = []; // ä¿å­˜æˆåŠŸå›è°ƒ
        this.onRejectedCallbacks = []; // ä¿å­˜å¤±è´¥å›è°ƒ
        try {
            func(this.resolve.bind(this), this.reject.bind(this));
        } catch (error) {
            this.reject(error)
        }
    }
    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
            this.onFulfilledCallbacks.forEach(callback => {
                callback(result)
            })
        }
    }
    reject(reason) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECTED;
            this.PromiseResult = reason;
            this.onRejectedCallbacks.forEach(callback => {
                callback(reason)
            })
        }
    }
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };
        if (this.PromiseState === myPromise.PENDING) {
            this.onFulfilledCallbacks.push(() => {
                setTimeout(() => {
                    onFulfilled(this.PromiseResult);
                });
            });
            this.onRejectedCallbacks.push(() => {
                setTimeout(() => {
                    onRejected(this.PromiseResult);
                });
            });
        }
        if (this.PromiseState === myPromise.FULFILLED) {
            setTimeout(() => {
                onFulfilled(this.PromiseResult);
            });
        }
        if (this.PromiseState === myPromise.REJECTED) {
            setTimeout(() => {
                onRejected(this.PromiseResult);
            });
        }
    }
}
å¤åˆ¶ä»£ç 
```

æ£€éªŒä¸€ä¸‹è¿™æ¬¡æ˜¯å¦èƒ½è¡Œï¼š

```js
class myPromise {
    ...
}

// æµ‹è¯•ä»£ç 
console.log(1);
let promise1 = new myPromise((resolve, reject) => {
    console.log(2);
    setTimeout(() => {
        console.log('A', promise1.PromiseState);
        resolve('è¿™æ¬¡ä¸€å®š');
        console.log('B', promise1.PromiseState);
        console.log(4);
    });
})
promise1.then(
    result => {
        console.log('C', promise1.PromiseState);
        console.log('fulfilled:', result);
    },
    reason => {
        console.log('rejected:', reason)
    }
)
console.log(3);
å¤åˆ¶ä»£ç 
```

è¾“å‡ºé¡ºåºï¼š

```javascript
1
2
3
A pending
B pending
4
C fulfilled
fulfilled: è¿™æ¬¡ä¸€å®š
å¤åˆ¶ä»£ç 
```

**å¯ä»¥çœ‹åˆ°æœ€åè¾“å‡º `fulfilled: è¿™æ¬¡ä¸€å®š` ï¼Œå’ŒåŸç”ŸPromiseé¡ºåºä¸€è‡´ï¼**

åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»å®Œæˆäº† **promiseçš„å›è°ƒä¿å­˜**ï¼Œå·²ç»è¶Šæ¥è¶Šæ¥è¿‘èƒœåˆ©äº†ğŸ˜º

## 3.  éªŒè¯ then æ–¹æ³•å¤šæ¬¡è°ƒç”¨

Promise çš„ then æ–¹æ³•å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ã€‚

ç”¨ä¸€ä¸ª ğŸŒ° ï¼Œæ¥éªŒè¯ä¸€ä¸‹æˆ‘ä»¬å†™çš„promise  `then` æ–¹æ³•æ˜¯å¦å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼š

```javascript
class myPromise {
    ...
}


// æµ‹è¯•ä»£ç 
const promise = new myPromise((resolve, reject) => {
    setTimeout(() => {
        resolve('success')
    }, 2000);
})
promise.then(value => {
    console.log(1)
    console.log('resolve', value)
})
promise.then(value => {
    console.log(2)
    console.log('resolve', value)
})
promise.then(value => {
    console.log(3)
    console.log('resolve', value)
})
å¤åˆ¶ä»£ç 
```

è¿è¡Œä¸Šé¢ ğŸŒ°ï¼Œè¾“å‡ºç»“æœğŸ‘‡

```javascript
1
resolve success
2
resolve success
3
resolve success
å¤åˆ¶ä»£ç 
```

æ‰€æœ‰ `then` ä¸­çš„å›è°ƒå‡½æ•°éƒ½å·²ç»æ‰§è¡Œ  ğŸ˜

è¯´æ˜æˆ‘ä»¬å½“å‰çš„ä»£ç ï¼Œå·²ç»å¯ä»¥å®ç° `then` æ–¹æ³•çš„å¤šæ¬¡è°ƒç”¨âœ¨

ğŸ‘ğŸ‘ğŸ‘ å®Œç¾ï¼Œç»§ç»­

# äº”ã€å®ç° then æ–¹æ³•çš„é“¾å¼è°ƒç”¨

**æˆ‘ä»¬å¸¸å¸¸ç”¨åˆ° `new Promise().then().then()`ï¼Œè¿™å°±æ˜¯é“¾å¼è°ƒç”¨ï¼Œç”¨æ¥è§£å†³å›è°ƒåœ°ç‹±**

ä¸¾ä¸ªä¾‹å­ ğŸŒ°

```javascript
let p1 = new Promise((resolve, reject) => {
    resolve(100)
})
p1.then(res => {
    console.log('fulfilled', res);
    return 2 * res
}).then(res => {
    console.log('fulfilled', res)
})
å¤åˆ¶ä»£ç 
```

è¾“å‡ºğŸ‘‡ï¼š

```javascript
fulfilled 100
fulfilled 200
å¤åˆ¶ä»£ç 
```

å†ä¸¾ä¸€ä¸ªä¾‹å­ ğŸŒ° ï¼š

```javascript
const p2 = new Promise((resolve, reject) => {
    resolve(100)
})

p2.then(res => {
    console.log('fulfilled', res);
    return new Promise((resolve, reject) => resolve(3 * res))
}).then(res => {
    console.log('fulfilled', res)
})
å¤åˆ¶ä»£ç 
```

è¾“å‡ºğŸ‘‡ï¼š

```javascript
fulfilled 100
fulfilled 300
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬å…ˆè¯•ä¸€ä¸‹å½“å‰çš„`myPromise`æ˜¯å¦å¯ä»¥å®ç°é“¾å¼è°ƒç”¨ï¼š

```javascript
class myPromise {
    ...
}

// æµ‹è¯•ä»£ç 
let p1 = new myPromise((resolve, reject) => {
    resolve(10)
})
p1.then(res => {
    console.log('fulfilled', res);
    return 2 * res
}).then(res => {
    console.log('fulfilled', res)
}) 
å¤åˆ¶ä»£ç 
```

æ¯«æ— ç–‘é—®åœ¨æ§åˆ¶å°é‡Œé¢æ˜¯ä¼šæŠ¥é”™çš„ï¼Œæç¤º `then` æ–¹æ³•æ²¡æœ‰å®šä¹‰ï¼š

```
Uncaught TypeError: Cannot read property 'then' of undefined
```

**`Promise.prototype.then()` æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promiseå®ä¾‹ï¼ˆæ³¨æ„ï¼Œä¸æ˜¯åŸæ¥é‚£ä¸ª`Promise`å®ä¾‹ï¼‰ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨é“¾å¼å†™æ³•ï¼Œå³thenæ–¹æ³•åé¢å†è°ƒç”¨å¦ä¸€ä¸ªthenæ–¹æ³•ã€‚**

## 1. Promises/A+ è§„èŒƒçš„ç†è§£

â—¾ **æƒ³è¦å®ç°`then`æ–¹æ³•çš„é“¾å¼è°ƒç”¨ï¼Œå°±å¿…é¡»å½»åº•ææ‡‚`then`æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å‚è€ƒ [\**`Promises/A+` è§„èŒƒ\**](https://link.juejin.cn?target=https%3A%2F%2Fpromisesaplus.com%2F%23notes)** ğŸ‘‡

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/113f66b486b748fd82312640d981f4a8~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**è§„èŒƒåœ¨`2.2.7`ä¸­è¿™æ ·æè¿° ğŸ‘‡ï¼š**

â—¾ **2.2.7 then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡**

```javascript
promise2 = promise1.then(onFulfilled, onRejected);
å¤åˆ¶ä»£ç 
```

- **2.2.7.1** å¦‚æœ `onFulfilled` æˆ–è€… `onRejected` è¿”å›ä¸€ä¸ªå€¼ `x` ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ **Promise è§£å†³è¿‡ç¨‹ï¼š`[[Resolve]](promise2, x)`**
- **2.2.7.2** å¦‚æœ `onFulfilled` æˆ–è€… `onRejected` æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ `e` ï¼Œåˆ™ `promise2` å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  `e`
- **2.2.7.3** å¦‚æœ `onFulfilled` ä¸æ˜¯å‡½æ•°ä¸” `promise1` æˆåŠŸæ‰§è¡Œï¼Œ `promise2` å¿…é¡»æˆåŠŸæ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„å€¼
- **2.2.7.4** å¦‚æœ `onRejected` ä¸æ˜¯å‡½æ•°ä¸” `promise1` æ‹’ç»æ‰§è¡Œï¼Œ `promise2` å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„æ®å› 

ç†è§£ä¸Šé¢çš„`â€œè¿”å›â€`éƒ¨åˆ†éå¸¸é‡è¦ï¼Œå³ï¼š**ä¸è®º promise1 è¢« reject è¿˜æ˜¯è¢« resolve æ—¶ promise2 éƒ½ä¼šæ‰§è¡Œ Promise è§£å†³è¿‡ç¨‹ï¼š`[[Resolve]](promise2, x)`ï¼Œåªæœ‰å‡ºç°å¼‚å¸¸æ—¶æ‰ä¼šè¢« rejectedã€‚**

æ³¨æ„ **2.2.7.1** ï¼š

> If either onFulfilled or onRejected returns a value x, **`run the Promise Resolution Procedure [[Resolve]](promise2, x).`**

å³ï¼šå¦‚æœ `onFulfilled` æˆ–è€… `onRejected` è¿”å›ä¸€ä¸ªå€¼ `x` ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ **Promise è§£å†³è¿‡ç¨‹ï¼š`[[Resolve]](promise2, x)`**

è§„èŒƒåœ¨ **2.3** ä¸­è¯¦ç»†æè¿° **Promise è§£å†³è¿‡ç¨‹**  `The Promise Resolution Procedure` ğŸ‘‡

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb4fc438128f4b3aa1f665733a491bca~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

è¯‘è¿‡æ¥ ğŸ‘‡ï¼š

â—¾ **2.3 Promise è§£å†³è¿‡ç¨‹**

**Promise è§£å†³è¿‡ç¨‹** æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ“ä½œï¼Œå…¶éœ€è¾“å…¥ä¸€ä¸ª `promise` å’Œä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬è¡¨ç¤ºä¸º `[[Resolve]](promise, x)`ï¼Œå¦‚æœ `x` æœ‰ `then` æ–¹æ³•ä¸”çœ‹ä¸Šå»åƒä¸€ä¸ª `Promise` ï¼Œè§£å†³ç¨‹åºå³å°è¯•ä½¿ `promise` æ¥å— `x` çš„çŠ¶æ€ï¼›å¦åˆ™å…¶ç”¨ `x` çš„å€¼æ¥æ‰§è¡Œ `promise` ã€‚

è¿™ç§ `thenable` çš„ç‰¹æ€§ä½¿å¾— `Promise` çš„å®ç°æ›´å…·æœ‰é€šç”¨æ€§ï¼š**åªè¦å…¶æš´éœ²å‡ºä¸€ä¸ªéµå¾ª `Promises/A+` åè®®çš„ `then` æ–¹æ³•å³å¯ï¼›è¿™åŒæ—¶ä¹Ÿä½¿éµå¾ª `Promises/A+` è§„èŒƒçš„å®ç°å¯ä»¥ä¸é‚£äº›ä¸å¤ªè§„èŒƒä½†å¯ç”¨çš„å®ç°èƒ½è‰¯å¥½å…±å­˜ã€‚**

**è¿è¡Œ `[[Resolve]](promise, x)` éœ€éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š**

â–ª **2.3.1 `x` ä¸ promise ç›¸ç­‰**

å¦‚æœ `promise` å’Œ `x` æŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œä»¥ `TypeError` ä¸ºæ®å› æ‹’ç»æ‰§è¡Œ `promise`

â–ª **2.3.2 `x` ä¸º Promise**

å¦‚æœ `x` ä¸º Promise ï¼Œåˆ™ä½¿ `promise` æ¥å— `x` çš„çŠ¶æ€

- 2.3.2.1 å¦‚æœ `x` å¤„äºç­‰å¾…æ€ï¼Œ `promise` éœ€ä¿æŒä¸ºç­‰å¾…æ€ç›´è‡³ `x` è¢«æ‰§è¡Œæˆ–æ‹’ç»
- 2.3.2.2 å¦‚æœ `x` å¤„äºæ‰§è¡Œæ€ï¼Œç”¨ç›¸åŒçš„å€¼æ‰§è¡Œ `promise`
- 2.3.2.3 å¦‚æœ `x` å¤„äºæ‹’ç»æ€ï¼Œç”¨ç›¸åŒçš„æ®å› æ‹’ç» `promise`

â–ª **2.3.3 `x` ä¸ºå¯¹è±¡æˆ–å‡½æ•°**

å¦‚æœ x ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼š

- 2.3.3.1 æŠŠ `x.then` èµ‹å€¼ç»™ `then`
- 2.3.3.2 å¦‚æœå– `x.then` çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ `e` ï¼Œåˆ™ä»¥ `e` ä¸ºæ®å› æ‹’ç» `promise`
- 2.3.3.3 å¦‚æœ `then` æ˜¯å‡½æ•°ï¼Œå°† `x` ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ `this` è°ƒç”¨ä¹‹ã€‚ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å«åš `resolvePromise` ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš `rejectPromise`:
  - 2.3.3.3.1 å¦‚æœ `resolvePromise` ä»¥å€¼ `y` ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ `[[Resolve]](promise, y)`
  - 2.3.3.3.2 å¦‚æœ `rejectPromise` ä»¥æ®å›  `r` ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  `r` æ‹’ç» `promise`
  - 2.3.3.3.3 å¦‚æœ `resolvePromise` å’Œ `rejectPromise` å‡è¢«è°ƒç”¨ï¼Œæˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨
  - 2.3.3.3.4 å¦‚æœè°ƒç”¨ `then` æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ `e`ï¼š
    - 2.3.3.3.4.1 å¦‚æœ `resolvePromise` æˆ– `rejectPromise` å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥ä¹‹
    - 2.3.3.3.4.2 å¦åˆ™ä»¥ `e` ä¸ºæ®å› æ‹’ç» `promise`
  - 2.3.3.4 å¦‚æœ `then` ä¸æ˜¯å‡½æ•°ï¼Œä»¥ `x` ä¸ºå‚æ•°æ‰§è¡Œ `promise`

**â–ª 2.3.4 å¦‚æœ `x` ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ `x` ä¸ºå‚æ•°æ‰§è¡Œ `promise`**

å¦‚æœä¸€ä¸ª `promise` è¢«ä¸€ä¸ªå¾ªç¯çš„ `thenable` é“¾ä¸­çš„å¯¹è±¡è§£å†³ï¼Œè€Œ `[[Resolve]](promise, thenable)` çš„é€’å½’æ€§è´¨åˆä½¿å¾—å…¶è¢«å†æ¬¡è°ƒç”¨ï¼Œæ ¹æ®ä¸Šè¿°çš„ç®—æ³•å°†ä¼šé™·å…¥æ— é™é€’å½’ä¹‹ä¸­ã€‚ç®—æ³•è™½ä¸å¼ºåˆ¶è¦æ±‚ï¼Œä½†ä¹Ÿé¼“åŠ±æ–½è€…æ£€æµ‹è¿™æ ·çš„é€’å½’æ˜¯å¦å­˜åœ¨ï¼Œè‹¥æ£€æµ‹åˆ°å­˜åœ¨åˆ™ä»¥ä¸€ä¸ªå¯è¯†åˆ«çš„ `TypeError` ä¸ºæ®å› æ¥æ‹’ç» `promise`ã€‚

## 2. Promises/A+ è§„èŒƒçš„æ€»ç»“

åŸºäºè§„èŒƒçš„æè¿°ï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š

**â—¾ 1.** `then`æ–¹æ³•æœ¬èº«ä¼šè¿”å›ä¸€ä¸ªæ–°çš„`Promise`å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„Promiseä»¥åå®ƒå°±æœ‰è‡ªå·±çš„`then`æ–¹æ³•ï¼Œè¿™æ ·å°±èƒ½å®ç°æ— é™çš„é“¾å¼

**â—¾ 2.** ä¸è®º `promise1` è¢« `resolve()`  è¿˜æ˜¯è¢« `reject()` æ—¶ `promise2` éƒ½ä¼šæ‰§è¡Œ **`Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)`**

åœ¨æ‰‹å†™è¿™é‡Œæˆ‘ä»¬æŠŠè¿™ä¸ª **`Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)`** å‘½åä¸º `resolvePromise()` æ–¹æ³•ï¼Œå‚æ•°ä¸º `(promise2, x, resolve, reject)` å³ï¼š

```javascript
function resolvePromise(promise2, x, resolve, reject) {}
å¤åˆ¶ä»£ç 
```

`resolvePromise()`å„å‚æ•°çš„æ„ä¹‰ï¼š

```javascript
/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {}
å¤åˆ¶ä»£ç 
```

å…¶å®ï¼Œè¿™ä¸ª`resolvePromise(promise2, x, resolve, reject)` å³ `Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)` å°±æ˜¯å¯¹`resolve()ã€reject()` è¿›è¡Œ**æ”¹é€ å¢å¼º**ï¼Œ é’ˆå¯¹`resolve()`å’Œ`reject()`ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†ã€‚

`resolve()`å’Œ`reject()` è¿”å›çš„ `x` å€¼çš„å‡ ç§æƒ…å†µï¼š

1. æ™®é€šå€¼
2. Promiseå¯¹è±¡
3. thenableå¯¹è±¡/å‡½æ•°

**ä¸‹é¢æˆ‘ä»¬å°±æ ¹æ®æ€»ç»“çš„ä¸¤ç‚¹ï¼Œç»“åˆ `Promises/A+ è§„èŒƒ` æ¥å®ç° `then` æ–¹æ³•çš„é“¾å¼è°ƒç”¨ ğŸ’ªğŸ’ªğŸ’ª**

## 3. then æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promise

â—¾ **2.2.7è§„èŒƒ then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡**

æˆ‘ä»¬åœ¨`then`æ–¹æ³•é‡Œé¢è¿”å›ä¸€ä¸ª **`æ–°çš„æ‰‹å†™Promiseå®ä¾‹`**ï¼Œå†æŠŠåŸæ¥çš„ä»£ç å¤åˆ¶ä¸Šå»ï¼š

```javascript
class myPromise {
	...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };
        
+       const promise2 = new myPromise((resolve, reject) => {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() => {
                    onFulfilled(this.PromiseResult);
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() => {
                    onRejected(this.PromiseResult);
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() => {
                    setTimeout(() => {
                        onFulfilled(this.PromiseResult);
                    });
                });
                this.onRejectedCallbacks.push(() => {
                    setTimeout(() => {
                        onRejected(this.PromiseResult);
                    });
                });
            }
+       })
        
+       return promise2
    }
}
å¤åˆ¶ä»£ç 
```

**â—¾ 2.2.7.1è§„èŒƒ** å¦‚æœ `onFulfilled` æˆ–è€… `onRejected` è¿”å›ä¸€ä¸ªå€¼ `x` ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ **Promise è§£å†³è¿‡ç¨‹ï¼š`[[Resolve]](promise2, x)`**

```javascript
class myPromise {
	...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : +reason => {
            throw reason;
        };

        const promise2 = new myPromise((resolve, reject) => {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() => {
+                   let x = onFulfilled(this.PromiseResult);
+                   resolvePromise(promise2, x, resolve, reject);
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() => {
+                   let x = onRejected(this.PromiseResult);
+                   resolvePromise(promise2, x, resolve, reject);
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() => {
                    setTimeout(() => {
                        onFulfilled(this.PromiseResult);
                    });
                });
                this.onRejectedCallbacks.push(() => {
                    setTimeout(() => {
                        onRejected(this.PromiseResult);
                    });
                });
            }
        })

        return promise2
    }
}

+/**
+ * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
+ * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
+ * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
+ * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
+ * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
+ */
+ function resolvePromise(promise2, x, resolve, reject) {}
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬åœ¨ `myPromise` ç±»å¤–é¢å£°æ˜äº†ä¸€ä¸ª **Promise è§£å†³è¿‡ç¨‹**ï¼š

```javascript
function resolvePromise(promise2, x, resolve, reject) {

}
å¤åˆ¶ä»£ç 
```

**`resolvePromise()` å…·ä½“æ–¹æ³•æˆ‘ä»¬åé¢ä¼šè¡¥å……~**

**â—¾ 2.2.7.2 å¦‚æœ `onFulfilled` æˆ–è€… `onRejected` æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ `e` ï¼Œåˆ™ `promise2` å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  `e`**

```javascript
class myPromise {
	...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };

        const promise2 = new myPromise((resolve, reject) => {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() => {
+                   try {
                        let x = onFulfilled(this.PromiseResult);
                        resolvePromise(promise2, x, resolve, reject);
+                   } catch (e) {
+                       reject(e); // æ•è·å‰é¢onFulfilledä¸­æŠ›å‡ºçš„å¼‚å¸¸
+                   }
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() => {
+                   try {
                        let x = onRejected(this.PromiseResult);
                        resolvePromise(promise2, x, resolve, reject);
+                   } catch (e) {
+                       reject(e)
+                   }
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() => {
                    setTimeout(() => {
                        onFulfilled(this.PromiseResult);
                    });
                });
                this.onRejectedCallbacks.push(() => {
                    setTimeout(() => {
                        onRejected(this.PromiseResult);
                    });
                });
            }
        })

        return promise2
    }
}

/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {}
å¤åˆ¶ä»£ç 
```

**â—¾ `fulfilled` å’Œ `rejected` çŠ¶æ€å¤„ç†å®Œï¼Œä¸è¦å¿˜äº† `pending` çŠ¶æ€çš„æƒ…å†µ**

æˆ‘ä»¬åœ¨ `pending` çŠ¶æ€ä¿å­˜çš„ `resolve()` å’Œ `reject()` å›è°ƒä¹Ÿè¦ç¬¦åˆ `2.2.7.1 å’Œ 2.2.7.2 è§„èŒƒ`ï¼š

> å¦‚æœ `onFulfilled` æˆ–è€… `onRejected` è¿”å›ä¸€ä¸ªå€¼ `x` ï¼Œåˆ™è¿è¡Œ Promise è§£å†³è¿‡ç¨‹ï¼š`[[Resolve]](promise2, x)`

> å¦‚æœ `onFulfilled` æˆ–è€… `onRejected` æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ `e` ï¼Œåˆ™ `promise2` å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  `e`

```javascript
class myPromise {
	...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };

        const promise2 = new myPromise((resolve, reject) => {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() => {
                    try {
                        let x = onFulfilled(this.PromiseResult);
                        resolvePromise(promise2, x, resolve, reject);
                    } catch (e) {
                        reject(e); // æ•è·å‰é¢onFulfilledä¸­æŠ›å‡ºçš„å¼‚å¸¸
                    }
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() => {
                    try {
                        let x = onRejected(this.PromiseResult);
                        resolvePromise(promise2, x, resolve, reject);
                    } catch (e) {
                        reject(e)
                    }
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() => {
                    setTimeout(() => {
+                       try {
+                           let x = onFulfilled(this.PromiseResult);
+                           resolvePromise(promise2, x, resolve, reject)
+                       } catch (e) {
+                           reject(e);
+                       }
                    });
                });
                this.onRejectedCallbacks.push(() => {
                    setTimeout(() => {
+                       try {
+                           let x = onRejected(this.PromiseResult);
+                           resolvePromise(promise2, x, resolve, reject);
+                       } catch (e) {
+                           reject(e);
+                       }
                    });
                });
            }
        })

        return promise2
    }
}

/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {}
å¤åˆ¶ä»£ç 
```

**â—¾ 2.2.7.3 å¦‚æœ `onFulfilled` ä¸æ˜¯å‡½æ•°ä¸” `promise1` æˆåŠŸæ‰§è¡Œï¼Œ `promise2` å¿…é¡»æˆåŠŸæ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„å€¼**

```js
class myPromise {
    ...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };

        const promise2 = new myPromise((resolve, reject) => {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() => {
                    try {
+                       if (typeof onFulfilled !== 'function') {
+                           resolve(this.PromiseResult);
+                       } else {
                            let x = onFulfilled(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
+                       }
                    } catch (e) {
                        reject(e);
                    }
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() => {
                    try {
                        let x = onRejected(this.PromiseResult);
                        resolvePromise(promise2, x, resolve, reject);
                    } catch (e) {
                        reject(e)
                    }
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() => {
                    setTimeout(() => {
                        try {
+                           if (typeof onFulfilled !== 'function') {
+                               resolve(this.PromiseResult);
+                           } else {
                                let x = onFulfilled(this.PromiseResult);
                                resolvePromise(promise2, x, resolve, reject);
+                           }
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
                this.onRejectedCallbacks.push(() => {
                    setTimeout(() => {
                        try {
                            let x = onRejected(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
            }
        })

        return promise2
    }
}

/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {}
å¤åˆ¶ä»£ç 
```

**â—¾ 2.2.7.4 å¦‚æœ `onRejected` ä¸æ˜¯å‡½æ•°ä¸” `promise1` æ‹’ç»æ‰§è¡Œï¼Œ `promise2` å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„æ®å› **

```js
class myPromise {
    ...
    then(onFulfilled, onRejected) {
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
        onRejected = typeof onRejected === 'function' ? onRejected : reason => {
            throw reason;
        };

        const promise2 = new myPromise((resolve, reject) => {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() => {
                    try {
                        if (typeof onFulfilled !== 'function') {
                            resolve(this.PromiseResult);
                        } else {
                            let x = onFulfilled(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
                        }
                    } catch (e) {
                        reject(e);
                    }
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() => {
                    try {
+                       if (typeof onRejected !== 'function') {
+                           reject(this.PromiseResult);
+                       } else {
                            let x = onRejected(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
+                       }
                    } catch (e) {
                        reject(e)
                    }
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() => {
                    setTimeout(() => {
                        try {
                            if (typeof onFulfilled !== 'function') {
                                resolve(this.PromiseResult);
                            } else {
                                let x = onFulfilled(this.PromiseResult);
                                resolvePromise(promise2, x, resolve, reject);
                            }
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
                this.onRejectedCallbacks.push(() => {
                    setTimeout(() => {
                        try {
+                           if (typeof onRejected !== 'function') {
+                               reject(this.PromiseResult);
+                           } else {
                                let x = onRejected(this.PromiseResult);
                                resolvePromise(promise2, x, resolve, reject);
+                           }
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
            }
        })

        return promise2
    }
}

/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {}
å¤åˆ¶ä»£ç 
```

è§„èŒƒ **2.2.7.3** å’Œ **2.2.7.4** å¯¹ `onFulfilled` å’Œ `onRejected` ä¸æ˜¯å‡½æ•°çš„æƒ…å†µåšäº†æ›´è¯¦ç»†çš„æè¿°ï¼Œæ ¹æ®æè¿°æˆ‘ä»¬å¯¹ `onFulfilled` å’Œ `onRejected` å¼•å…¥äº†æ–°çš„å‚æ•°æ ¡éªŒï¼Œæ‰€ä»¥ä¹‹å‰çš„å‚æ•°æ ¡éªŒå°±å¯ä»¥é€€å½¹äº†ï¼š

```js
class myPromise {
    ...
    then(onFulfilled, onRejected) {
-       onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value;
-       onRejected = typeof onRejected === 'function' ? onRejected : reason => {
-           throw reason;
-       };
    
    ...
    }
}

/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {}
å¤åˆ¶ä»£ç 
```

æå®š `then` æ–¹æ³• ğŸ˜

ä¸‹é¢æˆ‘ä»¬å¼€å§‹ç€æ‰‹å†™ **promise è§£å†³è¿‡ç¨‹ `resolvePromise(promise2, x, resolve, reject)`**

# å…­ã€å®ç° resolvePromise æ–¹æ³•

**â—¾ 2.3.1 å¦‚æœ `promise` å’Œ `x` æŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œä»¥ `TypeError` ä¸ºæ®å› æ‹’ç»æ‰§è¡Œ `promise`**

```javascript
class myPromise {
    ...
    then(onFulfilled, onRejected) {
        const promise2 = new myPromise((resolve, reject) => {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() => {
                    try {
                        if (typeof onFulfilled !== 'function') {
                            resolve(this.PromiseResult);
                        } else {
                            let x = onFulfilled(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
                        }
                    } catch (e) {
                        reject(e);
                    }
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() => {
                    try {
                        if (typeof onRejected !== 'function') {
                            reject(this.PromiseResult);
                        } else {
                            let x = onRejected(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
                        }
                    } catch (e) {
                        reject(e)
                    }
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() => {
                    setTimeout(() => {
                        try {
                            if (typeof onFulfilled !== 'function') {
                                resolve(this.PromiseResult);
                            } else {
                                let x = onFulfilled(this.PromiseResult);
                                resolvePromise(promise2, x, resolve, reject);
                            }
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
                this.onRejectedCallbacks.push(() => {
                    setTimeout(() => {
                        try {
                            if (typeof onRejected !== 'function') {
                                reject(this.PromiseResult);
                            } else {
                                let x = onRejected(this.PromiseResult);
                                resolvePromise(promise2, x, resolve, reject);
                            }
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
            }
        })

        return promise2
    }
}

/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {
+   if (x === promise2) {
+       throw new TypeError('Chaining cycle detected for promise');
+   }
}
å¤åˆ¶ä»£ç 
```

åœ¨è¿™é‡Œæˆ‘ä»¬åªéœ€è¦æŠ›å‡ºä¸€ä¸ª `TypeError` çš„å¼‚å¸¸å³å¯ï¼Œå› ä¸ºè°ƒç”¨ `resolvePromise` æ–¹æ³•å¤–å±‚çš„ `try...catch` ä¼šæŠ“ä½è¿™ä¸ªå¼‚å¸¸ï¼Œç„¶å **ä»¥ TypeError ä¸ºæ®å› æ‹’ç»æ‰§è¡Œ promiseã€‚**

å¦‚æœä» `onFulfilled` æˆ– `onRejected` ä¸­è¿”å›çš„ x å°±æ˜¯ promise2ï¼Œä¼šå¯¼è‡´ **å¾ªç¯å¼•ç”¨æŠ¥é”™**ï¼Œè¿™éƒ¨åˆ†çš„å¤„ç†å°±æ˜¯è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

ä¸¾ä¸€ä¸ª **å¾ªç¯å¼•ç”¨** çš„ä¾‹å­ğŸŒ°ï¼š

```javascript
const promise = new Promise((resolve, reject) => {
  resolve(100)
})
const p1 = promise.then(value => {
  console.log(value)
  return p1
})
å¤åˆ¶ä»£ç 
```

ä½¿ç”¨åŸç”Ÿ Promise æ‰§è¡Œè¿™ä¸ªä»£ç ï¼Œä¼šæŠ¥ç±»å‹é”™è¯¯ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ce362aa04d1474899056757d69c2a80~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**â—¾ 2.3.2 å¦‚æœ `x` ä¸º Promise ï¼Œåˆ™ä½¿ `promise` æ¥å— `x` çš„çŠ¶æ€**

```javascript
class myPromise {
	...
}

/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {
    if (x === promise2) {
        throw new TypeError('Chaining cycle detected for promise');
    }

+   if (x instanceof myPromise) {
+       /**
+        * 2.3.2 å¦‚æœ x ä¸º Promise ï¼Œåˆ™ä½¿ promise2 æ¥å— x çš„çŠ¶æ€
+        *       ä¹Ÿå°±æ˜¯ç»§ç»­æ‰§è¡Œxï¼Œå¦‚æœæ‰§è¡Œçš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªyï¼Œè¿˜è¦ç»§ç»­è§£æy
+        */
+       x.then(y => {
+           resolvePromise(promise2, y, resolve, reject)
+       }, reject);
+   }
}
å¤åˆ¶ä»£ç 
```

é©¬ä¸Šå°±è¦æˆåŠŸå•¦ğŸ˜¸ï¼Œè¿˜æœ‰æœ€åä¸€æ¡ğŸ˜

**â—¾ 2.3.3 å¦‚æœ `x` ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°** **â—¾ 2.3.4 å¦‚æœ `x` ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ `x` ä¸ºå‚æ•°æ‰§è¡Œ `promise`**

åœ¨åˆ¤æ–­`x`æ˜¯å¯¹è±¡æˆ–å‡½æ•°æ—¶ï¼Œ`x` ä¸èƒ½æ˜¯ `null`ï¼Œå› ä¸º `typeof  null`çš„å€¼ä¹Ÿä¸º `object`

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1976a2fb1142468185be97771c418c3c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

æˆ‘ä»¬åº”è¯¥æ˜¾å¼çš„å£°æ˜ `x != null`ï¼Œè¿™æ · å½“ `x` ä¸º `null` æ—¶ï¼Œç›´æ¥æ‰§è¡Œ`resolve(x)`ï¼Œå¦åˆ™ï¼Œå¦‚æœä¸è¿™æ ·ä¸å£°æ˜ï¼Œ`x` ä¸º `null` æ—¶å°±ä¼šèµ°åˆ°`catch`ç„¶å`reject`ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬è¦çš„ï¼Œæ‰€ä»¥éœ€è¦æ£€æµ‹ä¸‹`null`ï¼š

```javascript
if (x != null && ((typeof x === 'object' || (typeof x === 'function'))))
å¤åˆ¶ä»£ç 
```

**â—¾ 2.3.3 å’Œ 2.3.4 è§„èŒƒå®ç°å¦‚ä¸‹ï¼š**

```javascript
class myPromise {
	...
}

/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {
    if (x === promise2) {
        throw new TypeError('Chaining cycle detected for promise');
    }

    if (x instanceof myPromise) {
        /**
         * 2.3.2 å¦‚æœ x ä¸º Promise ï¼Œåˆ™ä½¿ promise2 æ¥å— x çš„çŠ¶æ€
         *       ä¹Ÿå°±æ˜¯ç»§ç»­æ‰§è¡Œxï¼Œå¦‚æœæ‰§è¡Œçš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªyï¼Œè¿˜è¦ç»§ç»­è§£æy
         */
        x.then(y => {
            resolvePromise(promise2, y, resolve, reject)
        }, reject);
+   } else if (x !== null && ((typeof x === 'object' || (typeof x === 'function')))) {
+       // 2.3.3 å¦‚æœ x ä¸ºå¯¹è±¡æˆ–å‡½æ•°
+       try {
+           // 2.3.3.1 æŠŠ x.then èµ‹å€¼ç»™ then
+           var then = x.then;
+       } catch (e) {
+           // 2.3.3.2 å¦‚æœå– x.then çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ e ï¼Œåˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise
+           return reject(e);
+       }
+
+       /**
+        * 2.3.3.3 
+        * å¦‚æœ then æ˜¯å‡½æ•°ï¼Œå°† x ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ this è°ƒç”¨ä¹‹ã€‚
+        * ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œ
+        * ç¬¬ä¸€ä¸ªå‚æ•°å«åš `resolvePromise` ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš `rejectPromise`
+        */
+       if (typeof then === 'function') {
+           // 2.3.3.3.3 å¦‚æœ resolvePromise å’Œ rejectPromise å‡è¢«è°ƒç”¨ï¼Œæˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨
+           let called = false; // é¿å…å¤šæ¬¡è°ƒç”¨
+           try {
+               then.call(
+                   x,
+                   // 2.3.3.3.1 å¦‚æœ resolvePromise ä»¥å€¼ y ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ [[Resolve]](promise, y)
+                   y => {
+                       if (called) return;
+                       called = true;
+                       resolvePromise(promise2, y, resolve, reject);
+                   },
+                   // 2.3.3.3.2 å¦‚æœ rejectPromise ä»¥æ®å›  r ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  r æ‹’ç» promise
+                   r => {
+                       if (called) return;
+                       called = true;
+                       reject(r);
+                   }
+               )
+           } catch (e) {
+               /**
+                * 2.3.3.3.4 å¦‚æœè°ƒç”¨ then æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ e
+                * 2.3.3.3.4.1 å¦‚æœ resolvePromise æˆ– rejectPromise å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥ä¹‹
+                */
+               if (called) return;
+               called = true;
+
+               /**
+                * 2.3.3.3.4.2 å¦åˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise
+                */
+               reject(e);
+           }
+       } else {
+           // 2.3.3.4 å¦‚æœ then ä¸æ˜¯å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise
+           resolve(x);
+       }
+   } else {
+       // 2.3.4 å¦‚æœ x ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise
+       return resolve(x);
+   }
}
å¤åˆ¶ä»£ç 
```

**æ‰“å®Œæ”¶å·¥**âœ¨âœ¨âœ¨âœ¨

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/083987eb143d45f7bb02b903dc56fe99~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**`resolvePromise()`æ–¹æ³• å®Œæ•´ä»£ç ï¼š**

```javascript
/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {
    if (x === promise2) {
        throw new TypeError('Chaining cycle detected for promise');
    }

    if (x instanceof myPromise) {
        /**
         * 2.3.2 å¦‚æœ x ä¸º Promise ï¼Œåˆ™ä½¿ promise2 æ¥å— x çš„çŠ¶æ€
         *       ä¹Ÿå°±æ˜¯ç»§ç»­æ‰§è¡Œxï¼Œå¦‚æœæ‰§è¡Œçš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªyï¼Œè¿˜è¦ç»§ç»­è§£æy
         */
        x.then(y => {
            resolvePromise(promise2, y, resolve, reject)
        }, reject);
    } else if (x !== null && ((typeof x === 'object' || (typeof x === 'function')))) {
        // 2.3.3 å¦‚æœ x ä¸ºå¯¹è±¡æˆ–å‡½æ•°
        try {
            // 2.3.3.1 æŠŠ x.then èµ‹å€¼ç»™ then
            var then = x.then;
        } catch (e) {
            // 2.3.3.2 å¦‚æœå– x.then çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ e ï¼Œåˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise
            return reject(e);
        }

        /**
         * 2.3.3.3 
         * å¦‚æœ then æ˜¯å‡½æ•°ï¼Œå°† x ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ this è°ƒç”¨ä¹‹ã€‚
         * ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œ
         * ç¬¬ä¸€ä¸ªå‚æ•°å«åš `resolvePromise` ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš `rejectPromise`
         */
        if (typeof then === 'function') {
            // 2.3.3.3.3 å¦‚æœ resolvePromise å’Œ rejectPromise å‡è¢«è°ƒç”¨ï¼Œæˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨
            let called = false; // é¿å…å¤šæ¬¡è°ƒç”¨
            try {
                then.call(
                    x,
                    // 2.3.3.3.1 å¦‚æœ resolvePromise ä»¥å€¼ y ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ [[Resolve]](promise, y)
                    y => {
                        if (called) return;
                        called = true;
                        resolvePromise(promise2, y, resolve, reject);
                    },
                    // 2.3.3.3.2 å¦‚æœ rejectPromise ä»¥æ®å›  r ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  r æ‹’ç» promise
                    r => {
                        if (called) return;
                        called = true;
                        reject(r);
                    }
                )
            } catch (e) {
                /**
                 * 2.3.3.3.4 å¦‚æœè°ƒç”¨ then æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ e
                 * 2.3.3.3.4.1 å¦‚æœ resolvePromise æˆ– rejectPromise å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥ä¹‹
                 */
                if (called) return;
                called = true;

                /**
                 * 2.3.3.3.4.2 å¦åˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise
                 */
                reject(e);
            }
        } else {
            // 2.3.3.4 å¦‚æœ then ä¸æ˜¯å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise
            resolve(x);
        }
    } else {
        // 2.3.4 å¦‚æœ x ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise
        return resolve(x);
    }
}
å¤åˆ¶ä»£ç 
```

# ä¸ƒã€å®Œæ•´çš„ Promises/A+ å®ç°

åˆ°è¿™é‡Œæˆ‘ä»¬çš„`myPromsie`å·²ç»å®Œæˆäº† **Promises/A+ è§„èŒƒ** ğŸ˜¸

> ES6çš„å®˜æ–¹Promiseè¿˜æœ‰å¾ˆå¤šAPIï¼Œä½†è¿™äº›éƒ½ä¸åœ¨Promises/A+é‡Œé¢

è¿™é‡Œä¸ºå¤§å®¶æä¾›äº†ä¸¤ä¸ªå®Œæ•´çš„ Promises/A+ å®ç°ç‰ˆæœ¬ï¼š

1. æ¸…çˆ½ç®€æ´ æ— æ³¨é‡Šç‰ˆ
2. æŒ‰æ­¥åˆ†æ æ³¨é‡ŠåŠ æŒç‰ˆ

## 1. æ¸…çˆ½ç®€æ´ æ— æ³¨é‡Šç‰ˆ

**å®Œæ•´çš„ Promises/A+ å®ç° `(æ¸…çˆ½ç®€æ´ æ— æ³¨é‡Šç‰ˆ)`ï¼š**

*å®Œæ•´ç‰ˆçš„ä»£ç è¾ƒé•¿ï¼Œè¿™é‡Œå¦‚æœçœ‹ä¸æ¸…æ¥šçš„å¯ä»¥å»æˆ‘çš„GitHubä¸Šçœ‹ï¼Œæˆ‘ä¸“é—¨ç»´æŠ¤äº†ä¸€ä¸ª æ‰‹å†™ Promsie çš„ä»“åº“*ï¼š[github.com/yuanyuanbytâ€¦](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyuanyuanbyte%2FPromise)

```javascript
class myPromise {
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';

    constructor(func) {
        this.PromiseState = myPromise.PENDING;
        this.PromiseResult = null;
        this.onFulfilledCallbacks = [];
        this.onRejectedCallbacks = [];
        try {
            func(this.resolve.bind(this), this.reject.bind(this));
        } catch (error) {
            this.reject(error)
        }
    }

    resolve(result) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
            this.onFulfilledCallbacks.forEach(callback => {
                callback(result)
            })
        }
    }

    reject(reason) {
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECTED;
            this.PromiseResult = reason;
            this.onRejectedCallbacks.forEach(callback => {
                callback(reason)
            })
        }
    }

    then(onFulfilled, onRejected) {
        let promise2 = new myPromise((resolve, reject) => {
            if (this.PromiseState === myPromise.FULFILLED) {
                setTimeout(() => {
                    try {
                        if (typeof onFulfilled !== 'function') {
                            resolve(this.PromiseResult);
                        } else {
                            let x = onFulfilled(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
                        }
                    } catch (e) {
                        reject(e);
                    }
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() => {
                    try {
                        if (typeof onRejected !== 'function') {
                            reject(this.PromiseResult);
                        } else {
                            let x = onRejected(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
                        }
                    } catch (e) {
                        reject(e)
                    }
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                this.onFulfilledCallbacks.push(() => {
                    setTimeout(() => {
                        try {
                            if (typeof onFulfilled !== 'function') {
                                resolve(this.PromiseResult);
                            } else {
                                let x = onFulfilled(this.PromiseResult);
                                resolvePromise(promise2, x, resolve, reject);
                            }
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
                this.onRejectedCallbacks.push(() => {
                    setTimeout(() => {
                        try {
                            if (typeof onRejected !== 'function') {
                                reject(this.PromiseResult);
                            } else {
                                let x = onRejected(this.PromiseResult);
                                resolvePromise(promise2, x, resolve, reject);
                            }
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
            }
        })

        return promise2
    }
}

function resolvePromise(promise2, x, resolve, reject) {
    if (x === promise2) {
        throw new TypeError('Chaining cycle detected for promise');
    }

    if (x instanceof myPromise) {
        x.then(y => {
            resolvePromise(promise2, y, resolve, reject)
        }, reject);
    } else if (x !== null && ((typeof x === 'object' || (typeof x === 'function')))) {
        try {
            var then = x.then;
        } catch (e) {
            return reject(e);
        }

        if (typeof then === 'function') {
            let called = false;
            try {
                then.call(
                    x,
                    y => {
                        if (called) return;
                        called = true;
                        resolvePromise(promise2, y, resolve, reject);
                    },
                    r => {
                        if (called) return;
                        called = true;
                        reject(r);
                    }
                )
            } catch (e) {
                if (called) return;
                called = true;

                reject(e);
            }
        } else {
            resolve(x);
        }
    } else {
        return resolve(x);
    }
}
å¤åˆ¶ä»£ç 
```

## 2. æŒ‰æ­¥åˆ†æ æ³¨é‡ŠåŠ æŒç‰ˆ

**å®Œæ•´çš„ Promises/A+ å®ç° `(æŒ‰æ­¥åˆ†æ æ³¨é‡ŠåŠ æŒç‰ˆ)`ï¼š**

*å®Œæ•´ç‰ˆçš„ä»£ç è¾ƒé•¿ï¼Œè¿™é‡Œå¦‚æœçœ‹ä¸æ¸…æ¥šçš„å¯ä»¥å»æˆ‘çš„GitHubä¸Šçœ‹ï¼Œæˆ‘ä¸“é—¨ç»´æŠ¤äº†ä¸€ä¸ª æ‰‹å†™ Promsie çš„ä»“åº“*ï¼š[github.com/yuanyuanbytâ€¦](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyuanyuanbyte%2FPromise)

```javascript
class myPromise {
    // ç”¨staticåˆ›å»ºé™æ€å±æ€§ï¼Œç”¨æ¥ç®¡ç†çŠ¶æ€
    static PENDING = 'pending';
    static FULFILLED = 'fulfilled';
    static REJECTED = 'rejected';

    // æ„é€ å‡½æ•°ï¼šé€šè¿‡newå‘½ä»¤ç”Ÿæˆå¯¹è±¡å®ä¾‹æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ç±»çš„æ„é€ å‡½æ•°
    constructor(func) { // ç»™ç±»çš„æ„é€ æ–¹æ³•constructoræ·»åŠ ä¸€ä¸ªå‚æ•°func
        this.PromiseState = myPromise.PENDING; // æŒ‡å®šPromiseå¯¹è±¡çš„çŠ¶æ€å±æ€§ PromiseStateï¼Œåˆå§‹å€¼ä¸ºpending
        this.PromiseResult = null; // æŒ‡å®šPromiseå¯¹è±¡çš„ç»“æœ PromiseResult
        this.onFulfilledCallbacks = []; // ä¿å­˜æˆåŠŸå›è°ƒ
        this.onRejectedCallbacks = []; // ä¿å­˜å¤±è´¥å›è°ƒ
        try {
            /**
             * func()ä¼ å…¥resolveå’Œrejectï¼Œ
             * resolve()å’Œreject()æ–¹æ³•åœ¨å¤–éƒ¨è°ƒç”¨ï¼Œè¿™é‡Œéœ€è¦ç”¨bindä¿®æ­£ä¸€ä¸‹thisæŒ‡å‘
             * new å¯¹è±¡å®ä¾‹æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œfunc()
             */
            func(this.resolve.bind(this), this.reject.bind(this));
        } catch (error) {
            // ç”Ÿæˆå®ä¾‹æ—¶(æ‰§è¡Œresolveå’Œreject)ï¼Œå¦‚æœæŠ¥é”™ï¼Œå°±æŠŠé”™è¯¯ä¿¡æ¯ä¼ å…¥ç»™reject()æ–¹æ³•ï¼Œå¹¶ä¸”ç›´æ¥æ‰§è¡Œreject()æ–¹æ³•
            this.reject(error)
        }
    }

    resolve(result) { // resultä¸ºæˆåŠŸæ€æ—¶æ¥æ”¶çš„ç»ˆå€¼
        // åªèƒ½ç”±pendingçŠ¶æ€ => fulfilledçŠ¶æ€ (é¿å…è°ƒç”¨å¤šæ¬¡resolve reject)
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.FULFILLED;
            this.PromiseResult = result;
            /**
             * åœ¨æ‰§è¡Œresolveæˆ–è€…rejectçš„æ—¶å€™ï¼Œéå†è‡ªèº«çš„callbacksæ•°ç»„ï¼Œ
             * çœ‹çœ‹æ•°ç»„é‡Œé¢æœ‰æ²¡æœ‰thené‚£è¾¹ ä¿ç•™ è¿‡æ¥çš„ å¾…æ‰§è¡Œå‡½æ•°ï¼Œ
             * ç„¶åé€ä¸ªæ‰§è¡Œæ•°ç»„é‡Œé¢çš„å‡½æ•°ï¼Œæ‰§è¡Œçš„æ—¶å€™ä¼šä¼ å…¥ç›¸åº”çš„å‚æ•°
             */
            this.onFulfilledCallbacks.forEach(callback => {
                callback(result)
            })
        }
    }

    reject(reason) { // reasonä¸ºæ‹’ç»æ€æ—¶æ¥æ”¶çš„ç»ˆå€¼
        // åªèƒ½ç”±pendingçŠ¶æ€ => rejectedçŠ¶æ€ (é¿å…è°ƒç”¨å¤šæ¬¡resolve reject)
        if (this.PromiseState === myPromise.PENDING) {
            this.PromiseState = myPromise.REJECTED;
            this.PromiseResult = reason;
            this.onRejectedCallbacks.forEach(callback => {
                callback(reason)
            })
        }
    }

    /**
     * [æ³¨å†ŒfulfilledçŠ¶æ€/rejectedçŠ¶æ€å¯¹åº”çš„å›è°ƒå‡½æ•°] 
     * @param {function} onFulfilled  fulfilledçŠ¶æ€æ—¶ æ‰§è¡Œçš„å‡½æ•°
     * @param {function} onRejected  rejectedçŠ¶æ€æ—¶ æ‰§è¡Œçš„å‡½æ•° 
     * @returns {function} newPromsie  è¿”å›ä¸€ä¸ªæ–°çš„promiseå¯¹è±¡
     */
    then(onFulfilled, onRejected) {
        // 2.2.7è§„èŒƒ then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡
        let promise2 = new myPromise((resolve, reject) => {
            if (this.PromiseState === myPromise.FULFILLED) {
                /**
                 * ä¸ºä»€ä¹ˆè¿™é‡Œè¦åŠ å®šæ—¶å™¨setTimeoutï¼Ÿ
                 * 2.2.4è§„èŒƒ onFulfilled å’Œ onRejected åªæœ‰åœ¨æ‰§è¡Œç¯å¢ƒå †æ ˆä»…åŒ…å«å¹³å°ä»£ç æ—¶æ‰å¯è¢«è°ƒç”¨ æ³¨1
                 * è¿™é‡Œçš„å¹³å°ä»£ç æŒ‡çš„æ˜¯å¼•æ“ã€ç¯å¢ƒä»¥åŠ promise çš„å®æ–½ä»£ç ã€‚
                 * å®è·µä¸­è¦ç¡®ä¿ onFulfilled å’Œ onRejected æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ then æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚
                 * è¿™ä¸ªäº‹ä»¶é˜Ÿåˆ—å¯ä»¥é‡‡ç”¨â€œå®ä»»åŠ¡ï¼ˆmacro-taskï¼‰â€æœºåˆ¶ï¼Œæ¯”å¦‚setTimeout æˆ–è€… setImmediateï¼› ä¹Ÿå¯ä»¥é‡‡ç”¨â€œå¾®ä»»åŠ¡ï¼ˆmicro-taskï¼‰â€æœºåˆ¶æ¥å®ç°ï¼Œ æ¯”å¦‚ MutationObserver æˆ–è€…process.nextTickã€‚
                 */
                setTimeout(() => {
                    try {
                        if (typeof onFulfilled !== 'function') {
                            // 2.2.7.3è§„èŒƒ å¦‚æœ onFulfilled ä¸æ˜¯å‡½æ•°ä¸” promise1 æˆåŠŸæ‰§è¡Œï¼Œ promise2 å¿…é¡»æˆåŠŸæ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„å€¼
                            resolve(this.PromiseResult);
                        } else {
                            // 2.2.7.1è§„èŒƒ å¦‚æœ onFulfilled æˆ–è€… onRejected è¿”å›ä¸€ä¸ªå€¼ x ï¼Œåˆ™è¿è¡Œä¸‹é¢çš„ Promise è§£å†³è¿‡ç¨‹ï¼š[[Resolve]](promise2, x)ï¼Œå³è¿è¡ŒresolvePromise()
                            let x = onFulfilled(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
                        }
                    } catch (e) {
                        // 2.2.7.2è§„èŒƒ å¦‚æœ onFulfilled æˆ–è€… onRejected æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ e ï¼Œåˆ™ promise2 å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å›  e
                        reject(e); // æ•è·å‰é¢onFulfilledä¸­æŠ›å‡ºçš„å¼‚å¸¸
                    }
                });
            } else if (this.PromiseState === myPromise.REJECTED) {
                setTimeout(() => {
                    try {
                        if (typeof onRejected !== 'function') {
                            // 2.2.7.4è§„èŒƒ å¦‚æœ onRejected ä¸æ˜¯å‡½æ•°ä¸” promise1 æ‹’ç»æ‰§è¡Œï¼Œ promise2 å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„æ®å› 
                            reject(this.PromiseResult);
                        } else {
                            let x = onRejected(this.PromiseResult);
                            resolvePromise(promise2, x, resolve, reject);
                        }
                    } catch (e) {
                        reject(e)
                    }
                });
            } else if (this.PromiseState === myPromise.PENDING) {
                // pending çŠ¶æ€ä¿å­˜çš„ onFulfilled() å’Œ onRejected() å›è°ƒä¹Ÿè¦ç¬¦åˆ 2.2.7.1ï¼Œ2.2.7.2ï¼Œ2.2.7.3 å’Œ 2.2.7.4 è§„èŒƒ
                this.onFulfilledCallbacks.push(() => {
                    setTimeout(() => {
                        try {
                            if (typeof onFulfilled !== 'function') {
                                resolve(this.PromiseResult);
                            } else {
                                let x = onFulfilled(this.PromiseResult);
                                resolvePromise(promise2, x, resolve, reject);
                            }
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
                this.onRejectedCallbacks.push(() => {
                    setTimeout(() => {
                        try {
                            if (typeof onRejected !== 'function') {
                                reject(this.PromiseResult);
                            } else {
                                let x = onRejected(this.PromiseResult);
                                resolvePromise(promise2, x, resolve, reject);
                            }
                        } catch (e) {
                            reject(e);
                        }
                    });
                });
            }
        })

        return promise2
    }
}

/**
 * å¯¹resolve()ã€reject() è¿›è¡Œæ”¹é€ å¢å¼º é’ˆå¯¹resolve()å’Œreject()ä¸­ä¸åŒå€¼æƒ…å†µ è¿›è¡Œå¤„ç†
 * @param  {promise} promise2 promise1.thenæ–¹æ³•è¿”å›çš„æ–°çš„promiseå¯¹è±¡
 * @param  {[type]} x         promise1ä¸­onFulfilledæˆ–onRejectedçš„è¿”å›å€¼
 * @param  {[type]} resolve   promise2çš„resolveæ–¹æ³•
 * @param  {[type]} reject    promise2çš„rejectæ–¹æ³•
 */
function resolvePromise(promise2, x, resolve, reject) {
    // 2.3.1è§„èŒƒ å¦‚æœ promise å’Œ x æŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œä»¥ TypeError ä¸ºæ®å› æ‹’ç»æ‰§è¡Œ promise
    if (x === promise2) {
        throw new TypeError('Chaining cycle detected for promise');
    }

    if (x instanceof myPromise) {
        /**
         * 2.3.2 å¦‚æœ x ä¸º Promise ï¼Œåˆ™ä½¿ promise2 æ¥å— x çš„çŠ¶æ€
         *       ä¹Ÿå°±æ˜¯ç»§ç»­æ‰§è¡Œxï¼Œå¦‚æœæ‰§è¡Œçš„æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªyï¼Œè¿˜è¦ç»§ç»­è§£æy
         */
        x.then(y => {
            resolvePromise(promise2, y, resolve, reject)
        }, reject);
    } else if (x !== null && ((typeof x === 'object' || (typeof x === 'function')))) {
        // 2.3.3 å¦‚æœ x ä¸ºå¯¹è±¡æˆ–å‡½æ•°
        try {
            // 2.3.3.1 æŠŠ x.then èµ‹å€¼ç»™ then
            var then = x.then;
        } catch (e) {
            // 2.3.3.2 å¦‚æœå– x.then çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ e ï¼Œåˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise
            return reject(e);
        }

        /**
         * 2.3.3.3 
         * å¦‚æœ then æ˜¯å‡½æ•°ï¼Œå°† x ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ this è°ƒç”¨ä¹‹ã€‚
         * ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œ
         * ç¬¬ä¸€ä¸ªå‚æ•°å«åš `resolvePromise` ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš `rejectPromise`
         */
        if (typeof then === 'function') {
            // 2.3.3.3.3 å¦‚æœ resolvePromise å’Œ rejectPromise å‡è¢«è°ƒç”¨ï¼Œæˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨
            let called = false; // é¿å…å¤šæ¬¡è°ƒç”¨
            try {
                then.call(
                    x,
                    // 2.3.3.3.1 å¦‚æœ resolvePromise ä»¥å€¼ y ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ [[Resolve]](promise, y)
                    y => {
                        if (called) return;
                        called = true;
                        resolvePromise(promise2, y, resolve, reject);
                    },
                    // 2.3.3.3.2 å¦‚æœ rejectPromise ä»¥æ®å›  r ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  r æ‹’ç» promise
                    r => {
                        if (called) return;
                        called = true;
                        reject(r);
                    }
                )
            } catch (e) {
                /**
                 * 2.3.3.3.4 å¦‚æœè°ƒç”¨ then æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ e
                 * 2.3.3.3.4.1 å¦‚æœ resolvePromise æˆ– rejectPromise å·²ç»è¢«è°ƒç”¨ï¼Œåˆ™å¿½ç•¥ä¹‹
                 */
                if (called) return;
                called = true;

                // 2.3.3.3.4.2 å¦åˆ™ä»¥ e ä¸ºæ®å› æ‹’ç» promise
                reject(e);
            }
        } else {
            // 2.3.3.4 å¦‚æœ then ä¸æ˜¯å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise
            resolve(x);
        }
    } else {
        // 2.3.4 å¦‚æœ x ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise
        return resolve(x);
    }
}
å¤åˆ¶ä»£ç 
```

# å…«ã€Promise A+ æµ‹è¯•

å¦‚ä½•è¯æ˜æˆ‘ä»¬å†™çš„`myPromise`å°±ç¬¦åˆ **Promises/A+** è§„èŒƒå‘¢ï¼Ÿ

è·‘ä¸€ä¸‹ Promise A+ æµ‹è¯• å°±å¥½å•¦~

## 1. å®‰è£…å®˜æ–¹æµ‹è¯•å·¥å…·

æˆ‘ä»¬ä½¿ç”¨Promises/A+å®˜æ–¹çš„æµ‹è¯•å·¥å…· [promises-aplus-tests](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpromises-aplus%2Fpromises-tests) æ¥å¯¹æˆ‘ä»¬çš„`myPromise`è¿›è¡Œæµ‹è¯•

**å®‰è£… `promises-aplus-tests`:**

```shell
npm install promises-aplus-tests -D
å¤åˆ¶ä»£ç 
```

**å®‰è£…å®Œæµ‹è¯•å·¥å…·åçš„é¡¹ç›®ç›®å½•ï¼š**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f7151919f5a44882b61466d0e2cf7d31~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

## 2.  ä½¿ç”¨ CommonJS å¯¹å¤–æš´éœ² myPromise ç±»

```javascript
class myPromise {
	...
}

function resolvePromise(promise2, x, resolve, reject) { 
	...
}

+ module.exports = myPromise;
å¤åˆ¶ä»£ç 
```

## 3. å®ç°é™æ€æ–¹æ³• deferred

è¦ä½¿ç”¨ `promises-aplus-tests` è¿™ä¸ªå·¥å…·æµ‹è¯•ï¼Œå¿…é¡»å®ç°ä¸€ä¸ªé™æ€æ–¹æ³•`deferred()`ï¼Œå®˜æ–¹å¯¹è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹:

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/370aab7c0bed4cd6b360ddee24b0cd0d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

æ„æ€å°±æ˜¯ï¼š

æˆ‘ä»¬è¦ç»™è‡ªå·±æ‰‹å†™çš„`myPromise`ä¸Šå®ç°ä¸€ä¸ªé™æ€æ–¹æ³•`deferred()`ï¼Œè¯¥æ–¹æ³•è¦è¿”å›ä¸€ä¸ªåŒ…å«`{ promise, resolve, reject }`çš„å¯¹è±¡ï¼š

- `promise` æ˜¯ä¸€ä¸ªå¤„äº`pending`çŠ¶æ€çš„ Promsieã€‚
- `resolve(value)` ç”¨`value`è§£å†³ä¸Šé¢é‚£ä¸ª`promise`
- `reject(reason)` ç”¨`reason`æ‹’ç»ä¸Šé¢é‚£ä¸ª`promise`

**`deferred()`çš„å®ç°å¦‚ä¸‹ï¼š**

```javascript
class myPromise {
	...
}

function resolvePromise(promise2, x, resolve, reject) { 
	...
}

+  myPromise.deferred = function () {
+      let result = {};
+      result.promise = new myPromise((resolve, reject) => {
+          result.resolve = resolve;
+          result.reject = reject;
+      });
+      return result;
+  }

module.exports = myPromise;
å¤åˆ¶ä»£ç 
```

## 4. é…ç½® package.json

æˆ‘ä»¬å®ç°äº†`deferred `æ–¹æ³•ï¼Œä¹Ÿé€šè¿‡ CommonJS å¯¹å¤–æš´éœ²äº†`myPromise`ï¼Œæœ€åé…ç½®ä¸€ä¸‹`package.json`å°±å¯ä»¥è·‘æµ‹è¯•å•¦~ğŸ˜º

æ–°å»ºä¸€ä¸ª `package.json` ï¼Œ**é…ç½®å¦‚ä¸‹ï¼š**

```javascript
// package.json
{
  "devDependencies": {
    "promises-aplus-tests": "^2.1.2"
  },
  "scripts": {
    "test": "promises-aplus-tests myPromise"
  }
}
å¤åˆ¶ä»£ç 
```

**é¡¹ç›®ç›®å½•ï¼š**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/830bd69f1d4f42c397004c45e954e33a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å‡†å¤‡å·¥ä½œå·²å°±ç»ªğŸ‘ğŸ‘ğŸ‘

æ¿€åŠ¨äººå¿ƒçš„æ—¶åˆ»é©¬ä¸Šå°±è¦åˆ°å•¦ï¼Œå˜¿å˜¿ğŸ˜¸

## 5. å®Œç¾é€šè¿‡å®˜æ–¹872ä¸ªæµ‹è¯•ç”¨ä¾‹

**æ‰§è¡Œæµ‹è¯•å‘½ä»¤ï¼š**

```shell
npm run test
å¤åˆ¶ä»£ç 
```

è‚¯å®šéƒ½ç­‰ä¸åŠäº†å§~ğŸ˜œ å¿«æ¥çœ‹çœ‹æˆ‘ä»¬çš„æµ‹è¯•ç»“æœå§ï¼Œèµ°èµ· ğŸš€

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/93d8240233514a888b2276a84afbbcb3~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

Promises/A+ æµ‹è¯•æ€»å…±872ç”¨ä¾‹ï¼Œæˆ‘ä»¬å†™çš„Promiseå®Œç¾é€šè¿‡äº†æ‰€æœ‰ç”¨ä¾‹:

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/825b38548ff847b1afbd4342da1aebad~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

# ä¹ã€å…¶ä»–æ–¹æ³•

åœ¨ ES6 çš„å®˜æ–¹ Promise è¿˜æœ‰å¾ˆå¤šAPIï¼Œæ¯”å¦‚ï¼š

- Promise.resolve
- Promise.reject
- Promise.prototype.catch
- Promise.prototype.finally
- Promise.all
- Promise.allSettled
- Promise.race

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5d7cd1a55e1342019cb28ba1405a9da5~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

è™½ç„¶è¿™äº›éƒ½ä¸åœ¨ Promises/A+ è§„èŒƒé‡Œé¢ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿæ¥å®ç°ä¸€ä¸‹å§ï¼ŒåŠ æ·±ç†è§£ã€‚å…¶å®æˆ‘ä»¬å‰é¢æˆ‘ä»¬ç”¨äº†å¾ˆå¤§åŠŸå¤«å®ç°äº† Promises/A+ ï¼Œç°åœ¨å†æ¥å®ç°è¿™äº›å·²ç»æ˜¯å°èœä¸€ç¢Ÿäº†ï¼Œå› ä¸ºè¿™äº›APIå…¨éƒ¨æ˜¯å‰é¢çš„å°è£…è€Œå·²ã€‚

## 1. å®ç° Promise.resolve

## 2. å®ç° Promise.reject

## 3. å®ç° Promise.prototype.catch

## 4. å®ç° Promise.prototype.finally

## 5. å®ç° Promise.all

## 6. å®ç° Promise.allSettled

## 7. å®ç° Promise.any

## 8. å®ç° Promise.race()

*å› æ–‡ç« å­—æ•°é™åˆ¶ï¼ŒPromise å…¶ä»–æ–¹æ³•çš„æ‰‹å†™å®ç°å·²æ”¾åœ¨ä¸‹ç¯‡ï¼š* [çœ‹äº†å°±ä¼šï¼Œæ‰‹å†™ Promise å…¨éƒ¨ API æ•™ç¨‹ï¼ŒåŒ…æ‹¬å¤„äº TC39 ç¬¬å››é˜¶æ®µè‰æ¡ˆçš„ Promise.any()](https://juejin.cn/post/7044088065874198536)

# â¤ï¸ ç»“å°¾

å¦‚æœè¿™ç¯‡æ–‡ç«  **å¯¹ä½ çš„å­¦ä¹ ** æœ‰æ‰€ **å¸®åŠ©**ï¼Œæ¬¢è¿ **ç‚¹èµ** ğŸ‘ **æ”¶è—** â­ **ç•™è¨€** ğŸ“ ï¼Œ**ä½ çš„æ”¯æŒ** æ˜¯æˆ‘ **åˆ›ä½œåˆ†äº«** çš„ **åŠ¨åŠ›ï¼**

*å­¦ä¹ è¿‡ç¨‹ä¸­å¦‚æœæœ‰ç–‘é—®ï¼Œ[ç‚¹å‡»è¿™é‡Œ](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyuanyuanbyte%2FBlog)ï¼Œå¯ä»¥è·å¾—æˆ‘çš„è”ç³»æ–¹å¼ï¼Œä¸æˆ‘äº¤æµ~*

**å…³æ³¨å…¬ä¼—å·ã€Œå‰ç«¯åœ†åœ†ã€**ï¼Œç¬¬ä¸€æ—¶é—´è·å–æ–‡ç« æ›´æ–°ã€‚

**æ›´å¤šæ›´å…¨æ›´è¯¦ç»†** çš„ **ä¼˜è´¨å†…å®¹**ï¼Œ **[çŒ›æˆ³è¿™é‡ŒæŸ¥çœ‹](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyuanyuanbyte%2FBlog)**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd520cf6949f40fcae03b779c4019802~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

# å£°æ˜

æœ¬æ–‡ â€œç¬¬å››èŠ‚ï¼šå®ç°å¼‚æ­¥â€ ä¹‹å‰çš„å†…å®¹ éƒ½æ˜¯å­¦ä¹ è‡ªBç«™ upä¸» **æŠ€æœ¯è›‹è€å¸ˆ**ï¼š[www.bilibili.com/video/BV1RRâ€¦](https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RR4y1p7my)

*æ³¨ï¼šæœ¬ç¯‡æ–‡ç« çš„å†…å®¹æˆ‘å·²äº Bç«™ upä¸» **æŠ€æœ¯è›‹è€å¸ˆ** äº¤æµå¹¶å–å¾—è®¤å¯ï¼Œå·²ç»è·å¾—å…è´£ã€‚*

æ²¡æœ‰ è›‹è€å¸ˆ çš„è§†é¢‘ï¼Œè¿™ç¯‡æ–‡ç« å¯èƒ½è¦å¾ˆæ™šæ‰èƒ½è·Ÿå¤§å®¶è§é¢~

**è›‹è€å¸ˆ [space.bilibili.com/327247876](https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F327247876) çš„è§†é¢‘è´¨é‡éƒ½å¾ˆé«˜**ï¼ŒèŠ‚æµå’Œé˜²æŠ–æˆ‘å°±æ˜¯é€šè¿‡è›‹è€å¸ˆçš„è§†é¢‘å­¦ä¹ çš„ï¼Œé‡Œé¢è¿˜æœ‰å¾ˆå¤šè§†é¢‘å†…å®¹ï¼Œé€šä¿—æ˜“æ‡‚ï¼Œæˆ‘è‡ªå·±éƒ½åæ‚”æ²¡æœ‰æ—©ç‚¹æ¥è§¦è›‹è€å¸ˆï¼Œå°‘èµ°å¤šå°‘å¼¯è·¯å•Šï¼Œ**æ¬¢è¿å¤§å®¶æ”¯æŒå…³æ³¨è›‹è€å¸ˆ**ğŸ’~

# å‚è€ƒ



ç¬”è€…åˆšæ¥è§¦`async/await`æ—¶ï¼Œå°±è¢«å…¶æš‚åœæ‰§è¡Œçš„ç‰¹æ€§å¸å¼•äº†ï¼Œå¿ƒæƒ³åœ¨æ²¡æœ‰åŸç”ŸAPIæ”¯æŒçš„æƒ…å†µä¸‹ï¼Œawaitå±…ç„¶èƒ½æŒ‚èµ·å½“å‰æ–¹æ³•ï¼Œå®ç°æš‚åœæ‰§è¡Œï¼Œæˆ‘æ„Ÿåˆ°ååˆ†å¥½å¥‡ã€‚å¥½å¥‡å¿ƒé©±ä½¿æˆ‘ä¸€å±‚ä¸€å±‚å‰¥å¼€æœ‰å…³JSå¼‚æ­¥ç¼–ç¨‹çš„ä¸€åˆ‡ã€‚é˜…è¯»å®Œæœ¬æ–‡ï¼Œè¯»è€…åº”è¯¥èƒ½å¤Ÿäº†è§£ï¼š

1. `Promise`çš„å®ç°åŸç†
2. `async/await`çš„å®ç°åŸç†
3. `Generator`çš„å®ç°åŸç†

# Promiseå®ç°

åœ¨æˆæ–‡è¿‡ç¨‹ä¸­ï¼Œç¬”è€…æŸ¥é˜…äº†å¾ˆå¤šè®²è§£Promiseå®ç°çš„æ–‡ç« ï¼Œä½†æ„Ÿè§‰å¤§å¤šæ–‡ç« éƒ½å¾ˆéš¾ç§°å¾—ä¸Šæ¡ç†æ¸…æ™°ï¼Œæœ‰çš„ä¸Šæ¥å°±æ”¾å¤§æ®µPromiseè§„èŒƒç¿»è¯‘ï¼Œæœ‰çš„åœ¨PromiseåŸºç¡€ä½¿ç”¨ä¸Šæµªè´¹ç¯‡å¹…ï¼Œåˆæˆ–è€…æŠŠä¸€ä¸ªç®€å•çš„ä¸œè¥¿é•¿ç¯‡å¤§è®ºï¼Œè¿‡åº¦è®²è§£ï¼Œæˆ‘æ¨èå¤´é“çš„åŒå­¦ç›´æ¥æ‹‰åˆ°æœ¬ç« å°ç»“çœ‹æœ€ç»ˆå®ç°ï¼Œç»“åˆç€æ³¨é‡Šç›´æ¥å•ƒä»£ç ä¹Ÿèƒ½ç†è§£åä¹‹å…«ä¹

å›å½’æ­£é¢˜ï¼Œæ–‡ç« å¼€å¤´æˆ‘ä»¬å…ˆç‚¹ä¸€ä¸‹Promiseä¸ºæˆ‘ä»¬è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼šåœ¨ä¼ ç»Ÿçš„å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œå¦‚æœå¼‚æ­¥ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡å±‚å±‚åµŒå¥—å›è°ƒæ¥æ»¡è¶³è¿™ç§ä¾èµ–ï¼Œå¦‚æœåµŒå¥—å±‚æ•°è¿‡å¤šï¼Œå¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§éƒ½å˜å¾—å¾ˆå·®ï¼Œäº§ç”Ÿæ‰€è°“â€œå›è°ƒåœ°ç‹±â€ï¼Œè€ŒPromiseå°†å›è°ƒåµŒå¥—æ”¹ä¸ºé“¾å¼è°ƒç”¨ï¼Œå¢åŠ å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ªPromiseï¼š

## 1. è§‚å¯Ÿè€…æ¨¡å¼

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„Promiseä½¿ç”¨ï¼š

```javascript
const p1 = new Promise((resolve, reject) => {
    setTimeout(() => {
        resolve('result')
    },
    1000);
}) 

p1.then(res => console.log(res), err => console.log(err))
å¤åˆ¶ä»£ç 
```

è§‚å¯Ÿè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åˆ†æPromiseçš„è°ƒç”¨æµç¨‹ï¼š

- `Promise`çš„æ„é€ æ–¹æ³•æ¥æ”¶ä¸€ä¸ª`executor()`ï¼Œåœ¨`new Promise()`æ—¶å°±ç«‹åˆ»æ‰§è¡Œè¿™ä¸ªexecutorå›è°ƒ
- `executor()`å†…éƒ¨çš„å¼‚æ­¥ä»»åŠ¡è¢«æ”¾å…¥å®/å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ
- `then()`è¢«æ‰§è¡Œï¼Œæ”¶é›†æˆåŠŸ/å¤±è´¥å›è°ƒï¼Œæ”¾å…¥æˆåŠŸ/å¤±è´¥é˜Ÿåˆ—
- `executor()`çš„å¼‚æ­¥ä»»åŠ¡è¢«æ‰§è¡Œï¼Œè§¦å‘`resolve/reject`ï¼Œä»æˆåŠŸ/å¤±è´¥é˜Ÿåˆ—ä¸­å–å‡ºå›è°ƒä¾æ¬¡æ‰§è¡Œ

å…¶å®ç†Ÿæ‚‰è®¾è®¡æ¨¡å¼çš„åŒå­¦ï¼Œå¾ˆå®¹æ˜“å°±èƒ½æ„è¯†åˆ°è¿™æ˜¯ä¸ª**è§‚å¯Ÿè€…æ¨¡å¼**ï¼Œè¿™ç§`æ”¶é›†ä¾èµ– -> è§¦å‘é€šçŸ¥ -> å–å‡ºä¾èµ–æ‰§è¡Œ` çš„æ–¹å¼ï¼Œè¢«å¹¿æ³›è¿ç”¨äºè§‚å¯Ÿè€…æ¨¡å¼çš„å®ç°ï¼Œåœ¨Promiseé‡Œï¼Œæ‰§è¡Œé¡ºåºæ˜¯`thenæ”¶é›†ä¾èµ– -> å¼‚æ­¥è§¦å‘resolve -> resolveæ‰§è¡Œä¾èµ–`ã€‚ä¾æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å‹¾å‹’å‡ºPromiseçš„å¤§è‡´å½¢çŠ¶ï¼š

```js
class MyPromise {
  // æ„é€ æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå›è°ƒ
  constructor(executor) {
    this._resolveQueue = []    // thenæ”¶é›†çš„æ‰§è¡ŒæˆåŠŸçš„å›è°ƒé˜Ÿåˆ—
    this._rejectQueue = []     // thenæ”¶é›†çš„æ‰§è¡Œå¤±è´¥çš„å›è°ƒé˜Ÿåˆ—

    // ç”±äºresolve/rejectæ˜¯åœ¨executorå†…éƒ¨è¢«è°ƒç”¨, å› æ­¤éœ€è¦ä½¿ç”¨ç®­å¤´å‡½æ•°å›ºå®šthisæŒ‡å‘, å¦åˆ™æ‰¾ä¸åˆ°this._resolveQueue
    let _resolve = (val) => {
      // ä»æˆåŠŸé˜Ÿåˆ—é‡Œå–å‡ºå›è°ƒä¾æ¬¡æ‰§è¡Œ
      while(this._resolveQueue.length) {
        const callback = this._resolveQueue.shift()
        callback(val)
      }
    }
    // å®ç°åŒresolve
    let _reject = (val) => {
      while(this._rejectQueue.length) {
        const callback = this._rejectQueue.shift()
        callback(val)
      }
    }
    // new Promise()æ—¶ç«‹å³æ‰§è¡Œexecutor,å¹¶ä¼ å…¥resolveå’Œreject
    executor(_resolve, _reject)
  }

  // thenæ–¹æ³•,æ¥æ”¶ä¸€ä¸ªæˆåŠŸçš„å›è°ƒå’Œä¸€ä¸ªå¤±è´¥çš„å›è°ƒï¼Œå¹¶pushè¿›å¯¹åº”é˜Ÿåˆ—
  then(resolveFn, rejectFn) {
    this._resolveQueue.push(resolveFn)
    this._rejectQueue.push(rejectFn)
  }
}
å¤åˆ¶ä»£ç 
```

å†™å®Œä»£ç æˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹:

```js
const p1 = new MyPromise((resolve, reject) => {
  setTimeout(() => {
    resolve('result')
  }, 1000);
})
p1.then(res => console.log(res))
//ä¸€ç§’åè¾“å‡ºresult
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬è¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ç®€å•çš„å®ç°äº†ä¸€ä¸‹`then`å’Œ`resolve`ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨thenæ–¹æ³•çš„å›è°ƒé‡Œå–å¾—å¼‚æ­¥æ“ä½œçš„è¿”å›å€¼ï¼Œä½†æˆ‘ä»¬è¿™ä¸ªPromiseç¦»æœ€ç»ˆå®ç°è¿˜æœ‰å¾ˆé•¿çš„è·ç¦»ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥è¡¥å……è¿™ä¸ªPromiseï¼š

## 2. Promise A+è§„èŒƒ

ä¸Šé¢æˆ‘ä»¬å·²ç»ç®€å•åœ°å®ç°äº†ä¸€ä¸ªè¶…ä½é…ç‰ˆPromiseï¼Œä½†æˆ‘ä»¬ä¼šçœ‹åˆ°å¾ˆå¤šæ–‡ç« å’Œæˆ‘ä»¬å†™çš„ä¸ä¸€æ ·ï¼Œä»–ä»¬çš„Promiseå®ç°ä¸­è¿˜å¼•å…¥äº†å„ç§çŠ¶æ€æ§åˆ¶ï¼Œè¿™æ˜¯ç”±äºES6çš„Promiseå®ç°éœ€è¦éµå¾ª[Promise/A+è§„èŒƒ](https://link.juejin.cn?target=https%3A%2F%2Fpromisesaplus.com%2F)ï¼Œæ˜¯è§„èŒƒå¯¹Promiseçš„çŠ¶æ€æ§åˆ¶åšäº†è¦æ±‚ã€‚Promise/A+çš„è§„èŒƒæ¯”è¾ƒé•¿ï¼Œè¿™é‡Œåªæ€»ç»“ä¸¤æ¡æ ¸å¿ƒè§„åˆ™ï¼š

> 1. Promiseæœ¬è´¨æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œä¸”çŠ¶æ€åªèƒ½ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š`Pendingï¼ˆç­‰å¾…æ€ï¼‰`ã€`Fulfilledï¼ˆæ‰§è¡Œæ€ï¼‰`ã€`Rejectedï¼ˆæ‹’ç»æ€ï¼‰`ï¼ŒçŠ¶æ€çš„å˜æ›´æ˜¯å•å‘çš„ï¼Œåªèƒ½ä»Pending -> Fulfilled æˆ– Pending -> Rejectedï¼ŒçŠ¶æ€å˜æ›´ä¸å¯é€†
> 2. `thenæ–¹æ³•`æ¥æ”¶ä¸¤ä¸ªå¯é€‰å‚æ•°ï¼Œåˆ†åˆ«å¯¹åº”çŠ¶æ€æ”¹å˜æ—¶è§¦å‘çš„å›è°ƒã€‚thenæ–¹æ³•è¿”å›ä¸€ä¸ªpromiseã€‚then æ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ª promise è°ƒç”¨å¤šæ¬¡ã€‚

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/2/26/161d2454e68ff07b~tplv-t2oaga2asx-zoom-in-crop-mark:1512:0:0:0.awebp) æ ¹æ®è§„èŒƒï¼Œæˆ‘ä»¬è¡¥å……ä¸€ä¸‹Promiseçš„ä»£ç ï¼š

```js
//Promise/A+è§„èŒƒçš„ä¸‰ç§çŠ¶æ€
const PENDING = 'pending'
const FULFILLED = 'fulfilled'
const REJECTED = 'rejected'

class MyPromise {
  // æ„é€ æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå›è°ƒ
  constructor(executor) {
    this._status = PENDING     // PromiseçŠ¶æ€
    this._resolveQueue = []    // æˆåŠŸé˜Ÿåˆ—, resolveæ—¶è§¦å‘
    this._rejectQueue = []     // å¤±è´¥é˜Ÿåˆ—, rejectæ—¶è§¦å‘

    // ç”±äºresolve/rejectæ˜¯åœ¨executorå†…éƒ¨è¢«è°ƒç”¨, å› æ­¤éœ€è¦ä½¿ç”¨ç®­å¤´å‡½æ•°å›ºå®šthisæŒ‡å‘, å¦åˆ™æ‰¾ä¸åˆ°this._resolveQueue
    let _resolve = (val) => {
      if(this._status !== PENDING) return   // å¯¹åº”è§„èŒƒä¸­çš„"çŠ¶æ€åªèƒ½ç”±pendingåˆ°fulfilledæˆ–rejected"
      this._status = FULFILLED              // å˜æ›´çŠ¶æ€

      // è¿™é‡Œä¹‹æ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªé˜Ÿåˆ—æ¥å‚¨å­˜å›è°ƒ,æ˜¯ä¸ºäº†å®ç°è§„èŒƒè¦æ±‚çš„ "then æ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ª promise è°ƒç”¨å¤šæ¬¡"
      // å¦‚æœä½¿ç”¨ä¸€ä¸ªå˜é‡è€Œéé˜Ÿåˆ—æ¥å‚¨å­˜å›è°ƒ,é‚£ä¹ˆå³ä½¿å¤šæ¬¡p1.then()ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡å›è°ƒ
      while(this._resolveQueue.length) {    
        const callback = this._resolveQueue.shift()
        callback(val)
      }
    }
    // å®ç°åŒresolve
    let _reject = (val) => {
      if(this._status !== PENDING) return   // å¯¹åº”è§„èŒƒä¸­çš„"çŠ¶æ€åªèƒ½ç”±pendingåˆ°fulfilledæˆ–rejected"
      this._status = REJECTED               // å˜æ›´çŠ¶æ€
      while(this._rejectQueue.length) {
        const callback = this._rejectQueue.shift()
        callback(val)
      }
    }
    // new Promise()æ—¶ç«‹å³æ‰§è¡Œexecutor,å¹¶ä¼ å…¥resolveå’Œreject
    executor(_resolve, _reject)
  }

  // thenæ–¹æ³•,æ¥æ”¶ä¸€ä¸ªæˆåŠŸçš„å›è°ƒå’Œä¸€ä¸ªå¤±è´¥çš„å›è°ƒ
  then(resolveFn, rejectFn) {
    this._resolveQueue.push(resolveFn)
    this._rejectQueue.push(rejectFn)
  }
}
å¤åˆ¶ä»£ç 
```

## 3. thençš„é“¾å¼è°ƒç”¨

è¡¥å……å®Œè§„èŒƒï¼Œæˆ‘ä»¬æ¥ç€æ¥å®ç°é“¾å¼è°ƒç”¨ï¼Œè¿™æ˜¯Promiseå®ç°çš„é‡ç‚¹å’Œéš¾ç‚¹ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹thenæ˜¯å¦‚ä½•é“¾å¼è°ƒç”¨çš„ï¼š

```js
const p1 = new Promise((resolve, reject) => {
  resolve(1)
})

p1
  .then(res => {
    console.log(res)
    //thenå›è°ƒä¸­å¯ä»¥returnä¸€ä¸ªPromise
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        resolve(2)
      }, 1000);
    })
  })
  .then(res => {
    console.log(res)
    //thenå›è°ƒä¸­ä¹Ÿå¯ä»¥returnä¸€ä¸ªå€¼
    return 3
  })
  .then(res => {
    console.log(res)
  })
å¤åˆ¶ä»£ç 
```

è¾“å‡º

```
1
2
3
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬æ€è€ƒä¸€ä¸‹å¦‚ä½•å®ç°è¿™ç§é“¾å¼è°ƒç”¨ï¼š

1. æ˜¾ç„¶`.then()`éœ€è¦è¿”å›ä¸€ä¸ªPromiseï¼Œè¿™æ ·æ‰èƒ½æ‰¾åˆ°thenæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæŠŠthenæ–¹æ³•çš„è¿”å›å€¼åŒ…è£…æˆPromiseã€‚
2. `.then()`çš„å›è°ƒéœ€è¦æ‹¿åˆ°ä¸Šä¸€ä¸ª`.then()`çš„è¿”å›å€¼
3. `.then()`çš„å›è°ƒéœ€è¦é¡ºåºæ‰§è¡Œï¼Œä»¥ä¸Šé¢è¿™æ®µä»£ç ä¸ºä¾‹ï¼Œè™½ç„¶ä¸­é—´returnäº†ä¸€ä¸ªPromiseï¼Œä½†æ‰§è¡Œé¡ºåºä»è¦ä¿è¯æ˜¯1->2->3ã€‚æˆ‘ä»¬è¦ç­‰å¾…å½“å‰PromiseçŠ¶æ€å˜æ›´åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªthenæ”¶é›†çš„å›è°ƒï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬å¯¹thençš„è¿”å›å€¼åˆ†ç±»è®¨è®º

```js
// thenæ–¹æ³•
then(resolveFn, rejectFn) {
  //returnä¸€ä¸ªæ–°çš„promise
  return new MyPromise((resolve, reject) => {
    //æŠŠresolveFné‡æ–°åŒ…è£…ä¸€ä¸‹,å†pushè¿›resolveæ‰§è¡Œé˜Ÿåˆ—,è¿™æ˜¯ä¸ºäº†èƒ½å¤Ÿè·å–å›è°ƒçš„è¿”å›å€¼è¿›è¡Œåˆ†ç±»è®¨è®º
    const fulfilledFn = value => {
      try {
        //æ‰§è¡Œç¬¬ä¸€ä¸ª(å½“å‰çš„)Promiseçš„æˆåŠŸå›è°ƒ,å¹¶è·å–è¿”å›å€¼
        let x = resolveFn(value)
        //åˆ†ç±»è®¨è®ºè¿”å›å€¼,å¦‚æœæ˜¯Promise,é‚£ä¹ˆç­‰å¾…PromiseçŠ¶æ€å˜æ›´,å¦åˆ™ç›´æ¥resolve
        //è¿™é‡Œresolveä¹‹åï¼Œå°±èƒ½è¢«ä¸‹ä¸€ä¸ª.then()çš„å›è°ƒè·å–åˆ°è¿”å›å€¼ï¼Œä»è€Œå®ç°é“¾å¼è°ƒç”¨
        x instanceof MyPromise ? x.then(resolve, reject) : resolve(x)
      } catch (error) {
        reject(error)
      }
    }
    //æŠŠåç»­thenæ”¶é›†çš„ä¾èµ–éƒ½pushè¿›å½“å‰Promiseçš„æˆåŠŸå›è°ƒé˜Ÿåˆ—ä¸­(_rejectQueue), è¿™æ˜¯ä¸ºäº†ä¿è¯é¡ºåºè°ƒç”¨
    this._resolveQueue.push(fulfilledFn)

    //rejectåŒç†
    const rejectedFn  = error => {
      try {
        let x = rejectFn(error)
        x instanceof MyPromise ? x.then(resolve, reject) : resolve(x)
      } catch (error) {
        reject(error)
      }
    }
    this._rejectQueue.push(rejectedFn)
  })
}
å¤åˆ¶ä»£ç 
```

ç„¶åæˆ‘ä»¬å°±èƒ½æµ‹è¯•ä¸€ä¸‹é“¾å¼è°ƒç”¨ï¼š

```js
const p1 = new MyPromise((resolve, reject) => {
  setTimeout(() => {
    resolve(1)
  }, 500);
})

p1
  .then(res => {
    console.log(res)
    return 2
  })
  .then(res => {
    console.log(res)
    return 3
  })
  .then(res => {
    console.log(res)
  })

//è¾“å‡º 1 2 3
å¤åˆ¶ä»£ç 
```



## 4.å€¼ç©¿é€ & çŠ¶æ€å·²å˜æ›´çš„æƒ…å†µ

æˆ‘ä»¬å·²ç»åˆæ­¥å®Œæˆäº†é“¾å¼è°ƒç”¨ï¼Œä½†æ˜¯å¯¹äº then() æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜è¦ä¸¤ä¸ªç»†èŠ‚éœ€è¦å¤„ç†ä¸€ä¸‹

1. **å€¼ç©¿é€**ï¼šæ ¹æ®è§„èŒƒï¼Œå¦‚æœ then() æ¥æ”¶çš„å‚æ•°ä¸æ˜¯functionï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¿½ç•¥å®ƒã€‚å¦‚æœæ²¡æœ‰å¿½ç•¥ï¼Œå½“then()å›è°ƒä¸ä¸ºfunctionæ—¶å°†ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´é“¾å¼è°ƒç”¨ä¸­æ–­
2. **å¤„ç†çŠ¶æ€ä¸ºresolve/rejectçš„æƒ…å†µ**ï¼šå…¶å®æˆ‘ä»¬ä¸Šè¾¹ then() çš„å†™æ³•æ˜¯å¯¹åº”çŠ¶æ€ä¸º`padding`çš„æƒ…å†µï¼Œä½†æ˜¯æœ‰äº›æ—¶å€™ï¼Œresolve/reject åœ¨ then() ä¹‹å‰å°±è¢«æ‰§è¡Œï¼ˆæ¯”å¦‚`Promise.resolve().then()`ï¼‰ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™è¿˜æŠŠthen()å›è°ƒpushè¿›resolve/rejectçš„æ‰§è¡Œé˜Ÿåˆ—é‡Œï¼Œé‚£ä¹ˆå›è°ƒå°†ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› æ­¤å¯¹äºçŠ¶æ€å·²ç»å˜ä¸º`fulfilled`æˆ–`rejected`çš„æƒ…å†µï¼Œæˆ‘ä»¬ç›´æ¥æ‰§è¡Œthenå›è°ƒï¼š

```js
// thenæ–¹æ³•,æ¥æ”¶ä¸€ä¸ªæˆåŠŸçš„å›è°ƒå’Œä¸€ä¸ªå¤±è´¥çš„å›è°ƒ
  then(resolveFn, rejectFn) {
    // æ ¹æ®è§„èŒƒï¼Œå¦‚æœthençš„å‚æ•°ä¸æ˜¯functionï¼Œåˆ™æˆ‘ä»¬éœ€è¦å¿½ç•¥å®ƒ, è®©é“¾å¼è°ƒç”¨ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
    typeof resolveFn !== 'function' ? resolveFn = value => value : null
    typeof rejectFn !== 'function' ? rejectFn = reason => {
      throw new Error(reason instanceof Error? reason.message:reason);
    } : null
  
    // returnä¸€ä¸ªæ–°çš„promise
    return new MyPromise((resolve, reject) => {
      // æŠŠresolveFné‡æ–°åŒ…è£…ä¸€ä¸‹,å†pushè¿›resolveæ‰§è¡Œé˜Ÿåˆ—,è¿™æ˜¯ä¸ºäº†èƒ½å¤Ÿè·å–å›è°ƒçš„è¿”å›å€¼è¿›è¡Œåˆ†ç±»è®¨è®º
      const fulfilledFn = value => {
        try {
          // æ‰§è¡Œç¬¬ä¸€ä¸ª(å½“å‰çš„)Promiseçš„æˆåŠŸå›è°ƒ,å¹¶è·å–è¿”å›å€¼
          let x = resolveFn(value)
          // åˆ†ç±»è®¨è®ºè¿”å›å€¼,å¦‚æœæ˜¯Promise,é‚£ä¹ˆç­‰å¾…PromiseçŠ¶æ€å˜æ›´,å¦åˆ™ç›´æ¥resolve
          x instanceof MyPromise ? x.then(resolve, reject) : resolve(x)
        } catch (error) {
          reject(error)
        }
      }
  
      // rejectåŒç†
      const rejectedFn  = error => {
        try {
          let x = rejectFn(error)
          x instanceof MyPromise ? x.then(resolve, reject) : resolve(x)
        } catch (error) {
          reject(error)
        }
      }
  
      switch (this._status) {
        // å½“çŠ¶æ€ä¸ºpendingæ—¶,æŠŠthenå›è°ƒpushè¿›resolve/rejectæ‰§è¡Œé˜Ÿåˆ—,ç­‰å¾…æ‰§è¡Œ
        case PENDING:
          this._resolveQueue.push(fulfilledFn)
          this._rejectQueue.push(rejectedFn)
          break;
        // å½“çŠ¶æ€å·²ç»å˜ä¸ºresolve/rejectæ—¶,ç›´æ¥æ‰§è¡Œthenå›è°ƒ
        case FULFILLED:
          fulfilledFn(this._value)    // this._valueæ˜¯ä¸Šä¸€ä¸ªthenå›è°ƒreturnçš„å€¼(è§å®Œæ•´ç‰ˆä»£ç )
          break;
        case REJECTED:
          rejectedFn(this._value)
          break;
      }
    })
  }
å¤åˆ¶ä»£ç 
```



## 5.å…¼å®¹åŒæ­¥ä»»åŠ¡

å®Œæˆäº†thençš„é“¾å¼è°ƒç”¨ä»¥åï¼Œæˆ‘ä»¬å†å¤„ç†ä¸€ä¸ªå‰è¾¹çš„ç»†èŠ‚ï¼Œç„¶åæ”¾å‡ºå®Œæ•´ä»£ç ã€‚ä¸Šæ–‡æˆ‘ä»¬è¯´è¿‡ï¼ŒPromiseçš„æ‰§è¡Œé¡ºåºæ˜¯`new Promise -> then()æ”¶é›†å›è°ƒ -> resolve/rejectæ‰§è¡Œå›è°ƒ`ï¼Œè¿™ä¸€é¡ºåºæ˜¯å»ºç«‹åœ¨**executoræ˜¯å¼‚æ­¥ä»»åŠ¡**çš„å‰æä¸Šçš„ï¼Œå¦‚æœexecutoræ˜¯ä¸€ä¸ªåŒæ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆé¡ºåºå°±ä¼šå˜æˆ`new Promise -> resolve/rejectæ‰§è¡Œå›è°ƒ -> then()æ”¶é›†å›è°ƒ`ï¼Œresolveçš„æ‰§è¡Œè·‘åˆ°thenä¹‹å‰å»äº†ï¼Œä¸ºäº†å…¼å®¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬ç»™`resolve/reject`æ‰§è¡Œå›è°ƒçš„æ“ä½œåŒ…ä¸€ä¸ªsetTimeoutï¼Œè®©å®ƒå¼‚æ­¥æ‰§è¡Œã€‚

> è¿™é‡Œæ’ä¸€å¥ï¼Œæœ‰å…³è¿™ä¸ªsetTimeoutï¼Œå…¶å®è¿˜æœ‰ä¸€ç•ªå­¦é—®ã€‚è™½ç„¶è§„èŒƒæ²¡æœ‰è¦æ±‚å›è°ƒåº”è¯¥è¢«æ”¾è¿›å®ä»»åŠ¡é˜Ÿåˆ—è¿˜æ˜¯å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œä½†å…¶å®Promiseçš„é»˜è®¤å®ç°æ˜¯æ”¾è¿›äº†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬çš„å®ç°ï¼ˆåŒ…æ‹¬å¤§å¤šæ•°Promiseæ‰‹åŠ¨å®ç°å’Œpolyfillçš„è½¬åŒ–ï¼‰éƒ½æ˜¯ä½¿ç”¨setTimeoutæ”¾å…¥äº†å®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨MutationObserveræ¨¡æ‹Ÿå¾®ä»»åŠ¡ï¼‰

```js
//Promise/A+è§„å®šçš„ä¸‰ç§çŠ¶æ€
const PENDING = 'pending'
const FULFILLED = 'fulfilled'
const REJECTED = 'rejected'

class MyPromise {
  // æ„é€ æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå›è°ƒ
  constructor(executor) {
    this._status = PENDING     // PromiseçŠ¶æ€
    this._value = undefined    // å‚¨å­˜thenå›è°ƒreturnçš„å€¼
    this._resolveQueue = []    // æˆåŠŸé˜Ÿåˆ—, resolveæ—¶è§¦å‘
    this._rejectQueue = []     // å¤±è´¥é˜Ÿåˆ—, rejectæ—¶è§¦å‘

    // ç”±äºresolve/rejectæ˜¯åœ¨executorå†…éƒ¨è¢«è°ƒç”¨, å› æ­¤éœ€è¦ä½¿ç”¨ç®­å¤´å‡½æ•°å›ºå®šthisæŒ‡å‘, å¦åˆ™æ‰¾ä¸åˆ°this._resolveQueue
    let _resolve = (val) => {
      //æŠŠresolveæ‰§è¡Œå›è°ƒçš„æ“ä½œå°è£…æˆä¸€ä¸ªå‡½æ•°,æ”¾è¿›setTimeouté‡Œ,ä»¥å…¼å®¹executoræ˜¯åŒæ­¥ä»£ç çš„æƒ…å†µ
      const run = () => {
        if(this._status !== PENDING) return   // å¯¹åº”è§„èŒƒä¸­çš„"çŠ¶æ€åªèƒ½ç”±pendingåˆ°fulfilledæˆ–rejected"
        this._status = FULFILLED              // å˜æ›´çŠ¶æ€
        this._value = val                     // å‚¨å­˜å½“å‰value

        // è¿™é‡Œä¹‹æ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªé˜Ÿåˆ—æ¥å‚¨å­˜å›è°ƒ,æ˜¯ä¸ºäº†å®ç°è§„èŒƒè¦æ±‚çš„ "then æ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ª promise è°ƒç”¨å¤šæ¬¡"
        // å¦‚æœä½¿ç”¨ä¸€ä¸ªå˜é‡è€Œéé˜Ÿåˆ—æ¥å‚¨å­˜å›è°ƒ,é‚£ä¹ˆå³ä½¿å¤šæ¬¡p1.then()ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡å›è°ƒ
        while(this._resolveQueue.length) {    
          const callback = this._resolveQueue.shift()
          callback(val)
        }
      }
      setTimeout(run)
    }
    // å®ç°åŒresolve
    let _reject = (val) => {
      const run = () => {
        if(this._status !== PENDING) return   // å¯¹åº”è§„èŒƒä¸­çš„"çŠ¶æ€åªèƒ½ç”±pendingåˆ°fulfilledæˆ–rejected"
        this._status = REJECTED               // å˜æ›´çŠ¶æ€
        this._value = val                     // å‚¨å­˜å½“å‰value
        while(this._rejectQueue.length) {
          const callback = this._rejectQueue.shift()
          callback(val)
        }
      }
      setTimeout(run)
    }
    // new Promise()æ—¶ç«‹å³æ‰§è¡Œexecutor,å¹¶ä¼ å…¥resolveå’Œreject
    executor(_resolve, _reject)
  }

  // thenæ–¹æ³•,æ¥æ”¶ä¸€ä¸ªæˆåŠŸçš„å›è°ƒå’Œä¸€ä¸ªå¤±è´¥çš„å›è°ƒ
  then(resolveFn, rejectFn) {
    // æ ¹æ®è§„èŒƒï¼Œå¦‚æœthençš„å‚æ•°ä¸æ˜¯functionï¼Œåˆ™æˆ‘ä»¬éœ€è¦å¿½ç•¥å®ƒ, è®©é“¾å¼è°ƒç”¨ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
    typeof resolveFn !== 'function' ? resolveFn = value => value : null
    typeof rejectFn !== 'function' ? rejectFn = reason => {
      throw new Error(reason instanceof Error? reason.message:reason);
    } : null
  
    // returnä¸€ä¸ªæ–°çš„promise
    return new MyPromise((resolve, reject) => {
      // æŠŠresolveFné‡æ–°åŒ…è£…ä¸€ä¸‹,å†pushè¿›resolveæ‰§è¡Œé˜Ÿåˆ—,è¿™æ˜¯ä¸ºäº†èƒ½å¤Ÿè·å–å›è°ƒçš„è¿”å›å€¼è¿›è¡Œåˆ†ç±»è®¨è®º
      const fulfilledFn = value => {
        try {
          // æ‰§è¡Œç¬¬ä¸€ä¸ª(å½“å‰çš„)Promiseçš„æˆåŠŸå›è°ƒ,å¹¶è·å–è¿”å›å€¼
          let x = resolveFn(value)
          // åˆ†ç±»è®¨è®ºè¿”å›å€¼,å¦‚æœæ˜¯Promise,é‚£ä¹ˆç­‰å¾…PromiseçŠ¶æ€å˜æ›´,å¦åˆ™ç›´æ¥resolve
          x instanceof MyPromise ? x.then(resolve, reject) : resolve(x)
        } catch (error) {
          reject(error)
        }
      }
  
      // rejectåŒç†
      const rejectedFn  = error => {
        try {
          let x = rejectFn(error)
          x instanceof MyPromise ? x.then(resolve, reject) : resolve(x)
        } catch (error) {
          reject(error)
        }
      }
  
      switch (this._status) {
        // å½“çŠ¶æ€ä¸ºpendingæ—¶,æŠŠthenå›è°ƒpushè¿›resolve/rejectæ‰§è¡Œé˜Ÿåˆ—,ç­‰å¾…æ‰§è¡Œ
        case PENDING:
          this._resolveQueue.push(fulfilledFn)
          this._rejectQueue.push(rejectedFn)
          break;
        // å½“çŠ¶æ€å·²ç»å˜ä¸ºresolve/rejectæ—¶,ç›´æ¥æ‰§è¡Œthenå›è°ƒ
        case FULFILLED:
          fulfilledFn(this._value)    // this._valueæ˜¯ä¸Šä¸€ä¸ªthenå›è°ƒreturnçš„å€¼(è§å®Œæ•´ç‰ˆä»£ç )
          break;
        case REJECTED:
          rejectedFn(this._value)
          break;
      }
    })
  }
}
å¤åˆ¶ä»£ç 
```

ç„¶åæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªPromiseï¼š

```js
const p1 = new MyPromise((resolve, reject) => {
  resolve(1)          //åŒæ­¥executoræµ‹è¯•
})

p1
  .then(res => {
    console.log(res)
    return 2          //é“¾å¼è°ƒç”¨æµ‹è¯•
  })
  .then()             //å€¼ç©¿é€æµ‹è¯•
  .then(res => {
    console.log(res)
    return new MyPromise((resolve, reject) => {
      resolve(3)      //è¿”å›Promiseæµ‹è¯•
    })
  })
  .then(res => {
    console.log(res)
    throw new Error('rejectæµ‹è¯•')   //rejectæµ‹è¯•
  })
  .then(() => {}, err => {
    console.log(err)
  })

// è¾“å‡º 
// 1 
// 2 
// 3 
// Error: rejectæµ‹è¯•
å¤åˆ¶ä»£ç 
```

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†Promiseçš„ä¸»è¦åŠŸèƒ½`(ï½€âˆ€Â´)Î¨`å‰©ä¸‹çš„å‡ ä¸ªæ–¹æ³•éƒ½éå¸¸ç®€å•ï¼Œæˆ‘ä»¬é¡ºæ‰‹æ”¶æ‹¾æ‰ï¼š



## Promise.prototype.catch()

> `catch()æ–¹æ³•`è¿”å›ä¸€ä¸ªPromiseï¼Œå¹¶ä¸”å¤„ç†æ‹’ç»çš„æƒ…å†µã€‚å®ƒçš„è¡Œä¸ºä¸è°ƒç”¨Promise.prototype.then(undefined, onRejected) ç›¸åŒã€‚

```js
//catchæ–¹æ³•å…¶å®å°±æ˜¯æ‰§è¡Œä¸€ä¸‹thençš„ç¬¬äºŒä¸ªå›è°ƒ
catch(rejectFn) {
  return this.then(undefined, rejectFn)
}
å¤åˆ¶ä»£ç 
```



## Promise.prototype.finally()

> `finally()æ–¹æ³•`è¿”å›ä¸€ä¸ªPromiseã€‚åœ¨promiseç»“æŸæ—¶ï¼Œæ— è®ºç»“æœæ˜¯fulfilledæˆ–è€…æ˜¯rejectedï¼Œéƒ½ä¼šæ‰§è¡ŒæŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚åœ¨finallyä¹‹åï¼Œè¿˜å¯ä»¥ç»§ç»­thenã€‚å¹¶ä¸”ä¼šå°†å€¼åŸå°ä¸åŠ¨çš„ä¼ é€’ç»™åé¢çš„then

```js
//finallyæ–¹æ³•
finally(callback) {
  return this.then(
    value => MyPromise.resolve(callback()).then(() => value),             // MyPromise.resolveæ‰§è¡Œå›è°ƒ,å¹¶åœ¨thenä¸­returnç»“æœä¼ é€’ç»™åé¢çš„Promise
    reason => MyPromise.resolve(callback()).then(() => { throw reason })  // rejectåŒç†
  )
}
å¤åˆ¶ä»£ç 
```

PS. æœ‰åŒå­¦é—®æˆ‘`MyPromise.resolve(callback())`çš„æ„ä¹‰ï¼Œè¿™é‡Œè¡¥å……è§£é‡Šä¸€ä¸‹ï¼šè¿™ä¸ªå†™æ³•å…¶å®æ¶‰åŠåˆ°ä¸€ä¸ª`finally()`çš„ä½¿ç”¨ç»†èŠ‚ï¼Œ**finally()å¦‚æœreturnäº†ä¸€ä¸ªrejectçŠ¶æ€çš„Promiseï¼Œå°†ä¼šæ”¹å˜å½“å‰Promiseçš„çŠ¶æ€**ï¼Œè¿™ä¸ª`MyPromise.resolve`å°±ç”¨äºæ”¹å˜PromiseçŠ¶æ€ï¼Œåœ¨finally()æ²¡æœ‰è¿”å›rejectæ€Promiseæˆ–throwé”™è¯¯çš„æƒ…å†µä¸‹ï¼Œå»æ‰`MyPromise.resolve`ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼ˆæ¬¢è¿å¤§å®¶å‘æˆ‘æé—®ï¼Œå‹˜è¯¯çš„è¿‡ç¨‹ä¸­ä¹Ÿèƒ½å¾ˆå¥½åœ°åŠ æ·±è‡ªå·±å¯¹Promiseçš„ç†è§£ï¼Œå¤§å®¶å¯ä»¥åœ¨å„ä¸ªäº¤æµç¾¤é‡Œç›´æ¥@æˆ‘ï¼‰

> å‚è€ƒèµ„æ–™ï¼š[å¯¹ Promise.prototype.finally() çš„ç²—æµ…ç†è§£](https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2Ff0b94daf9bf7)



## Promise.resolve()

> `Promise.resolve(value)`æ–¹æ³•è¿”å›ä¸€ä¸ªä»¥ç»™å®šå€¼è§£æåçš„Promise å¯¹è±¡ã€‚å¦‚æœè¯¥å€¼ä¸ºpromiseï¼Œè¿”å›è¿™ä¸ªpromiseï¼›å¦‚æœè¿™ä¸ªå€¼æ˜¯thenableï¼ˆå³å¸¦æœ‰"then" æ–¹æ³•)ï¼‰ï¼Œè¿”å›çš„promiseä¼šâ€œè·Ÿéšâ€è¿™ä¸ªthenableçš„å¯¹è±¡ï¼Œé‡‡ç”¨å®ƒçš„æœ€ç»ˆçŠ¶æ€ï¼›å¦åˆ™è¿”å›çš„promiseå°†ä»¥æ­¤å€¼å®Œæˆã€‚æ­¤å‡½æ•°å°†ç±»promiseå¯¹è±¡çš„å¤šå±‚åµŒå¥—å±•å¹³ã€‚

```js
//é™æ€çš„resolveæ–¹æ³•
static resolve(value) {
  if(value instanceof MyPromise) return value // æ ¹æ®è§„èŒƒ, å¦‚æœå‚æ•°æ˜¯Promiseå®ä¾‹, ç›´æ¥returnè¿™ä¸ªå®ä¾‹
  return new MyPromise(resolve => resolve(value))
}
å¤åˆ¶ä»£ç 
```



## Promise.reject()

> `Promise.reject()`æ–¹æ³•è¿”å›ä¸€ä¸ªå¸¦æœ‰æ‹’ç»åŸå› çš„Promiseå¯¹è±¡ã€‚

```js
//é™æ€çš„rejectæ–¹æ³•
static reject(reason) {
  return new MyPromise((resolve, reject) => reject(reason))
}
å¤åˆ¶ä»£ç 
```



## Promise.all()

> `Promise.all(iterable)`æ–¹æ³•è¿”å›ä¸€ä¸ª Promise å®ä¾‹ï¼Œæ­¤å®ä¾‹åœ¨ iterable å‚æ•°å†…æ‰€æœ‰çš„ promise éƒ½â€œå®Œæˆï¼ˆresolvedï¼‰â€æˆ–å‚æ•°ä¸­ä¸åŒ…å« promise æ—¶å›è°ƒå®Œæˆï¼ˆresolveï¼‰ï¼›å¦‚æœå‚æ•°ä¸­  promise æœ‰ä¸€ä¸ªå¤±è´¥ï¼ˆrejectedï¼‰ï¼Œæ­¤å®ä¾‹å›è°ƒå¤±è´¥ï¼ˆrejectï¼‰ï¼Œå¤±è´¥åŸå› çš„æ˜¯ç¬¬ä¸€ä¸ªå¤±è´¥ promise çš„ç»“æœã€‚

```js
//é™æ€çš„allæ–¹æ³•
static all(promiseArr) {
  let index = 0
  let result = []
  return new MyPromise((resolve, reject) => {
    promiseArr.forEach((p, i) => {
      //Promise.resolve(p)ç”¨äºå¤„ç†ä¼ å…¥å€¼ä¸ä¸ºPromiseçš„æƒ…å†µ
      MyPromise.resolve(p).then(
        val => {
          index++
          result[i] = val
          //æ‰€æœ‰thenæ‰§è¡Œå, resolveç»“æœ
          if(index === promiseArr.length) {
            resolve(result)
          }
        },
        err => {
          //æœ‰ä¸€ä¸ªPromiseè¢«rejectæ—¶ï¼ŒMyPromiseçš„çŠ¶æ€å˜ä¸ºreject
          reject(err)
        }
      )
    })
  })
}
å¤åˆ¶ä»£ç 
```



## Promise.race()

> `Promise.race(iterable)`æ–¹æ³•è¿”å›ä¸€ä¸ª promiseï¼Œä¸€æ—¦è¿­ä»£å™¨ä¸­çš„æŸä¸ªpromiseè§£å†³æˆ–æ‹’ç»ï¼Œè¿”å›çš„ promiseå°±ä¼šè§£å†³æˆ–æ‹’ç»ã€‚

```js
static race(promiseArr) {
  return new MyPromise((resolve, reject) => {
    //åŒæ—¶æ‰§è¡ŒPromise,å¦‚æœæœ‰ä¸€ä¸ªPromiseçš„çŠ¶æ€å‘ç”Ÿæ”¹å˜,å°±å˜æ›´æ–°MyPromiseçš„çŠ¶æ€
    for (let p of promiseArr) {
      MyPromise.resolve(p).then(  //Promise.resolve(p)ç”¨äºå¤„ç†ä¼ å…¥å€¼ä¸ä¸ºPromiseçš„æƒ…å†µ
        value => {
          resolve(value)        //æ³¨æ„è¿™ä¸ªresolveæ˜¯ä¸Šè¾¹new MyPromiseçš„
        },
        err => {
          reject(err)
        }
      )
    }
  })
}
å¤åˆ¶ä»£ç 
```



## å®Œæ•´ä»£ç 

```js
//Promise/A+è§„å®šçš„ä¸‰ç§çŠ¶æ€
const PENDING = 'pending'
const FULFILLED = 'fulfilled'
const REJECTED = 'rejected'

class MyPromise {
  // æ„é€ æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå›è°ƒ
  constructor(executor) {
    this._status = PENDING     // PromiseçŠ¶æ€
    this._value = undefined    // å‚¨å­˜thenå›è°ƒreturnçš„å€¼
    this._resolveQueue = []    // æˆåŠŸé˜Ÿåˆ—, resolveæ—¶è§¦å‘
    this._rejectQueue = []     // å¤±è´¥é˜Ÿåˆ—, rejectæ—¶è§¦å‘

    // ç”±äºresolve/rejectæ˜¯åœ¨executorå†…éƒ¨è¢«è°ƒç”¨, å› æ­¤éœ€è¦ä½¿ç”¨ç®­å¤´å‡½æ•°å›ºå®šthisæŒ‡å‘, å¦åˆ™æ‰¾ä¸åˆ°this._resolveQueue
    let _resolve = (val) => {
      //æŠŠresolveæ‰§è¡Œå›è°ƒçš„æ“ä½œå°è£…æˆä¸€ä¸ªå‡½æ•°,æ”¾è¿›setTimeouté‡Œ,ä»¥å…¼å®¹executoræ˜¯åŒæ­¥ä»£ç çš„æƒ…å†µ
      const run = () => {
        if(this._status !== PENDING) return   // å¯¹åº”è§„èŒƒä¸­çš„"çŠ¶æ€åªèƒ½ç”±pendingåˆ°fulfilledæˆ–rejected"
        this._status = FULFILLED              // å˜æ›´çŠ¶æ€
        this._value = val                     // å‚¨å­˜å½“å‰value

        // è¿™é‡Œä¹‹æ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªé˜Ÿåˆ—æ¥å‚¨å­˜å›è°ƒ,æ˜¯ä¸ºäº†å®ç°è§„èŒƒè¦æ±‚çš„ "then æ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ª promise è°ƒç”¨å¤šæ¬¡"
        // å¦‚æœä½¿ç”¨ä¸€ä¸ªå˜é‡è€Œéé˜Ÿåˆ—æ¥å‚¨å­˜å›è°ƒ,é‚£ä¹ˆå³ä½¿å¤šæ¬¡p1.then()ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡å›è°ƒ
        while(this._resolveQueue.length) {    
          const callback = this._resolveQueue.shift()
          callback(val)
        }
      }
      setTimeout(run)
    }
    // å®ç°åŒresolve
    let _reject = (val) => {
      const run = () => {
        if(this._status !== PENDING) return   // å¯¹åº”è§„èŒƒä¸­çš„"çŠ¶æ€åªèƒ½ç”±pendingåˆ°fulfilledæˆ–rejected"
        this._status = REJECTED               // å˜æ›´çŠ¶æ€
        this._value = val                     // å‚¨å­˜å½“å‰value
        while(this._rejectQueue.length) {
          const callback = this._rejectQueue.shift()
          callback(val)
        }
      }
      setTimeout(run)
    }
    // new Promise()æ—¶ç«‹å³æ‰§è¡Œexecutor,å¹¶ä¼ å…¥resolveå’Œreject
    executor(_resolve, _reject)
  }

  // thenæ–¹æ³•,æ¥æ”¶ä¸€ä¸ªæˆåŠŸçš„å›è°ƒå’Œä¸€ä¸ªå¤±è´¥çš„å›è°ƒ
  then(resolveFn, rejectFn) {
    // æ ¹æ®è§„èŒƒï¼Œå¦‚æœthençš„å‚æ•°ä¸æ˜¯functionï¼Œåˆ™æˆ‘ä»¬éœ€è¦å¿½ç•¥å®ƒ, è®©é“¾å¼è°ƒç”¨ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
    typeof resolveFn !== 'function' ? resolveFn = value => value : null
    typeof rejectFn !== 'function' ? rejectFn = reason => {
      throw new Error(reason instanceof Error? reason.message:reason);
    } : null
  
    // returnä¸€ä¸ªæ–°çš„promise
    return new MyPromise((resolve, reject) => {
      // æŠŠresolveFné‡æ–°åŒ…è£…ä¸€ä¸‹,å†pushè¿›resolveæ‰§è¡Œé˜Ÿåˆ—,è¿™æ˜¯ä¸ºäº†èƒ½å¤Ÿè·å–å›è°ƒçš„è¿”å›å€¼è¿›è¡Œåˆ†ç±»è®¨è®º
      const fulfilledFn = value => {
        try {
          // æ‰§è¡Œç¬¬ä¸€ä¸ª(å½“å‰çš„)Promiseçš„æˆåŠŸå›è°ƒ,å¹¶è·å–è¿”å›å€¼
          let x = resolveFn(value)
          // åˆ†ç±»è®¨è®ºè¿”å›å€¼,å¦‚æœæ˜¯Promise,é‚£ä¹ˆç­‰å¾…PromiseçŠ¶æ€å˜æ›´,å¦åˆ™ç›´æ¥resolve
          x instanceof MyPromise ? x.then(resolve, reject) : resolve(x)
        } catch (error) {
          reject(error)
        }
      }
  
      // rejectåŒç†
      const rejectedFn  = error => {
        try {
          let x = rejectFn(error)
          x instanceof MyPromise ? x.then(resolve, reject) : resolve(x)
        } catch (error) {
          reject(error)
        }
      }
  
      switch (this._status) {
        // å½“çŠ¶æ€ä¸ºpendingæ—¶,æŠŠthenå›è°ƒpushè¿›resolve/rejectæ‰§è¡Œé˜Ÿåˆ—,ç­‰å¾…æ‰§è¡Œ
        case PENDING:
          this._resolveQueue.push(fulfilledFn)
          this._rejectQueue.push(rejectedFn)
          break;
        // å½“çŠ¶æ€å·²ç»å˜ä¸ºresolve/rejectæ—¶,ç›´æ¥æ‰§è¡Œthenå›è°ƒ
        case FULFILLED:
          fulfilledFn(this._value)    // this._valueæ˜¯ä¸Šä¸€ä¸ªthenå›è°ƒreturnçš„å€¼(è§å®Œæ•´ç‰ˆä»£ç )
          break;
        case REJECTED:
          rejectedFn(this._value)
          break;
      }
    })
  }

  //catchæ–¹æ³•å…¶å®å°±æ˜¯æ‰§è¡Œä¸€ä¸‹thençš„ç¬¬äºŒä¸ªå›è°ƒ
  catch(rejectFn) {
    return this.then(undefined, rejectFn)
  }

  //finallyæ–¹æ³•
  finally(callback) {
    return this.then(
      value => MyPromise.resolve(callback()).then(() => value),             //æ‰§è¡Œå›è°ƒ,å¹¶returnvalueä¼ é€’ç»™åé¢çš„then
      reason => MyPromise.resolve(callback()).then(() => { throw reason })  //rejectåŒç†
    )
  }

  //é™æ€çš„resolveæ–¹æ³•
  static resolve(value) {
    if(value instanceof MyPromise) return value //æ ¹æ®è§„èŒƒ, å¦‚æœå‚æ•°æ˜¯Promiseå®ä¾‹, ç›´æ¥returnè¿™ä¸ªå®ä¾‹
    return new MyPromise(resolve => resolve(value))
  }

  //é™æ€çš„rejectæ–¹æ³•
  static reject(reason) {
    return new MyPromise((resolve, reject) => reject(reason))
  }

  //é™æ€çš„allæ–¹æ³•
  static all(promiseArr) {
    let index = 0
    let result = []
    return new MyPromise((resolve, reject) => {
      promiseArr.forEach((p, i) => {
        //Promise.resolve(p)ç”¨äºå¤„ç†ä¼ å…¥å€¼ä¸ä¸ºPromiseçš„æƒ…å†µ
        MyPromise.resolve(p).then(
          val => {
            index++
            result[i] = val
            if(index === promiseArr.length) {
              resolve(result)
            }
          },
          err => {
            reject(err)
          }
        )
      })
    })
  }

  //é™æ€çš„raceæ–¹æ³•
  static race(promiseArr) {
    return new MyPromise((resolve, reject) => {
      //åŒæ—¶æ‰§è¡ŒPromise,å¦‚æœæœ‰ä¸€ä¸ªPromiseçš„çŠ¶æ€å‘ç”Ÿæ”¹å˜,å°±å˜æ›´æ–°MyPromiseçš„çŠ¶æ€
      for (let p of promiseArr) {
        MyPromise.resolve(p).then(  //Promise.resolve(p)ç”¨äºå¤„ç†ä¼ å…¥å€¼ä¸ä¸ºPromiseçš„æƒ…å†µ
          value => {
            resolve(value)        //æ³¨æ„è¿™ä¸ªresolveæ˜¯ä¸Šè¾¹new MyPromiseçš„
          },
          err => {
            reject(err)
          }
        )
      }
    })
  }
}
å¤åˆ¶ä»£ç 
```

æ´‹æ´‹æ´’æ´’150å¤šè¡Œçš„ä»£ç ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥ç»™Promiseçš„å®ç°åšä¸€ä¸ªç»“å°¾äº†ã€‚æˆ‘ä»¬ä»ä¸€ä¸ªæœ€ç®€å•çš„Promiseä½¿ç”¨å®ä¾‹å¼€å§‹ï¼Œé€šè¿‡å¯¹è°ƒç”¨æµç¨‹çš„åˆ†æï¼Œæ ¹æ®è§‚å¯Ÿè€…æ¨¡å¼å®ç°äº†Promiseçš„å¤§è‡´éª¨æ¶ï¼Œç„¶åä¾æ®Promise/A+è§„èŒƒå¡«å……ä»£ç ï¼Œé‡ç‚¹å®ç°äº†then çš„é“¾å¼è°ƒç”¨ï¼Œæœ€åå®Œæˆäº†Promiseçš„é™æ€/å®ä¾‹æ–¹æ³•ã€‚å…¶å®Promiseå®ç°åœ¨æ•´ä½“ä¸Šå¹¶æ²¡æœ‰å¤ªå¤æ‚çš„æ€æƒ³ï¼Œä½†æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„æ—¶å€™å¾€å¾€å¿½ç•¥äº†å¾ˆå¤šPromiseç»†èŠ‚ï¼Œå› è€Œå¾ˆéš¾å†™å‡ºä¸€ä¸ªç¬¦åˆè§„èŒƒçš„Promiseå®ç°ï¼Œæºç çš„å®ç°è¿‡ç¨‹ï¼Œå…¶å®ä¹Ÿæ˜¯å¯¹Promiseä½¿ç”¨ç»†èŠ‚é‡æ–°å­¦ä¹ çš„è¿‡ç¨‹ã€‚

# async/awaitå®ç°

è™½ç„¶å‰è¾¹èŠ±äº†è¿™ä¹ˆå¤šç¯‡å¹…è®²Promiseçš„å®ç°ï¼Œä¸è¿‡æ¢ç´¢`async/await`æš‚åœæ‰§è¡Œçš„æœºåˆ¶æ‰æ˜¯æˆ‘ä»¬çš„åˆè¡·ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥è¿›å…¥è¿™ä¸€å—çš„å†…å®¹ã€‚åŒæ ·åœ°ï¼Œå¼€å¤´æˆ‘ä»¬ç‚¹ä¸€ä¸‹async/awaitçš„ä½¿ç”¨æ„ä¹‰ã€‚ åœ¨å¤šä¸ªå›è°ƒä¾èµ–çš„åœºæ™¯ä¸­ï¼Œå°½ç®¡Promiseé€šè¿‡é“¾å¼è°ƒç”¨å–ä»£äº†å›è°ƒåµŒå¥—ï¼Œä½†è¿‡å¤šçš„é“¾å¼è°ƒç”¨å¯è¯»æ€§ä»ç„¶ä¸ä½³ï¼Œæµç¨‹æ§åˆ¶ä¹Ÿä¸æ–¹ä¾¿ï¼ŒES7 æå‡ºçš„async å‡½æ•°ï¼Œç»ˆäºè®© JS å¯¹äºå¼‚æ­¥æ“ä½œæœ‰äº†ç»ˆæè§£å†³æ–¹æ¡ˆï¼Œç®€æ´ä¼˜ç¾åœ°è§£å†³äº†ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜ã€‚

> è®¾æƒ³ä¸€ä¸ªè¿™æ ·çš„åœºæ™¯ï¼Œå¼‚æ­¥ä»»åŠ¡a->b->cä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå¦‚æœæˆ‘ä»¬é€šè¿‡thené“¾å¼è°ƒç”¨æ¥å¤„ç†è¿™äº›å…³ç³»ï¼Œå¯è¯»æ€§å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ§åˆ¶å…¶ä¸­æŸä¸ªè¿‡ç¨‹ï¼Œæ¯”å¦‚åœ¨æŸäº›æ¡ä»¶ä¸‹ï¼Œbä¸å¾€ä¸‹æ‰§è¡Œåˆ°cï¼Œé‚£ä¹ˆä¹Ÿä¸æ˜¯å¾ˆæ–¹ä¾¿æ§åˆ¶

```js
Promise.resolve(a)
  .then(b => {
    // do something
  })
  .then(c => {
    // do something
  })
å¤åˆ¶ä»£ç 
```

> ä½†æ˜¯å¦‚æœé€šè¿‡async/awaitæ¥å®ç°è¿™ä¸ªåœºæ™¯ï¼Œå¯è¯»æ€§å’Œæµç¨‹æ§åˆ¶éƒ½ä¼šæ–¹ä¾¿ä¸å°‘ã€‚

```js
async () => {
  const a = await Promise.resolve(a);
  const b = await Promise.resolve(b);
  const c = await Promise.resolve(c);
}
å¤åˆ¶ä»£ç 
```



é‚£ä¹ˆæˆ‘ä»¬è¦å¦‚ä½•å®ç°ä¸€ä¸ªasync/awaitå‘¢ï¼Œé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ï¼Œ**async/awaitå®é™…ä¸Šæ˜¯å¯¹Generatorï¼ˆç”Ÿæˆå™¨ï¼‰çš„å°è£…**ï¼Œæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ã€‚ç”±äºGeneratorå‡ºç°ä¸ä¹…å°±è¢«async/awaitå–ä»£äº†ï¼Œå¾ˆå¤šåŒå­¦å¯¹Generatoræ¯”è¾ƒé™Œç”Ÿï¼Œå› æ­¤æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹Generatorçš„ç”¨æ³•ï¼š

> ES6 æ–°å¼•å…¥äº† Generator å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡ yield å…³é”®å­—ï¼ŒæŠŠå‡½æ•°çš„æ‰§è¡ŒæµæŒ‚èµ·ï¼Œé€šè¿‡next()æ–¹æ³•å¯ä»¥åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€ï¼Œä¸ºæ”¹å˜æ‰§è¡Œæµç¨‹æä¾›äº†å¯èƒ½ï¼Œä»è€Œä¸ºå¼‚æ­¥ç¼–ç¨‹æä¾›è§£å†³æ–¹æ¡ˆã€‚

```JS
function* myGenerator() {
  yield '1'
  yield '2'
  return '3'
}

const gen = myGenerator();  // è·å–è¿­ä»£å™¨
gen.next()  //{value: "1", done: false}
gen.next()  //{value: "2", done: false}
gen.next()  //{value: "3", done: true}
å¤åˆ¶ä»£ç 
```

ä¹Ÿå¯ä»¥é€šè¿‡ç»™`next()`ä¼ å‚, è®©yieldå…·æœ‰è¿”å›å€¼

```js
function* myGenerator() {
  console.log(yield '1')  //test1
  console.log(yield '2')  //test2
  console.log(yield '3')  //test3
}

// è·å–è¿­ä»£å™¨
const gen = myGenerator();

gen.next()
gen.next('test1')
gen.next('test2')
gen.next('test3')
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬çœ‹åˆ°Generatorçš„ç”¨æ³•ï¼Œåº”è¯¥ï¸ä¼šæ„Ÿåˆ°å¾ˆç†Ÿæ‚‰ï¼Œ`*/yield`å’Œ`async/await`çœ‹èµ·æ¥å…¶å®å·²ç»å¾ˆç›¸ä¼¼äº†ï¼Œå®ƒä»¬éƒ½æä¾›äº†æš‚åœæ‰§è¡Œçš„åŠŸèƒ½ï¼Œä½†äºŒè€…åˆæœ‰ä¸‰ç‚¹ä¸åŒï¼š

- `async/await`è‡ªå¸¦æ‰§è¡Œå™¨ï¼Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨next()å°±èƒ½è‡ªåŠ¨æ‰§è¡Œä¸‹ä¸€æ­¥
- `async`å‡½æ•°è¿”å›å€¼æ˜¯Promiseå¯¹è±¡ï¼Œè€ŒGeneratorè¿”å›çš„æ˜¯ç”Ÿæˆå™¨å¯¹è±¡
- `await`èƒ½å¤Ÿè¿”å›Promiseçš„resolve/rejectçš„å€¼

**æˆ‘ä»¬å¯¹async/awaitçš„å®ç°ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å¯¹åº”ä»¥ä¸Šä¸‰ç‚¹å°è£…Generator**

## 1.è‡ªåŠ¨æ‰§è¡Œ

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œå¯¹äºè¿™æ ·ä¸€ä¸ªGeneratorï¼Œæ‰‹åŠ¨æ‰§è¡Œæ˜¯æ€æ ·ä¸€ä¸ªæµç¨‹

```js
function* myGenerator() {
  yield Promise.resolve(1);
  yield Promise.resolve(2);
  yield Promise.resolve(3);
}

// æ‰‹åŠ¨æ‰§è¡Œè¿­ä»£å™¨
const gen = myGenerator()
gen.next().value.then(val => {
  console.log(val)
  gen.next().value.then(val => {
    console.log(val)
    gen.next().value.then(val => {
      console.log(val)
    })
  })
})

//è¾“å‡º1 2 3
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç»™`gen.next()`ä¼ å€¼çš„æ–¹å¼ï¼Œè®©yieldèƒ½è¿”å›resolveçš„å€¼

```js
function* myGenerator() {
  console.log(yield Promise.resolve(1))   //1
  console.log(yield Promise.resolve(2))   //2
  console.log(yield Promise.resolve(3))   //3
}

// æ‰‹åŠ¨æ‰§è¡Œè¿­ä»£å™¨
const gen = myGenerator()
gen.next().value.then(val => {
  // console.log(val)
  gen.next(val).value.then(val => {
    // console.log(val)
    gen.next(val).value.then(val => {
      // console.log(val)
      gen.next(val)
    })
  })
})
å¤åˆ¶ä»£ç 
```

æ˜¾ç„¶ï¼Œæ‰‹åŠ¨æ‰§è¡Œçš„å†™æ³•çœ‹èµ·æ¥æ—¢ç¬¨æ‹™åˆä¸‘é™‹ï¼Œæˆ‘ä»¬å¸Œæœ›ç”Ÿæˆå™¨å‡½æ•°èƒ½è‡ªåŠ¨å¾€ä¸‹æ‰§è¡Œï¼Œä¸”yieldèƒ½è¿”å›resolveçš„å€¼ï¼ŒåŸºäºè¿™ä¸¤ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬è¿›è¡Œä¸€ä¸ªåŸºæœ¬çš„å°è£…ï¼Œè¿™é‡Œ`async/await`æ˜¯å…³é”®å­—ï¼Œä¸èƒ½é‡å†™ï¼Œæˆ‘ä»¬ç”¨å‡½æ•°æ¥æ¨¡æ‹Ÿï¼š

```js
function run(gen) {
  var g = gen()                     //ç”±äºæ¯æ¬¡gen()è·å–åˆ°çš„éƒ½æ˜¯æœ€æ–°çš„è¿­ä»£å™¨,å› æ­¤è·å–è¿­ä»£å™¨æ“ä½œè¦æ”¾åœ¨_next()ä¹‹å‰,å¦åˆ™ä¼šè¿›å…¥æ­»å¾ªç¯

  function _next(val) {             //å°è£…ä¸€ä¸ªæ–¹æ³•, é€’å½’æ‰§è¡Œg.next()
    var res = g.next(val)           //è·å–è¿­ä»£å™¨å¯¹è±¡ï¼Œå¹¶è¿”å›resolveçš„å€¼
    if(res.done) return res.value   //é€’å½’ç»ˆæ­¢æ¡ä»¶
    res.value.then(val => {         //Promiseçš„thenæ–¹æ³•æ˜¯å®ç°è‡ªåŠ¨è¿­ä»£çš„å‰æ
      _next(val)                    //ç­‰å¾…Promiseå®Œæˆå°±è‡ªåŠ¨æ‰§è¡Œä¸‹ä¸€ä¸ªnextï¼Œå¹¶ä¼ å…¥resolveçš„å€¼
    })
  }
  _next()  //ç¬¬ä¸€æ¬¡æ‰§è¡Œ
}
å¤åˆ¶ä»£ç 
```

å¯¹äºæˆ‘ä»¬ä¹‹å‰çš„ä¾‹å­ï¼Œæˆ‘ä»¬å°±èƒ½è¿™æ ·æ‰§è¡Œï¼š

```js
function* myGenerator() {
  console.log(yield Promise.resolve(1))   //1
  console.log(yield Promise.resolve(2))   //2
  console.log(yield Promise.resolve(3))   //3
}

run(myGenerator)
å¤åˆ¶ä»£ç 
```

è¿™æ ·æˆ‘ä»¬å°±åˆæ­¥å®ç°äº†ä¸€ä¸ª`async/await`ã€‚ä¸Šè¾¹çš„ä»£ç åªæœ‰äº”å…­è¡Œï¼Œä½†å¹¶ä¸æ˜¯ä¸€ä¸‹å°±èƒ½çœ‹æ˜ç™½çš„ï¼Œæˆ‘ä»¬ä¹‹å‰ç”¨äº†å››ä¸ªä¾‹å­æ¥åšé“ºå«ï¼Œä¹Ÿæ˜¯ä¸ºäº†è®©è¯»è€…æ›´å¥½åœ°ç†è§£è¿™æ®µä»£ç ã€‚ ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬å°è£…äº†ä¸€ä¸ªrunæ–¹æ³•ï¼Œrunæ–¹æ³•é‡Œæˆ‘ä»¬æŠŠæ‰§è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œå°è£…æˆ`_next()`ï¼Œæ¯æ¬¡Promise.then()çš„æ—¶å€™éƒ½å»æ‰§è¡Œ`_next()`ï¼Œå®ç°è‡ªåŠ¨è¿­ä»£çš„æ•ˆæœã€‚åœ¨è¿­ä»£çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜æŠŠresolveçš„å€¼ä¼ å…¥`gen.next()`ï¼Œä½¿å¾—yieldå¾—ä»¥è¿”å›Promiseçš„resolveçš„å€¼

> è¿™é‡Œæ’ä¸€å¥ï¼Œæ˜¯ä¸æ˜¯åªæœ‰`.thenæ–¹æ³•`è¿™æ ·çš„å½¢å¼æ‰èƒ½å®Œæˆæˆ‘ä»¬è‡ªåŠ¨æ‰§è¡Œçš„åŠŸèƒ½å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œyieldåè¾¹é™¤äº†æ¥Promiseï¼Œè¿˜å¯ä»¥æ¥`thunkå‡½æ•°`ï¼Œthunkå‡½æ•°ä¸æ˜¯ä¸€ä¸ªæ–°ä¸œè¥¿ï¼Œæ‰€è°“thunkå‡½æ•°ï¼Œå°±æ˜¯**å•å‚çš„åªæ¥å—å›è°ƒçš„å‡½æ•°**ï¼Œè¯¦ç»†ä»‹ç»å¯ä»¥çœ‹[é˜®ä¸€å³°Thunk å‡½æ•°çš„å«ä¹‰å’Œç”¨æ³•](https://link.juejin.cn?target=https%3A%2F%2Fp1-jj.byteimg.com%2Ftos-cn-i-t2oaga2asx%2Fgold-user-assets%2F2020%2F3%2F15%2F170dc5e88df6c208~tplv-t2oaga2asx-image.image)ï¼Œæ— è®ºæ˜¯Promiseè¿˜æ˜¯thunkå‡½æ•°ï¼Œå…¶æ ¸å¿ƒéƒ½æ˜¯é€šè¿‡**ä¼ å…¥å›è°ƒ**çš„æ–¹å¼æ¥å®ç°Generatorçš„è‡ªåŠ¨æ‰§è¡Œã€‚thunkå‡½æ•°åªä½œä¸ºä¸€ä¸ªæ‹“å±•çŸ¥è¯†ï¼Œç†è§£æœ‰å›°éš¾çš„åŒå­¦ä¹Ÿå¯ä»¥è·³è¿‡è¿™é‡Œï¼Œå¹¶ä¸å½±å“åç»­ç†è§£ã€‚

## 2.è¿”å›Promise & å¼‚å¸¸å¤„ç†

è™½ç„¶æˆ‘ä»¬å®ç°äº†Generatorçš„è‡ªåŠ¨æ‰§è¡Œä»¥åŠè®©yieldè¿”å›resolveçš„å€¼ï¼Œä½†ä¸Šè¾¹çš„ä»£ç è¿˜å­˜åœ¨ç€å‡ ç‚¹é—®é¢˜ï¼š

1. **éœ€è¦å…¼å®¹åŸºæœ¬ç±»å‹**ï¼šè¿™æ®µä»£ç èƒ½è‡ªåŠ¨æ‰§è¡Œçš„å‰ææ˜¯`yield`åé¢è·ŸPromiseï¼Œä¸ºäº†å…¼å®¹åé¢è·Ÿç€åŸºæœ¬ç±»å‹å€¼çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦æŠŠyieldè·Ÿçš„å†…å®¹(`gen().next.value`)éƒ½ç”¨`Promise.resolve()`è½¬åŒ–ä¸€é
2. **ç¼ºå°‘é”™è¯¯å¤„ç†**ï¼šä¸Šè¾¹ä»£ç é‡Œçš„Promiseå¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œå°±ä¼šå¯¼è‡´åç»­æ‰§è¡Œç›´æ¥ä¸­æ–­ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è°ƒç”¨`Generator.prototype.throw()`ï¼ŒæŠŠé”™è¯¯æŠ›å‡ºæ¥ï¼Œæ‰èƒ½è¢«å¤–å±‚çš„try-catchæ•è·åˆ°
3. **è¿”å›å€¼æ˜¯Promise**ï¼š`async/await`çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªPromiseï¼Œæˆ‘ä»¬è¿™é‡Œä¹Ÿéœ€è¦ä¿æŒä¸€è‡´ï¼Œç»™è¿”å›å€¼åŒ…ä¸€ä¸ªPromise

æˆ‘ä»¬æ”¹é€ ä¸€ä¸‹runæ–¹æ³•ï¼š

```js
function run(gen) {
  //æŠŠè¿”å›å€¼åŒ…è£…æˆpromise
  return new Promise((resolve, reject) => {
    var g = gen()

    function _next(val) {
      //é”™è¯¯å¤„ç†
      try {
        var res = g.next(val) 
      } catch(err) {
        return reject(err); 
      }
      if(res.done) {
        return resolve(res.value);
      }
      //res.valueåŒ…è£…ä¸ºpromiseï¼Œä»¥å…¼å®¹yieldåé¢è·ŸåŸºæœ¬ç±»å‹çš„æƒ…å†µ
      Promise.resolve(res.value).then(
        val => {
          _next(val);
        }, 
        err => {
          //æŠ›å‡ºé”™è¯¯
          g.throw(err)
        });
    }
    _next();
  });
}
å¤åˆ¶ä»£ç 
```

ç„¶åæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼š

```js
function* myGenerator() {
  try {
    console.log(yield Promise.resolve(1)) 
    console.log(yield 2)   //2
    console.log(yield Promise.reject('error'))
  } catch (error) {
    console.log(error)
  }
}

const result = run(myGenerator)     //resultæ˜¯ä¸€ä¸ªPromise
//è¾“å‡º 1 2 error
å¤åˆ¶ä»£ç 
```

åˆ°è¿™é‡Œï¼Œä¸€ä¸ª`async/await`çš„å®ç°åŸºæœ¬å®Œæˆäº†ã€‚æœ€åæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹babelå¯¹async/awaitçš„è½¬æ¢ç»“æœï¼Œå…¶å®æ•´ä½“çš„æ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å†™æ³•ç¨æœ‰ä¸åŒï¼š

```js
//ç›¸å½“äºæˆ‘ä»¬çš„run()
function _asyncToGenerator(fn) {
  // returnä¸€ä¸ªfunctionï¼Œå’Œasyncä¿æŒä¸€è‡´ã€‚æˆ‘ä»¬çš„runç›´æ¥æ‰§è¡Œäº†Generatorï¼Œå…¶å®æ˜¯ä¸å¤ªè§„èŒƒçš„
  return function() {
    var self = this
    var args = arguments
    return new Promise(function(resolve, reject) {
      var gen = fn.apply(self, args);

      //ç›¸å½“äºæˆ‘ä»¬çš„_next()
      function _next(value) {
        asyncGeneratorStep(gen, resolve, reject, _next, _throw, 'next', value);
      }
      //å¤„ç†å¼‚å¸¸
      function _throw(err) {
        asyncGeneratorStep(gen, resolve, reject, _next, _throw, 'throw', err);
      }
      _next(undefined);
    });
  };
}

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
  try {
    var info = gen[key](arg);
    var value = info.value;
  } catch (error) {
    reject(error);
    return;
  }
  if (info.done) {
    resolve(value);
  } else {
    Promise.resolve(value).then(_next, _throw);
  }
}
å¤åˆ¶ä»£ç 
```

ä½¿ç”¨æ–¹å¼ï¼š

```js
const foo = _asyncToGenerator(function* () {
  try {
    console.log(yield Promise.resolve(1))   //1
    console.log(yield 2)                    //2
    return '3'
  } catch (error) {
    console.log(error)
  }
})

foo().then(res => {
  console.log(res)                          //3
})
å¤åˆ¶ä»£ç 
```

æœ‰å…³`async/await`çš„å®ç°ï¼Œåˆ°è¿™é‡Œå°±å‘Šä¸€æ®µè½äº†ã€‚ä½†æ˜¯ç›´åˆ°ç»“å°¾ï¼Œæˆ‘ä»¬ä¹Ÿä¸çŸ¥é“awaitåˆ°åº•æ˜¯å¦‚ä½•æš‚åœæ‰§è¡Œçš„ï¼Œæœ‰å…³awaitæš‚åœæ‰§è¡Œçš„ç§˜å¯†ï¼Œæˆ‘ä»¬è¿˜è¦åˆ°Generatorçš„å®ç°ä¸­å»å¯»æ‰¾ç­”æ¡ˆ

# Generatorå®ç°

æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„Generatorä½¿ç”¨å®ä¾‹å¼€å§‹ï¼Œä¸€æ­¥æ­¥æ¢ç©¶Generatorçš„å®ç°åŸç†ï¼š

```js
function* foo() {
  yield 'result1'
  yield 'result2'
  yield 'result3'
}
  
const gen = foo()
console.log(gen.next().value)
console.log(gen.next().value)
console.log(gen.next().value)
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬å¯ä»¥åœ¨[babelå®˜ç½‘](https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Frepl%2F%23%3Fbrowsers%3D%26build%3D%26builtIns%3Dfalse%26spec%3Dfalse%26loose%3Dfalse%26code_lz%3DGYVwdgxgLglg9mAVAAmHOAKAlMg3gKGWQE8YBTAGwBNkByAJzIGcQKoBGWwk86uxlmwBMXIqUo0GzVlADMXAL7d8EBEyjIA5mTDIAvKnTYVauBTIA6CnE0ZtYC2DIAPKNgsA3AIYUQZLCZgTGaW1rb2ji5uWJ4-fgGqQSFWNnY6ka7u3r7-QA%26debug%3Dfalse%26forceAllTransforms%3Dfalse%26shippedProposals%3Dfalse%26circleciRepo%3D%26evaluate%3Dfalse%26fileSize%3Dfalse%26timeTravel%3Dfalse%26sourceType%3Dmodule%26lineWrap%3Dtrue%26presets%3Des2015%2Creact%2Cstage-2%26prettier%3Dfalse%26targets%3D%26version%3D7.5.5%26externalPlugins%3D)ä¸Šåœ¨çº¿è½¬åŒ–è¿™æ®µä»£ç ï¼Œçœ‹çœ‹ES5ç¯å¢ƒä¸‹æ˜¯å¦‚ä½•å®ç°Generatorçš„ï¼š

```js
"use strict";

var _marked =
/*#__PURE__*/
regeneratorRuntime.mark(foo);

function foo() {
  return regeneratorRuntime.wrap(function foo$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          _context.next = 2;
          return 'result1';

        case 2:
          _context.next = 4;
          return 'result2';

        case 4:
          _context.next = 6;
          return 'result3';

        case 6:
        case "end":
          return _context.stop();
      }
    }
  }, _marked);
}

var gen = foo();
console.log(gen.next().value);
console.log(gen.next().value);
console.log(gen.next().value);
å¤åˆ¶ä»£ç 
```

ä»£ç å’‹ä¸€çœ‹ä¸é•¿ï¼Œä½†å¦‚æœä»”ç»†è§‚å¯Ÿä¼šå‘ç°æœ‰ä¸¤ä¸ªä¸è®¤è¯†çš„ä¸œè¥¿ â€”â€” `regeneratorRuntime.mark`å’Œ`regeneratorRuntime.wrap`ï¼Œè¿™ä¸¤è€…å…¶å®æ˜¯ regenerator-runtime æ¨¡å—é‡Œçš„ä¸¤ä¸ªæ–¹æ³•ï¼Œregenerator-runtime æ¨¡å—æ¥è‡ªfacebookçš„ regenerator æ¨¡å—ï¼Œå®Œæ•´ä»£ç åœ¨[runtime.js](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Fregenerator%2Fblob%2Fmaster%2Fpackages%2Fregenerator-runtime%2Fruntime.js)ï¼Œè¿™ä¸ªruntimeæœ‰700å¤šè¡Œ...-_-||ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½å…¨è®²ï¼Œä¸å¤ªé‡è¦çš„éƒ¨åˆ†æˆ‘ä»¬å°±ç®€å•åœ°è¿‡ä¸€ä¸‹ï¼Œé‡ç‚¹è®²è§£æš‚åœæ‰§è¡Œç›¸å…³éƒ¨åˆ†ä»£ç 

> ä¸ªäººè§‰å¾—å•ƒæºç çš„æ•ˆæœä¸æ˜¯å¾ˆå¥½ï¼Œå»ºè®®è¯»è€…æ‹‰åˆ°æœ«å°¾å…ˆçœ‹ç»“è®ºå’Œç®€ç•¥ç‰ˆå®ç°ï¼Œæºç ä½œä¸ºä¸€ä¸ªè¡¥å……ç†è§£

## regeneratorRuntime.mark()

`regeneratorRuntime.mark(foo)`è¿™ä¸ªæ–¹æ³•åœ¨ç¬¬ä¸€è¡Œè¢«è°ƒç”¨ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹runtimeé‡Œmark()æ–¹æ³•çš„å®šä¹‰

```js
//runtime.jsé‡Œçš„å®šä¹‰ç¨æœ‰ä¸åŒï¼Œå¤šäº†ä¸€äº›åˆ¤æ–­ï¼Œä»¥ä¸‹æ˜¯ç¼–è¯‘åçš„ä»£ç 
runtime.mark = function(genFun) {
  genFun.__proto__ = GeneratorFunctionPrototype;
  genFun.prototype = Object.create(Gp);
  return genFun;
};
å¤åˆ¶ä»£ç 
```

è¿™é‡Œè¾¹`GeneratorFunctionPrototype`å’Œ`Gp`æˆ‘ä»¬éƒ½ä¸è®¤è¯†ï¼Œä»–ä»¬è¢«å®šä¹‰åœ¨runtimeé‡Œï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œæˆ‘ä»¬åªè¦çŸ¥é“`mark()æ–¹æ³•`ä¸ºç”Ÿæˆå™¨å‡½æ•°ï¼ˆfooï¼‰ç»‘å®šäº†ä¸€ç³»åˆ—åŸå‹å°±å¯ä»¥äº†ï¼Œè¿™é‡Œå°±ç®€å•åœ°è¿‡äº†

## regeneratorRuntime.wrap()

ä»ä¸Šé¢babelè½¬åŒ–çš„ä»£ç æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œæ‰§è¡Œ`foo()`ï¼Œå…¶å®å°±æ˜¯æ‰§è¡Œ`wrap()`ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•èµ·åˆ°ä»€ä¹ˆä½œç”¨å‘¢ï¼Œä»–æƒ³åŒ…è£…ä¸€ä¸ªä»€ä¹ˆä¸œè¥¿å‘¢ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹wrapæ–¹æ³•çš„å®šä¹‰ï¼š

```js
//runtime.jsé‡Œçš„å®šä¹‰ç¨æœ‰ä¸åŒï¼Œå¤šäº†ä¸€äº›åˆ¤æ–­ï¼Œä»¥ä¸‹æ˜¯ç¼–è¯‘åçš„ä»£ç 
function wrap(innerFn, outerFn, self) {
  var generator = Object.create(outerFn.prototype);
  var context = new Context([]);
  generator._invoke = makeInvokeMethod(innerFn, self, context);

  return generator;
}
å¤åˆ¶ä»£ç 
```

wrapæ–¹æ³•å…ˆæ˜¯åˆ›å»ºäº†ä¸€ä¸ªgeneratorï¼Œå¹¶ç»§æ‰¿`outerFn.prototype`ï¼›ç„¶ånewäº†ä¸€ä¸ª`contextå¯¹è±¡`ï¼›`makeInvokeMethodæ–¹æ³•`æ¥æ”¶`innerFn(å¯¹åº”foo$)`ã€`context`å’Œ`this`ï¼Œå¹¶æŠŠè¿”å›å€¼æŒ‚åˆ°`generator._invoke`ä¸Šï¼›æœ€åreturnäº†generatorã€‚**å…¶å®wrap()ç›¸å½“äºæ˜¯ç»™generatorå¢åŠ äº†ä¸€ä¸ª_invokeæ–¹æ³•**

è¿™æ®µä»£ç è‚¯å®šè®©äººäº§ç”Ÿå¾ˆå¤šç–‘é—®ï¼ŒouterFn.prototypeæ˜¯ä»€ä¹ˆï¼ŒContextåˆæ˜¯ä»€ä¹ˆï¼ŒmakeInvokeMethodåˆåšäº†å“ªäº›æ“ä½œã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€ä¸€è§£ç­”ï¼š

> `outerFn.prototype`å…¶å®å°±æ˜¯`genFun.prototype`ï¼Œ

è¿™ä¸ªæˆ‘ä»¬ç»“åˆä¸€ä¸‹ä¸Šé¢çš„ä»£ç å°±èƒ½çŸ¥é“

> `context`å¯ä»¥ç›´æ¥ç†è§£ä¸ºè¿™æ ·ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œç”¨äºå‚¨å­˜å„ç§çŠ¶æ€å’Œä¸Šä¸‹æ–‡ï¼š

```js
var ContinueSentinel = {};

var context = {
  done: false,
  method: "next",
  next: 0,
  prev: 0,
  abrupt: function(type, arg) {
    var record = {};
    record.type = type;
    record.arg = arg;

    return this.complete(record);
  },
  complete: function(record, afterLoc) {
    if (record.type === "return") {
      this.rval = this.arg = record.arg;
      this.method = "return";
      this.next = "end";
    }

    return ContinueSentinel;
  },
  stop: function() {
    this.done = true;
    return this.rval;
  }
};
å¤åˆ¶ä»£ç 
```

> ```
> makeInvokeMethod`çš„å®šä¹‰å¦‚ä¸‹ï¼Œå®ƒreturnäº†ä¸€ä¸ª`invokeæ–¹æ³•`ï¼Œinvokeç”¨äºåˆ¤æ–­å½“å‰çŠ¶æ€å’Œæ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬è°ƒç”¨çš„`next()
> ```

```js
//ä»¥ä¸‹æ˜¯ç¼–è¯‘åçš„ä»£ç 
function makeInvokeMethod(innerFn, context) {
  // å°†çŠ¶æ€ç½®ä¸ºstart
  var state = "start";

  return function invoke(method, arg) {
    // å·²å®Œæˆ
    if (state === "completed") {
      return { value: undefined, done: true };
    }
    
    context.method = method;
    context.arg = arg;

    // æ‰§è¡Œä¸­
    while (true) {
      state = "executing";

      var record = {
        type: "normal",
        arg: innerFn.call(self, context)    // æ‰§è¡Œä¸‹ä¸€æ­¥,å¹¶è·å–çŠ¶æ€(å…¶å®å°±æ˜¯switché‡Œè¾¹returnçš„å€¼)
      };

      if (record.type === "normal") {
        // åˆ¤æ–­æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ
        state = context.done ? "completed" : "yield";

        // ContinueSentinelå…¶å®æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡,record.arg === {}åˆ™è·³è¿‡returnè¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯
        // ä»€ä¹ˆæ—¶å€™record.argä¼šä¸ºç©ºå¯¹è±¡å‘¢, ç­”æ¡ˆæ˜¯æ²¡æœ‰åç»­yieldè¯­å¥æˆ–å·²ç»returnçš„æ—¶å€™,ä¹Ÿå°±æ˜¯switchè¿”å›äº†ç©ºå€¼çš„æƒ…å†µ(è·Ÿç€ä¸Šé¢çš„switchèµ°ä¸€ä¸‹å°±çŸ¥é“äº†)
        if (record.arg === ContinueSentinel) {
          continue;
        }
        // next()çš„è¿”å›å€¼
        return {
          value: record.arg,
          done: context.done
        };
      }
    }
  };
}
å¤åˆ¶ä»£ç 
```

> ä¸ºä»€ä¹ˆ`generator._invoke`å®é™…ä¸Šå°±æ˜¯`gen.next`å‘¢ï¼Œå› ä¸ºåœ¨runtimeå¯¹äºnext()çš„å®šä¹‰ä¸­ï¼Œnext()å…¶å®å°±returnäº†_invokeæ–¹æ³•

```js
// Helper for defining the .next, .throw, and .return methods of the
// Iterator interface in terms of a single ._invoke method.
function defineIteratorMethods(prototype) {
    ["next", "throw", "return"].forEach(function(method) {
      prototype[method] = function(arg) {
        return this._invoke(method, arg);
      };
    });
}

defineIteratorMethods(Gp);
å¤åˆ¶ä»£ç 
```

## ä½é…å®ç° & è°ƒç”¨æµç¨‹åˆ†æ

è¿™ä¹ˆä¸€éæºç ä¸‹æ¥ï¼Œä¼°è®¡å¾ˆå¤šè¯»è€…è¿˜æ˜¯æ‡µé€¼çš„ï¼Œæ¯•ç«Ÿæºç ä¸­çº é›†äº†å¾ˆå¤šæ¦‚å¿µå’Œå°è£…ï¼Œä¸€æ—¶åŠä¼šä¸å¥½å®Œå…¨ç†è§£ï¼Œè®©æˆ‘ä»¬è·³å‡ºæºç ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„Generatorï¼Œç„¶åå†å›è¿‡å¤´çœ‹æºç ï¼Œä¼šå¾—åˆ°æ›´æ¸…æ™°çš„è®¤è¯†

```js
// ç”Ÿæˆå™¨å‡½æ•°æ ¹æ®yieldè¯­å¥å°†ä»£ç åˆ†å‰²ä¸ºswitch-caseå—ï¼Œåç»­é€šè¿‡åˆ‡æ¢_context.prevå’Œ_context.nextæ¥åˆ†åˆ«æ‰§è¡Œå„ä¸ªcase
function gen$(_context) {
  while (1) {
    switch (_context.prev = _context.next) {
      case 0:
        _context.next = 2;
        return 'result1';

      case 2:
        _context.next = 4;
        return 'result2';

      case 4:
        _context.next = 6;
        return 'result3';

      case 6:
      case "end":
        return _context.stop();
    }
  }
}

// ä½é…ç‰ˆcontext  
var context = {
  next:0,
  prev: 0,
  done: false,
  stop: function stop () {
    this.done = true
  }
}

// ä½é…ç‰ˆinvoke
let gen = function() {
  return {
    next: function() {
      value = context.done ? undefined: gen$(context)
      done = context.done
      return {
        value,
        done
      }
    }
  }
} 

// æµ‹è¯•ä½¿ç”¨
var g = gen() 
g.next()  // {value: "result1", done: false}
g.next()  // {value: "result2", done: false}
g.next()  // {value: "result3", done: false}
g.next()  // {value: undefined, done: true}
å¤åˆ¶ä»£ç 
```

è¿™æ®µä»£ç å¹¶ä¸éš¾ç†è§£ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹è°ƒç”¨æµç¨‹ï¼š

1. æˆ‘ä»¬å®šä¹‰çš„`function* `ç”Ÿæˆå™¨å‡½æ•°è¢«è½¬åŒ–ä¸ºä»¥ä¸Šä»£ç 
2. è½¬åŒ–åçš„ä»£ç åˆ†ä¸ºä¸‰å¤§å—ï¼š 
   - `gen$(_context)`ç”±yieldåˆ†å‰²ç”Ÿæˆå™¨å‡½æ•°ä»£ç è€Œæ¥
   - `contextå¯¹è±¡`ç”¨äºå‚¨å­˜å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡
   - `invoke()æ–¹æ³•`å®šä¹‰next()ï¼Œç”¨äºæ‰§è¡Œgen$(_context)æ¥è·³åˆ°ä¸‹ä¸€æ­¥
3. å½“æˆ‘ä»¬è°ƒç”¨`g.next()`ï¼Œå°±ç›¸å½“äºè°ƒç”¨`invoke()æ–¹æ³•`ï¼Œæ‰§è¡Œ`gen$(_context)`ï¼Œè¿›å…¥switchè¯­å¥ï¼Œswitchæ ¹æ®contextçš„æ ‡è¯†ï¼Œæ‰§è¡Œå¯¹åº”çš„caseå—ï¼Œreturnå¯¹åº”ç»“æœ
4. å½“ç”Ÿæˆå™¨å‡½æ•°è¿è¡Œåˆ°æœ«å°¾ï¼ˆæ²¡æœ‰ä¸‹ä¸€ä¸ªyieldæˆ–å·²ç»returnï¼‰ï¼ŒswitchåŒ¹é…ä¸åˆ°å¯¹åº”ä»£ç å—ï¼Œå°±ä¼šreturnç©ºå€¼ï¼Œè¿™æ—¶`g.next()`è¿”å›`{value: undefined, done: true}`

ä»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ**Generatorå®ç°çš„æ ¸å¿ƒåœ¨äº`ä¸Šä¸‹æ–‡çš„ä¿å­˜`ï¼Œå‡½æ•°å¹¶æ²¡æœ‰çœŸçš„è¢«æŒ‚èµ·ï¼Œæ¯ä¸€æ¬¡yieldï¼Œå…¶å®éƒ½æ‰§è¡Œäº†ä¸€éä¼ å…¥çš„ç”Ÿæˆå™¨å‡½æ•°ï¼Œåªæ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­é—´ç”¨äº†ä¸€ä¸ªcontextå¯¹è±¡å‚¨å­˜ä¸Šä¸‹æ–‡ï¼Œä½¿å¾—æ¯æ¬¡æ‰§è¡Œç”Ÿæˆå™¨å‡½æ•°çš„æ—¶å€™ï¼Œéƒ½å¯ä»¥ä»ä¸Šä¸€ä¸ªæ‰§è¡Œç»“æœå¼€å§‹æ‰§è¡Œï¼Œçœ‹èµ·æ¥å°±åƒå‡½æ•°è¢«æŒ‚èµ·äº†ä¸€æ ·**

# æ€»ç»“ & è‡´è°¢

æœ‰å…³Promiseã€async/awaitã€Generatorçš„åŸç†å°±å®ç°åˆ°è¿™é‡Œäº†ï¼Œæ„Ÿè°¢å¤§å®¶èƒ½å¤Ÿè·Ÿæˆ‘ä¸€èµ·èµ°å®Œå…¨ç¨‹ï¼Œä¸çŸ¥ä¸è§‰ï¼Œæˆ‘ä»¬èŠ±äº†è¿‘9åƒå­—æ¥è®²è¿°æœ‰å…³å¼‚æ­¥ç¼–ç¨‹çš„æ•…äº‹ï¼Œå¼‚æ­¥ç¼–ç¨‹çš„ä¸–ç•Œç¯ç¯ç›¸æ‰£ï¼Œä¸€å¼€å§‹ï¼Œç¬”è€…åªæ˜¯å‡ºäºå¯¹awaitæŒ‚èµ·æœºåˆ¶çš„å¥½å¥‡ï¼Œåæ¥ï¼Œä»ä¸€ä¸ª "awaitæ˜¯å¦‚ä½•å®ç°æš‚åœæ‰§è¡Œ" çš„å°é—®é¢˜ï¼Œå¼•å‡ºäº†å¯¹å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç³»åˆ—æ€è€ƒå’Œå®ç°åŸç†ã€‚ä¸‰è€…çš„å®ç°ï¼Œå…¶å®ä¹Ÿæ˜¯å‰ç«¯å¼‚æ­¥ç¼–ç¨‹ä¸€æ­¥æ­¥æ¼”åŒ–æ¨è¿›çš„è¿‡ç¨‹ã€‚

æˆæ–‡è¿‡ç¨‹ä¸­å¾—åˆ°å¾ˆå¤šå¤§ä½¬çš„å¸®åŠ©ï¼Œè¿™å››ç¯‡å‚è€ƒæ–‡ç« éƒ½æ˜¯æˆ‘é˜…è¯»äº†å¾ˆå¤šç›¸å…³æ–‡ç« åç²¾é€‰çš„å››ç¯‡ï¼Œå»ºè®®å¤§å®¶ç»“åˆé˜…è¯»ï¼Œå¤§ä½¬ä»¬å†™çš„æ¯”æˆ‘å¥½å¾ˆå¤šï¼Œå¦å¤–æ„Ÿè°¢å†´ç¾½å¤§ä½¬åœ¨Generatoræœºåˆ¶ä¸Šç»™äºˆçš„è§£æƒ‘~

## ä½•ä¸ºPromise.allï¼Ÿ

`Promise.all` æ˜¯ es6 `Promise` å¯¹è±¡ä¸Šçš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒçš„åŠŸèƒ½å°±æ˜¯å°†å¤šä¸ª`Promise`å®ä¾‹åŒ…è£…æˆä¸€ä¸ª`promise`å®ä¾‹ã€‚ä»¥ä¸‹æ˜¯ MDN å¯¹ `Promise.all` çš„æè¿°ï¼š

> Promise.all() æ–¹æ³•æ¥æ”¶ä¸€ä¸ª promise çš„ iterable ç±»å‹ï¼ˆæ³¨ï¼šArrayï¼ŒMapï¼ŒSetéƒ½å±äºES6çš„iterableç±»å‹ï¼‰çš„è¾“å…¥ï¼Œå¹¶ä¸”åªè¿”å›ä¸€ä¸ª[`Promise`](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FPromise)å®ä¾‹ï¼Œ é‚£ä¸ªè¾“å…¥çš„æ‰€æœ‰ promise çš„ resolve å›è°ƒçš„ç»“æœæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚è¿™ä¸ª[`Promise`](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FPromise)çš„ resolve å›è°ƒæ‰§è¡Œæ˜¯åœ¨æ‰€æœ‰è¾“å…¥çš„ promise çš„ resolve å›è°ƒéƒ½ç»“æŸï¼Œæˆ–è€…è¾“å…¥çš„ iterable é‡Œæ²¡æœ‰ promise äº†çš„æ—¶å€™ã€‚å®ƒçš„ reject å›è°ƒæ‰§è¡Œæ˜¯ï¼Œåªè¦ä»»ä½•ä¸€ä¸ªè¾“å…¥çš„ promise çš„ reject å›è°ƒæ‰§è¡Œæˆ–è€…è¾“å…¥ä¸åˆæ³•çš„ promise å°±ä¼šç«‹å³æŠ›å‡ºé”™è¯¯ï¼Œå¹¶ä¸”rejectçš„æ˜¯ç¬¬ä¸€ä¸ªæŠ›å‡ºçš„é”™è¯¯ä¿¡æ¯ã€‚

æˆ‘æˆ´ä¸Šæˆ‘çš„300åº¦è¿‘è§†çœ¼é•œï¼Œä»”ç»†åœ°æå–å‡ºè¿™æ®µæè¿°ä¸­çš„**å…³é”®å­—**ï¼š

1. `Promise.all` çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ–°çš„ `Promise` å®ä¾‹ã€‚
2. `Promise.all` æ¥å—ä¸€ä¸ªå¯éå†çš„æ•°æ®å®¹å™¨ï¼Œå®¹å™¨ä¸­æ¯ä¸ªå…ƒç´ éƒ½åº”æ˜¯ `Promise` å®ä¾‹ã€‚å’±å°±æ˜¯è¯´ï¼Œå‡è®¾è¿™ä¸ªå®¹å™¨å°±æ˜¯æ•°ç»„ã€‚
3. æ•°ç»„ä¸­æ¯ä¸ª `Promise` å®ä¾‹éƒ½æˆåŠŸæ—¶ï¼ˆç”±`pendding`çŠ¶æ€è½¬åŒ–ä¸º`fulfilled`çŠ¶æ€ï¼‰ï¼Œ`Promise.all` æ‰æˆåŠŸã€‚è¿™äº› `Promise` å®ä¾‹æ‰€æœ‰çš„ `resolve` ç»“æœä¼šæŒ‰ç…§åŸæ¥çš„é¡ºåºé›†åˆåœ¨ä¸€ä¸ªæ•°ç»„ä¸­ä½œä¸º `Promise.all` çš„ `resolve` çš„ç»“æœã€‚
4. æ•°ç»„ä¸­åªè¦æœ‰ä¸€ä¸ª `Promise` å®ä¾‹å¤±è´¥ï¼ˆç”±`pendding`çŠ¶æ€è½¬åŒ–ä¸º`rejected`çŠ¶æ€ï¼‰ï¼Œ`Promise.all` å°±å¤±è´¥ã€‚`Promise.all` çš„ `.catch()` ä¼šæ•è·åˆ°è¿™ä¸ª `reject`ã€‚

### åŸç”Ÿ Promise.all æµ‹è¯•

å’±å…ˆçœ‹çœ‹åŸç”Ÿçš„`Promise.all`çš„æ˜¯å•¥æ•ˆæœã€‚

```js
const p1 = Promise.resolve('p1')

const p2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('p2 å»¶æ—¶ä¸€ç§’')
  }, 1000)
})

const p3 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('p3 å»¶æ—¶ä¸¤ç§’')
  }, 2000)
})

const p4 = Promise.reject('p4 rejected')

const p5 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('p5 rejected å»¶æ—¶1.5ç§’')
  }, 1500)
})

// æ‰€æœ‰Promiseå®ä¾‹éƒ½æˆåŠŸ
Promise.all([p1, p2, p3])
  .then(res => {
    console.log(res)
  })
  .catch(err => console.log(err)) // 2ç§’åæ‰“å° [ 'p1', 'p2 å»¶æ—¶ä¸€ç§’', 'p3 å»¶æ—¶ä¸¤ç§’' ]
  
// ä¸€ä¸ªPromiseå®ä¾‹å¤±è´¥
Promise.all([p1, p2, p4])
  .then(res => {
    console.log(res)
  })
  .catch(err => console.log(err)) // p4 rejected
  
// ä¸€ä¸ªå»¶æ—¶å¤±è´¥çš„Promise
 Promise.all([p1, p2, p5])
  .then(res => {
    console.log(res)
  })
  .catch(err => console.log(err)) // 1.5ç§’åæ‰“å° p5 rejected
  
// ä¸¤ä¸ªPromiseå®ä¾‹å¤±è´¥
Promise.all([p1, p4, p5])
  .then(res => {
    console.log(res)
  })
  .catch(err => console.log(err)) // p4 rejected


å¤åˆ¶ä»£ç 
```

**æ³¨æ„**

ä¸Šé¢ `p4` å’Œ `p5` åœ¨æœªä¼ å…¥ `Promise.all` æ—¶éœ€è¦æ³¨é‡Šæ‰ï¼Œå› ä¸ºä¸€ä¸ªè°ƒç”¨äº† `reject` çš„ `Promise` å®ä¾‹å¦‚æœæ²¡æœ‰ä½¿ç”¨ `.catch()` æ–¹æ³•å»æ•è·é”™è¯¯ä¼šæŠ¥é”™ã€‚ä½†å¦‚æœ `Promise` å®ä¾‹å®šä¹‰äº†è‡ªå·±çš„ `.catch`ï¼Œå°±ä¸ä¼šè§¦å‘ `Promise.all` çš„ `.catch()` æ–¹æ³•ã€‚

OKï¼Œç†è®ºå­˜åœ¨ï¼Œå®è·µå¼€å§‹ï¼

## æ‰‹åŠ¨å®ç°Promise.all

1. `Promise.all` æ¥å—ä¸€ä¸ªæ•°ç»„ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªæ–°çš„ `Promise` å®ä¾‹

```js
Promise.MyAll = function (promises) {
  return new Promise((resolve, reject) => {

  })
}
å¤åˆ¶ä»£ç 
```

1. æ•°ç»„ä¸­æ‰€æœ‰ `Promise` å®ä¾‹éƒ½æˆåŠŸï¼Œ`Promise.all` æ‰æˆåŠŸã€‚ä¸éš¾æƒ³åˆ°ï¼Œå’±å¾—éœ€è¦ä¸€ä¸ªæ•°ç»„æ¥æ”¶é›†è¿™äº› `Promise` å®ä¾‹çš„ `resolve` ç»“æœã€‚ä½†æœ‰å¥ä¿—è¯è¯´å¾—å¥½ï¼šâ€œä¸æ€•ä¸€ä¸‡ï¼Œå°±æ€•ä¸‡ä¸€â€ï¼Œä¸‡ä¸€æ•°ç»„é‡Œé¢æœ‰å…ƒç´ ä¸æ˜¯ `Promise`å’‹åŠ â€”â€” é‚£å°±å¾—ç”¨ `Promise.resolve()` æŠŠå®ƒåŠäº†ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ`Promise` å®ä¾‹æ˜¯ä¸èƒ½ç›´æ¥è°ƒç”¨ `resolve` æ–¹æ³•çš„ï¼Œå’±å¾—åœ¨ `.then()` ä¸­å»æ”¶é›†ç»“æœã€‚æ³¨æ„è¦ä¿æŒç»“æœçš„é¡ºåºã€‚

```js
Promise.MyAll = function (promises) {
  let arr = []
  return new Promise((resolve, reject) => {
    promises.forEach((item, i) => {
      Promise.resolve(item).then(res => {
        arr[i] = res
      })
    }) 
  })
}
å¤åˆ¶ä»£ç 
```

1. å°†æ”¶é›†åˆ°çš„ç»“æœï¼ˆæ•°ç»„`arr`ï¼‰ä½œä¸ºå‚æ•°ä¼ ç»™å¤–å±‚çš„ `resolve` æ–¹æ³•ã€‚è¿™é‡Œå’±ä»¬è‚¯å®šæ˜¯æœ‰ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶çš„ï¼Œå¦‚ä½•åˆ¤æ–­æ‰€æœ‰ `Promise` å®ä¾‹éƒ½æˆåŠŸäº†å‘¢ï¼Ÿæ–°æ‰‹å®¹æ˜“å†™å‡ºè¿™å¥ä»£ç ï¼ˆæ²¡é”™å°±æ˜¯æˆ‘æœ¬äººäº†ğŸ˜­ï¼‰ï¼š

```js
if (arr.length === promises.length) resolve(arr)
å¤åˆ¶ä»£ç 
```

å’±ä»”ç»†æƒ³æƒ³ `Promise` ä½¿ç”¨æ¥å¹²å˜›çš„ â€”â€” å¤„ç†å¼‚æ­¥ä»»åŠ¡ã€‚å¯¹å‘€ï¼Œå¼‚æ­¥ä»»åŠ¡å¾ˆå¤šéƒ½éœ€è¦èŠ±æ—¶é—´å‘€ï¼Œå¦‚æœè¿™äº› `Promise` ä¸­æœ€åä¸€ä¸ªå…ˆå®Œæˆå‘¢ï¼Ÿé‚£ `arr` æ•°ç»„ä¸å°±åªæœ‰æœ€åä¸€é¡¹äº†ï¼Œå‰é¢çš„æ‰€æœ‰é¡¹éƒ½æ˜¯ `empty`ã€‚æ‰€ä»¥è¿™é‡Œå’±ä»¬åº”è¯¥åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯æœ‰ä¸€ä¸ª `Promise` å®ä¾‹æˆåŠŸï¼Œè®¡æ•°å™¨åŠ ä¸€ï¼š

```js
Promise.MyAll = function (promises) {
  let arr = [],
    count = 0
  return new Promise((resolve, reject) => {
    promises.forEach((item, i) => {
      Promise.resolve(item).then(res => {
        arr[i] = res
        count += 1
        if (count === promises.length) resolve(arr)
      })
    })
  })
}
å¤åˆ¶ä»£ç 
```

1. æœ€åå°±æ˜¯å¤„ç†å¤±è´¥çš„æƒ…å†µäº†ï¼Œè¿™é‡Œæœ‰ä¸¤ç§å†™æ³•ï¼Œç¬¬ä¸€ç§æ˜¯ç”¨ `.catch()` æ–¹æ³•æ•è·å¤±è´¥ï¼š

```js
Promise.MyAll = function (promises) {
  let arr = [],
    count = 0
  return new Promise((resolve, reject) => {
    promises.forEach((item, i) => {
      Promise.resolve(item).then(res => {
        arr[i] = res
        count += 1
        if (count === promises.length) resolve(arr)
      }).catch(reject)
    })
  })
}
å¤åˆ¶ä»£ç 
```

ç¬¬äºŒç§å†™æ³•å°±æ˜¯ç»™ `.then()` æ–¹æ³•ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å¤„ç†é”™è¯¯çš„å›è°ƒå‡½æ•°ï¼š

```js
Promise.MyAll = function (promises) {
  let arr = [],
    count = 0
  return new Promise((resolve, reject) => {
    promises.forEach((item, i) => {
      Promise.resolve(item).then(res => {
        arr[i] = res
        count += 1
        if (count === promises.length) resolve(arr)
      }, reject)
    })
  })
}
å¤åˆ¶ä»£ç 
```

### æµ‹è¯•æ¡ˆä¾‹

è‡´æ­¤ `Promise.all` å¤§åŠŸå‘Šæˆï¼Œèµ¶ç´§æ‹¿æ¥æµ‹è¯•ä¸€ä¸‹ï¼ˆæ‘©æ‹³æ“¦æŒï¼‰ï¼š

```js
const p1 = Promise.resolve('p1')
const p2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('p2 å»¶æ—¶ä¸€ç§’')
  }, 1000)
})
const p3 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('p3 å»¶æ—¶ä¸¤ç§’')
  }, 2000)
})

const p4 = Promise.reject('p4 rejected')

const p5 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('p5 rejected å»¶æ—¶1.5ç§’')
  }, 1500)
})

// æ‰€æœ‰ Promsie éƒ½æˆåŠŸ
Promise.MyAll([p1, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // 2ç§’åæ‰“å° [ 'p1', 'p2 å»¶æ—¶ä¸€ç§’', 'p3 å»¶æ—¶ä¸¤ç§’' ]
  
// ä¸€ä¸ª Promise å¤±è´¥
Promise.MyAll([p1, p2, p4])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p4 rejected
  
// ä¸€ä¸ªå»¶æ—¶å¤±è´¥çš„ Promise
Promise.MyAll([p1, p2, p5])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // 1.5ç§’åæ‰“å° p5 rejected å»¶æ—¶1.5ç§’
 
// ä¸¤ä¸ªå¤±è´¥çš„ Promise
Promise.MyAll([p1, p4, p5])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p4 rejected
å¤åˆ¶ä»£ç 
```

â€œOhOhOhOh~~~~â€ï¼Œä¸åŸç”Ÿçš„ `Promise.all`è¿è¡Œç»“æœä¸èƒ½è¯´å¾ˆåƒï¼Œåªèƒ½è¯´ä¸€æ¨¡ä¸€æ ·ã€‚è€è¯è¯´çš„å¥½ï¼Œè¶çƒ­æ‰“é“â€”â€”æ­£åœ¨ç«å€™ä¸Šã€‚æˆ‘æ‰“å¼€æŸä¸ªå­¦ä¹ ç½‘ç«™ï¼ˆ[MDN Web Docs (mozilla.org)](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2F)ï¼‰ï¼Œäº†è§£åˆ° `Promise` å¯¹è±¡ç”¨äºåŒæ—¶å¤„ç†å¤šä¸ª `Promise` çš„æ–¹æ³•è¿˜æœ‰ `Promise.race`ã€`Promise.any`ã€`Promise.allSettle`ã€‚ä»å°è€å¸ˆå°±æ•™ä¼šäº†å’±ä»¬ä¸¾ä¸€åä¸‰ï¼Œä»”ç»†çœ‹äº†è¿™ä¸‰ä¸ªæ–¹æ³•çš„æè¿°ä¹‹åï¼Œæˆ‘è¿˜çœŸç»™åå‡ºæ¥äº†ğŸ˜„ã€‚

## Promise.race

`Promise.race` ä»å­—é¢æ„æ€ç†è§£å°±æ˜¯èµ›è·‘ï¼Œä»¥çŠ¶æ€å˜åŒ–æœ€å¿«çš„é‚£ä¸ª `Promise` å®ä¾‹ä¸ºå‡†ï¼Œæœ€å¿«çš„ `Promise` æˆåŠŸ `Promise.race` å°±æˆåŠŸï¼Œæœ€å¿«çš„ `Promise` å¤±è´¥ `Promise.race` å°±å¤±è´¥ã€‚

å’±æ¥çœ‹çœ‹åŸç”Ÿ `Promise.race` æ•ˆæœ

### åŸç”Ÿ Promise.race æµ‹è¯•

```js
const p1 = Promise.resolve('p1')
const p2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('p2 å»¶æ—¶ä¸€ç§’')
  }, 1000)
})
const p3 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('p3 å»¶æ—¶ä¸¤ç§’')
  }, 2000)
})

const p4 = Promise.reject('p4 rejected')

const p5 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('p5 rejected å»¶æ—¶1ç§’')
  }, 1500)
})

// p1æ— å»¶æ—¶ï¼Œp2å»¶æ—¶1sï¼Œp3å»¶æ—¶2s
Promise.race([p1, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p1

// p4æ— å»¶æ—¶reject
Promise.race([p4, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p4 rejected
  
// p5 å»¶æ—¶1.5ç§’rejectï¼Œp2å»¶æ—¶1s
Promise.race([p5, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // 1såæ‰“å°: p2 å»¶æ—¶ä¸€ç§’
å¤åˆ¶ä»£ç 
```

ç†è®ºå­˜åœ¨ï¼Œå®è·µå¼€å§‹

### æ‰‹å†™Promise.race

æ•´ä½“æµç¨‹ä¸ `Promise` å·®ä¸å¤šï¼Œåªæ˜¯å¯¹æ•°ç»„ä¸­çš„ `Promise` å®ä¾‹å¤„ç†çš„é€»è¾‘ä¸ä¸€æ ·ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å°†æœ€å¿«æ”¹å˜çŠ¶æ€çš„ `Promise` ç»“æœä½œä¸º `Promise.race` çš„ç»“æœï¼Œç›¸å¯¹æ¥è¯´å°±æ¯”è¾ƒç®€å•äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
Promise.MyRace = function (promises) {
  return new Promise((resolve, reject) => {
    // è¿™é‡Œä¸éœ€è¦ä½¿ç”¨ç´¢å¼•ï¼Œåªè¦èƒ½å¾ªç¯å‡ºæ¯ä¸€é¡¹å°±è¡Œ
    for (const item of promises) {
      Promise.resolve(item).then(resolve, reject)
    }
  })
}
å¤åˆ¶ä»£ç 
```

### æµ‹è¯•æ¡ˆä¾‹

è¿˜æ˜¯åˆšæ‰å‡ ä¸ªæ¡ˆä¾‹ï¼Œå’±å°±ä¸é‡å¤å†™äº†ğŸ˜

```js
// p1æ— å»¶æ—¶ï¼Œp2å»¶æ—¶1sï¼Œp3å»¶æ—¶2s
Promise.MyRace([p1, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p1

// p4æ— å»¶æ—¶reject
Promise.MyRace([p4, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p4 rejected
  
// p5 å»¶æ—¶1.5ç§’rejectï¼Œp2å»¶æ—¶1s
Promise.MyRace([p5, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // 1såæ‰“å°: p2 å»¶æ—¶ä¸€ç§’
å¤åˆ¶ä»£ç 
```

å¯ä»¥çœ‹åˆ°ï¼Œç»“æœä¸åŸç”Ÿçš„ `Promise.race` æ˜¯ä¸€è‡´çš„ï¼ŒæˆåŠŸï¼

## Promise.any

`Promise.any` ä¸ `Promise.all` å¯ä»¥çœ‹åšæ˜¯ç›¸åçš„ã€‚`Promise.any` ä¸­åªè¦æœ‰ä¸€ä¸ª `Promise` å®ä¾‹æˆåŠŸå°±æˆåŠŸï¼Œåªæœ‰å½“æ‰€æœ‰çš„ `Promise` å®ä¾‹å¤±è´¥æ—¶ `Promise.any` æ‰å¤±è´¥ï¼Œæ­¤æ—¶`Promise.any` ä¼šæŠŠæ‰€æœ‰çš„å¤±è´¥/é”™è¯¯é›†åˆåœ¨ä¸€èµ·ï¼Œè¿”å›ä¸€ä¸ªå¤±è´¥çš„ `promise `å’Œ[`AggregateError`](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FAggregateError)ç±»å‹çš„å®ä¾‹ã€‚MDN ä¸Šè¯´è¿™ä¸ªæ–¹æ³•è¿˜å¤„äºè¯•éªŒé˜¶æ®µï¼Œå¦‚æœ `node` æˆ–è€…æµè§ˆå™¨ç‰ˆæœ¬è¿‡ä½å¯èƒ½æ— æ³•ä½¿ç”¨ï¼Œå„ä½çœ‹å®˜è‡ªè¡Œæµ‹è¯•ä¸‹ã€‚

### åŸç”Ÿ Promise.any æµ‹è¯•

```js
const p1 = Promise.resolve('p1')
const p2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('p2 å»¶æ—¶ä¸€ç§’')
  }, 1000)
})
const p3 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('p3 å»¶æ—¶ä¸¤ç§’')
  }, 2000)
})

const p4 = Promise.reject('p4 rejected')

const p5 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('p5 rejected å»¶æ—¶1.5ç§’')
  }, 1500)
})

// æ‰€æœ‰ Promise éƒ½æˆåŠŸ
Promise.any([p1, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p1
  
// ä¸¤ä¸ª Promise æˆåŠŸ
Promise.any([p1, p2, p4])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p1

// åªæœ‰ä¸€ä¸ªå»¶æ—¶æˆåŠŸçš„ Promise
Promise.any([p2, p4, p5])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p2 å»¶æ—¶1ç§’

// æ‰€æœ‰ Promise éƒ½å¤±è´¥
Promise.any([p4, p5])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // AggregateError: All promises were rejected
å¤åˆ¶ä»£ç 
```

å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœ `Promise.any` ä¸­æœ‰å¤šä¸ªæˆåŠŸçš„ `Promise` å®ä¾‹ï¼Œåˆ™ä»¥æœ€å¿«æˆåŠŸçš„é‚£ä¸ªç»“æœä½œä¸ºè‡ªèº« `resolve` çš„ç»“æœã€‚

OKï¼Œç†è®ºå­˜åœ¨ï¼Œå®è·µå¼€å§‹

### æ‰‹å†™Promise.any

1. ä¾è‘«èŠ¦ç”»ç“¢ï¼Œå’±ä»¬å…ˆå†™å‡º `Promise.any` çš„æ•´ä½“ç»“æ„ï¼š

```js
Promise.MyAny = function (promises) {
  return new Promise((resolve, reject) => {
    promises.forEach((item, i) => {

    })
  })
}
å¤åˆ¶ä»£ç 
```

1. è¿™é‡Œè·Ÿ`Promise.all` çš„é€»è¾‘æ˜¯åçš„ï¼Œå’±ä»¬éœ€è¦æ”¶é›† `reject` çš„ `Promise`ï¼Œä¹Ÿéœ€è¦ä¸€ä¸ªæ•°ç»„å’Œè®¡æ•°å™¨ï¼Œç”¨è®¡æ•°å™¨åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„ `Promise` å®ä¾‹éƒ½å¤±è´¥ã€‚å¦å¤–åœ¨æ”¶é›†å¤±è´¥çš„ `Promise` ç»“æœæ—¶å’±éœ€è¦æ‰“ä¸Šä¸€ä¸ªå¤±è´¥çš„æ ‡è®°æ–¹ä¾¿åˆ†æç»“æœã€‚

```js
Promise.MyAny = function (promises) {
  let arr = [],
    count = 0
  return new Promise((resolve, reject) => {
    promises.forEach((item, i) => {
      Promise.resolve(item).then(resolve, err => {
        arr[i] = { status: 'rejected', val: err }
        count += 1
        if (count === promises.length) reject(new Error('æ²¡æœ‰promiseæˆåŠŸ'))
      })
    })
  })
}
å¤åˆ¶ä»£ç 
```

è¿™é‡Œæˆ‘æ²¡æœ‰ä½¿ç”¨ MDN ä¸Šè§„å®šçš„ `AggregateError` å®ä¾‹ï¼Œæ‰‹å†™å˜›ï¼Œéšå¿ƒæ‰€æ¬²ä¸€ç‚¹ï¼Œå†™è‡ªå·±çœ‹ç€èˆ’æœçš„ğŸ˜„

### æµ‹è¯•æ¡ˆä¾‹

```js
// æ‰€æœ‰ Promise éƒ½æˆåŠŸ
Promise.MyAny([p1, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p1
  
// ä¸¤ä¸ª Promise æˆåŠŸ
Promise.MyAny([p1, p2, p4])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p1

// åªæœ‰ä¸€ä¸ªå»¶æ—¶æˆåŠŸçš„ Promise
Promise.MyAny([p2, p4, p5])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // p2 å»¶æ—¶1ç§’

// æ‰€æœ‰ Promise éƒ½å¤±è´¥
Promise.MyAny([p4, p5])
  .then(res => console.log(res))
  .catch(err => console.log(err)) // æ²¡æœ‰promiseæˆåŠŸ
å¤åˆ¶ä»£ç 
```

## Promise.allSettled

æœ‰æ—¶å€™ï¼Œå’±ä»£ç äººæ€»æ˜¯ä¼šæœ‰ç‚¹ç‰¹æ®Šçš„éœ€æ±‚ï¼šå¦‚æœå’±å¸Œæœ›ä¸€ç»„ `Promise` å®ä¾‹æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½ç­‰å®ƒä»¬å¼‚æ­¥æ“ä½œç»“æŸäº†åœ¨ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œè¿™å¯å¦‚ä½•æ˜¯å¥½ï¼Ÿäºæ˜¯å°±å‡ºç°äº† `Promise.allSettled`ã€‚

### åŸç”Ÿ `Promise.allSettled` æµ‹è¯•

```js
const p1 = Promise.resolve('p1')
const p2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('p2 å»¶æ—¶ä¸€ç§’')
  }, 1000)
})
const p3 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve('p3 å»¶æ—¶ä¸¤ç§’')
  }, 2000)
})

const p4 = Promise.reject('p4 rejected')

const p5 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject('p5 rejected å»¶æ—¶1.5ç§’')
  }, 1500)
})

// æ‰€æœ‰ Promise å®ä¾‹éƒ½æˆåŠŸ
Promise.allSettled([p1, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) 
// [
//   { status: 'fulfilled', value: 'p1' },
//   { status: 'fulfilled', value: 'p2 å»¶æ—¶ä¸€ç§’' },
//   { status: 'fulfilled', value: 'p3 å»¶æ—¶ä¸¤ç§’' }
// ]

// æœ‰ä¸€ä¸ª Promise å¤±è´¥
Promise.allSettled([p1, p2, p4])
  .then(res => console.log(res))
  .catch(err => console.log(err))
// [
//   { status: 'fulfilled', value: 'p1' },
//   { status: 'fulfilled', value: 'p2 å»¶æ—¶ä¸€ç§’' },
//   { status: 'rejected' , value: 'p4 rejected' }
// ]

// æ‰€æœ‰ Promise éƒ½å¤±è´¥
Promise.allSettled([p4, p5])
  .then(res => console.log(res))
  .catch(err => console.log(err))
// [
//   { status: 'rejected', reason: 'p4 rejected' },
//   { status: 'rejected', reason: 'p5 rejected å»¶æ—¶1.5ç§’' }
// ]
å¤åˆ¶ä»£ç 
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸ `Promise.any` ç±»ä¼¼ï¼Œ`Promise.allSettled` ä¹Ÿç»™æ‰€æœ‰æ”¶é›†åˆ°çš„ç»“æœæ‰“ä¸Šäº†æ ‡è®°ã€‚è€Œä¸” `Promise.allSettled` æ˜¯ä¸ä¼šå˜æˆ `rejected` çŠ¶æ€çš„ï¼Œä¸ç®¡ä¸€ç»„ `Promise` å®ä¾‹çš„å„è‡ªç»“æœå¦‚ä½•ï¼Œ`Promise.allSettled` éƒ½ä¼šè½¬å˜ä¸º `fulfilled` çŠ¶æ€ã€‚

OKï¼Œç†è®ºå­˜åœ¨ï¼Œå®è·µå¼€å§‹

### æ‰‹å†™ Promise.allSettled

å’±å°±æ˜¯è¯´ï¼Œå¾—ç”¨ä¸ªæ•°ç»„æŠŠæ‰€æœ‰çš„ `Promise` å®ä¾‹çš„ç»“æœï¼ˆæ— è®ºæˆåŠŸä¸å¦ï¼‰éƒ½æ”¶é›†èµ·æ¥ï¼Œåˆ¤æ–­æ”¶é›†å®Œäº†ï¼ˆæ‰€æœ‰ `Promise` å®ä¾‹çŠ¶æ€éƒ½æ”¹å˜äº†ï¼‰ï¼Œå’±å°±å°†è¿™ä¸ªæ”¶é›†åˆ°çš„ç»“æœ `resolve` æ‰ã€‚æ”¶é›†æˆåŠŸ `Promise` ç»“æœçš„é€»è¾‘å’±ä»¬åœ¨ `Promise.all` ä¸­å®ç°è¿‡ï¼Œæ”¶é›†å¤±è´¥ `Promise` ç»“æœå’±ä»¬åœ¨ `Promise.any` ä¸­å¤„ç†è¿‡ã€‚è¿™æ³¢ï¼Œè¿™æ³¢æ˜¯ä¾è‘«èŠ¦ç”»ç“¢â€”â€”ç…§æ ·ã€‚

```js
Promise.MyAllSettled = function (promises) {
  let arr = [],
    count = 0
  return new Promise((resolve, reject) => {
    promises.forEach((item, i) => {
      Promise.resolve(item).then(res => {
        arr[i] = { status: 'fulfilled', val: res }
        count += 1
        if (count === promises.length) resolve(arr)
      }, (err) => {
        arr[i] = { status: 'rejected', val: err }
        count += 1
        if (count === promises.length) resolve(arr)
      })
    })
  })
}
å¤åˆ¶ä»£ç 
```

è¿™ä»£ç ï¼Œé€»è¾‘ä¸Šè™½è¯´æ²¡é—®é¢˜ï¼Œä½†å„ä½ä¼˜ç§€çš„ç¨‹åºå‘˜ä»¬è‚¯å®šæ˜¯çœ‹ä¸é¡ºçœ¼çš„ï¼Œæ€ä¹ˆä¼šæœ‰ä¸¤æ®µé‡å¤çš„ä»£ç æï¼Œä¸è¡Œï¼Œå’±å¾—å°è£…ä¸€ä¸‹ã€‚

```js
Promise.MyAllSettled = function (promises) {
  let arr = [],
    count = 0
  return new Promise((resolve, reject) => {
    const processResult = (res, index, status) => {
      arr[index] = { status: status, val: res }
      count += 1
      if (count === promises.length) resolve(arr)
    }

    promises.forEach((item, i) => {
      Promise.resolve(item).then(res => {
        processResult(res, i, 'fulfilled')
      }, err => {
        processResult(err, i, 'rejected')
      })
    })
  })
}
å¤åˆ¶ä»£ç 
```

perfectï¼Œä¿—è¯è¯´å¾—å¥½ï¼šæ²¡ç—…èµ°ä¸¤æ­¥ã€‚è€æ ·å­ï¼Œç»™ä»£ç è·‘å‡ ä¸ªæ¡ˆä¾‹ã€‚

### æµ‹è¯•æ¡ˆä¾‹

```js
// æ‰€æœ‰ Promise å®ä¾‹éƒ½æˆåŠŸ
Promise.MyAllSettled([p1, p2, p3])
  .then(res => console.log(res))
  .catch(err => console.log(err)) 
// [
//   { status: 'fulfilled', value: 'p1' },
//   { status: 'fulfilled', value: 'p2 å»¶æ—¶ä¸€ç§’' },
//   { status: 'fulfilled', value: 'p3 å»¶æ—¶ä¸¤ç§’' }
// ]

// æœ‰ä¸€ä¸ª MyAllSettled å¤±è´¥
Promise.allSettled([p1, p2, p4])
  .then(res => console.log(res))
  .catch(err => console.log(err))
// [
//   { status: 'fulfilled', value: 'p1' },
//   { status: 'fulfilled', value: 'p2 å»¶æ—¶ä¸€ç§’' },
//   { status: 'rejected' , value: 'p4 rejected' }
// ]

// æ‰€æœ‰ MyAllSettled éƒ½å¤±è´¥
Promise.allSettled([p4, p5])
  .then(res => console.log(res))
  .catch(err => console.log(err))
// [
//   { status: 'rejected', reason: 'p4 rejected' },
//   { status: 'rejected', reason: 'p5 rejected å»¶æ—¶1.5ç§’' }
// ]
å¤åˆ¶ä»£ç 
```

è‡´æ­¤ï¼Œå¤§åŠŸå‘Šæˆï¼Œæˆ‘å¯ä»¥éª„å‚²åœ°å¯¹å¦ˆå¦ˆè¯´ï¼šâ€œå¦ˆå¦ˆï¼Œæˆ‘å†ä¹Ÿä¸æ€• Promise.allâ€äº†

## ç»“è¯­

è¿™æ¬¡å­—èŠ‚é£ä¹¦é¢è¯•å¯¹æˆ‘æ¥è¯´æ˜¯ä¸€ä¸ªå·¨å¤§çš„æœºé‡ï¼Œç¬¬ä¸€æ¬¡ä½“éªŒé¢å¤§å‚çš„æ„Ÿè§‰ï¼Œå¯èƒ½æœ‰æš´èºè€å“¥è¦è¯´äº†ï¼šâ€œå­—èŠ‚é¢è¯•é¢˜å°±è¿™ï¼Ÿä½ æ˜¯æ°´æ–‡ç« éª—èµçš„å§â€ã€‚å®³ï¼Œæ²¡åŠæ³•ï¼Œä¸»è¦æ˜¯æˆ‘å¤ªèœäº†ï¼Œä»ä»£ç ä¸çŸ¥ä¸ºä½•ç‰©åˆ°ç°åœ¨å‰ç«¯å­¦ä¹ è€…ï¼Œå°”æ¥8æœˆå³ä¸€å‘¨çŸ£ï¼Œæ°´å¹³ç¡®å®æ¯”è¾ƒæ¬¡ï¼Œé¢è¯•å®˜æ¯”è¾ƒå’Œå–„ï¼Œå°±æ²¡æœ‰ä¸ºéš¾æˆ‘ï¼Œé—®çš„é—®é¢˜éƒ½æ¯”è¾ƒåŸºç¡€ã€‚ä½†æˆ‘ä»ç„¶æ”¶è·é¢‡ä¸°ï¼Œæ„Ÿè°¢å­—èŠ‚å›¢é˜Ÿï¼Œæ„Ÿè°¢å‰ç«¯è¿™ä¸ªåŒ…å®¹ã€è¿›æ­¥çš„ç¯å¢ƒï¼Œæˆ‘ä¼šå¥½å¥½æ€»ç»“è¿™æ¬¡é¢è¯•ï¼Œå°½å¯èƒ½åœ°æå‡è‡ªå·±ï¼ŒåŠ æ²¹ï¼

## å‰è¨€

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æ—ä¸‰å¿ƒï¼Œç›¸ä¿¡å¤§å®¶åœ¨æ—¥å¸¸å¼€å‘ä¸­éƒ½ç”¨è¿‡**Promise**ï¼Œæˆ‘ä¸€ç›´æœ‰ä¸ªæ¢¦æƒ³ï¼Œå°±æ˜¯**ä»¥æœ€é€šä¿—çš„è¯ï¼Œè®²æœ€å¤æ‚çš„çŸ¥è¯†**ï¼Œæ‰€ä»¥æˆ‘æŠŠ**é€šä¿—æ˜“æ‡‚**æ”¾åœ¨äº†é¦–ä½ï¼Œä»Šå¤©å°±å¸¦å¤§å®¶æ‰‹å†™å®ç°ä»¥ä¸‹**Promiseå§**ï¼Œç›¸ä¿¡å¤§å®¶ä¸€çœ‹å°±æ‡‚ã€‚

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/032d1f70ba34471e81d047b3ff7e2eab~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

## resolveå’Œreject

å’±ä»¬æ¥çœ‹ä¸€æ®µPromiseçš„ä»£ç ï¼š

```js
let p1 = new Promise((resolve, reject) => {
    resolve('æˆåŠŸ')
    reject('å¤±è´¥')
})
console.log('p1', p1)

let p2 = new Promise((resolve, reject) => {
    reject('å¤±è´¥')
    resolve('æˆåŠŸ')
})
console.log('p2', p2)

let p3 = new Promise((resolve, reject) => {
    throw('æŠ¥é”™')
})
console.log('p3', p3)

å¤åˆ¶ä»£ç 
```

é‚£ä¹ˆä¼šè¾“å‡ºä»€ä¹ˆå‘¢ï¼Ÿè¯·çœ‹ï¼š

![æˆªå±2021-08-01 ä¸Šåˆ11.53.33.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db87e7956fa24650bb60902bc3f113b4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

è¿™é‡Œæš´éœ²å‡ºäº†å››ä¸ªçŸ¥è¯†ç‚¹ï¼š

- 1ã€æ‰§è¡Œäº†`resolve`ï¼ŒPromiseçŠ¶æ€ä¼šå˜æˆ`fulfilled`
- 2ã€æ‰§è¡Œäº†`reject`ï¼ŒPromiseçŠ¶æ€ä¼šå˜æˆ`rejected`
- 3ã€Promiseåªä»¥`ç¬¬ä¸€æ¬¡ä¸ºå‡†`ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸå°±`æ°¸ä¹…`ä¸º`fulfilled`ï¼Œç¬¬ä¸€æ¬¡å¤±è´¥å°±æ°¸è¿œçŠ¶æ€ä¸º`rejected`
- 4ã€Promiseä¸­æœ‰`throw`çš„è¯ï¼Œå°±ç›¸å½“äºæ‰§è¡Œäº†`reject` é‚£ä¹ˆå’±ä»¬å°±æŠŠè¿™å››ä¸ªçŸ¥è¯†ç‚¹ä¸€æ­¥æ­¥å®ç°å§ï¼ï¼ï¼

### 1ã€å®ç°resolveä¸reject

å¤§å®¶è¦æ³¨æ„ï¼šPromiseçš„åˆå§‹çŠ¶æ€æ˜¯`pending`

è¿™é‡Œå¾ˆé‡è¦çš„ä¸€æ­¥æ˜¯`resolveå’Œrejectçš„ç»‘å®šthis`ï¼Œä¸ºä»€ä¹ˆè¦ç»‘å®š`this`å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†resolveå’Œrejectçš„`thisæŒ‡å‘`æ°¸è¿œæŒ‡å‘å½“å‰çš„`MyPromiseå®ä¾‹`ï¼Œé˜²æ­¢éšç€å‡½æ•°æ‰§è¡Œç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜

```js
class MyPromise {
    // æ„é€ æ–¹æ³•
    constructor(executor) {

        // åˆå§‹åŒ–å€¼
        this.initValue()
        // åˆå§‹åŒ–thisæŒ‡å‘
        this.initBind()
        // æ‰§è¡Œä¼ è¿›æ¥çš„å‡½æ•°
        executor(this.resolve, this.reject)
    }

    initBind() {
        // åˆå§‹åŒ–this
        this.resolve = this.resolve.bind(this)
        this.reject = this.reject.bind(this)
    }

    initValue() {
        // åˆå§‹åŒ–å€¼
        this.PromiseResult = null // ç»ˆå€¼
        this.PromiseState = 'pending' // çŠ¶æ€
    }

    resolve(value) {
        // å¦‚æœæ‰§è¡Œresolveï¼ŒçŠ¶æ€å˜ä¸ºfulfilled
        this.PromiseState = 'fulfilled'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„å€¼
        this.PromiseResult = value
    }

    reject(reason) {
        // å¦‚æœæ‰§è¡Œrejectï¼ŒçŠ¶æ€å˜ä¸ºrejected
        this.PromiseState = 'rejected'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„reason
        this.PromiseResult = reason
    }
}
å¤åˆ¶ä»£ç 
```

å’±ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ä»£ç å§ï¼š

```js
const test1 = new MyPromise((resolve, reject) => {
    resolve('æˆåŠŸ')
})
console.log(test1) // MyPromise { PromiseState: 'fulfilled', PromiseResult: 'æˆåŠŸ' }

const test2 = new MyPromise((resolve, reject) => {
    reject('å¤±è´¥')
})
console.log(test2) // MyPromise { PromiseState: 'rejected', PromiseResult: 'å¤±è´¥' }
å¤åˆ¶ä»£ç 
```

### 2. çŠ¶æ€ä¸å¯å˜

å…¶å®ä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿçœ‹çœ‹ï¼š

```js
const test1 = new MyPromise((resolve, reject) => {
    resolve('æˆåŠŸ')
    reject('å¤±è´¥')
})
console.log(test1) // MyPromise { PromiseState: 'rejected', PromiseResult: 'å¤±è´¥' }
å¤åˆ¶ä»£ç 
```

æ­£ç¡®çš„åº”è¯¥æ˜¯çŠ¶æ€ä¸º`fulfilled`ï¼Œç»“æœæ˜¯`æˆåŠŸ`ï¼Œè¿™é‡Œæ˜æ˜¾æ²¡æœ‰`ä»¥ç¬¬ä¸€æ¬¡ä¸ºå‡†`

ä¹‹å‰è¯´äº†ï¼ŒPromiseåªä»¥`ç¬¬ä¸€æ¬¡ä¸ºå‡†`ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸå°±`æ°¸ä¹…`ä¸º`fulfilled`ï¼Œç¬¬ä¸€æ¬¡å¤±è´¥å°±æ°¸è¿œçŠ¶æ€ä¸º`rejected`ï¼Œå…·ä½“æ˜¯ä»€ä¹ˆæµç¨‹å‘¢ï¼Ÿæˆ‘ç»™å¤§å®¶ç”»äº†ä¸€å¼ å›¾ï¼š

Promiseæœ‰ä¸‰ç§çŠ¶æ€ï¼š

- `pending`ï¼šç­‰å¾…ä¸­ï¼Œæ˜¯åˆå§‹çŠ¶æ€
- `fulfilled`ï¼šæˆåŠŸçŠ¶æ€
- `rejected`ï¼šå¤±è´¥çŠ¶æ€

ä¸€æ—¦çŠ¶æ€ä»`pending`å˜ä¸º`fulfilledæˆ–è€…rejected`ï¼Œé‚£ä¹ˆæ­¤Promiseå®ä¾‹çš„çŠ¶æ€å°±å®šæ­»äº†ã€‚ ![æˆªå±2021-08-01 ä¸‹åˆ12.33.10.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2c9636d819ef4bc78af95fb80c9a7be4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å…¶å®å®ç°èµ·æ¥ä¹Ÿå¾ˆå®¹æ˜“ï¼ŒåŠ ä¸ªåˆ¤æ–­æ¡ä»¶å°±è¡Œï¼š

```js
    resolve(value) {
        // stateæ˜¯ä¸å¯å˜çš„
+        if (this.PromiseState !== 'pending') return
        // å¦‚æœæ‰§è¡Œresolveï¼ŒçŠ¶æ€å˜ä¸ºfulfilled
        this.PromiseState = 'fulfilled'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„å€¼
        this.PromiseResult = value
    }

    reject(reason) {
        // stateæ˜¯ä¸å¯å˜çš„
+        if (this.PromiseState !== 'pending') return
        // å¦‚æœæ‰§è¡Œrejectï¼ŒçŠ¶æ€å˜ä¸ºrejected
        this.PromiseState = 'rejected'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„reason
        this.PromiseResult = reason
    }
å¤åˆ¶ä»£ç 
```

å†æ¥çœ‹çœ‹æ•ˆæœï¼š

```js
const test1 = new MyPromise((resolve, reject) => {
    // åªä»¥ç¬¬ä¸€æ¬¡ä¸ºå‡†
    resolve('æˆåŠŸ')
    reject('å¤±è´¥')
})
console.log(test1) // MyPromise { PromiseState: 'fulfilled', PromiseResult: 'æˆåŠŸ' }
å¤åˆ¶ä»£ç 
```

### 3. throw

![æˆªå±2021-08-01 ä¸‹åˆ12.57.17.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa2e17b24a124dadba540e86350f1302~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

Promiseä¸­æœ‰`throw`çš„è¯ï¼Œå°±ç›¸å½“äºæ‰§è¡Œäº†`reject`ã€‚è¿™å°±è¦ä½¿ç”¨`try catch`äº†

```js
+        try {
            // æ‰§è¡Œä¼ è¿›æ¥çš„å‡½æ•°
            executor(this.resolve, this.reject)
+        } catch (e) {
            // æ•æ‰åˆ°é”™è¯¯ç›´æ¥æ‰§è¡Œreject
+            this.reject(e)
+        }
å¤åˆ¶ä»£ç 
```

å’±ä»¬æ¥çœ‹çœ‹æ•ˆæœï¼š

```js
const test3 = new MyPromise((resolve, reject) => {
    throw('å¤±è´¥')
})
console.log(test3) // MyPromise { PromiseState: 'rejected', PromiseResult: 'å¤±è´¥' }
å¤åˆ¶ä»£ç 
```

## then

å’±ä»¬å¹³æ—¶ä½¿ç”¨thenæ–¹æ³•æ˜¯è¿™ä¹ˆç”¨çš„ï¼š

```js
// é©¬ä¸Šè¾“å‡º â€æˆåŠŸâ€œ
const p1 = new Promise((resolve, reject) => {
    resolve('æˆåŠŸ')
}).then(res => console.log(res), err => console.log(err))

// 1ç§’åè¾“å‡º â€å¤±è´¥â€œ
const p2 = new Promise((resolve, reject) => {
    setTimeout(() => {
        reject('å¤±è´¥')
    }, 1000)
}).then(res => console.log(res), err => console.log(err))

// é“¾å¼è°ƒç”¨ è¾“å‡º 200
const p3 = new Promise((resolve, reject) => {
    resolve(100)
}).then(res => 2 * res, err => console.log(err))
  .then(res => console.log(res), err => console.log(err))
å¤åˆ¶ä»£ç 
```

å¯ä»¥æ€»ç»“å‡ºè¿™å‡ ä¸ªçŸ¥è¯†ç‚¹ï¼š

- thenæ¥æ”¶ä¸¤ä¸ªå›è°ƒï¼Œä¸€ä¸ªæ˜¯`æˆåŠŸå›è°ƒ`ï¼Œä¸€ä¸ªæ˜¯`å¤±è´¥å›è°ƒ`
- å½“PromiseçŠ¶æ€ä¸º`fulfilled`æ‰§è¡Œ`æˆåŠŸå›è°ƒ`ï¼Œä¸º`rejected`æ‰§è¡Œ`å¤±è´¥å›è°ƒ`
- å¦‚resolveæˆ–rejectåœ¨å®šæ—¶å™¨é‡Œï¼Œ`åˆ™å®šæ—¶å™¨ç»“æŸåå†æ‰§è¡Œthen`
- thenæ”¯æŒ`é“¾å¼è°ƒç”¨`ï¼Œä¸‹ä¸€æ¬¡thenæ‰§è¡Œ`å—ä¸Šä¸€æ¬¡thenè¿”å›å€¼çš„å½±å“`

ä¸‹é¢å’±ä»¬å°±ä¸€æ­¥ä¸€æ­¥åœ°å»å®ç°ä»–å§

### 1. å®ç°then

```js
    then(onFulfilled, onRejected) {
        // æ¥æ”¶ä¸¤ä¸ªå›è°ƒ onFulfilled, onRejected
        
        // å‚æ•°æ ¡éªŒï¼Œç¡®ä¿ä¸€å®šæ˜¯å‡½æ•°
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : val => val
        onRejected = typeof onRejected === 'function' ? onRejected : reason => { throw reason }

        if (this.PromiseState === 'fulfilled') {
            // å¦‚æœå½“å‰ä¸ºæˆåŠŸçŠ¶æ€ï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªå›è°ƒ
            onFulfilled(this.PromiseResult)
        } else if (this.PromiseState === 'rejected') {
            // å¦‚æœå½“å‰ä¸ºå¤±è´¥çŠ¶æ€ï¼Œæ‰§è¡Œç¬¬äºŒå“¥å›è°ƒ
            onRejected(this.PromiseResult)
        }

    }
å¤åˆ¶ä»£ç 
```

å’±ä»¬æ¥çœ‹çœ‹æ•ˆæœï¼š

```js
// è¾“å‡º â€æˆåŠŸâ€œ
const test = new MyPromise((resolve, reject) => {
    resolve('æˆåŠŸ')
}).then(res => console.log(res), err => console.log(err))
å¤åˆ¶ä»£ç 
```

### 2. å®šæ—¶å™¨æƒ…å†µ

ä¸Šé¢æˆ‘ä»¬å·²ç»å®ç°äº†`then`çš„åŸºæœ¬åŠŸèƒ½ã€‚é‚£å¦‚æœæ˜¯`å®šæ—¶å™¨`æƒ…å†µå‘¢ï¼Ÿ

è¿˜æ˜¯é‚£ä¸ªä»£ç ï¼Œæ€ä¹ˆæ‰èƒ½ä¿è¯ï¼Œ1ç§’åæ‰æ‰§è¡Œthené‡Œçš„å¤±è´¥å›è°ƒå‘¢ï¼Ÿ

```js
// 1ç§’åè¾“å‡º â€æˆåŠŸâ€œ
const p2 = new Promise((resolve, reject) => {
    setTimeout(() => {
        reject('å¤±è´¥')
    }, 1000)
}).then(res => console.log(res), err => console.log(err))
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬ä¸èƒ½ç¡®ä¿1ç§’åæ‰æ‰§è¡Œthenå‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¿è¯1ç§’åå†æ‰§è¡Œthené‡Œçš„å›è°ƒï¼Œå¯èƒ½è¿™é‡Œå¤§å®¶æœ‰ç‚¹æ‡µé€¼ï¼Œæˆ‘åŒæ ·ç”¨ä¸€å¼ å›¾ç»™å¤§å®¶è®²è®²å§ï¼š

![æˆªå±2021-08-01 ä¸‹åˆ9.05.24.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ba5a2544b1144548cdc63362fa27d23~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ä¹Ÿå°±æ˜¯åœ¨è¿™1ç§’æ—¶é—´å†…ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæŠŠthené‡Œçš„ä¸¤ä¸ªå›è°ƒä¿å­˜èµ·æ¥ï¼Œç„¶åç­‰åˆ°1ç§’è¿‡åï¼Œæ‰§è¡Œäº†resolveæˆ–è€…rejectï¼Œå’±ä»¬å†å»åˆ¤æ–­çŠ¶æ€ï¼Œå¹¶ä¸”åˆ¤æ–­è¦å»æ‰§è¡Œåˆšåˆšä¿å­˜çš„ä¸¤ä¸ªå›è°ƒä¸­çš„å“ªä¸€ä¸ªå›è°ƒã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“å½“å‰1ç§’è¿˜æ²¡èµ°å®Œç”šè‡³è¿˜æ²¡å¼€å§‹èµ°å‘¢ï¼Ÿå…¶å®å¾ˆå¥½åˆ¤æ–­ï¼Œåªè¦çŠ¶æ€æ˜¯`pending`ï¼Œé‚£å°±è¯æ˜å®šæ—¶å™¨è¿˜æ²¡è·‘å®Œï¼Œå› ä¸ºå¦‚æœå®šæ—¶å™¨è·‘å®Œçš„è¯ï¼Œé‚£çŠ¶æ€è‚¯å®šå°±ä¸æ˜¯`pending`ï¼Œè€Œæ˜¯`fulfilledæˆ–è€…rejected`

é‚£æ˜¯ç”¨ä»€ä¹ˆæ¥ä¿å­˜è¿™äº›å›è°ƒå‘¢ï¼Ÿå»ºè®®ä½¿ç”¨`æ•°ç»„`ï¼Œå› ä¸ºä¸€ä¸ªpromiseå®ä¾‹å¯èƒ½ä¼š`å¤šæ¬¡then`ï¼Œç”¨æ•°ç»„å°±ä¸€ä¸ªä¸€ä¸ªä¿å­˜äº†

```js
    initValue() {
        // åˆå§‹åŒ–å€¼
        this.PromiseResult = null // ç»ˆå€¼
        this.PromiseState = 'pending' // çŠ¶æ€
+        this.onFulfilledCallbacks = [] // ä¿å­˜æˆåŠŸå›è°ƒ
+        this.onRejectedCallbacks = [] // ä¿å­˜å¤±è´¥å›è°ƒ
    }

    resolve(value) {
        // stateæ˜¯ä¸å¯å˜çš„
        if (this.PromiseState !== 'pending') return
        // å¦‚æœæ‰§è¡Œresolveï¼ŒçŠ¶æ€å˜ä¸ºfulfilled
        this.PromiseState = 'fulfilled'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„å€¼
        this.PromiseResult = value
        // æ‰§è¡Œä¿å­˜çš„æˆåŠŸå›è°ƒ
+        while (this.onFulfilledCallbacks.length) {
+            this.onFulfilledCallbacks.shift()(this.PromiseResult)
+        }
    }

    reject(reason) {
        // stateæ˜¯ä¸å¯å˜çš„
        if (this.PromiseState !== 'pending') return
        // å¦‚æœæ‰§è¡Œrejectï¼ŒçŠ¶æ€å˜ä¸ºrejected
        this.PromiseState = 'rejected'
        // ç»ˆå€¼ä¸ºä¼ è¿›æ¥çš„reason
        this.PromiseResult = reason
        // æ‰§è¡Œä¿å­˜çš„å¤±è´¥å›è°ƒ
+        while (this.onRejectedCallbacks.length) {
+            this.onRejectedCallbacks.shift()(this.PromiseResult)
+        }
    }
    
    then(onFulfilled, onRejected) {
        // æ¥æ”¶ä¸¤ä¸ªå›è°ƒ onFulfilled, onRejected

        // å‚æ•°æ ¡éªŒï¼Œç¡®ä¿ä¸€å®šæ˜¯å‡½æ•°
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : val => val
        onRejected = typeof onRejected === 'function' ? onRejected : reason => { throw reason }

        if (this.PromiseState === 'fulfilled') {
            // å¦‚æœå½“å‰ä¸ºæˆåŠŸçŠ¶æ€ï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªå›è°ƒ
            onFulfilled(this.PromiseResult)
        } else if (this.PromiseState === 'rejected') {
            // å¦‚æœå½“å‰ä¸ºå¤±è´¥çŠ¶æ€ï¼Œæ‰§è¡Œç¬¬äºŒå“¥å›è°ƒ
            onRejected(this.PromiseResult)
+        } else if (this.PromiseState === 'pending') {
+            // å¦‚æœçŠ¶æ€ä¸ºå¾…å®šçŠ¶æ€ï¼Œæš‚æ—¶ä¿å­˜ä¸¤ä¸ªå›è°ƒ
+            this.onFulfilledCallbacks.push(onFulfilled.bind(this))
+            this.onRejectedCallbacks.push(onRejected.bind(this))
+        }

    }

å¤åˆ¶ä»£ç 
```

åŠ å®Œä¸Šé¢çš„ä»£ç ï¼Œå’±ä»¬æ¥çœ‹çœ‹å®šæ—¶å™¨çš„æ•ˆæœå§ï¼š

```js
const test2 = new MyPromise((resolve, reject) => {
    setTimeout(() => {
        resolve('æˆåŠŸ') // 1ç§’åè¾“å‡º æˆåŠŸ
        // resolve('æˆåŠŸ') // 1ç§’åè¾“å‡º å¤±è´¥
    }, 1000)
}).then(res => console.log(res), err => console.log(err))
å¤åˆ¶ä»£ç 
```

### 3. é“¾å¼è°ƒç”¨

thenæ”¯æŒ`é“¾å¼è°ƒç”¨`ï¼Œä¸‹ä¸€æ¬¡thenæ‰§è¡Œ`å—ä¸Šä¸€æ¬¡thenè¿”å›å€¼çš„å½±å“`ï¼Œç»™å¤§å®¶ä¸¾ä¸ªä¾‹å­ï¼š

```js
// é“¾å¼è°ƒç”¨ è¾“å‡º 200
const p3 = new Promise((resolve, reject) => {
    resolve(100)
}).then(res => 2 * res, err => console.log(err))
    .then(res => console.log(res), err => console.log(err))

// é“¾å¼è°ƒç”¨ è¾“å‡º300
const p4 = new Promise((resolve, reject) => {
    resolve(100)
}).then(res => new Promise((resolve, reject) => resolve(3 * res)), err => console.log(err))
    .then(res => console.log(res), err => console.log(err))
å¤åˆ¶ä»£ç 
```

ä»ä¸Šæ–¹ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°å‡ ä¸ªçŸ¥è¯†ç‚¹ï¼š

- 1ã€thenæ–¹æ³•æœ¬èº«ä¼šè¿”å›ä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡
- 2ã€å¦‚æœè¿”å›å€¼æ˜¯promiseå¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºæˆåŠŸï¼Œæ–°promiseå°±æ˜¯æˆåŠŸ
- 3ã€å¦‚æœè¿”å›å€¼æ˜¯promiseå¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºå¤±è´¥ï¼Œæ–°promiseå°±æ˜¯å¤±è´¥
- 4ã€å¦‚æœè¿”å›å€¼épromiseå¯¹è±¡ï¼Œæ–°promiseå¯¹è±¡å°±æ˜¯æˆåŠŸï¼Œå€¼ä¸ºæ­¤è¿”å›å€¼

å’±ä»¬çŸ¥é“thenæ˜¯Promiseä¸Šçš„æ–¹æ³•ï¼Œé‚£å¦‚ä½•å®ç°thenå®Œè¿˜èƒ½å†thenå‘¢ï¼Ÿå¾ˆç®€å•ï¼Œthenæ‰§è¡Œåè¿”å›ä¸€ä¸ª`Promiseå¯¹è±¡`å°±è¡Œäº†ï¼Œå°±èƒ½ä¿è¯thenå®Œè¿˜èƒ½ç»§ç»­æ‰§è¡Œthenï¼š

![æˆªå±2021-08-01 ä¸‹åˆ9.06.02.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62a3c3afcf0a4262a1a7e52231c34dbc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ä»£ç å®ç°ï¼š

```js
    then(onFulfilled, onRejected) {
        // æ¥æ”¶ä¸¤ä¸ªå›è°ƒ onFulfilled, onRejected

        // å‚æ•°æ ¡éªŒï¼Œç¡®ä¿ä¸€å®šæ˜¯å‡½æ•°
        onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : val => val
        onRejected = typeof onRejected === 'function' ? onRejected : reason => { throw reason }


        var thenPromise = new MyPromise((resolve, reject) => {

            const resolvePromise = cb => {
                try {
                    const x = cb(this.PromiseResult)
                    if (x === thenPromise) {
                        // ä¸èƒ½è¿”å›è‡ªèº«å“¦
                        throw new Error('ä¸èƒ½è¿”å›è‡ªèº«ã€‚ã€‚ã€‚')
                    }
                    if (x instanceof MyPromise) {
                        // å¦‚æœè¿”å›å€¼æ˜¯Promise
                        // å¦‚æœè¿”å›å€¼æ˜¯promiseå¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºæˆåŠŸï¼Œæ–°promiseå°±æ˜¯æˆåŠŸ
                        // å¦‚æœè¿”å›å€¼æ˜¯promiseå¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºå¤±è´¥ï¼Œæ–°promiseå°±æ˜¯å¤±è´¥
                        // è°çŸ¥é“è¿”å›çš„promiseæ˜¯å¤±è´¥æˆåŠŸï¼Ÿåªæœ‰thençŸ¥é“
                        x.then(resolve, reject)
                    } else {
                        // éPromiseå°±ç›´æ¥æˆåŠŸ
                        resolve(x)
                    }
                } catch (err) {
                    // å¤„ç†æŠ¥é”™
                    reject(err)
                    throw new Error(err)
                }
            }

            if (this.PromiseState === 'fulfilled') {
                // å¦‚æœå½“å‰ä¸ºæˆåŠŸçŠ¶æ€ï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªå›è°ƒ
                resolvePromise(onFulfilled)
            } else if (this.PromiseState === 'rejected') {
                // å¦‚æœå½“å‰ä¸ºå¤±è´¥çŠ¶æ€ï¼Œæ‰§è¡Œç¬¬äºŒä¸ªå›è°ƒ
                resolvePromise(onRejected)
            } else if (this.PromiseState === 'pending') {
                // å¦‚æœçŠ¶æ€ä¸ºå¾…å®šçŠ¶æ€ï¼Œæš‚æ—¶ä¿å­˜ä¸¤ä¸ªå›è°ƒ
                // å¦‚æœçŠ¶æ€ä¸ºå¾…å®šçŠ¶æ€ï¼Œæš‚æ—¶ä¿å­˜ä¸¤ä¸ªå›è°ƒ
                this.onFulfilledCallbacks.push(resolvePromise.bind(this, onFulfilled))
                this.onRejectedCallbacks.push(resolvePromise.bind(this, onRejected))
            }
        })

        // è¿”å›è¿™ä¸ªåŒ…è£…çš„Promise
        return thenPromise

    }
å¤åˆ¶ä»£ç 
```

ç°åœ¨å¤§å®¶å¯ä»¥è¯•è¯•æ•ˆæœæ€ä¹ˆæ ·äº†ï¼Œå¤§å®¶è¦**è¾¹æ•²è¾¹è¯•**å“¦ï¼š

```js
const test3 = new Promise((resolve, reject) => {
  resolve(100) // è¾“å‡º çŠ¶æ€ï¼šæˆåŠŸ å€¼ï¼š 200
  // reject(100) // è¾“å‡º çŠ¶æ€ï¼šæˆåŠŸ å€¼ï¼š300
}).then(res => 2 * res, err => 3 * err)
  .then(res => console.log('æˆåŠŸ', res), err => console.log('å¤±è´¥', err))


  const test4 = new Promise((resolve, reject) => {
    resolve(100) // è¾“å‡º çŠ¶æ€ï¼šå¤±è´¥ å€¼ï¼š200
    // reject(100) // è¾“å‡º çŠ¶æ€ï¼šæˆåŠŸ å€¼ï¼š300
    // è¿™é‡Œå¯æ²¡æåå“¦ã€‚çœŸçš„ææ‡‚äº†ï¼Œå°±çŸ¥é“äº†ä¸ºå•¥è¿™é‡Œæ˜¯åçš„
  }).then(res => new Promise((resolve, reject) => reject(2 * res)), err => new Promise((resolve, reject) => resolve(3 * err)))
    .then(res => console.log('æˆåŠŸ', res), err => console.log('å¤±è´¥', err))
å¤åˆ¶ä»£ç 
```

### 4. å¾®ä»»åŠ¡

çœ‹è¿‡`jsæ‰§è¡Œæœºåˆ¶`çš„å…„å¼Ÿéƒ½çŸ¥é“ï¼Œthenæ–¹æ³•æ˜¯`å¾®ä»»åŠ¡`ï¼Œå•¥å«å¾®ä»»åŠ¡å‘¢ï¼Ÿå…¶å®ä¸çŸ¥é“ä¹Ÿä¸è¦ç´§ï¼Œæˆ‘é€šè¿‡ä¸‹é¢ä¾‹å­è®©ä½ çŸ¥é“ï¼š

```js
const p = new Promise((resolve, reject) => {
    resolve(1)
}).then(res => console.log(res), err => console.log(err))

console.log(2)

è¾“å‡ºé¡ºåºæ˜¯ 2 1
å¤åˆ¶ä»£ç 
```

ä¸ºå•¥ä¸æ˜¯ 1 2 å‘¢ï¼Ÿå› ä¸ºthenæ˜¯ä¸ªå¾®ä»»åŠ¡å•Šã€‚ã€‚ã€‚åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿè¦ç»™æˆ‘ä»¬çš„MyPromiseåŠ ä¸Šè¿™ä¸ªç‰¹æ€§(æˆ‘è¿™é‡Œä½¿ç”¨å®šæ—¶å™¨ï¼Œå¤§å®¶åˆ«ä»‹æ„å“ˆ)

åªéœ€è¦è®©`resolvePromiseå‡½æ•°`å¼‚æ­¥æ‰§è¡Œå°±å¯ä»¥äº†

```js
 const resolvePromise = cb => {
    setTimeout(() => {
        try {
            const x = cb(this.PromiseResult)
            if (x === thenPromise) {
                // ä¸èƒ½è¿”å›è‡ªèº«å“¦
                throw new Error('ä¸èƒ½è¿”å›è‡ªèº«ã€‚ã€‚ã€‚')
            }
            if (x instanceof MyPromise) {
                // å¦‚æœè¿”å›å€¼æ˜¯Promise
                // å¦‚æœè¿”å›å€¼æ˜¯promiseå¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºæˆåŠŸï¼Œæ–°promiseå°±æ˜¯æˆåŠŸ
                // å¦‚æœè¿”å›å€¼æ˜¯promiseå¯¹è±¡ï¼Œè¿”å›å€¼ä¸ºå¤±è´¥ï¼Œæ–°promiseå°±æ˜¯å¤±è´¥
                // è°çŸ¥é“è¿”å›çš„promiseæ˜¯å¤±è´¥æˆåŠŸï¼Ÿåªæœ‰thençŸ¥é“
                x.then(resolve, reject)
            } else {
                // éPromiseå°±ç›´æ¥æˆåŠŸ
                resolve(x)
            }
        } catch (err) {
            // å¤„ç†æŠ¥é”™
            reject(err)
            throw new Error(err)
        }
    })
}
å¤åˆ¶ä»£ç 
```

çœ‹çœ‹æ•ˆæœï¼š

```js
const test4 = new MyPromise((resolve, reject) => {
    resolve(1)
}).then(res => console.log(res), err => console.log(err))

console.log(2)

è¾“å‡ºé¡ºåº 2 1

å¤åˆ¶ä»£ç 
```

## å…¶ä»–æ–¹æ³•

è¿™äº›æ–¹æ³•éƒ½æ¯”è¾ƒç®€å•ï¼Œæˆ‘å°±ä¸å¤ªè¿‡è¯¦ç»†åœ°è®²äº†ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å€Ÿè¿™ä¸ªæœºä¼šï¼Œè‡ªå·±æ‘¸ç´¢ï¼Œå·©å›ºè¿™ç¯‡æ–‡ç« çš„çŸ¥è¯†ã€‚

### all

- æ¥æ”¶ä¸€ä¸ªPromiseæ•°ç»„ï¼Œæ•°ç»„ä¸­å¦‚æœ‰éPromiseé¡¹ï¼Œåˆ™æ­¤é¡¹å½“åšæˆåŠŸ
- å¦‚æœæ‰€æœ‰Promiseéƒ½æˆåŠŸï¼Œåˆ™è¿”å›æˆåŠŸç»“æœæ•°ç»„
- å¦‚æœæœ‰ä¸€ä¸ªPromiseå¤±è´¥ï¼Œåˆ™è¿”å›è¿™ä¸ªå¤±è´¥ç»“æœ

```js
    static all(promises) {
        const result = []
        let count = 0
        return new MyPromise((resolve, reject) => {
            const addData = (index, value) => {
                result[index] = value
                count++
                if (count === promises.length) resolve(result)
            }
            promises.forEach((promise, index) => {
                if (promise instanceof MyPromise) {
                    promise.then(res => {
                        addData(index, res)
                    }, err => reject(err))
                } else {
                    addData(index, promise)
                }
            })
        })
    }
å¤åˆ¶ä»£ç 
```

### race

- æ¥æ”¶ä¸€ä¸ªPromiseæ•°ç»„ï¼Œæ•°ç»„ä¸­å¦‚æœ‰éPromiseé¡¹ï¼Œåˆ™æ­¤é¡¹å½“åšæˆåŠŸ
- å“ªä¸ªPromiseæœ€å¿«å¾—åˆ°ç»“æœï¼Œå°±è¿”å›é‚£ä¸ªç»“æœï¼Œæ— è®ºæˆåŠŸå¤±è´¥

```js
    static race(promises) {
        return new MyPromise((resolve, reject) => {
            promises.forEach(promise => {
                if (promise instanceof MyPromise) {
                    promise.then(res => {
                        resolve(res)
                    }, err => {
                        reject(err)
                    })
                } else {
                    resolve(promise)
                }
            })
        })
    }
å¤åˆ¶ä»£ç 
```

### allSettled

- æ¥æ”¶ä¸€ä¸ªPromiseæ•°ç»„ï¼Œæ•°ç»„ä¸­å¦‚æœ‰éPromiseé¡¹ï¼Œåˆ™æ­¤é¡¹å½“åšæˆåŠŸ
- æŠŠæ¯ä¸€ä¸ªPromiseçš„ç»“æœï¼Œé›†åˆæˆæ•°ç»„ï¼Œè¿”å›

```js
    static allSettled(promises) {
        return new Promise((resolve, reject) => {
            const res = []
            let count = 0
            const addData = (status, value, i) => {
                res[i] = {
                    status,
                    value
                }
                count++
                if (count === promises.length) {
                    resolve(res)
                }
            }
            promises.forEach((promise, i) => {
                if (promise instanceof MyPromise) {
                    promise.then(res => {
                        addData('fulfilled', res, i)
                    }, err => {
                        addData('rejected', err, i)
                    })
                } else {
                    addData('fulfilled', promise, i)
                }
            })
        })
    }
å¤åˆ¶ä»£ç 
```

### any

anyä¸allç›¸å

- æ¥æ”¶ä¸€ä¸ªPromiseæ•°ç»„ï¼Œæ•°ç»„ä¸­å¦‚æœ‰éPromiseé¡¹ï¼Œåˆ™æ­¤é¡¹å½“åšæˆåŠŸ
- å¦‚æœæœ‰ä¸€ä¸ªPromiseæˆåŠŸï¼Œåˆ™è¿”å›è¿™ä¸ªæˆåŠŸç»“æœ
- å¦‚æœæ‰€æœ‰Promiseéƒ½å¤±è´¥ï¼Œåˆ™æŠ¥é”™

```js
    static any(promises) {
        return new Promise((resolve, reject) => {
            let count = 0
            promises.forEach((promise) => {
                promise.then(val => {
                    resolve(val)
                }, err => {
                    count++
                    if (count === promises.length) {
                        reject(new AggregateError('All promises were rejected'))
                    }
                })
            })
        })
    }
}
å¤åˆ¶ä»£ç 
```

### ç»“è¯­

å†ä¹Ÿä¸æ€•é¢è¯•å®˜é—®ä½ PromiseåŸç†å•¦å“ˆå“ˆå“ˆå“ˆğŸ˜

å¦‚æœä½ è§‰å¾—æ­¤æ–‡å¯¹ä½ æœ‰ä¸€ä¸ç‚¹å¸®åŠ©ï¼Œç‚¹ä¸ªèµï¼Œé¼“åŠ±ä¸€ä¸‹æ—ä¸‰å¿ƒå“ˆå“ˆã€‚

### ä»ä¸€é“é¢˜ç›®å‡ºå‘

ä»Šå¤©çœ‹åˆ°ä¸€é“é¢è¯•é¢˜ï¼Œæ˜¯å…³äº`async/await`ã€`promise`å’Œ`setTimeout`çš„æ‰§è¡Œé¡ºåºï¼Œé¢˜ç›®å¦‚ä¸‹ï¼š

```javascript
async function async1() {
	console.log('async1 start');
	await async2();
	console.log('asnyc1 end');
}
async function async2() {
	console.log('async2');
}
console.log('script start');
setTimeout(() => {
	console.log('setTimeOut');
}, 0);
async1();
new Promise(function (reslove) {
	console.log('promise1');
	reslove();
}).then(function () {
	console.log('promise2');
})
console.log('script end');
å¤åˆ¶ä»£ç 
```

æˆ‘ç»™å‡ºçš„ç­”æ¡ˆï¼š

```sql
script start
async1 start
async2
asnyc1 end // x
promise1
script end
promise2
setTimeOut
å¤åˆ¶ä»£ç 
```

æ­£ç¡®çš„ç­”æ¡ˆï¼š

```sql
script start
async1 start
async2
promise1
script end
asnyc1 end
promise2
setTimeOut
å¤åˆ¶ä»£ç 
```

ä¸ºä»€ä¹ˆ`promise1`æ¯”`asnyc1 end`å…ˆå‡ºæ¥å‘¢ï¼Ÿå¸¦ç€è¿™ä¸ªç–‘é—®ï¼Œæˆ‘å»äº†è§£äº†ä¸€ä¸‹**äº‹ä»¶å¾ªç¯æœºåˆ¶**ã€‚

### js EventLoop äº‹ä»¶å¾ªç¯æœºåˆ¶

JavaScriptçš„äº‹ä»¶åˆ†ä¸¤ç§:

| å®ä»»åŠ¡(macro-task)         | å¾®ä»»åŠ¡(micro-task)                              |
| -------------------------- | ----------------------------------------------- |
| script                     | promise.[ then/catch/finally ]((énew Promise)) |
| setTimeout                 | process.nextTick(Node.js ç¯å¢ƒ)                  |
| setInterval                | MutaionOberverï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰                    |
| setImmediate(Node.js ç¯å¢ƒ) | Object.observe                                  |
| IOæ“ä½œ                     | x                                               |
| UIäº¤äº’äº‹ä»¶                 | x                                               |
| postMessage                | x                                               |
| MessageChannel             | x                                               |

äº‹ä»¶çš„æ‰§è¡Œé¡ºåºï¼Œæ˜¯å…ˆæ‰§è¡Œå®ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œå¾®ä»»åŠ¡ï¼Œè¿™ä¸ªæ˜¯åŸºç¡€ï¼Œä»»åŠ¡å¯ä»¥æœ‰åŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡ï¼ŒåŒæ­¥çš„è¿›å…¥ä¸»çº¿ç¨‹ï¼Œå¼‚æ­¥çš„è¿›å…¥Event Tableå¹¶æ³¨å†Œå‡½æ•°ï¼Œå¼‚æ­¥äº‹ä»¶å®Œæˆåï¼Œä¼šå°†å›è°ƒå‡½æ•°æ”¾å…¥Event Queueä¸­(å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡æ˜¯ä¸åŒçš„Event Queue)ï¼ŒåŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œä¼šä»Event Queueä¸­è¯»å–äº‹ä»¶æ”¾å…¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå›è°ƒå‡½æ•°ä¸­å¯èƒ½è¿˜ä¼šåŒ…å«ä¸åŒçš„ä»»åŠ¡ï¼Œå› æ­¤ä¼šå¾ªç¯æ‰§è¡Œä¸Šè¿°æ“ä½œã€‚

> **æ³¨æ„ï¼š** `setTimeOut`å¹¶ä¸æ˜¯ç›´æ¥çš„æŠŠä½ çš„å›æ‰å‡½æ•°æ”¾è¿›ä¸Šè¿°çš„å¼‚æ­¥é˜Ÿåˆ—ä¸­å»ï¼Œè€Œæ˜¯åœ¨å®šæ—¶å™¨çš„æ—¶é—´åˆ°äº†ä¹‹åï¼ŒæŠŠå›æ‰å‡½æ•°æ”¾åˆ°æ‰§è¡Œå¼‚æ­¥é˜Ÿåˆ—ä¸­å»ã€‚å¦‚æœæ­¤æ—¶è¿™ä¸ªé˜Ÿåˆ—å·²ç»æœ‰å¾ˆå¤šä»»åŠ¡äº†ï¼Œé‚£å°±æ’åœ¨ä»–ä»¬çš„åé¢ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ`setTimeOut`ä¸ºä»€ä¹ˆä¸èƒ½ç²¾å‡†çš„æ‰§è¡Œçš„é—®é¢˜äº†ã€‚`setTimeOut`æ‰§è¡Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š
>
> 1. ä¸»è¿›ç¨‹å¿…é¡»æ˜¯ç©ºé—²çš„çŠ¶æ€ï¼Œå¦‚æœåˆ°æ—¶é—´äº†ï¼Œä¸»è¿›ç¨‹ä¸ç©ºé—²ä¹Ÿä¸ä¼šæ‰§è¡Œä½ çš„å›è°ƒå‡½æ•°
> 2. è¿™ä¸ªå›è°ƒå‡½æ•°éœ€è¦ç­‰åˆ°æ’å…¥å¼‚æ­¥é˜Ÿåˆ—æ—¶å‰é¢çš„å¼‚æ­¥å‡½æ•°éƒ½æ‰§è¡Œå®Œäº†ï¼Œæ‰ä¼šæ‰§è¡Œ

### **promiseã€async/await**

é¦–å…ˆï¼Œ`new Promise`æ˜¯åŒæ­¥çš„ä»»åŠ¡ï¼Œä¼šè¢«æ”¾åˆ°ä¸»è¿›ç¨‹ä¸­å»ç«‹å³æ‰§è¡Œã€‚è€Œ`.then()`å‡½æ•°æ˜¯å¼‚æ­¥ä»»åŠ¡ä¼šæ”¾åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­å»ï¼Œé‚£ä»€ä¹ˆæ—¶å€™æ”¾åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­å»å‘¢ï¼Ÿå½“ä½ çš„`promise`çŠ¶æ€ç»“æŸçš„æ—¶å€™ï¼Œå°±ä¼šç«‹å³æ”¾è¿›å¼‚æ­¥é˜Ÿåˆ—ä¸­å»äº†ã€‚

**å¸¦`async`å…³é”®å­—çš„å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª`promise`å¯¹è±¡**ï¼Œå¦‚æœé‡Œé¢æ²¡æœ‰`await`ï¼Œæ‰§è¡Œèµ·æ¥ç­‰åŒäºæ™®é€šå‡½æ•°ï¼›å¦‚æœæ²¡æœ‰`await`ï¼Œ`async`å‡½æ•°å¹¶æ²¡æœ‰å¾ˆå‰å®³æ˜¯ä¸æ˜¯ã€‚

`await` å…³é”®å­—è¦åœ¨ `async` å…³é”®å­—å‡½æ•°çš„å†…éƒ¨ï¼Œ`await` å†™åœ¨å¤–é¢ä¼šæŠ¥é”™ï¼›`await`å¦‚åŒä»–çš„è¯­æ„ï¼Œå°±æ˜¯åœ¨ç­‰å¾…ï¼Œç­‰å¾…å³ä¾§çš„è¡¨è¾¾å¼å®Œæˆã€‚æ­¤æ—¶çš„`await`ä¼šè®©å‡ºçº¿ç¨‹ï¼Œé˜»å¡`async`å†…åç»­çš„ä»£ç ï¼Œå…ˆå»æ‰§è¡Œ`async`å¤–çš„ä»£ç ã€‚ç­‰å¤–é¢çš„åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œæ‰ä¼šæ‰§è¡Œé‡Œé¢çš„åç»­ä»£ç ã€‚å°±ç®—`await`çš„ä¸æ˜¯`promise`å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥å‡½æ•°ï¼Œä¹Ÿä¼šç­‰è¿™æ ·æ“ä½œã€‚

### æµç¨‹æ¢³ç†

æˆ‘ä»¬æ•´ä½“å†æ¢³ç†ä¸€ä¸‹ä¸Šé¢ä»£ç æ‰§è¡Œçš„æµç¨‹ï¼š

> 1. æ•´ä¸ªä»£ç ç‰‡æ®µï¼ˆscriptï¼‰ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œ`console.log('script start')`ï¼Œè¾“å‡º`script start`ï¼›
> 2. æ‰§è¡Œ`setTimeout`ï¼Œæ˜¯ä¸€ä¸ªå¼‚æ­¥åŠ¨ä½œï¼Œæ”¾å…¥å®ä»»åŠ¡å¼‚æ­¥é˜Ÿåˆ—ä¸­ï¼›
> 3. æ‰§è¡Œ`async1()`ï¼Œè¾“å‡º`async1 start`ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼›
> 4. æ‰§è¡Œ`async2()`ï¼Œè¾“å‡º`async2`ï¼Œå¹¶è¿”å›äº†ä¸€ä¸ª`promise`å¯¹è±¡ï¼Œ`await`è®©å‡ºäº†çº¿ç¨‹ï¼ŒæŠŠè¿”å›çš„`promise`åŠ å…¥äº†å¾®ä»»åŠ¡å¼‚æ­¥é˜Ÿåˆ—ï¼Œæ‰€ä»¥`async1()`ä¸‹é¢çš„ä»£ç ä¹Ÿè¦ç­‰å¾…ä¸Šé¢å®Œæˆåç»§ç»­æ‰§è¡Œ;
> 5. æ‰§è¡Œ `new Promise`ï¼Œè¾“å‡º`promise1`ï¼Œç„¶åå°†`resolve()`æ”¾å…¥å¾®ä»»åŠ¡å¼‚æ­¥é˜Ÿåˆ—ï¼›
> 6. æ‰§è¡Œ`console.log('script end')`ï¼Œè¾“å‡º`script end`ï¼›
> 7. åˆ°æ­¤åŒæ­¥çš„ä»£ç å°±éƒ½æ‰§è¡Œå®Œæˆäº†ï¼Œç„¶åå»å¾®ä»»åŠ¡å¼‚æ­¥é˜Ÿåˆ—é‡Œå»è·å–ä»»åŠ¡
> 8. æ¥ä¸‹æ¥æ‰§è¡Œ`resolve`ï¼ˆ`async2`è¿”å›çš„`promise`è¿”å›çš„ï¼‰ï¼Œè¾“å‡ºäº†`async1 end`ï¼›
> 9. ç„¶åæ‰§è¡Œ`resolveï¼ˆnew Promiseçš„ï¼‰`ï¼Œè¾“å‡ºäº†`promise2`ï¼›
> 10. æœ€åæ‰§è¡Œ`setTimeout`ï¼Œè¾“å‡ºäº†`settimeout`ã€‚

åœ¨ç¬¬`4`æ­¥ä¸­ï¼Œ `await` è¿™é‡Œæœ‰ä¸€ä¸ªæœºåˆ¶ï¼Œ å°±æ˜¯ `await` çš„ç­‰å¾…ï¼Œ ä¸ä¼šé˜»å¡å¤–éƒ¨å‡½æ•°çš„æ‰§è¡Œï¼Œ è€Œ `await` ç­‰å¾…çš„ å¦‚æœæ˜¯ä¸€ä¸ª `Promise` åˆ™ `Promise` é‡Œé¢çš„ä»£ç è¿˜æ˜¯åŒæ­¥æ‰§è¡Œï¼Œ å¦‚æœä¸æ˜¯ `Promise` ï¼Œå°±ä¼šä½¿ç”¨ `Promise.resolve` æ¥è¿›è¡Œå°è£…ï¼Œ è¿™é‡Œçš„ `async2` æ˜¯ä¸€ä¸ª `async` æ–¹æ³•ï¼Œ é‡Œé¢çš„ æ‰“å°ä¼šåŒæ­¥æ‰§è¡Œï¼Œ è€Œ `await async2()` åé¢çš„ä»£ç  ä¼šæ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œç­‰å¾…å¤–éƒ¨åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ä»¥åå†æ‰§è¡Œã€‚

æ‰€ä»¥æˆ‘çŸ¥é“äº†`script end`ä¸ºä»€ä¹ˆä¼šä¼˜å…ˆäº`async1 end`è¾“å‡ºã€‚

## ä¸€ã€ä»€ä¹ˆæ˜¯Promiseï¼Ÿæˆ‘ä»¬ç”¨Promiseæ¥è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

> Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼š ä»è¯­æ³•ä¸Šè®²ï¼Œpromiseæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»å®ƒå¯ä»¥è·å–å¼‚æ­¥æ“ä½œçš„æ¶ˆæ¯ï¼›ä»æœ¬æ„ä¸Šè®²ï¼Œå®ƒæ˜¯æ‰¿è¯ºï¼Œæ‰¿è¯ºå®ƒè¿‡ä¸€æ®µæ—¶é—´ä¼šç»™ä½ ä¸€ä¸ªç»“æœã€‚ promiseæœ‰ä¸‰ç§çŠ¶æ€ï¼š**pending(ç­‰å¾…æ€)ï¼Œfulfiled(æˆåŠŸæ€)ï¼Œrejected(å¤±è´¥æ€)**ï¼›çŠ¶æ€ä¸€æ—¦æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜ã€‚åˆ›é€ promiseå®ä¾‹åï¼Œå®ƒä¼šç«‹å³æ‰§è¡Œã€‚

æˆ‘ç›¸ä¿¡å¤§å®¶ç»å¸¸å†™è¿™æ ·çš„ä»£ç ï¼š







```stylus
// å½“å‚æ•°aå¤§äº10ä¸”å‚æ•°fn2æ˜¯ä¸€ä¸ªæ–¹æ³•æ—¶ æ‰§è¡Œfn2
function fn1(a, fn2) {
    if (a > 10 && typeof fn2 == 'function') {
        fn2()
    }
}
fn1(11, function() {
    console.log('this is a callback')
})å¤åˆ¶ä»£ç 
```



ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬ä¼šç¢°åˆ°çš„å›è°ƒåµŒå¥—éƒ½ä¸ä¼šå¾ˆå¤šï¼Œä¸€èˆ¬å°±ä¸€åˆ°ä¸¤çº§ï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹ï¼Œå›è°ƒåµŒå¥—å¾ˆå¤šæ—¶ï¼Œä»£ç å°±ä¼šéå¸¸ç¹çï¼Œä¼šç»™æˆ‘ä»¬çš„ç¼–ç¨‹å¸¦æ¥å¾ˆå¤šçš„éº»çƒ¦ï¼Œè¿™ç§æƒ…å†µä¿—ç§°â€”â€”å›è°ƒåœ°ç‹±ã€‚

è¿™æ—¶å€™æˆ‘ä»¬çš„promiseå°±åº”è¿è€Œç”Ÿã€ç²‰å¢¨ç™»åœºäº†

promiseæ˜¯ç”¨æ¥è§£å†³ä¸¤ä¸ªé—®é¢˜çš„ï¼š

- å›è°ƒåœ°ç‹±ï¼Œä»£ç éš¾ä»¥ç»´æŠ¤ï¼Œ å¸¸å¸¸ç¬¬ä¸€ä¸ªçš„å‡½æ•°çš„è¾“å‡ºæ˜¯ç¬¬äºŒä¸ªå‡½æ•°çš„è¾“å…¥è¿™ç§ç°è±¡
- promiseå¯ä»¥æ”¯æŒå¤šä¸ªå¹¶å‘çš„è¯·æ±‚ï¼Œè·å–å¹¶å‘è¯·æ±‚ä¸­çš„æ•°æ®
- è¿™ä¸ªpromiseå¯ä»¥è§£å†³å¼‚æ­¥çš„é—®é¢˜ï¼Œæœ¬èº«ä¸èƒ½è¯´promiseæ˜¯å¼‚æ­¥çš„



## äºŒã€es6 promiseç”¨æ³•å¤§å…¨

Promiseæ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œè‡ªå·±èº«ä¸Šæœ‰allã€rejectã€resolveè¿™å‡ ä¸ªçœ¼ç†Ÿçš„æ–¹æ³•ï¼ŒåŸå‹ä¸Šæœ‰thenã€catchç­‰åŒæ ·å¾ˆçœ¼ç†Ÿçš„æ–¹æ³•ã€‚

é‚£å°±newä¸€ä¸ª







```coffeescript
let p = new Promise((resolve, reject) => {
    //åšä¸€äº›å¼‚æ­¥æ“ä½œ
    setTimeout(() => {
        console.log('æ‰§è¡Œå®Œæˆ');
        resolve('æˆ‘æ˜¯æˆåŠŸï¼ï¼');
    }, 2000);
});å¤åˆ¶ä»£ç 
```



Promiseçš„æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼šå‡½æ•°ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼š

- resolve ï¼šå¼‚æ­¥æ“ä½œæ‰§è¡ŒæˆåŠŸåçš„å›è°ƒå‡½æ•°
- rejectï¼šå¼‚æ­¥æ“ä½œæ‰§è¡Œå¤±è´¥åçš„å›è°ƒå‡½æ•°

### then é“¾å¼æ“ä½œçš„ç”¨æ³• 

æ‰€ä»¥ï¼Œä»è¡¨é¢ä¸Šçœ‹ï¼ŒPromiseåªæ˜¯èƒ½å¤Ÿç®€åŒ–å±‚å±‚å›è°ƒçš„å†™æ³•ï¼Œè€Œå®è´¨ä¸Šï¼ŒPromiseçš„ç²¾é«“æ˜¯â€œçŠ¶æ€â€ï¼Œç”¨ç»´æŠ¤çŠ¶æ€ã€ä¼ é€’çŠ¶æ€çš„æ–¹å¼æ¥ä½¿å¾—å›è°ƒå‡½æ•°èƒ½å¤ŸåŠæ—¶è°ƒç”¨ï¼Œå®ƒæ¯”ä¼ é€’callbackå‡½æ•°è¦ç®€å•ã€çµæ´»çš„å¤šã€‚æ‰€ä»¥ä½¿ç”¨Promiseçš„æ­£ç¡®åœºæ™¯æ˜¯è¿™æ ·çš„ï¼š







```arcade
p.then((data) => {
    console.log(data);
})
.then((data) => {
    console.log(data);
})
.then((data) => {
    console.log(data);
});å¤åˆ¶ä»£ç 
```





### rejectçš„ç”¨æ³• :

æŠŠPromiseçš„çŠ¶æ€ç½®ä¸ºrejectedï¼Œè¿™æ ·æˆ‘ä»¬åœ¨thenä¸­å°±èƒ½æ•æ‰åˆ°ï¼Œç„¶åæ‰§è¡Œâ€œå¤±è´¥â€æƒ…å†µçš„å›è°ƒã€‚çœ‹ä¸‹é¢çš„ä»£ç ã€‚

```javascript
    let p = new Promise((resolve, reject) => {
        //åšä¸€äº›å¼‚æ­¥æ“ä½œ
      setTimeout(function(){
            var num = Math.ceil(Math.random()*10); //ç”Ÿæˆ1-10çš„éšæœºæ•°
            if(num<=5){
                resolve(num);
            }
            else{
                reject('æ•°å­—å¤ªå¤§äº†');
            }
      }, 2000);
    });
    p.then((data) => {
            console.log('resolved',data);
        },(err) => {
            console.log('rejected',err);
        }
    ); å¤åˆ¶ä»£ç 
```

thenä¸­ä¼ äº†ä¸¤ä¸ªå‚æ•°ï¼Œthenæ–¹æ³•å¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå¯¹åº”resolveçš„å›è°ƒï¼Œç¬¬äºŒä¸ªå¯¹åº”rejectçš„å›è°ƒã€‚æ‰€ä»¥æˆ‘ä»¬èƒ½å¤Ÿåˆ†åˆ«æ‹¿åˆ°ä»–ä»¬ä¼ è¿‡æ¥çš„æ•°æ®ã€‚å¤šæ¬¡è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¼šéšæœºå¾—åˆ°ä¸‹é¢ä¸¤ç§ç»“æœï¼š

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/5/19/16377e1df3ec16ee~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)æˆ–è€…![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/5/19/16377e4fd8619228~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

### catchçš„ç”¨æ³•

æˆ‘ä»¬çŸ¥é“Promiseå¯¹è±¡é™¤äº†thenæ–¹æ³•ï¼Œè¿˜æœ‰ä¸€ä¸ªcatchæ–¹æ³•ï¼Œå®ƒæ˜¯åšä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿå…¶å®å®ƒå’Œthençš„ç¬¬äºŒä¸ªå‚æ•°ä¸€æ ·ï¼Œç”¨æ¥æŒ‡å®šrejectçš„å›è°ƒã€‚ç”¨æ³•æ˜¯è¿™æ ·ï¼š







```arcade
p.then((data) => {
    console.log('resolved',data);
}).catch((err) => {
    console.log('rejected',err);
});å¤åˆ¶ä»£ç 
```



æ•ˆæœå’Œå†™åœ¨thençš„ç¬¬äºŒä¸ªå‚æ•°é‡Œé¢ä¸€æ ·ã€‚ä¸è¿‡å®ƒè¿˜æœ‰å¦å¤–ä¸€ä¸ªä½œç”¨ï¼šåœ¨æ‰§è¡Œresolveçš„å›è°ƒï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢thenä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰æ—¶ï¼Œå¦‚æœæŠ›å‡ºå¼‚å¸¸äº†ï¼ˆä»£ç å‡ºé”™äº†ï¼‰ï¼Œé‚£ä¹ˆå¹¶ä¸ä¼šæŠ¥é”™å¡æ­»jsï¼Œè€Œæ˜¯ä¼šè¿›åˆ°è¿™ä¸ªcatchæ–¹æ³•ä¸­ã€‚è¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼š







```arcade
p.then((data) => {
    console.log('resolved',data);
    console.log(somedata); //æ­¤å¤„çš„somedataæœªå®šä¹‰
})
.catch((err) => {
    console.log('rejected',err);
});å¤åˆ¶ä»£ç 
```



åœ¨resolveçš„å›è°ƒä¸­ï¼Œæˆ‘ä»¬console.log(somedata);è€Œsomedataè¿™ä¸ªå˜é‡æ˜¯æ²¡æœ‰è¢«å®šä¹‰çš„ã€‚å¦‚æœæˆ‘ä»¬ä¸ç”¨Promiseï¼Œä»£ç è¿è¡Œåˆ°è¿™é‡Œå°±ç›´æ¥åœ¨æ§åˆ¶å°æŠ¥é”™äº†ï¼Œä¸å¾€ä¸‹è¿è¡Œäº†ã€‚ä½†æ˜¯åœ¨è¿™é‡Œï¼Œä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœï¼š

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/5/19/1637880bdb32bee3~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

 

ä¹Ÿå°±æ˜¯è¯´è¿›åˆ°catchæ–¹æ³•é‡Œé¢å»äº†ï¼Œè€Œä¸”æŠŠé”™è¯¯åŸå› ä¼ åˆ°äº†reasonå‚æ•°ä¸­ã€‚å³ä¾¿æ˜¯æœ‰é”™è¯¯çš„ä»£ç ä¹Ÿä¸ä¼šæŠ¥é”™äº†ï¼Œè¿™ä¸æˆ‘ä»¬çš„try/catchè¯­å¥æœ‰ç›¸åŒçš„åŠŸèƒ½

### allçš„ç”¨æ³•ï¼šè°è·‘çš„æ…¢ï¼Œä»¥è°ä¸ºå‡†æ‰§è¡Œå›è°ƒã€‚allæ¥æ”¶ä¸€ä¸ªæ•°ç»„å‚æ•°ï¼Œé‡Œé¢çš„å€¼æœ€ç»ˆéƒ½ç®—è¿”å›Promiseå¯¹è±¡

Promiseçš„allæ–¹æ³•æä¾›äº†å¹¶è¡Œæ‰§è¡Œå¼‚æ­¥æ“ä½œçš„èƒ½åŠ›ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œåæ‰æ‰§è¡Œå›è°ƒã€‚çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š

```javascript
let Promise1 = new Promise(function(resolve, reject){})
let Promise2 = new Promise(function(resolve, reject){})
let Promise3 = new Promise(function(resolve, reject){})

let p = Promise.all([Promise1, Promise2, Promise3])

p.then(funciton(){
  // ä¸‰ä¸ªéƒ½æˆåŠŸåˆ™æˆåŠŸ  
}, function(){
  // åªè¦æœ‰å¤±è´¥ï¼Œåˆ™å¤±è´¥ 
})å¤åˆ¶ä»£ç 
```

 

æœ‰äº†allï¼Œä½ å°±å¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå¼‚æ­¥æ“ä½œï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªå›è°ƒä¸­å¤„ç†æ‰€æœ‰çš„è¿”å›æ•°æ®ï¼Œæ˜¯ä¸æ˜¯å¾ˆé…·ï¼Ÿ*æœ‰ä¸€ä¸ªåœºæ™¯æ˜¯å¾ˆé€‚åˆç”¨è¿™ä¸ªçš„ï¼Œä¸€äº›æ¸¸æˆç±»çš„ç´ ææ¯”è¾ƒå¤šçš„åº”ç”¨ï¼Œæ‰“å¼€ç½‘é¡µæ—¶ï¼Œé¢„å…ˆåŠ è½½éœ€è¦ç”¨åˆ°çš„å„ç§èµ„æºå¦‚å›¾ç‰‡ã€flashä»¥åŠå„ç§é™æ€æ–‡ä»¶ã€‚æ‰€æœ‰çš„éƒ½åŠ è½½å®Œåï¼Œæˆ‘ä»¬å†è¿›è¡Œé¡µé¢çš„åˆå§‹åŒ–ã€‚*

### raceçš„ç”¨æ³•ï¼šè°è·‘çš„å¿«ï¼Œä»¥è°ä¸ºå‡†æ‰§è¡Œå›è°ƒ

 

raceçš„ä½¿ç”¨åœºæ™¯ï¼šæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç”¨raceç»™æŸä¸ªå¼‚æ­¥è¯·æ±‚è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¹¶ä¸”åœ¨è¶…æ—¶åæ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
 //è¯·æ±‚æŸä¸ªå›¾ç‰‡èµ„æº
    function requestImg(){
        var p = new Promise((resolve, reject) => {
            var img = new Image();
            img.onload = function(){
                resolve(img);
            }
            img.src = 'å›¾ç‰‡çš„è·¯å¾„';
        });
        return p;
    }
    //å»¶æ—¶å‡½æ•°ï¼Œç”¨äºç»™è¯·æ±‚è®¡æ—¶
    function timeout(){
        var p = new Promise((resolve, reject) => {
            setTimeout(() => {
                reject('å›¾ç‰‡è¯·æ±‚è¶…æ—¶');
            }, 5000);
        });
        return p;
    }
    Promise.race([requestImg(), timeout()]).then((data) =>{
        console.log(data);
    }).catch((err) => {
        console.log(err);
    });å¤åˆ¶ä»£ç 
```

requestImgå‡½æ•°ä¼šå¼‚æ­¥è¯·æ±‚ä¸€å¼ å›¾ç‰‡ï¼Œæˆ‘æŠŠåœ°å€å†™ä¸º"å›¾ç‰‡çš„è·¯å¾„"ï¼Œæ‰€ä»¥è‚¯å®šæ˜¯æ— æ³•æˆåŠŸè¯·æ±‚åˆ°çš„ã€‚timeoutå‡½æ•°æ˜¯ä¸€ä¸ªå»¶æ—¶5ç§’çš„å¼‚æ­¥æ“ä½œã€‚æˆ‘ä»¬æŠŠè¿™ä¸¤ä¸ªè¿”å›Promiseå¯¹è±¡çš„å‡½æ•°æ”¾è¿›raceï¼Œäºæ˜¯ä»–ä¿©å°±ä¼šèµ›è·‘ï¼Œå¦‚æœ5ç§’ä¹‹å†…å›¾ç‰‡è¯·æ±‚æˆåŠŸäº†ï¼Œé‚£ä¹ˆéè¿›å…¥thenæ–¹æ³•ï¼Œæ‰§è¡Œæ­£å¸¸çš„æµç¨‹ã€‚å¦‚æœ5ç§’é’Ÿå›¾ç‰‡è¿˜æœªæˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆtimeoutå°±è·‘èµ¢äº†ï¼Œåˆ™è¿›å…¥catchï¼ŒæŠ¥å‡ºâ€œå›¾ç‰‡è¯·æ±‚è¶…æ—¶â€çš„ä¿¡æ¯ã€‚è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/5/19/16376a95ffa3b13c~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

å¥½äº†ï¼Œæˆ‘ç›¸ä¿¡å¤§å®¶å¯¹ç”¨æ³•å·²ç»æ‡‚äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥æ‰‹å†™ä¸€æ¬¾è‡ªå·±çš„promiseå§

## ä¸‰ã€æ ¹æ®promiseA+å®ç°ä¸€ä¸ªè‡ªå·±çš„promise

## 

### 

### æ­¥éª¤ä¸€ï¼šå®ç°æˆåŠŸå’Œå¤±è´¥çš„å›è°ƒæ–¹æ³•

è¦å®ç°ä¸Šé¢ä»£ç ä¸­çš„åŠŸèƒ½ï¼Œä¹Ÿæ˜¯promiseæœ€åŸºæœ¬çš„åŠŸèƒ½ã€‚é¦–å…ˆï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ„é€ å‡½æ•°promiseï¼Œåˆ›å»ºä¸€ä¸ªpromiselç±»ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ä¼ å…¥äº†ä¸€ä¸ªæ‰§è¡Œå™¨executorï¼Œexecutorä¼šä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼šæˆåŠŸ(resolve)å’Œå¤±è´¥(reject)ã€‚ä¹‹å‰è¯´è¿‡ï¼Œåªè¦æˆåŠŸï¼Œå°±ä¸ä¼šå¤±è´¥ï¼Œåªè¦å¤±è´¥å°±ä¸ä¼šæˆåŠŸã€‚æ‰€ä»¥ï¼Œé»˜è®¤çŠ¶æ€ä¸‹ï¼Œåœ¨è°ƒç”¨æˆåŠŸæ—¶ï¼Œå°±è¿”å›æˆåŠŸæ€ï¼Œè°ƒç”¨å¤±è´¥æ—¶ï¼Œè¿”å›å¤±è´¥æ€ã€‚ä»£ç å¦‚ä¸‹ï¼š







```kotlin
class Promise {
    constructor (executor){
        //é»˜è®¤çŠ¶æ€æ˜¯ç­‰å¾…çŠ¶æ€
        this.status = 'panding';
        this.value = undefined;
        this.reason = undefined;
        //å­˜æ”¾æˆåŠŸçš„å›è°ƒ
        this.onResolvedCallbacks = [];
        //å­˜æ”¾å¤±è´¥çš„å›è°ƒ
        this.onRejectedCallbacks = [];
        let resolve = (data) => {//thisæŒ‡çš„æ˜¯å®ä¾‹
            if(this.status === 'pending'){
                this.value = data;
                this.status = "resolved";
                this.onResolvedCallbacks.forEach(fn => fn());
            }
 
        }
        let reject = (reason) => {
            if(this.status === 'pending'){
                this.reason = reason;
                this.status = 'rejected';
                this.onRejectedCallbacks.forEach(fn => fn());
            }
        }
        try{//æ‰§è¡Œæ—¶å¯èƒ½ä¼šå‘ç”Ÿå¼‚å¸¸
            executor(resolve,reject);
        }catch (e){
            reject(e);//promiseå¤±è´¥äº†
        }
       
    }å¤åˆ¶ä»£ç 
```



> promise A+è§„èŒƒè§„å®šï¼Œåœ¨æœ‰å¼‚å¸¸é”™è¯¯æ—¶ï¼Œåˆ™æ‰§è¡Œå¤±è´¥å‡½æ•°ã€‚







```delphi
constructor (executor){
    ......      try{
        executor(resolve,reject);
      }catch(e){
        reject(e);
      }
  }å¤åˆ¶ä»£ç 
```



### æ­¥éª¤äºŒï¼šthenæ–¹æ³•é“¾å¼è°ƒç”¨ 

thenæ–¹æ³•æ˜¯promiseçš„æœ€åŸºæœ¬çš„æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ä¸¤ä¸ªå›è°ƒï¼Œä¸€ä¸ªæˆåŠŸçš„å›è°ƒï¼Œä¸€ä¸ªå¤±è´¥çš„å›è°ƒï¼Œå®ç°è¿‡ç¨‹å¦‚ä¸‹ï¼š







```kotlin
    then(onFulFilled, onRejected) {
    if (this.status === 'resolved') { //æˆåŠŸçŠ¶æ€çš„å›è°ƒ
      onFulFilled(this.value);
    }
    if (this.status === 'rejected') {//å¤±è´¥çŠ¶æ€çš„å›è°ƒ
      onRejected(this.reason);
    }
  }å¤åˆ¶ä»£ç 
```







```coffeescript
let p = new Promise(function(){
    resolve('æˆ‘æ˜¯æˆåŠŸ');
})
p.then((data) => {console.log(data);},(err) => {});
p.then((data) => {console.log(data);},(err) => {});
p.then((data) => {console.log(data);},(err) => {});å¤åˆ¶ä»£ç 
```



è¿”å›çš„ç»“æœæ˜¯ï¼š







```
æˆ‘æ˜¯æˆåŠŸ
æˆ‘æ˜¯æˆåŠŸ
æˆ‘æ˜¯æˆåŠŸå¤åˆ¶ä»£ç 
```



ä¸ºäº†å®ç°è¿™æ ·çš„æ•ˆæœï¼Œåˆ™ä¸Šä¸€æ¬¡çš„ä»£ç å°†è¦é‡æ–°å†™è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ¯æ¬¡è°ƒç”¨resolveçš„ç»“æœå­˜å…¥ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨rejectçš„ç»“æœå­˜å…¥ä¸€ä¸ªæ•°ç»„ã€‚è¿™å°±æ˜¯**ä¸ºä½•ä¼šåœ¨ä¸Šé¢å®šä¹‰ä¸¤ä¸ªæ•°ç»„,ä¸”åˆ†åˆ«åœ¨resolve()å’Œreject()éå†ä¸¤ä¸ªæ•°ç»„çš„åŸå› **ã€‚å› æ­¤ï¼Œåœ¨è°ƒç”¨resolve()æˆ–è€…reject()ä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨pendingçŠ¶æ€æ—¶ï¼Œä¼šæŠŠå¤šæ¬¡thenä¸­çš„ç»“æœå­˜å…¥æ•°ç»„ä¸­ï¼Œåˆ™ä¸Šé¢çš„ä»£ç ä¼šæ”¹å˜ä¸ºï¼š







```kotlin
  then(onFulFilled, onRejected) {
    if (this.status === 'resolved') {
      onFulFilled(this.value);
    }
    if (this.status === 'rejected') {
      onRejected(this.reason);
    }
    // å½“å‰æ—¢æ²¡æœ‰å®Œæˆ ä¹Ÿæ²¡æœ‰å¤±è´¥
    if (this.status === 'pending') {
      // å­˜æ”¾æˆåŠŸçš„å›è°ƒ
      this.onResolvedCallbacks.push(() => {
        onFulFilled(this.value);
      });
      // å­˜æ”¾å¤±è´¥çš„å›è°ƒ
      this.onRejectedCallbacks.push(() => {
        onRejected(this.reason);
      });
    }
  }å¤åˆ¶ä»£ç 
```



> Promise A+è§„èŒƒä¸­è§„å®šthenæ–¹æ³•å¯ä»¥é“¾å¼è°ƒç”¨

åœ¨promiseä¸­ï¼Œè¦å®ç°é“¾å¼è°ƒç”¨è¿”å›çš„ç»“æœæ˜¯è¿”å›ä¸€ä¸ªæ–°çš„promiseï¼Œç¬¬ä¸€æ¬¡thenä¸­è¿”å›çš„ç»“æœï¼Œæ— è®ºæ˜¯æˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½å°†è¿”å›åˆ°ä¸‹ä¸€æ¬¡thenä¸­çš„æˆåŠŸæ€ä¸­ï¼Œä½†åœ¨ç¬¬ä¸€æ¬¡thenä¸­å¦‚æœæŠ›å‡ºå¼‚å¸¸é”™è¯¯ï¼Œåˆ™å°†è¿”å›åˆ°ä¸‹ä¸€æ¬¡thenä¸­çš„å¤±è´¥æ€ä¸­

**é“¾å¼è°ƒç”¨æˆåŠŸæ—¶**



é“¾å¼è°ƒç”¨æˆåŠŸä¼šè¿”å›å€¼ï¼Œæœ‰å¤šç§æƒ…å†µï¼Œæ ¹æ®ä¸¾çš„ä¾‹å­ï¼Œå¤§è‡´åˆ—å‡ºå¯èƒ½ä¼šå‘ç”Ÿçš„ç»“æœã€‚å› æ­¤å°†é“¾å¼è°ƒç”¨è¿”å›çš„å€¼å•ç‹¬å†™ä¸€ä¸ªæ–¹æ³•ã€‚æ–¹æ³•ä¸­ä¼ å…¥å››ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯p2,x,resolve,reject,p2æŒ‡çš„æ˜¯ä¸Šä¸€æ¬¡è¿”å›çš„promiseï¼Œxè¡¨ç¤ºè¿è¡Œpromiseè¿”å›çš„ç»“æœï¼Œresolveå’Œrejectæ˜¯p2çš„æ–¹æ³•ã€‚åˆ™ä»£ç å†™ä¸ºï¼š







```reasonml
function resolvePromise(p2,x,resolve,reject){
    ....
}å¤åˆ¶ä»£ç 
```



- è¿”å›ç»“æœä¸èƒ½æ˜¯è‡ªå·±







```javascript
var p = new Promise((resovle,reject) => {
    return p;     //è¿”å›çš„ç»“æœä¸èƒ½æ˜¯è‡ªå·±ï¼Œ
})å¤åˆ¶ä»£ç 
```



å½“è¿”å›ç»“æœæ˜¯è‡ªå·±æ—¶ï¼Œæ°¸è¿œä¹Ÿä¸ä¼šæˆåŠŸæˆ–å¤±è´¥ï¼Œå› æ­¤å½“è¿”å›è‡ªå·±æ—¶ï¼Œåº”æŠ›å‡ºä¸€ä¸ªé”™è¯¯







```reasonml
function resolvePromise(p2,x,resolve,reject){
    if(px===x){
        return reject(new TypeError('è‡ªå·±å¼•ç”¨è‡ªå·±äº†'));
    }
    ....
}å¤åˆ¶ä»£ç 
```



- è¿”å›ç»“æœå¯èƒ½æ˜¯promise







```javascript
function resolvePromise(promise2,x,resolve,reject){
    //åˆ¤æ–­xæ˜¯ä¸æ˜¯promise
    //è§„èŒƒä¸­è§„å®šï¼šæˆ‘ä»¬å…è®¸åˆ«äººä¹±å†™ï¼Œè¿™ä¸ªä»£ç å¯ä»¥å®ç°æˆ‘ä»¬çš„promiseå’Œåˆ«äººçš„promise è¿›è¡Œäº¤äº’
    if(promise2 === x){//ä¸èƒ½è‡ªå·±ç­‰å¾…è‡ªå·±å®Œæˆ
        return reject(new TypeError('å¾ªç¯å¼•ç”¨'));
    };
    // xæ˜¯é™¤äº†nullä»¥å¤–çš„å¯¹è±¡æˆ–è€…å‡½æ•°
    if(x !=null && (typeof x === 'object' || typeof x === 'function')){
        let called;//é˜²æ­¢æˆåŠŸåè°ƒç”¨å¤±è´¥
        try{//é˜²æ­¢å–thenæ˜¯å‡ºç°å¼‚å¸¸  object.defineProperty
            let then = x.then;//å–xçš„thenæ–¹æ³• {then:{}}
            if(typeof then === 'function'){//å¦‚æœthenæ˜¯å‡½æ•°å°±è®¤ä¸ºä»–æ˜¯promise
                //callç¬¬ä¸€ä¸ªå‚æ•°æ˜¯thisï¼Œåé¢çš„æ˜¯æˆåŠŸçš„å›è°ƒå’Œå¤±è´¥çš„å›è°ƒ
                then.call(x,y => {//å¦‚æœYæ˜¯promiseå°±ç»§ç»­é€’å½’promise
                    if(called) return;
                    called = true;
                    resolvePromise(promise2,y,resolve,reject)
                },r => { //åªè¦å¤±è´¥äº†å°±å¤±è´¥äº†
                    if(called) return;
                    called = true;
                    reject(r);  
                });
            }else{//thenæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå°±ç›´æ¥æˆåŠŸå³å¯
                resolve(x);
            }
        }catch (e){
            if(called) return;
            called = true;
            reject(e)
        }
    }else{//x = 123 xå°±æ˜¯ä¸€ä¸ªæ™®é€šå€¼ ä½œä¸ºä¸‹ä¸ªthenæˆåŠŸçš„å‚æ•°
        resolve(x)
    }

}å¤åˆ¶ä»£ç 
```



- è¿”å›ç»“æœå¯èƒ½ä¸ºä¸€ä¸ªæ™®é€šå€¼ï¼Œåˆ™ç›´æ¥  resolve(x);

- Promiseä¸€æ¬¡åªèƒ½è°ƒç”¨æˆåŠŸæˆ–è€…å¤±è´¥

ä¹Ÿå°±æ˜¯å½“è°ƒç”¨æˆåŠŸå°±ä¸èƒ½å†è°ƒç”¨å¤±è´¥äº†ï¼Œå¦‚æœä¸¤ä¸ªéƒ½è°ƒç”¨çš„æ—¶å€™ï¼Œå“ªä¸ªå…ˆè°ƒç”¨å°±æ‰§è¡Œå“ªä¸€ä¸ªã€‚ä»£ç éƒ¨åˆ†è¿˜æ˜¯ä¸Šé¢é‚£éƒ¨åˆ†

ä¸ªäººè®¤ä¸ºï¼Œè¿™ä¸ªåœ°æ–¹æ¯”è¾ƒç»•ï¼Œéœ€è¦æ…¢æ…¢çš„ä¸€æ­¥ä¸€æ­¥çš„ç†æ¸…æ¥šã€‚

æ ¹æ®promise A+è§„èŒƒåŸç†ï¼Œpromiseåœ¨è‡ªå·±çš„æ¡†æ¶ä¸­ï¼Œå°è£…äº†ä¸€ç³»åˆ—çš„å†…ç½®çš„æ–¹æ³•ã€‚

- æ•è·é”™è¯¯çš„æ–¹æ³• **catch()**
- è§£æå…¨éƒ¨æ–¹æ³• **all()**
- ç«èµ› **race()**
- ç”Ÿæˆä¸€ä¸ªæˆåŠŸçš„promise **resolve()**
- ç”Ÿæˆä¸€ä¸ªå¤±è´¥çš„promise **reject()**

æœ€åç»™å¤§å®¶é™„ä¸Šå…¨éƒ¨æºç ï¼Œä¾›å¤§å®¶ä»”ç»†å“è¯»ã€‚









```javascript
function resolvePromise(promise2,x,resolve,reject){
    //åˆ¤æ–­xæ˜¯ä¸æ˜¯promise
    //è§„èŒƒä¸­è§„å®šï¼šæˆ‘ä»¬å…è®¸åˆ«äººä¹±å†™ï¼Œè¿™ä¸ªä»£ç å¯ä»¥å®ç°æˆ‘ä»¬çš„promiseå’Œåˆ«äººçš„promise è¿›è¡Œäº¤äº’
    if(promise2 === x){//ä¸èƒ½è‡ªå·±ç­‰å¾…è‡ªå·±å®Œæˆ
        return reject(new TypeError('å¾ªç¯å¼•ç”¨'));
    };
    // xæ˜¯é™¤äº†nullä»¥å¤–çš„å¯¹è±¡æˆ–è€…å‡½æ•°
    if(x !=null && (typeof x === 'object' || typeof x === 'function')){
        let called;//é˜²æ­¢æˆåŠŸåè°ƒç”¨å¤±è´¥
        try{//é˜²æ­¢å–thenæ˜¯å‡ºç°å¼‚å¸¸  object.defineProperty
            let then = x.then;//å–xçš„thenæ–¹æ³• {then:{}}
            if(typeof then === 'function'){//å¦‚æœthenæ˜¯å‡½æ•°å°±è®¤ä¸ºä»–æ˜¯promise
                //callç¬¬ä¸€ä¸ªå‚æ•°æ˜¯thisï¼Œåé¢çš„æ˜¯æˆåŠŸçš„å›è°ƒå’Œå¤±è´¥çš„å›è°ƒ
                then.call(x,y => {//å¦‚æœYæ˜¯promiseå°±ç»§ç»­é€’å½’promise
                    if(called) return;
                    called = true;
                    resolvePromise(promise2,y,resolve,reject)
                },r => { //åªè¦å¤±è´¥äº†å°±å¤±è´¥äº†
                    if(called) return;
                    called = true;
                    reject(r);  
                });
            }else{//thenæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå°±ç›´æ¥æˆåŠŸå³å¯
                resolve(x);
            }
        }catch (e){
            if(called) return;
            called = true;
            reject(e)
        }
    }else{//x = 123 xå°±æ˜¯ä¸€ä¸ªæ™®é€šå€¼ ä½œä¸ºä¸‹ä¸ªthenæˆåŠŸçš„å‚æ•°
        resolve(x)
    }

}

class Promise {
    constructor (executor){
        //é»˜è®¤çŠ¶æ€æ˜¯ç­‰å¾…çŠ¶æ€
        this.status = 'panding';
        this.value = undefined;
        this.reason = undefined;
        //å­˜æ”¾æˆåŠŸçš„å›è°ƒ
        this.onResolvedCallbacks = [];
        //å­˜æ”¾å¤±è´¥çš„å›è°ƒ
        this.onRejectedCallbacks = [];
        let resolve = (data) => {//thisæŒ‡çš„æ˜¯å®ä¾‹
            if(this.status === 'pending'){
                this.value = data;
                this.status = "resolved";
                this.onResolvedCallbacks.forEach(fn => fn());
            }
 
        }
        let reject = (reason) => {
            if(this.status === 'pending'){
                this.reason = reason;
                this.status = 'rejected';
                this.onRejectedCallbacks.forEach(fn => fn());
            }
        }
        try{//æ‰§è¡Œæ—¶å¯èƒ½ä¼šå‘ç”Ÿå¼‚å¸¸
            executor(resolve,reject);
        }catch (e){
            reject(e);//promiseå¤±è´¥äº†
        }
       
    }
    then(onFuiFilled,onRejected){ 
        //é˜²æ­¢å€¼å¾—ç©¿é€ 
        onFuiFilled = typeof onFuiFilled === 'function' ? onFuiFilled : y => y;
        onRejected = typeof onRejected === 'function' ? onRejected :err => {throw err;}        
        let promise2;//ä½œä¸ºä¸‹ä¸€æ¬¡thenæ–¹æ³•çš„promise
       if(this.status === 'resolved'){
           promise2 = new Promise((resolve,reject) => {
               setTimeout(() => {
                  try{
                        //æˆåŠŸçš„é€»è¾‘ å¤±è´¥çš„é€»è¾‘
                        let x = onFuiFilled(this.value);
                        //çœ‹xæ˜¯ä¸æ˜¯promise å¦‚æœæ˜¯promiseå–ä»–çš„ç»“æœ ä½œä¸ºpromise2æˆåŠŸçš„çš„ç»“æœ
                        //å¦‚æœè¿”å›ä¸€ä¸ªæ™®é€šå€¼ï¼Œä½œä¸ºpromise2æˆåŠŸçš„ç»“æœ
                        //resolvePromiseå¯ä»¥è§£æxå’Œpromise2ä¹‹é—´çš„å…³ç³»
                        //åœ¨resolvePromiseä¸­ä¼ å…¥å››ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¿”å›çš„promiseï¼Œç¬¬äºŒä¸ªæ˜¯è¿”å›çš„ç»“æœï¼Œç¬¬ä¸‰ä¸ªå’Œç¬¬å››ä¸ªåˆ†åˆ«æ˜¯resolve()å’Œreject()çš„æ–¹æ³•ã€‚
                        resolvePromise(promise2,x,resolve,reject)
                  }catch(e){
                        reject(e);
                  } 
               },0)
           }); 
       } 
       if(this.status === 'rejected'){
            promise2 = new Promise((resolve,reject) => {
                setTimeout(() => {
                    try{
                        let x = onRejected(this.reason);
                        //åœ¨resolvePromiseä¸­ä¼ å…¥å››ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¿”å›çš„promiseï¼Œç¬¬äºŒä¸ªæ˜¯è¿”å›çš„ç»“æœï¼Œç¬¬ä¸‰ä¸ªå’Œç¬¬å››ä¸ªåˆ†åˆ«æ˜¯resolve()å’Œreject()çš„æ–¹æ³•ã€‚
                        resolvePromise(promise2,x,resolve,reject)
                    }catch(e){
                        reject(e);
                    }
                },0)

            });
       }
       //å½“å‰æ—¢æ²¡æœ‰å®Œæˆä¹Ÿæ²¡æœ‰å¤±è´¥
       if(this.status === 'pending'){
           promise2 = new Promise((resolve,reject) => {
               //æŠŠæˆåŠŸçš„å‡½æ•°ä¸€ä¸ªä¸ªå­˜æ”¾åˆ°æˆåŠŸå›è°ƒå‡½æ•°æ•°ç»„ä¸­
                this.onResolvedCallbacks.push( () =>{
                    setTimeout(() => {
                        try{
                            let x = onFuiFilled(this.value);
                            resolvePromise(promise2,x,resolve,reject);
                        }catch(e){
                            reject(e);
                        }
                    },0)
                });
                //æŠŠå¤±è´¥çš„å‡½æ•°ä¸€ä¸ªä¸ªå­˜æ”¾åˆ°å¤±è´¥å›è°ƒå‡½æ•°æ•°ç»„ä¸­
                this.onRejectedCallbacks.push( ()=>{
                    setTimeout(() => {
                        try{
                            let x = onRejected(this.reason);
                            resolvePromise(promise2,x,resolve,reject)
                        }catch(e){
                            reject(e)
                        }
                    },0)
                })
           })
       }
       return promise2;//è°ƒç”¨thenåè¿”å›ä¸€ä¸ªæ–°çš„promise
    }
    catch (onRejected) {
        // catch æ–¹æ³•å°±æ˜¯thenæ–¹æ³•æ²¡æœ‰æˆåŠŸçš„ç®€å†™
        return this.then(null, onRejected);
    }
}
Promise.all = function (promises) {
    //promisesæ˜¯ä¸€ä¸ªpromiseçš„æ•°ç»„
    return new Promise(function (resolve, reject) {
        let arr = []; //arræ˜¯æœ€ç»ˆè¿”å›å€¼çš„ç»“æœ
        let i = 0; // è¡¨ç¤ºæˆåŠŸäº†å¤šå°‘æ¬¡
        function processData(index, data) {
            arr[index] = data;
            if (++i === promises.length) {
                resolve(arr);
            }
        }
        for (let i = 0; i < promises.length; i++) {
            promises[i].then(function (data) {
                processData(i, data)
            }, reject)
        }
    })
}
// åªè¦æœ‰ä¸€ä¸ªpromiseæˆåŠŸäº† å°±ç®—æˆåŠŸã€‚å¦‚æœç¬¬ä¸€ä¸ªå¤±è´¥äº†å°±å¤±è´¥äº†
Promise.race = function (promises) {
    return new Promise((resolve, reject) => {
        for (var i = 0; i < promises.length; i++) {
            promises[i].then(resolve,reject)
        }
    })
}
// ç”Ÿæˆä¸€ä¸ªæˆåŠŸçš„promise
Promise.resolve = function(value){
    return new Promise((resolve,reject) => resolve(value);
}
// ç”Ÿæˆä¸€ä¸ªå¤±è´¥çš„promise
Promise.reject = function(reason){
    return new Promise((resolve,reject) => reject(reason));
}
Promise.defer = Promise.deferred = function () {
    let dfd = {};
    dfd.promise = new Promise( (resolve, reject) =>  {
        dfd.resolve = resolve;
        dfd.reject = reject;
    });
    return dfd
}
module.exports = Promise;å¤åˆ¶ä»£ç 
```



å…³äºè¿™ç¯‡promise A+è§„èŒƒçš„æ€»ç»“ï¼Œè‚¯å®šä¼šå­˜åœ¨å¾ˆå¤šä¸è¶³çš„åœ°æ–¹ï¼Œæ¬¢è¿å„ä½æå‡ºå®è´µçš„æ„è§æˆ–å»ºè®®ï¼Œä¹Ÿå¸Œæœ›èƒ½å¸®åŠ©åˆ°ä½ ä»ä¸­è·å¾—ä¸€äº›çŸ¥è¯†ï¼

# Promise ä¸­çš„ä¸‰å…„å¼Ÿ .all(), .race(), .allSettled()

[![img](https://p3-passport.byteimg.com/img/user-avatar/2a91a15bf1fd08b29971dcf08a22d627~100x100.awebp)](https://juejin.cn/user/2330620350435501)

[ç‹å¤§å†¶![lv-8](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3fdb11f5b5ff4d9aaf7982197d7e4082~tplv-k3u1fbpfcp-no-mark:0:0:0:0.awebp)![img](https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/07302452a7ad81cb43a173b5cd580237.svg)](https://juejin.cn/user/2330620350435501)

2019å¹´08æœˆ14æ—¥ 08:08 Â· é˜…è¯» 29855

> ä½œè€…ï¼šDr. Axel Rauschmayer è¯‘è€…ï¼šå‰ç«¯å°æ™º æ¥æº:2ality

> **ç‚¹èµå†çœ‹**ï¼Œå¾®ä¿¡æœç´¢ **ã€å¤§è¿ä¸–ç•Œã€‘** å…³æ³¨è¿™ä¸ªæ²¡æœ‰å¤§å‚èƒŒæ™¯ï¼Œä½†æœ‰ç€ä¸€è‚¡å‘ä¸Šç§¯æå¿ƒæ€äººã€‚æœ¬æ–‡ `GitHub` [github.com/qq449245884â€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fqq449245884%2Fxiaozhi) ä¸Šå·²ç»æ”¶å½•ï¼Œæ–‡ç« çš„å·²åˆ†ç±»ï¼Œä¹Ÿæ•´ç†äº†å¾ˆå¤šæˆ‘çš„æ–‡æ¡£ï¼Œå’Œæ•™ç¨‹èµ„æ–™ã€‚

**å¤§å®¶éƒ½è¯´ç®€å†æ²¡é¡¹ç›®å†™ï¼Œæˆ‘å°±å¸®å¤§å®¶æ‰¾äº†ä¸€ä¸ªé¡¹ç›®ï¼Œè¿˜é™„èµ [ã€æ­å»ºæ•™ç¨‹ã€‘](https://link.juejin.cn/?target=http%3A%2F%2Fwww.longstudy.club%2Ftuiguan%2Ft1%2Findex.html)ã€‚**

ä»ES6 å¼€å§‹ï¼Œæˆ‘ä»¬å¤§éƒ½ä½¿ç”¨çš„æ˜¯ `Promise.all()`å’Œ`Promise.race()`ï¼Œ`Promise.allSettled()` ææ¡ˆå·²ç»åˆ°ç¬¬4é˜¶æ®µï¼Œå› æ­¤å°†ä¼šæˆä¸º`ECMAScript 2020`çš„ä¸€éƒ¨åˆ†ã€‚

## 1.æ¦‚è¿°

**Promise.all(promises: Iterable): Promise**

- `Promise.all(iterable)` æ–¹æ³•è¿”å›ä¸€ä¸ª `Promise` å®ä¾‹ï¼Œæ­¤å®ä¾‹åœ¨ `iterable` å‚æ•°å†…æ‰€æœ‰çš„ `promise` éƒ½â€œå®Œæˆï¼ˆresolvedï¼‰â€æˆ–å‚æ•°ä¸­ä¸åŒ…å« `promise` æ—¶å›è°ƒå®Œæˆï¼ˆresolveï¼‰ï¼›å¦‚æœå‚æ•°ä¸­ `promise` æœ‰ä¸€ä¸ªå¤±è´¥ï¼ˆrejectedï¼‰ï¼Œæ­¤å®ä¾‹å›è°ƒå¤±è´¥ï¼ˆrejectï¼‰ï¼Œå¤±è´¥åŸå› çš„æ˜¯ç¬¬ä¸€ä¸ªå¤±è´¥ `promise` çš„ç»“æœ

**Promise.race(promises: Iterable): Promise**

- **Promise.race(iterable)** æ–¹æ³•è¿”å›ä¸€ä¸ª `promise`ï¼Œä¸€æ—¦è¿­ä»£å™¨ä¸­çš„æŸä¸ª`promise`è§£å†³æˆ–æ‹’ç»ï¼Œè¿”å›çš„ `promise`å°±ä¼šè§£å†³æˆ–æ‹’ç»ã€‚

**Promise.allSettled(promises: Iterable): Promise>**

- **Promise.allSettled()**æ–¹æ³•è¿”å›ä¸€ä¸ª`promise`ï¼Œè¯¥`promise`åœ¨æ‰€æœ‰ç»™å®šçš„`promise`å·²è¢«è§£ææˆ–è¢«æ‹’ç»åè§£æï¼Œå¹¶ä¸”æ¯ä¸ªå¯¹è±¡éƒ½æè¿°æ¯ä¸ª`promise`çš„ç»“æœã€‚

## å›é¡¾: Promise çŠ¶æ€

ç»™å®šä¸€ä¸ªè¿”å›`Promise`çš„å¼‚æ­¥æ“ä½œï¼Œä»¥ä¸‹è¿™äº›æ˜¯`Promise`çš„å¯èƒ½çŠ¶æ€ï¼š

- pending: åˆå§‹çŠ¶æ€ï¼Œæ—¢ä¸æ˜¯æˆåŠŸï¼Œä¹Ÿä¸æ˜¯å¤±è´¥çŠ¶æ€ã€‚
- fulfilled: æ„å‘³ç€æ“ä½œæˆåŠŸå®Œæˆã€‚
- rejected: æ„å‘³ç€æ“ä½œå¤±è´¥ã€‚
- Settledï¼š `Promise`è¦ä¹ˆè¢«å®Œæˆï¼Œè¦ä¹ˆè¢«æ‹’ç»ã€‚`Promise`ä¸€æ—¦è¾¾æˆï¼Œå®ƒçš„çŠ¶æ€å°±ä¸å†æ”¹å˜ã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0397a284cf043cbb87883da03832ec1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

## 3.ä»€ä¹ˆæ˜¯ç»„åˆ

åˆç§°éƒ¨åˆ†-æ•´ä½“æ¨¡å¼ï¼Œå°†å¯¹è±¡æ•´åˆæˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€œéƒ¨åˆ†æ•´ä½“â€çš„å±‚æ¬¡ç»“æ„ã€‚ç»„åˆæ¨¡å¼ä½¿å¾—ç”¨æˆ·å¯¹å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡çš„ä½¿ç”¨å…·æœ‰ä¸€è‡´æ€§ï¼Œå®ƒåŸºäºä¸¤ç§å‡½æ•°ï¼š

- åŸºå…ƒå‡½æ•°(ç®€çŸ­:åŸºå…ƒ)åˆ›å»ºåŸå­å—ã€‚
- ç»„åˆå‡½æ•°ï¼ˆç®€ç§°ï¼šç»„åˆï¼‰å°†åŸå­å’Œ/æˆ–å¤åˆä»¶ç»„åˆåœ¨ä¸€èµ·ä»¥å½¢æˆå¤åˆä»¶ã€‚

å¯¹äº JS çš„ Promises æ¥è¯´

- åŸºå…ƒå‡½æ•°åŒ…æ‹¬:`Promise.resolve()`ã€`Promise.reject()`
- ç»„åˆå‡½æ•°ï¼š`Promise.all()`, `Promise.race()`, `Promise.allSettled()`

## 4. Promise.all()

`Promise.all()`çš„ç±»å‹ç­¾å:

- **Promise.all(promises: Iterable): Promise**

è¿”å›æƒ…å†µï¼š

**å®Œæˆï¼ˆFulfillmentï¼‰ï¼š** å¦‚æœä¼ å…¥çš„å¯è¿­ä»£å¯¹è±¡ä¸ºç©ºï¼Œ`Promise.all` ä¼šåŒæ­¥åœ°è¿”å›ä¸€ä¸ªå·²å®Œæˆï¼ˆ`resolved`ï¼‰çŠ¶æ€çš„`promise`ã€‚ å¦‚æœæ‰€æœ‰ä¼ å…¥çš„ `promise` éƒ½å˜ä¸ºå®ŒæˆçŠ¶æ€ï¼Œæˆ–è€…ä¼ å…¥çš„å¯è¿­ä»£å¯¹è±¡å†…æ²¡æœ‰ `promise`ï¼Œ`Promise.all` è¿”å›çš„ `promise` å¼‚æ­¥åœ°å˜ä¸ºå®Œæˆã€‚ åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œ`Promise.all` è¿”å›çš„ `promise` çš„å®ŒæˆçŠ¶æ€çš„ç»“æœéƒ½æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒåŒ…å«æ‰€æœ‰çš„ä¼ å…¥è¿­ä»£å‚æ•°å¯¹è±¡çš„å€¼ï¼ˆä¹ŸåŒ…æ‹¬é promise å€¼ï¼‰ã€‚

**å¤±è´¥/æ‹’ç»ï¼ˆRejectionï¼‰ï¼š** å¦‚æœä¼ å…¥çš„ `promise` ä¸­æœ‰ä¸€ä¸ªå¤±è´¥ï¼ˆ`rejected`ï¼‰ï¼Œ`Promise.all` å¼‚æ­¥åœ°å°†å¤±è´¥çš„é‚£ä¸ªç»“æœç»™å¤±è´¥çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼Œè€Œä¸ç®¡å…¶å®ƒ `promise` æ˜¯å¦å®Œæˆã€‚

æ¥ä¸ªä¾‹å­ï¼š

```javascript
const promises = [
  Promise.resolve('a'),
  Promise.resolve('b'),
  Promise.resolve('c'),
];
Promise.all(promises)
  .then((arr) => assert.deepEqual(
    arr, ['a', 'b', 'c']
  ));
å¤åˆ¶ä»£ç 
```

å¦‚æœå…¶ä¸­çš„ä¸€ä¸ª promise è¢«æ‹’ç»ï¼Œé‚£ä¹ˆåˆæ˜¯ä»€ä¹ˆæƒ…å†µï¼š

```javascript
const promises = [
  Promise.resolve('a'),
  Promise.resolve('b'),
  Promise.reject('ERROR'),
];
Promise.all(promises)
  .catch((err) => assert.equal(
    err, 'ERROR'
  ));
å¤åˆ¶ä»£ç 
```

ä¸‹å›¾è¯´æ˜`Promise.all()`æ˜¯å¦‚ä½•å·¥ä½œçš„

![è¿™éœ€è¦æœ‰æ•°å­—ç”µè·¯çš„çŸ¥è¯†æ‰èƒ½çœ‹å¾—æ‡‚å“¦](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dcb803d2b3744f1bb028f50ff9ca9eb1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

#### 4.1 å¼‚æ­¥ .map() ä¸ Promise.all()

æ•°ç»„è½¬æ¢æ–¹æ³•ï¼Œå¦‚`.map()`ã€`.filter()`ç­‰ï¼Œç”¨äºåŒæ­¥è®¡ç®—ã€‚ä¾‹å¦‚

```ini
function timesTwoSync(x) {
  return 2 * x;
}
const arr = [1, 2, 3];
const result = arr.map(timesTwoSync);
assert.deepEqual(result, [2, 4, 6]);
å¤åˆ¶ä»£ç 
```

å¦‚æœ`.map()`çš„å›è°ƒæ˜¯åŸºäº`Promise`çš„å‡½æ•°ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ ä½¿ç”¨è¿™ç§æ–¹å¼ `.map()`è¿”å›çš„çš„ç»“æœæ˜¯ä¸€ä¸ª`Promises`æ•°ç»„ã€‚

`Promises`æ•°ç»„ä¸æ˜¯æ™®é€šä»£ç å¯ä»¥ä½¿ç”¨çš„æ•°æ®ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡`Promise.all()`æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼šå®ƒå°†Promisesæ•°ç»„è½¬æ¢ä¸º`Promise`ï¼Œå¹¶ä½¿ç”¨ä¸€ç»„æ™®é€šå€¼æ•°ç»„æ¥å®ç°ã€‚

```ini
function timesTwoAsync(x) {
  return new Promise(resolve => resolve(x * 2));
}
const arr = [1, 2, 3];
const promiseArr = arr.map(timesTwoAsync);
Promise.all(promiseArr)
  .then(result => {
    assert.deepEqual(result, [2, 4, 6]);
  });
å¤åˆ¶ä»£ç 
```

#### æ›´å®é™…å·¥ä½œä¸Šå…³äº .map()ç¤ºä¾‹

æ¥ä¸‹æ¥ï¼Œå’±ä»¬ä½¿ç”¨`.map()`å’Œ`Promise.all()`ä»`Web`ä¸‹è½½æ–‡ä»¶ã€‚ é¦–å…ˆï¼Œå’±ä»¬éœ€è¦ä»¥ä¸‹å¸®åŠ©å‡½æ•°ï¼š

```javascript
function downloadText(url) {
  return fetch(url)
    .then((response) => { // (A)
      if (!response.ok) { // (B)
        throw new Error(response.statusText);
      }
      return response.text(); // (C)
    });
}
å¤åˆ¶ä»£ç 
```

`downloadText()`ä½¿ç”¨åŸºäº`Promise`çš„fetch API ä»¥å­—ç¬¦ä¸²æµçš„æ–¹å¼ä¸‹è½½æ–‡ä»¶ï¼š

- é¦–å…ˆï¼Œå®ƒå¼‚æ­¥æ£€ç´¢å“åº”ï¼ˆç¬¬Aè¡Œï¼‰ã€‚
- response.okï¼ˆBè¡Œï¼‰æ£€æŸ¥æ˜¯å¦å­˜åœ¨â€œæ‰¾ä¸åˆ°æ–‡ä»¶â€ç­‰é”™è¯¯ã€‚
- å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œä½¿ç”¨`.text()`(ç¬¬Cè¡Œ)ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å–å›æ–‡ä»¶çš„å†…å®¹ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå’±ä»¬ ä¸‹è½½äº†ä¸¤ä¸ªæ–‡ä»¶

```ini
const urls = [
  'http://example.com/first.txt',
  'http://example.com/second.txt',
];

const promises = urls.map(
  url => downloadText(url));

Promise.all(promises)
  .then(
    (arr) => assert.deepEqual(
      arr, ['First!', 'Second!']
    ));
å¤åˆ¶ä»£ç 
```

#### Promise.all()çš„ä¸€ä¸ªç®€ç‰ˆå®ç°

```ini
function all(iterable) {
  return new Promise((resolve, reject) => {
    let index = 0;
    for (const promise of iterable) {
      // Capture the current value of `index`
      const currentIndex = index;
      promise.then(
        (value) => {
          if (anErrorOccurred) return;
          result[currentIndex] = value;
          elementCount++;
          if (elementCount === result.length) {
            resolve(result);
          }
        },
        (err) => {
          if (anErrorOccurred) return;
          anErrorOccurred = true;
          reject(err);
        });
      index++;
    }
    if (index === 0) {
      resolve([]);
      return;
    }
    let elementCount = 0;
    let anErrorOccurred = false;
    const result = new Array(index);
  });
}
å¤åˆ¶ä»£ç 
```

\##5. Promise.race()

`Promise.race()`æ–¹æ³•çš„å®šä¹‰ï¼š

**Promise.race(promises: Iterable): Promise**

**Promise.race(iterable)** æ–¹æ³•è¿”å›ä¸€ä¸ª `promise`ï¼Œä¸€æ—¦è¿­ä»£å™¨ä¸­çš„æŸä¸ª`promise`è§£å†³æˆ–æ‹’ç»ï¼Œè¿”å›çš„ `promise`å°±ä¼šè§£å†³æˆ–æ‹’ç»ã€‚æ¥å‡ ä¸ªä¾‹å­ï¼Œç§ç§ï¼š

```javascript
const promises = [
  new Promise((resolve, reject) =>
    setTimeout(() => resolve('result'), 100)), // (A)
  new Promise((resolve, reject) =>
    setTimeout(() => reject('ERROR'), 200)), // (B)
];
Promise.race(promises)
  .then((result) => assert.equal( // (C)
    result, 'result'));
å¤åˆ¶ä»£ç 
```

åœ¨ç¬¬ `A` è¡Œï¼Œ`Promise` æ˜¯å®ŒæˆçŠ¶æ€ ï¼Œæ‰€ä»¥ ç¬¬ `C` è¡Œä¼šæ‰§è¡Œï¼ˆå°½ç®¡ç¬¬ `B` è¡Œè¢«æ‹’ç»ï¼‰ã€‚

å¦‚æœ Promise è¢«æ‹’ç»é¦–å…ˆæ‰§è¡Œï¼Œåœ¨æ¥çœ‹çœ‹æƒ…å†µæ˜¯å˜›æ ·çš„ï¼š

```javascript
const promises = [
  new Promise((resolve, reject) =>
    setTimeout(() => resolve('result'), 200)),
  new Promise((resolve, reject) =>
    setTimeout(() => reject('ERROR'), 100)),
];
Promise.race(promises)
  .then(
    (result) => assert.fail(),
    (err) => assert.equal(
      err, 'ERROR'));
å¤åˆ¶ä»£ç 
```

æ³¨æ„ï¼Œç”±äº `Promse` å…ˆè¢«æ‹’ç»ï¼Œæ‰€ä»¥ `Promise.race()` è¿”å›çš„æ˜¯ä¸€ä¸ªè¢«æ‹’ç»çš„ `Promise`

è¿™æ„å‘³ç€`Promise.raceï¼ˆ[]ï¼‰`çš„ç»“æœæ°¸è¿œä¸ä¼šå®Œæˆã€‚

ä¸‹å›¾æ¼”ç¤ºäº†`Promise.race()`çš„å·¥ä½œåŸç†ï¼š

![è¿™éœ€è¦æœ‰æ•°å­—ç”µè·¯çš„çŸ¥è¯†æ‰èƒ½çœ‹å¾—æ‡‚](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2da73c2ea1b54014a072f463d4643e70~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

#### Promise.race() åœ¨ Promise è¶…æ—¶ä¸‹çš„æƒ…å†µ

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`Promise.race()`æ¥å¤„ç†è¶…æ—¶çš„ `Promise`ã€‚ ä»¥ä¸‹è¾…åŠ©å‡½æ•°:

```javascript
function resolveAfter(ms, value=undefined) {
  return new Promise((resolve, reject) => {
    setTimeout(() => resolve(value), ms);
  });
}
å¤åˆ¶ä»£ç 
resolveAfter()` ä¸»è¦åšçš„æ˜¯åœ¨æŒ‡å®šçš„æ—¶é—´å†…ï¼Œè¿”å›ä¸€ä¸ªçŠ¶æ€ä¸º `resolve` çš„ `Promise`ï¼Œå€¼ä¸ºä¸ºä¼ å…¥çš„ `value
```

è°ƒç”¨ä¸Šé¢æ–¹æ³•ï¼š

```javascript
function timeout(timeoutInMs, promise) {
  return Promise.race([
    promise,
    resolveAfter(timeoutInMs,
      Promise.reject(new Error('Operation timed out'))),
  ]);
}
å¤åˆ¶ä»£ç 
```

`timeout()` è¿”å›ä¸€ä¸ª`Promise`ï¼Œè¯¥ `Promise` çš„çŠ¶æ€å–å†³äºä¼ å…¥ `promise` çŠ¶æ€ ã€‚

å…¶ä¸­ `timeout` å‡½æ•°ä¸­çš„ `resolveAfter(timeoutInMs, Promise.reject(new Error('Operation timed out'))` ï¼Œé€šè¿‡ `resolveAfter` å®šä¹‰å¯çŸ¥ï¼Œè¯¥ç»“æœè¿”å›çš„æ˜¯ä¸€ä¸ªè¢«æ‹’ç»çŠ¶æ€çš„ `Promise`ã€‚

å†æ¥çœ‹çœ‹`timeout(timeoutInMs, promise)`çš„è¿è¡Œæƒ…å†µã€‚å¦‚æœä¼ å…¥`promise`åœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹å‰çŠ¶æ€ä¸ºå®Œæˆæ—¶ï¼Œ`timeout` è¿”å›ç»“æœå°±æ˜¯ä¸€ä¸ªå®ŒæˆçŠ¶æ€çš„ `Promise`,å¯ä»¥é€šè¿‡`.then`çš„ç¬¬ä¸€ä¸ªå›è°ƒå‚æ•°å¤„ç†è¿”å›çš„ç»“æœã€‚

```ini
timeout(200, resolveAfter(100, 'Result!'))
  .then(result => assert.equal(result, 'Result!'));
å¤åˆ¶ä»£ç 
```

ç›¸åï¼Œå¦‚æœæ˜¯åœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åå®Œæˆï¼Œåˆš `timeout` è¿”å›ç»“æœå°±æ˜¯ä¸€ä¸ªæ‹’ç»çŠ¶æ€çš„ `Promise`,ä»è€Œè§¦å‘`catch`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚

```javascript
timeout(100, resolveAfter(2000, 'Result!'))
  .catch(err => assert.deepEqual(err, new Error('Operation timed out')));
å¤åˆ¶ä»£ç 
```

é‡è¦çš„æ˜¯è¦äº†è§£â€œPromise è¶…æ—¶â€çš„çœŸæ­£å«ä¹‰ï¼š

1. å¦‚æœä¼ å…¥å…¥`Promise` è¾ƒåˆ°çš„å¾—åˆ°è§£å†³ï¼Œå…¶ç»“æœå°±ä¼šç»™è¿”å›çš„ `Promise`ã€‚
2. å¦‚æœæ²¡æœ‰è¶³å¤Ÿå¿«å¾—åˆ°è§£å†³ï¼Œè¾“å‡ºçš„ `Promise` çš„çŠ¶æ€ä¸ºæ‹’ç»ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¶…æ—¶åªä¼šé˜»æ­¢ä¼ å…¥çš„Promiseï¼Œå½±å“è¾“å‡º Promiseï¼ˆå› ä¸ºPromiseåªèƒ½è§£å†³ä¸€æ¬¡ï¼‰ï¼Œ ä½†å®ƒå¹¶æ²¡æœ‰é˜»æ­¢ä¼ å…¥`Promise`çš„å¼‚æ­¥æ“ä½œã€‚

#### 5.2 Promise.race() çš„ä¸€ä¸ªç®€ç‰ˆå®ç°

ä»¥ä¸‹æ˜¯ `Promise.race()`çš„ä¸€ä¸ªç®€åŒ–å®ç°(å®ƒä¸æ‰§è¡Œå®‰å…¨æ£€æŸ¥)

```ini
function race(iterable) {
  return new Promise((resolve, reject) => {
    for (const promise of iterable) {
      promise.then(
        (value) => {
          if (settlementOccurred) return;
          settlementOccurred = true;
          resolve(value);
        },
        (err) => {
          if (settlementOccurred) return;
          settlementOccurred = true;
          reject(err);
        });
    }
    let settlementOccurred = false;
  });
}
å¤åˆ¶ä»£ç 
```

## 6.Promise.allSettled()

`â€œPromise.allSettledâ€`è¿™ä¸€ç‰¹æ€§æ˜¯ç”±**Jason Williams**ï¼Œ**Robert Pamely**å’Œ**Mathias Bynens**æå‡ºã€‚

`promise.allsettle()`æ–¹æ³•çš„å®šä¹‰ï¼š

- **Promise**.allSettled(promises: Iterable<**Promise**>) : **Promise**<**Array**<SettlementObject>>

å®ƒè¿”å›ä¸€ä¸ª`Array`çš„`Promise`ï¼Œå…¶å…ƒç´ å…·æœ‰ä»¥ä¸‹ç±»å‹ç‰¹å¾ï¼š

```css
type SettlementObject<T> = FulfillmentObject<T> | RejectionObject;

interface FulfillmentObject<T> {
  status: 'fulfilled';
  value: T;
}

interface RejectionObject {
  status: 'rejected';
  reason: unknown;
}
å¤åˆ¶ä»£ç 
```

`Promise.allSettled()`æ–¹æ³•è¿”å›ä¸€ä¸ªpromiseï¼Œè¯¥promiseåœ¨æ‰€æœ‰ç»™å®šçš„promiseå·²è¢«è§£ææˆ–è¢«æ‹’ç»åè§£æï¼Œå¹¶ä¸”æ¯ä¸ªå¯¹è±¡éƒ½æè¿°æ¯ä¸ªpromiseçš„ç»“æœã€‚

ä¸¾ä¾‹è¯´æ˜, æ¯”å¦‚å„ä½ç”¨æˆ·åœ¨é¡µé¢ä¸Šé¢åŒæ—¶å¡«äº†3ä¸ªç‹¬ç«‹çš„è¡¨å•, è¿™ä¸‰ä¸ªè¡¨å•åˆ†ä¸‰ä¸ªæ¥å£æäº¤åˆ°åç«¯, ä¸‰ä¸ªæ¥å£ç‹¬ç«‹, æ²¡æœ‰é¡ºåºä¾èµ–, è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦ç­‰åˆ°è¯·æ±‚å…¨éƒ¨å®Œæˆåç»™ä¸ç”¨æˆ·æç¤ºè¡¨å•æäº¤çš„æƒ…å†µ

åœ¨å¤šä¸ª`promise`åŒæ—¶è¿›è¡Œæ—¶å’±ä»¬å¾ˆå¿«ä¼šæƒ³åˆ°ä½¿ç”¨`Promise.all`æ¥è¿›è¡ŒåŒ…è£…, ä½†æ˜¯ç”±äº`Promise.all`çš„çŸ­è·¯ç‰¹æ€§, ä¸‰ä¸ªæäº¤ä¸­è‹¥å‰é¢ä»»æ„ä¸€ä¸ªæäº¤å¤±è´¥, åˆ™åé¢çš„è¡¨å•ä¹Ÿä¸ä¼šè¿›è¡Œæäº¤äº†, è¿™å°±ä¸å’±ä»¬éœ€æ±‚ä¸ç¬¦åˆ.

`Promise.allSettled`è·Ÿ`Promise.all`ç±»ä¼¼, å…¶å‚æ•°æ¥å—ä¸€ä¸ª`Promise`çš„æ•°ç»„, è¿”å›ä¸€ä¸ªæ–°çš„`Promise`, å”¯ä¸€çš„ä¸åŒåœ¨äº, å…¶ä¸ä¼šè¿›è¡ŒçŸ­è·¯, ä¹Ÿå°±æ˜¯è¯´å½“`Promise`å…¨éƒ¨å¤„ç†å®Œæˆåæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°æ¯ä¸ª`Promise`çš„çŠ¶æ€, è€Œä¸ç®¡å…¶æ˜¯å¦å¤„ç†æˆåŠŸ.

ä¸‹å›¾è¯´æ˜`promise.allsettle()`æ˜¯å¦‚ä½•å·¥ä½œçš„

![è¿™éœ€è¦æœ‰æ•°å­—ç”µè·¯çš„çŸ¥è¯†æ‰èƒ½çœ‹å¾—æ‡‚å“¦](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a836cc5e7df41bf976ffcd8a8e7202c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

#### 6.1 Promise.allSettled() ä¾‹å­

è¿™æ˜¯`Promise.allSettled()` ä½¿ç”¨æ–¹å¼å¿«é€Ÿæ¼”ç¤ºç¤ºä¾‹

```less
Promise.allSettled([
  Promise.resolve('a'),
  Promise.reject('b'),
])
.then(arr => assert.deepEqual(arr, [
  { status: 'fulfilled', value:  'a' },
  { status: 'rejected',  reason: 'b' },
]));
å¤åˆ¶ä»£ç 
```

#### 6.2 Promise.allSettled() è¾ƒå¤æ‚ç‚¹çš„ä¾‹å­

è¿™ä¸ªç¤ºä¾‹ç±»ä¼¼äº`.map()`å’Œ`Promise.all()`ç¤ºä¾‹(æˆ‘ä»¬ä»å…¶ä¸­å€Ÿç”¨äº†`downloadText()`å‡½æ•°):æˆ‘ä»¬ä¸‹è½½å¤šä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶çš„`url`å­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™ä¸€æ¬¡ï¼Œå’±ä»¬ä¸å¸Œæœ›åœ¨å‡ºç°é”™è¯¯æ—¶åœæ­¢ï¼Œè€Œæ˜¯å¸Œæœ›ç»§ç»­æ‰§è¡Œã€‚`Promise.allSettled()`å…è®¸å’±ä»¬è¿™æ ·åšï¼š

```less
const urls = [  'http://example.com/exists.txt',  'http://example.com/missing.txt',];

const result = Promise.allSettled(
  urls.map(u => downloadText(u)));
result.then(
  arr => assert.deepEqual(
    arr,
    [
      {
        status: 'fulfilled',
        value: 'Hello!',
      },
      {
        status: 'rejected',
        reason: new Error('Not Found'),
      },
    ]
));
å¤åˆ¶ä»£ç 
```

#### 6.3 Promise.allSettled() çš„ç®€åŒ–å®ç°

è¿™æ˜¯`promise.allsettle()`çš„ç®€åŒ–å®ç°(ä¸æ‰§è¡Œå®‰å…¨æ£€æŸ¥)

```ini
function allSettled(iterable) {
  return new Promise((resolve, reject) => {
    function addElementToResult(i, elem) {
      result[i] = elem;
      elementCount++;
      if (elementCount === result.length) {
        resolve(result);
      }
    }

    let index = 0;
    for (const promise of iterable) {
      // Capture the current value of `index`
      const currentIndex = index;
      promise.then(
        (value) => addElementToResult(
          currentIndex, {
            status: 'fulfilled',
            value
          }),
        (reason) => addElementToResult(
          currentIndex, {
            status: 'rejected',
            reason
          }));
      index++;
    }
    if (index === 0) {
      resolve([]);
      return;
    }
    let elementCount = 0;
    const result = new Array(index);
  });
}
å¤åˆ¶ä»£ç 
```

## 7. çŸ­è·¯ç‰¹æ€§

`Promise.all()` å’Œ `romise.race()` éƒ½å…·æœ‰ çŸ­è·¯ç‰¹æ€§

- **Promise.all()**ï¼š å¦‚æœå‚æ•°ä¸­ `promise` æœ‰ä¸€ä¸ªå¤±è´¥ï¼ˆrejectedï¼‰ï¼Œæ­¤å®ä¾‹å›è°ƒå¤±è´¥ï¼ˆrejectï¼‰

**Promise.race()**ï¼šå¦‚æœå‚æ•°ä¸­æŸä¸ª`promise`è§£å†³æˆ–æ‹’ç»ï¼Œè¿”å›çš„ promiseå°±ä¼šè§£å†³æˆ–æ‹’ç»ã€‚

## 8.å¹¶å‘æ€§å’Œ Promise.all()

#### 8.1 é¡ºåºæ‰§è¡Œä¸å¹¶å‘æ‰§è¡Œ

è€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼š

```ini
asyncFunc1()
  .then(result1 => {
    assert.equal(result1, 'one');
    return asyncFunc2();
  })
  .then(result2 => {
    assert.equal(result2, 'two');
  });
å¤åˆ¶ä»£ç 
```

ä½¿ç”¨`.then()`é¡ºåºæ‰§è¡ŒåŸºäº`Promise`çš„å‡½æ•°ï¼šåªæœ‰åœ¨ `asyncFunc1()`çš„ç»“æœè¢«è§£å†³åæ‰ä¼šæ‰§è¡Œ`asyncFunc2()` ã€‚

è€Œ `Promise.all()` æ˜¯å¹¶å‘æ‰§è¡Œçš„

```ini
Promise.all([asyncFunc1(), asyncFunc2()])
  .then(arr => {
    assert.deepEqual(arr, ['one', 'two']);
  });
å¤åˆ¶ä»£ç 
```

#### 9.2 å¹¶å‘æŠ€å·§ï¼šå…³æ³¨æ“ä½œä½•æ—¶å¼€å§‹

ç¡®å®šå¹¶å‘å¼‚æ­¥ä»£ç çš„æŠ€å·§:å…³æ³¨å¼‚æ­¥æ“ä½œä½•æ—¶å¯åŠ¨ï¼Œè€Œä¸æ˜¯å¦‚ä½•å¤„ç†å®ƒä»¬çš„**Promises**ã€‚

ä¾‹å¦‚ï¼Œä¸‹é¢çš„æ¯ä¸ªå‡½æ•°éƒ½åŒæ—¶æ‰§è¡Œ`asyncFunc1()`å’Œ`asyncFunc2()`ï¼Œå› ä¸ºå®ƒä»¬å‡ ä¹åŒæ—¶å¯åŠ¨ã€‚

```scss
function concurrentAll() {
  return Promise.all([asyncFunc1(), asyncFunc2()]);
}

function concurrentThen() {
  const p1 = asyncFunc1();
  const p2 = asyncFunc2();
  return p1.then(r1 => p2.then(r2 => [r1, r2]));
}
å¤åˆ¶ä»£ç 
```

å¦ä¸€æ–¹é¢ï¼Œä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ä¾æ¬¡æ‰§è¡Œ`asyncFunc1()`å’Œ`asyncFunc2()`: `asyncFunc2()`ä»…åœ¨`asyncFunc1()`çš„è§£å†³ä¹‹åæ‰è°ƒç”¨ã€‚

```scss
function sequentialThen() {
  return asyncFunc1()
    .then(r1 => asyncFunc2()
      .then(r2 => [r1, r2]));
}

function sequentialAll() {
  const p1 = asyncFunc1();
  const p2 = p1.then(() => asyncFunc2());
  return Promise.all([p1, p2]);
}
å¤åˆ¶ä»£ç 
```

#### 9.3 Promise.all() ä¸ Fork-Join åˆ†æ²»ç¼–ç¨‹

`Promise.all()` ä¸å¹¶å‘æ¨¡å¼â€œfork joinâ€æ¾æ•£ç›¸å…³ã€‚é‡æ¸©ä¸€ä¸‹å’±ä»¬å‰é¢çš„ä¸€ä¸ªä¾‹å­ï¼š

```javascript
Promise.all([
    // (A) fork
    downloadText('http://example.com/first.txt'),
    downloadText('http://example.com/second.txt'),
  ])
  // (B) join
  .then(
    (arr) => assert.deepEqual(
      arr, ['First!', 'Second!']
    ));
å¤åˆ¶ä»£ç 
```

- Forkï¼šåœ¨`A`è¡Œä¸­ï¼Œåˆ†å‰²ä¸¤ä¸ªå¼‚æ­¥ä»»åŠ¡å¹¶åŒæ—¶æ‰§è¡Œå®ƒä»¬ã€‚
- Joinï¼šåœ¨`B`è¡Œä¸­ï¼Œå¯¹æ¯ä¸ªå°ä»»åŠ¡å¾—åˆ°çš„ç»“æœè¿›è¡Œæ±‡æ€»ã€‚

**ä»£ç éƒ¨ç½²åå¯èƒ½å­˜åœ¨çš„BUGæ²¡æ³•å®æ—¶çŸ¥é“ï¼Œäº‹åä¸ºäº†è§£å†³è¿™äº›BUGï¼ŒèŠ±äº†å¤§é‡çš„æ—¶é—´è¿›è¡Œlog è°ƒè¯•ï¼Œè¿™è¾¹é¡ºä¾¿ç»™å¤§å®¶æ¨èä¸€ä¸ªå¥½ç”¨çš„BUGç›‘æ§å·¥å…· [Fundebug](https://link.juejin.cn/?target=https%3A%2F%2Fwww.fundebug.com%2F%3Futm_source%3Dxiaozhi)ã€‚**

## ä¸€. ä»€ä¹ˆæ˜¯Promise?

åœ¨`JavaScript`çš„ä¸–ç•Œä¸­ï¼Œæ‰€æœ‰ä»£ç éƒ½æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ã€‚ç”±äºè¿™ä¸ªâ€œç¼ºé™·â€ï¼Œå¯¼è‡´JavaScriptçš„æ‰€æœ‰ç½‘ç»œæ“ä½œï¼Œæµè§ˆå™¨äº‹ä»¶ï¼Œéƒ½å¿…é¡»æ˜¯å¼‚æ­¥æ‰§è¡Œã€‚å¼‚æ­¥æ‰§è¡Œå¯ä»¥ç”¨`å›è°ƒå‡½æ•°å®ç°`ï¼š

```js
function requestData(url, successCallback, failtureCallback) {
  // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
  setTimeout(() => {
    // æ‹¿åˆ°è¯·æ±‚çš„ç»“æœ
    // urlä¼ å…¥çš„æ˜¯localhost, è¯·æ±‚æˆåŠŸ
    if (url === "localhost") {
      // æˆåŠŸ
      successCallback('success')
    } else { // å¦åˆ™è¯·æ±‚å¤±è´¥
      // å¤±è´¥
      failtureCallback("error")
    }
  }, 3000);
}

//æ‰§è¡Œè¯·æ±‚
requestData("kobe", (res) => {
  console.log(res)
}, (err) => {
  console.log(err)
})
å¤åˆ¶ä»£ç 
```

ä½†å®é™…å¼€å‘è¿‡ç¨‹ä¸­æœ‰äº›æƒ…å†µéœ€è¦å¤šæ¬¡è°ƒç”¨æœåŠ¡å™¨APIï¼Œå°±ä¼šå½¢æˆä¸€ä¸ªé“¾å¼è°ƒç”¨ï¼Œæ¯”å¦‚ä¸ºäº†å®Œæˆä¸€ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨API1ã€API2ã€API3ï¼Œä¾æ¬¡æŒ‰ç…§é¡ºåºè¿›è¡Œè°ƒç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°`å›è°ƒåœ°ç‹±`çš„é—®é¢˜ï¼Œå³åµŒå¥—å±‚æ¬¡æ·±ï¼Œä¸å¥½ç»´æŠ¤ï¼Œå¯è¯»æ€§å·®ã€‚è¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°`Promise`ã€‚

## äºŒ. Promiseä½¿ç”¨æ–¹å¼

`Promise` å¯¹è±¡çš„`æ„é€ å™¨ï¼ˆconstructorï¼‰`è¯­æ³•å¦‚ä¸‹ï¼š

```js
// ä¼ å…¥çš„è¿™ä¸ªå‡½æ•°, è¢«ç§°ä¹‹ä¸º executor
// > resolve: å›è°ƒå‡½æ•°, åœ¨æˆåŠŸæ—¶, å›è°ƒresolveå‡½æ•°
// > reject: å›è°ƒå‡½æ•°, åœ¨å¤±è´¥æ—¶, å›è°ƒrejectå‡½æ•°
let promise = new Promise(function(resolve, reject) { // executor });
å¤åˆ¶ä»£ç 
```

executor æœ€ç»ˆå°† `promise` ç§»è‡³ä»¥ä¸‹çŠ¶æ€ä¹‹ä¸€ï¼š

> executor åªèƒ½è°ƒç”¨ä¸€ä¸ª `resolve` æˆ–ä¸€ä¸ª `reject`ã€‚ä¸€æ—¦çŠ¶æ€è¢«ç¡®å®šä¸‹æ¥ï¼ŒPromiseçš„çŠ¶æ€ä¼šè¢«`é”æ­»`ï¼Œè¯¥Promiseçš„çŠ¶æ€æ˜¯ä¸å¯æ›´æ”¹çš„ã€‚ ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/278d28a58a1f4694ac5edae411d0e754~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

ä¸Šæ–¹ä»£ç æ”¹å†™ä¸º`Promise`:

```js
// request.js
function requestData(url,) {
  // å¼‚æ­¥è¯·æ±‚çš„ä»£ç ä¼šè¢«æ”¾å…¥åˆ°executorä¸­
  return new Promise((resolve, reject) => {
    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
    setTimeout(() => {
      // æ‹¿åˆ°è¯·æ±‚çš„ç»“æœ
      // urlä¼ å…¥çš„æ˜¯localhost, è¯·æ±‚æˆåŠŸ
      if (url === "localhost") {
        // æˆåŠŸ
        resolve(success)
      } else { // å¦åˆ™è¯·æ±‚å¤±è´¥
        // å¤±è´¥
        reject('error')
      }
    }, 3000);
  })
}

const promise = requestData("localhost")

//thenæ–¹æ³•æ˜¯Promiseå¯¹è±¡ä¸Šçš„ä¸€ä¸ªæ–¹æ³•ï¼šå®ƒå…¶å®æ˜¯æ”¾åœ¨Promiseçš„åŸå‹ä¸Šçš„ Promise.prototype.then
promise.then((res) => {
  console.log("è¯·æ±‚æˆåŠŸ:", res)
}, (err) => { 
   console.log("è¯·æ±‚å¤±è´¥:", err)
})

//ç­‰ä»·äº
promise.then((res) => {
  console.log("è¯·æ±‚æˆåŠŸ:", res)
}).catch(err => {//catchæ–¹æ³•ä¹Ÿæ˜¯Promiseå¯¹è±¡ä¸Šçš„ä¸€ä¸ªæ–¹æ³•ï¼šå®ƒä¹Ÿæ˜¯æ”¾åœ¨Promiseçš„åŸå‹ä¸Šçš„ Promise.prototype.catch
console.log("è¯·æ±‚å¤±è´¥:", err)
})
å¤åˆ¶ä»£ç 
```

**å½“ä¼ å…¥resolveä¸åŒçš„å€¼çš„åŒºåˆ«:**

> æƒ…å†µä¸€ï¼šå¦‚æœresolveä¼ å…¥ä¸€ä¸ªæ™®é€šçš„å€¼æˆ–è€…å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼ä¼šä½œä¸ºthenå›è°ƒçš„å‚æ•°ï¼›

> æƒ…å†µäºŒï¼šå¦‚æœresolveä¸­ä¼ å…¥çš„æ˜¯å¦å¤–ä¸€ä¸ªPromiseï¼Œé‚£ä¹ˆè¿™ä¸ªæ–°Promiseä¼šå†³å®šåŸPromiseçš„çŠ¶æ€ï¼›

ä¸¾ä¾‹ï¼š

```js
new Promise((resolve, reject) => {
  // pending -> fulfilled
  resolve(new Promise((resolve,reject)=>{
    setTimeout(()=>{resolve(111)},1000)
  }))
}).then(res => {
  console.log("res:", res) //111
}, err => {
  console.log("err:", err)
})
å¤åˆ¶ä»£ç 
```

> æƒ…å†µä¸‰ï¼šå¦‚æœresolveä¸­ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ªå¯¹è±¡æœ‰å®ç°thenæ–¹æ³•ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œè¯¥thenæ–¹æ³•ï¼Œå¹¶ä¸”æ ¹æ® thenæ–¹æ³•çš„ç»“æœæ¥å†³å®šPromiseçš„çŠ¶æ€ï¼›

ä¸¾ä¾‹ï¼š

```js
// 2.ä¼ å…¥ä¸€ä¸ªå¯¹è±¡, è¿™ä¸ªå…‘ç°æœ‰thenæ–¹æ³•
new Promise((resolve, reject) => {
  // pending -> fulfilled
  const obj = {
    then: function(resolve, reject) {
      // resolve("resolve message")
      reject("reject message")
    }
  }
  resolve(obj)
}).then(res => {
  console.log("res:", res)
}, err => {
  console.log("err:", err)//reject message
})
å¤åˆ¶ä»£ç 
```

## ä¸‰. Promiseå®ä¾‹æ–¹æ³•

### 1. `then`æ–¹æ³•

å½“`Promise`çš„çŠ¶æ€å˜æˆ`fulfilled`çš„æ—¶å€™ï¼Œthenæ–¹æ³•å¯ä»¥å¤šæ¬¡è°ƒç”¨(åŒç†çŠ¶æ€å˜æˆ`reject`çš„æ—¶å€™ï¼Œcatchä¹Ÿå¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼‰ ï¼š

```js
onst promise = new Promise((resolve, reject) => {
  resolve("hahaha")
})

promise.then(res => {
  console.log("res1:", res)
})

promise.then(res => {
  console.log("res2:", res)
})

promise.then(res => {
  console.log("res3:", res)
})
å¤åˆ¶ä»£ç 
```

`then`æ–¹æ³•æœ¬èº«ä¹Ÿæ˜¯æœ‰è¿”å›å€¼çš„, å®ƒçš„è¿”å›å€¼æ˜¯`Promise`,æˆ‘ä»¬å¯ä»¥è¿›è¡Œé“¾å¼è°ƒç”¨ã€‚

```js
promise.then(res => {
  return "aaaaaa"
}).then(res => {
  console.log("res:", res) //aaaaaa
  return "bbbbbb"
})
å¤åˆ¶ä»£ç 
```

**thenæ–¹æ³•è¿”å›çš„Promiseåˆ°åº•å¤„äºä»€ä¹ˆæ ·çš„çŠ¶æ€å‘¢ï¼Ÿ**

> å½“`then`æ–¹æ³•ä¸­çš„å›è°ƒå‡½æ•°æœ¬èº«åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œé‚£ä¹ˆå®ƒå¤„äº`pending`çŠ¶æ€ï¼›
>
> å½“`then`æ–¹æ³•ä¸­çš„å›è°ƒå‡½æ•°è¿”å›ä¸€ä¸ªç»“æœæ—¶ï¼Œé‚£ä¹ˆå®ƒå¤„äº`fulfilled`çŠ¶æ€ï¼Œå¹¶ä¸”ä¼šå°†ç»“æœä½œä¸ºresolveçš„å‚æ•°ï¼›
>
> å½“`then`æ–¹æ³•æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸æ—¶ï¼Œé‚£ä¹ˆå®ƒå¤„äº`reject`çŠ¶æ€ï¼›

`then`ä¼ å…¥ä¸åŒå€¼åŒºåˆ«çš„åŒä¸Šæ–¹`resolve`ç›¸åŒï¼Œè¿™è¾¹å°±ä¸ä¸¾ä¾‹äº†ï¼Œå¤§å®¶è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸‹ã€‚

### 2.`catch` æ–¹æ³•

catchæ–¹æ³•ä¹Ÿæ˜¯ä¼šè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡çš„ï¼Œæ‰€ä»¥catchæ–¹æ³•åé¢å¯ä»¥ç»§ç»­è°ƒç”¨thenæ–¹æ³•æˆ–è€…catchæ–¹æ³•:

```js
const promise = new Promise((resolve, reject) => {
  reject("111111")
})

promise.then(res => {
  console.log("res:", res)
}).catch(err => {
  console.log("err:", err)//111111
  // throw new Error('hhhhhh')
  return "catch return value"
}).then(res => {
  console.log("res result:", res) //catch return value
}).catch(err => {
  console.log("err result:", err)  
})
å¤åˆ¶ä»£ç 
```

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f97d44a5b5694a8b916bc100d22fa13c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

> æç¤ºï¼šæŠŠä¸Šæ–¹æ³¨é‡Šçš„throwæ–¹æ³•æ‰“å¼€ï¼Œæ–¹æ³•ä¼šå–ä¸‹æ–¹catchéƒ¨åˆ†

### 3.`finally` æ–¹æ³•

finallyæ˜¯åœ¨ES9ï¼ˆES2018ï¼‰ä¸­æ–°å¢çš„ä¸€ä¸ªç‰¹æ€§ï¼šè¡¨ç¤ºæ— è®ºPromiseå¯¹è±¡æ— è®ºå˜æˆfulfilledè¿˜æ˜¯rejectçŠ¶æ€ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«æ‰§è¡Œçš„ä»£ç ã€‚

> finallyæ–¹æ³•æ˜¯ä¸æ¥æ”¶å‚æ•°çš„ï¼Œå› ä¸ºæ— è®ºå‰é¢æ˜¯fulfilledçŠ¶æ€ï¼Œè¿˜æ˜¯rejectçŠ¶æ€ï¼Œå®ƒéƒ½ä¼šæ‰§è¡Œ

```js
const promise = new Promise((resolve, reject) => {
  // resolve("resolve message")
  reject("reject message")
})

promise.then(res => {
  console.log("res:", res)
}).catch(err => {
  console.log("err:", err)
}).finally(() => {
  console.log("finally code execute")
})

å¤åˆ¶ä»£ç 
```

## å››. Promiseç±»æ–¹æ³•

### 1.Promise.resolve

ç”¨æ³•ç›¸å½“äºnew Promiseï¼Œå¹¶ä¸”æ‰§è¡Œresolveæ“ä½œï¼š

```js
// 1.æ™®é€šçš„å€¼
 const promise = Promise.resolve({ name: "why" })
// ç›¸å½“äº
 const promise2 = new Promise((resolve, reject) => {
   resolve({ name: "why" })
 })
å¤åˆ¶ä»£ç 
```

### 2.Promise.reject

ç”¨æ³•ç›¸å½“äºnew Promiseï¼Œåªæ˜¯ä¼šè°ƒç”¨rejectï¼š

```js
const promise = Promise.reject("rejected message")
//ç›¸å½“äº
const promise2 = new Promsie((resolve, reject) => {
  reject("rejected message")
})
å¤åˆ¶ä»£ç 
```

### 3.Promise.all

ä½œç”¨æ˜¯å°†å¤šä¸ªPromiseåŒ…è£¹åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ–°çš„Promise,æ–°çš„PromiseçŠ¶æ€ç”±åŒ…è£¹çš„æ‰€æœ‰Promiseå…±åŒå†³å®šï¼š

> å½“æ‰€æœ‰çš„PromiseçŠ¶æ€å˜æˆfulfilledçŠ¶æ€æ—¶ï¼Œæ–°çš„PromiseçŠ¶æ€ä¸ºfulfilledï¼Œå¹¶ä¸”ä¼šå°†æ‰€æœ‰Promiseçš„è¿”å›å€¼ ç»„æˆä¸€ä¸ªæ•°ç»„ï¼›
>
> å½“æœ‰ä¸€ä¸ªPromiseçŠ¶æ€ä¸ºrejectæ—¶ï¼Œæ–°çš„PromiseçŠ¶æ€ä¸ºrejectï¼Œå¹¶ä¸”ä¼šå°†ç¬¬ä¸€ä¸ªrejectçš„è¿”å›å€¼ä½œä¸ºå‚æ•°;

```js
// åˆ›å»ºå¤šä¸ªPromise
const p1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve(11111)
  }, 1000);
})

const p2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject(22222)
  }, 2000);
})

const p3 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve(33333)
  }, 3000);
})

// éœ€æ±‚: æ‰€æœ‰çš„Promiseéƒ½å˜æˆfulfilledæ—¶, å†æ‹¿åˆ°ç»“æœ
// æ„å¤–: åœ¨æ‹¿åˆ°æ‰€æœ‰ç»“æœä¹‹å‰, æœ‰ä¸€ä¸ªpromiseå˜æˆäº†rejected, é‚£ä¹ˆæ•´ä¸ªpromiseæ˜¯rejected
Promise.all([p2, p1, p3, "aaaa"]).then(res => {
  console.log(res)
}).catch(err => {
  console.log("err:", err)
})
å¤åˆ¶ä»£ç 
```

### 3.Promise.race

å¦‚æœæœ‰ä¸€ä¸ªPromiseæœ‰äº†ç»“æœï¼Œæˆ‘ä»¬å°±å¸Œæœ›å†³å®šæœ€ç»ˆæ–°Promiseçš„çŠ¶æ€ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨raceæ–¹æ³•

```js
// åªè¦æœ‰ä¸€ä¸ªPromiseå˜æˆfulfilledçŠ¶æ€, é‚£ä¹ˆå°±ç»“æŸ
// æ„å¤–: 
Promise.race([p1, p2, p3]).then(res => {
  console.log("res:", res)
}).catch(err => {
  console.log("err:", err)
})

å¤åˆ¶ä»£ç 
```

# åè®°

å½“ç„¶promiseç±»è¿œè¿œä¸æ­¢ä¸Šæ–¹å‡ ç§æ–¹æ³•ï¼Œåœ¨ES11,ES12ä¸­æ–°å¢äº†`Promise.allSettled`ã€`Promise.any`, è¿™è¾¹å°±ä¸ä»‹ç»äº†ï¼Œå¤§å®¶å¯ç‚¹å‡»æ­¤é“¾æ¥è‡ªä¸»å­¦ä¹ 

## å‰è¨€

æˆ‘ä»¬çŸ¥é“`Promise`ä¸`Async/await`å‡½æ•°éƒ½æ˜¯ç”¨æ¥è§£å†³JavaScriptä¸­çš„å¼‚æ­¥é—®é¢˜çš„ï¼Œä»æœ€å¼€å§‹çš„å›è°ƒå‡½æ•°å¤„ç†å¼‚æ­¥ï¼Œåˆ°`Promise`å¤„ç†å¼‚æ­¥ï¼Œåˆ°`Generator`å¤„ç†å¼‚æ­¥ï¼Œå†åˆ°`Async/await`å¤„ç†å¼‚æ­¥ï¼Œæ¯ä¸€æ¬¡çš„æŠ€æœ¯æ›´æ–°éƒ½ä½¿å¾—JavaScriptå¤„ç†å¼‚æ­¥çš„æ–¹å¼æ›´åŠ ä¼˜é›…ï¼Œä»ç›®å‰æ¥çœ‹ï¼Œ`Async/await`è¢«è®¤ä¸ºæ˜¯å¼‚æ­¥å¤„ç†çš„ç»ˆæè§£å†³æ–¹æ¡ˆï¼Œè®©JSçš„å¼‚æ­¥å¤„ç†è¶Šæ¥è¶ŠåƒåŒæ­¥ä»»åŠ¡ã€‚**å¼‚æ­¥ç¼–ç¨‹çš„æœ€é«˜å¢ƒç•Œï¼Œå°±æ˜¯æ ¹æœ¬ä¸ç”¨å…³å¿ƒå®ƒæ˜¯ä¸æ˜¯å¼‚æ­¥**ã€‚

**å¦‚æœè¿™ç¯‡æ–‡ç« æœ‰å¸®åŠ©åˆ°ä½ ï¼Œâ¤ï¸å…³æ³¨+ç‚¹èµâ¤ï¸é¼“åŠ±ä¸€ä¸‹ä½œè€…ï¼Œæ–‡ç« å…¬ä¼—å·é¦–å‘ï¼Œå…³æ³¨ `å‰ç«¯å—ç–` ç¬¬ä¸€æ—¶é—´è·å–æœ€æ–°çš„æ–‡ç« ï½**

## å¼‚æ­¥è§£å†³æ–¹æ¡ˆçš„å‘å±•å†ç¨‹

### 1.å›è°ƒå‡½æ•°

ä»æ—©æœŸçš„Javascriptä»£ç æ¥çœ‹ï¼Œåœ¨ES6è¯ç”Ÿä¹‹å‰ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„å¼‚æ­¥å¤„ç†éƒ½æ˜¯åŸºäºå›è°ƒå‡½æ•°å‡½æ•°å®ç°çš„ï¼Œä½ ä»¬å¯èƒ½ä¼šè§è¿‡ä¸‹é¢è¿™ç§ä»£ç ï¼š

```js
ajax('aaa', () => {
    // callback å‡½æ•°ä½“
    ajax('bbb', () => {
        // callback å‡½æ•°ä½“
        ajax('ccc', () => {
            // callback å‡½æ•°ä½“
        })
    })
})
å¤åˆ¶ä»£ç 
```

æ²¡é”™ï¼Œåœ¨ES6å‡ºç°ä¹‹å‰ï¼Œè¿™ç§ä»£ç å¯ä»¥è¯´æ˜¯éšå¤„å¯è§ã€‚å®ƒè™½ç„¶è§£å†³äº†å¼‚æ­¥æ‰§è¡Œçš„é—®é¢˜ï¼Œå¯éšä¹‹è€Œæ¥çš„æ˜¯æˆ‘ä»¬å¸¸å¬è¯´çš„**å›è°ƒåœ°ç‹±**é—®é¢˜ï¼š

- æ²¡æœ‰é¡ºåºå¯è¨€ï¼šåµŒå¥—å‡½æ•°æ‰§è¡Œå¸¦æ¥çš„æ˜¯è°ƒè¯•å›°éš¾ï¼Œä¸åˆ©äºç»´æŠ¤ä¸é˜…è¯»
- è€¦åˆæ€§å¤ªå¼ºï¼šä¸€æ—¦æŸä¸€ä¸ªåµŒå¥—å±‚çº§æœ‰æ”¹åŠ¨ï¼Œå°±ä¼šå½±å“æ•´ä¸ªå›è°ƒçš„æ‰§è¡Œ

**æ‰€ä»¥ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç¤¾åŒºæœ€æ—©æå‡ºå’Œå®ç°äº†`Promise`ï¼ŒES6å°†å…¶å†™è¿›äº†è¯­è¨€æ ‡å‡†ï¼Œç»Ÿä¸€äº†ç”¨æ³•ã€‚**

### 2.Promise

Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ¯”ä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆâ€”â€”å›è°ƒå‡½æ•°å’Œäº‹ä»¶â€”â€”æ›´åˆç†å’Œæ›´å¼ºå¤§ã€‚å®ƒå°±æ˜¯ä¸ºäº†è§£å†³å›è°ƒå‡½æ•°äº§ç”Ÿçš„é—®é¢˜è€Œè¯ç”Ÿçš„ã€‚

æœ‰äº†`Promise`å¯¹è±¡ï¼Œå°±å¯ä»¥å°†å¼‚æ­¥æ“ä½œä»¥åŒæ­¥æ“ä½œçš„æµç¨‹è¡¨è¾¾å‡ºæ¥ï¼Œé¿å…äº†å±‚å±‚åµŒå¥—çš„å›è°ƒå‡½æ•°ã€‚æ­¤å¤–ï¼Œ`Promise`å¯¹è±¡æä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œä½¿å¾—æ§åˆ¶å¼‚æ­¥æ“ä½œæ›´åŠ å®¹æ˜“ã€‚

æ‰€ä»¥ä¸Šé¢é‚£ç§å›è°ƒå‡½æ•°çš„æ–¹å¼æˆ‘ä»¬å¯ä»¥æ”¹æˆè¿™æ ·ï¼š(å‰ææ˜¯ajaxå·²ç”¨PromiseåŒ…è£…)

```js
ajax('aaa').then(res=>{
  return ajax('bbb')
}).then(res=>{
  return ajax('ccc')
})
å¤åˆ¶ä»£ç 
```

é€šè¿‡ä½¿ç”¨`Promise`æ¥å¤„ç†å¼‚æ­¥ï¼Œæ¯”ä»¥å¾€çš„å›è°ƒå‡½æ•°çœ‹èµ·æ¥æ›´åŠ æ¸…æ™°äº†ï¼Œè§£å†³äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œ`Promise`çš„`then`çš„é“¾å¼è°ƒç”¨æ›´èƒ½è®©äººæ¥å—ï¼Œä¹Ÿç¬¦åˆæˆ‘ä»¬åŒæ­¥çš„æ€æƒ³ã€‚

**ä½†Promiseä¹Ÿæœ‰å®ƒçš„ç¼ºç‚¹ï¼š**

- Promiseçš„å†…éƒ¨é”™è¯¯ä½¿ç”¨`try catch`æ•è·ä¸åˆ°ï¼Œåªèƒ½åªç”¨`then`çš„ç¬¬äºŒä¸ªå›è°ƒæˆ–`catch`æ¥æ•è·

```js
let pro
try{
    pro = new Promise((resolve,reject) => {
        throw Error('err....')
    })
}catch(err){
    console.log('catch',err) // ä¸ä¼šæ‰“å°
}
pro.catch(err=>{
    console.log('promise',err) // ä¼šæ‰“å°
})
å¤åˆ¶ä»£ç 
```

- Promiseä¸€æ—¦æ–°å»ºå°±ä¼šç«‹å³æ‰§è¡Œï¼Œæ— æ³•å–æ¶ˆ

ä¹‹å‰å†™è¿‡ä¸€ç¯‡[ä»å¦‚ä½•ä½¿ç”¨åˆ°å¦‚ä½•å®ç°ä¸€ä¸ªPromise](https://juejin.cn/post/7051364317119119396)ï¼Œè®²è§£äº†Promiseå¦‚ä½•ä½¿ç”¨ä»¥åŠå†…éƒ¨å®ç°åŸç†ã€‚å¯¹Promiseè¿˜ä¸å¤ªç†è§£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ï½

### 3.Generator

`Generator` å‡½æ•°æ˜¯ ES6 æä¾›çš„ä¸€ç§å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆï¼Œè¯­æ³•è¡Œä¸ºä¸ä¼ ç»Ÿå‡½æ•°å®Œå…¨ä¸åŒã€‚`Generator` å‡½æ•°å°† JavaScript å¼‚æ­¥ç¼–ç¨‹å¸¦å…¥äº†ä¸€ä¸ªå…¨æ–°çš„é˜¶æ®µã€‚

#### å£°æ˜

ä¸å‡½æ•°å£°æ˜ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯`function`å…³é”®å­—ä¸å‡½æ•°åä¹‹é—´æœ‰ä¸€ä¸ªæ˜Ÿå·ï¼Œä»¥åŠå‡½æ•°ä½“å†…éƒ¨ä½¿ç”¨`yield`è¡¨è¾¾å¼ï¼Œå®šä¹‰ä¸åŒçš„å†…éƒ¨çŠ¶æ€ï¼ˆ`yield`åœ¨è‹±è¯­é‡Œçš„æ„æ€å°±æ˜¯â€œäº§å‡ºâ€ï¼‰ã€‚

```js
function* gen(x){
 const y = yield x + 6;
 return y;
}
// yield å¦‚æœç”¨åœ¨å¦å¤–ä¸€ä¸ªè¡¨è¾¾å¼ä¸­,è¦æ”¾åœ¨()é‡Œé¢
// åƒä¸Šé¢å¦‚æœæ˜¯åœ¨=å³è¾¹å°±ä¸ç”¨åŠ ()
function* genOne(x){
  const y = `è¿™æ˜¯ç¬¬ä¸€ä¸ª yield æ‰§è¡Œ:${yield x + 1}`;
 return y;
}
å¤åˆ¶ä»£ç 
```

#### æ‰§è¡Œ

```js
const g = gen(1);
//æ‰§è¡Œ Generator ä¼šè¿”å›ä¸€ä¸ªObject,è€Œä¸æ˜¯åƒæ™®é€šå‡½æ•°è¿”å›return åé¢çš„å€¼
g.next() // { value: 7, done: false }
//è°ƒç”¨æŒ‡é’ˆçš„ next æ–¹æ³•,ä¼šä»å‡½æ•°çš„å¤´éƒ¨æˆ–ä¸Šä¸€æ¬¡åœä¸‹æ¥çš„åœ°æ–¹å¼€å§‹æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ª yield è¡¨è¾¾å¼æˆ–returnè¯­å¥æš‚åœ,ä¹Ÿå°±æ˜¯æ‰§è¡Œyield è¿™ä¸€è¡Œ
// æ‰§è¡Œå®Œæˆä¼šè¿”å›ä¸€ä¸ª Object,
// value å°±æ˜¯æ‰§è¡Œ yield åé¢çš„å€¼,done è¡¨ç¤ºå‡½æ•°æ˜¯å¦æ‰§è¡Œå®Œæ¯•
g.next() // { value: undefined, done: true }
// å› ä¸ºæœ€åä¸€è¡Œ return y è¢«æ‰§è¡Œå®Œæˆ,æ‰€ä»¥done ä¸º true
å¤åˆ¶ä»£ç 
```

è°ƒç”¨ Generator å‡½æ•°åï¼Œè¯¥å‡½æ•°å¹¶ä¸æ‰§è¡Œï¼Œè¿”å›çš„ä¹Ÿä¸æ˜¯å‡½æ•°è¿è¡Œç»“æœï¼Œè€Œæ˜¯ä¸€ä¸ªæŒ‡å‘å†…éƒ¨çŠ¶æ€çš„æŒ‡é’ˆå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯`éå†å™¨å¯¹è±¡ï¼ˆIterator Objectï¼‰`ã€‚ä¸‹ä¸€æ­¥ï¼Œå¿…é¡»è°ƒç”¨éå†å™¨å¯¹è±¡çš„`next`æ–¹æ³•ï¼Œä½¿å¾—æŒ‡é’ˆç§»å‘ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚

æ‰€ä»¥ä¸Šé¢çš„å›è°ƒå‡½æ•°åˆå¯ä»¥å†™æˆè¿™æ ·ï¼š

```js
function *fetch() {
    yield ajax('aaa')
    yield ajax('bbb')
    yield ajax('ccc')
}
let gen = fetch()
let res1 = gen.next() // { value: 'aaa', done: false }
let res2 = gen.next() // { value: 'bbb', done: false }
let res3 = gen.next() // { value: 'ccc', done: false }
let res4 = gen.next() // { value: undefined, done: true } doneä¸ºtrueè¡¨ç¤ºæ‰§è¡Œç»“æŸ
å¤åˆ¶ä»£ç 
```

ç”±äº Generator å‡½æ•°è¿”å›çš„éå†å™¨å¯¹è±¡ï¼Œåªæœ‰è°ƒç”¨`next`æ–¹æ³•æ‰ä¼šéå†ä¸‹ä¸€ä¸ªå†…éƒ¨çŠ¶æ€ï¼Œæ‰€ä»¥å…¶å®æä¾›äº†ä¸€ç§å¯ä»¥æš‚åœæ‰§è¡Œçš„å‡½æ•°ã€‚`yield`è¡¨è¾¾å¼å°±æ˜¯æš‚åœæ ‡å¿—ã€‚

éå†å™¨å¯¹è±¡çš„`next`æ–¹æ³•çš„è¿è¡Œé€»è¾‘å¦‚ä¸‹ã€‚

ï¼ˆ1ï¼‰é‡åˆ°`yield`è¡¨è¾¾å¼ï¼Œå°±æš‚åœæ‰§è¡Œåé¢çš„æ“ä½œï¼Œå¹¶å°†ç´§è·Ÿåœ¨`yield`åé¢çš„é‚£ä¸ªè¡¨è¾¾å¼çš„å€¼ï¼Œä½œä¸ºè¿”å›çš„å¯¹è±¡çš„`value`å±æ€§å€¼ã€‚

ï¼ˆ2ï¼‰ä¸‹ä¸€æ¬¡è°ƒç”¨`next`æ–¹æ³•æ—¶ï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ª`yield`è¡¨è¾¾å¼ã€‚

ï¼ˆ3ï¼‰å¦‚æœæ²¡æœ‰å†é‡åˆ°æ–°çš„`yield`è¡¨è¾¾å¼ï¼Œå°±ä¸€ç›´è¿è¡Œåˆ°å‡½æ•°ç»“æŸï¼Œç›´åˆ°`return`è¯­å¥ä¸ºæ­¢ï¼Œå¹¶å°†`return`è¯­å¥åé¢çš„è¡¨è¾¾å¼çš„å€¼ï¼Œä½œä¸ºè¿”å›çš„å¯¹è±¡çš„`value`å±æ€§å€¼ã€‚

ï¼ˆ4ï¼‰å¦‚æœè¯¥å‡½æ•°æ²¡æœ‰`return`è¯­å¥ï¼Œåˆ™è¿”å›çš„å¯¹è±¡çš„`value`å±æ€§å€¼ä¸º`undefined`ã€‚

**`yield`è¡¨è¾¾å¼æœ¬èº«æ²¡æœ‰è¿”å›å€¼ï¼Œæˆ–è€…è¯´æ€»æ˜¯è¿”å›`undefined`ã€‚`next`æ–¹æ³•å¯ä»¥å¸¦ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°å°±ä¼šè¢«å½“ä½œä¸Šä¸€ä¸ª`yield`è¡¨è¾¾å¼çš„è¿”å›å€¼ã€‚**

æ€ä¹ˆç†è§£è¿™å¥è¯ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

```js
function* foo(x) {
  var y = 2 * (yield (x + 1));
  var z = yield (y / 3);
  return (x + y + z);
}

var a = foo(5);
a.next() // Object{value:6, done:false}
a.next() // Object{value:NaN, done:false}
a.next() // Object{value:NaN, done:true}

var b = foo(5);
b.next() // { value:6, done:false }
b.next(12) // { value:8, done:false }
b.next(13) // { value:42, done:true }
å¤åˆ¶ä»£ç 
```

ç”±äº`yield`æ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥ï¼ˆyieldï¼ˆx+1ï¼‰ï¼‰æ‰§è¡Œåçš„å€¼æ˜¯`undefined`ï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒæ¬¡æ‰§è¡Œ`a.next()`æ˜¯å…¶å®æ˜¯æ‰§è¡Œçš„`2*undefined`ï¼Œæ‰€ä»¥å€¼æ˜¯`NaN`ï¼Œæ‰€ä»¥ä¸‹é¢bçš„ä¾‹å­ä¸­ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œ`b.next()`æ—¶ä¼ å…¥äº†12ï¼Œå®ƒä¼šå½“æˆç¬¬ä¸€æ¬¡`b.next()`çš„æ‰§è¡Œè¿”å›å€¼ï¼Œæ‰€ä»¥bçš„ä¾‹å­ä¸­èƒ½å¤Ÿæ­£ç¡®è®¡ç®—ã€‚**è¿™é‡Œä¸èƒ½æŠŠnextæ‰§è¡Œç»“æœä¸­çš„valueå€¼ä¸yieldè¿”å›å€¼ææ··äº†ï¼Œå®ƒä¸¤ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿**

#### yieldä¸returnçš„åŒºåˆ«

ç›¸åŒç‚¹:

- éƒ½èƒ½è¿”å›è¯­å¥åé¢çš„é‚£ä¸ªè¡¨è¾¾å¼çš„å€¼
- éƒ½å¯ä»¥æš‚åœå‡½æ•°æ‰§è¡Œ

åŒºåˆ«:

- ä¸€ä¸ªå‡½æ•°å¯ä»¥æœ‰å¤šä¸ª yield,ä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ª return
- yield æœ‰ä½ç½®è®°å¿†åŠŸèƒ½,return æ²¡æœ‰

### 4.Async/await

`Async/await`å…¶å®å°±æ˜¯ä¸Šé¢`Generator`çš„è¯­æ³•ç³–ï¼Œ`async`å‡½æ•°å…¶å®å°±ç›¸å½“äº`funciton *`çš„ä½œç”¨ï¼Œè€Œ`await`å°±ç›¸å½“ä¸`yield`çš„ä½œç”¨ã€‚è€Œåœ¨`async/await`æœºåˆ¶ä¸­ï¼Œè‡ªåŠ¨åŒ…å«äº†æˆ‘ä»¬ä¸Šè¿°å°è£…å‡ºæ¥çš„`spawn`è‡ªåŠ¨æ‰§è¡Œå‡½æ•°ã€‚

æ‰€ä»¥ä¸Šé¢çš„å›è°ƒå‡½æ•°åˆå¯ä»¥å†™çš„æ›´åŠ ç®€æ´äº†ï¼š

```js
async function fetch() {
  	await ajax('aaa')
    await ajax('bbb')
    await ajax('ccc')
}
// ä½†è¿™æ˜¯åœ¨è¿™ä¸‰ä¸ªè¯·æ±‚æœ‰ç›¸äº’ä¾èµ–çš„å‰æä¸‹å¯ä»¥è¿™ä¹ˆå†™ï¼Œä¸ç„¶ä¼šäº§ç”Ÿæ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºä½ æ¯ä¸€ä¸ªè¯·æ±‚éƒ½éœ€è¦ç­‰å¾…ä¸Šä¸€æ¬¡è¯·æ±‚å®Œæˆåå†å‘èµ·è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰ç›¸äº’ä¾èµ–çš„æƒ…å†µä¸‹ï¼Œå»ºè®®è®©å®ƒä»¬åŒæ—¶å‘èµ·è¯·æ±‚ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨Promise.all()æ¥å¤„ç†
å¤åˆ¶ä»£ç 
```

`async`å‡½æ•°å¯¹`Generator`å‡½æ•°çš„æ”¹è¿›ï¼Œä½“ç°åœ¨ä»¥ä¸‹å››ç‚¹ï¼š

- å†…ç½®æ‰§è¡Œå™¨ï¼š`async`å‡½æ•°æ‰§è¡Œä¸æ™®é€šå‡½æ•°ä¸€æ ·ï¼Œä¸åƒ`Generator`å‡½æ•°ï¼Œéœ€è¦è°ƒç”¨`next`æ–¹æ³•ï¼Œæˆ–ä½¿ç”¨`co`æ¨¡å—æ‰èƒ½çœŸæ­£æ‰§è¡Œ
- è¯­æ„åŒ–æ›´æ¸…æ™°ï¼š`async`å’Œ`await`ï¼Œæ¯”èµ·æ˜Ÿå·å’Œ`yield`ï¼Œè¯­ä¹‰æ›´æ¸…æ¥šäº†ã€‚`async`è¡¨ç¤ºå‡½æ•°é‡Œæœ‰å¼‚æ­¥æ“ä½œï¼Œ`await`è¡¨ç¤ºç´§è·Ÿåœ¨åé¢çš„è¡¨è¾¾å¼éœ€è¦ç­‰å¾…ç»“æœã€‚
- é€‚ç”¨æ€§æ›´å¹¿ï¼š`co`æ¨¡å—çº¦å®šï¼Œ`yield`å‘½ä»¤åé¢åªèƒ½æ˜¯ Thunk å‡½æ•°æˆ– Promise å¯¹è±¡ï¼Œè€Œ`async`å‡½æ•°çš„`await`å‘½ä»¤åé¢ï¼Œå¯ä»¥æ˜¯ Promise å¯¹è±¡å’ŒåŸå§‹ç±»å‹çš„å€¼ï¼ˆæ•°å€¼ã€å­—ç¬¦ä¸²å’Œå¸ƒå°”å€¼ï¼Œä½†è¿™æ—¶ä¼šè‡ªåŠ¨è½¬æˆç«‹å³ resolved çš„ Promise å¯¹è±¡ï¼‰ã€‚
- è¿”å›å€¼æ˜¯Promiseï¼š`async`å‡½æ•°çš„è¿”å›å€¼æ˜¯ Promise å¯¹è±¡ï¼Œè¿™æ¯” Generator å‡½æ•°çš„è¿”å›å€¼æ˜¯ Iterator å¯¹è±¡æ–¹ä¾¿å¤šäº†ã€‚ä½ å¯ä»¥ç”¨`then`æ–¹æ³•æŒ‡å®šä¸‹ä¸€æ­¥çš„æ“ä½œã€‚

#### asyncå‡½æ•°

asyncå‡½æ•°çš„è¿”å›å€¼ä¸ºPromiseå¯¹è±¡ï¼Œæ‰€ä»¥å®ƒå¯ä»¥è°ƒç”¨thenæ–¹æ³•

```js
async function fn() {
  return 'async'
}
fn().then(res => {
  console.log(res) // 'async'
})
å¤åˆ¶ä»£ç 
```

#### awaitè¡¨è¾¾å¼

**await** å³ä¾§çš„è¡¨è¾¾å¼ä¸€èˆ¬ä¸º **promise** å¯¹è±¡, ä½†ä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒçš„å€¼

1. å¦‚æœè¡¨è¾¾å¼æ˜¯ promise å¯¹è±¡, await è¿”å›çš„æ˜¯ promise æˆåŠŸçš„å€¼
2. å¦‚æœè¡¨è¾¾å¼æ˜¯å…¶å®ƒå€¼, ç›´æ¥å°†æ­¤å€¼ä½œä¸º await çš„è¿”å›å€¼
3. awaitåé¢æ˜¯Promiseå¯¹è±¡ä¼šé˜»å¡åé¢çš„ä»£ç ï¼ŒPromise å¯¹è±¡ resolveï¼Œç„¶åå¾—åˆ° resolve çš„å€¼ï¼Œä½œä¸º await è¡¨è¾¾å¼çš„è¿ç®—ç»“æœ
4. æ‰€ä»¥è¿™å°±æ˜¯awaitå¿…é¡»ç”¨åœ¨asyncçš„åŸå› ï¼Œasyncåˆšå¥½è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå¯ä»¥å¼‚æ­¥æ‰§è¡Œé˜»å¡

```js
function fn() {
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            resolve(1000)
        }, 1000);
    })
}
function fn1() { return 'nanjiu' }
async function fn2() {
    // const value = await fn() // await å³ä¾§è¡¨è¾¾å¼ä¸ºPromiseï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯PromiseæˆåŠŸçš„value
    // const value = await 'å—ç–'
    const value = await fn1()
    console.log('value', value)
}
fn2() // value 'nanjiu'
å¤åˆ¶ä»£ç 
```

## å¼‚æ­¥æ–¹æ¡ˆæ¯”è¾ƒ

åä¸‰ç§æ–¹æ¡ˆéƒ½æ˜¯ä¸ºè§£å†³ä¼ ç»Ÿçš„å›è°ƒå‡½æ•°è€Œæå‡ºçš„ï¼Œæ‰€ä»¥å®ƒä»¬ç›¸å¯¹äºå›è°ƒå‡½æ•°çš„ä¼˜åŠ¿ä¸è¨€è€Œå–»ã€‚è€Œ`async/await`åˆæ˜¯`Generator`å‡½æ•°çš„è¯­æ³•ç³–ã€‚

- Promiseçš„å†…éƒ¨é”™è¯¯ä½¿ç”¨`try catch`æ•è·ä¸åˆ°ï¼Œåªèƒ½åªç”¨`then`çš„ç¬¬äºŒä¸ªå›è°ƒæˆ–`catch`æ¥æ•è·ï¼Œè€Œ`async/await`çš„é”™è¯¯å¯ä»¥ç”¨`try catch`æ•è·
- `Promise`ä¸€æ—¦æ–°å»ºå°±ä¼šç«‹å³æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡åé¢çš„ä»£ç ï¼Œè€Œ`async`å‡½æ•°ä¸­awaitåé¢æ˜¯Promiseå¯¹è±¡ä¼šé˜»å¡åé¢çš„ä»£ç ã€‚
- `async`å‡½æ•°ä¼šéšå¼åœ°è¿”å›ä¸€ä¸ª`promise`ï¼Œè¯¥`promise`çš„`reosolve`å€¼å°±æ˜¯å‡½æ•°returnçš„å€¼ã€‚
- ä½¿ç”¨`async`å‡½æ•°å¯ä»¥è®©ä»£ç æ›´åŠ ç®€æ´ï¼Œä¸éœ€è¦åƒ`Promise`ä¸€æ ·éœ€è¦è°ƒç”¨`then`æ–¹æ³•æ¥è·å–è¿”å›å€¼ï¼Œä¸éœ€è¦å†™åŒ¿åå‡½æ•°å¤„ç†`Promise`çš„resolveå€¼ï¼Œä¹Ÿä¸éœ€è¦å®šä¹‰å¤šä½™çš„dataå˜é‡ï¼Œè¿˜é¿å…äº†åµŒå¥—ä»£ç ã€‚

## è¯´äº†è¿™ä¹ˆå¤šï¼Œé¡ºä¾¿çœ‹ä¸ªé¢˜å§ï½

```js
console.log('script start')
async function async1() {
    await async2()
    console.log('async1 end')
}
async function async2() {
    console.log('async2 end')
}
async1()

setTimeout(function() {
    console.log('setTimeout')
}, 0)

new Promise(resolve => {
    console.log('Promise')
    resolve()
})
.then(function() {
    console.log('promise1')
})
.then(function() {
    console.log('promise2')
})
console.log('script end')
å¤åˆ¶ä»£ç 
```

**è§£æï¼š**

æ‰“å°é¡ºåºåº”è¯¥æ˜¯ï¼š` script start -> async2 end -> Promise -> script end -> async1 end -> promise1 -> promise2 -> setTimeout`

è€è§„çŸ©ï¼Œå…¨å±€ä»£ç è‡ªä¸Šè€Œä¸‹æ‰§è¡Œï¼Œå…ˆæ‰“å°å‡º`script start`ï¼Œç„¶åæ‰§è¡Œasync1(),é‡Œé¢å…ˆé‡åˆ°await async2(),æ‰§è¡Œasync2,æ‰“å°å‡º`async2 end`ï¼Œç„¶åawaitåé¢çš„ä»£ç æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¥ç€å¾€ä¸‹æ‰§è¡Œnew Promiseï¼Œæ‰“å°å‡º`Promise`,é‡è§äº†resolveï¼Œå°†ç¬¬ä¸€ä¸ªthenæ–¹æ³•æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¥ç€å¾€ä¸‹æ‰§è¡Œæ‰“å°å‡º`script end`ï¼Œå…¨å±€ä»£ç æ‰§è¡Œå®Œäº†ï¼Œç„¶åä»å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œï¼Œæ‰“å°å‡º`async1 end`,å†å–å‡ºç¬¬äºŒä¸ªå¾®ä»»åŠ¡æ‰§è¡Œï¼Œæ‰“å°å‡º`promise1`,ç„¶åè¿™ä¸ªthenæ–¹æ³•æ‰§è¡Œå®Œäº†ï¼Œå½“å‰Promiseçš„çŠ¶æ€ä¸º`fulfilled`,å®ƒä¹Ÿå¯ä»¥å‡ºå‘thençš„å›è°ƒï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªthenè¿™æ—¶å€™åˆè¢«åŠ è¿›äº†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åå†å‡ºå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºè¿™ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œï¼Œæ‰“å°å‡º`promise2`,æ­¤æ—¶å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¥ç€æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰“å°å‡º`setTimeout`ã€‚

**è§£é¢˜æŠ€å·§ï¼š**

- æ— è®ºæ˜¯thenè¿˜æ˜¯catché‡Œçš„å›è°ƒå†…å®¹åªè¦ä»£ç æ­£å¸¸æ‰§è¡Œæˆ–è€…æ­£å¸¸è¿”å›ï¼Œåˆ™å½“å‰æ–°çš„Promiseå®ä¾‹ä¸ºfulfilledçŠ¶æ€ã€‚å¦‚æœæœ‰æŠ¥é”™æˆ–è¿”å›Promise.reject()åˆ™æ–°çš„Promiseå®ä¾‹ä¸ºrejectedçŠ¶æ€ã€‚
- fulfilledçŠ¶æ€èƒ½å¤Ÿè§¦å‘thenå›è°ƒ
- rejectedçŠ¶æ€èƒ½å¤Ÿè§¦å‘catchå›è°ƒ
- æ‰§è¡Œasyncå‡½æ•°ï¼Œè¿”å›çš„æ˜¯Promiseå¯¹è±¡
- awaitç›¸å½“äºPromiseçš„thenå¹¶ä¸”åŒä¸€ä½œç”¨åŸŸä¸‹awaitä¸‹é¢çš„å†…å®¹å…¨éƒ¨ä½œä¸ºthenä¸­å›è°ƒçš„å†…å®¹
- å¼‚æ­¥ä¸­å…ˆæ‰§è¡Œå¾®ä»»åŠ¡ï¼Œå†æ‰§è¡Œå®ä»»åŠ¡

### å‡½æ•°é˜²æŠ–(debounce)

> åœ¨äº‹ä»¶è¢«è§¦å‘nç§’åå†æ‰§è¡Œå›è°ƒï¼Œå¦‚æœåœ¨è¿™nç§’å†…åˆè¢«è§¦å‘ï¼Œåˆ™é‡æ–°è®¡æ—¶ã€‚

çœ‹ä¸€ä¸ªğŸŒ°ï¼ˆæ —å­ï¼‰ï¼š

```stylus
//æ¨¡æ‹Ÿä¸€æ®µajaxè¯·æ±‚
function ajax(content) {
  console.log('ajax request ' + content)
}

let inputa = document.getElementById('unDebounce')

inputa.addEventListener('keyup', function (e) {
    ajax(e.target.value)
})
å¤åˆ¶ä»£ç 
```

çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š



![2018-09-04 09 23 46](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/4/165a252be5c94d6b~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åªè¦æŒ‰ä¸‹é”®ç›˜ï¼Œå°±ä¼šè§¦å‘è¿™æ¬¡ajaxè¯·æ±‚ã€‚ä¸ä»…ä»èµ„æºä¸Šæ¥è¯´æ˜¯å¾ˆæµªè´¹çš„è¡Œä¸ºï¼Œè€Œä¸”å®é™…åº”ç”¨ä¸­ï¼Œç”¨æˆ·ä¹Ÿæ˜¯è¾“å‡ºå®Œæ•´çš„å­—ç¬¦åï¼Œæ‰ä¼šè¯·æ±‚ã€‚ä¸‹é¢æˆ‘ä»¬ä¼˜åŒ–ä¸€ä¸‹ï¼š

```reasonml
//æ¨¡æ‹Ÿä¸€æ®µajaxè¯·æ±‚
function ajax(content) {
  console.log('ajax request ' + content)
}

function debounce(fun, delay) {
    return function (args) {
        let that = this
        let _args = args
        clearTimeout(fun.id)
        fun.id = setTimeout(function () {
            fun.call(that, _args)
        }, delay)
    }
}
    
let inputb = document.getElementById('debounce')

let debounceAjax = debounce(ajax, 500)

inputb.addEventListener('keyup', function (e) {
        debounceAjax(e.target.value)
    })å¤åˆ¶ä»£ç 
```

çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š



![2018-09-04 09 29 50](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/4/165a252b4b429b56~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åŠ å…¥äº†é˜²æŠ–ä»¥åï¼Œå½“ä½ åœ¨é¢‘ç¹çš„è¾“å…¥æ—¶ï¼Œå¹¶ä¸ä¼šå‘é€è¯·æ±‚ï¼Œåªæœ‰å½“ä½ åœ¨æŒ‡å®šé—´éš”å†…æ²¡æœ‰è¾“å…¥æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œå‡½æ•°ã€‚å¦‚æœåœæ­¢è¾“å…¥ä½†æ˜¯åœ¨æŒ‡å®šé—´éš”å†…åˆè¾“å…¥ï¼Œä¼šé‡æ–°è§¦å‘è®¡æ—¶ã€‚ å†çœ‹ä¸€ä¸ªğŸŒ°ï¼š

```reasonml
let biu = function () {
    console.log('biu biu biu',new Date().Format('HH:mm:ss'))
}

let boom = function () {
    console.log('boom boom boom',new Date().Format('HH:mm:ss'))
}


setInterval(debounce(biu,500),1000)
setInterval(debounce(boom,2000),1000)å¤åˆ¶ä»£ç 
```

çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š



![2018-09-04 09 32 21](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/4/165a252b4b809a23~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



è¿™ä¸ªğŸŒ°å°±å¾ˆå¥½çš„è§£é‡Šäº†ï¼Œå¦‚æœåœ¨æ—¶é—´é—´éš”å†…æ‰§è¡Œå‡½æ•°ï¼Œä¼šé‡æ–°è§¦å‘è®¡æ—¶ã€‚biuä¼šåœ¨ç¬¬ä¸€æ¬¡1.5sæ‰§è¡Œåï¼Œæ¯éš”1sæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œboomä¸€æ¬¡ä¹Ÿä¸ä¼šæ‰§è¡Œã€‚å› ä¸ºå®ƒçš„æ—¶é—´é—´éš”æ˜¯2sï¼Œè€Œæ‰§è¡Œæ—¶é—´æ˜¯1sï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½ä¼šé‡æ–°è§¦å‘è®¡æ—¶

> ### ä¸ªäººç†è§£ å‡½æ•°é˜²æŠ–å°±æ˜¯æ³•å¸ˆå‘æŠ€èƒ½çš„æ—¶å€™è¦è¯»æ¡ï¼ŒæŠ€èƒ½è¯»æ¡æ²¡å®Œå†æŒ‰æŠ€èƒ½å°±ä¼šé‡æ–°è¯»æ¡ã€‚

### å‡½æ•°èŠ‚æµ(throttle)

> è§„å®šåœ¨ä¸€ä¸ªå•ä½æ—¶é—´å†…ï¼Œåªèƒ½è§¦å‘ä¸€æ¬¡å‡½æ•°ã€‚å¦‚æœè¿™ä¸ªå•ä½æ—¶é—´å†…è§¦å‘å¤šæ¬¡å‡½æ•°ï¼Œåªæœ‰ä¸€æ¬¡ç”Ÿæ•ˆã€‚

çœ‹ä¸€ä¸ªğŸŒ°ï¼š

```reasonml
  function throttle(fun, delay) {
        let last, deferTimer
        return function (args) {
            let that = this
            let _args = arguments
            let now = +new Date()
            if (last && now < last + delay) {
                clearTimeout(deferTimer)
                deferTimer = setTimeout(function () {
                    last = now
                    fun.apply(that, _args)
                }, delay)
            }else {
                last = now
                fun.apply(that,_args)
            }
        }
    }

    let throttleAjax = throttle(ajax, 1000)

    let inputc = document.getElementById('throttle')
    inputc.addEventListener('keyup', function(e) {
        throttleAjax(e.target.value)
    })å¤åˆ¶ä»£ç 
```

çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š



![2018-09-04 09 36 49](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/4/165a252b4c1a9686~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ä¸æ–­è¾“å…¥æ—¶ï¼Œajaxä¼šæŒ‰ç…§æˆ‘ä»¬è®¾å®šçš„æ—¶é—´ï¼Œæ¯1sæ‰§è¡Œä¸€æ¬¡ã€‚

ç»“åˆåˆšåˆšbiubiubiuçš„ğŸŒ°ï¼š

```reasonml
    let biubiu = function () {
        console.log('biu biu biu', new Date().Format('HH:mm:ss'))
    }

    setInterval(throttle(biubiu,1000),10)
å¤åˆ¶ä»£ç 
```



![2018-09-04 09 37 58](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/4/165a252b46818296~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



ä¸ç®¡æˆ‘ä»¬è®¾å®šçš„æ‰§è¡Œæ—¶é—´é—´éš”å¤šå°ï¼Œæ€»æ˜¯1så†…åªæ‰§è¡Œä¸€æ¬¡ã€‚

> ### ä¸ªäººç†è§£ å‡½æ•°èŠ‚æµå°±æ˜¯fpsæ¸¸æˆçš„å°„é€Ÿï¼Œå°±ç®—ä¸€ç›´æŒ‰ç€é¼ æ ‡å°„å‡»ï¼Œä¹Ÿåªä¼šåœ¨è§„å®šå°„é€Ÿå†…å°„å‡ºå­å¼¹ã€‚

# æ€»ç»“

- å‡½æ•°é˜²æŠ–å’Œå‡½æ•°èŠ‚æµéƒ½æ˜¯é˜²æ­¢æŸä¸€æ—¶é—´é¢‘ç¹è§¦å‘ï¼Œä½†æ˜¯è¿™ä¸¤å…„å¼Ÿä¹‹é—´çš„åŸç†å´ä¸ä¸€æ ·ã€‚
- å‡½æ•°é˜²æŠ–æ˜¯æŸä¸€æ®µæ—¶é—´å†…åªæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œå‡½æ•°èŠ‚æµæ˜¯é—´éš”æ—¶é—´æ‰§è¡Œã€‚

### ç»“åˆåº”ç”¨åœºæ™¯

- debounce 
  - searchæœç´¢è”æƒ³ï¼Œç”¨æˆ·åœ¨ä¸æ–­è¾“å…¥å€¼æ—¶ï¼Œç”¨é˜²æŠ–æ¥èŠ‚çº¦è¯·æ±‚èµ„æºã€‚
  - windowè§¦å‘resizeçš„æ—¶å€™ï¼Œä¸æ–­çš„è°ƒæ•´æµè§ˆå™¨çª—å£å¤§å°ä¼šä¸æ–­çš„è§¦å‘è¿™ä¸ªäº‹ä»¶ï¼Œç”¨é˜²æŠ–æ¥è®©å…¶åªè§¦å‘ä¸€æ¬¡
- throttle 
  - é¼ æ ‡ä¸æ–­ç‚¹å‡»è§¦å‘ï¼Œmousedown(å•ä½æ—¶é—´å†…åªè§¦å‘ä¸€æ¬¡)
  - ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ¯”å¦‚æ˜¯å¦æ»‘åˆ°åº•éƒ¨è‡ªåŠ¨åŠ è½½æ›´å¤šï¼Œç”¨throttleæ¥åˆ¤æ–­

# æ‹“å±•

> å‚è€ƒé“¾æ¥ï¼š[www.cnblogs.com/zichi/p/533â€¦](https://link.juejin.cn?target=http%3A%2F%2Fwww.cnblogs.com%2Fzichi%2Fp%2F5331426.html)



![15343043539670](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/4/165a252b4c074274~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)



è¿™æ˜¯é«˜ç¨‹ä¸­çš„ç»å…¸ä»£ç ï¼š

```reasonml
    function throttle(method, context) {
        clearTimeout(method.tId);
        method.tId = setTimeout(function () {
            method.call(context);
        }, 100)
    }
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬é€šè¿‡ä¸Šé¢çš„ä¾‹å­çŸ¥é“ï¼Œå…¶å®è¿™æ®µå‡½æ•°åº”è¯¥æ˜¯debounceå‡½æ•°é˜²æŠ–ï¼Œè€Œä¸æ˜¯å‡½æ•°èŠ‚æµï¼Œå¾ˆå¤šæ–‡ç« ä¹Ÿéƒ½ä¼šæ‹¿è¿™æ®µä»£ç æ¥åšä¾‹å­ï¼Œå‡½æ•°æœ¬èº«æ²¡é”™ï¼Œä½†æ˜¯å‘½åé”™äº†ã€‚

åŸä½œè€…çš„è¿™æ®µè¯å°±å†™çš„å¾ˆå¥½ï¼Œ

> å°±ä»¥ throttle ä¸ºä¾‹ï¼ŒæŸæ—¥ï¼Œè€å¸ˆç»™ä½ å¸ƒç½®äº†ä¸€ä¸ªä½œä¸šï¼Œè®©ä½ æ·±å…¥ç†è§£ä¸€ä¸‹ throttleï¼Œç¬¬äºŒå¤©ä¸Šè¯¾æ¥èŠèŠã€‚å¼ ä¸‰å¿ƒé‡Œéå¸¸é«˜å…´ï¼Œè¿™ä¸ªæ¦‚å¿µåœ¨ç»å…¸ä¹¦ç±ã€ŠJavaScripté«˜çº§ç¨‹åºè®¾è®¡ã€‹ä¸­è§è¿‡ï¼Œæ‰“å¼€ä¸€çœ‹ï¼Œå°±ä¸¤é¡µï¼Œè€Œä¸”è§£é‡Šåœ°éå¸¸æ¸…æ™°ï¼Œçœ‹å®Œå°±é«˜å…´åœ°å¹²åˆ«çš„äº‹æƒ…å»äº†ã€‚è€Œæå››ï¼Œè§‰å¾—é«˜ç¨‹ä¸‰è®²çš„æœ‰ç‚¹å°‘ï¼Œè€Œå»è°·æ­Œäº†ä¸‹å…¶ä»–å…³äº throttle çš„çŸ¥è¯†ç‚¹ï¼Œå…´å¥‹åœ°çœ‹åˆ° throttle å‡½æ•°çš„å¥½å‡ ç§å†™æ³•ï¼Œå‘ç°é«˜ç¨‹ä¸‰åªæ˜¯ç”¨äº†æœ€ç®€å•çš„æ–¹å¼ï¼Œè¿˜æœ‰æ›´ä¼˜é›…è¿ç”¨åœºæ™¯æ›´å¤šçš„å†™æ³•ï¼Œæˆ–è®¸æ­¤æ—¶ä»–å·²ç»å‘ç°å’Œ throttle åŒæ—¶å‡ºç°çš„è¿˜æœ‰ä¸ª debounceï¼Œè¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿåæ­£è€å¸ˆæ²¡è¯´ï¼Œä»¥åå†çœ‹å§ï¼Œäºæ˜¯å¿ƒæ»¡æ„è¶³åœ°ç©æ¸¸æˆå»äº†ã€‚è€Œç‹äº”ï¼Œå’Œæå››ä¸€æ ·å‘ç°äº† debounceï¼Œè¿™æ˜¯ä»€ä¹ˆï¼Ÿä¸€èµ·äº†è§£äº†å§ï¼Œç»§è€Œå‘ç° debounce çš„ç”¨æ³•å±…ç„¶å’Œé«˜ç¨‹ä¸‰ä¸­çš„ throttle ä¸€æ ·ï¼ç»§ç»­æŒ–ä¸‹å»ï¼Œå‘ç°é«˜ç¨‹ä¸‰ä¸­çš„ throttle å‡½æ•°å…¶å®åº”è¯¥å« debounceï¼Œçœ‹åˆ°æœ€åï¼Œç‹äº”å·²ç»æŠŠ throttle å’Œ debounce å½»åº•ç†è§£äº†ã€‚

æˆ‘ä»¬è¦åšç‹äº”ï¼Œå¹¶ä¸”äº‰å–æ—©æ—¥äº§å‡ºä¸€æ‰‹çŸ¥è¯†ï¼åŠ æ²¹ï¼

## é˜²æŠ–ï¼ˆdebounceï¼‰

å¦‚æœç”¨æˆ·å¤šæ¬¡é¢‘ç¹æ“ä½œä»¥æœ€åä¸€æ¬¡ä¸ºå‡†ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä»¥ç¬¬ä¸€æ¬¡ä¸ºå‡†ï¼Œè¿›è¡Œæ•°æ®æ›´æ–°æˆ–è€…ç½‘ç»œèµ„æºè¯·æ±‚ï¼Œä»¥æ¶ˆé™¤å†—ä½™çš„æ“ä½œï¼Œæˆ–è€…å‡å°‘ä¸€å®šçš„è¯·æ±‚èµ„æºæµªè´¹ã€‚

### ç¤ºä¾‹ä»£ç 

```javascript
function debounce (fn, delay = 300){
    let timer = null
    return function (...args) {
        clearTimeout(timer)
        timer = setTimeout(()=>{
            fn.call(this, ...args)
        }, delay);
    }
}
å¤åˆ¶ä»£ç 
```

### ä½¿ç”¨

```javascript
debounce(()=> count += 1, 1000)
å¤åˆ¶ä»£ç 
```

## èŠ‚æµï¼ˆthrottle ï¼‰

åœ¨ä¸€å®šæ—¶é—´èŒƒå›´å†…ï¼Œç”¨æˆ·è§¦å‘å¤šæ¬¡åªä¼šæ‰§è¡Œä¸€æ¬¡ä»¥è¾¾åˆ°é˜²æ­¢ç”¨æˆ·é¢‘ç¹æ“ä½œçš„ç›®çš„ã€‚

### ç¤ºä¾‹ä»£ç 

```javascript
let timer = null
function throttle (fn, delay = 300) {
    if(timer == null){
        timer = setTimeout(() => {
            fn()

            clearTimeout(timer)
            timer = null
        }, delay);
    }
}
å¤åˆ¶ä»£ç 
```

### ä½¿ç”¨

```javascript
throttle(()=> count += 1, 1000)
å¤åˆ¶ä»£ç 
```

# ç¯å¢ƒè¯´æ˜

- vue 3
- vite

# æ–°å°è£…

è¿™é‡Œæˆ‘åˆ†ä¸¤ä¸ªæ¨¡å—æ¥è®²è¿°ã€‚ä¸€ä¸ªæ˜¯é˜²æŠ–ï¼›å¦ä¸€ä¸ªæ˜¯èŠ‚æµã€‚

è™½ç„¶è¿™ä¸¤ä¸ªå·®åˆ«ä¸æ˜¯å¾ˆå¤§ï¼Œä½†è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚ä¸Šè½¦ï¼Œå…„å¼Ÿä»¬ã€‚ğŸš—ğŸš—ğŸš—

## é˜²æŠ–ï¼ˆdebounceï¼‰

å…ˆçœ‹å¸¸è§å°è£…å†…å®¹ã€‚

### å¸¸è§å°è£…-1

#### ä»£ç 

```javascript
function debounce (fn, delay = 300){
    let timer = null
    return function (...args) {
        if(timer != null){
            clearTimeout(timer)
            timer = null
        }
        timer = setTimeout(()=>{
            fn.call(this, ...args)
        }, delay);
    }
}
å¤åˆ¶ä»£ç 
```

#### ä½¿ç”¨

```javascript
const addCount = debounce(()=> count.value += 1, 1000)
å¤åˆ¶ä»£ç 
```

### å¸¸è§å°è£…-2

#### ä»£ç 

```javascript
let timer = null
function debounce (fn, delay = 1000){
    if(timer != null){
        clearTimeout(timer)
        timer = null
    }
    timer = setTimeout(fn, delay)
}
å¤åˆ¶ä»£ç 
```

#### ä½¿ç”¨

```javascript
const addCount = () => debounce(()=> count.value += 1, 1000)
å¤åˆ¶ä»£ç 
```

### æ–°å°è£…

è¿™é‡Œæˆ‘ä»¬éœ€è¦å€ŸåŠ© `vue 3` ä¸­çš„ `customRef` æ¥å®ç°æˆ‘ä»¬çš„æ–°æ–¹å¼ã€‚è¿™é‡Œæˆ‘å°±ä¸å…·ä½“å†™äº†ã€‚æˆ‘ç›´æ¥åœ¨æ¯è¡Œä»£ç ä¸Šé¢æ·»åŠ æ³¨é‡Šã€‚æˆ‘ç›¸ä¿¡æœ‹å‹ä½ æ˜¯èƒ½çœ‹æ‡‚çš„ã€‚ğŸŒ¹ğŸŒ¹ğŸŒ¹

#### ä»£ç 

```javascript
// ä» vue ä¸­å¼•å…¥ customRef å’Œ ref
import { customRef, ref } from "vue"

// data ä¸ºåˆ›å»ºæ—¶çš„æ•°æ®
// delay ä¸ºé˜²æŠ–æ—¶é—´
function debounceRef (data, delay = 300){
    // åˆ›å»ºå®šæ—¶å™¨
    let timer = null;
    // å¯¹ delay è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¼ é€’çš„æ˜¯ null åˆ™ä¸éœ€è¦ä½¿ç”¨ é˜²æŠ–æ–¹æ¡ˆï¼Œç›´æ¥è¿”å›ä½¿ç”¨ ref åˆ›å»ºçš„ã€‚
    return delay == null 
        ? 
        // è¿”å› ref åˆ›å»ºçš„
        ref(data)
        : 
        // customRef ä¸­ä¼šè¿”å›ä¸¤ä¸ªå‡½æ•°å‚æ•°ã€‚ä¸€ä¸ªæ˜¯ï¼štrack åœ¨è·å–æ•°æ®æ—¶æ”¶é›†ä¾èµ–çš„ï¼›ä¸€ä¸ªæ˜¯ï¼štrigger åœ¨ä¿®æ”¹æ•°æ®æ—¶è¿›è¡Œé€šçŸ¥æ´¾å‘æ›´æ–°çš„ã€‚
        customRef((track, trigger) => {
            return {
                get () {
                    // æ”¶é›†ä¾èµ–
                    track()
                    // è¿”å›å½“å‰æ•°æ®çš„å€¼
                    return data
                },
                set (value) {
                    // æ¸…é™¤å®šæ—¶å™¨
                    if(timer != null){
                        clearTimeout(timer)
                        timer = null
                    }
                    // åˆ›å»ºå®šæ—¶å™¨
                    timer = setTimeout(() => {
                        // ä¿®æ”¹æ•°æ®
                        data = value;
                        // æ´¾å‘æ›´æ–°
                        trigger()
                    }, delay)
                }
            }
        })
}
å¤åˆ¶ä»£ç 
```

#### ä½¿ç”¨

```javascript
// åˆ›å»º
const count = debounceRef(0, 300)

// å‡½æ•°ä¸­ä½¿ç”¨
const addCount = () => {
  count.value += 1
}

// v-model ä¸­ä½¿ç”¨
<input type="text" v-model="count">

å¤åˆ¶ä»£ç 
```

## èŠ‚æµï¼ˆthrottleï¼‰

æˆ‘ä»¬è¿˜æ˜¯ä¸€æ ·ï¼Œå…ˆçœ‹å¸¸è§å°è£…å†…å®¹ã€‚

### å¸¸è§å°è£…-1

#### ä»£ç 

```javascript
let timer = null
function throttle (fn, delay = 300) {
    if(timer == null){
        timer = setTimeout(() => {
            fn()

            clearTimeout(timer)
            timer = null
        }, delay);
    }
}
å¤åˆ¶ä»£ç 
```

#### ä½¿ç”¨

```javascript
const addCount = () => throttle(()=> count.value += 1, 1000)
å¤åˆ¶ä»£ç 
```

### å¸¸è§å°è£…-2

#### ä»£ç 

```javascript
function throttle (fn, delay = 300) {
    let timer = null
    return function (...args) {
        if(timer == null){
            timer = setTimeout(() => {
                fn.call(this, ...args)
    
                clearTimeout(timer)
                timer = null
            }, delay);
        }
    }
}
å¤åˆ¶ä»£ç 
```

#### ä½¿ç”¨

```javascript
const addCount = throttle(()=> count.value += 1, 1000)
å¤åˆ¶ä»£ç 
```

### æ–°å°è£…

èŠ‚æµå’Œé˜²æŠ–åœ¨å°è£…å’Œä½¿ç”¨ä¸Šå¤§åŒå°å¼‚ã€‚

#### ä»£ç 

```javascript
// data ä¸ºåˆ›å»ºæ—¶çš„æ•°æ®
// delay ä¸ºèŠ‚æµæ—¶é—´
function throttleRef (data, delay = 300){
    // åˆ›å»ºå®šæ—¶å™¨
    let timer = null;
    // å¯¹ delay è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¼ é€’çš„æ˜¯ null åˆ™ä¸éœ€è¦ä½¿ç”¨ èŠ‚æµæ–¹æ¡ˆï¼Œç›´æ¥è¿”å›ä½¿ç”¨ ref åˆ›å»ºçš„ã€‚
    return delay == null 
        ? 
        // è¿”å› ref åˆ›å»ºçš„
        ref(data)
        : 
        // customRef ä¸­ä¼šè¿”å›ä¸¤ä¸ªå‡½æ•°å‚æ•°ã€‚ä¸€ä¸ªæ˜¯ï¼štrack åœ¨è·å–æ•°æ®æ—¶æ”¶é›†ä¾èµ–çš„ï¼›ä¸€ä¸ªæ˜¯ï¼štrigger åœ¨ä¿®æ”¹æ•°æ®æ—¶è¿›è¡Œé€šçŸ¥æ´¾å‘æ›´æ–°çš„ã€‚
        customRef((track, trigger) => {
            return {
                get () {
                    // æ”¶é›†ä¾èµ–
                    track()
                    // è¿”å›å½“å‰æ•°æ®çš„å€¼
                    return data
                },
                set (value) {
                    // åˆ¤æ–­
                    if(timer == null){
                        // åˆ›å»ºå®šæ—¶å™¨
                        timer = setTimeout(() => {
                            // ä¿®æ”¹æ•°æ®
                            data = value;
                            // æ´¾å‘æ›´æ–°
                            trigger()
                            // æ¸…é™¤å®šæ—¶å™¨
                            clearTimeout(timer)
                            timer = null
                        }, delay)
                    }
                    
                }
            }
        })
}
å¤åˆ¶ä»£ç 
```

#### ä½¿ç”¨

```javascript
// åˆ›å»º
const count = debounceRef(0, 300)

// å‡½æ•°ä¸­ä½¿ç”¨
const addCount = () => {
  count.value += 1
}

// v-model ä¸­ä½¿ç”¨
<input type="text" v-model="count">

å¤åˆ¶ä»£ç 
```

# æ€»ç»“

ä»¥ä¸Šä¾¿æ˜¯`Vue 3 ä¸­çš„æè‡´é˜²æŠ–/èŠ‚æµï¼ˆå«å¸¸è§æ–¹å¼é˜²æŠ–/èŠ‚æµï¼‰`è¿™ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹ï¼Œå¦‚æœ‰ä¸è¶³æˆ–æœ‹å‹ä½ æœ‰æ›´å¥½çš„æ–¹å¼æˆ–è€…å…¶ä»–ç‹¬åˆ°çš„è§è§£ï¼Œæ¬¢è¿è¯„è®º + ç§ä¿¡ã€‚

å½“ç„¶æœ‹å‹ä½ åˆå­¦åˆ°äº†ä¸€æ‹›å¯ä»¥ç‚¹èµ + å…³æ³¨ + è¯„è®ºå“¦ã€‚

å¸Œæœ›æœ¬ç¯‡æ–‡ç« å¯¹æ­£åœ¨é˜…è¯»çš„æœ‹å‹ä½ æœ‰æ‰€å¸®åŠ©ã€‚

## èµ·æº

é¢è¯•å®˜ï¼šâ€œçŸ¥é“é˜²æŠ–å’ŒèŠ‚æµå—ï¼Œç®€å•åœ°è¯´è¯´ã€‚â€

æ­¤æ—¶æˆ‘å¿ƒä¸­çªƒå–œï¼Œè¿™ä¹ˆç®€å•ï¼Œæœ‰æ‰‹å°±è¡Œã€‚ç„¶åå°±å¼€å§‹ä»‹ç»èµ·é˜²æŠ–èŠ‚æµçš„çŸ¥è¯†ç‚¹ã€‚

æˆ‘ï¼šâ€œé˜²æŠ–æ˜¯....ï¼Œç„¶åèŠ‚æµæ˜¯....ï¼Œå®ƒä»¬çš„åº”ç”¨åœºæ™¯åœ¨....â€

èƒ½è¯´çš„ä¸œè¥¿éƒ½è¯´åˆ°äº†ï¼Œèƒ½è¦†ç›–çš„çŸ¥è¯†ç‚¹éƒ½è¦†ç›–åˆ°äº†ï¼Œç»“æœé¢è¯•å®˜æ¥ä¸€å¥ï¼šâ€œå—¯å—¯å¥½ï¼Œç»™æˆ‘æ‰‹å†™ä¸€ä¸‹é˜²æŠ–èŠ‚æµã€‚â€

è¿™ä¸€åˆ»æˆ‘æ„£ä½äº†ï¼šâ€œè®©æˆ‘æ‰‹å†™è¿™ä¸¤ä¸ª....ï¼Œæˆ‘ä¸ä¼šå‘€....â€

æœ€åç»“æœå¯æƒ³è€ŒçŸ¥ã€‚

äºæ˜¯ä¹ï¼Œæˆ‘ä¾¿é‡æ•´æ——é¼“ï¼Œæ¥é¢å¯¹è¿™ä¸¤åº§å¯¹æˆ‘ä¹‹å‰è€Œè¨€çš„å¤§å±± â€” é˜²æŠ–å’ŒèŠ‚æµã€‚

## é˜²æŠ–

é¡¾åæ€ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†é˜²æŠ–ç†è§£ä¸ºæ˜¯é˜²æ­¢æŠ–åŠ¨ã€‚å½“æˆ‘ä»¬åœ¨é¢‘ç¹åœ°è§¦å‘ä¸€ä¸ªäº‹ä»¶æ—¶ï¼Œä¼šå¼•èµ·ä¸å¿…è¦çš„æ€§èƒ½æŸå¤±ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦åšçš„æ˜¯è®©äº‹ä»¶åœ¨åœæ­¢è§¦å‘åå†è§¦å‘ï¼Œä»¥æ­¤å‡å°‘æ€§èƒ½æŸå¤±ã€‚

é˜²æŠ–å°±æ˜¯è¦å»¶è¿Ÿæ‰§è¡Œï¼Œæˆ‘ä»¬ä¸€ç›´æ“ä½œè§¦å‘äº‹ä»¶å¹¶ä¸”ä¸æ‰§è¡Œï¼Œåªæœ‰å½“åœæ­¢æ“ä½œåç­‰æ‰ä¼šæ‰§è¡Œã€‚

**é˜²æŠ–å‡½æ•°**çš„ä½œç”¨æ˜¯æ§åˆ¶å‡½æ•°åœ¨ä¸€å®šæ—¶é—´å†…çš„æ‰§è¡Œæ¬¡æ•°ã€‚ç®€å•ç‚¹è¯´å°±æ˜¯é€šè¿‡é˜²æŠ–å‡½æ•°è®©æŸä¸ªè§¦å‘äº‹ä»¶åœ¨ `n` ç§’å†…åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚

## èŠ‚æµ

èŠ‚æµæ˜¯æŒ‡ç»‘å®šäº‹ä»¶åï¼Œé€šè¿‡åŠ¨ä½œè§¦å‘äº‹ä»¶ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå¦‚æœåŠ¨ä½œåˆå‘ç”Ÿï¼Œå¿½ç•¥è¯¥åŠ¨ä½œï¼Œä¸€ç›´åˆ°äº‹ä»¶æ‰§è¡Œå®Œåæ‰èƒ½é‡æ–°è§¦å‘ã€‚é€šä¿—çš„è¯´å°±æ˜¯æ§åˆ¶é«˜é¢‘æ‰§è¡Œçš„æ¬¡æ•°ã€‚

**èŠ‚æµå‡½æ•°**çš„ä½œç”¨æ˜¯åœ¨ä¸€ä¸ªå•ä½æ—¶é—´å†…æœ€å¤šåªèƒ½è§¦å‘ä¸€æ¬¡å‡½æ•°æ‰§è¡Œï¼Œå¦‚æœè¿™ä¸ªå•ä½æ—¶é—´å†…å¤šæ¬¡è§¦å‘å‡½æ•°ï¼Œåªèƒ½æœ‰ä¸€æ¬¡ç”Ÿæ•ˆã€‚

## åº”ç”¨åœºæ™¯

å¯èƒ½è¿™æ ·æè¿°å¯¹åˆšæ¥è§¦é˜²æŠ–èŠ‚æµçš„å°ä¼™ä¼´æ¥è¯´ä¼šæœ‰äº›ä¸å¥½å®Œå…¨ç†è§£ï¼Œæ¥ä¸‹æ¥é€šè¿‡åˆ†æä¸€ä¸‹å®ƒä»¬çš„åº”ç”¨åœºæ™¯æ¥æ·±åŒ–å®ƒä»¬çš„æ¦‚å¿µã€‚

### é˜²æŠ–åº”ç”¨åœºæ™¯

é˜²æŠ–é€‚åˆå¤šæ¬¡äº‹ä»¶ä¸€æ¬¡å“åº”çš„æƒ…å†µã€‚

æ¯”è¾ƒå…¸å‹çš„æœ‰æœç´¢äº‹ä»¶ï¼Œç”¨æˆ·åœ¨ä¸æ–­è¾“å…¥å€¼æ—¶ï¼Œç”¨é˜²æŠ–æ¥èŠ‚çº¦è¯·æ±‚èµ„æºï¼Œåªæœ‰æœ€åä¸€æ¬¡å›è½¦æ‰èƒ½è¿”å›ç»“æœã€‚è¿˜æœ‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼Œä¸ºäº†é˜²æ­¢ç”¨æˆ·å¤šæ¬¡é‡å¤æäº¤ä¹Ÿä¼šä½¿ç”¨é˜²æŠ–å‡½æ•°ã€‚æœ€åå°±æ˜¯éƒ¨åˆ†çš„ç”µè¯å·ç è¾“å…¥çš„éªŒè¯ï¼Œè¦ç­‰åœæ­¢è¾“å…¥åæ‰ä¼šè¿›è¡Œä¸€æ¬¡éªŒè¯ã€‚

### èŠ‚æµåº”ç”¨åœºæ™¯

èŠ‚æµé€‚åˆå¤§é‡äº‹ä»¶æŒ‰æ—¶é—´åšå¹³å‡åˆ†é…è§¦å‘ã€‚

æ¯”è¾ƒå…¸å‹çš„æœ‰ç›‘å¬æ»šåŠ¨æˆ– `resize` äº‹ä»¶ï¼Œæ¯”å¦‚æ˜¯å¦æ»‘åˆ°åº•éƒ¨è‡ªåŠ¨åŠ è½½æ›´å¤šï¼Œè°ƒæ•´çª—å£å¤§å°ã€‚å¦å¤–è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯åƒæ˜é‡‘å†™æ–‡ç« è¿™é‡Œä¸€æ ·ï¼Œæœ‰è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¸€è¾¹å†™ï¼Œå®ƒå¯ä»¥ä¸€è¾¹ä¿å­˜ã€‚å‰©ä¸‹å°±æ¯”å¦‚è¯´ `DOM` å…ƒç´ æ‹–æ‹½ï¼Œä»¥åŠæ¸¸æˆä¸­çš„åˆ·æ–°ç‡éƒ½æ˜¯ä¼šä½¿ç”¨åˆ°èŠ‚æµå‡½æ•°çš„ã€‚

## æ‰‹å†™é˜²æŠ–èŠ‚æµ

ä»‹ç»äº†å®ƒä»¬çš„ç†è®ºåŸºç¡€çŸ¥è¯†å’Œåº”ç”¨åœºæ™¯åï¼Œç°åœ¨æ¥æ‰‹å†™ä¸€ä¸‹å®ƒä»¬å§ã€‚

```javascript
// é˜²æŠ–ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
function debounce(fn, delay) {
    let timer = null;
    clearTimeout(timer); // ä¸‹æ¬¡è°ƒç”¨æ—¶ä¼šæ¸…é™¤ä¸Šæ¬¡çš„timerï¼Œ ç„¶åé‡æ–°å»¶è¿Ÿ
    timer = setTimeout(function(){
        fn();
    }, delay);
} 

// é˜²æŠ–ï¼ˆç«‹å³æ‰§è¡Œç‰ˆæœ¬ï¼‰
function debounce(fn, wait) {
    let timer = null
    return function () {
        let args = arguments
        let now = !timer
        timer && clearTimeout(timer)
        timer = setTimeout(() => {
            timer = null
        }, wait)
        if (now) {
            fn.apply(this, args)
        }
    }
}

// èŠ‚æµï¼ˆå®šæ—¶å™¨ç‰ˆæœ¬ï¼‰
function throttle(fn, wait) {
    let timer = null
    return function () {
        let context = this
        let args = arguments
        if (!timer) {
            timer = setTimeout(() => {
                timer = null
                fn.apply(context, args)
            }, wait)
        }
    }
}
å¤åˆ¶ä»£ç 
```

é˜²æŠ–å’ŒèŠ‚æµçš„æ ¸å¿ƒå°±æ˜¯å®šæ—¶å™¨ï¼Œé€šè¿‡é…åˆå®šæ—¶å™¨æ¥å®Œæˆé˜²æŠ–èŠ‚æµå‡½æ•°çš„æ‰‹å†™æ˜¯å¾ˆå¸¸è§çš„æ–¹å¼ã€‚è¿™é‡Œé™„ä¸Šé˜²æŠ–å‡½æ•°çš„ä¸¤ç§å†™æ³•ä»¥åŠèŠ‚æµå‡½æ•°çš„ä¸€ç§å†™æ³•ï¼Œéƒ½å¯ä»¥å‚è€ƒç ”ç©¶ã€‚

## æ€»ç»“

**é˜²æŠ–å’ŒèŠ‚æµèƒ½æœ‰æ•ˆå‡å°‘æµè§ˆå™¨å¼•æ“çš„æŸè€—ï¼Œé˜²æ­¢å‡ºç°é¡µé¢å µå¡å¡é¡¿ç°è±¡ï¼Œéœ€è¦ç†Ÿç»ƒæŒæ¡ã€‚** é˜²æŠ–å’ŒèŠ‚æµå­¦ä¹ å®Œåï¼Œè¿˜æœ‰å…¶ä»–çš„æ‰‹å†™é¢˜ç­‰ç€æˆ‘ï¼Œæ¥ä¸‹æ¥æ…¢æ…¢å»å­¦å¹¶è®°å½•ä¸‹æ¥ã€‚

## é˜²æŠ–

é˜²æŠ–æ˜¯æŒ‡åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œå¤šæ¬¡è§¦å‘åŒä¸€äº‹ä»¶ï¼Œåªæ‰§è¡Œæœ€åä¸€æ¬¡ï¼Œæˆ–è€…åªåœ¨å¼€å§‹æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚é˜²æŠ–çš„åº”ç”¨åœºæ™¯æ¯”è¾ƒå¹¿æ³›ï¼Œä¾‹å¦‚åœ¨ç”¨æˆ·è¾“å…¥æœç´¢å…³é”®è¯æ—¶ï¼Œå¯ä»¥ä½¿ç”¨é˜²æŠ–æ¥é¿å…é¢‘ç¹åœ°å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„é˜²æŠ–å®ç°ä»£ç ï¼š

```js
/**
 * é˜²æŠ–å‡½æ•°
 * @param {Function} fn - éœ€è¦æ‰§è¡Œçš„å‡½æ•°
 * @param {Number} delay - æ—¶é—´å»¶è¿Ÿå‚æ•°
 * @return {Function} è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°
 */
function debounce(fn, delay) {
  // å®šä¹‰ä¸€ä¸ªå˜é‡æ¥ä¿å­˜å®šæ—¶å™¨çš„è¿”å›å€¼
  let timer = null;
  // è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°
  return function() {
    // ä¿å­˜å‡½æ•°æ‰§è¡Œæ—¶çš„å‚æ•°
    const args = arguments;
    // å¦‚æœå·²ç»å­˜åœ¨å®šæ—¶å™¨ï¼Œåˆ™æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (timer) clearTimeout(timer);
    // åˆ›å»ºä¸€ä¸ªæ–°çš„å®šæ—¶å™¨
    timer = setTimeout(() => {
      // åœ¨å»¶è¿Ÿç»“æŸåæ‰§è¡Œä¼ å…¥çš„å‡½æ•°ï¼Œå¹¶ä¼ å…¥ä¹‹å‰ä¿å­˜çš„å‚æ•°
      fn.apply(this, args);
    }, delay);
  }
}

å¤åˆ¶ä»£ç 
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `debounce` å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•° `fn` å’Œä¸€ä¸ªæ—¶é—´å»¶è¿Ÿå‚æ•° `delay`ã€‚è¿”å›ä¸€ä¸ªæ–°å‡½æ•°ï¼Œåœ¨è¿™ä¸ªæ–°å‡½æ•°ä¸­ä½¿ç”¨äº†é—­åŒ…ä¿å­˜äº†åŸå‡½æ•°çš„ `this` æŒ‡å‘å’Œ `arguments` å¯¹è±¡ï¼Œä»¥ç¡®ä¿åŸå‡½æ•°åœ¨æ‰§è¡Œæ—¶èƒ½å¤Ÿæ­£ç¡®åœ°è®¿é—®åˆ°å®ƒä»¬ã€‚åœ¨å»¶è¿Ÿç»“æŸåæ‰§è¡ŒåŸå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ `apply` æ–¹æ³•å°†ä¿å­˜çš„ `this` æŒ‡å‘ä¼ é€’ç»™åŸå‡½æ•°ï¼Œä»¥ç¡®ä¿å®ƒèƒ½å¤Ÿæ­£ç¡®åœ°è®¿é—®åˆ°å…¶æ‰€åœ¨çš„å¯¹è±¡ã€‚

## èŠ‚æµ

èŠ‚æµæ˜¯æŒ‡åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œå¤šæ¬¡è§¦å‘åŒä¸€äº‹ä»¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚èŠ‚æµçš„åº”ç”¨åœºæ™¯ä¹Ÿæ¯”è¾ƒå¹¿æ³›ï¼Œä¾‹å¦‚åœ¨ç”¨æˆ·æ»šåŠ¨é¡µé¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨èŠ‚æµæ¥é¿å…é¢‘ç¹åœ°è§¦å‘å‡½æ•°ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„èŠ‚æµå®ç°ä»£ç ï¼š

```js
/**
 * èŠ‚æµå‡½æ•°
 * @param {Function} fn - éœ€è¦æ‰§è¡Œçš„å‡½æ•°
 * @param {Number} delay - æ—¶é—´å»¶è¿Ÿå‚æ•°
 * @return {Function} è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°
 */
function throttle(fn, delay) {
  // å®šä¹‰ä¸€ä¸ªå˜é‡æ¥ä¿å­˜å®šæ—¶å™¨çš„è¿”å›å€¼
  let timer = null;
  // è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°
  return function() {
    // ä¿å­˜å‡½æ•°æ‰§è¡Œæ—¶çš„å‚æ•°
    const args = arguments;
    // å¦‚æœå·²ç»å­˜åœ¨å®šæ—¶å™¨ï¼Œåˆ™ç›´æ¥è¿”å›
    if (timer) return;
    // åˆ›å»ºä¸€ä¸ªæ–°çš„å®šæ—¶å™¨
    //fn.apply(this, args); //åœ¨å»¶è¿Ÿå‰æ‰§è¡Œä¼ å…¥çš„å‡½æ•°ï¼Œå¹¶ä¼ å…¥ä¹‹å‰ä¿å­˜çš„å‚æ•°
    timer = setTimeout(() => {
      // åœ¨å»¶è¿Ÿç»“æŸåæ‰§è¡Œä¼ å…¥çš„å‡½æ•°ï¼Œå¹¶ä¼ å…¥ä¹‹å‰ä¿å­˜çš„å‚æ•°
      fn.apply(this, args);
      // æ‰§è¡Œå®Œæ¯•åå°†å®šæ—¶å™¨å˜é‡è®¾ç½®ä¸º nullï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡è°ƒç”¨å‡½æ•°
      timer = null;
    }, delay);
  }
}
å¤åˆ¶ä»£ç 
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `throttle` å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•° `fn` å’Œä¸€ä¸ªæ—¶é—´å»¶è¿Ÿå‚æ•° `delay`ã€‚è¿”å›ä¸€ä¸ªæ–°å‡½æ•°ï¼Œåœ¨è¿™ä¸ªæ–°å‡½æ•°ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæ ‡è®°å˜é‡ `timer` æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡ŒåŸå‡½æ•°ã€‚åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨åŸå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ä¿å­˜äº†å…¶ `this` æŒ‡å‘å’Œ `arguments` å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨è®¡æ—¶å™¨ç»“æŸåæ‰§è¡ŒåŸå‡½æ•°æ—¶ï¼ŒåŒæ ·éœ€è¦ä½¿ç”¨ `apply` æ–¹æ³•å°†ä¿å­˜çš„ `this` æŒ‡å‘ä¼ é€’ç»™åŸå‡½æ•°ï¼Œä»¥ç¡®ä¿å®ƒèƒ½å¤Ÿæ­£ç¡®åœ°è®¿é—®åˆ°å…¶æ‰€åœ¨çš„å¯¹è±¡ã€‚

## åœ¨å…·ä½“åŠŸèƒ½ä¸­ä½¿ç”¨é˜²æŠ–å’ŒèŠ‚æµ

é˜²æŠ–å’ŒèŠ‚æµçš„åº”ç”¨åœºæ™¯æ¯”è¾ƒå¹¿æ³›ï¼Œå¯ä»¥åœ¨å¾ˆå¤šå…·ä½“åŠŸèƒ½ä¸­ä½¿ç”¨å®ƒä»¬æ¥æé«˜ä»£ç çš„æ€§èƒ½ã€‚ä¾‹å¦‚ï¼š

- åœ¨ç”¨æˆ·è¾“å…¥æœç´¢å…³é”®è¯æ—¶ï¼Œå¯ä»¥ä½¿ç”¨é˜²æŠ–æ¥é¿å…é¢‘ç¹åœ°å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚
- åœ¨ç”¨æˆ·æ»šåŠ¨é¡µé¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨èŠ‚æµæ¥é¿å…é¢‘ç¹åœ°è§¦å‘å‡½æ•°ã€‚
- åœ¨ç›‘å¬çª—å£å¤§å°æ”¹å˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨èŠ‚æµæ¥é¿å…é¢‘ç¹åœ°è°ƒæ•´å¸ƒå±€ã€‚
- åœ¨ç›‘å¬é¼ æ ‡ç§»åŠ¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨èŠ‚æµæ¥é¿å…é¢‘ç¹åœ°è§¦å‘äº‹ä»¶ã€‚

ä¸‹é¢ä»¥ä¸€ä¸ªæœç´¢æ¡†çš„ä¾‹å­æ¥æ¼”ç¤ºå¦‚ä½•åœ¨å…·ä½“åŠŸèƒ½ä¸­ä½¿ç”¨é˜²æŠ–ã€‚

```html
<input type="text" id="search-input">
å¤åˆ¶ä»£ç 
const searchInput = document.getElementById('search-input');

function search(keyword) {
  console.log(`search for ${keyword}`);
  // å‘é€æœç´¢è¯·æ±‚
}

const debounceSearch = debounce(search, 500);

searchInput.addEventListener('input', event => {
  debounceSearch(event.target.value);
});
å¤åˆ¶ä»£ç 
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª `search` å‡½æ•°ï¼Œå®ƒä¼šæ¥å—ä¸€ä¸ªå…³é”®è¯å‚æ•°å¹¶å‘é€æœç´¢è¯·æ±‚ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ `debounce` å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªæ–°å‡½æ•° `debounceSearch`ï¼Œå®ƒä¼šåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å†…å®¹æ—¶è¢«è°ƒç”¨ï¼Œé¿å…äº†é¢‘ç¹åœ°å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚æœ€åï¼Œæˆ‘ä»¬é€šè¿‡ `addEventListener` æ–¹æ³•å°†è¿™ä¸ªæ–°å‡½æ•°ç»‘å®šåˆ°è¾“å…¥æ¡†çš„ `input` äº‹ä»¶ä¸Šï¼Œä»¥å“åº”ç”¨æˆ·çš„è¾“å…¥ã€‚

ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å…¶ä»–å…·ä½“åŠŸèƒ½ä¸­ä½¿ç”¨é˜²æŠ–å’ŒèŠ‚æµæ¥æé«˜ä»£ç çš„æ€§èƒ½ã€‚åªéœ€è¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©åˆé€‚çš„å‡½æ•°å’Œæ—¶é—´å»¶è¿Ÿå‚æ•°å³å¯ã€‚

## ç»“è¯­

é˜²æŠ–å’ŒèŠ‚æµæ˜¯ JavaScript ä¸­å¸¸ç”¨çš„æ€§èƒ½ä¼˜åŒ–æ–¹å¼ã€‚å®ƒä»¬çš„åŸç†å’Œå®ç°æ–¹æ³•éƒ½æ¯”è¾ƒç®€å•ï¼Œä½†å´èƒ½å¤Ÿæ˜¾è‘—æé«˜ä»£ç çš„æ€§èƒ½ã€‚åœ¨å…·ä½“åŠŸèƒ½ä¸­ä½¿ç”¨é˜²æŠ–å’ŒèŠ‚æµä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©åˆé€‚çš„å‡½æ•°å’Œæ—¶é—´å»¶è¿Ÿå‚æ•°å³å¯ã€‚å¸Œæœ›æœ¬æ–‡å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚

## ä¸€ã€æ˜¯ä»€ä¹ˆ

æœ¬è´¨ä¸Šæ˜¯ä¼˜åŒ–é«˜é¢‘ç‡æ‰§è¡Œä»£ç çš„ä¸€ç§æ‰‹æ®µ

å¦‚ï¼šæµè§ˆå™¨çš„ `resize`ã€`scroll`ã€`keypress`ã€`mousemove` ç­‰äº‹ä»¶åœ¨è§¦å‘æ—¶ï¼Œä¼šä¸æ–­åœ°è°ƒç”¨ç»‘å®šåœ¨äº‹ä»¶ä¸Šçš„å›è°ƒå‡½æ•°ï¼Œæå¤§åœ°æµªè´¹èµ„æºï¼Œé™ä½å‰ç«¯æ€§èƒ½

ä¸ºäº†ä¼˜åŒ–ä½“éªŒï¼Œéœ€è¦å¯¹è¿™ç±»äº‹ä»¶è¿›è¡Œè°ƒç”¨æ¬¡æ•°çš„é™åˆ¶ï¼Œå¯¹æ­¤æˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨ **é˜²æŠ–ï¼ˆdebounceï¼‰**  å’Œ **èŠ‚æµï¼ˆthrottleï¼‰**  çš„æ–¹å¼æ¥å‡å°‘è°ƒç”¨é¢‘ç‡

## äºŒ. åŒºåˆ«ä»¥åŠå…±åŒç‚¹

JS é˜²æŠ–ä¸èŠ‚æµ

|               | å…±åŒç‚¹                 | åŒºåˆ«           | åº”ç”¨åœºæ™¯    |
| ------------- | ---------------------- | -------------- | ----------- |
| é˜²æŠ– debounce | åœ¨äº‹ä»¶é¢‘ç¹è¢«è§¦å‘çš„æ—¶å€™ | åªæ‰§è¡Œæœ€åä¸€æ¬¡ | inputè¾“å…¥   |
| èŠ‚æµ throttle | å‡å°‘äº‹ä»¶æ‰§è¡Œçš„æ¬¡æ•°     | æœ‰è§„å¾‹çš„æ‰§è¡Œ   | æ‹–æ‹½,Scroll |

## ä¸‰. ä»£ç å®ç°

**é˜²æŠ–æ–¹æ³•çš„å®ç°**

```js
let input = document.querySelector('input')
        input.addEventListener('keyup', debounce(function () {
            console.log(input.value, 'å‘åå°å–æ•°æ®');
        })
        )
        // æ‰‹å†™ä¸€ä¸ªé˜²æŠ–å‡½æ•°æ¥è§£å†³é‡å¤è¯·æ±‚åå°æœåŠ¡å™¨çš„é—®é¢˜
        function debounce(fn) {
            let timer = null;

            return function () {
                if (timer) clearTimeout(timer)

                timer = setTimeout(() => {
                    fn.apply(this, arguments)
                    timer = null;
                }, 1000)
            }
        }
å¤åˆ¶ä»£ç 
```

**ä¸Šé¢ä»£ç çš„æ„æ€æ˜¯:**

æ‰¾åˆ°é¡µé¢ä¸­ç¬¬ä¸€ä¸ª` input` å…ƒç´ ï¼Œæ·»åŠ ä¸€ä¸ª `"keyup" äº‹ä»¶ç›‘å¬å™¨`ï¼Œå½“ç”¨æˆ·è¾“å…¥å†…å®¹æ—¶ï¼Œä½¿ç”¨`é˜²æŠ–å‡½æ•° debounce `æ¥é™åˆ¶äº‹ä»¶çš„è§¦å‘é¢‘ç‡ï¼Œæ¯æ¬¡äº‹ä»¶`æœ€å¤šåªè¢«è§¦å‘ä¸€æ¬¡`ã€‚

é˜²æŠ–å‡½æ•°`è¿”å›ä¸€ä¸ªæ–°å‡½æ•°`ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ä¸€å®šæ—¶é—´å†…ï¼ˆè¿™é‡Œæ˜¯ 1000 æ¯«ç§’ï¼‰ä¸æ‰§è¡Œï¼Œåœ¨è¯¥æ—¶é—´å†…å¦‚æœå†æ¬¡è§¦å‘äº†è¯¥äº‹ä»¶ï¼Œä¼š`æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨`å¹¶é‡æ–°è®¾ç½®è®¡æ—¶å™¨ã€‚å½“è®¡æ—¶å™¨ç»“æŸåï¼Œæ‰ä¼šæ‰§è¡Œä¼ å…¥çš„å‡½æ•°å¹¶å‘åå°æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼ŒåŒæ—¶å°† input å…ƒç´ çš„å€¼ä½œä¸ºå‚æ•°è¿›è¡Œè¾“å‡ºã€‚

è¿™æ ·å¯ä»¥`é˜²æ­¢ç”¨æˆ·è¾“å…¥è¿‡å¿«æˆ–è€…é¢‘ç‡è¿‡é«˜`ï¼Œå¯¼è‡´å‘åå°æœåŠ¡å™¨`å‘é€é‡å¤çš„è¯·æ±‚`ã€‚

**èŠ‚æµå‡½æ•°ä»£ç çš„å®ç°**

```js
   let box = document.querySelector('.box')
        box.addEventListener('drag', throttle(function (e) {
            console.log(e.clientX);
        }))

        function throttle(fn) {
            let timer = null;
            return function () {
                if (timer) return
                timer = setTimeout(() => {
                    fn.apply(this, arguments)
                    timer = null
                }, 100)
            }
        }
å¤åˆ¶ä»£ç 
```

**ä¸Šé¢ä»£ç çš„æ„æ€:** æ‰¾åˆ°é¡µé¢ä¸­ class ä¸º `"box" `çš„å…ƒç´ ï¼Œæ·»åŠ ä¸€ä¸ª `"drag" é¼ æ ‡æ‹–æ‹½` äº‹ä»¶ç›‘å¬å™¨ï¼Œå½“ç”¨æˆ·æ‹–åŠ¨è¯¥å…ƒç´ æ—¶ï¼Œä½¿ç”¨`èŠ‚æµå‡½æ•° throttle` æ¥é™åˆ¶äº‹ä»¶çš„`è§¦å‘é¢‘ç‡`ï¼Œ`æ¯100æ¯«ç§’è§¦å‘ä¸€æ¬¡äº‹ä»¶`ï¼Œå¹¶åœ¨æ§åˆ¶å°è¾“å‡ºé¼ æ ‡çš„ x åæ ‡å€¼ã€‚å…¶ä¸­ throttle å‡½æ•°è¿”å›ä¸€ä¸ªæ–°å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨ `timer è®¡æ—¶å™¨æœªç»“æŸæ—¶ä¸ä¼šæ‰§è¡Œ`ï¼Œä»è€Œå®ç°äº†`äº‹ä»¶çš„èŠ‚æµ`ã€‚

## å››. é˜²æŠ–æ•ˆæœå›¾å±•ç¤º(å‰åå¯¹æ¯”)

**æ²¡æœ‰åŠ é˜²æŠ–å‡½æ•°ä¹‹é—´** ![1.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb70c4f692f3492aaecc9b286185808e~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?) **åŠ äº†é˜²æŠ–å‡½æ•°ä¹‹å**

![1.1.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfa9312951454d35be1d9caf41b51b4f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

## èŠ‚æµæ•ˆæœå›¾å±•ç¤º(å‰åå¯¹æ¯”)

**æ²¡æœ‰åŠ èŠ‚æµå‡½æ•°ä¹‹é—´** ![2.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b6740e84fe8e457487eca9599fb3b575~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

**åŠ äº†èŠ‚æµå‡½æ•°ä¹‹å** ![2.1.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e9266b43583476aa348cb954a033c8a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

## äº”.æ€»ç»“

é˜²æŠ–å‡½æ•°çš„ä½œç”¨æ˜¯åœ¨ç”¨æˆ·åœæ­¢è§¦å‘äº‹ä»¶åï¼Œå»¶è¿Ÿä¸€æ®µæ—¶é—´å†æ‰§è¡Œå‡½æ•°ã€‚è¿™æ ·å¯ä»¥é¿å…é¢‘ç¹åœ°æ‰§è¡Œä¸€äº›è®¡ç®—é‡å¤§æˆ–è€…è¯·æ±‚é‡å¤§çš„å‡½æ•°ï¼Œæ¯”å¦‚è‡ªåŠ¨ä¿å­˜ã€æœç´¢å»ºè®®ç­‰ã€‚

èŠ‚æµå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨ä¸€å®šæ—¶é—´é—´éš”å†…ï¼Œåªæ‰§è¡Œä¸€æ¬¡å‡½æ•°ã€‚è¿™æ ·å¯ä»¥ä¿è¯å‡½æ•°çš„æ‰§è¡Œé€Ÿåº¦ä¸è¶…è¿‡è®¾å®šçš„é¢‘ç‡ï¼Œæ¯”å¦‚æ»šåŠ¨äº‹ä»¶ã€çª—å£å¤§å°è°ƒæ•´ç­‰ã€‚

æ€§èƒ½ä¼˜åŒ–æ˜¯æŠŠåŒåˆƒå‰‘ï¼Œæœ‰å¥½çš„ä¸€é¢ä¹Ÿæœ‰åçš„ä¸€é¢ã€‚å¥½çš„ä¸€é¢å°±æ˜¯èƒ½æå‡ç½‘ç«™æ€§èƒ½ï¼Œåçš„ä¸€é¢å°±æ˜¯é…ç½®éº»çƒ¦ï¼Œæˆ–è€…è¦éµå®ˆçš„è§„åˆ™å¤ªå¤šã€‚å¹¶ä¸”æŸäº›æ€§èƒ½ä¼˜åŒ–è§„åˆ™å¹¶ä¸é€‚ç”¨æ‰€æœ‰åœºæ™¯ï¼Œéœ€è¦è°¨æ…ä½¿ç”¨ï¼Œè¯·è¯»è€…å¸¦ç€æ‰¹åˆ¤æ€§çš„çœ¼å…‰æ¥é˜…è¯»æœ¬æ–‡ã€‚

æœ¬æ–‡ç›¸å…³çš„ä¼˜åŒ–å»ºè®®çš„å¼•ç”¨èµ„æ–™å‡ºå¤„å‡ä¼šåœ¨å»ºè®®åé¢ç»™å‡ºï¼Œæˆ–è€…æ”¾åœ¨æ–‡æœ«ã€‚

### 1. å‡å°‘ HTTP è¯·æ±‚

ä¸€ä¸ªå®Œæ•´çš„ HTTP è¯·æ±‚éœ€è¦ç»å† DNS æŸ¥æ‰¾ï¼ŒTCP æ¡æ‰‹ï¼Œæµè§ˆå™¨å‘å‡º HTTP è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ï¼ŒæœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶å‘å›å“åº”ï¼Œæµè§ˆå™¨æ¥æ”¶å“åº”ç­‰è¿‡ç¨‹ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­å¸®åŠ©ç†è§£ HTTP ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https:////p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05c1c42e60734ecd8dc7db8f4a8443ce~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

è¿™æ˜¯ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œè¯·æ±‚çš„æ–‡ä»¶å¤§å°ä¸º 28.4KBã€‚

åè¯è§£é‡Šï¼š

- Queueing: åœ¨è¯·æ±‚é˜Ÿåˆ—ä¸­çš„æ—¶é—´ã€‚
- Stalled: ä»TCP è¿æ¥å»ºç«‹å®Œæˆï¼Œåˆ°çœŸæ­£å¯ä»¥ä¼ è¾“æ•°æ®ä¹‹é—´çš„æ—¶é—´å·®ï¼Œæ­¤æ—¶é—´åŒ…æ‹¬ä»£ç†åå•†æ—¶é—´ã€‚
- Proxy negotiation: ä¸ä»£ç†æœåŠ¡å™¨è¿æ¥è¿›è¡Œåå•†æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚
- DNS Lookup: æ‰§è¡ŒDNSæŸ¥æ‰¾æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œé¡µé¢ä¸Šçš„æ¯ä¸ªä¸åŒçš„åŸŸéƒ½éœ€è¦è¿›è¡ŒDNSæŸ¥æ‰¾ã€‚
- Initial Connection / Connecting: å»ºç«‹è¿æ¥æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ŒåŒ…æ‹¬TCPæ¡æ‰‹/é‡è¯•å’Œåå•†SSLã€‚
- SSL: å®ŒæˆSSLæ¡æ‰‹æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚
- Request sent: å‘å‡ºç½‘ç»œè¯·æ±‚æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œé€šå¸¸ä¸ºä¸€æ¯«ç§’çš„æ—¶é—´ã€‚
- Waiting(TFFB): TFFB æ˜¯å‘å‡ºé¡µé¢è¯·æ±‚åˆ°æ¥æ”¶åˆ°åº”ç­”æ•°æ®ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æ—¶é—´ã€‚
- Content Download: æ¥æ”¶å“åº”æ•°æ®æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚

ä»è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºï¼ŒçœŸæ­£ä¸‹è½½æ•°æ®çš„æ—¶é—´å æ¯”ä¸º `13.05 / 204.16 = 6.39%`ï¼Œæ–‡ä»¶è¶Šå°ï¼Œè¿™ä¸ªæ¯”ä¾‹è¶Šå°ï¼Œæ–‡ä»¶è¶Šå¤§ï¼Œæ¯”ä¾‹å°±è¶Šé«˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦å»ºè®®å°†å¤šä¸ªå°æ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œä»è€Œå‡å°‘ HTTP è¯·æ±‚æ¬¡æ•°çš„åŸå› ã€‚

å‚è€ƒèµ„æ–™ï¼š

- [understanding-resource-timing](https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ftools%2Fchrome-devtools%2Fnetwork%2Funderstanding-resource-timing)

### 2. ä½¿ç”¨ HTTP2

HTTP2 ç›¸æ¯” HTTP1.1 æœ‰å¦‚ä¸‹å‡ ä¸ªä¼˜ç‚¹ï¼š

#### è§£æé€Ÿåº¦å¿«

æœåŠ¡å™¨è§£æ HTTP1.1 çš„è¯·æ±‚æ—¶ï¼Œå¿…é¡»ä¸æ–­åœ°è¯»å…¥å­—èŠ‚ï¼Œç›´åˆ°é‡åˆ°åˆ†éš”ç¬¦ CRLF ä¸ºæ­¢ã€‚è€Œè§£æ HTTP2 çš„è¯·æ±‚å°±ä¸ç”¨è¿™ä¹ˆéº»çƒ¦ï¼Œå› ä¸º HTTP2 æ˜¯åŸºäºå¸§çš„åè®®ï¼Œæ¯ä¸ªå¸§éƒ½æœ‰è¡¨ç¤ºå¸§é•¿åº¦çš„å­—æ®µã€‚

#### å¤šè·¯å¤ç”¨

HTTP1.1 å¦‚æœè¦åŒæ—¶å‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œå°±å¾—å»ºç«‹å¤šä¸ª TCP è¿æ¥ï¼Œå› ä¸ºä¸€ä¸ª TCP è¿æ¥åŒæ—¶åªèƒ½å¤„ç†ä¸€ä¸ª HTTP1.1 çš„è¯·æ±‚ã€‚

åœ¨ HTTP2 ä¸Šï¼Œå¤šä¸ªè¯·æ±‚å¯ä»¥å…±ç”¨ä¸€ä¸ª TCP è¿æ¥ï¼Œè¿™ç§°ä¸ºå¤šè·¯å¤ç”¨ã€‚åŒä¸€ä¸ªè¯·æ±‚å’Œå“åº”ç”¨ä¸€ä¸ªæµæ¥è¡¨ç¤ºï¼Œå¹¶æœ‰å”¯ä¸€çš„æµ ID æ¥æ ‡è¯†ã€‚ å¤šä¸ªè¯·æ±‚å’Œå“åº”åœ¨ TCP è¿æ¥ä¸­å¯ä»¥ä¹±åºå‘é€ï¼Œåˆ°è¾¾ç›®çš„åœ°åå†é€šè¿‡æµ ID é‡æ–°ç»„å»ºã€‚

#### é¦–éƒ¨å‹ç¼©

HTTP2 æä¾›äº†é¦–éƒ¨å‹ç¼©åŠŸèƒ½ã€‚

ä¾‹å¦‚æœ‰å¦‚ä¸‹ä¸¤ä¸ªè¯·æ±‚ï¼š

```makefile
:authority: unpkg.zhimg.com
:method: GET
:path: /za-js-sdk@2.16.0/dist/zap.js
:scheme: https
accept: */*
accept-encoding: gzip, deflate, br
accept-language: zh-CN,zh;q=0.9
cache-control: no-cache
pragma: no-cache
referer: https://www.zhihu.com/
sec-fetch-dest: script
sec-fetch-mode: no-cors
sec-fetch-site: cross-site
user-agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.122 Safari/537.36
å¤åˆ¶ä»£ç 
:authority: zz.bdstatic.com
:method: GET
:path: /linksubmit/push.js
:scheme: https
accept: */*
accept-encoding: gzip, deflate, br
accept-language: zh-CN,zh;q=0.9
cache-control: no-cache
pragma: no-cache
referer: https://www.zhihu.com/
sec-fetch-dest: script
sec-fetch-mode: no-cors
sec-fetch-site: cross-site
user-agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.122 Safari/537.36
å¤åˆ¶ä»£ç 
```

ä»ä¸Šé¢ä¸¤ä¸ªè¯·æ±‚å¯ä»¥çœ‹å‡ºæ¥ï¼Œæœ‰å¾ˆå¤šæ•°æ®éƒ½æ˜¯é‡å¤çš„ã€‚å¦‚æœå¯ä»¥æŠŠç›¸åŒçš„é¦–éƒ¨å­˜å‚¨èµ·æ¥ï¼Œä»…å‘é€å®ƒä»¬ä¹‹é—´ä¸åŒçš„éƒ¨åˆ†ï¼Œå°±å¯ä»¥èŠ‚çœä¸å°‘çš„æµé‡ï¼ŒåŠ å¿«è¯·æ±‚çš„æ—¶é—´ã€‚

HTTP/2 åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä½¿ç”¨â€œé¦–éƒ¨è¡¨â€æ¥è·Ÿè¸ªå’Œå­˜å‚¨ä¹‹å‰å‘é€çš„é”®ï¼å€¼å¯¹ï¼Œå¯¹äºç›¸åŒçš„æ•°æ®ï¼Œä¸å†é€šè¿‡æ¯æ¬¡è¯·æ±‚å’Œå“åº”å‘é€ã€‚

ä¸‹é¢å†æ¥çœ‹ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼Œå‡è®¾å®¢æˆ·ç«¯æŒ‰é¡ºåºå‘é€å¦‚ä¸‹è¯·æ±‚é¦–éƒ¨ï¼š

```makefile
Header1:foo
Header2:bar
Header3:bat
å¤åˆ¶ä»£ç 
```

å½“å®¢æˆ·ç«¯å‘é€è¯·æ±‚æ—¶ï¼Œå®ƒä¼šæ ¹æ®é¦–éƒ¨å€¼åˆ›å»ºä¸€å¼ è¡¨ï¼š

| ç´¢å¼• | é¦–éƒ¨åç§° | å€¼   |
| ---- | -------- | ---- |
| 62   | Header1  | foo  |
| 63   | Header2  | bar  |
| 64   | Header3  | bat  |

å¦‚æœæœåŠ¡å™¨æ”¶åˆ°äº†è¯·æ±‚ï¼Œå®ƒä¼šç…§æ ·åˆ›å»ºä¸€å¼ è¡¨ã€‚ å½“å®¢æˆ·ç«¯å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœé¦–éƒ¨ç›¸åŒï¼Œå®ƒå¯ä»¥ç›´æ¥å‘é€è¿™æ ·çš„é¦–éƒ¨å—ï¼š

```
62 63 64
å¤åˆ¶ä»£ç 
```

æœåŠ¡å™¨ä¼šæŸ¥æ‰¾å…ˆå‰å»ºç«‹çš„è¡¨æ ¼ï¼Œå¹¶æŠŠè¿™äº›æ•°å­—è¿˜åŸæˆç´¢å¼•å¯¹åº”çš„å®Œæ•´é¦–éƒ¨ã€‚

#### ä¼˜å…ˆçº§

HTTP2 å¯ä»¥å¯¹æ¯”è¾ƒç´§æ€¥çš„è¯·æ±‚è®¾ç½®ä¸€ä¸ªè¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼ŒæœåŠ¡å™¨åœ¨æ”¶åˆ°è¿™æ ·çš„è¯·æ±‚åï¼Œå¯ä»¥ä¼˜å…ˆå¤„ç†ã€‚

#### æµé‡æ§åˆ¶

ç”±äºä¸€ä¸ª TCP è¿æ¥æµé‡å¸¦å®½ï¼ˆæ ¹æ®å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„ç½‘ç»œå¸¦å®½è€Œå®šï¼‰æ˜¯å›ºå®šçš„ï¼Œå½“æœ‰å¤šä¸ªè¯·æ±‚å¹¶å‘æ—¶ï¼Œä¸€ä¸ªè¯·æ±‚å çš„æµé‡å¤šï¼Œå¦ä¸€ä¸ªè¯·æ±‚å çš„æµé‡å°±ä¼šå°‘ã€‚æµé‡æ§åˆ¶å¯ä»¥å¯¹ä¸åŒçš„æµçš„æµé‡è¿›è¡Œç²¾ç¡®æ§åˆ¶ã€‚

#### æœåŠ¡å™¨æ¨é€

HTTP2 æ–°å¢çš„ä¸€ä¸ªå¼ºå¤§çš„æ–°åŠŸèƒ½ï¼Œå°±æ˜¯æœåŠ¡å™¨å¯ä»¥å¯¹ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚å‘é€å¤šä¸ªå“åº”ã€‚æ¢å¥è¯è¯´ï¼Œé™¤äº†å¯¹æœ€åˆè¯·æ±‚çš„å“åº”å¤–ï¼ŒæœåŠ¡å™¨è¿˜å¯ä»¥é¢å¤–å‘å®¢æˆ·ç«¯æ¨é€èµ„æºï¼Œè€Œæ— éœ€å®¢æˆ·ç«¯æ˜ç¡®åœ°è¯·æ±‚ã€‚

ä¾‹å¦‚å½“æµè§ˆå™¨è¯·æ±‚ä¸€ä¸ªç½‘ç«™æ—¶ï¼Œé™¤äº†è¿”å› HTML é¡µé¢å¤–ï¼ŒæœåŠ¡å™¨è¿˜å¯ä»¥æ ¹æ® HTML é¡µé¢ä¸­çš„èµ„æºçš„ URLï¼Œæ¥æå‰æ¨é€èµ„æºã€‚

ç°åœ¨æœ‰å¾ˆå¤šç½‘ç«™å·²ç»å¼€å§‹ä½¿ç”¨ HTTP2 äº†ï¼Œä¾‹å¦‚çŸ¥ä¹ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https:////p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1ecd41f4c08c419ca381f8907299e928~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å…¶ä¸­ h2 æ˜¯æŒ‡ HTTP2 åè®®ï¼Œhttp/1.1 åˆ™æ˜¯æŒ‡ HTTP1.1 åè®®ã€‚

å‚è€ƒèµ„æ–™ï¼š

- [HTTP2 ç®€ä»‹](https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ffundamentals%2Fperformance%2Fhttp2%2F%3Fhl%3Dzh-cn)
- [åŠå°æ—¶ææ‡‚ HTTPã€HTTPSå’ŒHTTP2](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwoai3c%2FFront-end-articles%2Fblob%2Fmaster%2Fhttp-https-http2.md)

### 3. ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“

å®¢æˆ·ç«¯æ¸²æŸ“: è·å– HTML æ–‡ä»¶ï¼Œæ ¹æ®éœ€è¦ä¸‹è½½ JavaScript æ–‡ä»¶ï¼Œè¿è¡Œæ–‡ä»¶ï¼Œç”Ÿæˆ DOMï¼Œå†æ¸²æŸ“ã€‚

æœåŠ¡ç«¯æ¸²æŸ“ï¼šæœåŠ¡ç«¯è¿”å› HTML æ–‡ä»¶ï¼Œå®¢æˆ·ç«¯åªéœ€è§£æ HTMLã€‚

- ä¼˜ç‚¹ï¼šé¦–å±æ¸²æŸ“å¿«ï¼ŒSEO å¥½ã€‚
- ç¼ºç‚¹ï¼šé…ç½®éº»çƒ¦ï¼Œå¢åŠ äº†æœåŠ¡å™¨çš„è®¡ç®—å‹åŠ›ã€‚

ä¸‹é¢æˆ‘ç”¨ Vue SSR åšç¤ºä¾‹ï¼Œç®€å•çš„æè¿°ä¸€ä¸‹ SSR è¿‡ç¨‹ã€‚

#### å®¢æˆ·ç«¯æ¸²æŸ“è¿‡ç¨‹

1. è®¿é—®å®¢æˆ·ç«¯æ¸²æŸ“çš„ç½‘ç«™ã€‚
2. æœåŠ¡å™¨è¿”å›ä¸€ä¸ªåŒ…å«äº†å¼•å…¥èµ„æºè¯­å¥å’Œ `` çš„ HTML æ–‡ä»¶ã€‚
3. å®¢æˆ·ç«¯é€šè¿‡ HTTP å‘æœåŠ¡å™¨è¯·æ±‚èµ„æºï¼Œå½“å¿…è¦çš„èµ„æºéƒ½åŠ è½½å®Œæ¯•åï¼Œæ‰§è¡Œ `new Vue()` å¼€å§‹å®ä¾‹åŒ–å¹¶æ¸²æŸ“é¡µé¢ã€‚

#### æœåŠ¡ç«¯æ¸²æŸ“è¿‡ç¨‹

1. è®¿é—®æœåŠ¡ç«¯æ¸²æŸ“çš„ç½‘ç«™ã€‚
2. æœåŠ¡å™¨ä¼šæŸ¥çœ‹å½“å‰è·¯ç”±ç»„ä»¶éœ€è¦å“ªäº›èµ„æºæ–‡ä»¶ï¼Œç„¶åå°†è¿™äº›æ–‡ä»¶çš„å†…å®¹å¡«å……åˆ° HTML æ–‡ä»¶ã€‚å¦‚æœæœ‰ ajax è¯·æ±‚ï¼Œå°±ä¼šæ‰§è¡Œå®ƒè¿›è¡Œæ•°æ®é¢„å–å¹¶å¡«å……åˆ° HTML æ–‡ä»¶é‡Œï¼Œæœ€åè¿”å›è¿™ä¸ª HTML é¡µé¢ã€‚
3. å½“å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¿™ä¸ª HTML é¡µé¢æ—¶ï¼Œå¯ä»¥é©¬ä¸Šå°±å¼€å§‹æ¸²æŸ“é¡µé¢ã€‚ä¸æ­¤åŒæ—¶ï¼Œé¡µé¢ä¹Ÿä¼šåŠ è½½èµ„æºï¼Œå½“å¿…è¦çš„èµ„æºéƒ½åŠ è½½å®Œæ¯•åï¼Œå¼€å§‹æ‰§è¡Œ `new Vue()` å¼€å§‹å®ä¾‹åŒ–å¹¶æ¥ç®¡é¡µé¢ã€‚

ä»ä¸Šè¿°ä¸¤ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºï¼ŒåŒºåˆ«å°±åœ¨äºç¬¬äºŒæ­¥ã€‚å®¢æˆ·ç«¯æ¸²æŸ“çš„ç½‘ç«™ä¼šç›´æ¥è¿”å› HTML æ–‡ä»¶ï¼Œè€ŒæœåŠ¡ç«¯æ¸²æŸ“çš„ç½‘ç«™åˆ™ä¼šæ¸²æŸ“å®Œé¡µé¢å†è¿”å›è¿™ä¸ª HTML æ–‡ä»¶ã€‚

**è¿™æ ·åšçš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯æ›´å¿«çš„å†…å®¹åˆ°è¾¾æ—¶é—´ (time-to-content)**ã€‚

å‡è®¾ä½ çš„ç½‘ç«™éœ€è¦åŠ è½½å®Œ abcd å››ä¸ªæ–‡ä»¶æ‰èƒ½æ¸²æŸ“å®Œæ¯•ã€‚å¹¶ä¸”æ¯ä¸ªæ–‡ä»¶å¤§å°ä¸º 1 Mã€‚

è¿™æ ·ä¸€ç®—ï¼šå®¢æˆ·ç«¯æ¸²æŸ“çš„ç½‘ç«™éœ€è¦åŠ è½½ 4 ä¸ªæ–‡ä»¶å’Œ HTML æ–‡ä»¶æ‰èƒ½å®Œæˆé¦–é¡µæ¸²æŸ“ï¼Œæ€»è®¡å¤§å°ä¸º 4Mï¼ˆå¿½ç•¥ HTML æ–‡ä»¶å¤§å°ï¼‰ã€‚è€ŒæœåŠ¡ç«¯æ¸²æŸ“çš„ç½‘ç«™åªéœ€è¦åŠ è½½ä¸€ä¸ªæ¸²æŸ“å®Œæ¯•çš„ HTML æ–‡ä»¶å°±èƒ½å®Œæˆé¦–é¡µæ¸²æŸ“ï¼Œæ€»è®¡å¤§å°ä¸ºå·²ç»æ¸²æŸ“å®Œæ¯•çš„ HTML æ–‡ä»¶ï¼ˆè¿™ç§æ–‡ä»¶ä¸ä¼šå¤ªå¤§ï¼Œä¸€èˆ¬ä¸ºå‡ ç™¾Kï¼Œæˆ‘çš„ä¸ªäººåšå®¢ç½‘ç«™ï¼ˆSSRï¼‰åŠ è½½çš„ HTML æ–‡ä»¶ä¸º 400Kï¼‰ã€‚**è¿™å°±æ˜¯æœåŠ¡ç«¯æ¸²æŸ“æ›´å¿«çš„åŸå› **ã€‚

å‚è€ƒèµ„æ–™ï¼š

- [vue-ssr-demo](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwoai3c%2Fvue-ssr-demo)
- [Vue.js æœåŠ¡å™¨ç«¯æ¸²æŸ“æŒ‡å—](https://link.juejin.cn?target=https%3A%2F%2Fssr.vuejs.org%2Fzh%2F)

### 4. é™æ€èµ„æºä½¿ç”¨ CDN

å†…å®¹åˆ†å‘ç½‘ç»œï¼ˆCDNï¼‰æ˜¯ä¸€ç»„åˆ†å¸ƒåœ¨å¤šä¸ªä¸åŒåœ°ç†ä½ç½®çš„ Web æœåŠ¡å™¨ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå½“æœåŠ¡å™¨ç¦»ç”¨æˆ·è¶Šè¿œæ—¶ï¼Œå»¶è¿Ÿè¶Šé«˜ã€‚CDN å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œåœ¨å¤šä¸ªä½ç½®éƒ¨ç½²æœåŠ¡å™¨ï¼Œè®©ç”¨æˆ·ç¦»æœåŠ¡å™¨æ›´è¿‘ï¼Œä»è€Œç¼©çŸ­è¯·æ±‚æ—¶é—´ã€‚

#### CDN åŸç†

å½“ç”¨æˆ·è®¿é—®ä¸€ä¸ªç½‘ç«™æ—¶ï¼Œå¦‚æœæ²¡æœ‰ CDNï¼Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

1. æµè§ˆå™¨è¦å°†åŸŸåè§£æä¸º IP åœ°å€ï¼Œæ‰€ä»¥éœ€è¦å‘æœ¬åœ° DNS å‘å‡ºè¯·æ±‚ã€‚
2. æœ¬åœ° DNS ä¾æ¬¡å‘æ ¹æœåŠ¡å™¨ã€é¡¶çº§åŸŸåæœåŠ¡å™¨ã€æƒé™æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå¾—åˆ°ç½‘ç«™æœåŠ¡å™¨çš„ IP åœ°å€ã€‚
3. æœ¬åœ° DNS å°† IP åœ°å€å‘å›ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨å‘ç½‘ç«™æœåŠ¡å™¨ IP åœ°å€å‘å‡ºè¯·æ±‚å¹¶å¾—åˆ°èµ„æºã€‚

![img](https:////p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d25d1b0091b4e00ae51789172a46d2d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å¦‚æœç”¨æˆ·è®¿é—®çš„ç½‘ç«™éƒ¨ç½²äº† CDNï¼Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

1. æµè§ˆå™¨è¦å°†åŸŸåè§£æä¸º IP åœ°å€ï¼Œæ‰€ä»¥éœ€è¦å‘æœ¬åœ° DNS å‘å‡ºè¯·æ±‚ã€‚
2. æœ¬åœ° DNS ä¾æ¬¡å‘æ ¹æœåŠ¡å™¨ã€é¡¶çº§åŸŸåæœåŠ¡å™¨ã€æƒé™æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå¾—åˆ°å…¨å±€è´Ÿè½½å‡è¡¡ç³»ç»Ÿï¼ˆGSLBï¼‰çš„ IP åœ°å€ã€‚
3. æœ¬åœ° DNS å†å‘ GSLB å‘å‡ºè¯·æ±‚ï¼ŒGSLB çš„ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®æœ¬åœ° DNS çš„ IP åœ°å€åˆ¤æ–­ç”¨æˆ·çš„ä½ç½®ï¼Œç­›é€‰å‡ºè·ç¦»ç”¨æˆ·è¾ƒè¿‘çš„æœ¬åœ°è´Ÿè½½å‡è¡¡ç³»ç»Ÿï¼ˆSLBï¼‰ï¼Œå¹¶å°†è¯¥ SLB çš„ IP åœ°å€ä½œä¸ºç»“æœè¿”å›ç»™æœ¬åœ° DNSã€‚
4. æœ¬åœ° DNS å°† SLB çš„ IP åœ°å€å‘å›ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨å‘ SLB å‘å‡ºè¯·æ±‚ã€‚
5. SLB æ ¹æ®æµè§ˆå™¨è¯·æ±‚çš„èµ„æºå’Œåœ°å€ï¼Œé€‰å‡ºæœ€ä¼˜çš„ç¼“å­˜æœåŠ¡å™¨å‘å›ç»™æµè§ˆå™¨ã€‚
6. æµè§ˆå™¨å†æ ¹æ® SLB å‘å›çš„åœ°å€é‡å®šå‘åˆ°ç¼“å­˜æœåŠ¡å™¨ã€‚
7. å¦‚æœç¼“å­˜æœåŠ¡å™¨æœ‰æµè§ˆå™¨éœ€è¦çš„èµ„æºï¼Œå°±å°†èµ„æºå‘å›ç»™æµè§ˆå™¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±å‘æºæœåŠ¡å™¨è¯·æ±‚èµ„æºï¼Œå†å‘ç»™æµè§ˆå™¨å¹¶ç¼“å­˜åœ¨æœ¬åœ°ã€‚

![img](https:////p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67c19972e7dd4ae0840a0f838dd6a017~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å‚è€ƒèµ„æ–™ï¼š

- [CDNæ˜¯ä»€ä¹ˆï¼Ÿä½¿ç”¨CDNæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ](https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F36514327%2Fanswer%2F193768864)
- [CDNåŸç†ç®€æ](https://juejin.im/post/6844903873518239752)

### 5. å°† CSS æ”¾åœ¨æ–‡ä»¶å¤´éƒ¨ï¼ŒJavaScript æ–‡ä»¶æ”¾åœ¨åº•éƒ¨

- CSS æ‰§è¡Œä¼šé˜»å¡æ¸²æŸ“ï¼Œé˜»æ­¢ JS æ‰§è¡Œ
- JS åŠ è½½å’Œæ‰§è¡Œä¼šé˜»å¡ HTML è§£æï¼Œé˜»æ­¢ CSSOM æ„å»º

å¦‚æœè¿™äº› CSSã€JS æ ‡ç­¾æ”¾åœ¨ HEAD æ ‡ç­¾é‡Œï¼Œå¹¶ä¸”éœ€è¦åŠ è½½å’Œè§£æå¾ˆä¹…çš„è¯ï¼Œé‚£ä¹ˆé¡µé¢å°±ç©ºç™½äº†ã€‚æ‰€ä»¥ JS æ–‡ä»¶è¦æ”¾åœ¨åº•éƒ¨ï¼ˆä¸é˜»æ­¢ DOM è§£æï¼Œä½†ä¼šé˜»å¡æ¸²æŸ“ï¼‰ï¼Œç­‰ HTML è§£æå®Œäº†å†åŠ è½½ JS æ–‡ä»¶ï¼Œå°½æ—©å‘ç”¨æˆ·å‘ˆç°é¡µé¢çš„å†…å®¹ã€‚

é‚£ä¸ºä»€ä¹ˆ CSS æ–‡ä»¶è¿˜è¦æ”¾åœ¨å¤´éƒ¨å‘¢ï¼Ÿ

å› ä¸ºå…ˆåŠ è½½ HTML å†åŠ è½½ CSSï¼Œä¼šè®©ç”¨æˆ·ç¬¬ä¸€æ—¶é—´çœ‹åˆ°çš„é¡µé¢æ˜¯æ²¡æœ‰æ ·å¼çš„ã€â€œä¸‘é™‹â€çš„ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œå°±è¦å°† CSS æ–‡ä»¶æ”¾åœ¨å¤´éƒ¨äº†ã€‚

å¦å¤–ï¼ŒJS æ–‡ä»¶ä¹Ÿä¸æ˜¯ä¸å¯ä»¥æ”¾åœ¨å¤´éƒ¨ï¼Œåªè¦ç»™ script æ ‡ç­¾åŠ ä¸Š defer å±æ€§å°±å¯ä»¥äº†ï¼Œå¼‚æ­¥ä¸‹è½½ï¼Œå»¶è¿Ÿæ‰§è¡Œã€‚

å‚è€ƒèµ„æ–™ï¼š

- [ä½¿ç”¨ JavaScript æ·»åŠ äº¤äº’](https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ffundamentals%2Fperformance%2Fcritical-rendering-path%2Fadding-interactivity-with-javascript)

### 6. ä½¿ç”¨å­—ä½“å›¾æ ‡ iconfont ä»£æ›¿å›¾ç‰‡å›¾æ ‡

å­—ä½“å›¾æ ‡å°±æ˜¯å°†å›¾æ ‡åˆ¶ä½œæˆä¸€ä¸ªå­—ä½“ï¼Œä½¿ç”¨æ—¶å°±è·Ÿå­—ä½“ä¸€æ ·ï¼Œå¯ä»¥è®¾ç½®å±æ€§ï¼Œä¾‹å¦‚ font-sizeã€color ç­‰ç­‰ï¼Œéå¸¸æ–¹ä¾¿ã€‚å¹¶ä¸”å­—ä½“å›¾æ ‡æ˜¯çŸ¢é‡å›¾ï¼Œä¸ä¼šå¤±çœŸã€‚è¿˜æœ‰ä¸€ä¸ªä¼˜ç‚¹æ˜¯ç”Ÿæˆçš„æ–‡ä»¶ç‰¹åˆ«å°ã€‚

#### å‹ç¼©å­—ä½“æ–‡ä»¶

ä½¿ç”¨ [fontmin-webpack](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpatrickhulce%2Ffontmin-webpack) æ’ä»¶å¯¹å­—ä½“æ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼ˆæ„Ÿè°¢[å‰ç«¯å°ä¼Ÿ](https://juejin.im/user/237150239985165)æä¾›ï¼‰ã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/31d80f1553444be3a0b69a70eacc963b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å‚è€ƒèµ„æ–™ï¼š

- [fontmin-webpack](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpatrickhulce%2Ffontmin-webpack)
- [Iconfont-é˜¿é‡Œå·´å·´çŸ¢é‡å›¾æ ‡åº“](https://link.juejin.cn?target=https%3A%2F%2Fwww.iconfont.cn%2F)

### 7. å–„ç”¨ç¼“å­˜ï¼Œä¸é‡å¤åŠ è½½ç›¸åŒçš„èµ„æº

ä¸ºäº†é¿å…ç”¨æˆ·æ¯æ¬¡è®¿é—®ç½‘ç«™éƒ½å¾—è¯·æ±‚æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ  Expires æˆ– max-age æ¥æ§åˆ¶è¿™ä¸€è¡Œä¸ºã€‚Expires è®¾ç½®äº†ä¸€ä¸ªæ—¶é—´ï¼Œåªè¦åœ¨è¿™ä¸ªæ—¶é—´ä¹‹å‰ï¼Œæµè§ˆå™¨éƒ½ä¸ä¼šè¯·æ±‚æ–‡ä»¶ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ç¼“å­˜ã€‚è€Œ max-age æ˜¯ä¸€ä¸ªç›¸å¯¹æ—¶é—´ï¼Œå»ºè®®ä½¿ç”¨ max-age ä»£æ›¿ Expires ã€‚

ä¸è¿‡è¿™æ ·ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œå½“æ–‡ä»¶æ›´æ–°äº†æ€ä¹ˆåŠï¼Ÿæ€ä¹ˆé€šçŸ¥æµè§ˆå™¨é‡æ–°è¯·æ±‚æ–‡ä»¶ï¼Ÿ

å¯ä»¥é€šè¿‡æ›´æ–°é¡µé¢ä¸­å¼•ç”¨çš„èµ„æºé“¾æ¥åœ°å€ï¼Œè®©æµè§ˆå™¨ä¸»åŠ¨æ”¾å¼ƒç¼“å­˜ï¼ŒåŠ è½½æ–°èµ„æºã€‚

å…·ä½“åšæ³•æ˜¯æŠŠèµ„æºåœ°å€ URL çš„ä¿®æ”¹ä¸æ–‡ä»¶å†…å®¹å…³è”èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰æ–‡ä»¶å†…å®¹å˜åŒ–ï¼Œæ‰ä¼šå¯¼è‡´ç›¸åº” URL çš„å˜æ›´ï¼Œä»è€Œå®ç°æ–‡ä»¶çº§åˆ«çš„ç²¾ç¡®ç¼“å­˜æ§åˆ¶ã€‚ä»€ä¹ˆä¸œè¥¿ä¸æ–‡ä»¶å†…å®¹ç›¸å…³å‘¢ï¼Ÿæˆ‘ä»¬ä¼šå¾ˆè‡ªç„¶çš„è”æƒ³åˆ°åˆ©ç”¨[æ•°æ®æ‘˜è¦è¦ç®—æ³•](https://link.juejin.cn?target=https%3A%2F%2Fbaike.baidu.com%2Fitem%2F%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%E7%AE%97%E6%B3%95%2F3286770%3Ffromtitle%3D%E6%91%98%E8%A6%81%E7%AE%97%E6%B3%95%26fromid%3D12011257)å¯¹æ–‡ä»¶æ±‚æ‘˜è¦ä¿¡æ¯ï¼Œæ‘˜è¦ä¿¡æ¯ä¸æ–‡ä»¶å†…å®¹ä¸€ä¸€å¯¹åº”ï¼Œå°±æœ‰äº†ä¸€ç§å¯ä»¥ç²¾ç¡®åˆ°å•ä¸ªæ–‡ä»¶ç²’åº¦çš„ç¼“å­˜æ§åˆ¶ä¾æ®äº†ã€‚

å‚è€ƒèµ„æ–™ï¼š

- [webpack + express å®ç°æ–‡ä»¶ç²¾ç¡®ç¼“å­˜](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwoai3c%2Fnode-blog%2Fblob%2Fmaster%2Fdoc%2Fnode-blog7.md)
- [webpack-ç¼“å­˜](https://link.juejin.cn?target=https%3A%2F%2Fwww.webpackjs.com%2Fguides%2Fcaching%2F)
- [å¼ äº‘é¾™--å¤§å…¬å¸é‡Œæ€æ ·å¼€å‘å’Œéƒ¨ç½²å‰ç«¯ä»£ç ï¼Ÿ](https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F20790576%2Fanswer%2F32602154)

### 8. å‹ç¼©æ–‡ä»¶

å‹ç¼©æ–‡ä»¶å¯ä»¥å‡å°‘æ–‡ä»¶ä¸‹è½½æ—¶é—´ï¼Œè®©ç”¨æˆ·ä½“éªŒæ€§æ›´å¥½ã€‚

å¾—ç›Šäº webpack å’Œ node çš„å‘å±•ï¼Œç°åœ¨å‹ç¼©æ–‡ä»¶å·²ç»éå¸¸æ–¹ä¾¿äº†ã€‚

åœ¨ webpack å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ’ä»¶è¿›è¡Œå‹ç¼©ï¼š

- JavaScriptï¼šUglifyPlugin
- CSS ï¼šMiniCssExtractPlugin
- HTMLï¼šHtmlWebpackPlugin

å…¶å®ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åšå¾—æ›´å¥½ã€‚é‚£å°±æ˜¯ä½¿ç”¨ gzip å‹ç¼©ã€‚å¯ä»¥é€šè¿‡å‘ HTTP è¯·æ±‚å¤´ä¸­çš„ Accept-Encoding å¤´æ·»åŠ  gzip æ ‡è¯†æ¥å¼€å¯è¿™ä¸€åŠŸèƒ½ã€‚å½“ç„¶ï¼ŒæœåŠ¡å™¨ä¹Ÿå¾—æ”¯æŒè¿™ä¸€åŠŸèƒ½ã€‚

gzip æ˜¯ç›®å‰æœ€æµè¡Œå’Œæœ€æœ‰æ•ˆçš„å‹ç¼©æ–¹æ³•ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ç”¨ Vue å¼€å‘çš„é¡¹ç›®æ„å»ºåç”Ÿæˆçš„ app.js æ–‡ä»¶å¤§å°ä¸º 1.4MBï¼Œä½¿ç”¨ gzip å‹ç¼©ååªæœ‰ 573KBï¼Œä½“ç§¯å‡å°‘äº†å°†è¿‘ 60%ã€‚

é™„ä¸Š webpack å’Œ node é…ç½® gzip çš„ä½¿ç”¨æ–¹æ³•ã€‚

**ä¸‹è½½æ’ä»¶**

```css
npm install compression-webpack-plugin --save-dev
npm install compression
å¤åˆ¶ä»£ç 
```

**webpack é…ç½®**

```ini
const CompressionPlugin = require('compression-webpack-plugin');

module.exports = {
  plugins: [new CompressionPlugin()],
}
å¤åˆ¶ä»£ç 
```

**node é…ç½®**

```php
const compression = require('compression')
// åœ¨å…¶ä»–ä¸­é—´ä»¶å‰ä½¿ç”¨
app.use(compression())
å¤åˆ¶ä»£ç 
```

### 9. å›¾ç‰‡ä¼˜åŒ–

#### (1). å›¾ç‰‡å»¶è¿ŸåŠ è½½

åœ¨é¡µé¢ä¸­ï¼Œå…ˆä¸ç»™å›¾ç‰‡è®¾ç½®è·¯å¾„ï¼Œåªæœ‰å½“å›¾ç‰‡å‡ºç°åœ¨æµè§ˆå™¨çš„å¯è§†åŒºåŸŸæ—¶ï¼Œæ‰å»åŠ è½½çœŸæ­£çš„å›¾ç‰‡ï¼Œè¿™å°±æ˜¯å»¶è¿ŸåŠ è½½ã€‚å¯¹äºå›¾ç‰‡å¾ˆå¤šçš„ç½‘ç«™æ¥è¯´ï¼Œä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨å›¾ç‰‡ï¼Œä¼šå¯¹ç”¨æˆ·ä½“éªŒé€ æˆå¾ˆå¤§çš„å½±å“ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨å›¾ç‰‡å»¶è¿ŸåŠ è½½ã€‚

é¦–å…ˆå¯ä»¥å°†å›¾ç‰‡è¿™æ ·è®¾ç½®ï¼Œåœ¨é¡µé¢ä¸å¯è§æ—¶å›¾ç‰‡ä¸ä¼šåŠ è½½ï¼š

```html
<img data-src="https://avatars0.githubusercontent.com/u/22117876?s=460&u=7bd8f32788df6988833da6bd155c3cfbebc68006&v=4">
å¤åˆ¶ä»£ç 
```

ç­‰é¡µé¢å¯è§æ—¶ï¼Œä½¿ç”¨ JS åŠ è½½å›¾ç‰‡ï¼š

```js
const img = document.querySelector('img')
img.src = img.dataset.src
å¤åˆ¶ä»£ç 
```

è¿™æ ·å›¾ç‰‡å°±åŠ è½½å‡ºæ¥äº†ï¼Œå®Œæ•´çš„ä»£ç å¯ä»¥çœ‹ä¸€ä¸‹å‚è€ƒèµ„æ–™ã€‚

å‚è€ƒèµ„æ–™ï¼š

- [web å‰ç«¯å›¾ç‰‡æ‡’åŠ è½½å®ç°åŸç†](https://juejin.im/entry/6844903482164510734)

#### (2). å“åº”å¼å›¾ç‰‡

å“åº”å¼å›¾ç‰‡çš„ä¼˜ç‚¹æ˜¯æµè§ˆå™¨èƒ½å¤Ÿæ ¹æ®å±å¹•å¤§å°è‡ªåŠ¨åŠ è½½åˆé€‚çš„å›¾ç‰‡ã€‚

é€šè¿‡ `picture` å®ç°

```html
<picture>
	<source srcset="banner_w1000.jpg" media="(min-width: 801px)">
	<source srcset="banner_w800.jpg" media="(max-width: 800px)">
	<img src="banner_w800.jpg" alt="">
</picture>
å¤åˆ¶ä»£ç 
```

é€šè¿‡ `@media` å®ç°

```html
@media (min-width: 769px) {
	.bg {
		background-image: url(bg1080.jpg);
	}
}
@media (max-width: 768px) {
	.bg {
		background-image: url(bg768.jpg);
	}
}
å¤åˆ¶ä»£ç 
```

#### (3). è°ƒæ•´å›¾ç‰‡å¤§å°

ä¾‹å¦‚ï¼Œä½ æœ‰ä¸€ä¸ª 1920 * 1080 å¤§å°çš„å›¾ç‰‡ï¼Œç”¨ç¼©ç•¥å›¾çš„æ–¹å¼å±•ç¤ºç»™ç”¨æˆ·ï¼Œå¹¶ä¸”å½“ç”¨æˆ·é¼ æ ‡æ‚¬åœåœ¨ä¸Šé¢æ—¶æ‰å±•ç¤ºå…¨å›¾ã€‚å¦‚æœç”¨æˆ·ä»æœªçœŸæ­£å°†é¼ æ ‡æ‚¬åœåœ¨ç¼©ç•¥å›¾ä¸Šï¼Œåˆ™æµªè´¹äº†ä¸‹è½½å›¾ç‰‡çš„æ—¶é—´ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸¤å¼ å›¾ç‰‡æ¥å®è¡Œä¼˜åŒ–ã€‚ä¸€å¼€å§‹ï¼ŒåªåŠ è½½ç¼©ç•¥å›¾ï¼Œå½“ç”¨æˆ·æ‚¬åœåœ¨å›¾ç‰‡ä¸Šæ—¶ï¼Œæ‰åŠ è½½å¤§å›¾ã€‚è¿˜æœ‰ä¸€ç§åŠæ³•ï¼Œå³å¯¹å¤§å›¾è¿›è¡Œå»¶è¿ŸåŠ è½½ï¼Œåœ¨æ‰€æœ‰å…ƒç´ éƒ½åŠ è½½å®Œæˆåæ‰‹åŠ¨æ›´æ”¹å¤§å›¾çš„ src è¿›è¡Œä¸‹è½½ã€‚

#### (4). é™ä½å›¾ç‰‡è´¨é‡

ä¾‹å¦‚ JPG æ ¼å¼çš„å›¾ç‰‡ï¼Œ100% çš„è´¨é‡å’Œ 90% è´¨é‡çš„é€šå¸¸çœ‹ä¸å‡ºæ¥åŒºåˆ«ï¼Œå°¤å…¶æ˜¯ç”¨æ¥å½“èƒŒæ™¯å›¾çš„æ—¶å€™ã€‚æˆ‘ç»å¸¸ç”¨ PS åˆ‡èƒŒæ™¯å›¾æ—¶ï¼Œ å°†å›¾ç‰‡åˆ‡æˆ JPG æ ¼å¼ï¼Œå¹¶ä¸”å°†å®ƒå‹ç¼©åˆ° 60% çš„è´¨é‡ï¼ŒåŸºæœ¬ä¸Šçœ‹ä¸å‡ºæ¥åŒºåˆ«ã€‚

å‹ç¼©æ–¹æ³•æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯é€šè¿‡ webpack æ’ä»¶ `image-webpack-loader`ï¼ŒäºŒæ˜¯é€šè¿‡åœ¨çº¿ç½‘ç«™è¿›è¡Œå‹ç¼©ã€‚

ä»¥ä¸‹é™„ä¸Š webpack æ’ä»¶ `image-webpack-loader` çš„ç”¨æ³•ã€‚

```arduino
npm i -D image-webpack-loader
å¤åˆ¶ä»£ç 
```

webpack é…ç½®

```js
{
  test: /\.(png|jpe?g|gif|svg)(\?.*)?$/,
  use:[
    {
    loader: 'url-loader',
    options: {
      limit: 10000, /* å›¾ç‰‡å¤§å°å°äº1000å­—èŠ‚é™åˆ¶æ—¶ä¼šè‡ªåŠ¨è½¬æˆ base64 ç å¼•ç”¨*/
      name: utils.assetsPath('img/[name].[hash:7].[ext]')
      }
    },
    /*å¯¹å›¾ç‰‡è¿›è¡Œå‹ç¼©*/
    {
      loader: 'image-webpack-loader',
      options: {
        bypassOnDebug: true,
      }
    }
  ]
}
å¤åˆ¶ä»£ç 
```

#### (5). å°½å¯èƒ½åˆ©ç”¨ CSS3 æ•ˆæœä»£æ›¿å›¾ç‰‡

æœ‰å¾ˆå¤šå›¾ç‰‡ä½¿ç”¨ CSS æ•ˆæœï¼ˆæ¸å˜ã€é˜´å½±ç­‰ï¼‰å°±èƒ½ç”»å‡ºæ¥ï¼Œè¿™ç§æƒ…å†µé€‰æ‹© CSS3 æ•ˆæœæ›´å¥½ã€‚å› ä¸ºä»£ç å¤§å°é€šå¸¸æ˜¯å›¾ç‰‡å¤§å°çš„å‡ åˆ†ä¹‹ä¸€ç”šè‡³å‡ ååˆ†ä¹‹ä¸€ã€‚

å‚è€ƒèµ„æ–™ï¼š

- [imgå›¾ç‰‡åœ¨webpackä¸­ä½¿ç”¨](https://juejin.im/post/6844903816081457159)

#### (6). ä½¿ç”¨ webp æ ¼å¼çš„å›¾ç‰‡

> WebP çš„ä¼˜åŠ¿ä½“ç°åœ¨å®ƒå…·æœ‰æ›´ä¼˜çš„å›¾åƒæ•°æ®å‹ç¼©ç®—æ³•ï¼Œèƒ½å¸¦æ¥æ›´å°çš„å›¾ç‰‡ä½“ç§¯ï¼Œè€Œä¸”æ‹¥æœ‰è‚‰çœ¼è¯†åˆ«æ— å·®å¼‚çš„å›¾åƒè´¨é‡ï¼›åŒæ—¶å…·å¤‡äº†æ— æŸå’Œæœ‰æŸçš„å‹ç¼©æ¨¡å¼ã€Alpha é€æ˜ä»¥åŠåŠ¨ç”»çš„ç‰¹æ€§ï¼Œåœ¨ JPEG å’Œ PNG ä¸Šçš„è½¬åŒ–æ•ˆæœéƒ½ç›¸å½“ä¼˜ç§€ã€ç¨³å®šå’Œç»Ÿä¸€ã€‚

å‚è€ƒèµ„æ–™ï¼š

- [WebP ç›¸å¯¹äº PNGã€JPG æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ](https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F27201061)

### 10. é€šè¿‡ webpack æŒ‰éœ€åŠ è½½ä»£ç ï¼Œæå–ç¬¬ä¸‰åº“ä»£ç ï¼Œå‡å°‘ ES6 è½¬ä¸º ES5 çš„å†—ä½™ä»£ç 

> æ‡’åŠ è½½æˆ–è€…æŒ‰éœ€åŠ è½½ï¼Œæ˜¯ä¸€ç§å¾ˆå¥½çš„ä¼˜åŒ–ç½‘é¡µæˆ–åº”ç”¨çš„æ–¹å¼ã€‚è¿™ç§æ–¹å¼å®é™…ä¸Šæ˜¯å…ˆæŠŠä½ çš„ä»£ç åœ¨ä¸€äº›é€»è¾‘æ–­ç‚¹å¤„åˆ†ç¦»å¼€ï¼Œç„¶ååœ¨ä¸€äº›ä»£ç å—ä¸­å®ŒæˆæŸäº›æ“ä½œåï¼Œç«‹å³å¼•ç”¨æˆ–å³å°†å¼•ç”¨å¦å¤–ä¸€äº›æ–°çš„ä»£ç å—ã€‚è¿™æ ·åŠ å¿«äº†åº”ç”¨çš„åˆå§‹åŠ è½½é€Ÿåº¦ï¼Œå‡è½»äº†å®ƒçš„æ€»ä½“ä½“ç§¯ï¼Œå› ä¸ºæŸäº›ä»£ç å—å¯èƒ½æ°¸è¿œä¸ä¼šè¢«åŠ è½½ã€‚

#### æ ¹æ®æ–‡ä»¶å†…å®¹ç”Ÿæˆæ–‡ä»¶åï¼Œç»“åˆ import åŠ¨æ€å¼•å…¥ç»„ä»¶å®ç°æŒ‰éœ€åŠ è½½

é€šè¿‡é…ç½® output çš„ filename å±æ€§å¯ä»¥å®ç°è¿™ä¸ªéœ€æ±‚ã€‚filename å±æ€§çš„å€¼é€‰é¡¹ä¸­æœ‰ä¸€ä¸ª [contenthash]ï¼Œå®ƒå°†æ ¹æ®æ–‡ä»¶å†…å®¹åˆ›å»ºå‡ºå”¯ä¸€ hashã€‚å½“æ–‡ä»¶å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œ[contenthash] ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ã€‚

```js
output: {
	filename: '[name].[contenthash].js',
    chunkFilename: '[name].[contenthash].js',
    path: path.resolve(__dirname, '../dist'),
},
å¤åˆ¶ä»£ç 
```

#### æå–ç¬¬ä¸‰æ–¹åº“

ç”±äºå¼•å…¥çš„ç¬¬ä¸‰æ–¹åº“ä¸€èˆ¬éƒ½æ¯”è¾ƒç¨³å®šï¼Œä¸ä¼šç»å¸¸æ”¹å˜ã€‚æ‰€ä»¥å°†å®ƒä»¬å•ç‹¬æå–å‡ºæ¥ï¼Œä½œä¸ºé•¿æœŸç¼“å­˜æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚ è¿™é‡Œéœ€è¦ä½¿ç”¨ webpack4 çš„ splitChunk æ’ä»¶ cacheGroups é€‰é¡¹ã€‚

```js
optimization: {
  	runtimeChunk: {
        name: 'manifest' // å°† webpack çš„ runtime ä»£ç æ‹†åˆ†ä¸ºä¸€ä¸ªå•ç‹¬çš„ chunkã€‚
    },
    splitChunks: {
        cacheGroups: {
            vendor: {
                name: 'chunk-vendors',
                test: /[\\/]node_modules[\\/]/,
                priority: -10,
                chunks: 'initial'
            },
            common: {
                name: 'chunk-common',
                minChunks: 2,
                priority: -20,
                chunks: 'initial',
                reuseExistingChunk: true
            }
        },
    }
},
å¤åˆ¶ä»£ç 
```

- test: ç”¨äºæ§åˆ¶å“ªäº›æ¨¡å—è¢«è¿™ä¸ªç¼“å­˜ç»„åŒ¹é…åˆ°ã€‚åŸå°ä¸åŠ¨ä¼ é€’å‡ºå»çš„è¯ï¼Œå®ƒé»˜è®¤ä¼šé€‰æ‹©æ‰€æœ‰çš„æ¨¡å—ã€‚å¯ä»¥ä¼ é€’çš„å€¼ç±»å‹ï¼šRegExpã€Stringå’ŒFunction;
- priorityï¼šè¡¨ç¤ºæŠ½å–æƒé‡ï¼Œæ•°å­—è¶Šå¤§è¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜ã€‚å› ä¸ºä¸€ä¸ª module å¯èƒ½ä¼šæ»¡è¶³å¤šä¸ª cacheGroups çš„æ¡ä»¶ï¼Œé‚£ä¹ˆæŠ½å–åˆ°å“ªä¸ªå°±ç”±æƒé‡æœ€é«˜çš„è¯´äº†ç®—ï¼›
- reuseExistingChunkï¼šè¡¨ç¤ºæ˜¯å¦ä½¿ç”¨å·²æœ‰çš„ chunkï¼Œå¦‚æœä¸º true åˆ™è¡¨ç¤ºå¦‚æœå½“å‰çš„ chunk åŒ…å«çš„æ¨¡å—å·²ç»è¢«æŠ½å–å‡ºå»äº†ï¼Œé‚£ä¹ˆå°†ä¸ä¼šé‡æ–°ç”Ÿæˆæ–°çš„ã€‚
- minChunksï¼ˆé»˜è®¤æ˜¯1ï¼‰ï¼šåœ¨åˆ†å‰²ä¹‹å‰ï¼Œè¿™ä¸ªä»£ç å—æœ€å°åº”è¯¥è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼ˆè¯‘æ³¨ï¼šä¿è¯ä»£ç å—å¤ç”¨æ€§ï¼Œé»˜è®¤é…ç½®çš„ç­–ç•¥æ˜¯ä¸éœ€è¦å¤šæ¬¡å¼•ç”¨ä¹Ÿå¯ä»¥è¢«åˆ†å‰²ï¼‰
- chunks (é»˜è®¤æ˜¯async) ï¼šinitialã€asyncå’Œall
- name(æ‰“åŒ…çš„chunksçš„åå­—)ï¼šå­—ç¬¦ä¸²æˆ–è€…å‡½æ•°(å‡½æ•°å¯ä»¥æ ¹æ®æ¡ä»¶è‡ªå®šä¹‰åå­—)

#### å‡å°‘ ES6 è½¬ä¸º ES5 çš„å†—ä½™ä»£ç 

Babel è½¬åŒ–åçš„ä»£ç æƒ³è¦å®ç°å’ŒåŸæ¥ä»£ç ä¸€æ ·çš„åŠŸèƒ½éœ€è¦å€ŸåŠ©ä¸€äº›å¸®åŠ©å‡½æ•°ï¼Œæ¯”å¦‚ï¼š

```js
class Person {}
å¤åˆ¶ä»£ç 
```

ä¼šè¢«è½¬æ¢ä¸ºï¼š

```js
"use strict";

function _classCallCheck(instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
}

var Person = function Person() {
  _classCallCheck(this, Person);
};
å¤åˆ¶ä»£ç 
```

è¿™é‡Œ `_classCallCheck` å°±æ˜¯ä¸€ä¸ª `helper` å‡½æ•°ï¼Œå¦‚æœåœ¨å¾ˆå¤šæ–‡ä»¶é‡Œéƒ½å£°æ˜äº†ç±»ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿå¾ˆå¤šä¸ªè¿™æ ·çš„ `helper` å‡½æ•°ã€‚

è¿™é‡Œçš„ `@babel/runtime` åŒ…å°±å£°æ˜äº†æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„å¸®åŠ©å‡½æ•°ï¼Œè€Œ `@babel/plugin-transform-runtime` çš„ä½œç”¨å°±æ˜¯å°†æ‰€æœ‰éœ€è¦ `helper` å‡½æ•°çš„æ–‡ä»¶ï¼Œä» `@babel/runtimeåŒ…` å¼•è¿›æ¥ï¼š

```js
"use strict";

var _classCallCheck2 = require("@babel/runtime/helpers/classCallCheck");

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

var Person = function Person() {
  (0, _classCallCheck3.default)(this, Person);
};
å¤åˆ¶ä»£ç 
```

è¿™é‡Œå°±æ²¡æœ‰å†ç¼–è¯‘å‡º `helper` å‡½æ•° `classCallCheck` äº†ï¼Œè€Œæ˜¯ç›´æ¥å¼•ç”¨äº† `@babel/runtime` ä¸­çš„ `helpers/classCallCheck`ã€‚

**å®‰è£…**

```bash
npm i -D @babel/plugin-transform-runtime @babel/runtime
å¤åˆ¶ä»£ç 
```

**ä½¿ç”¨** åœ¨ `.babelrc` æ–‡ä»¶ä¸­

```perl
"plugins": [
        "@babel/plugin-transform-runtime"
]
å¤åˆ¶ä»£ç 
```

å‚è€ƒèµ„æ–™ï¼š

- [Babel 7.1ä»‹ç» transform-runtime polyfill env](https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2Fd078b5f3036a)
- [æ‡’åŠ è½½](https://link.juejin.cn?target=http%3A%2F%2Fwebpack.docschina.org%2Fguides%2Flazy-loading%2F)
- [Vue è·¯ç”±æ‡’åŠ è½½](https://link.juejin.cn?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2Fguide%2Fadvanced%2Flazy-loading.html%23%E8%B7%AF%E7%94%B1%E6%87%92%E5%8A%A0%E8%BD%BD)
- [webpack ç¼“å­˜](https://link.juejin.cn?target=https%3A%2F%2Fwebpack.docschina.org%2Fguides%2Fcaching%2F)
- [ä¸€æ­¥ä¸€æ­¥çš„äº†è§£webpack4çš„splitChunkæ’ä»¶](https://juejin.im/post/6844903614759043079)

### 11. å‡å°‘é‡ç»˜é‡æ’

**æµè§ˆå™¨æ¸²æŸ“è¿‡ç¨‹**

1. è§£æHTMLç”ŸæˆDOMæ ‘ã€‚
2. è§£æCSSç”ŸæˆCSSOMè§„åˆ™æ ‘ã€‚
3. è§£æJSï¼Œæ“ä½œ DOM æ ‘å’Œ CSSOM è§„åˆ™æ ‘ã€‚
4. å°†DOMæ ‘ä¸CSSOMè§„åˆ™æ ‘åˆå¹¶åœ¨ä¸€èµ·ç”Ÿæˆæ¸²æŸ“æ ‘ã€‚
5. éå†æ¸²æŸ“æ ‘å¼€å§‹å¸ƒå±€ï¼Œè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ä½ç½®å¤§å°ä¿¡æ¯ã€‚
6. æµè§ˆå™¨å°†æ‰€æœ‰å›¾å±‚çš„æ•°æ®å‘é€ç»™GPUï¼ŒGPUå°†å›¾å±‚åˆæˆå¹¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https:////p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e927ffe33f3d4bdba64e179e9c793bb9~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**é‡æ’**

å½“æ”¹å˜ DOM å…ƒç´ ä½ç½®æˆ–å¤§å°æ—¶ï¼Œä¼šå¯¼è‡´æµè§ˆå™¨é‡æ–°ç”Ÿæˆæ¸²æŸ“æ ‘ï¼Œè¿™ä¸ªè¿‡ç¨‹å«é‡æ’ã€‚

**é‡ç»˜**

å½“é‡æ–°ç”Ÿæˆæ¸²æŸ“æ ‘åï¼Œå°±è¦å°†æ¸²æŸ“æ ‘æ¯ä¸ªèŠ‚ç‚¹ç»˜åˆ¶åˆ°å±å¹•ï¼Œè¿™ä¸ªè¿‡ç¨‹å«é‡ç»˜ã€‚ä¸æ˜¯æ‰€æœ‰çš„åŠ¨ä½œéƒ½ä¼šå¯¼è‡´é‡æ’ï¼Œä¾‹å¦‚æ”¹å˜å­—ä½“é¢œè‰²ï¼Œåªä¼šå¯¼è‡´é‡ç»˜ã€‚è®°ä½ï¼Œé‡æ’ä¼šå¯¼è‡´é‡ç»˜ï¼Œé‡ç»˜ä¸ä¼šå¯¼è‡´é‡æ’ ã€‚

é‡æ’å’Œé‡ç»˜è¿™ä¸¤ä¸ªæ“ä½œéƒ½æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œå› ä¸º JavaScript å¼•æ“çº¿ç¨‹ä¸ GUI æ¸²æŸ“çº¿ç¨‹æ˜¯äº’æ–¥ï¼Œå®ƒä»¬åŒæ—¶åªèƒ½ä¸€ä¸ªåœ¨å·¥ä½œã€‚

ä»€ä¹ˆæ“ä½œä¼šå¯¼è‡´é‡æ’ï¼Ÿ

- æ·»åŠ æˆ–åˆ é™¤å¯è§çš„ DOM å…ƒç´ 
- å…ƒç´ ä½ç½®æ”¹å˜
- å…ƒç´ å°ºå¯¸æ”¹å˜
- å†…å®¹æ”¹å˜
- æµè§ˆå™¨çª—å£å°ºå¯¸æ”¹å˜

å¦‚ä½•å‡å°‘é‡æ’é‡ç»˜ï¼Ÿ

- ç”¨ JavaScript ä¿®æ”¹æ ·å¼æ—¶ï¼Œæœ€å¥½ä¸è¦ç›´æ¥å†™æ ·å¼ï¼Œè€Œæ˜¯æ›¿æ¢ class æ¥æ”¹å˜æ ·å¼ã€‚
- å¦‚æœè¦å¯¹ DOM å…ƒç´ æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œï¼Œå¯ä»¥å°† DOM å…ƒç´ è„±ç¦»æ–‡æ¡£æµï¼Œä¿®æ”¹å®Œæˆåï¼Œå†å°†å®ƒå¸¦å›æ–‡æ¡£ã€‚æ¨èä½¿ç”¨éšè—å…ƒç´ ï¼ˆdisplay:noneï¼‰æˆ–æ–‡æ¡£ç¢ç‰‡ï¼ˆDocumentFragementï¼‰ï¼Œéƒ½èƒ½å¾ˆå¥½çš„å®ç°è¿™ä¸ªæ–¹æ¡ˆã€‚

### 12. ä½¿ç”¨äº‹ä»¶å§”æ‰˜

äº‹ä»¶å§”æ‰˜åˆ©ç”¨äº†äº‹ä»¶å†’æ³¡ï¼ŒåªæŒ‡å®šä¸€ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºï¼Œå°±å¯ä»¥ç®¡ç†æŸä¸€ç±»å‹çš„æ‰€æœ‰äº‹ä»¶ã€‚æ‰€æœ‰ç”¨åˆ°æŒ‰é’®çš„äº‹ä»¶ï¼ˆå¤šæ•°é¼ æ ‡äº‹ä»¶å’Œé”®ç›˜äº‹ä»¶ï¼‰éƒ½é€‚åˆé‡‡ç”¨äº‹ä»¶å§”æ‰˜æŠ€æœ¯ï¼Œ ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¯ä»¥èŠ‚çœå†…å­˜ã€‚

```js
<ul>
  <li>è‹¹æœ</li>
  <li>é¦™è•‰</li>
  <li>å‡¤æ¢¨</li>
</ul>

// good
document.querySelector('ul').onclick = (event) => {
  const target = event.target
  if (target.nodeName === 'LI') {
    console.log(target.innerHTML)
  }
}

// bad
document.querySelectorAll('li').forEach((e) => {
  e.onclick = function() {
    console.log(this.innerHTML)
  }
}) 
å¤åˆ¶ä»£ç 
```

### 13. æ³¨æ„ç¨‹åºçš„å±€éƒ¨æ€§

ä¸€ä¸ªç¼–å†™è‰¯å¥½çš„è®¡ç®—æœºç¨‹åºå¸¸å¸¸å…·æœ‰è‰¯å¥½çš„å±€éƒ¨æ€§ï¼Œå®ƒä»¬å€¾å‘äºå¼•ç”¨æœ€è¿‘å¼•ç”¨è¿‡çš„æ•°æ®é¡¹é™„è¿‘çš„æ•°æ®é¡¹ï¼Œæˆ–è€…æœ€è¿‘å¼•ç”¨è¿‡çš„æ•°æ®é¡¹æœ¬èº«ï¼Œè¿™ç§å€¾å‘æ€§ï¼Œè¢«ç§°ä¸ºå±€éƒ¨æ€§åŸç†ã€‚æœ‰è‰¯å¥½å±€éƒ¨æ€§çš„ç¨‹åºæ¯”å±€éƒ¨æ€§å·®çš„ç¨‹åºè¿è¡Œå¾—æ›´å¿«ã€‚

**å±€éƒ¨æ€§é€šå¸¸æœ‰ä¸¤ç§ä¸åŒçš„å½¢å¼ï¼š**

- æ—¶é—´å±€éƒ¨æ€§ï¼šåœ¨ä¸€ä¸ªå…·æœ‰è‰¯å¥½æ—¶é—´å±€éƒ¨æ€§çš„ç¨‹åºä¸­ï¼Œè¢«å¼•ç”¨è¿‡ä¸€æ¬¡çš„å†…å­˜ä½ç½®å¾ˆå¯èƒ½åœ¨ä¸è¿œçš„å°†æ¥è¢«å¤šæ¬¡å¼•ç”¨ã€‚
- ç©ºé—´å±€éƒ¨æ€§ ï¼šåœ¨ä¸€ä¸ªå…·æœ‰è‰¯å¥½ç©ºé—´å±€éƒ¨æ€§çš„ç¨‹åºä¸­ï¼Œå¦‚æœä¸€ä¸ªå†…å­˜ä½ç½®è¢«å¼•ç”¨äº†ä¸€æ¬¡ï¼Œé‚£ä¹ˆç¨‹åºå¾ˆå¯èƒ½åœ¨ä¸è¿œçš„å°†æ¥å¼•ç”¨é™„è¿‘çš„ä¸€ä¸ªå†…å­˜ä½ç½®ã€‚

æ—¶é—´å±€éƒ¨æ€§ç¤ºä¾‹

```js
function sum(arry) {
	let i, sum = 0
	let len = arry.length

	for (i = 0; i < len; i++) {
		sum += arry[i]
	}

	return sum
}
å¤åˆ¶ä»£ç 
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå˜é‡sumåœ¨æ¯æ¬¡å¾ªç¯è¿­ä»£ä¸­è¢«å¼•ç”¨ä¸€æ¬¡ï¼Œå› æ­¤ï¼Œå¯¹äºsumæ¥è¯´ï¼Œå…·æœ‰è‰¯å¥½çš„æ—¶é—´å±€éƒ¨æ€§

ç©ºé—´å±€éƒ¨æ€§ç¤ºä¾‹

**å…·æœ‰è‰¯å¥½ç©ºé—´å±€éƒ¨æ€§çš„ç¨‹åº**

```js
// äºŒç»´æ•°ç»„ 
function sum1(arry, rows, cols) {
	let i, j, sum = 0

	for (i = 0; i < rows; i++) {
		for (j = 0; j < cols; j++) {
			sum += arry[i][j]
		}
	}
	return sum
}
å¤åˆ¶ä»£ç 
```

**ç©ºé—´å±€éƒ¨æ€§å·®çš„ç¨‹åº**

```js
// äºŒç»´æ•°ç»„ 
function sum2(arry, rows, cols) {
	let i, j, sum = 0

	for (j = 0; j < cols; j++) {
		for (i = 0; i < rows; i++) {
			sum += arry[i][j]
		}
	}
	return sum
}
å¤åˆ¶ä»£ç 
```

çœ‹ä¸€ä¸‹ä¸Šé¢çš„ä¸¤ä¸ªç©ºé—´å±€éƒ¨æ€§ç¤ºä¾‹ï¼Œåƒç¤ºä¾‹ä¸­ä»æ¯è¡Œå¼€å§‹æŒ‰é¡ºåºè®¿é—®æ•°ç»„æ¯ä¸ªå…ƒç´ çš„æ–¹å¼ï¼Œç§°ä¸ºå…·æœ‰æ­¥é•¿ä¸º1çš„å¼•ç”¨æ¨¡å¼ã€‚ å¦‚æœåœ¨æ•°ç»„ä¸­ï¼Œæ¯éš”kä¸ªå…ƒç´ è¿›è¡Œè®¿é—®ï¼Œå°±ç§°ä¸ºæ­¥é•¿ä¸ºkçš„å¼•ç”¨æ¨¡å¼ã€‚ ä¸€èˆ¬è€Œè¨€ï¼Œéšç€æ­¥é•¿çš„å¢åŠ ï¼Œç©ºé—´å±€éƒ¨æ€§ä¸‹é™ã€‚

è¿™ä¸¤ä¸ªä¾‹å­æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸåŒºåˆ«åœ¨äºç¬¬ä¸€ä¸ªç¤ºä¾‹æ˜¯æŒ‰è¡Œæ‰«ææ•°ç»„ï¼Œæ¯æ‰«æå®Œä¸€è¡Œå†å»æ‰«ä¸‹ä¸€è¡Œï¼›ç¬¬äºŒä¸ªç¤ºä¾‹æ˜¯æŒ‰åˆ—æ¥æ‰«ææ•°ç»„ï¼Œæ‰«å®Œä¸€è¡Œä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œé©¬ä¸Šå°±å»æ‰«ä¸‹ä¸€è¡Œä¸­çš„åŒä¸€åˆ—å…ƒç´ ã€‚

æ•°ç»„åœ¨å†…å­˜ä¸­æ˜¯æŒ‰ç…§è¡Œé¡ºåºæ¥å­˜æ”¾çš„ï¼Œç»“æœå°±æ˜¯é€è¡Œæ‰«ææ•°ç»„çš„ç¤ºä¾‹å¾—åˆ°äº†æ­¥é•¿ä¸º 1 å¼•ç”¨æ¨¡å¼ï¼Œå…·æœ‰è‰¯å¥½çš„ç©ºé—´å±€éƒ¨æ€§ï¼›è€Œå¦ä¸€ä¸ªç¤ºä¾‹æ­¥é•¿ä¸º rowsï¼Œç©ºé—´å±€éƒ¨æ€§æå·®ã€‚

#### æ€§èƒ½æµ‹è¯•

è¿è¡Œç¯å¢ƒï¼š

- cpu: i5-7400
- æµè§ˆå™¨: chrome 70.0.3538.110

å¯¹ä¸€ä¸ªé•¿åº¦ä¸º9000çš„äºŒç»´æ•°ç»„ï¼ˆå­æ•°ç»„é•¿åº¦ä¹Ÿä¸º9000ï¼‰è¿›è¡Œ10æ¬¡ç©ºé—´å±€éƒ¨æ€§æµ‹è¯•ï¼Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰å–å¹³å‡å€¼ï¼Œç»“æœå¦‚ä¸‹ï¼š

æ‰€ç”¨ç¤ºä¾‹ä¸ºä¸Šè¿°ä¸¤ä¸ªç©ºé—´å±€éƒ¨æ€§ç¤ºä¾‹

| æ­¥é•¿ä¸º 1 | æ­¥é•¿ä¸º 9000 |
| -------- | ----------- |
| 124      | 2316        |

ä»ä»¥ä¸Šæµ‹è¯•ç»“æœæ¥çœ‹ï¼Œæ­¥é•¿ä¸º 1 çš„æ•°ç»„æ‰§è¡Œæ—¶é—´æ¯”æ­¥é•¿ä¸º 9000 çš„æ•°ç»„å¿«äº†ä¸€ä¸ªæ•°é‡çº§ã€‚

æ€»ç»“ï¼š

- é‡å¤å¼•ç”¨ç›¸åŒå˜é‡çš„ç¨‹åºå…·æœ‰è‰¯å¥½çš„æ—¶é—´å±€éƒ¨æ€§
- å¯¹äºå…·æœ‰æ­¥é•¿ä¸º k çš„å¼•ç”¨æ¨¡å¼çš„ç¨‹åºï¼Œæ­¥é•¿è¶Šå°ï¼Œç©ºé—´å±€éƒ¨æ€§è¶Šå¥½ï¼›è€Œåœ¨å†…å­˜ä¸­ä»¥å¤§æ­¥é•¿è·³æ¥è·³å»çš„ç¨‹åºç©ºé—´å±€éƒ¨æ€§ä¼šå¾ˆå·®

å‚è€ƒèµ„æ–™ï¼š

- [æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ](https://link.juejin.cn?target=https%3A%2F%2Fbook.douban.com%2Fsubject%2F26912767%2F)

### 14. if-else å¯¹æ¯” switch

å½“åˆ¤æ–­æ¡ä»¶æ•°é‡è¶Šæ¥è¶Šå¤šæ—¶ï¼Œè¶Šå€¾å‘äºä½¿ç”¨ switch è€Œä¸æ˜¯ if-elseã€‚

```js
if (color == 'blue') {

} else if (color == 'yellow') {

} else if (color == 'white') {

} else if (color == 'black') {

} else if (color == 'green') {

} else if (color == 'orange') {

} else if (color == 'pink') {

}

switch (color) {
    case 'blue':

        break
    case 'yellow':

        break
    case 'white':

        break
    case 'black':

        break
    case 'green':

        break
    case 'orange':

        break
    case 'pink':

        break
}
å¤åˆ¶ä»£ç 
```

åƒä¸Šé¢çš„è¿™ç§æƒ…å†µï¼Œä»å¯è¯»æ€§æ¥è¯´ï¼Œä½¿ç”¨ switch æ˜¯æ¯”è¾ƒå¥½çš„ï¼ˆjs çš„ switch è¯­å¥ä¸æ˜¯åŸºäºå“ˆå¸Œå®ç°ï¼Œè€Œæ˜¯å¾ªç¯åˆ¤æ–­ï¼Œæ‰€ä»¥è¯´ if-elseã€switch ä»æ€§èƒ½ä¸Šæ¥è¯´æ˜¯ä¸€æ ·çš„ï¼‰ã€‚

### 15. æŸ¥æ‰¾è¡¨

å½“æ¡ä»¶è¯­å¥ç‰¹åˆ«å¤šæ—¶ï¼Œä½¿ç”¨ switch å’Œ if-else ä¸æ˜¯æœ€ä½³çš„é€‰æ‹©ï¼Œè¿™æ—¶ä¸å¦¨è¯•ä¸€ä¸‹æŸ¥æ‰¾è¡¨ã€‚æŸ¥æ‰¾è¡¨å¯ä»¥ä½¿ç”¨æ•°ç»„å’Œå¯¹è±¡æ¥æ„å»ºã€‚

```js
switch (index) {
    case '0':
        return result0
    case '1':
        return result1
    case '2':
        return result2
    case '3':
        return result3
    case '4':
        return result4
    case '5':
        return result5
    case '6':
        return result6
    case '7':
        return result7
    case '8':
        return result8
    case '9':
        return result9
    case '10':
        return result10
    case '11':
        return result11
}
å¤åˆ¶ä»£ç 
```

å¯ä»¥å°†è¿™ä¸ª switch è¯­å¥è½¬æ¢ä¸ºæŸ¥æ‰¾è¡¨

```js
const results = [result0,result1,result2,result3,result4,result5,result6,result7,result8,result9,result10,result11]

return results[index]
å¤åˆ¶ä»£ç 
```

å¦‚æœæ¡ä»¶è¯­å¥ä¸æ˜¯æ•°å€¼è€Œæ˜¯å­—ç¬¦ä¸²ï¼Œå¯ä»¥ç”¨å¯¹è±¡æ¥å»ºç«‹æŸ¥æ‰¾è¡¨

```js
const map = {
  red: result0,
  green: result1,
}

return map[color]
å¤åˆ¶ä»£ç 
```

### 16. é¿å…é¡µé¢å¡é¡¿

**60fps ä¸è®¾å¤‡åˆ·æ–°ç‡**

> ç›®å‰å¤§å¤šæ•°è®¾å¤‡çš„å±å¹•åˆ·æ–°ç‡ä¸º 60 æ¬¡/ç§’ã€‚å› æ­¤ï¼Œå¦‚æœåœ¨é¡µé¢ä¸­æœ‰ä¸€ä¸ªåŠ¨ç”»æˆ–æ¸å˜æ•ˆæœï¼Œæˆ–è€…ç”¨æˆ·æ­£åœ¨æ»šåŠ¨é¡µé¢ï¼Œé‚£ä¹ˆæµè§ˆå™¨æ¸²æŸ“åŠ¨ç”»æˆ–é¡µé¢çš„æ¯ä¸€å¸§çš„é€Ÿç‡ä¹Ÿéœ€è¦è·Ÿè®¾å¤‡å±å¹•çš„åˆ·æ–°ç‡ä¿æŒä¸€è‡´ã€‚ å…¶ä¸­æ¯ä¸ªå¸§çš„é¢„ç®—æ—¶é—´ä»…æ¯” 16 æ¯«ç§’å¤šä¸€ç‚¹ (1 ç§’/ 60 = 16.66 æ¯«ç§’)ã€‚ä½†å®é™…ä¸Šï¼Œæµè§ˆå™¨æœ‰æ•´ç†å·¥ä½œè¦åšï¼Œå› æ­¤æ‚¨çš„æ‰€æœ‰å·¥ä½œéœ€è¦åœ¨ 10 æ¯«ç§’å†…å®Œæˆã€‚å¦‚æœæ— æ³•ç¬¦åˆæ­¤é¢„ç®—ï¼Œå¸§ç‡å°†ä¸‹é™ï¼Œå¹¶ä¸”å†…å®¹ä¼šåœ¨å±å¹•ä¸ŠæŠ–åŠ¨ã€‚ æ­¤ç°è±¡é€šå¸¸ç§°ä¸ºå¡é¡¿ï¼Œä¼šå¯¹ç”¨æˆ·ä½“éªŒäº§ç”Ÿè´Ÿé¢å½±å“ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https:////p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5877fb299fb94e979551481dcf79e67f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å‡å¦‚ä½ ç”¨ JavaScript ä¿®æ”¹äº† DOMï¼Œå¹¶è§¦å‘æ ·å¼ä¿®æ”¹ï¼Œç»å†é‡æ’é‡ç»˜æœ€åç”»åˆ°å±å¹•ä¸Šã€‚å¦‚æœè¿™å…¶ä¸­ä»»æ„ä¸€é¡¹çš„æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œéƒ½ä¼šå¯¼è‡´æ¸²æŸ“è¿™ä¸€å¸§çš„æ—¶é—´è¿‡é•¿ï¼Œå¹³å‡å¸§ç‡å°±ä¼šä¸‹é™ã€‚å‡è®¾è¿™ä¸€å¸§èŠ±äº† 50 msï¼Œé‚£ä¹ˆæ­¤æ—¶çš„å¸§ç‡ä¸º 1s / 50ms = 20fpsï¼Œé¡µé¢çœ‹èµ·æ¥å°±åƒå¡é¡¿äº†ä¸€æ ·ã€‚

å¯¹äºä¸€äº›é•¿æ—¶é—´è¿è¡Œçš„ JavaScriptï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®šæ—¶å™¨è¿›è¡Œåˆ‡åˆ†ï¼Œå»¶è¿Ÿæ‰§è¡Œã€‚

```js
for (let i = 0, len = arry.length; i < len; i++) {
	process(arry[i])
}
å¤åˆ¶ä»£ç 
```

å‡è®¾ä¸Šé¢çš„å¾ªç¯ç»“æ„ç”±äº process() å¤æ‚åº¦è¿‡é«˜æˆ–æ•°ç»„å…ƒç´ å¤ªå¤šï¼Œç”šè‡³ä¸¤è€…éƒ½æœ‰ï¼Œå¯ä»¥å°è¯•ä¸€ä¸‹åˆ‡åˆ†ã€‚

```js
const todo = arry.concat()
setTimeout(function() {
	process(todo.shift())
	if (todo.length) {
		setTimeout(arguments.callee, 25)
	} else {
		callback(arry)
	}
}, 25)
å¤åˆ¶ä»£ç 
```

å¦‚æœæœ‰å…´è¶£äº†è§£æ›´å¤šï¼Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹[é«˜æ€§èƒ½JavaScript](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwoai3c%2Frecommended-books%2Fblob%2Fmaster%2F%E5%89%8D%E7%AB%AF%2F%E9%AB%98%E6%80%A7%E8%83%BDJavaScript.pdf)ç¬¬ 6 ç« å’Œ[é«˜æ•ˆå‰ç«¯ï¼šWebé«˜æ•ˆç¼–ç¨‹ä¸ä¼˜åŒ–å®è·µ](https://link.juejin.cn?target=https%3A%2F%2Fbook.douban.com%2Fsubject%2F30170670%2F)ç¬¬ 3 ç« ã€‚

å‚è€ƒèµ„æ–™ï¼š

- [æ¸²æŸ“æ€§èƒ½](https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ffundamentals%2Fperformance%2Frendering)

### 17. ä½¿ç”¨ requestAnimationFrame æ¥å®ç°è§†è§‰å˜åŒ–

ä»ç¬¬ 16 ç‚¹æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¤§å¤šæ•°è®¾å¤‡å±å¹•åˆ·æ–°ç‡ä¸º 60 æ¬¡/ç§’ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€å¸§çš„å¹³å‡æ—¶é—´ä¸º 16.66 æ¯«ç§’ã€‚åœ¨ä½¿ç”¨ JavaScript å®ç°åŠ¨ç”»æ•ˆæœçš„æ—¶å€™ï¼Œæœ€å¥½çš„æƒ…å†µå°±æ˜¯æ¯æ¬¡ä»£ç éƒ½æ˜¯åœ¨å¸§çš„å¼€å¤´å¼€å§‹æ‰§è¡Œã€‚è€Œä¿è¯ JavaScript åœ¨å¸§å¼€å§‹æ—¶è¿è¡Œçš„å”¯ä¸€æ–¹å¼æ˜¯ä½¿ç”¨ `requestAnimationFrame`ã€‚

```js
/**
 * If run as a requestAnimationFrame callback, this
 * will be run at the start of the frame.
 */
function updateScreen(time) {
  // Make visual updates here.
}

requestAnimationFrame(updateScreen);
å¤åˆ¶ä»£ç 
```

å¦‚æœé‡‡å– `setTimeout` æˆ– `setInterval` æ¥å®ç°åŠ¨ç”»çš„è¯ï¼Œå›è°ƒå‡½æ•°å°†åœ¨å¸§ä¸­çš„æŸä¸ªæ—¶ç‚¹è¿è¡Œï¼Œå¯èƒ½åˆšå¥½åœ¨æœ«å°¾ï¼Œè€Œè¿™å¯èƒ½ç»å¸¸ä¼šä½¿æˆ‘ä»¬ä¸¢å¤±å¸§ï¼Œå¯¼è‡´å¡é¡¿ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https:////p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/090488e1a87540558ffdeb8fb4fd157f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å‚è€ƒèµ„æ–™ï¼š

- [ä¼˜åŒ– JavaScript æ‰§è¡Œ](https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ffundamentals%2Fperformance%2Frendering%2Foptimize-javascript-execution%3Fhl%3Dzh-cn)

### 18. ä½¿ç”¨ Web Workers

Web Worker ä½¿ç”¨å…¶ä»–å·¥ä½œçº¿ç¨‹ä»è€Œç‹¬ç«‹äºä¸»çº¿ç¨‹ä¹‹å¤–ï¼Œå®ƒå¯ä»¥æ‰§è¡Œä»»åŠ¡è€Œä¸å¹²æ‰°ç”¨æˆ·ç•Œé¢ã€‚ä¸€ä¸ª worker å¯ä»¥å°†æ¶ˆæ¯å‘é€åˆ°åˆ›å»ºå®ƒçš„ JavaScript ä»£ç , é€šè¿‡å°†æ¶ˆæ¯å‘é€åˆ°è¯¥ä»£ç æŒ‡å®šçš„äº‹ä»¶å¤„ç†ç¨‹åºï¼ˆåä¹‹äº¦ç„¶ï¼‰ã€‚

Web Worker é€‚ç”¨äºé‚£äº›å¤„ç†çº¯æ•°æ®ï¼Œæˆ–è€…ä¸æµè§ˆå™¨ UI æ— å…³çš„é•¿æ—¶é—´è¿è¡Œè„šæœ¬ã€‚

åˆ›å»ºä¸€ä¸ªæ–°çš„ worker å¾ˆç®€å•ï¼ŒæŒ‡å®šä¸€ä¸ªè„šæœ¬çš„ URI æ¥æ‰§è¡Œ worker çº¿ç¨‹ï¼ˆmain.jsï¼‰ï¼š

```js
var myWorker = new Worker('worker.js');
// ä½ å¯ä»¥é€šè¿‡postMessage() æ–¹æ³•å’Œonmessageäº‹ä»¶å‘workerå‘é€æ¶ˆæ¯ã€‚
first.onchange = function() {
  myWorker.postMessage([first.value,second.value]);
  console.log('Message posted to worker');
}

second.onchange = function() {
  myWorker.postMessage([first.value,second.value]);
  console.log('Message posted to worker');
}
å¤åˆ¶ä»£ç 
```

åœ¨ worker ä¸­æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ä»£ç ä½œä¸ºå“åº”ï¼ˆworker.jsï¼‰ï¼š

```js
onmessage = function(e) {
  console.log('Message received from main script');
  var workerResult = 'Result: ' + (e.data[0] * e.data[1]);
  console.log('Posting message back to main script');
  postMessage(workerResult);
}
å¤åˆ¶ä»£ç 
```

onmessageå¤„ç†å‡½æ•°åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åé©¬ä¸Šæ‰§è¡Œï¼Œä»£ç ä¸­æ¶ˆæ¯æœ¬èº«ä½œä¸ºäº‹ä»¶çš„dataå±æ€§è¿›è¡Œä½¿ç”¨ã€‚è¿™é‡Œæˆ‘ä»¬ç®€å•çš„å¯¹è¿™2ä¸ªæ•°å­—ä½œä¹˜æ³•å¤„ç†å¹¶å†æ¬¡ä½¿ç”¨postMessage()æ–¹æ³•ï¼Œå°†ç»“æœå›ä¼ ç»™ä¸»çº¿ç¨‹ã€‚

å›åˆ°ä¸»çº¿ç¨‹ï¼Œæˆ‘ä»¬å†æ¬¡ä½¿ç”¨onmessageä»¥å“åº”workerå›ä¼ çš„æ¶ˆæ¯ï¼š

```js
myWorker.onmessage = function(e) {
  result.textContent = e.data;
  console.log('Message received from worker');
}
å¤åˆ¶ä»£ç 
```

åœ¨è¿™é‡Œæˆ‘ä»¬è·å–æ¶ˆæ¯äº‹ä»¶çš„dataï¼Œå¹¶ä¸”å°†å®ƒè®¾ç½®ä¸ºresultçš„textContentï¼Œæ‰€ä»¥ç”¨æˆ·å¯ä»¥ç›´æ¥çœ‹åˆ°è¿ç®—çš„ç»“æœã€‚

ä¸è¿‡åœ¨workerå†…ï¼Œä¸èƒ½ç›´æ¥æ“ä½œDOMèŠ‚ç‚¹ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨windowå¯¹è±¡çš„é»˜è®¤æ–¹æ³•å’Œå±æ€§ã€‚ç„¶è€Œä½ å¯ä»¥ä½¿ç”¨å¤§é‡windowå¯¹è±¡ä¹‹ä¸‹çš„ä¸œè¥¿ï¼ŒåŒ…æ‹¬WebSocketsï¼ŒIndexedDBä»¥åŠFireFox OSä¸“ç”¨çš„Data Store APIç­‰æ•°æ®å­˜å‚¨æœºåˆ¶ã€‚

å‚è€ƒèµ„æ–™ï¼š

- [Web Workers](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWeb_Workers_API%2FUsing_web_workers)

### 19. ä½¿ç”¨ä½æ“ä½œ

JavaScript ä¸­çš„æ•°å­—éƒ½ä½¿ç”¨ IEEE-754 æ ‡å‡†ä»¥ 64 ä½æ ¼å¼å­˜å‚¨ã€‚ä½†æ˜¯åœ¨ä½æ“ä½œä¸­ï¼Œæ•°å­—è¢«è½¬æ¢ä¸ºæœ‰ç¬¦å·çš„ 32 ä½æ ¼å¼ã€‚å³ä½¿éœ€è¦è½¬æ¢ï¼Œä½æ“ä½œä¹Ÿæ¯”å…¶ä»–æ•°å­¦è¿ç®—å’Œå¸ƒå°”æ“ä½œå¿«å¾—å¤šã€‚

##### å–æ¨¡

ç”±äºå¶æ•°çš„æœ€ä½ä½ä¸º 0ï¼Œå¥‡æ•°ä¸º 1ï¼Œæ‰€ä»¥å–æ¨¡è¿ç®—å¯ä»¥ç”¨ä½æ“ä½œæ¥ä»£æ›¿ã€‚

```js
if (value % 2) {
	// å¥‡æ•°
} else {
	// å¶æ•° 
}
// ä½æ“ä½œ
if (value & 1) {
	// å¥‡æ•°
} else {
	// å¶æ•°
}
å¤åˆ¶ä»£ç 
```

##### å–æ•´

```js
~~10.12 // 10
~~10 // 10
~~'1.5' // 1
~~undefined // 0
~~null // 0
å¤åˆ¶ä»£ç 
```

##### ä½æ©ç 

```js
const a = 1
const b = 2
const c = 4
const options = a | b | c
å¤åˆ¶ä»£ç 
```

é€šè¿‡å®šä¹‰è¿™äº›é€‰é¡¹ï¼Œå¯ä»¥ç”¨æŒ‰ä½ä¸æ“ä½œæ¥åˆ¤æ–­ a/b/c æ˜¯å¦åœ¨ options ä¸­ã€‚

```js
// é€‰é¡¹ b æ˜¯å¦åœ¨é€‰é¡¹ä¸­
if (b & options) {
	...
}
å¤åˆ¶ä»£ç 
```

### 20. ä¸è¦è¦†ç›–åŸç”Ÿæ–¹æ³•

æ— è®ºä½ çš„ JavaScript ä»£ç å¦‚ä½•ä¼˜åŒ–ï¼Œéƒ½æ¯”ä¸ä¸ŠåŸç”Ÿæ–¹æ³•ã€‚å› ä¸ºåŸç”Ÿæ–¹æ³•æ˜¯ç”¨ä½çº§è¯­è¨€å†™çš„ï¼ˆC/C++ï¼‰ï¼Œå¹¶ä¸”è¢«ç¼–è¯‘æˆæœºå™¨ç ï¼Œæˆä¸ºæµè§ˆå™¨çš„ä¸€éƒ¨åˆ†ã€‚å½“åŸç”Ÿæ–¹æ³•å¯ç”¨æ—¶ï¼Œå°½é‡ä½¿ç”¨å®ƒä»¬ï¼Œç‰¹åˆ«æ˜¯æ•°å­¦è¿ç®—å’Œ DOM æ“ä½œã€‚

### 21. é™ä½ CSS é€‰æ‹©å™¨çš„å¤æ‚æ€§

#### (1). æµè§ˆå™¨è¯»å–é€‰æ‹©å™¨ï¼Œéµå¾ªçš„åŸåˆ™æ˜¯ä»é€‰æ‹©å™¨çš„å³è¾¹åˆ°å·¦è¾¹è¯»å–ã€‚

çœ‹ä¸ªç¤ºä¾‹

```css
#block .text p {
	color: red;
}
å¤åˆ¶ä»£ç 
```

1. æŸ¥æ‰¾æ‰€æœ‰ P å…ƒç´ ã€‚
2. æŸ¥æ‰¾ç»“æœ 1 ä¸­çš„å…ƒç´ æ˜¯å¦æœ‰ç±»åä¸º text çš„çˆ¶å…ƒç´ 
3. æŸ¥æ‰¾ç»“æœ 2 ä¸­çš„å…ƒç´ æ˜¯å¦æœ‰ id ä¸º block çš„çˆ¶å…ƒç´ 

#### (2). CSS é€‰æ‹©å™¨ä¼˜å…ˆçº§

```
å†…è” > IDé€‰æ‹©å™¨ > ç±»é€‰æ‹©å™¨ > æ ‡ç­¾é€‰æ‹©å™¨
å¤åˆ¶ä»£ç 
```

æ ¹æ®ä»¥ä¸Šä¸¤ä¸ªä¿¡æ¯å¯ä»¥å¾—å‡ºç»“è®ºã€‚

1. é€‰æ‹©å™¨è¶ŠçŸ­è¶Šå¥½ã€‚
2. å°½é‡ä½¿ç”¨é«˜ä¼˜å…ˆçº§çš„é€‰æ‹©å™¨ï¼Œä¾‹å¦‚ ID å’Œç±»é€‰æ‹©å™¨ã€‚
3. é¿å…ä½¿ç”¨é€šé…ç¬¦ *ã€‚

æœ€åè¦è¯´ä¸€å¥ï¼Œæ®æˆ‘æŸ¥æ‰¾çš„èµ„æ–™æ‰€å¾—ï¼ŒCSS é€‰æ‹©å™¨æ²¡æœ‰ä¼˜åŒ–çš„å¿…è¦ï¼Œå› ä¸ºæœ€æ…¢å’Œæ…¢å¿«çš„é€‰æ‹©å™¨æ€§èƒ½å·®åˆ«éå¸¸å°ã€‚

å‚è€ƒèµ„æ–™ï¼š

- [CSS selector performance](https://link.juejin.cn?target=https%3A%2F%2Fecss.io%2Fappendix1.html)
- [Optimizing CSS: ID Selectors and Other Myths](https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Foptimizing-css-id-selectors-and-other-myths%2F)

### 22. ä½¿ç”¨ flexbox è€Œä¸æ˜¯è¾ƒæ—©çš„å¸ƒå±€æ¨¡å‹

åœ¨æ—©æœŸçš„ CSS å¸ƒå±€æ–¹å¼ä¸­æˆ‘ä»¬èƒ½å¯¹å…ƒç´ å®è¡Œç»å¯¹å®šä½ã€ç›¸å¯¹å®šä½æˆ–æµ®åŠ¨å®šä½ã€‚è€Œç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†æ–°çš„å¸ƒå±€æ–¹å¼ [flexbox](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FCSS_Flexible_Box_Layout%2FBasic_Concepts_of_Flexbox)ï¼Œå®ƒæ¯”èµ·æ—©æœŸçš„å¸ƒå±€æ–¹å¼æ¥è¯´æœ‰ä¸ªä¼˜åŠ¿ï¼Œé‚£å°±æ˜¯æ€§èƒ½æ¯”è¾ƒå¥½ã€‚

ä¸‹é¢çš„æˆªå›¾æ˜¾ç¤ºäº†åœ¨ 1300 ä¸ªæ¡†ä¸Šä½¿ç”¨æµ®åŠ¨çš„å¸ƒå±€å¼€é”€ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https:////p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8171c61cb63f4e599bd8e0144371f2dc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ç„¶åæˆ‘ä»¬ç”¨ flexbox æ¥é‡ç°è¿™ä¸ªä¾‹å­ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https:////p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e95eca94007949ee8f0b4f5e7306bbf0~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ç°åœ¨ï¼Œå¯¹äºç›¸åŒæ•°é‡çš„å…ƒç´ å’Œç›¸åŒçš„è§†è§‰å¤–è§‚ï¼Œå¸ƒå±€çš„æ—¶é—´è¦å°‘å¾—å¤šï¼ˆæœ¬ä¾‹ä¸­ä¸ºåˆ†åˆ« 3.5 æ¯«ç§’å’Œ 14 æ¯«ç§’ï¼‰ã€‚

ä¸è¿‡ flexbox å…¼å®¹æ€§è¿˜æ˜¯æœ‰ç‚¹é—®é¢˜ï¼Œä¸æ˜¯æ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒå®ƒï¼Œæ‰€ä»¥è¦è°¨æ…ä½¿ç”¨ã€‚

å„æµè§ˆå™¨å…¼å®¹æ€§ï¼š

- Chrome 29+
- Firefox 28+
- Internet Explorer 11
- Opera 17+
- Safari 6.1+ (prefixed with -webkit-)
- Android 4.4+
- iOS 7.1+ (prefixed with -webkit-)

å‚è€ƒèµ„æ–™ï¼š

- [ä½¿ç”¨ flexbox è€Œä¸æ˜¯è¾ƒæ—©çš„å¸ƒå±€æ¨¡å‹](https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ffundamentals%2Fperformance%2Frendering%2Favoid-large-complex-layouts-and-layout-thrashing%3Fhl%3Dzh-cn)

### 23. ä½¿ç”¨ transform å’Œ opacity å±æ€§æ›´æ”¹æ¥å®ç°åŠ¨ç”»

åœ¨ CSS ä¸­ï¼Œtransforms å’Œ opacity è¿™ä¸¤ä¸ªå±æ€§æ›´æ”¹ä¸ä¼šè§¦å‘é‡æ’ä¸é‡ç»˜ï¼Œå®ƒä»¬æ˜¯å¯ä»¥ç”±åˆæˆå™¨ï¼ˆcompositeï¼‰å•ç‹¬å¤„ç†çš„å±æ€§ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https:////p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/675e5328a6e34e30af51e09689368f7d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å‚è€ƒèµ„æ–™ï¼š

- [ä½¿ç”¨ transform å’Œ opacity å±æ€§æ›´æ”¹æ¥å®ç°åŠ¨ç”»](https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ffundamentals%2Fperformance%2Frendering%2Fstick-to-compositor-only-properties-and-manage-layer-count%3Fhl%3Dzh-cn)

### 24. åˆç†ä½¿ç”¨è§„åˆ™ï¼Œé¿å…è¿‡åº¦ä¼˜åŒ–

æ€§èƒ½ä¼˜åŒ–ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼š

1. åŠ è½½æ—¶ä¼˜åŒ–
2. è¿è¡Œæ—¶ä¼˜åŒ–

ä¸Šè¿° 23 æ¡å»ºè®®ä¸­ï¼Œå±äºåŠ è½½æ—¶ä¼˜åŒ–çš„æ˜¯å‰é¢ 10 æ¡å»ºè®®ï¼Œå±äºè¿è¡Œæ—¶ä¼˜åŒ–çš„æ˜¯åé¢ 13 æ¡å»ºè®®ã€‚é€šå¸¸æ¥è¯´ï¼Œæ²¡æœ‰å¿…è¦ 23 æ¡æ€§èƒ½ä¼˜åŒ–è§„åˆ™éƒ½ç”¨ä¸Šï¼Œæ ¹æ®ç½‘ç«™ç”¨æˆ·ç¾¤ä½“æ¥åšé’ˆå¯¹æ€§çš„è°ƒæ•´æ˜¯æœ€å¥½çš„ï¼ŒèŠ‚çœç²¾åŠ›ï¼ŒèŠ‚çœæ—¶é—´ã€‚

åœ¨è§£å†³é—®é¢˜ä¹‹å‰ï¼Œå¾—å…ˆæ‰¾å‡ºé—®é¢˜ï¼Œå¦åˆ™æ— ä»ä¸‹æ‰‹ã€‚æ‰€ä»¥åœ¨åšæ€§èƒ½ä¼˜åŒ–ä¹‹å‰ï¼Œæœ€å¥½å…ˆè°ƒæŸ¥ä¸€ä¸‹ç½‘ç«™çš„åŠ è½½æ€§èƒ½å’Œè¿è¡Œæ€§èƒ½ã€‚

##### æ£€æŸ¥åŠ è½½æ€§èƒ½

ä¸€ä¸ªç½‘ç«™åŠ è½½æ€§èƒ½å¦‚ä½•ä¸»è¦çœ‹ç™½å±æ—¶é—´å’Œé¦–å±æ—¶é—´ã€‚

- ç™½å±æ—¶é—´ï¼šæŒ‡ä»è¾“å…¥ç½‘å€ï¼Œåˆ°é¡µé¢å¼€å§‹æ˜¾ç¤ºå†…å®¹çš„æ—¶é—´ã€‚
- é¦–å±æ—¶é—´ï¼šæŒ‡ä»è¾“å…¥ç½‘å€ï¼Œåˆ°é¡µé¢å®Œå…¨æ¸²æŸ“çš„æ—¶é—´ã€‚

å°†ä»¥ä¸‹è„šæœ¬æ”¾åœ¨ `` å‰é¢å°±èƒ½è·å–ç™½å±æ—¶é—´ã€‚

```html
<script>
  new Date() - performance.timing.navigationStart
  // é€šè¿‡ domLoading å’Œ navigationStart ä¹Ÿå¯ä»¥
  performance.timing.domLoading - performance.timing.navigationStart
</script>
å¤åˆ¶ä»£ç 
```

åœ¨ `window.onload` äº‹ä»¶é‡Œæ‰§è¡Œ `new Date() - performance.timing.navigationStart` å³å¯è·å–é¦–å±æ—¶é—´ã€‚

##### æ£€æŸ¥è¿è¡Œæ€§èƒ½

é…åˆ chrome çš„å¼€å‘è€…å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ç½‘ç«™åœ¨è¿è¡Œæ—¶çš„æ€§èƒ½ã€‚

æ‰“å¼€ç½‘ç«™ï¼ŒæŒ‰ F12 é€‰æ‹© performanceï¼Œç‚¹å‡»å·¦ä¸Šè§’çš„ç°è‰²åœ†ç‚¹ï¼Œå˜æˆçº¢è‰²å°±ä»£è¡¨å¼€å§‹è®°å½•äº†ã€‚è¿™æ—¶å¯ä»¥æ¨¡ä»¿ç”¨æˆ·ä½¿ç”¨ç½‘ç«™ï¼Œåœ¨ä½¿ç”¨å®Œæ¯•åï¼Œç‚¹å‡» stopï¼Œç„¶åä½ å°±èƒ½çœ‹åˆ°ç½‘ç«™è¿è¡ŒæœŸé—´çš„æ€§èƒ½æŠ¥å‘Šã€‚å¦‚æœæœ‰çº¢è‰²çš„å—ï¼Œä»£è¡¨æœ‰æ‰å¸§çš„æƒ…å†µï¼›å¦‚æœæ˜¯ç»¿è‰²ï¼Œåˆ™ä»£è¡¨ FPS å¾ˆå¥½ã€‚performance çš„å…·ä½“ä½¿ç”¨æ–¹æ³•è¯·ç”¨æœç´¢å¼•æ“æœç´¢ä¸€ä¸‹ï¼Œæ¯•ç«Ÿç¯‡å¹…æœ‰é™ã€‚

é€šè¿‡æ£€æŸ¥åŠ è½½å’Œè¿è¡Œæ€§èƒ½ï¼Œç›¸ä¿¡ä½ å¯¹ç½‘ç«™æ€§èƒ½å·²ç»æœ‰äº†å¤§æ¦‚äº†è§£ã€‚æ‰€ä»¥è¿™æ—¶å€™è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯ä½¿ç”¨ä¸Šè¿° 23 æ¡å»ºè®®å°½æƒ…åœ°å»ä¼˜åŒ–ä½ çš„ç½‘ç«™ï¼ŒåŠ æ²¹ï¼

å‚è€ƒèµ„æ–™ï¼š

- [performance.timing.navigationStart](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FPerformanceTiming%2FnavigationStart)

### ä¸€ã€å¼€åœºç™½

æˆ‘ä¸ªäººè®¤ä¸ºæ€§èƒ½ä¼˜åŒ–å¯ä»¥ä»ä¸‰ä¸ªæ–¹é¢æ¥è¿›è¡Œï¼Œä¸€æ˜¯ä»£ç å±‚é¢çš„ä¼˜åŒ–ï¼ŒäºŒæ˜¯é¡¹ç›®æ‰“åŒ…çš„ä¼˜åŒ–ï¼Œä¸‰æ˜¯é¡¹ç›®éƒ¨ç½²çš„ä¼˜åŒ–ã€‚

å¼€åœºç™½åˆ‡è®°è¦ç®€çŸ­ï¼Œæ¦‚å†µä¸€ä¸‹ä½ æ¥ä¸‹æ¥è¯´çš„å†…å®¹ï¼Œä¸è¦é•¿ç¯‡å¤§è®ºï¼Œé¢è¯•å®˜æ²¡é‚£ä¹ˆå¤šæ—¶é—´å¬ä½ çæ‰¯ã€‚

ä¸‹é¢æ•™å¤§å®¶ä»å¸¸è§ä¼˜åŒ–ä¸€ä¸€è¯´èµ·ã€‚å¦å¤–æ‰€æœ‰ä¼˜åŒ–éƒ½æ˜¯æœ‰åŸç†ï¼Œå¸Œæœ›å¤§å®¶èƒ½æ¥å¾—ä½é¢è¯•å®˜çš„æ·±å±‚æ¬¡çš„è€ƒå¯Ÿã€‚

### äºŒã€ä»£ç å±‚é¢çš„ä¼˜åŒ–

#### 1ã€åˆ©ç”¨v-ifå’Œv-showå‡å°‘åˆå§‹åŒ–æ¸²æŸ“å’Œåˆ‡æ¢æ¸²æŸ“çš„æ€§èƒ½å¼€é”€

åœ¨é¡µé¢åŠ è½½æ—¶ï¼Œåˆ©ç”¨v-ifæ¥æ§åˆ¶ç»„ä»¶ä»…åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æ¸²æŸ“å‡å°‘åˆå§‹åŒ–æ¸²æŸ“ï¼Œéšåç”¨v-showæ¥æ§åˆ¶ç»„ä»¶æ˜¾ç¤ºéšè—å‡å°‘åˆ‡æ¢æ¸²æŸ“çš„æ€§èƒ½å¼€é”€ã€‚

ä¹Ÿè®¸ä¸Šé¢æè¿°ä¸å¤Ÿæ¸…æ¥šï¼Œä¸‹é¢ç”¨ä¸€ä¸ªå®ä¾‹æ¥åŠ æ·±å°è±¡ã€‚

iviewå¼¹çª—ç»„ä»¶å¤§å®¶å¾ˆç»å¸¸ç”¨å§ï¼Œå¼¹çª—ç»„ä»¶æ˜¯ç”¨v-showæ¥æ§åˆ¶å…¶æ˜¾ç¤ºå’Œéšè—ï¼Œé‚£ä¹ˆåœ¨é¡µé¢åŠ è½½æ—¶ï¼Œå¼¹çª—ç»„ä»¶ï¼ˆåŒ…æ‹¬é‡Œé¢çš„å†…å®¹ï¼‰æ˜¯ä¼šè¢«åˆå§‹åŒ–æ¸²æŸ“çš„ï¼Œå¦‚æœä¸€ä¸ªé¡µé¢ä¸­åªæœ‰ä¸€ä¸ªå¼¹çª—ç»„ä»¶ï¼Œä¸ä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ï¼Œä½†æ˜¯å‡å¦‚ä¸€ä¸ªé¡µé¢ä¸­æœ‰å‡ åä¸ªå¼¹çª—ç»„ä»¶ï¼Œä¼šä¸ä¼šå½±å“åˆ°æ€§èƒ½ï¼Œå¤§å®¶å¯ä»¥åšä¸€ä¸ªå³é”®èœå•å»è¯•ä¸€ä¸‹ã€‚

ps: å·å·å‘Šè¯‰å¤§å®¶ï¼Œelementå¼¹çª—ç»„ä»¶åˆæ¬¡æ¸²æŸ“æ—¶ï¼Œå¼¹çª—bodyé‡Œé¢çš„å†…å®¹ä¸ä¼šè¢«æ¸²æŸ“çš„ã€‚

ä¸‹é¢ç”¨ä»£ç æ¥å®ç°ä¸€ä¸‹ã€‚

```xml
<template>
    <div>
        <Button type="primary" @click.native="add">æ·»åŠ </Button>
        <add v-model="add.show" v-bind="add"></add>
    </div>
</template>
<script>
export default{
    data(){
        return{
            add:{
                show:false,
                init:false
            }
        }
    },
    components:{
        add:() =>import('./add.vue')
    },
    methods:{
        add(){
            this.add.show=true;
            this.add.init=true
        }
    }
}
</script>
å¤åˆ¶ä»£ç 
<template>
    <div v-if="init">
        <Modal v-model="show" title="æ·»åŠ " @on-cancel="handleClose"></Modal>
    </div>
</template>
<script>
export default{
    props:{
        value:{
            type:Boolean,
            default:false
        },
        init:{
            type:Boolean,
            default:false
        }
    },
    data(){
        return{
            show:false,
        }
    },
    watch:{
        value(val){
            if(val){
                this.show = val;
            }
        }  
    },
    methods:{
        handleClose(val) {
            this.$emit('input', val);
        },
    }
}
</script>
å¤åˆ¶ä»£ç 
```

**åŸç†ï¼š**

> `v-if`ç»‘å®šå€¼ä¸ºfalseæ—¶ï¼Œåˆå§‹æ¸²æŸ“æ—¶ï¼Œ**ä¸ä¼š**æ¸²æŸ“å…¶æ¡ä»¶å—ã€‚

> `v-if`ç»‘å®šå€¼ï¼Œåœ¨trueå’Œfalseä¹‹é—´åˆ‡æ¢æ—¶ï¼Œ**ä¼š**é”€æ¯å’Œé‡æ–°æ¸²æŸ“å…¶æ¡ä»¶å—ã€‚

> `v-show`ç»‘å®šå€¼ä¸ç®¡ä¸ºtrueè¿˜æ˜¯ä¸ºfalseï¼Œåˆå§‹æ¸²æŸ“æ—¶ï¼Œæ€»æ˜¯**ä¼š**æ¸²æŸ“å…¶æ¡ä»¶å—ã€‚

> `v-show`ç»‘å®šå€¼ï¼Œåœ¨trueå’Œfalseä¹‹é—´åˆ‡æ¢æ—¶ï¼Œ**ä¸ä¼š**é”€æ¯å’Œé‡æ–°æ¸²æŸ“å…¶æ¡ä»¶å—ï¼Œåªæ˜¯ç”¨`display:none`æ ·å¼æ¥æ§åˆ¶å…¶æ˜¾ç¤ºéšè—ã€‚

#### 2ã€computedã€watchã€methodsåŒºåˆ†ä½¿ç”¨åœºæ™¯

å¯¹äºæœ‰äº›éœ€æ±‚ï¼Œcomputedã€watchã€methodséƒ½å¯ä»¥å®ç°ï¼Œä½†æ˜¯è¿˜æ˜¯è¦åŒºåˆ†ä¸€ä¸‹ä½¿ç”¨åœºæ™¯ã€‚ç”¨é”™åœºæ™¯è™½ç„¶åŠŸèƒ½å®ç°äº†ä½†æ˜¯å½±å“äº†æ€§èƒ½ã€‚

- ```
  computed
  ```

  ï¼š 

  - ä¸€ä¸ªæ•°æ®å—å¤šä¸ªæ•°æ®å½±å“çš„ã€‚
  - è¯¥æ•°æ®è¦ç»è¿‡æ€§èƒ½å¼€é”€æ¯”è¾ƒå¤§çš„è®¡ç®—ï¼Œå¦‚å®ƒéœ€è¦éå†ä¸€ä¸ªå·¨å¤§çš„æ•°ç»„å¹¶åšå¤§é‡çš„è®¡ç®—æ‰èƒ½å¾—åˆ°ï¼Œè¿™æ—¶å°±å¯ä»¥åˆ©ç”¨`computed`çš„ç¼“å­˜ç‰¹æ€§ï¼Œåªæœ‰å®ƒè®¡ç®—æ—¶ä¾èµ–çš„æ•°æ®å‘ç°å˜åŒ–æ—¶æ‰ä¼šé‡æ–°è®¡ç®—ï¼Œå¦åˆ™ç›´æ¥è¿”å›ç¼“å­˜å€¼ã€‚

- ```
  watch
  ```

  ï¼š 

  - ä¸€ä¸ªæ•°æ®å½±å“å¤šä¸ªæ•°æ®çš„ã€‚
  - å½“æ•°æ®å˜åŒ–æ—¶ï¼Œéœ€è¦æ‰§è¡Œå¼‚æ­¥æˆ–å¼€é”€è¾ƒå¤§çš„æ“ä½œæ—¶ã€‚å¦‚æœæ•°æ®å˜åŒ–æ—¶è¯·æ±‚ä¸€ä¸ªæ¥å£ã€‚

- ```
  methods
  ```

  ï¼š 

  - å¸Œæœ›æ•°æ®æ˜¯å®æ—¶æ›´æ–°ï¼Œä¸éœ€è¦ç¼“å­˜ã€‚

#### 3ã€æå‰å¤„ç†å¥½æ•°æ®è§£å†³v-ifå’Œv-forå¿…é¡»åŒçº§çš„é—®é¢˜

å› ä¸ºå½“Vueå¤„ç†æŒ‡ä»¤æ—¶ï¼Œ`v-for`æ¯”`v-if`å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œæ„å‘³ç€`v-if` å°†åˆ†åˆ«é‡å¤è¿è¡Œäºæ¯ä¸ª`v-for`å¾ªç¯ä¸­ã€‚

å¯ä»¥åœ¨computedä¸­æå‰æŠŠè¦`v-for`çš„æ•°æ®ä¸­`v-if`çš„æ•°æ®é¡¹ç»™è¿‡æ»¤å¤„ç†äº†ã€‚

```xml
//userList.vue
<template>
    <div>
        <div v-for="item in userList" :key="item.id" v-if="item.age > 18">{{ item.name }}</div>
    </div>
</template>
å¤åˆ¶ä»£ç 
//userList.vue
<template>
    <div>
        <div v-for="item in userComputedList" :key="item.id">{{ item.name }}</div>
    </div>
</template>
export default {
    computed:{
        userComputedList:function(){
            return this.userList.filter(function (item) {
                return item.age > 18
            })
        }
    }
}
å¤åˆ¶ä»£ç 
```

ä¹Ÿè®¸é¢è¯•å®˜è¿˜ä¼šä¸ºä»€ä¹ˆ`v-for`æ¯”`v-if`å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Ÿè¿™ä¸ªé—®é¢˜å·²ç»æ¶‰åŠåˆ°åŸç†å±‚æ¬¡ï¼Œå¦‚æœè¿™ä¸ªä¹Ÿä¼šå›ç­”ï¼Œä¼šç»™é¢è¯•åŠ åˆ†ä¸å°‘ã€‚

ä¸Šé¢è¯´åˆ° â€œ`v-if`å°†åˆ†åˆ«é‡å¤è¿è¡Œäºæ¯ä¸ª`v-for`å¾ªç¯ä¸­â€ï¼Œè¿™ä¸ªè¿‡ç¨‹åªæœ‰åœ¨æ¸²æŸ“é¡µé¢æ—¶æ‰æœ‰ï¼Œè€ŒVueæœ€ç»ˆæ˜¯é€šè¿‡renderå‡½æ•°æ¥æ¸²æŸ“é¡µé¢çš„ï¼Œå…ˆæŠŠç»„ä»¶ç¼–è¯‘ç”Ÿæˆçš„renderæ‰“å°å‡ºæ¥ã€‚

```xml
//home.vue
<script>
import userList from './userList'
console.log(userList.render)
</script>
å¤åˆ¶ä»£ç 
```

æ‰“å°å‡ºæ¥çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤º

```javascript
var render = function() {
  var _vm = this
  var _h = _vm.$createElement
  var _c = _vm._self._c || _h
  return _c(
    "div",
    _vm._l(_vm.userList, function(item) {
      return item.age > 18
        ? _c("div", { key: item.id }, [_vm._v(_vm._s(item.name))])
        : _vm._e()
    }),
    0
  )
}
var staticRenderFns = []
render._withStripped = true
export { render, staticRenderFns }
å¤åˆ¶ä»£ç 
```

å…¶ä¸­`_l`æ–¹æ³•æ˜¯`v-for`æŒ‡ä»¤é€šè¿‡`genFor`å‡½æ•°ç”Ÿæˆçš„renderListæ–¹æ³•ï¼Œ`item.age > 18? `æ˜¯`v-if`æŒ‡ä»¤é€šè¿‡`genIf`å‡½æ•°ç”Ÿæˆçš„ä¸‰å…ƒè¿ç®—ç¬¦çš„ä»£ç ï¼Œ`_v`æ–¹æ³•æ˜¯createTextVNodeæ–¹æ³•ç”¨æ¥åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹ï¼Œ`_e`æ–¹å¼æ˜¯createEmptyVNodeæ–¹æ³•ç”¨æ¥åˆ›å»ºç©ºèŠ‚ç‚¹ã€‚åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯å·²ç»å¾ˆæ¸…æ¥šï¼Œ`v-if`è¿è¡Œåœ¨æ¯ä¸ª`v-for`ä¸­ã€‚

å½’æ ¹åˆ°åº•è¿˜æ˜¯åœ¨ç”Ÿæˆrenderå‡½æ•°ä¸­ï¼Œå¯¼è‡´`v-for`æ¯”`v-if`å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬å»renderå‡½æ•°çš„ç”Ÿæˆè¿‡ç¨‹ä¸­çœ‹ä¸€ä¸‹ã€‚

Vueæä¾›äº†2ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯Runtime + Compiler çš„ï¼Œä¸€ä¸ªæ˜¯ Runtime only çš„ï¼Œå‰è€…æ˜¯åŒ…å«ç¼–è¯‘ä»£ç çš„ï¼Œå¯ä»¥æŠŠç¼–è¯‘è¿‡ç¨‹æ”¾åœ¨è¿è¡Œæ—¶åšï¼Œåè€…æ˜¯ä¸åŒ…å«ç¼–è¯‘ä»£ç çš„ï¼Œéœ€è¦å€ŸåŠ© webpack çš„ vue-loader äº‹å…ˆæŠŠæ¨¡æ¿ç¼–è¯‘æˆ renderå‡½æ•°ã€‚

è¿™é‡Œä¸ç ”ç©¶vue-loaderï¼Œæ‰€ä»¥ç”¨Runtime + Compileræ¥ç ”ç©¶ï¼Œä¹Ÿæ˜¯ç”¨CDNå¼•å…¥Vue.jsï¼Œæ­¤æ—¶Vueçš„å…¥å£åœ¨*src/platforms/web/entry-runtime-with-compiler.js*ä¸­ã€‚

```ini
const vm = new Vue({
    render: h => h(App)
}).$mount('#app')
å¤åˆ¶ä»£ç 
```

Vueå®ä¾‹æ˜¯é€šè¿‡`$mount`æŒ‚è½½åˆ°DOMä¸Šã€‚åœ¨å…¥å£æ–‡ä»¶ä¸­å¯»æ‰¾`$mount`æ–¹æ³•ï¼Œåœ¨å…¶æ–¹æ³•ä¸­å†æ‰¾`render`å­—æ®µï¼Œå‘ç°ä»¥ä¸‹ä»£ç 

```arduino
const { render, staticRenderFns } = compileToFunctions(template, {
    outputSourceRange: process.env.NODE_ENV !== 'production',
    shouldDecodeNewlines,
    shouldDecodeNewlinesForHref,
    delimiters: options.delimiters,
    comments: options.comments
}, this)
options.render = render
options.staticRenderFns = staticRenderFns
å¤åˆ¶ä»£ç 
```

è¯´æ˜renderå‡½æ•°æ˜¯é€šè¿‡compileToFunctionsæ–¹æ³•ç”Ÿæˆï¼Œå†å»å¯»æ‰¾compileToFunctionsæ–¹æ³•åœ¨å“ªé‡Œã€‚

compileToFunctionsæ–¹æ³•åœ¨*src/platforms/web/compiler/index.js*ä¸­å®šä¹‰ã€‚

```arduino
const { compile, compileToFunctions } = createCompiler(baseOptions)
export { compile, compileToFunctions }
å¤åˆ¶ä»£ç 
```

compileToFunctionsæ–¹æ³•åˆæ˜¯createCompileræ–¹æ³•ç”Ÿæˆçš„ï¼Œç»§ç»­å¯»æ‰¾createCompileræ–¹æ³•ã€‚

createCompileræ–¹æ³•åœ¨*src/compiler/index.js*ä¸­å®šä¹‰ã€‚

```scss
export const createCompiler = createCompilerCreator(
    function baseCompile(template,options) {
        const ast = parse(template.trim(), options)
        if (options.optimize !== false) {
            optimize(ast, options)
        }
        const code = generate(ast, options)
        return {
            ast,
            render: code.render,
            staticRenderFns: code.staticRenderFns
        }
})
å¤åˆ¶ä»£ç 
```

åœ¨ä¸Šé¢ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œrenderæ˜¯codeä¸­çš„renderï¼Œè€Œcodeæ˜¯generateæ–¹æ³•ç”Ÿæˆçš„ã€‚

åœ¨è¿™é‡Œé¢å¤–æä¸€ä¸‹astæ˜¯ä»€ä¹ˆï¼Œå°±æ˜¯ç”±tempalteç”Ÿæˆçš„è¯­æ³•ä¹¦ï¼Œåœ¨æ‰§è¡Œgenerateæ–¹æ³•å‰æ‰§è¡Œä»¥ä¸‹å‡ ä¸ªé€»è¾‘

- è§£ææ¨¡æ¿å­—ç¬¦ä¸²ç”Ÿæˆ ast `const ast = parse(template.trim(), options)`ã€‚
- ä¼˜åŒ–è¯­æ³•æ ‘ `optimize(ast, options)`ã€‚
- ç”Ÿæˆrenderå‡½æ•°ä»£ç `const code = generate(ast, options)`ã€‚

ç»§ç»­å¯»æ‰¾generateæ–¹æ³•ï¼Œå…¶åœ¨*src/compiler/codegen/index.js*ä¸­å®šä¹‰ã€‚

```arduino
export function generate (ast,options){
    const state = new CodegenState(options)
    const code = ast ? genElement(ast, state) : '_c("div")'
    return {
        render: `with(this){return ${code}}`,
        staticRenderFns: state.staticRenderFns
    }
}
å¤åˆ¶ä»£ç 
```

å‘ç°codeæ˜¯genElementæ–¹æ³•ç”Ÿæˆçš„ï¼Œç»§ç»­å¯»æ‰¾genElementæ–¹æ³•ï¼Œå…¶å®è¿™é‡Œå·²ç»è§£å†³æ ¹æœ¬åŸå› äº†ï¼Œç»™å‡ºå‡ è¡Œå…³é”®ä»£ç ã€‚

```scss
export function genElement(el,state){
    if(){
    //...
    }else if (el.for && !el.forProcessed) {
        return genFor(el, state)
    } else if (el.if && !el.ifProcessed) {
        return genIf(el, state)
    } 
}
å¤åˆ¶ä»£ç 
```

ç”±ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œel.forå°±æ˜¯`v-for`ï¼Œel.ifå°±æ˜¯`v-if`ï¼Œel.forå…ˆäºel.ifåˆ¤æ–­æ‰§è¡Œï¼Œæ‰€ä»¥`v-for`æ¯”`v-if`å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚

å¦å¤–åœ¨genForæ–¹æ³•æœ€åé¢ä¼šç»§ç»­è°ƒç”¨genElementæ–¹æ³•ï¼Œå½¢æˆä¸€çº§ä¸€çº§å¾€ä¸‹æ‰§è¡Œã€‚

```javascript
return `${altHelper || '_l'}((${exp}),` +
    `function(${alias}${iterator1}${iterator2}){` +
    `return ${(altGen || genElement)(el, state)}` +
'})'
å¤åˆ¶ä»£ç 
```

> æŠŠå¯»æ‰¾åŸå› çš„æ•´ä¸ªæ€è·¯éƒ½å†™å‡ºæ¥ï¼Œå°±æ˜¯è®©å°ä¼™ä¼´åœ¨çœ‹é¢è¯•é¢˜æ—¶ä¸è¦æ­»è®°ç¡¬èƒŒï¼Œè¦å»ç†è§£ï¼Œå¯ä»¥æŒ‰ç…§ä¸Šé¢çš„æ€è·¯ï¼Œè‡ªå·±å»é˜…è¯»æºç æ‰¾ä¸€ä¸‹åŸå› ã€‚æ¯•ç«Ÿé˜…è¯»æºç èƒ½åŠ›ä¹Ÿæ˜¯å¯ä»¥ä¸ºé¢è¯•åŠ åˆ†çš„ã€‚

#### 4ã€ç»™v-forå¾ªç¯é¡¹åŠ ä¸Škeyæé«˜diffè®¡ç®—é€Ÿåº¦

ä¸€æ—¦ä½ ç»™é¢è¯•å®˜è®²äº†æ­¤é¡¹ä¼˜åŒ–ï¼Œä½ è¦åšå¥½è¢«é¢è¯•å®˜æ·±å…¥æé—®çš„å‡†å¤‡å¦‚ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ã€‚

- ä¸ºä»€ä¹ˆåŠ keyä¼šæé«˜diffè®¡ç®—é€Ÿåº¦ã€‚

  ç»è¿‡æ—§å¤´æ–°å¤´ã€æ—§å°¾æ–°å°¾ã€æ—§å¤´æ–°å°¾ã€æ—§å°¾æ–°å¤´å››æ¬¡äº¤å‰æ¯”å¯¹åï¼Œéƒ½æ²¡æœ‰åŒ¹é…åˆ°å€¼å¾—æ¯”å¯¹çš„èŠ‚ç‚¹ï¼Œè¿™æ—¶å¦‚æœæ–°èŠ‚ç‚¹æœ‰keyçš„è¯ã€‚å¯ä»¥é€šè¿‡mapç›´æ¥è·å¾—å€¼å¾—å¯¹æ¯”çš„æ—§èŠ‚ç‚¹çš„ä¸‹æ ‡ï¼Œå¦‚æœæ²¡æœ‰keyçš„è¯ï¼Œå°±è¦é€šè¿‡å¾ªç¯æ—§èŠ‚ç‚¹æ•°ç»„ç”¨sameVnodeæ–¹æ³•åˆ¤æ–­æ–°èŠ‚ç‚¹å’Œè¯¥æ—§èŠ‚ç‚¹æ˜¯å¦å€¼å¾—æ¯”è¾ƒï¼Œå€¼å¾—å°±è¿”å›è¯¥æ—§èŠ‚ç‚¹çš„ä¸‹æ ‡ã€‚æ˜¾ç„¶é€šè¿‡mapæ¯”é€šè¿‡å¾ªç¯æ•°ç»„çš„è®¡ç®—é€Ÿåº¦æ¥çš„å¿«ã€‚

- ä»€ä¹ˆæ˜¯diffè®¡ç®—ã€‚

  å¯¹äºæ¸²æŸ“watcherè§¦å‘æ—¶ä¼šæ‰§è¡Œ`vm._update(vm._render(), hydrating)`ï¼Œåœ¨`vm._undata`æ–¹æ³•ä¸­ä¼šè°ƒç”¨`vm.__patch__`ï¼Œè€Œ`vm.__patch__`æŒ‡å‘patchæ–¹æ³•ï¼Œdiffè®¡ç®—æ˜¯æŒ‡åœ¨è°ƒç”¨patchæ–¹æ³•å¼€å§‹ï¼Œç”¨sameVnodeæ–¹æ³•åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å€¼å¾—æ¯”è¾ƒï¼Œè‹¥ä¸å€¼å¾—ç›´æ¥æ–°èŠ‚ç‚¹æ›¿æ¢æ—§èŠ‚ç‚¹åç»“æŸã€‚å€¼å¾—å¯¹æ¯”è¿›å…¥patchVnodeæ–¹æ³•ï¼Œåˆ†åˆ«å¤„ç†ä¸€ä¸‹å‡ ç§æƒ…å†µï¼Œè‹¥æ–°æ—§èŠ‚ç‚¹éƒ½æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ–°èŠ‚ç‚¹ä¸‹çš„æ–‡æœ¬èŠ‚ç‚¹ç›´æ¥æ›¿æ¢æ—§èŠ‚ç‚¹ä¸‹çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œå¦‚æœæ–°èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹ï¼Œæ—§èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç›´æ¥æŠŠæ–°èŠ‚ç‚¹æŸ¥åˆ°æ—§èŠ‚ç‚¹çš„çˆ¶çº§ä¸­ï¼Œå¦‚æœæ–°èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œæ—§èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ—§èŠ‚ç‚¹çš„çˆ¶çº§ä¸‹çš„å­èŠ‚ç‚¹éƒ½åˆ äº†ã€‚å¦‚æœæ–°æ—§èŠ‚ç‚¹éƒ½æœ‰å­èŠ‚ç‚¹ï¼Œè¿›å…¥updateChildrenæ–¹æ³•ï¼Œé€šè¿‡æ—§å¤´æ–°å¤´ã€æ—§å°¾æ–°å°¾ã€æ—§å¤´æ–°å°¾ã€æ—§å°¾æ–°å¤´å››æ¬¡äº¤å‰æ¯”å¯¹ï¼Œå¦‚æœå€¼å¾—å¯¹æ¯”å†è¿›å…¥patchVnodeæ–¹æ³•ï¼Œå¦‚æœéƒ½ä¸å€¼å¾—å¯¹æ¯”ï¼Œæœ‰keyç”¨mapè·å¾—å€¼å¾—å¯¹æ¯”çš„æ—§èŠ‚ç‚¹ï¼Œæ²¡æœ‰keyé€šè¿‡å¾ªç¯æ—§èŠ‚ç‚¹è·å¾—å€¼å¾—å¯¹æ¯”çš„æ—§èŠ‚ç‚¹ã€‚å½“æ–°èŠ‚ç‚¹éƒ½å¯¹æ¯”å®Œï¼Œæ—§èŠ‚ç‚¹è¿˜æ²¡å¯¹æ¯”å®Œï¼Œå°†è¿˜æ²¡å¯¹æ¯”å®Œçš„æ—§èŠ‚ç‚¹åˆ æ‰ã€‚å½“æ—§èŠ‚ç‚¹éƒ½å¯¹æ¯”å®Œï¼Œæ–°èŠ‚ç‚¹è¿˜æ²¡å¯¹æ¯”å®Œï¼Œå°†æ–°èŠ‚ç‚¹æ·»åŠ åˆ°æœ€åä¸€ä¸ªå¯¹æ¯”è¿‡çš„æ–°èŠ‚ç‚¹åé¢ï¼Œå®Œæˆdiffè®¡ç®—ã€‚

è¿™ä¸¤ä¸ªé—®é¢˜æ˜¯å¯ä»¥è¿ç»­æé—®ï¼Œä¸€æ—¦ä½ ç­”å‡ºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå¯èƒ½ä¼šè¢«ç»§ç»­æ·±å…¥æé—®ç¬¬äºŒä¸ªé—®é¢˜ã€‚

ä»¥ä¸‹æ˜¯è¯¦ç»†è¿‡ç¨‹ï¼Œé¢è¯•ä¸­ä¹Ÿä¸å¯èƒ½è¡¨è¿°é‚£ä¹ˆè¯¦ç»†ã€‚ä¸»è¦æ˜¯æä¾›ç»™å¤§å®¶ç†è§£ç”¨ã€‚

é¦–å…ˆä»‹ç»ä¸€ä¸‹ä»€ä¹ˆdiffè®¡ç®—ï¼Œdiffè®¡ç®—å°±æ˜¯å¯¹æ¯”æ–°æ—§è™šæ‹ŸDOMï¼ˆvirtual DOMï¼‰ï¼Œvirtual DOMæ˜¯å°†çœŸå®çš„DOMçš„æ•°æ®æŠ½å–å‡ºæ¥ï¼Œä»¥å¯¹è±¡çš„å½¢å¼æ¨¡æ‹Ÿæ ‘å½¢ç»“æ„ï¼Œå†è¯´ç®€ç™½ä¸€ç‚¹ï¼Œdiffè®¡ç®—å°±æ˜¯å¯¹ä¸¤ä¸ªå¯¹è±¡è¿›è¡Œå¯¹æ¯”ã€‚

åœ¨é‡‡å–diffç®—æ³•æ¯”è¾ƒæ–°æ—§èŠ‚ç‚¹çš„æ—¶å€™ï¼Œæ¯”è¾ƒåªä¼šåœ¨åŒå±‚çº§è¿›è¡Œ, ä¸ä¼šè·¨å±‚çº§æ¯”è¾ƒã€‚ ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2434e64f4e114b66a506229959e54c5e~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) å…ˆä¸Šæ­¥éª¤å›¾ï¼Œå¯ä»¥å…ˆçœ‹å›¾ï¼Œå†çœ‹æ–‡å­—ä»‹ç» ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3855e292967441f3b9d28e3cb6e341c7~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5f6a50d6a3614a4ca366a138684f8bb3~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) ![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/213b5ca1a7fb4a089b13c8734d6bd522~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) ![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e4c54942bc1f4ce8b71892e299979b52~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) ![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/472639c8f3394f4994afcc9ad626f0ac~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5169774f27f349e58974aeead903b7ae~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) æ¯æ¬¡å¯¹æ¯”çš„é€»è¾‘å¤§æ¦‚å¦‚ä¸‹æ‰€ç¤º

- 1ã€åœ¨patchæ–¹æ³•å†…ï¼Œç”¨sameVnodeåˆ¤æ–­æ–°æ—§èŠ‚ç‚¹æ˜¯å¦å€¼å¾—æ¯”è¾ƒã€‚
- 2ã€å¦‚æœä¸å€¼å¾—æ¯”è¾ƒï¼Œç›´æ¥åœ¨æ—§èŠ‚ç‚¹çš„çˆ¶çº§ä¸­æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œç„¶ååˆ é™¤æ—§èŠ‚ç‚¹ï¼Œé€€å‡ºå¯¹æ¯”ã€‚
- 3ã€å¦‚æœå€¼å¾—æ¯”è¾ƒï¼Œè°ƒç”¨patchVnodeæ–¹æ³•ã€‚
- 4ã€å¦‚æœæ–°æ—§èŠ‚ç‚¹æ˜¯å¦å®Œå…¨ç›¸ç­‰ï¼Œå¦‚æœæ˜¯ï¼Œé€€å‡ºå¯¹æ¯”ã€‚
- 5ã€å¦‚æœä¸æ˜¯ï¼Œæ‰¾åˆ°å¯¹åº”çš„çœŸå®DOMï¼Œè®°ä¸ºelã€‚
- 6ã€å¦‚æœæ–°æ—§èŠ‚ç‚¹éƒ½æœ‰æ–‡æœ¬èŠ‚ç‚¹å¹¶ä¸”ä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆå°†elçš„æ–‡æœ¬èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°èŠ‚ç‚¹çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œé€€å‡ºå¯¹æ¯”ã€‚
- 7ã€å¦‚æœæ–°èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹ï¼Œæ—§èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œåˆ™å°†æ–°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ç”ŸæˆçœŸå®DOMåæ·»åŠ åˆ°elä¸­ï¼Œé€€å‡ºå¯¹æ¯”ã€‚
- 8ã€å¦‚æœæ–°èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œæ—§èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹ï¼Œåˆ™åˆ é™¤elçš„å­èŠ‚ç‚¹ï¼Œé€€å‡ºå¯¹æ¯”ã€‚
- 9ã€å¦‚æœæ–°èŠ‚ç‚¹å’Œæ—§èŠ‚ç‚¹éƒ½æœ‰å­èŠ‚ç‚¹ï¼Œåˆ™å¼€å§‹å¯¹æ¯”å®ƒä»¬çš„å­èŠ‚ç‚¹ï¼Œç”¨çš„æ˜¯updateChildrenæ–¹æ³•ã€‚
- 10ã€å°†æ—§èŠ‚ç‚¹çš„å­èŠ‚ç‚¹è®°ä¸º`oldCh`æ˜¯ä¸ªæ•°ç»„,å…¶å¤´éƒ¨ç”¨`oldCh[oldStartIdx]`è·å–è®°ä¸º`oldStartVnode`ï¼Œ`oldStartIdx`åˆå§‹ä¸º0ã€‚å…¶å°¾éƒ¨ç”¨`oldCh[oldEndIdx]`è·å–è®°ä¸º`oldEndVnode`ï¼Œ`oldEndIdx`åˆå§‹ä¸º`oldCh.length - 1`ã€‚
- 11ã€å°†æ—§èŠ‚ç‚¹çš„å­èŠ‚ç‚¹è®°ä¸º`newCh`æ˜¯ä¸ªæ•°ç»„,å…¶å¤´éƒ¨ç”¨`newCh[newStartIdx]`è·å–è®°ä¸º`newStartVnode`ï¼Œ`newStartIdx`åˆå§‹ä¸º0ã€‚å…¶å°¾éƒ¨ç”¨`newCh[newEndIdx]`è·å–è®°ä¸º`newEndVnode`ï¼Œ`newEndIdx`åˆå§‹ä¸º`newCh.length - 1`ã€‚
- 12ã€å°†æ—§å­èŠ‚ç‚¹çš„å¤´éƒ¨å’Œæ–°å­èŠ‚ç‚¹çš„å¤´éƒ¨ï¼Œç®€ç§°æ—§å¤´å’Œæ–°å¤´ç”¨sameVnodeåˆ¤æ–­æ˜¯å¦å€¼å¾—æ¯”è¾ƒã€‚
- 13ã€å¦‚æœå€¼å¾—æ¯”è¾ƒï¼Œè°ƒç”¨patchVnodeæ–¹æ³•ï¼Œé‡æ–°æ‰§è¡Œç¬¬3æ­¥ã€‚åŒæ—¶ç”¨`oldCh[++oldStartIdx]`é‡æ–°è·å–æ—§å­èŠ‚ç‚¹å¤´éƒ¨ï¼Œç”¨`newCh[++newStartIdx]`é‡æ–°è·å–æ–°å­èŠ‚ç‚¹å¤´éƒ¨ã€‚
- 14ã€å¦‚æœä¸å€¼å¾—æ¯”è¾ƒï¼Œå°†æ—§å­èŠ‚ç‚¹çš„å°¾éƒ¨å’Œæ–°å­èŠ‚ç‚¹çš„å°¾éƒ¨ï¼Œç®€ç§°æ—§å°¾å’Œæ–°å°¾ç”¨sameVnodeåˆ¤æ–­æ˜¯å¦å€¼å¾—æ¯”è¾ƒã€‚
- 15ã€å¦‚æœå€¼å¾—æ¯”è¾ƒï¼Œè°ƒç”¨patchVnodeæ–¹æ³•ï¼Œé‡æ–°æ‰§è¡Œç¬¬3æ­¥ã€‚åŒæ—¶ç”¨`oldCh[--oldEndIdx]`é‡æ–°è·å–æ—§å­èŠ‚ç‚¹å°¾éƒ¨ï¼Œé‡æ–°ç”¨`newCh[--newEndIdx]`è·å–æ–°å­èŠ‚ç‚¹å°¾éƒ¨ã€‚
- 16ã€å¦‚æœä¸å€¼å¾—æ¯”è¾ƒï¼Œå°†æ—§å­èŠ‚ç‚¹çš„å¤´éƒ¨å’Œæ–°å­èŠ‚ç‚¹çš„å°¾éƒ¨ï¼Œç®€ç§°æ—§å¤´å’Œæ–°å°¾ç”¨sameVnodeåˆ¤æ–­æ˜¯å¦å€¼å¾—æ¯”è¾ƒã€‚
- 17ã€å¦‚æœå€¼å¾—æ¯”è¾ƒï¼Œè°ƒç”¨patchVnodeæ–¹æ³•ï¼Œé‡æ–°æ‰§è¡Œç¬¬3æ­¥ã€‚åŒæ—¶å°†æ—§å­èŠ‚ç‚¹çš„å¤´éƒ¨`oldStartVnode`å¯¹åº”çš„çœŸå®DOMç§»åŠ¨åˆ°æ—§å­èŠ‚ç‚¹çš„å°¾éƒ¨`oldEndVnode`å¯¹åº”çš„çœŸå®DOMåé¢ã€‚åŒæ—¶ç”¨`oldCh[++oldStartIdx]`é‡æ–°è·å–æ—§å­èŠ‚ç‚¹å¤´éƒ¨ï¼Œç”¨`newCh[--newEndIdx]`é‡æ–°è·å–æ–°å­èŠ‚ç‚¹å°¾éƒ¨ã€‚
- 18ã€å¦‚æœä¸å€¼å¾—æ¯”è¾ƒï¼Œå°†æ—§å­èŠ‚ç‚¹çš„å°¾éƒ¨å’Œæ–°å­èŠ‚ç‚¹çš„å¤´éƒ¨ï¼Œç®€ç§°æ—§å°¾å’Œæ–°å¤´ç”¨sameVnodeåˆ¤æ–­æ˜¯å¦å€¼å¾—æ¯”è¾ƒã€‚
- 19ã€å¦‚æœå€¼å¾—æ¯”è¾ƒï¼Œè°ƒç”¨patchVnodeæ–¹æ³•ï¼Œé‡æ–°æ‰§è¡Œç¬¬3æ­¥ã€‚åŒæ—¶å°†æ—§å­èŠ‚ç‚¹çš„å°¾éƒ¨`oldEndVnode`å¯¹åº”çš„çœŸå®DOMç§»åŠ¨åˆ°æ—§å­èŠ‚ç‚¹çš„å¤´éƒ¨`oldStartVnode`å¯¹åº”çš„çœŸå®DOMåé¢ã€‚åŒæ—¶ç”¨`oldCh[--oldEndIdx]`é‡æ–°è·å–æ—§å­èŠ‚ç‚¹å°¾éƒ¨ï¼Œç”¨`newCh[++newStartIdx]`é‡æ–°è·å–æ–°å­èŠ‚ç‚¹å¤´éƒ¨ã€‚
- 20ã€å¦‚æœä¸å€¼å¾—æ¯”è¾ƒï¼Œå¦‚æœæ—§å­èŠ‚ç‚¹æœ‰keyï¼Œå¯ä»¥ç”¨createKeyToOldIdxæ–¹æ³•è·å¾—ä»¥æ—§å­èŠ‚ç‚¹çš„keyä¸ºå¥ï¼Œå…¶ä¸‹æ ‡ä¸ºå€¼çš„mapç»“æ„,è®°ä¸º`oldKeyToIdx`ã€‚
- 21ã€å¦‚æœæ–°å­èŠ‚ç‚¹çš„å¤´éƒ¨`newStartVnode`æœ‰keyå±æ€§ï¼Œç›´æ¥é€šè¿‡`oldKeyToIdx[newStartVnode.key]`è·å–å¯¹åº”çš„ä¸‹æ ‡`idxInOld`ã€‚
- 22ã€å¦‚æœæ–°å­èŠ‚ç‚¹çš„å¤´éƒ¨`newStartVnode`æ²¡æœ‰keyå±æ€§ï¼Œè¦ç”¨è¿‡findIdxInOldæ–¹æ³•ï¼Œæ‰¾åˆ°å€¼å¾—å¯¹æ¯”çš„æ—§å­èŠ‚ç‚¹å¯¹åº”çš„ä¸‹æ ‡`idxInOld`ã€‚
- 23ã€ç»è¿‡æŸ¥æ‰¾ã€‚å¦‚æœ`idxInOld`ä¸å­˜åœ¨ã€‚åˆ™è°ƒç”¨createElmæ–¹æ³•ç›´æ¥ç”Ÿæˆ`newStartVnode`å¯¹åº”çš„çœŸå®DOMæ’å…¥`oldStartVnode`å¯¹åº”çœŸå®DOMå‰é¢ã€‚
- 24ã€å¦‚æœ`idxInOld`å­˜åœ¨ï¼Œåˆ™æŠŠç”¨é€šè¿‡`oldCh[idxInOld]`è·å–åˆ°Vnodeè®°ä¸º`vnodeToMove`å’Œ`newStartVnode`ç”¨sameVnodeåˆ¤æ–­æ˜¯å¦å€¼å¾—æ¯”è¾ƒã€‚
- 25ã€å¦‚æœå€¼å¾—æ¯”è¾ƒï¼Œè°ƒç”¨patchVnodeæ–¹æ³•ï¼Œé‡æ–°æ‰§è¡Œç¬¬3æ­¥ã€‚åŒæ—¶æ‰§è¡Œ`oldCh[idxInOld] = undefined`ï¼Œå…å¾—è¢«é‡å¤æ¯”è¾ƒã€‚åŒæ—¶å°†`vnodeToMove`å¯¹åº”çš„çœŸå®DOMç§»åŠ¨åˆ°æ—§å­èŠ‚ç‚¹çš„å¤´éƒ¨`oldStartVnode`å¯¹åº”çš„çœŸå®DOMå‰é¢ã€‚
- 26ã€å¦‚æœä¸å€¼å¾—æ¯”è¾ƒï¼Œåˆ™è°ƒç”¨createElmæ–¹æ³•ç›´æ¥ç”Ÿæˆ`newStartVnode`å¯¹åº”çš„çœŸå®DOMæ’å…¥`oldStartVnode`å¯¹åº”çœŸå®DOMå‰é¢ã€‚
- 27ã€ç”¨`newCh[++newStartIdx]`é‡æ–°è·å–æ–°å­èŠ‚ç‚¹å¤´éƒ¨
- 28ã€å¦‚æœæ»¡è¶³`oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx`ç»§ç»­æ‰§è¡Œæ­¥éª¤9ã€‚
- 29ã€å¦‚æœ`oldStartIdx > oldEndIdx`ï¼Œè¯´æ˜æ‰€æœ‰æ—§å­èŠ‚ç‚¹å·²ç»éƒ½æ¯”å¯¹å®Œäº†ï¼Œè¿˜å‰©ä¸‹æœªæ¯”å¯¹çš„æ–°å­èŠ‚ç‚¹éƒ½è°ƒç”¨createElmæ–¹æ³•ç”Ÿæˆå¯¹åº”çš„çœŸå®DOMï¼Œæ’åˆ°`newCh[newEndIdx + 1]`å¯¹åº”çš„çœŸå®DOMåé¢ã€‚
- 30ã€å¦‚æœ`newStartIdx > newEndIdx`ï¼Œè¯´æ˜æ‰€æœ‰æ–°å­èŠ‚ç‚¹éƒ½æ¯”è¾ƒå®Œï¼Œé‚£ä¹ˆè¿˜å‰©ä¸‹çš„æ—§å­èŠ‚ç‚¹éƒ½åˆ é™¤æ‰ã€‚

#### 5ã€åˆ©ç”¨v-onceå¤„ç†åªä¼šæ¸²æŸ“ä¸€æ¬¡çš„å…ƒç´ æˆ–ç»„ä»¶

åªæ¸²æŸ“å…ƒç´ å’Œç»„ä»¶ä¸€æ¬¡ã€‚éšåçš„é‡æ–°æ¸²æŸ“ï¼Œå…ƒç´ /ç»„ä»¶åŠå…¶æ‰€æœ‰çš„å­èŠ‚ç‚¹å°†è¢«è§†ä¸ºé™æ€å†…å®¹å¹¶è·³è¿‡ã€‚è¿™å¯ä»¥ç”¨äºä¼˜åŒ–æ›´æ–°æ€§èƒ½ã€‚

ä¾‹å¦‚æŸä¸ªé¡µé¢æ˜¯åˆåŒèŒƒæ–‡ï¼Œé‡Œé¢å¤§éƒ¨åˆ†å†…å®¹ä»æœåŠ¡ç«¯è·å–ä¸”æ˜¯å›ºå®šä¸å˜ï¼Œåªæœ‰å§“åã€äº§å“ã€é‡‘é¢ç­‰å†…å®¹ä¼šå˜åŠ¨ã€‚è¿™æ—¶å°±å¯ä»¥æŠŠ`v-once`æ·»åŠ åˆ°é‚£äº›åŒ…è£¹å›ºå®šå†…å®¹çš„å…ƒç´ ä¸Šï¼Œå½“ç”Ÿæˆæ–°çš„åˆåŒå¯ä»¥è·³è¿‡é‚£äº›å›ºå®šå†…å®¹ï¼Œåªé‡æ–°æ¸²æŸ“å§“åã€äº§å“ã€é‡‘é¢ç­‰å†…å®¹å³å¯ã€‚

å’Œ`v-if`ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œ`v-once`ä¸ç”Ÿæ•ˆã€‚åœ¨`v-for`å¾ªç¯å†…çš„å…ƒç´ æˆ–ç»„ä»¶ä¸Šä½¿ç”¨ï¼Œå¿…é¡»åŠ ä¸Škeyã€‚

è®²åˆ°æ­¤ä¼˜åŒ–ï¼Œè¦é˜²æ­¢é¢è¯•å®˜é—®ä½ `v-once`æ€ä¹ˆå®ç°åªæ¸²æŸ“ä¸€æ¬¡å…ƒç´ æˆ–ç»„ä»¶ï¼Ÿ

è¯´åˆ°æ¸²æŸ“åº”è¯¥å’Œ`render`å‡½æ•°æœ‰å…³ï¼Œé‚£è¦å»ç”Ÿæˆ`render`å‡½æ•°çš„åœ°æ–¹å»å¯»æ‰¾ç­”æ¡ˆã€‚

åœ¨*src/compiler/codegen/index.js*ä¸­ï¼Œæ‰¾åˆ°genElementæ–¹æ³•

```scss
else if (el.once && !el.onceProcessed) {è‹¥è®¾ç½®v-onceï¼Œåˆ™è°ƒç”¨genOnce()å‡½æ•°
    return genOnce(el, state)
 } 
å¤åˆ¶ä»£ç 
```

å†çœ‹genOnceæ–¹æ³•

```javascript
function genOnce(el, state){
    el.onceProcessed = true
    if (el.if && !el.ifProcessed) {//å¦‚æœæœ‰å®šä¹‰äº†v-ifæŒ‡ä»¤
        //...
    } else if (el.staticInFor) {//å¦‚æœæ˜¯åœ¨v-forä¸‹é¢çš„å…ƒç´ æˆ–ç»„ä»¶ä¸Š
        //...
        return `_o(${genElement(el, state)},${state.onceId++},${key})`
    } else {
        return genStatic(el, state)
    }
}
å¤åˆ¶ä»£ç 
```

å¦‚æœæœ‰å®šä¹‰`v-if`æŒ‡ä»¤ï¼Œå¦‚æœ`v-if`æŒ‡ä»¤çš„å€¼ä¸å­˜åœ¨ï¼Œæœ€åè¿˜æ˜¯ä¼šè°ƒç”¨genStaticæ–¹æ³•ã€‚å†çœ‹genStaticæ–¹æ³•

```javascript
function genStatic(el, state) {
	//...
    state.staticRenderFns.push(`with(this){return ${genElement(el, state)}}`)
    return `_m(${state.staticRenderFns.length - 1}${el.staticInFor ? ',true' : ''})`
}
å¤åˆ¶ä»£ç 
```

å…¶ä¸­_mæ–¹æ³•å°±æ˜¯*src\core\instance\render-helpers\render-static.js*ä¸­çš„renderStaticæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯`v-once`å®ç°åªæ¸²æŸ“ä¸€æ¬¡å…ƒç´ æˆ–ç»„ä»¶çš„å…³é”®æ‰€åœ¨ã€‚

```kotlin
function renderStatic(index,isInFor){
    const cached = this._staticTrees || (this._staticTrees = [])
    let tree = cached[index]
    if (tree && !isInFor) {
        return tree
    }
    tree = cached[index] = this.$options.staticRenderFns[index].call(this._renderProxy,null,this)
 	return tree
}
å¤åˆ¶ä»£ç 
```

å…¶ä¸­`cached`æ˜¯å¸¦`v-once`çš„å…ƒç´ æˆ–ç»„ä»¶æ¸²æŸ“ç”Ÿæˆçš„è™šæ‹ŸDOMèŠ‚ç‚¹çš„ç¼“å­˜ï¼Œå¦‚æœæŸä¸ªè™šæ‹ŸDOMèŠ‚ç‚¹çš„ç¼“å­˜å­˜åœ¨ï¼Œä¸”è™šæ‹ŸDOMèŠ‚ç‚¹ä¸æ˜¯åœ¨`v-for`ä¸­ç›´æ¥è¿”å›è¯¥è™šæ‹ŸDOMèŠ‚ç‚¹ç¼“å­˜ï¼Œå¦‚æœè¯¥è™šæ‹ŸDOMèŠ‚ç‚¹æ²¡æœ‰ç¼“å­˜ï¼Œåˆ™è°ƒç”¨`genStatic`æ–¹æ³•ä¸­å­˜åœ¨`staticRenderFns`æ•°ç»„ä¸­çš„æ¸²æŸ“å‡½æ•°ï¼Œæ¸²æŸ“å‡ºè™šæ‹ŸDOMèŠ‚ç‚¹ä¸”å­˜åœ¨`cached`ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä¸ç”¨é‡æ–°æ¸²æŸ“ç›´æ¥è¿”å›è¯¥è™šæ‹ŸDOMèŠ‚ç‚¹ï¼Œå¹¶åŒæ—¶è°ƒç”¨`markOnce`æ–¹æ³•åœ¨è¯¥è™šæ‹ŸDOMèŠ‚ç‚¹ä¸ŠåŠ ä¸Š`isOnce`æ ‡å¿—ï¼Œå€¼ä¸º`true`ã€‚

å¦‚æœæœ‰å®šä¹‰`v-for`ï¼Œæœ€ç»ˆä¼šè°ƒç”¨`_o(${genElement(el, state)},${state.onceId++},${key})`,å…¶ä¸­`_o`æ–¹æ³•å°±æ˜¯*src\core\instance\render-helpers\render-static.js*ä¸­çš„markOnceæ–¹æ³•ï¼Œå…¶ä½œç”¨æ˜¯åœ¨ç”Ÿæˆçš„è™šæ‹ŸDOMèŠ‚ç‚¹ä¸ŠåŠ ä¸Š`isOnce`æ ‡å¿—ï¼Œä¸ºtrueä»£è¡¨è¯¥è™šæ‹ŸDOMèŠ‚ç‚¹æ˜¯é™æ€èŠ‚ç‚¹ï¼Œå½“ patch æ—¶ï¼Œä¼šåˆ¤æ–­`vnode.isOnce`æ˜¯å¦ä¸º`true`ï¼Œä¸º`true`æ—¶ï¼Œç›´æ¥è¿”å›æ—§èŠ‚ç‚¹ï¼Œä¸è¿›è¡Œæ¯”å¯¹ï¼Œç›¸å½“å®ç°æ¸²æŸ“ä¸€æ¬¡ã€‚

#### 6ã€åˆ©ç”¨Object.freeze()å†»ç»“ä¸éœ€è¦å“åº”å¼å˜åŒ–çš„æ•°æ®

```!
Vueåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠdataä¼ å…¥observeå‡½æ•°ä¸­è¿›è¡Œæ•°æ®åŠ«æŒï¼ŒæŠŠdataä¸­çš„æ•°æ®éƒ½è½¬æ¢æˆå“åº”å¼çš„ã€‚
å¤åˆ¶ä»£ç 
```

åœ¨observeå‡½æ•°å†…éƒ¨è°ƒç”¨defineReactiveå‡½æ•°å¤„ç†æ•°æ®ï¼Œé…ç½®getter/setterå±æ€§ï¼Œè½¬æˆå“åº”å¼ï¼Œå¦‚æœä½¿ç”¨`Object.freeze()`å°†dataä¸­æŸäº›æ•°æ®å†»ç»“äº†ï¼Œä¹Ÿå°±æ˜¯å°†å…¶configurableå±æ€§ï¼ˆå¯é…ç½®ï¼‰è®¾ç½®ä¸ºfalseã€‚

defineReactiveå‡½æ•°ä¸­æœ‰æ®µä»£ç ï¼Œæ£€æµ‹æ•°æ®ä¸ŠæŸä¸ªkeyå¯¹åº”çš„å€¼çš„configurableå±æ€§æ˜¯å¦ä¸ºfalseï¼Œè‹¥æ˜¯å°±ç›´æ¥è¿”å›ï¼Œè‹¥ä¸æ˜¯ç»§ç»­é…ç½®getter/setterå±æ€§ã€‚

```vbnet
export function defineReactive(obj,key,val,customSetter,shallow){
    //...
    const property = Object.getOwnPropertyDescriptor(obj, key)//è·å–obj[key]çš„å±æ€§
    if (property && property.configurable === false) {
        return
    }
    //...
}
å¤åˆ¶ä»£ç 
```

åœ¨é¡¹ç›®ä¸­å¦‚æœé‡åˆ°ä¸éœ€è¦å“åº”å¼å˜åŒ–çš„æ•°æ®ï¼Œå¯ä»¥ç”¨`Object.freeze()`æŠŠè¯¥æ•°æ®å†»ç»“äº†ï¼Œå¯ä»¥è·³è¿‡åˆå§‹åŒ–æ—¶æ•°æ®åŠ«æŒçš„æ­¥éª¤ï¼Œå¤§å¤§æé«˜åˆæ¬¡æ¸²æŸ“é€Ÿåº¦ã€‚

#### 7ã€æå‰è¿‡æ»¤æ‰éå¿…é¡»æ•°æ®ï¼Œä¼˜åŒ–dataé€‰é¡¹ä¸­çš„æ•°æ®ç»“æ„

Vueåˆå§‹åŒ–æ—¶ï¼Œä¼šå°†é€‰é¡¹dataä¼ å…¥observeå‡½æ•°ä¸­è¿›è¡Œæ•°æ®åŠ«æŒï¼Œ

```javascript
initData(vm){
    let data = vm.$options.data
    //...
    observe(data, true)
}
å¤åˆ¶ä»£ç 
```

åœ¨observeå‡½æ•°ä¼šè°ƒç”¨

```scss
observe(value,asRootData){
   //...
   ob = new Observer(value);
}
å¤åˆ¶ä»£ç 
```

åœ¨ObserveråŸå‹ä¸­defineReactiveå‡½æ•°å¤„ç†æ•°æ®ï¼Œé…ç½®getter/setterå±æ€§ï¼Œè½¬æˆå“åº”å¼

```ini
walk (obj) {
    const keys = Object.keys(obj)
    for (let i = 0; i < keys.length; i++) {
        defineReactive(obj, keys[i])
    }
}
å¤åˆ¶ä»£ç 
```

defineReactiveå‡½æ•°ä¸­,ä¼šå°†æ•°æ®çš„å€¼å†æ¬¡ä¼ å…¥observeå‡½æ•°ä¸­

```scss
export function defineReactive(obj,key,val,customSetter,shallow){
    //...
    if (arguments.length === 2) {
        val = obj[key]
    }
    let childOb = observe(val);
    //...
}
å¤åˆ¶ä»£ç 
```

observeå‡½æ•°ä¸­æœ‰æ®µä»£ç ï¼Œå°†æ•°æ®ä¼ å…¥ï¼ŒObserverç±»ä¸­ã€‚

```javascript
export function observe(value,asRootData){
  //...
  ob = new Observer(value)
  //...
  return ob
}
å¤åˆ¶ä»£ç 
```

ä»¥ä¸Šæ„æˆäº†ä¸€ä¸ªé€’å½’è°ƒç”¨ã€‚

æ¥æ”¶æœåŠ¡ç«¯ä¼ æ¥çš„æ•°æ®ï¼Œéƒ½ä¼šæœ‰ä¸€äº›æ¸²æŸ“é¡µé¢æ—¶ç”¨ä¸åˆ°çš„æ•°æ®ã€‚æœåŠ¡ç«¯çš„æƒ¯ä¾‹ï¼Œå®å¯å¤šä¼ ä¹Ÿä¸ä¼šå°‘ä¼ ã€‚

æ‰€ä»¥è¦å…ˆæŠŠæœåŠ¡ç«¯ä¼ æ¥çš„æ•°æ®ä¸­é‚£äº›æ¸²æŸ“é¡µé¢ç”¨ä¸åˆ°çš„æ•°æ®å…ˆè¿‡æ»¤æ‰ã€‚ç„¶åå†èµ‹å€¼åˆ°dataé€‰é¡¹ä¸­ã€‚å¯ä»¥é¿å…å»åŠ«æŒé‚£äº›éæ¸²æŸ“é¡µé¢éœ€è¦çš„æ•°æ®ï¼Œå‡å°‘å¾ªç¯å’Œé€’å½’è°ƒç”¨ï¼Œä»è€Œæé«˜æ¸²æŸ“é€Ÿåº¦ã€‚

#### 8ã€é¿å…åœ¨v-forå¾ªç¯ä¸­è¯»å–dataä¸­æ•°ç»„ç±»å‹çš„æ•°æ®

```vbnet
export function defineReactive(obj,key,val,customSetter,shallow){
    const dep = new Dep()
    const property = Object.getOwnPropertyDescriptor(obj, key)
    const getter = property && property.get;
    const setter = property && property.set;
    if ((!getter || setter) && arguments.length === 2) {
        val = obj[key]
    }
    let childOb = !shallow && observe(val);
    Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
        const value = getter ? getter.call(obj) : val
        if (Dep.target) {
            dep.depend()
            if (childOb) {
                childOb.dep.depend()
                if (Array.isArray(value)) {
                    dependArray(value)
                }
            }
        }
        return value
    }
    })
}
function dependArray (value: Array<any>) {
    for (let e, i = 0, l = value.length; i < l; i++) {
        e = value[i]
        e && e.__ob__ && e.__ob__.dep.depend()
        if (Array.isArray(e)) {
            dependArray(e)
        }
    }
}
export function observe (value, asRootData){
  	if (!isObject(value) || value instanceof VNode) {
    	return
  	}
  	//...
}
å¤åˆ¶ä»£ç 
```

ä¸ºä»€ä¹ˆè¦é¿å…åœ¨v-forå¾ªç¯ä¸­è¯»å–dataä¸­æ•°ç»„ç±»å‹çš„æ•°æ®ï¼Œå› ä¸ºåœ¨æ•°æ®åŠ«æŒä¸­ä¼šè°ƒç”¨defineReactiveå‡½æ•°ä¸­ã€‚ç”±äº getteræ˜¯å‡½æ•°ï¼Œå¹¶ä¸”å¼•ç”¨äº† `dep`ã€`childOb`ï¼Œå½¢æˆäº†é—­åŒ…ï¼Œæ‰€ä»¥ `dep`ã€`childOb` ä¸€ç›´å­˜åœ¨äºå†…å­˜ï¼ˆæ¯ä¸ªæ•°æ®çš„getterå‡½æ•°ï¼‰ä¸­ï¼Œ`dep`æ˜¯æ¯ä¸ªæ•°æ®çš„ä¾èµ–æ”¶é›†å®¹å™¨ï¼Œ`childOb`æ˜¯ç»è¿‡å“åº”å¼å¤„ç†åçš„æ•°æ®ã€‚

åœ¨æ¸²æŸ“è§†å›¾ã€ä½¿ç”¨watchç›‘å¬ã€ä½¿ç”¨è®¡ç®—å±æ€§è¿‡ç¨‹ä¸­ï¼Œè¯»å–æ•°æ®ï¼Œéƒ½ä¼šå¯¹`Dep.target`è¿›è¡Œèµ‹å€¼ï¼Œå…¶å€¼ä¸ºWatcherï¼ˆä¾èµ–ï¼‰ï¼Œä¾‹å¦‚åœ¨æ¸²æŸ“è§†å›¾è¿‡ç¨‹ä¸­è¯»å–æ•°æ®æ—¶ï¼Œ`Dep.target`ä¸ºrenderWatcherã€‚

æ¥ç€å…ˆè°ƒç”¨`dep.depend()`ç»™è‡ªèº«æ”¶é›†ä¾èµ–ï¼Œå¦‚æœvalï¼ˆè‡ªèº«çš„å€¼ï¼‰ä¸æ˜¯å¯¹è±¡ï¼Œåˆ™`childOb`ä¸ºfalseã€‚å¦‚æœvalï¼ˆè‡ªèº«çš„å€¼ï¼‰æ˜¯å¯¹è±¡ï¼Œç”¨`childOb.dep.depend()`æ”¶é›†ä¾èµ–ï¼Œè‹¥valueï¼ˆè‡ªèº«çš„å€¼ï¼‰æ˜¯æ•°ç»„ç”¨`dependArray(value)`é€’å½’æ¯ä¸€é¡¹æ¥æ”¶é›†ä¾èµ–ã€‚

ä¸ºä»€ä¹ˆè¦é¿å…åœ¨v-forå¾ªç¯ä¸­è¯»å–dataä¸­æ•°ç»„ç±»å‹çš„æ•°æ®ï¼Œå…¶åŸå› å°±æ˜¯**è‹¥valueï¼ˆè‡ªèº«çš„å€¼ï¼‰æ˜¯æ•°ç»„ç”¨`dependArray(value)`é€’å½’æ¯ä¸€é¡¹æ¥æ”¶é›†ä¾èµ–**

ä¸¾ä¸ªç®€å•çš„æ —å­ï¼Œè¡¨æ ¼ä¸­æ¯è¡Œæœ‰ä¸¤ä¸ªè¾“å…¥æ¡†ï¼Œåˆ†åˆ«å¯ä»¥è¾“å…¥é©¾é©¶å‘˜å’Œç”µè¯ï¼Œä»£ç è¿™ä¹ˆå®ç°ã€‚

```xml
<template>
    <div class="g-table-content">
        <el-table :data="tableData">
            <el-table-column prop="carno" label="è½¦ç‰Œå·"></el-table-column>
            <el-table-column prop="cartype" label="è½¦å‹"></el-table-column>
            <el-table-column label="é©¾é©¶å‘˜">
                <template slot-scope="{row,column,$index}">
                    <el-input v-model="driverList[$index].name"></el-input>
                </template>
            </el-table-column>
            <el-table-column label="ç”µè¯">
                <template slot-scope="{row,column,$index}">
                    <el-input v-model="driverList[$index].phone"></el-input>
                </template>
            </el-table-column>
        </el-table>
    </div>
</template>
å¤åˆ¶ä»£ç 
```

å‡è®¾è¡¨æ ¼æœ‰500æ¡æ•°æ®ï¼Œé‚£ä¹ˆè¯»å–driverListå…±500æ¬¡ï¼Œæ¯æ¬¡éƒ½è¯»å–driverListéƒ½ä¼šè¿›å…¥`dependArray(value)`ä¸­ï¼Œæ€»å…±è¦å¾ªç¯500*500=25ä¸‡æ¬¡ï¼Œè‹¥æœ‰åˆ†é¡µï¼Œæ¯æ¬¡åˆ‡æ¢é¡µç ï¼Œéƒ½ä¼šè‡³å°‘å¾ªç¯25ä¸‡æ¬¡ã€‚

å¦‚æœæˆ‘ä»¬åœ¨ä»æœåŠ¡è·å–åˆ°æ•°æ®åï¼Œåšäº†å¦‚ä¸‹é¢„å¤„ç†ï¼Œåœ¨èµ‹å€¼ç»™`this.tableData`ï¼Œä¼šæ˜¯æ€ä¹ˆæ ·ï¼Ÿ

```ini
res.data.forEach(item =>{
    item.name='';
    item.phone='';
})
å¤åˆ¶ä»£ç 
```

æ¨¡æ¿è¿™æ ·å®ç°

```xml
<template>
    <div class="g-table-content">
        <el-table :data="tableData">
            <el-table-column prop="carno" label="è½¦ç‰Œå·"></el-table-column>
            <el-table-column prop="cartype" label="è½¦å‹"></el-table-column>
            <el-table-column label="é©¾é©¶å‘˜">
                <template slot-scope="{row}">
                    <el-input v-model="row.name"></el-input>
                </template>
            </el-table-column>
            <el-table-column label="ç”µè¯">
                <template slot-scope="{row,column,$index}">
                    <el-input v-model="row.phone"></el-input>
                </template>
            </el-table-column>
        </el-table>
    </div>
</template>
å¤åˆ¶ä»£ç 
```

ä¹Ÿå¯ä»¥å®ç°éœ€æ±‚ï¼Œæ¸²æŸ“è¿‡ç¨‹ä¸­æ±‚å€¼æ—¶ä¹Ÿä¸ä¼šè¿›å…¥`dependArray(value)`ä¸­,ä¹Ÿä¸ä¼šé€ æˆ25ä¸‡æ¬¡çš„ä¸å¿…è¦çš„å¾ªç¯ã€‚å¤§å¤§æé«˜äº†æ€§èƒ½ã€‚

#### 9ã€é˜²æŠ–å’ŒèŠ‚æµ

é˜²æŠ–å’ŒèŠ‚æµæ˜¯é’ˆå¯¹ç”¨æˆ·æ“ä½œçš„ä¼˜åŒ–ã€‚é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹é˜²æŠ–å’ŒèŠ‚æµçš„æ¦‚å¿µã€‚

- é˜²æŠ–ï¼šè§¦å‘äº‹ä»¶åè§„å®šæ—¶é—´å†…äº‹ä»¶åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚ç®€å•æ¥è¯´å°±æ˜¯é˜²æ­¢æ‰‹æŠ–ï¼ŒçŸ­æ—¶é—´æ“ä½œäº†å¥½å¤šæ¬¡ã€‚
- èŠ‚æµï¼šäº‹ä»¶åœ¨è§„å®šæ—¶é—´å†…åªæ‰§è¡Œä¸€æ¬¡ã€‚
- åº”ç”¨åœºæ™¯ï¼š èŠ‚æµä¸ç®¡äº‹ä»¶æœ‰æ²¡æœ‰è§¦å‘è¿˜æ˜¯é¢‘ç¹è§¦å‘ï¼Œåœ¨è§„å®šæ—¶é—´å†…ä¸€å®šä¼šåªæ‰§è¡Œä¸€æ¬¡äº‹ä»¶ï¼Œè€Œé˜²æŠ–æ˜¯åœ¨è§„å®šæ—¶é—´å†…äº‹ä»¶è¢«è§¦å‘ï¼Œä¸”æ˜¯æœ€åä¸€æ¬¡è¢«è§¦å‘æ‰æ‰§è¡Œä¸€æ¬¡äº‹ä»¶ã€‚å‡å¦‚äº‹ä»¶éœ€è¦å®šæ—¶æ‰§è¡Œï¼Œä½†æ˜¯å…¶ä»–æ“ä½œä¹Ÿä¼šè®©äº‹ä»¶æ‰§è¡Œï¼Œè¿™ç§åœºæ™¯å¯ä»¥ç”¨èŠ‚æµã€‚å‡å¦‚äº‹ä»¶ä¸éœ€è¦å®šæ—¶æ‰§è¡Œï¼Œéœ€è¢«è§¦å‘æ‰æ‰§è¡Œï¼Œä¸”çŸ­æ—¶é—´å†…ä¸èƒ½æ‰§è¡Œå¤šæ¬¡ï¼Œè¿™ç§åœºæ™¯å¯ä»¥ç”¨é˜²æŠ–ã€‚

åœ¨ç”¨Vue Cliè„šæ‰‹æ¶æ­å»ºçš„Vueé¡¹ç›®ä¸­ï¼Œå¯ä»¥é€šè¿‡å¼•ç”¨Lodashå·¥å…·åº“é‡Œé¢çš„debounceé˜²æŠ–å‡½æ•°å’ŒthrottleèŠ‚æµå‡½æ•°ã€‚

```javascript
import debounce from 'lodash/debounce';
import throttle from 'lodash/throttle';
export default{
	methods:{
    	a: debounce(function (){
        	//...
        },200,{
            'leading': false,
            'trailing': true
        }),
        b: throttle(function (){
        	//...
        },200,{
            'leading': false,
            'trailing': true
        })
    }
}
å¤åˆ¶ä»£ç 
```

- `debounce(func, [wait=0], [options={}])` åˆ›å»ºä¸€ä¸ªé˜²æŠ–å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šä»ä¸Šä¸€æ¬¡è¢«è°ƒç”¨åï¼Œå»¶è¿Ÿ wait æ¯«ç§’åè°ƒç”¨ func æ–¹æ³•ã€‚è¿”å›ä¸€ä¸ªé˜²æŠ–å‡½æ•°debounceFnï¼Œ`debounce.cancel`å–æ¶ˆé˜²æŠ–ï¼Œ`debounce.flush` ç«‹å³è°ƒç”¨è¯¥funcã€‚
  - `options.leading`ä¸ºtrueæ—¶ï¼Œfuncåœ¨å»¶è¿Ÿå¼€å§‹å‰è°ƒç”¨ã€‚
  - `options.trailing`ä¸ºtrueæ—¶ï¼Œfuncåœ¨å»¶è¿Ÿå¼€å§‹ç»“æŸåè°ƒç”¨ã€‚
  - `options.maxWait`è®¾ç½®func å…è®¸è¢«å»¶è¿Ÿçš„æœ€å¤§å€¼ã€‚
- `throttle(func, [wait=0], [options={}])` åˆ›å»ºä¸€ä¸ªèŠ‚æµå‡½æ•°ï¼Œåœ¨ wait ç§’å†…æœ€å¤šæ‰§è¡Œ func ä¸€æ¬¡çš„å‡½æ•°ã€‚ è¿”å›ä¸€ä¸ªèŠ‚æµå‡½æ•°throttleFnï¼Œ`throttleFn.cancel`å–æ¶ˆèŠ‚æµï¼Œ`throttleFn.flush` ç«‹å³è°ƒç”¨è¯¥funcã€‚
  - `options.leading`ä¸ºtrueæ—¶ï¼Œfuncåœ¨èŠ‚æµå¼€å§‹å‰è°ƒç”¨ã€‚
  - `options.trailing`ä¸ºtrueæ—¶ï¼Œfuncåœ¨èŠ‚æµç»“æŸåè°ƒç”¨ã€‚
  - `leading`å’Œ`trailing`éƒ½ä¸ºtrueï¼Œfuncåœ¨waitæœŸé—´å¤šæ¬¡è°ƒç”¨ã€‚

#### 10ã€å›¾ç‰‡å¤§å°ä¼˜åŒ–å’Œæ‡’åŠ è½½

å…³äºå›¾ç‰‡å¤§å°çš„ä¼˜åŒ–ï¼Œå¯ä»¥ç”¨image-webpack-loaderè¿›è¡Œå‹ç¼©å›¾ç‰‡ï¼Œåœ¨webpackæ’ä»¶ä¸­é…ç½®ï¼Œå…·ä½“å¯ä»¥çœ‹æœ¬æ–‡ä¸­è¿™ç‚¹ã€‚

å…³äºå›¾ç‰‡æ‡’åŠ è½½ï¼Œå¯ä»¥ç”¨vue-lazyloadæ’ä»¶å®ç°ã€‚

æ‰§è¡Œå‘½ä»¤`npm install vue-lazyload --save`å®‰è£…vue-lazyloadæ’ä»¶ã€‚åœ¨main.jsä¸­å¼•å…¥é…ç½®

```go
import VueLazyload from 'vue-lazyload';
Vue.use(VueLazyload, {
  preLoad: 1.3,//é¢„è½½é«˜åº¦æ¯”ä¾‹
  error: 'dist/error.png',//åŠ è½½å¤±è´¥æ˜¾ç¤ºå›¾ç‰‡
  loading: 'dist/loading.gif',//åŠ è½½è¿‡ç¨‹ä¸­æ˜¾ç¤ºå›¾ç‰‡
  attempt: 1,//å°è¯•æ¬¡æ•°
})
å¤åˆ¶ä»£ç 
```

åœ¨é¡¹ç›®ä¸­ä½¿ç”¨

```ini
<img v-lazy="/static/img/1.png">
å¤åˆ¶ä»£ç 
```

#### 11ã€åˆ©ç”¨æŒ‚è½½èŠ‚ç‚¹ä¼šè¢«æ›¿æ¢çš„ç‰¹æ€§ä¼˜åŒ–ç™½å±é—®é¢˜

```javascript
import Vue from 'vue'
import App from './App.vue'
new Vue({
    render: h => h(App)
}).$mount('#app')
å¤åˆ¶ä»£ç 
```

> Vue é€‰é¡¹ä¸­çš„ render å‡½æ•°è‹¥å­˜åœ¨ï¼Œåˆ™ Vue æ„é€ å‡½æ•°ä¸ä¼šä» template é€‰é¡¹æˆ–é€šè¿‡ el é€‰é¡¹æŒ‡å®šçš„æŒ‚è½½å…ƒç´ ä¸­æå–å‡ºçš„ HTML æ¨¡æ¿ç¼–è¯‘æ¸²æŸ“å‡½æ•°ã€‚

ä¹Ÿå°±æ˜¯è¯´æ¸²æŸ“æ—¶ï¼Œä¼šç›´æ¥ç”¨renderæ¸²æŸ“å‡ºæ¥çš„å†…å®¹æ›¿æ¢``ã€‚

Vueé¡¹ç›®æœ‰ä¸ªç¼ºç‚¹ï¼Œé¦–æ¬¡æ¸²æŸ“ä¼šæœ‰ä¸€æ®µæ—¶é—´çš„ç™½å±åŸå› æ˜¯é¦–æ¬¡æ¸²æŸ“æ—¶éœ€è¦åŠ è½½ä¸€å †èµ„æºï¼Œå¦‚jsã€cssã€å›¾ç‰‡ã€‚å¾ˆå¤šä¼˜åŒ–ç­–ç•¥ï¼Œæœ€ç»ˆç›®çš„æ˜¯æé«˜è¿™äº›èµ„æºçš„åŠ è½½é€Ÿåº¦ã€‚ä½†æ˜¯å¦‚æœé‡ä¸Šç½‘ç»œæ…¢çš„æƒ…å†µï¼Œæ— è®ºä¼˜åŒ–åˆ°æè‡´è¿˜æ˜¯éœ€è¦ä¸€å®šåŠ è½½æ—¶é—´ï¼Œè¿™æ—¶å°±ä¼šå‡ºç°ç™½å±ç°è±¡ã€‚

é¦–å…ˆåŠ è½½æ˜¯index.htmlé¡µé¢ï¼Œå…¶æ˜¯æ²¡æœ‰å†…å®¹ï¼Œå°±ä¼šå‡ºç°ç™½å±ã€‚å¦‚æœ``é‡Œé¢æœ‰å†…å®¹ï¼Œå°±ä¸ä¼šå‡ºç°ç™½å±ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨``é‡Œæ·»åŠ é¦–å±çš„é™æ€é¡µé¢ã€‚ç­‰çœŸæ­£çš„é¦–å±åŠ è½½å‡ºæ¥åå°±ä¼šæŠŠ``è¿™å—ç»“æ„éƒ½æ›¿æ¢æ‰ï¼Œç»™äººä¸€ç§è§†è§‰ä¸Šçš„è¯¯å·®ï¼Œå°±ä¸ä¼šäº§ç”Ÿç™½å±ã€‚

#### 11ã€ç»„ä»¶åº“çš„æŒ‰éœ€å¼•å…¥

ç»„ä»¶åº“æŒ‰éœ€å¼•å…¥çš„æ–¹æ³•ï¼Œä¸€èˆ¬æ–‡æ¡£éƒ½ä¼šä»‹ç»ã€‚

å¦‚element UIåº“ï¼Œç”¨babel-plugin-componentæ’ä»¶å®ç°æŒ‰éœ€å¼•å…¥ã€‚

æ‰§è¡Œå‘½ä»¤`npm install babel-plugin-component --save-dev`ï¼Œå®‰è£…æ’ä»¶ã€‚

åœ¨æ ¹ç›®å½•ä¸‹.babelrc.jsæ–‡ä»¶ä¸­æŒ‰å¦‚ä¸‹é…ç½®

```lua
{
  "presets": [["es2015", { "modules": false }]],
  "plugins": [
    [
      "component",
      {
        "libraryName": "element-ui",
        "styleLibraryName": "theme-chalk"
      }
    ]
  ]
}
å¤åˆ¶ä»£ç 
```

å…¶ä¸­`libraryName`ä¸ºç»„ä»¶åº“çš„åç§°ï¼Œ`styleLibraryName`ä¸ºç»„ä»¶åº“æ‰“åŒ…åæ ·å¼å­˜æ”¾çš„æ–‡ä»¶å¤¹åç§°ã€‚ åœ¨main.jsä¸­å°±å¯ä»¥æŒ‰éœ€å¼•å…¥ã€‚

```javascript
import Vue from 'vue';
import { Button, Select } from 'element-ui';
Vue.use(Button)
Vue.use(Select)
å¤åˆ¶ä»£ç 
```

å…¶å®babel-plugin-componentæ’ä»¶æ˜¯elementç”¨babel-plugin-importæ’ä»¶æ”¹é€ åç‰¹å®šç»™element UIä½¿ç”¨ã€‚ä¸€èˆ¬çš„ç»„ä»¶åº“è¿˜æ˜¯babel-plugin-importæ’ä»¶å®ç°æŒ‰éœ€å¼•å…¥ã€‚

æ‰§è¡Œå‘½ä»¤`npm install babel-plugin-import --save-dev`ï¼Œå®‰è£…æ’ä»¶ã€‚

åœ¨æ ¹ç›®å½•ä¸‹.babelrc.jsæ–‡ä»¶ä¸­æŒ‰å¦‚ä¸‹é…ç½®

```json
{
  "plugins": [
    ["import", {
      "libraryName": "vant",
      "libraryDirectory": "es",
      "style": true
    }]
  ]
}
å¤åˆ¶ä»£ç 
```

å…¶ä¸­`libraryName`ä¸ºç»„ä»¶åº“çš„åç§°ï¼Œ`libraryDirectory`è¡¨ç¤ºä»åº“çš„package.jsonçš„mainå…¥å£æ–‡ä»¶æˆ–è€…moduleå…¥å£æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹åç§°ï¼Œå¦åˆ™é»˜è®¤ä¸ºlibã€‚

åœ¨ä»‹ç»`style`é€‰é¡¹é…ç½®ä¹‹å‰ã€‚å…ˆçœ‹ä¸€ä¸‹Vant ç»„ä»¶åº“æ‰“åŒ…åç”Ÿæˆæ–‡ä»¶çš„ç»“æ„å’Œå†…å®¹ã€‚ ![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42990946918c4045b7d74ddba8eec282~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

index.jsæ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤º

![img](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/defb215cea674b0ba2ae8a67888d870d~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

less.jsæ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤º

![img](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/553ce8c0e6a7401589f8c8f2e968c33d~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

`style`ä¸ºtrueæ—¶ï¼Œä¼šæŒ‰éœ€åœ¨é¡¹ç›®ä¸­å¼•å…¥å¯¹åº”styleæ–‡ä»¶ä¸­çš„index.jsã€‚

`style`ä¸ºcssæ—¶ï¼Œä¼šæŒ‰éœ€åœ¨é¡¹ç›®ä¸­å¼•å…¥å¯¹åº”styleæ–‡ä»¶ä¸­çš„less.jsã€‚

`style`ä¸ºFunctionï¼Œbabel-plugin-importå°†è‡ªåŠ¨å¯¼å…¥æ–‡ä»¶è·¯å¾„ç­‰äºå‡½æ•°è¿”å›å€¼çš„æ–‡ä»¶ã€‚è¿™å¯¹äºç»„ä»¶åº“å¼€å‘äººå‘˜å¾ˆæœ‰ç”¨ã€‚ å¯ä»¥çœ‹æˆ‘å¦ä¸€ç¯‡æ–‡ç« [Vue CLI3æ­å»ºç»„ä»¶åº“å¹¶å®ç°æŒ‰éœ€å¼•å…¥å®æˆ˜æ“ä½œ](https://juejin.cn/post/6844904000655998984#heading-28)ã€‚

### ä¸‰ã€é¡¹ç›®æ‰“åŒ…çš„ä¼˜åŒ–

åœ¨è¯´è¿™ä¸ªä¹‹å‰ï¼Œå…ˆè¦æ˜ç¡®ä»€ä¹ˆæ˜¯æ‰“åŒ…ã€‚é€šä¿—æ¥è¯´ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªé¡¹ç›®æ‰“åŒ…æˆä¸€ä¸ªä¸ªjsæ–‡ä»¶ã€cssæ–‡ä»¶ç­‰èµ„æºï¼Œæœ€ååœ¨index.htmlæ–‡ä»¶ä¸­å¼•å…¥ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹é¡¹ç›®ä¸­distæ–‡ä»¶å¤¹ä¸­çš„index.htmlã€‚

å¦‚ä¸‹å›¾,çº¢æ¡†ä¸­å°±æ˜¯ä¸€ä¸ªé¡¹ç›®é€šè¿‡æ‰“åŒ…å‡ºæ¥çš„èµ„æºã€‚å…¶å®è¯´ä¼˜åŒ–ï¼Œå°±æ˜¯ä¼˜åŒ–è¿™äº›èµ„æºã€‚é‚£ä¹ˆè¦æ€ä¹ˆä¼˜åŒ–è¿™äº›èµ„æºå‘¢ï¼Ÿ ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/41e9c6bd76de45c4abd710c7e4654459~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) åœ¨æ—©æœŸæ²¡æœ‰Webpackæ—¶ï¼Œè¿™äº›èµ„æºéƒ½æ˜¯å¼€å‘è€…æŒ‰ç…§å›¢é˜Ÿè§„èŒƒæ¥å¤„ç†å’Œå¼•å…¥ã€‚å¹¶é€šè¿‡ä¼˜åŒ–æ¥å®ç°æœ€å¿«çš„ã€æœ€åˆç†ä»æœåŠ¡å™¨ä¸‹è½½è¿™äº›èµ„æºã€‚è¿™æ—¶æœŸçš„ä¼˜åŒ–ä¸»è¦ä½“ç°åœ¨:

- jsã€cssä»£ç æŒ‰éœ€å¼•å…¥ã€‚
- jsã€cssä»£ç å…¬ç”¨ä»£ç æå–ã€‚
- jsã€cssä»£ç çš„æœ€å°åŒ–å‹ç¼©ã€‚
- å›¾ç‰‡èµ„æºçš„å‹ç¼©ã€‚

ç°åœ¨é¡¹ç›®æ˜¯ç”¨Webpackæ‰“åŒ…çš„ï¼Œå¯ä»¥é€šè¿‡é…ç½®Webpackæ¥ä¼˜åŒ–ã€‚

å¦‚æœä½ çš„Vueé¡¹ç›®æ˜¯ç”¨Vue Cli3æ­å»ºèµ·æ¥ï¼Œå¯ä»¥åœ¨æ ¹ç›®å½•æ–°å»ºä¸€ä¸ª*vue.config.js*æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­é…ç½®Webpackæ¥ä¼˜åŒ–è¿™äº›èµ„æºã€‚

ä¼˜åŒ–è¿˜æ˜¯æç°åœ¨ä¸Šé¢å››ç‚¹ã€‚ä¸‹é¢æ€»ç»“äº†5ä¸ªä¼˜åŒ–æ‰‹æ®µï¼Œå…¶ä¸­ä¸¤ä¸ªæ‰‹æ®µè™½ç„¶åœ¨ç”Ÿäº§ç¯å¢ƒå·²ç»æ˜¯é»˜è®¤ä¼˜åŒ–çš„ï¼Œä½†æ˜¯è¿˜æ˜¯è¦äº†è§£ä¸€ä¸‹ã€‚

ä¼˜åŒ–è‡ªç„¶è¦å‰åå¯¹æ¯”ï¼Œå…ˆå®‰è£…æ’ä»¶webpack-bundle-analyzerï¼Œå¯ä»¥å¸®åŠ©ä½ å¯è§†åŒ–çš„åˆ†ææ‰“åŒ…åçš„å„ä¸ªèµ„æºçš„å¤§å°ã€‚

```css
npm install webpack-bundle-analyzer --save-dev
å¤åˆ¶ä»£ç 
```

åœ¨*vue.config.js*ä¸­å¼•å…¥è¿™æ’ä»¶

```ini
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;
module.exports={
    configureWebpack:config =>{
        return {
            plugins:[
                new BundleAnalyzerPlugin()
            ]
        }
    }
}
å¤åˆ¶ä»£ç 
```

æ‰§è¡Œå‘½ä»¤`npm run build`ï¼Œä¼šåœ¨æµè§ˆå™¨æ‰“å¼€ä¸€ä»½æ‰“åŒ…åˆ†æå›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cbebd7b867534f6f947bc626b6725960~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

#### 1ã€åˆ©ç”¨import()å¼‚æ­¥å¼•å…¥ç»„ä»¶å®ç°æŒ‰éœ€å¼•å…¥

è¯´èµ·`import()`ï¼Œæˆ‘ä»¬è‡ªç„¶ä¼šæƒ³åˆ°è·¯ç”±æ‡’åŠ è½½ï¼Œæ‰€è°“çš„æ‡’åŠ è½½å°±æ˜¯ç”¨`import()`å¼‚æ­¥å¼•å…¥ç»„ä»¶ã€‚

åœ¨ç½‘ä¸Šéšä¾¿ä¸€æœï¼Œæ‡’åŠ è½½è¿˜å¯ä»¥é€šè¿‡`resolve =>require(['éœ€è¦åŠ è½½ç»„ä»¶çš„åœ°å€'],resolve)`æ¥å®ç°ã€‚

```javascript
component: () =>import('views/home.vue'),
component: resolve =>require(['views/home.vue'],resolve)
å¤åˆ¶ä»£ç 
```

ä½†æ˜¯ç”¨`resolve =>require(['éœ€è¦åŠ è½½ç»„ä»¶çš„åœ°å€'],resolve)`æ¥å¼‚æ­¥å¼•å…¥ç»„ä»¶ï¼Œé€šè¿‡Webpack4æ‰“åŒ…åï¼Œå‘ç°æ‰€æœ‰ç»„ä»¶çš„ä»£ç è¢«æ‰“åŒ…æˆä¸€ä¸ªjsæ–‡ä»¶è¿™å’Œé¢„æœŸçš„ä¸ç¬¦ï¼Œé¢„æœŸåº”è¯¥æ˜¯æ¯ä¸ªç»„ä»¶çš„ä»£ç éƒ½è¢«æ‰“åŒ…æˆå¯¹åº”çš„jsæ–‡ä»¶ï¼ŒåŠ è½½ç»„ä»¶æ—¶ä¼šå¯¹åº”åŠ è½½jsæ–‡ä»¶ï¼Œè¿™æ‰æ˜¯æ‡’åŠ è½½ã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d260f74249948e980c212e26b2503a2~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

ç”¨`import()`æ¥å¼‚æ­¥å¼•å…¥ç»„ä»¶åï¼Œæ‰§è¡Œå‘½ä»¤`npm run build`åï¼Œçœ‹ä¸€ä¸‹æ‰“åŒ…åˆ†æå›¾ã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2469067189f9414890c8d2b66fc0c57b~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

å¯¹æ¯”åå‘ç°ï¼ŒåŸæ¥ä¸€ä¸ª1.42MBçš„jsæ–‡ä»¶ä¸è§äº†ï¼Œè¢«æ‹†åˆ†æˆè®¸å¤šå¦‚32.55KBã€31.69KBçš„jså°æ–‡ä»¶ã€‚è¿™äº›jså°æ–‡ä»¶åªæœ‰åœ¨å¯¹åº”çš„ç»„ä»¶åŠ è½½æ—¶æ‰ä¼šåŠ è½½ï¼Œè¿™æ‰æ˜¯æ‡’åŠ è½½ã€‚

æˆ–è®¸ä½ çœ‹è¿™äº›jsæ–‡ä»¶åä¼šæ„Ÿåˆ°æ··ä¹±ï¼Œä¸èƒ½å’Œé¡¹ç›®ä¸­çš„ç»„ä»¶ä¸€ä¸€å¯¹ä¸Šï¼Œç°åœ¨æ•™ä½ ä¸€ä¸ªå°æŠ€å·§ã€‚[webpackChunkName](https://link.juejin.cn?target=https%3A%2F%2Fwebpack.docschina.org%2Fapi%2Fmodule-methods%2F%23magic-comments)ï¼šchunkæ–‡ä»¶çš„åç§°ã€‚[request]è¡¨ç¤ºå®é™…è§£æçš„æ–‡ä»¶åã€‚

```javascript
function load(component) {
    return () => import(/* webpackChunkName: "[request]" */ `views/${component}`)
}
å¤åˆ¶ä»£ç 
```

æ‰§è¡Œå‘½ä»¤`npm run build`ï¼Œçœ‹ä¸€ä¸‹æ‰“åŒ…åˆ†æå›¾ã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19ff6bb406cc4b24ad68218fb56dbb91~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) å¦‚å›¾ä¸­çº¢æ¡†çš„jsæ–‡ä»¶æ˜¯views/flow_card_manage/flow_card_list/index.vueè¿™ä¸ªç»„ä»¶æ‰“åŒ…å‡ºæ¥çš„ã€‚

åœ¨æµè§ˆå™¨ä¸Šæ‰“å¼€é¡¹ç›®ï¼Œç”¨F12æŠ“åŒ…çœ‹ä¸€ä¸‹ï¼Œæœä¸€ä¸‹`flow_card_manage-flow_card_list.67de1ef8.js`è¿™ä¸ªæ–‡ä»¶ã€‚åœ¨é¦–é¡µæ—¶ï¼Œè¿˜æ²¡åŠ è½½åˆ°è¿™ä¸ªè·¯ç”±ç»„ä»¶æ—¶ã€‚è¿™ä¸ªjsæ–‡ä»¶æ˜¯æœ‰è¢«åŠ è½½ï¼Œåªæ˜¯é¢„å–ï¼ˆprefetchï¼‰ä¸€ä¸‹ï¼Œæ²¡æœ‰è¿”å›å†…å®¹çš„ã€‚ç›®çš„æ˜¯å‘Šè¯‰æµè§ˆå™¨ï¼Œç©ºé—²çš„æ—¶å€™ç»™æˆ‘åŠ è½½è¿™ä¸ªjsæ–‡ä»¶ã€‚ ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b65fb0b253dd4091ae5dacfa2de8e512~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/669a7734e900429a81005d5d9b4de352~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) ç›´åˆ°çœŸæ­£åŠ è½½è¿™ä¸ªè·¯ç”±ç»„ä»¶æ—¶ï¼Œè¿™ä¸ªjsæ–‡ä»¶å†æ¬¡è¢«åŠ è½½ï¼Œå¦‚æœæµè§ˆå™¨å·²ç»åŠ è½½å¥½äº†ç›´æ¥è¿”å›å†…å®¹ï¼Œå¦‚æœæµè§ˆå™¨è¿˜æ²¡åŠ è½½å¥½ï¼Œå°±å»æœåŠ¡å™¨è¯·æ±‚è¿™ä¸ªjsæ–‡ä»¶ï¼Œå†è¿”å›å†…å®¹ã€‚è¿™æ ·å°±æ˜¯æ‡’åŠ è½½ï¼ŒæŒ‰éœ€åŠ è½½ã€‚ ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/090ca9ab658c4a00abc861782e9cd11e~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) **åŸç†ï¼š** å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« [ğŸš©å››å¹´å‰ç«¯å¸¦ä½ ç†è§£è·¯ç”±æ‡’åŠ è½½çš„åŸç†](https://juejin.cn/post/6844904180285456398)

#### 2ã€åˆ©ç”¨externalsæå–ç¬¬ä¸‰æ–¹ä¾èµ–å¹¶ç”¨CDNå¼•å…¥

ä»æ‰“åŒ…åˆ†æå›¾ä¸­å¯ä»¥å‘ç°chunk-vendors.jså’Œchunk-80f6b79a.jsè¿™ä¸¤ä¸ªæ–‡ä»¶è¿˜æ˜¯å¾ˆå¤§ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶å†…æœ‰element-uiã€jqueryã€xlsxç­‰ç¬¬ä¸‰æ–¹ä¾èµ–çš„èµ„æºã€‚ ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a0853dff9994f8f8987c4ac0d5035ff~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8e14d6f560c46789437ab7839e7b6a3~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

åœ¨Webpackä¸­çš„`externals`é…ç½®é€‰é¡¹ï¼Œå¯é¿å…å°†ç¬¬ä¸‰æ–¹ä¾èµ–æ‰“åŒ…ï¼Œè€Œæ˜¯åœ¨é¡¹ç›®è¿è¡Œæ—¶ä»å¤–éƒ¨è·å–ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚

å…·ä½“æ“ä½œå¯ä»¥çœ‹ä¸€ä¸‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« [Webpackä¹‹externalsç”¨æ³•è¯¦è§£](https://juejin.cn/post/6844904190083350542)ã€‚

æ‰§è¡Œå‘½ä»¤`npm run build`ï¼Œçœ‹ä¸€ä¸‹æ‰“åŒ…åˆ†æå›¾ã€‚ ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d59b4dafd304e92af593ee72a4de5f6~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) chunk-vendors.jså’Œchunk-80f6b79a.jsçš„æ–‡ä»¶å¤§å°å’Œä¹‹å‰ç›¸æ¯”ï¼Œæœ‰å¤§å¹…åº¦çš„å‡å°ã€‚

> ç”¨externalsæå–ç¬¬ä¸‰æ–¹ä¾èµ–æ—¶ï¼Œéœ€åˆ‡è®°ä¸­åº¸ä¹‹é“ã€‚è™½ç„¶æˆ‘ä»¬çš„æœ€ç»ˆç›®çš„æ˜¯å‡å°‘httpè¯·æ±‚èµ„æºå¤§å°ï¼Œä½†æ˜¯è¿‡çŠ¹ä¸åŠï¼Œæå–çš„è¿‡ç»†å°†ä¼šå¢åŠ httpè¯·æ±‚æ•°é‡ã€‚

#### 3ã€åˆ©ç”¨SplitChunksæ’ä»¶æå–å…¬å…±jsä»£ç å’Œåˆ†å‰²jsä»£ç 

ç”¨Webpackæ‰“åŒ…åï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šèµ„æºè¢«é‡å¤æ‰“åŒ…åˆ°å„ä¸ªjsæ–‡ä»¶ï¼Œå¯ä»¥ç”¨SplitChunksæ’ä»¶è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå‡å°‘æ‰“åŒ…ç”Ÿæˆæ–‡ä»¶çš„æ€»ä½“å¤§å°ã€‚

å¦å¤–CDNæ˜¯ç¬¬ä¸‰æ–¹ï¼Œå…·æœ‰ä¸ç¨³å®šæ€§ï¼Œä¸‡ä¸€CDNçªç„¶æŒ‚äº†ï¼Œç³»ç»Ÿä¹Ÿå°±å´©äº†ï¼Œæœ‰ä¸€å®šçš„é£é™©ã€‚ä¹Ÿå¯ä»¥ç”¨SplitChunksæ’ä»¶å®ç°`externals`é…ç½®çš„æ•ˆæœï¼Œç¬¬ä¸‰æ–¹ä¾èµ–è¿˜æ˜¯åœ¨è‡ªå·±æœåŠ¡å™¨ä¸Šï¼Œå‡å°‘é£é™©ã€‚

å…·ä½“æ“ä½œå¯ä»¥çœ‹ä¸€ä¸‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« [Webpackä¹‹SplitChunksæ’ä»¶ç”¨æ³•è¯¦è§£](https://juejin.cn/post/6844904198023168013)

#### 4ã€åˆ©ç”¨MiniCssExtractPluginæ’ä»¶æå–cssæ ·å¼

åœ¨ç”¨Vue Cli3æ­å»ºçš„Vueé¡¹ç›®ä¸­æ˜¯ç”¨`css.extract`æ¥æ§åˆ¶MiniCssExtractPluginæ’ä»¶æ˜¯å¦å¯ç”¨ï¼Œè™½ç„¶åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ`css.extract`é»˜è®¤æ˜¯ä¸º`true`ï¼Œä¹Ÿå°±æ˜¯è¯´MiniCssExtractPluginæ’ä»¶æ˜¯å¯ç”¨çš„ã€‚ä½†æ˜¯è¿˜æ˜¯è¦ç†Ÿæ‚‰ä¸€ä¸‹MiniCssExtractPluginæ’ä»¶çš„ç”¨æ³•ï¼Œä»¥é˜²é¢è¯•å®˜ç»†é—®ã€‚

å…·ä½“æ“ä½œå¯ä»¥çœ‹ä¸€ä¸‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« [Webpackä¹‹MiniCssExtractPluginæ’ä»¶ç”¨æ³•è¯¦è§£](https://juejin.cn/post/6850418117500715015)ã€‚

#### 5ã€åˆ©ç”¨OptimizeCssnanoPluginæ’ä»¶å‹ç¼©å’Œå»é‡cssæ ·å¼æ–‡ä»¶

åœ¨ç”¨Vue Cli3æ­å»ºçš„Vueé¡¹ç›®ä¸­é»˜è®¤æ˜¯ä½¿ç”¨OptimizeCssnanoPluginæ’ä»¶æ¥å‹ç¼©å’Œå»é‡cssæ ·å¼æ–‡ä»¶ï¼Œ

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/01b2a9b813f444ed8893d377854fa9fc~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

è¿™é‡Œæ¥è®²ä¸€ä¸‹æ€ä¹ˆä½¿ç”¨è¿™æ¬¾æ’ä»¶ã€‚ å…ˆå®‰è£…OptimizeCssnanoPluginæ’ä»¶

```css
cnpm install --save-dev @intervolga/optimize-cssnano-plugin
å¤åˆ¶ä»£ç 
```

åœ¨*vue.config.js*ä¸­è¿™ä¹ˆé…ç½®

```javascript
const OptimizeCssnanoPlugin = require('@intervolga/optimize-cssnano-plugin');
module.exports={
    configureWebpack:config =>{
        return {
            plugins:[
                new OptimizeCssnanoPlugin({
                    sourceMap: false,
                    cssnanoOptions: {
                        preset: [
                            'default',
                            {
                              mergeLonghand: false,
                              cssDeclarationSorter: false
                            }
                        ]
                    },
                }),
            ]
        }
    }
}
å¤åˆ¶ä»£ç 
```

å…¶ä¸­cssnanoOptionsçš„é…ç½®å¯ä»¥çœ‹[è¿™é‡Œ](https://link.juejin.cn?target=https%3A%2F%2Fcssnano.co%2Fguides%2Foptimisations)ã€‚

`mergeLonghand:false`,è¡¨ç¤ºå…³é—­å¦‚marginï¼Œpaddingå’Œborderç±»ä¼¼cssæ ·å¼å±æ€§åˆå¹¶ã€‚

```css
.box {
    margin-top: 10px;
    margin-right: 20px;
    margin-bottom: 10px;
    margin-left: 20px;
}
//å‹ç¼©å
.box {
    margin: 10px 20px;
}
å¤åˆ¶ä»£ç 
```

`cssDeclarationSorter:false`ï¼Œè¡¨ç¤ºå…³é—­æ ¹æ®CSSçš„å±æ€§åç§°å¯¹CSSè¿›è¡Œæ’åºã€‚

```css
body {
   animation: none;
   color: #C55;
   border: 0;
}
//å‹ç¼©å
body {
   animation: none;
   border: 0;
   color: #C55;
}
å¤åˆ¶ä»£ç 
```

#### 6ã€å¼€å¯optimization.minimizeæ¥å‹ç¼©jsä»£ç 

`optimization.minimize`é€‰é¡¹æœ‰ä¸¤ä¸ªå€¼`true`å’Œ`false`ï¼Œä¸º`true`å¼€å¯å‹ç¼©jsä»£ç ï¼Œä¸º`false`å…³é—­å‹ç¼©jsä»£ç ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é»˜è®¤ä¸º`true`ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­é»˜è®¤ä¸º`false`ã€‚

å¦‚æœä½ åœ¨å¼€å‘ç¯å¢ƒä¸éœ€è¦ç”¨debugè°ƒè¯•ä»£ç ï¼Œå¯ä»¥ä¹Ÿè®¾ç½®ä¸º`true`æ¥å‹ç¼©jsä»£ç ï¼Œæé«˜é¡µé¢åŠ è½½é€Ÿåº¦ã€‚

åœ¨*vue.config.js*ä¸­è¿™ä¹ˆé…ç½®

```arduino
module.exports={
    configureWebpack:config =>{
        return {
            optimization:{
                minimize: true
            }
        }
    }
}
å¤åˆ¶ä»£ç 
```

åœ¨Vue Cli3ä¸­é»˜è®¤ç”¨TerserPluginæ’ä»¶æ¥å‹ç¼©jsä»£ç ï¼Œå…¶ä¸­é…ç½®å·²ç»æ˜¯æœ€ä¼˜äº†ã€‚

å¦‚æœæƒ³ç”¨å…¶å®ƒæ’ä»¶æ¥å‹ç¼©jsä»£ç ï¼Œå¯ä»¥åœ¨`optimization.minimizer`é€‰é¡¹ä¸­æ·»åŠ ï¼Œå…¶å€¼ä¸ºæ•°ç»„ã€‚

ç”¨chainWebpackæ¥æ·»åŠ ï¼Œå…¶ä¸­WebpackPluginä¸ºæ’ä»¶åç§°ï¼Œargsä¸ºæ’ä»¶å‚æ•°ã€‚

```ini
const WebpackPlugin = require(æ’ä»¶åç§°)
module.exports = {
    chainWebpack: config =>{
        config.optimization
            .minimizer(name)
            .use(WebpackPlugin, args)
    },
}
å¤åˆ¶ä»£ç 
```

#### 7ã€åˆ©ç”¨image-webpack-loaderè¿›è¡Œå‹ç¼©å›¾ç‰‡

ç”¨Vue Cli3æ­å»ºçš„Vueé¡¹ç›®ä¸­ï¼Œå›¾ç‰‡æ˜¯æ²¡è¿›è¡Œå‹ç¼©å°±ç›´æ¥ç”¨url-loaderå’Œfile-loaderå¤„ç†ã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/51c1cd91b0644744910f533943dfa361~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

ä¼˜åŒ–ä¸€ä¸‹ç”¨image-webpack-loaderè¿›è¡Œå‹ç¼©å›¾ç‰‡åå†ç»™url-loaderå’Œfile-loaderå¤„ç†ã€‚

åœ¨Vue Cli3å·²ç»é…ç½®äº†å¯¹å›¾ç‰‡å¤„ç†çš„loaderï¼Œè¦å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œå…·ä½“æ–¹æ³•å¯ä»¥çœ‹æˆ‘å¦ä¸€ç¯‡æ–‡ç« [Webpackä¹‹loaderé…ç½®è¯¦è§£](https://juejin.cn/post/6847902222873788430#heading-17)ã€‚

å…ˆå®‰è£…image-webpack-loader

```arduino
cnpm install image-webpack-loader --save-dev
å¤åˆ¶ä»£ç 
```

ç„¶ååœ¨*vue.config.js*ä¸­è¿™ä¹ˆé…ç½®

```arduino
module.exports = {
    chainWebpack: config =>{
        config.module
            .rule('images')
            .use('imageWebpackLoader')
            .loader('image-webpack-loader')
    },
}
å¤åˆ¶ä»£ç 
```

æ·»åŠ image-webpack-loaderå‰ï¼Œæ‰“åŒ…å homeBg.png å›¾ç‰‡ å¦‚ä¸‹æ‰€ç¤º ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8e45a80d6b544a09aaac542ecdea6961~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

æ·»åŠ image-webpack-loaderåï¼Œæ‰“åŒ…å homeBg.png å›¾ç‰‡ å¦‚ä¸‹æ‰€ç¤º ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c2d22c308d14358a63ea396eb5a0239~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

å¯ä»¥çœ‹åˆ°å›¾ç‰‡å¤§å°ä»251KBå‡å°‘åˆ°110KBï¼Œä¼˜åŒ–æ•ˆæœæ˜æ˜¾ã€‚

[image-webpack-loader](https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fimage-webpack-loader)æ”¯æŒå‹ç¼©PNGï¼ŒJPEGï¼ŒGIFï¼ŒSVGå’ŒWEBPå›¾ç‰‡ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹å…¶å¸¸ç”¨çš„å‚æ•°ã€‚

- bypassOnDebug `ture/false`ï¼Œé»˜è®¤ä¸º`false`ï¼Œä¸º`true`æ—¶ç¦ç”¨å‹ç¼©å›¾ç‰‡ï¼Œåœ¨[webpack@1.x](https://link.juejin.cn?target=mailto%3Awebpack%401.x)ä¸­ä½¿ç”¨ã€‚

- disable `ture/false`ï¼Œé»˜è®¤ä¸º`false`ï¼Œä¸º`true`æ—¶ç¦ç”¨å‹ç¼©å›¾ç‰‡ï¼Œåœ¨[webpack@2.x](https://link.juejin.cn?target=mailto%3Awebpack%402.x)åŠæ›´é«˜ç‰ˆæœ¬ä¸­ä½¿ç”¨ã€‚ å¯ä»¥åœ¨å¼€å‘ç¯å¢ƒä¸­ç¦ç”¨å‹ç¼©å›¾ç‰‡ï¼Œä½¿å…¶ç¼–è¯‘é€Ÿåº¦æ›´å¿«ã€‚

  ```arduino
  module.exports = {
      chainWebpack: config =>{
          config.module
              .rule('images')
              .use('imageWebpackLoader')
              .loader('image-webpack-loader')
              .options({
                  disable: process.env.NODE_ENV === 'development',
              })
      },
  }
  å¤åˆ¶ä»£ç 
  ```

- mozjpegï¼š  æ§åˆ¶å‹ç¼©JPEGå›¾åƒçš„é…ç½®ï¼Œé»˜è®¤å¯ç”¨ã€‚å‚æ•°å€¼ä¸ºå¯¹è±¡ï¼Œå¸¸ç”¨çš„å­å‚æ•°æœ‰ï¼š

  - quality å‹ç¼©è´¨é‡ï¼ŒèŒƒå›´0ï¼ˆæœ€å·®ï¼‰è‡³100ï¼ˆæœ€å®Œç¾ï¼‰ã€‚

- optipngï¼šæ§åˆ¶å‹ç¼©PNGå›¾åƒçš„é…ç½®ï¼Œé»˜è®¤å¯ç”¨ã€‚å‚æ•°å€¼ä¸ºå¯¹è±¡ï¼Œå¸¸ç”¨çš„å­å‚æ•°æœ‰ï¼š

  - OptimizationLevel ä¼˜åŒ–çº§åˆ«ï¼Œåœ¨0å’Œ7ä¹‹é—´é€‰æ‹©ä¸€ä¸ªä¼˜åŒ–çº§åˆ«ï¼Œæ•°å€¼è¶Šé«˜ï¼Œå‹ç¼©è´¨é‡è¶Šå¥½ï¼Œä½†æ˜¯é€Ÿåº¦è¶Šæ…¢ï¼Œé»˜è®¤ä¸º3ã€‚

- pngquantï¼šæ§åˆ¶å‹ç¼©PNGå›¾åƒçš„é…ç½®ï¼Œé»˜è®¤å¯ç”¨ã€‚å‚æ•°å€¼ä¸ºå¯¹è±¡ï¼Œå¸¸ç”¨çš„å­å‚æ•°æœ‰ï¼š

  - speed å‹ç¼©é€Ÿåº¦ï¼Œåœ¨1åˆ°11ï¼Œæ•°å€¼è¶Šé«˜ï¼Œå‹ç¼©é€Ÿåº¦è¶Šå¿«ï¼Œé»˜è®¤å€¼ä¸º4ã€‚å€¼ä¸º10æ—¶è´¨é‡é™ä½5ï¼…ï¼Œä½†æ¯”é»˜è®¤é€Ÿåº¦å¿«8å€ã€‚
  - quality å‹ç¼©è´¨é‡ï¼Œå€¼ä¸ºæ•°ç»„ï¼Œå¦‚`[0 , 1]`ï¼Œæœ€å°å€¼æ˜¯0ï¼ˆæœ€å·®ï¼‰å’Œæœ€å¤§å€¼æ˜¯1ï¼ˆå®Œç¾ï¼‰ã€‚

- gifsicleï¼šæ§åˆ¶å‹ç¼©GIFå›¾åƒçš„é…ç½®ï¼Œé»˜è®¤å¯ç”¨ã€‚å‚æ•°å€¼ä¸ºå¯¹è±¡ï¼Œå¸¸ç”¨çš„å­å‚æ•°æœ‰: -OptimizationLevel ä¼˜åŒ–çº§åˆ«ï¼Œåœ¨1å’Œ3ä¹‹é—´é€‰æ‹©ä¸€ä¸ªä¼˜åŒ–çº§åˆ«ï¼Œä¼˜åŒ–çº§åˆ«ç¡®å®šå®Œæˆå¤šå°‘ä¼˜åŒ–ï¼›è¾ƒé«˜çš„æ°´å¹³éœ€è¦æ›´é•¿çš„æ—¶é—´ï¼Œä½†å¯èƒ½ä¼šæœ‰æ›´å¥½çš„æ•ˆæœã€‚

- webpï¼š å°†JPGå’ŒPNGå›¾åƒå‹ç¼©ä¸ºWEBPï¼Œé»˜è®¤ä¸å¯ç”¨ï¼Œéœ€è¦é…ç½®åæ‰å¯ç”¨ã€‚å¯ç”¨åï¼Œå¯ä»¥å°†JPGå’ŒPNGå›¾åƒå‹ç¼©è¾“å‡ºå¤§å°æ›´å°çš„å›¾ç‰‡ï¼Œä½†æ¯”ç”¨mozjpegã€optipngã€pngquantå‹ç¼©æ›´è€—æ—¶ï¼Œä¼šå½±å“ç¼–è¯‘æ‰“åŒ…é€Ÿåº¦ï¼Œéœ€è‡ªå·±å–èˆã€‚

  å‚æ•°å€¼ä¸ºå¯¹è±¡ï¼Œå¸¸ç”¨çš„å­å‚æ•°æœ‰

  - quality å“è´¨å› æ•°ï¼Œåœ¨0å’Œä¹‹é—´100è®¾ç½®ï¼Œé»˜è®¤ä¸º75ï¼Œå€¼è¶Šé«˜å“è´¨è¶Šå¥½ã€‚
  - lossless æ˜¯å¦æ— æŸå‹ç¼©ï¼Œé»˜è®¤ä¸ºfalseï¼Œä¸ºtrueæ—¶å¼€å¯æ— æŸå‹ç¼©ã€‚
  - nearLossless ä½¿ç”¨é¢å¤–çš„æœ‰æŸé¢„å¤„ç†æ­¥éª¤è¿›è¡Œæ— æŸç¼–ç ï¼Œå…¶å“è´¨å› æ•°ä»‹äº0ï¼ˆæœ€å¤§é¢„å¤„ç†ï¼‰å’Œ100ï¼ˆç­‰äºlosslessï¼‰ä¹‹é—´ã€‚

```php
module.exports = {
    chainWebpack: config =>{
        config.module
            .rule('images')
            .use('imageWebpackLoader')
            .loader('image-webpack-loader')
            .options({
                disable: process.env.NODE_ENV === 'development',
                mozjpeg:{
                    quality:75
                },
                optipng:{
                    OptimizationLevel:3
                },
                pngquant:{
                    speed:4,
                    quality:[0.2,0.5]
                },
                gifsicle:{
                    OptimizationLevel:1
                },
                webp:{
                    quality:75,
                    lossless:true,
                    nearLossless:75
                }
            })
    },
}
å¤åˆ¶ä»£ç 
```

### å››ã€é¡¹ç›®éƒ¨ç½²çš„ä¼˜åŒ–

è¿™é‡Œåªè®²ä¸€ä¸ªæ¯”è¾ƒå¸¸è§å’Œç®€å•çš„ä¼˜åŒ–æ‰‹æ®µï¼Œgzipå‹ç¼©ã€‚å…¶å®è¿˜æœ‰å…¶ä»–ä¼˜åŒ–æ‰‹æ®µï¼Œæ¶‰åŠåˆ°æœåŠ¡ç«¯ï¼Œå¦‚æœé¢è¯•å®˜æ·±ç©¶ä¼šå…¶åä½œç”¨ã€‚

#### 1ã€è¯†åˆ«gzipå‹ç¼©æ˜¯å¦å¼€å¯

è¿™ä¸ªå¾ˆç®€å•ï¼Œåªè¦çœ‹å“åº”å¤´éƒ¨ï¼ˆResponse headersï¼‰ä¸­ æœ‰æ²¡æœ‰`Content-Encoding: gzip`è¿™ä¸ªå±æ€§å³å¯ï¼Œæœ‰ä»£è¡¨æœ‰å¼€å¯gzipå‹ç¼©ã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d251ee56f34c42fca4027794c7138062~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

#### 2ã€åœ¨Nginxä¸Šå¼€å¯gzipå‹ç¼©

åœ¨nginx/conf/nginx.confä¸­é…ç½®

```ini
http {
    gzip  on;
    gzip_min_length 1k;
    gzip_comp_level 5;
    gzip_types application/javascript image/png image/gif image/jpeg text/css text/plain;
    gzip_buffers 4 4k;
    gzip_http_version 1.1;
    gzip_vary on;
}
å¤åˆ¶ä»£ç 
```

- `gzip`ï¼šon | off ï¼Œé»˜è®¤ä¸ºoffï¼Œonä¸ºå¼€å¯gzipï¼Œoffä¸ºå…³é—­gzipã€‚
- `gzip_min_length`ï¼šnumberï¼Œå‹ç¼©èµ·ç‚¹ï¼Œæ–‡ä»¶å¤§äºå¤šå°‘æ‰è¿›è¡Œå‹ç¼©ï¼Œå•ä½é»˜è®¤ä¸ºå­—èŠ‚ï¼Œä¹Ÿå¯ç”¨kè¡¨ç¤ºåƒå­—èŠ‚ã€‚
- `gzip_comp_level`ï¼šå‹ç¼©çº§åˆ«ï¼Œ1-9ï¼Œæ•°å­—è¶Šå¤§ï¼Œå‹ç¼©åçš„å¤§å°è¶Šå°ï¼Œä¹Ÿè¶Šå ç”¨CPUï¼ŒèŠ±è´¹æ—¶é—´è¶Šé•¿ã€‚
- `gzip_types`ï¼šéœ€è¦è¿›è¡Œå‹ç¼©çš„æ–‡ä»¶ç±»å‹ã€‚ç±»å‹å»Response headersä¸­çœ‹Content-Typeå±æ€§ã€‚
- `gzip_buffers`ï¼šnumber sizeï¼Œè®¾ç½®ç³»ç»Ÿè·å–å‡ ä¸ªå•ä½çš„ç¼“å­˜ç”¨äºå­˜å‚¨gzipçš„å‹ç¼©ç»“æœæ•°æ®æµã€‚ ä¾‹å¦‚ 4 4kä»£è¡¨ä»¥4kä¸ºå•ä½ï¼ŒæŒ‰ç…§åŸå§‹æ•°æ®å¤§å°ä»¥4kä¸ºå•ä½çš„4å€ç”³è¯·å†…å­˜ã€‚å¦‚åŸå§‹æ•°æ®å¤§å°ä¸º17Kï¼Œåˆ™ç”³è¯· ï¼ˆ17/4ï¼‰*4 = 17kå†…å­˜ã€‚
- `gzip_http_version`ï¼šè®¾ç½®gzipå‹ç¼©é’ˆå¯¹çš„HTTPåè®®ç‰ˆæœ¬ä»¥ä¸Šã€‚
- `gzip_vary`ï¼šon | offï¼Œæ˜¯å¦åœ¨http headerä¸­æ·»åŠ Vary:Accept-Encodingï¼Œonè¡¨ç¤ºæ·»åŠ ã€‚Vary:Accept-Encodingå‘Šè¯‰ä»£ç†æœåŠ¡å™¨ç¼“å­˜ä¸¤ç§ç‰ˆæœ¬çš„èµ„æºï¼šå‹ç¼©å’Œéå‹ç¼©ï¼Œé¿å…ä¸€ä¸ªæµè§ˆå™¨ä¸æ”¯æŒå‹ç¼©èµ„æºï¼Œè€Œå…ˆè¯·æ±‚äº†æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ç¼“å­˜äº†éå‹ç¼©çš„èµ„æºï¼Œç„¶åä¸€ä¸ªæµè§ˆå™¨æ”¯æŒå‹ç¼©èµ„æºï¼Œå†å»è¯·æ±‚äº†æœåŠ¡å™¨ï¼Œç»“æœå¾—åˆ°éå‹ç¼©èµ„æºï¼Œä½†æ˜¯åˆå»è§£å‹å®ƒï¼Œç»“æœä¼šå‡ºé”™ã€‚æ‰€ä»¥å»ºè®®è®¾ç½®ä¸ºonã€‚

å¼€å¯gzipå‹ç¼©å‰ ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f23b7e864eb84b1b9e02126abe053680~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) å¼€å¯gzipå‹ç¼©å

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c65180c285d436eb39856d97ef72f02~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

å¯¹æ¯”ä¸€ä¸‹ï¼Œä¼˜åŒ–æ•ˆæœéå¸¸æ˜æ˜¾ã€‚è‡ªå·±ä¹Ÿå¯ä»¥åœ¨æœ¬åœ°å°è¯•ä¸€ä¸‹ï¼Œæ€ä¹ˆç”¨Nginxéƒ¨ç½²Vueé¡¹ç›®å¯ä»¥çœ‹æˆ‘[è¿™ç¯‡æ–‡ç« ](https://juejin.cn/post/6844903974697435150)ã€‚

#### 3ã€åœ¨Webpackä¸Šå¼€å¯gzipå‹ç¼©

åˆ©ç”¨CompressionWebpackæ’ä»¶æ¥å®ç°gzipå‹ç¼©ã€‚

é¦–å…ˆå®‰è£…CompressionWebpackæ’ä»¶

```css
npm install compression-webpack-plugin --save-dev
å¤åˆ¶ä»£ç 
```

ç„¶ååœ¨*vue.config.js*ä¸­è¿™ä¹ˆé…ç½®

```ini
const CompressionPlugin = require('compression-webpack-plugin');
module.exports = {
    configureWebpack: config =>{
        return {
            plugins: [
                new CompressionPlugin()
            ],
        }
    }
}
å¤åˆ¶ä»£ç 
```

æ‰§è¡Œ`npm run build`å‘½ä»¤åï¼Œæ‰“å¼€*dist*æ–‡ä»¶ï¼Œä¼šå‘ç°å¤šå‡ºå¾ˆå¤šåå­—ç›¸åŒçš„æ–‡ä»¶ï¼Œåªæ˜¯å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶åç¼€ä¸º`.gz`ï¼Œè¿™å°±æ˜¯ç”¨gzipå‹ç¼©åçš„æ–‡ä»¶ã€‚ ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52c0d290451147229d0bb6d81eb9f671~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

#### 4ã€Nginxå’ŒWebpackå‹ç¼©çš„åŒºåˆ«

- ä¸ç®¡Nginxè¿˜æ˜¯Webpackå‹ç¼©ï¼Œåœ¨Nginxä¸­éƒ½è¦å¼€å¯gzipå‹ç¼©ï¼Œä¸ç„¶æµè§ˆå™¨åŠ è½½è¿˜æ˜¯æœªå‹ç¼©çš„èµ„æºã€‚

  è¿˜å¯ä»¥åœ¨NginxåŠ ä¸Š`gzip_static on;`çš„é…ç½®ã€‚`gzip_static`å¯ç”¨åï¼Œ æµè§ˆå™¨è¯·æ±‚èµ„æºæ—¶ï¼ŒNginxä¼šå…ˆæ£€æŸ¥æ˜¯å¦å­˜è¯¥èµ„æºåç§°ä¸”åç¼€ä¸º`.gz`çš„æ–‡ä»¶ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›è¯¥gzæ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥é¿å…Nginxå¯¹è¯¥èµ„æºå†è¿›è¡Œgzipå‹ç¼©ï¼Œæµªè´¹æœåŠ¡å™¨çš„CPUã€‚

- ç”¨Nginxå‹ç¼©ä¼šå ç”¨æœåŠ¡å™¨çš„CPUï¼Œæµè§ˆå™¨æ¯æ¬¡è¯·æ±‚èµ„æºï¼ŒNginxä¼šå¯¹è¯¥èµ„æºå®æ—¶å‹ç¼©ï¼Œå‹ç¼©å®Œæ¯•åæ‰ä¼šè¿”å›è¯¥èµ„æºï¼Œå¦‚æœèµ„æºå¾ˆå¤§çš„è¯ï¼Œè¿˜æ˜¯å‹ç¼©çº§åˆ«è®¾ç½®å¾ˆé«˜ï¼Œéƒ½ä¼šå¯¼è‡´è¿”å›èµ„æºçš„æ—¶é—´è¿‡é•¿ï¼Œé€ æˆä¸å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

- ç”¨Webpackä¼šä½¿æ‰“åŒ…æ—¶é—´å˜é•¿ã€‚ä½†æ˜¯ç”¨CompressionPluginæ’ä»¶å‹ç¼©ï¼Œä¼šæœ‰ç¼“å­˜ï¼Œå¯ä»¥ç›¸å¯¹å‡å°‘æ‰“åŒ…æ—¶é—´ã€‚

- å»ºè®®Nginxå’ŒWebpackå‹ç¼©éƒ½å¼€å¯å‹ç¼©ï¼Œä¸”åœ¨NginxåŠ ä¸Š`gzip_static on;`çš„é…ç½®ï¼Œå‡å°‘æœåŠ¡å™¨çš„CPUçš„ä½¿ç”¨ï¼Œå½“ç„¶è¿˜æ˜¯è¦æ ¹æ®é¡¹ç›®çš„æƒ…å†µå®é™…é€‰æ‹©ã€‚

#### 5ã€CompressionPluginæ’ä»¶çš„å‚æ•°è¯¦ç»†è¯¦è§£

- ```
  test
  ```

  ï¼šString|RegExp|Array<String|RegExp>ï¼Œ

  èµ„æºçš„åç§°

  ç¬¦åˆæ¡ä»¶çš„æ‰ä¼šè¢«å‹ç¼©ï¼Œé»˜è®¤ä¸ºundefinedï¼Œå³å…¨éƒ¨ç¬¦åˆï¼Œä¾‹å¦‚åªè¦å‹ç¼©jsæ–‡ä»¶ 

  ```css
  plugins: [
      new CompressionPlugin({
          test: /\.js(\?.*)?$/i,
      })
  ],
  å¤åˆ¶ä»£ç 
  ```

- `include`ï¼šString|RegExp|Array<String|RegExp>ï¼Œ**èµ„æºçš„åç§°**ç¬¦åˆæ¡ä»¶çš„æ‰ä¼šè¢«å‹ç¼©ï¼Œé»˜è®¤ä¸ºundefinedï¼Œæ˜¯åœ¨`test`å‚æ•°çš„èŒƒå›´å†…åœ¨è¿›è¡Œç­›é€‰ï¼Œæ»¡è¶³`test`å‚æ•°çš„æ¡ä»¶ï¼Œä¸”æ»¡è¶³`include`å‚æ•°çš„æ¡ä»¶çš„èµ„æºæ‰ä¼šè¢«å‹ç¼©ã€‚

- `exclude`ï¼šString|RegExp|Array<String|RegExp>ï¼Œå‹ç¼©æ—¶æ’é™¤**èµ„æºçš„åç§°**ç¬¦åˆæ¡ä»¶çš„èµ„æºï¼Œé»˜è®¤ä¸ºundefinedï¼Œæ˜¯åœ¨`test`å‚æ•°çš„èŒƒå›´å†…åœ¨è¿›è¡Œæ’é™¤ï¼Œæ»¡è¶³`test`å‚æ•°çš„æ¡ä»¶ï¼Œä¸æ»¡è¶³`exclude`å‚æ•°çš„æ¡ä»¶çš„èµ„æºæ‰ä¼šè¢«å‹ç¼©ã€‚

- `algorithm`ï¼šå‹ç¼©ç®—æ³•/åŠŸèƒ½ï¼Œé»˜è®¤gzipï¼Œä¸€èˆ¬ä¸åšæ›´æ”¹ã€‚

- ```
  compressionOptions
  ```

  ï¼Œå¯¹

  ```
  algorithm
  ```

  å‚æ•°æ‰€é€‰ç”¨çš„å‹ç¼©åŠŸèƒ½çš„å‚æ•°è®¾ç½®ï¼Œä¸€èˆ¬ç”¨æ¥è®¾ç½®å‹ç¼©çº§åˆ«ï¼Œ1-9ï¼Œæ•°å­—è¶Šå¤§ï¼Œå‹ç¼©åçš„å¤§å°è¶Šå°ï¼Œä¹Ÿè¶Šå ç”¨CPUï¼ŒèŠ±è´¹æ—¶é—´ä¹Ÿè¶Šé•¿ã€‚ 

  ```css
  plugins: [
      new CompressionPlugin({
          compressionOptions: { level: 1 },
      })
  ],
  å¤åˆ¶ä»£ç 
  ```

- `threshold`ï¼šNumberï¼Œè®¾ç½®è¢«å‹ç¼©èµ„æºçš„æœ€å°å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚é»˜è®¤ä¸º0ã€‚

- `minRatio`ï¼šNumberï¼Œè®¾ç½®å‹ç¼©æ¯”ç‡ï¼Œå‹ç¼©æ¯”ç‡ = å‹ç¼©åçš„èµ„æºçš„å¤§å°/å‹ç¼©åçš„èµ„æºï¼Œå°äºå‹ç¼©æ¯”ç‡çš„èµ„æºæ‰ä¼šè¢«å‹ç¼©ã€‚å’Œ`threshold`å‚æ•°æ˜¯â€˜ä¸â€™çš„å…³ç³»ã€‚

- `filename`ï¼šç±»å‹ï¼šString|Functionï¼Œè®¾ç½®å‹ç¼©èµ„æºåçš„åç§°ï¼Œé»˜è®¤å€¼ï¼š[path].gz[query]ï¼Œ [file]è¢«æ›¿æ¢ä¸ºåŸå§‹èµ„äº§æ–‡ä»¶åã€‚ [path]æ›¿æ¢ä¸ºåŸå§‹èµ„äº§çš„è·¯å¾„ã€‚ [dir]æ›¿æ¢ä¸ºåŸå§‹èµ„äº§çš„ç›®å½•ã€‚ [name]è¢«æ›¿æ¢ä¸ºåŸå§‹èµ„äº§çš„æ–‡ä»¶åã€‚ [ext]æ›¿æ¢ä¸ºåŸå§‹èµ„äº§çš„æ‰©å±•åã€‚ [query]è¢«æŸ¥è¯¢æ›¿æ¢ã€‚ ä¸‹é¢ç”¨å‡½æ•°æŠŠå„ç±»çš„å€¼éƒ½æ‰“å°å‡ºæ¥ã€‚

```javascript
 new CompressionPlugin({
    filename(info) {
        console.log(info)
        return `${info.path}.gz${info.query}`;
    },
})
å¤åˆ¶ä»£ç 
```

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b24d3455d8364959bf7468a89b628207~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

- `deleteOriginalAssets`ï¼šBooleanï¼Œé»˜è®¤ä¸º`false`ï¼Œä¸º`true`æ—¶åˆ é™¤åŸå§‹èµ„æºæ–‡ä»¶ã€‚ä¸å»ºè®®è®¾ç½®ã€‚
- `cache`ï¼šBoolean|Stringï¼Œé»˜è®¤ä¸º`true`ï¼Œä¸º`true`æ—¶ï¼Œå¯ç”¨æ–‡ä»¶ç¼“å­˜ã€‚ç¼“å­˜ç›®å½•çš„é»˜è®¤è·¯å¾„ï¼š*node_modules/.cache/compression-webpack-plugin*ã€‚å€¼ä¸ºStringæ—¶ã€‚å¯ç”¨æ–‡ä»¶ç¼“å­˜å¹¶è®¾ç½®ç¼“å­˜ç›®å½•çš„è·¯å¾„ã€‚

```arduino
new CompressionPlugin({
      cache: 'path/to/cache',
}),
```



# 0 å‰è¨€

åœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œæ€§èƒ½ä¸€ç›´éƒ½æ˜¯è¢«å¤§å®¶æ‰€é‡è§†çš„ä¸€ç‚¹ï¼Œç„¶è€Œåˆ¤æ–­ä¸€ä¸ªç½‘ç«™çš„æ€§èƒ½æœ€ç›´è§‚çš„å°±æ˜¯çœ‹ç½‘é¡µæ‰“å¼€çš„é€Ÿåº¦ã€‚**å…¶ä¸­æé«˜ç½‘é¡µååº”é€Ÿåº¦çš„ä¸€ä¸ªæ–¹å¼å°±æ˜¯ä½¿ç”¨ç¼“å­˜**ã€‚ç¼“å­˜æŠ€æœ¯ä¸€ç›´ä¸€æ¥åœ¨WEBæŠ€æœ¯ä½“ç³»ä¸­æ‰®æ¼”éå¸¸é‡è¦è§’è‰²ï¼Œæ˜¯å¿«é€Ÿä¸”æœ‰æ•ˆåœ°æå‡æ€§èƒ½çš„æ‰‹æ®µã€‚

ä¸€ä¸ªä¼˜ç§€çš„ç¼“å­˜ç­–ç•¥å¯ä»¥ç¼©çŸ­ç½‘é¡µè¯·æ±‚èµ„æºçš„è·ç¦»ï¼Œå‡å°‘å»¶è¿Ÿï¼Œå¹¶ä¸”ç”±äºç¼“å­˜æ–‡ä»¶å¯ä»¥é‡å¤åˆ©ç”¨ï¼Œè¿˜å¯ä»¥å‡å°‘å¸¦å®½ï¼Œé™ä½ç½‘ç»œè´Ÿè·ã€‚

æ‰€ä»¥ï¼Œç¼“å­˜æŠ€æœ¯æ˜¯æ— æ•°WEBå¼€å‘ä»ä¸šäººå‘˜åœ¨å·¥ä½œè¿‡ç¨‹ä¸­ä¸å¯é¿å…çš„ä¸€å¤§é—®é¢˜ã€‚**åœ¨äº§å“å¼€å‘çš„æ—¶å€™æˆ‘ä»¬æ€»æ˜¯æƒ³åŠæ³•é¿å…ç¼“å­˜äº§ç”Ÿï¼Œè€Œåœ¨äº§å“å‘å¸ƒä¹‹æ—¶åˆåœ¨æƒ³ç­–ç•¥ç®¡ç†ç¼“å­˜æå‡ç½‘é¡µçš„è®¿é—®é€Ÿåº¦**ã€‚äº†è§£æµè§ˆå™¨çš„ç¼“å­˜å‘½ä¸­åŸç†ï¼Œæ˜¯å¼€å‘WEBåº”ç”¨çš„åŸºç¡€ï¼Œæœ¬æ–‡ç€çœ¼äºæ­¤ï¼Œå­¦ä¹ æµè§ˆå™¨ç¼“å­˜çš„ç›¸å…³çŸ¥è¯†ï¼Œæ€»ç»“ç¼“å­˜é¿å…å’Œç¼“å­˜ç®¡ç†çš„æ–¹æ³•ï¼Œç»“åˆå…·ä½“çš„åœºæ™¯è¯´æ˜ç¼“å­˜çš„ç›¸å…³é—®é¢˜ã€‚å¸Œæœ›èƒ½å¯¹æœ‰éœ€è¦çš„äººæœ‰æ‰€å¸®åŠ©ã€‚

# 1 WEBç¼“å­˜ä½“ç³»

åœ¨å®é™…WEBå¼€å‘è¿‡ç¨‹ä¸­ï¼Œç¼“å­˜æŠ€æœ¯ä¼šæ¶‰åŠåˆ°ä¸åŒå±‚ã€ä¸åŒç«¯ï¼Œæ¯”å¦‚ï¼šç”¨æˆ·å±‚ã€ç³»ç»Ÿå±‚ã€ä»£ç†å±‚ã€å‰ç«¯ã€åç«¯ã€æœåŠ¡ç«¯ç­‰ï¼Œ**æ¯ä¸€å±‚çš„ç¼“å­˜ç›®æ ‡éƒ½æ˜¯ä¸€è‡´çš„ï¼Œå°±æ˜¯å°½å¿«è¿”å›è¯·æ±‚æ•°æ®ã€å‡å°‘å»¶è¿Ÿ**ï¼Œä½†æ¯å±‚ä½¿ç”¨çš„æŠ€æœ¯å®ç°æ˜¯å„æœ‰ä¸åŒï¼Œé¢å¯¹ä¸åŒå±‚ã€ä¸åŒç«¯çš„ä¼˜åŠ£ï¼Œé€‰ç”¨ä¸åŒçš„æŠ€æœ¯æ¥æå‡ç³»ç»Ÿå“åº”æ•ˆç‡ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹å„å±‚çš„ç¼“å­˜éƒ½æœ‰å“ªäº›æŠ€æœ¯ï¼Œéƒ½ç¼“å­˜å“ªäº›æ•°æ®ï¼Œä»æ•´ä½“ä¸Šï¼Œå¯¹WEBçš„ç¼“å­˜æŠ€æœ¯è¿›è¡Œäº†è§£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![WEBå„å±‚ç¼“å­˜æŠ€æœ¯ä½“ç³»](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74ced1550cb8~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)



æœ¬ç¯‡æ–‡ç« é‡ç‚¹è®²çš„å°±æ˜¯ä¸Šé¢çº¢è‰²æ¡†éƒ¨åˆ†ç¼“å­˜å†…å®¹ã€‚

# 2 è®¤è¯†æµè§ˆå™¨ç¼“å­˜

å½“æµè§ˆå™¨è¯·æ±‚ä¸€ä¸ªç½‘ç«™çš„æ—¶å€™ï¼Œä¼šåŠ è½½å„ç§å„æ ·çš„èµ„æºï¼Œæ¯”å¦‚ï¼šHTMLæ–‡æ¡£ã€å›¾ç‰‡ã€CSSå’ŒJSç­‰æ–‡ä»¶ã€‚å¯¹äºä¸€äº›ä¸ç»å¸¸å˜çš„å†…å®¹ï¼Œæµè§ˆå™¨ä¼šå°†ä»–ä»¬ä¿å­˜åœ¨æœ¬åœ°çš„æ–‡ä»¶ä¸­ï¼Œä¸‹æ¬¡è®¿é—®ç›¸åŒç½‘ç«™çš„æ—¶å€™ï¼Œç›´æ¥åŠ è½½è¿™äº›èµ„æºï¼ŒåŠ é€Ÿè®¿é—®ã€‚

> è¿™äº›è¢«æµè§ˆå™¨ä¿å­˜çš„æ–‡ä»¶å°±è¢«ç§°ä¸ºç¼“å­˜ï¼ˆä¸æ˜¯æŒ‡Cookieæˆ–è€…Localstorageï¼‰ã€‚

é‚£ä¹ˆå¦‚ä½•çŸ¥æ™“æµè§ˆå™¨æ˜¯è¯»å–äº†ç¼“å­˜è¿˜æ˜¯ç›´æ¥è¯·æ±‚æœåŠ¡å™¨ï¼Ÿå¦‚ä¸‹å›¾ç½‘ç«™æ¥åšä¸ªç¤ºä¾‹ï¼š



![æµè§ˆå™¨ç¼“å­˜ç¤ºä¾‹](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74ced0854320~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)



ç¬¬ä¸€æ¬¡æ‰“å¼€è¯¥ç½‘ç«™åï¼Œå¦‚æœå†æ¬¡åˆ·æ–°é¡µé¢ã€‚ä¼šå‘ç°æµè§ˆå™¨åŠ è½½çš„ä¼—å¤šèµ„æºä¸­ï¼Œæœ‰ä¸€éƒ¨åˆ†sizeæœ‰å…·ä½“æ•°å€¼ï¼Œç„¶è€Œè¿˜æœ‰ä¸€éƒ¨åˆ†è¯·æ±‚ï¼Œæ¯”å¦‚å›¾ç‰‡ã€csså’Œjsç­‰æ–‡ä»¶å¹¶æ²¡æœ‰æ˜¾ç¤ºæ–‡ä»¶å¤§å°ï¼Œè€Œæ˜¯æ˜¾ç¤ºäº† `from dis cache` æˆ–è€… `from memory cache` å­—æ ·ã€‚è¿™å°±è¯´æ˜äº†ï¼Œè¯¥èµ„æºç›´æ¥ä»æœ¬åœ°ç¡¬ç›˜æˆ–è€…æµè§ˆå™¨å†…å­˜è¯»å–ï¼Œè€Œå¹¶æ²¡æœ‰è¯·æ±‚æœåŠ¡å™¨ã€‚

æµè§ˆå™¨å¯ç”¨ç¼“å­˜è‡³å°‘æœ‰ä¸¤ç‚¹æ˜¾è€Œæ˜“è§çš„å¥½å¤„ï¼š**ï¼ˆ1ï¼‰å‡å°‘é¡µé¢åŠ è½½æ—¶é—´ï¼›ï¼ˆ2ï¼‰å‡å°‘æœåŠ¡å™¨è´Ÿè½½ï¼›**

**æµè§ˆå™¨æ˜¯å¦ä½¿ç”¨ç¼“å­˜ã€ç¼“å­˜å¤šä¹…ï¼Œæ˜¯ç”±æœåŠ¡å™¨æ§åˆ¶çš„**ã€‚å‡†ç¡®æ¥è¯´ï¼Œå½“æµè§ˆå™¨è¯·æ±‚ä¸€ä¸ªç½‘é¡µï¼ˆæˆ–è€…å…¶ä»–èµ„æºï¼‰æ—¶ï¼Œ**æœåŠ¡å™¨å‘å›çš„å“åº”çš„ã€Œå“åº”å¤´ã€éƒ¨åˆ†çš„æŸäº›å­—æ®µæŒ‡æ˜äº†æœ‰å…³ç¼“å­˜çš„å…³é”®ä¿¡æ¯**ã€‚ä¸‹é¢çœ‹ä¸‹ï¼ŒHTTPæŠ¥æ–‡ä¸­ä¸ç¼“å­˜ç›¸å…³çš„é¦–éƒ¨å­—æ®µï¼š

1. **é€šç”¨é¦–éƒ¨å­—æ®µ**ï¼ˆå°±æ˜¯è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡éƒ½èƒ½ç”¨ä¸Šçš„å­—æ®µï¼‰

   

   ![é€šç”¨é¦–éƒ¨å­—æ®µ](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74ced137bcc2~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

2. **è¯·æ±‚é¦–éƒ¨å­—æ®µ**

   

   ![è¯·æ±‚é¦–éƒ¨å­—æ®µ](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74ced09f1146~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

3. **å“åº”é¦–éƒ¨å­—æ®µ**

   

   ![å“åº”é¦–éƒ¨å­—æ®µ](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74ced1676641~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

4. **å®ä½“é¦–éƒ¨å­—æ®µ**

   

   ![å®ä½“é¦–éƒ¨å­—æ®µ](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74cedc1725cf~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

# 3 æµè§ˆå™¨ç¼“å­˜æœºåˆ¶

æ ¹æ®ä¸Šé¢å››ç§ç±»å‹çš„é¦–éƒ¨å­—æ®µä¸åŒä½¿ç”¨ç­–ç•¥ï¼Œ**æµè§ˆå™¨ä¸­ç¼“å­˜å¯åˆ†ä¸ºå¼ºç¼“å­˜å’Œåå•†ç¼“å­˜**ï¼š

> 1ï¼‰æµè§ˆå™¨åœ¨åŠ è½½èµ„æºæ—¶ï¼Œå…ˆæ ¹æ®è¿™ä¸ªèµ„æºçš„ä¸€äº›http headeråˆ¤æ–­å®ƒæ˜¯å¦å‘½ä¸­å¼ºç¼“å­˜ï¼Œ**å¼ºç¼“å­˜å¦‚æœå‘½ä¸­ï¼Œæµè§ˆå™¨ç›´æ¥ä»è‡ªå·±çš„ç¼“å­˜ä¸­è¯»å–èµ„æºï¼Œä¸ä¼šå‘è¯·æ±‚åˆ°æœåŠ¡å™¨**ã€‚æ¯”å¦‚ï¼šæŸä¸ªcssæ–‡ä»¶ï¼Œå¦‚æœæµè§ˆå™¨åœ¨åŠ è½½å®ƒæ‰€åœ¨çš„ç½‘é¡µæ—¶ï¼Œè¿™ä¸ªcssæ–‡ä»¶çš„ç¼“å­˜é…ç½®å‘½ä¸­äº†å¼ºç¼“å­˜ï¼Œæµè§ˆå™¨å°±ç›´æ¥ä»ç¼“å­˜ä¸­åŠ è½½è¿™ä¸ªcssï¼Œè¿è¯·æ±‚éƒ½ä¸ä¼šå‘é€åˆ°ç½‘é¡µæ‰€åœ¨æœåŠ¡å™¨ï¼›
>
> 2ï¼‰å½“å¼ºç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¸€å®šä¼šå‘é€ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œ**é€šè¿‡æœåŠ¡å™¨ç«¯ä¾æ®èµ„æºçš„å¦å¤–ä¸€äº›http headeréªŒè¯è¿™ä¸ªèµ„æºæ˜¯å¦å‘½ä¸­åå•†ç¼“å­˜**ï¼Œå¦‚æœåå•†ç¼“å­˜å‘½ä¸­ï¼ŒæœåŠ¡å™¨ä¼šå°†è¿™ä¸ªè¯·æ±‚è¿”å›ï¼Œ**ä½†æ˜¯ä¸ä¼šè¿”å›è¿™ä¸ªèµ„æºçš„æ•°æ®ï¼Œè€Œæ˜¯å‘Šè¯‰å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­åŠ è½½è¿™ä¸ªèµ„æº**ï¼Œäºæ˜¯æµè§ˆå™¨å°±åˆä¼šä»è‡ªå·±çš„ç¼“å­˜ä¸­å»åŠ è½½è¿™ä¸ªèµ„æºï¼›
>
> 3ï¼‰å¼ºç¼“å­˜ä¸åå•†ç¼“å­˜çš„å…±åŒç‚¹æ˜¯ï¼š**å¦‚æœå‘½ä¸­ï¼Œéƒ½æ˜¯ä»å®¢æˆ·ç«¯ç¼“å­˜ä¸­åŠ è½½èµ„æºï¼Œè€Œä¸æ˜¯ä»æœåŠ¡å™¨åŠ è½½èµ„æºæ•°æ®**ï¼›åŒºåˆ«æ˜¯ï¼š**å¼ºç¼“å­˜ä¸å‘è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œåå•†ç¼“å­˜ä¼šå‘è¯·æ±‚åˆ°æœåŠ¡å™¨**ã€‚
>
> 4ï¼‰å½“åå•†ç¼“å­˜ä¹Ÿæ²¡æœ‰å‘½ä¸­çš„æ—¶å€™ï¼Œæµè§ˆå™¨ç›´æ¥ä»æœåŠ¡å™¨åŠ è½½èµ„æºæ•°æ®ã€‚

## 3.1 å¼ºç¼“å­˜ï¼šExpires&Cache-Control

å½“æµè§ˆå™¨å¯¹æŸä¸ªèµ„æºçš„è¯·æ±‚å‘½ä¸­äº†å¼ºç¼“å­˜æ—¶ï¼Œ**è¿”å›çš„HTTPçŠ¶æ€ä¸º200**ï¼Œåœ¨chromeçš„å¼€å‘è€…å·¥å…·çš„networké‡Œé¢ **sizeä¼šæ˜¾ç¤ºä¸ºfrom cache**ï¼Œæ¯”å¦‚ï¼šäº¬ä¸œçš„é¦–é¡µé‡Œå°±æœ‰å¾ˆå¤šé™æ€èµ„æºé…ç½®äº†å¼ºç¼“å­˜ï¼Œç”¨chromeæ‰“å¼€å‡ æ¬¡ï¼Œå†ç”¨f12æŸ¥çœ‹networkï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸å°‘è¯·æ±‚å°±æ˜¯ä»ç¼“å­˜ä¸­åŠ è½½çš„ï¼š



![å‘½ä¸­å¼ºç¼“å­˜](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74cef1897f96~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)



> **å¼ºç¼“å­˜æ˜¯åˆ©ç”¨Expiresæˆ–è€…Cache-Controlè¿™ä¸¤ä¸ªhttp response headerå®ç°çš„ï¼Œå®ƒä»¬éƒ½ç”¨æ¥è¡¨ç¤ºèµ„æºåœ¨å®¢æˆ·ç«¯ç¼“å­˜çš„æœ‰æ•ˆæœŸ**ã€‚

**Expiresæ˜¯HTTP 1.0æå‡ºçš„ä¸€ä¸ªè¡¨ç¤ºèµ„æºè¿‡æœŸæ—¶é—´çš„headerï¼Œå®ƒæè¿°çš„æ˜¯ä¸€ä¸ªç»å¯¹æ—¶é—´ï¼Œç”±æœåŠ¡å™¨è¿”å›ï¼Œç”¨GMTæ ¼å¼çš„å­—ç¬¦ä¸²è¡¨ç¤º**ï¼Œå¦‚ï¼šExpires:Thu, 31 Dec 2037 23:55:55 GMTï¼ŒåŒ…å«äº†Expireså¤´æ ‡ç­¾çš„æ–‡ä»¶ï¼Œå°±è¯´æ˜æµè§ˆå™¨å¯¹äºè¯¥æ–‡ä»¶ç¼“å­˜å…·æœ‰éå¸¸å¤§çš„æ§åˆ¶æƒã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ªæ–‡ä»¶çš„Expireså€¼æ˜¯2020å¹´çš„1æœˆ1æ—¥ï¼Œé‚£ä¹ˆå°±ä»£è¡¨ï¼Œåœ¨2020å¹´1æœˆ1æ—¥ä¹‹å‰ï¼Œæµè§ˆå™¨éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥æ–‡ä»¶çš„æœ¬åœ°ç¼“å­˜æ–‡ä»¶ï¼Œè€Œä¸å¿…å»æœåŠ¡å™¨å†æ¬¡è¯·æ±‚è¯¥æ–‡ä»¶ï¼Œå“ªæ€•æœåŠ¡å™¨æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–ã€‚

æ‰€ä»¥ï¼Œ**Expiresæ˜¯ä¼˜åŒ–ä¸­æœ€ç†æƒ³çš„æƒ…å†µï¼Œå› ä¸ºå®ƒæ ¹æœ¬ä¸ä¼šäº§ç”Ÿè¯·æ±‚**ï¼Œæ‰€ä»¥åç«¯ä¹Ÿå°±æ— éœ€è€ƒè™‘æŸ¥è¯¢å¿«æ…¢ã€‚å®ƒçš„ç¼“å­˜åŸç†ï¼Œå¦‚ä¸‹ï¼š

1. æµè§ˆå™¨ç¬¬ä¸€æ¬¡è·ŸæœåŠ¡å™¨è¯·æ±‚ä¸€ä¸ªèµ„æºï¼ŒæœåŠ¡å™¨åœ¨è¿”å›è¿™ä¸ªèµ„æºçš„åŒæ—¶ï¼Œåœ¨responseçš„headeråŠ ä¸ŠExpiresçš„headerï¼Œå¦‚ï¼š

   

   ![responseçš„headeråŠ ä¸ŠExpires](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74cf04b04c8a~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

2. æµè§ˆå™¨åœ¨æ¥æ”¶åˆ°è¿™ä¸ªèµ„æºåï¼Œä¼šæŠŠè¿™ä¸ªèµ„æºè¿åŒæ‰€æœ‰response headerä¸€èµ·ç¼“å­˜ä¸‹æ¥ï¼ˆæ‰€ä»¥ç¼“å­˜å‘½ä¸­çš„è¯·æ±‚è¿”å›çš„headerå¹¶ä¸æ˜¯æ¥è‡ªæœåŠ¡å™¨ï¼Œè€Œæ˜¯æ¥è‡ªä¹‹å‰ç¼“å­˜çš„headerï¼‰ï¼›

3. æµè§ˆå™¨å†è¯·æ±‚è¿™ä¸ªèµ„æºæ—¶ï¼Œ**å…ˆä»ç¼“å­˜ä¸­å¯»æ‰¾ï¼Œæ‰¾åˆ°è¿™ä¸ªèµ„æºåï¼Œæ‹¿å‡ºå®ƒçš„Expiresè·Ÿå½“å‰çš„è¯·æ±‚æ—¶é—´æ¯”è¾ƒ**ï¼Œå¦‚æœè¯·æ±‚æ—¶é—´åœ¨ExpiresæŒ‡å®šçš„æ—¶é—´ä¹‹å‰ï¼Œå°±èƒ½å‘½ä¸­ç¼“å­˜ï¼Œå¦åˆ™å°±ä¸è¡Œï¼›

4. å¦‚æœç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œæµè§ˆå™¨ç›´æ¥ä»æœåŠ¡å™¨åŠ è½½èµ„æºæ—¶ï¼ŒExpires Headeråœ¨é‡æ–°åŠ è½½çš„æ—¶å€™ä¼šè¢«æ›´æ–°ï¼›

Expiresæ˜¯è¾ƒè€çš„å¼ºç¼“å­˜ç®¡ç†headerï¼Œ**ç”±äºå®ƒæ˜¯æœåŠ¡å™¨è¿”å›çš„ä¸€ä¸ªç»å¯¹æ—¶é—´**ï¼Œåœ¨æœåŠ¡å™¨æ—¶é—´ä¸å®¢æˆ·ç«¯æ—¶é—´ç›¸å·®è¾ƒå¤§æ—¶ï¼Œç¼“å­˜ç®¡ç†å®¹æ˜“å‡ºç°é—®é¢˜ï¼Œ**æ¯”å¦‚ï¼šéšæ„ä¿®æ”¹ä¸‹å®¢æˆ·ç«¯æ—¶é—´ï¼Œå°±èƒ½å½±å“ç¼“å­˜å‘½ä¸­çš„ç»“æœ**ã€‚æ‰€ä»¥åœ¨HTTP 1.1çš„æ—¶å€™ï¼Œæå‡ºäº†ä¸€ä¸ªæ–°çš„headerï¼Œ**å°±æ˜¯Cache-Controlï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å¯¹æ—¶é—´ï¼Œåœ¨é…ç½®ç¼“å­˜çš„æ—¶å€™ï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œç”¨æ•°å€¼è¡¨ç¤º**ï¼Œå¦‚ï¼šCache-Control:max-age=315360000ï¼Œå®ƒçš„ç¼“å­˜åŸç†æ˜¯ï¼š

1. æµè§ˆå™¨ç¬¬ä¸€æ¬¡è·ŸæœåŠ¡å™¨è¯·æ±‚ä¸€ä¸ªèµ„æºï¼ŒæœåŠ¡å™¨åœ¨è¿”å›è¿™ä¸ªèµ„æºçš„åŒæ—¶ï¼Œåœ¨responseçš„headeråŠ ä¸ŠCache-Controlçš„headerï¼Œå¦‚ï¼š

   

   ![responseçš„headeråŠ ä¸ŠCache-Control](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74cf19190d29~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

2. æµè§ˆå™¨åœ¨æ¥æ”¶åˆ°è¿™ä¸ªèµ„æºåï¼Œä¼šæŠŠè¿™ä¸ªèµ„æºè¿åŒæ‰€æœ‰response headerä¸€èµ·ç¼“å­˜ä¸‹æ¥ï¼›

3. æµè§ˆå™¨å†è¯·æ±‚è¿™ä¸ªèµ„æºæ—¶ï¼Œ**å…ˆä»ç¼“å­˜ä¸­å¯»æ‰¾ï¼Œæ‰¾åˆ°è¿™ä¸ªèµ„æºåï¼Œæ ¹æ®å®ƒç¬¬ä¸€æ¬¡çš„è¯·æ±‚æ—¶é—´å’ŒCache-Controlè®¾å®šçš„æœ‰æ•ˆæœŸ**ï¼Œè®¡ç®—å‡ºä¸€ä¸ªèµ„æºè¿‡æœŸæ—¶é—´ï¼Œå†æ‹¿è¿™ä¸ªè¿‡æœŸæ—¶é—´è·Ÿå½“å‰çš„è¯·æ±‚æ—¶é—´æ¯”è¾ƒï¼Œå¦‚æœè¯·æ±‚æ—¶é—´åœ¨è¿‡æœŸæ—¶é—´ä¹‹å‰ï¼Œå°±èƒ½å‘½ä¸­ç¼“å­˜ï¼Œå¦åˆ™å°±ä¸è¡Œï¼›

4. å¦‚æœç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œæµè§ˆå™¨ç›´æ¥ä»æœåŠ¡å™¨åŠ è½½èµ„æºæ—¶ï¼Œ**Cache-Control Headeråœ¨é‡æ–°åŠ è½½çš„æ—¶å€™ä¼šè¢«æ›´æ–°**ï¼›

**Cache-Controlæè¿°çš„æ˜¯ä¸€ä¸ªç›¸å¯¹æ—¶é—´**ï¼Œåœ¨è¿›è¡Œç¼“å­˜å‘½ä¸­çš„æ—¶å€™ï¼Œ**éƒ½æ˜¯åˆ©ç”¨å®¢æˆ·ç«¯æ—¶é—´è¿›è¡Œåˆ¤æ–­**ï¼Œæ‰€ä»¥ç›¸æ¯”è¾ƒExpiresï¼ŒCache-Controlçš„ç¼“å­˜ç®¡ç†æ›´æœ‰æ•ˆï¼Œå®‰å…¨ä¸€äº›ã€‚

è¿™ä¸¤ä¸ªheaderå¯ä»¥åªå¯ç”¨ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥åŒæ—¶å¯ç”¨ï¼Œ**å½“response headerä¸­ï¼ŒExpireså’ŒCache-ControlåŒæ—¶å­˜åœ¨æ—¶ï¼ŒCache-Controlä¼˜å…ˆçº§é«˜äºExpires**ï¼š



![Cache-Controlä¼˜å…ˆçº§é«˜äºExpires](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74cf18869548~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)



æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä¸º Cache-Control æŒ‡å®š `public` æˆ– `private` æ ‡è®°ã€‚**å¦‚æœä½¿ç”¨ privateï¼Œåˆ™è¡¨ç¤ºè¯¥èµ„æºä»…ä»…å±äºå‘å‡ºè¯·æ±‚çš„æœ€ç»ˆç”¨æˆ·ï¼Œè¿™å°†ç¦æ­¢ä¸­é—´æœåŠ¡å™¨ï¼ˆå¦‚ä»£ç†æœåŠ¡å™¨ï¼‰ç¼“å­˜æ­¤ç±»èµ„æº**ã€‚å¯¹äºåŒ…å«ç”¨æˆ·ä¸ªäººä¿¡æ¯çš„æ–‡ä»¶ï¼ˆå¦‚ä¸€ä¸ªåŒ…å«ç”¨æˆ·åçš„ HTML æ–‡æ¡£ï¼‰ï¼Œå¯ä»¥è®¾ç½® privateï¼Œä¸€æ–¹é¢ç”±äºè¿™äº›ç¼“å­˜å¯¹å…¶ä»–ç”¨æˆ·æ¥è¯´æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œå¦ä¸€æ–¹é¢ç”¨æˆ·å¯èƒ½ä¸å¸Œæœ›ç›¸å…³æ–‡ä»¶å‚¨å­˜åœ¨ä¸å—ä¿¡ä»»çš„æœåŠ¡å™¨ä¸Šã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œprivate å¹¶ä¸ä¼šä½¿å¾—ç¼“å­˜æ›´åŠ å®‰å…¨ï¼Œå®ƒåŒæ ·ä¼šä¼ ç»™ä¸­é—´æœåŠ¡å™¨ï¼ˆå¦‚æœç½‘ç«™å¯¹äºä¼ è¾“çš„å®‰å…¨æ€§è¦æ±‚å¾ˆé«˜ï¼Œåº”è¯¥ä½¿ç”¨ä¼ è¾“å±‚å®‰å…¨æªæ–½ï¼‰ã€‚**å¯¹äº publicï¼Œåˆ™å…è®¸æ‰€æœ‰æœåŠ¡å™¨ç¼“å­˜è¯¥èµ„æº**ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯¹äºæ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®çš„èµ„æºï¼ˆä¾‹å¦‚ç½‘ç«™çš„ logoã€å›¾ç‰‡ã€è„šæœ¬ç­‰ï¼‰ï¼Œ**Cache-Control é»˜è®¤è®¾ä¸º public æ˜¯åˆç†çš„**ã€‚

## 3.2 åå•†ç¼“å­˜ï¼šLast-Modified&Etag

å½“æµè§ˆå™¨å¯¹æŸä¸ªèµ„æºçš„è¯·æ±‚æ²¡æœ‰å‘½ä¸­å¼ºç¼“å­˜ï¼Œ**å°±ä¼šå‘ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡å™¨ï¼ŒéªŒè¯åå•†ç¼“å­˜æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœåå•†ç¼“å­˜å‘½ä¸­ï¼Œè¯·æ±‚å“åº”è¿”å›çš„httpçŠ¶æ€ä¸º304å¹¶ä¸”ä¼šæ˜¾ç¤ºä¸€ä¸ªNot Modifiedçš„å­—ç¬¦ä¸²**ï¼Œæ¯”å¦‚ä½ æ‰“å¼€äº¬ä¸œçš„é¦–é¡µï¼ŒæŒ‰f12æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œå†æŒ‰f5åˆ·æ–°é¡µé¢ï¼ŒæŸ¥çœ‹networkï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸å°‘è¯·æ±‚å°±æ˜¯å‘½ä¸­äº†åå•†ç¼“å­˜çš„ï¼š



![å‘½ä¸­åå•†ç¼“å­˜](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74cf1570ab4b~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)



æŸ¥çœ‹å•ä¸ªè¯·æ±‚çš„Response Headerï¼Œ**ä¹Ÿèƒ½çœ‹åˆ°304çš„çŠ¶æ€ç å’ŒNot Modifiedçš„å­—ç¬¦ä¸²ï¼Œåªè¦çœ‹åˆ°è¿™ä¸ªå°±å¯è¯´æ˜è¿™ä¸ªèµ„æºæ˜¯å‘½ä¸­äº†åå•†ç¼“å­˜ï¼Œç„¶åä»å®¢æˆ·ç«¯ç¼“å­˜ä¸­åŠ è½½çš„**ï¼Œè€Œä¸æ˜¯æœåŠ¡å™¨æœ€æ–°çš„èµ„æºï¼š



![å‘½ä¸­åå•†ç¼“å­˜ 304 Not Modified](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74d0451f2563~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)



> **åå•†ç¼“å­˜æ˜¯åˆ©ç”¨çš„æ˜¯ã€Last-Modifiedï¼ŒIf-Modified-Sinceã€‘å’Œã€ETagã€If-None-Matchã€‘è¿™ä¸¤å¯¹Headeræ¥ç®¡ç†çš„**ã€‚

**ã€Last-Modifiedï¼ŒIf-Modified-Sinceã€‘çš„æ§åˆ¶ç¼“å­˜çš„åŸç†ï¼Œå¦‚ä¸‹**ï¼š

1. æµè§ˆå™¨ç¬¬ä¸€æ¬¡è·ŸæœåŠ¡å™¨è¯·æ±‚ä¸€ä¸ªèµ„æºï¼ŒæœåŠ¡å™¨åœ¨è¿”å›è¿™ä¸ªèµ„æºçš„åŒæ—¶ï¼Œ**åœ¨responseçš„headeråŠ ä¸ŠLast-Modifiedçš„headerï¼Œè¿™ä¸ªheaderè¡¨ç¤ºè¿™ä¸ªèµ„æºåœ¨æœåŠ¡å™¨ä¸Šçš„æœ€åä¿®æ”¹æ—¶é—´**ï¼š

   

   ![responseçš„headeråŠ ä¸ŠLast-Modified](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74d0480c1ca9~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

2. æµè§ˆå™¨å†æ¬¡è·ŸæœåŠ¡å™¨è¯·æ±‚è¿™ä¸ªèµ„æºæ—¶ï¼Œ**åœ¨requestçš„headerä¸ŠåŠ ä¸ŠIf-Modified-Sinceçš„header**ï¼Œè¿™ä¸ªheaderçš„å€¼å°±æ˜¯ä¸Šä¸€æ¬¡è¯·æ±‚æ—¶è¿”å›çš„Last-Modifiedçš„å€¼ï¼š

   

   ![requestçš„headerä¸ŠåŠ ä¸ŠIf-Modified-Since](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74d05d4fbf77~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

3. æœåŠ¡å™¨å†æ¬¡æ”¶åˆ°èµ„æºè¯·æ±‚æ—¶ï¼Œ**æ ¹æ®æµè§ˆå™¨ä¼ è¿‡æ¥If-Modified-Sinceå’Œèµ„æºåœ¨æœåŠ¡å™¨ä¸Šçš„æœ€åä¿®æ”¹æ—¶é—´åˆ¤æ–­èµ„æºæ˜¯å¦æœ‰å˜åŒ–**ï¼Œå¦‚æœæ²¡æœ‰å˜åŒ–åˆ™è¿”å›304 Not Modifiedï¼Œä½†æ˜¯ä¸ä¼šè¿”å›èµ„æºå†…å®¹ï¼›å¦‚æœæœ‰å˜åŒ–ï¼Œå°±æ­£å¸¸è¿”å›èµ„æºå†…å®¹ã€‚**å½“æœåŠ¡å™¨è¿”å›304 Not Modifiedçš„å“åº”æ—¶ï¼Œresponse headerä¸­ä¸ä¼šå†æ·»åŠ Last-Modifiedçš„header**ï¼Œå› ä¸ºæ—¢ç„¶èµ„æºæ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆLast-Modifiedä¹Ÿå°±ä¸ä¼šæ”¹å˜ï¼Œè¿™æ˜¯æœåŠ¡å™¨è¿”å›304æ—¶çš„response headerï¼š

   

   ![æœåŠ¡å™¨å“åº”304 Not Modified](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74d05d37cc80~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

4. æµè§ˆå™¨æ”¶åˆ°304çš„å“åº”åï¼Œå°±ä¼šä»ç¼“å­˜ä¸­åŠ è½½èµ„æºã€‚

5. å¦‚æœåå•†ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œæµè§ˆå™¨ç›´æ¥ä»æœåŠ¡å™¨åŠ è½½èµ„æºæ—¶ï¼Œ**Last-Modified Headeråœ¨é‡æ–°åŠ è½½çš„æ—¶å€™ä¼šè¢«æ›´æ–°**ï¼Œä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œ**If-Modified-Sinceä¼šå¯ç”¨ä¸Šæ¬¡è¿”å›çš„Last-Modifiedå€¼**ã€‚

ã€Last-Modifiedï¼ŒIf-Modified-Sinceã€‘éƒ½æ˜¯æ ¹æ®æœåŠ¡å™¨æ—¶é—´è¿”å›çš„headerï¼Œä¸€èˆ¬æ¥è¯´ï¼Œ**åœ¨æ²¡æœ‰è°ƒæ•´æœåŠ¡å™¨æ—¶é—´å’Œç¯¡æ”¹å®¢æˆ·ç«¯ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ä¸ªheaderé…åˆèµ·æ¥ç®¡ç†åå•†ç¼“å­˜æ˜¯éå¸¸å¯é çš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¹Ÿä¼šæœåŠ¡å™¨ä¸Šèµ„æºå…¶å®æœ‰å˜åŒ–ï¼Œä½†æ˜¯æœ€åä¿®æ”¹æ—¶é—´å´æ²¡æœ‰å˜åŒ–çš„æƒ…å†µ**ï¼Œè€Œè¿™ç§é—®é¢˜åˆå¾ˆä¸å®¹æ˜“è¢«å®šä½å‡ºæ¥ï¼Œè€Œå½“è¿™ç§æƒ…å†µå‡ºç°çš„æ—¶å€™ï¼Œå°±ä¼šå½±å“åå•†ç¼“å­˜çš„å¯é æ€§ã€‚**æ‰€ä»¥å°±æœ‰äº†å¦å¤–ä¸€å¯¹headeræ¥ç®¡ç†åå•†ç¼“å­˜ï¼Œè¿™å¯¹headerå°±æ˜¯ã€ETagã€If-None-Matchã€‘**ã€‚å®ƒä»¬çš„ç¼“å­˜ç®¡ç†çš„æ–¹å¼æ˜¯ï¼š

1. æµè§ˆå™¨ç¬¬ä¸€æ¬¡è·ŸæœåŠ¡å™¨è¯·æ±‚ä¸€ä¸ªèµ„æºï¼Œ**æœåŠ¡å™¨åœ¨è¿”å›è¿™ä¸ªèµ„æºçš„åŒæ—¶ï¼Œåœ¨responseçš„headeråŠ ä¸ŠETagçš„header**ï¼Œè¿™ä¸ªheaderæ˜¯æœåŠ¡å™¨æ ¹æ®å½“å‰è¯·æ±‚çš„èµ„æºç”Ÿæˆçš„ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œ**è¿™ä¸ªå”¯ä¸€æ ‡è¯†æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåªè¦èµ„æºæœ‰å˜åŒ–è¿™ä¸ªä¸²å°±ä¸åŒ**ï¼Œè·Ÿæœ€åä¿®æ”¹æ—¶é—´æ²¡æœ‰å…³ç³»ï¼Œæ‰€ä»¥èƒ½å¾ˆå¥½çš„è¡¥å……Last-Modifiedçš„é—®é¢˜ï¼š

   

   ![åœ¨responseçš„headeråŠ ä¸ŠETag](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74d0e587fdf5~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

2. æµè§ˆå™¨å†æ¬¡è·ŸæœåŠ¡å™¨è¯·æ±‚è¿™ä¸ªèµ„æºæ—¶ï¼Œ**åœ¨requestçš„headerä¸ŠåŠ ä¸ŠIf-None-Matchçš„header**ï¼Œè¿™ä¸ªheaderçš„å€¼å°±æ˜¯ä¸Šä¸€æ¬¡è¯·æ±‚æ—¶è¿”å›çš„ETagçš„å€¼ï¼š

   

   ![åœ¨requestçš„headerä¸ŠåŠ ä¸ŠIf-None-Match](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74d05d5f4171~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

3. æœåŠ¡å™¨å†æ¬¡æ”¶åˆ°èµ„æºè¯·æ±‚æ—¶ï¼Œ**æ ¹æ®æµè§ˆå™¨ä¼ è¿‡æ¥If-None-Matchå’Œç„¶åå†æ ¹æ®èµ„æºç”Ÿæˆä¸€ä¸ªæ–°çš„ETag**ï¼Œå¦‚æœè¿™ä¸¤ä¸ªå€¼ç›¸åŒå°±è¯´æ˜èµ„æºæ²¡æœ‰å˜åŒ–ï¼Œå¦åˆ™å°±æ˜¯æœ‰å˜åŒ–ï¼›å¦‚æœæ²¡æœ‰å˜åŒ–åˆ™è¿”å›304 Not Modifiedï¼Œä½†æ˜¯ä¸ä¼šè¿”å›èµ„æºå†…å®¹ï¼›å¦‚æœæœ‰å˜åŒ–ï¼Œå°±æ­£å¸¸è¿”å›èµ„æºå†…å®¹ã€‚ä¸Last-Modifiedä¸ä¸€æ ·çš„æ˜¯ï¼Œå½“æœåŠ¡å™¨è¿”å›304 Not Modifiedçš„å“åº”æ—¶ï¼Œ**ç”±äºETagé‡æ–°ç”Ÿæˆè¿‡ï¼Œresponse headerä¸­è¿˜ä¼šæŠŠè¿™ä¸ªETagè¿”å›**ï¼Œå³ä½¿è¿™ä¸ªETagè·Ÿä¹‹å‰çš„æ²¡æœ‰å˜åŒ–ï¼š

   

   ![ç”±äºETagé‡æ–°ç”Ÿæˆè¿‡ï¼Œresponse headerä¸­è¿˜ä¼šæŠŠè¿™ä¸ªETagè¿”å›](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74d0e5592563~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)

   

4. æµè§ˆå™¨æ”¶åˆ°304çš„å“åº”åï¼Œå°±ä¼šä»ç¼“å­˜ä¸­åŠ è½½èµ„æºã€‚

Etagå’ŒLast-Modifiedéå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªå‚æ•°ï¼Œä»è€Œå†³å®šæ˜¯å¦å¯ç”¨ç¼“å­˜ã€‚**ä½†æ˜¯ETagç›¸å¯¹äºLast-Modifiedä¹Ÿæœ‰å…¶ä¼˜åŠ¿ï¼Œå¯ä»¥æ›´åŠ å‡†ç¡®çš„åˆ¤æ–­æ–‡ä»¶å†…å®¹æ˜¯å¦è¢«ä¿®æ”¹**ï¼Œä»è€Œåœ¨å®é™…æ“ä½œä¸­å®ç”¨ç¨‹åº¦ä¹Ÿæ›´é«˜ã€‚

åå•†ç¼“å­˜è·Ÿå¼ºç¼“å­˜ä¸ä¸€æ ·ï¼Œå¼ºç¼“å­˜ä¸å‘è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œ**æ‰€ä»¥æœ‰æ—¶å€™èµ„æºæ›´æ–°äº†æµè§ˆå™¨è¿˜ä¸çŸ¥é“ï¼Œä½†æ˜¯åå•†ç¼“å­˜ä¼šå‘è¯·æ±‚åˆ°æœåŠ¡å™¨**ï¼Œæ‰€ä»¥èµ„æºæ˜¯å¦æ›´æ–°ï¼ŒæœåŠ¡å™¨è‚¯å®šçŸ¥é“ã€‚å¤§éƒ¨åˆ†webæœåŠ¡å™¨éƒ½é»˜è®¤å¼€å¯åå•†ç¼“å­˜ï¼Œè€Œä¸”æ˜¯åŒæ—¶å¯ç”¨ã€Last-Modifiedï¼ŒIf-Modified-Sinceã€‘å’Œã€ETagã€If-None-Matchã€‘ï¼Œæ¯”å¦‚apache:



![åŒæ—¶å¼€å¯Etagå’ŒLast-Modified](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74d0e536d23e~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)



å¦‚æœæ²¡æœ‰åå•†ç¼“å­˜ï¼Œæ¯ä¸ªåˆ°æœåŠ¡å™¨çš„è¯·æ±‚ï¼Œå°±éƒ½å¾—è¿”å›èµ„æºå†…å®¹ï¼Œè¿™æ ·æœåŠ¡å™¨çš„æ€§èƒ½ä¼šæå·®ã€‚

ã€Last-Modifiedï¼ŒIf-Modified-Sinceã€‘å’Œã€ETagã€If-None-Matchã€‘ä¸€èˆ¬éƒ½æ˜¯åŒæ—¶å¯ç”¨ï¼Œè¿™æ˜¯ä¸ºäº†å¤„ç†Last-Modifiedä¸å¯é çš„æƒ…å†µã€‚æœ‰ä¸€ç§åœºæ™¯éœ€è¦æ³¨æ„ï¼š

> **åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œå¤šå°æœºå™¨é—´æ–‡ä»¶çš„Last-Modifiedå¿…é¡»ä¿æŒä¸€è‡´ï¼Œä»¥å…è´Ÿè½½å‡è¡¡åˆ°ä¸åŒæœºå™¨å¯¼è‡´æ¯”å¯¹å¤±è´¥**ï¼›
>
> **åˆ†å¸ƒå¼ç³»ç»Ÿå°½é‡å…³é—­æ‰ETag(æ¯å°æœºå™¨ç”Ÿæˆçš„ETagéƒ½ä¼šä¸ä¸€æ ·ï¼‰**ï¼›

æ¯”å¦‚ï¼Œäº¬ä¸œé¡µé¢çš„èµ„æºè¯·æ±‚ï¼Œè¿”å›çš„repsonse headerå°±åªæœ‰Last-Modifiedï¼Œæ²¡æœ‰ETagï¼š



![repsonse headeråªå¼€å¯Last-Modified](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74d0e57befb2~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)



åå•†ç¼“å­˜éœ€è¦é…åˆå¼ºç¼“å­˜ä½¿ç”¨ï¼Œä¸Šé¢è¿™ä¸ªæˆªå›¾ä¸­ï¼Œé™¤äº†Last-Modifiedè¿™ä¸ªheaderï¼Œè¿˜æœ‰å¼ºç¼“å­˜çš„ç›¸å…³headerï¼Œ**å› ä¸ºå¦‚æœä¸å¯ç”¨å¼ºç¼“å­˜çš„è¯ï¼Œåå•†ç¼“å­˜æ ¹æœ¬æ²¡æœ‰æ„ä¹‰**ã€‚

# 4 ç¼“å­˜åˆ¤æ–­æµç¨‹

å¦‚æœèµ„æºå·²ç»è¢«æµè§ˆå™¨ç¼“å­˜ä¸‹æ¥ï¼Œåœ¨ç¼“å­˜å¤±æ•ˆä¹‹å‰ï¼Œå†æ¬¡è¯·æ±‚æ—¶ï¼Œé»˜è®¤ä¼šå…ˆæ£€æŸ¥æ˜¯å¦å‘½ä¸­å¼ºç¼“å­˜ï¼Œå¦‚æœå¼ºç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¯»å–ç¼“å­˜ï¼Œå¦‚æœå¼ºç¼“å­˜æ²¡æœ‰å‘½ä¸­åˆ™å‘è¯·æ±‚åˆ°æœåŠ¡å™¨æ£€æŸ¥æ˜¯å¦å‘½ä¸­åå•†ç¼“å­˜ï¼Œå¦‚æœåå•†ç¼“å­˜å‘½ä¸­ï¼Œåˆ™å‘Šè¯‰æµè§ˆå™¨è¿˜æ˜¯å¯ä»¥ä»ç¼“å­˜è¯»å–ï¼Œå¦åˆ™æ‰ä»æœåŠ¡å™¨è¿”å›æœ€æ–°çš„èµ„æºã€‚å…¶æµè§ˆå™¨åˆ¤æ–­ç¼“å­˜çš„è¯¦ç»†æµç¨‹å›¾ï¼Œå¦‚ä¸‹ï¼š



![æµè§ˆå™¨ç¼“å­˜åˆ¤æ–­æµç¨‹](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/8/165b74d0e55dda0b~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp)



# 5 å…¶ä»–å‚è€ƒèµ„æ–™

1. [æµ…è°ˆWebç¼“å­˜](https://link.juejin.cn?target=http%3A%2F%2Fwww.alloyteam.com%2F2016%2F03%2Fdiscussion-on-web-caching)
2. [æµ…è°ˆæµè§ˆå™¨httpçš„ç¼“å­˜æœºåˆ¶](https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fvajoy%2Fp%2F5341664.html)



åœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œæ€§èƒ½ä¸€ç›´éƒ½æ˜¯è¢«å¤§å®¶æ‰€é‡è§†çš„ä¸€ç‚¹ï¼Œç„¶è€Œåˆ¤æ–­ä¸€ä¸ªç½‘ç«™çš„æ€§èƒ½æœ€ç›´è§‚çš„å°±æ˜¯çœ‹ç½‘é¡µæ‰“å¼€çš„é€Ÿåº¦ã€‚å…¶ä¸­æé«˜ç½‘é¡µååº”é€Ÿåº¦çš„ä¸€ä¸ªæ–¹å¼å°±æ˜¯ä½¿ç”¨ç¼“å­˜ã€‚ä¸€ä¸ªä¼˜ç§€çš„ç¼“å­˜ç­–ç•¥å¯ä»¥ç¼©çŸ­ç½‘é¡µè¯·æ±‚èµ„æºçš„è·ç¦»ï¼Œå‡å°‘å»¶è¿Ÿï¼Œå¹¶ä¸”ç”±äºç¼“å­˜æ–‡ä»¶å¯ä»¥é‡å¤åˆ©ç”¨ï¼Œè¿˜å¯ä»¥å‡å°‘å¸¦å®½ï¼Œé™ä½ç½‘ç»œè´Ÿè·ã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹æœåŠ¡å™¨ç«¯ç¼“å­˜çš„åŸç†ã€‚

 



# ç¼“å­˜åˆ†ç±» 

web ç¼“å­˜åˆ†ä¸ºå¾ˆå¤šç§ï¼Œæ¯”å¦‚æ•°æ®åº“ç¼“å­˜ã€ä»£ç†æœåŠ¡å™¨ç¼“å­˜ã€è¿˜æœ‰æˆ‘ä»¬ç†Ÿæ‚‰çš„ CDN ç¼“å­˜ï¼Œä»¥åŠæµè§ˆå™¨ç¼“å­˜ã€‚å¯¹äºå¤ªå¤šæ–‡å­—çš„é˜…è¯»å…¶å®æˆ‘æ˜¯æ‹’ç»çš„ï¼Œäºæ˜¯å°±ç”»äº†ä¸ªå›¾æ¥è§£é‡Šä¸‹ã€‚

æµè§ˆå™¨é€šè¿‡ä»£ç†æœåŠ¡å™¨å‘æºæœåŠ¡å™¨å‘èµ·è¯·æ±‚çš„åŸç†å¦‚ä¸‹å›¾ï¼Œ

[![å›¾ç‰‡1](http://www.alloyteam.com/wp-content/uploads/2016/03/%E5%9B%BE%E7%89%8715.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/å›¾ç‰‡15.png)

æµè§ˆå™¨å…ˆå‘ä»£ç†æœåŠ¡å™¨å‘èµ· Web è¯·æ±‚ï¼Œå†å°†è¯·æ±‚è½¬å‘åˆ°æºæœåŠ¡å™¨ã€‚å®ƒå±äºå…±äº«ç¼“å­˜ï¼Œæ‰€ä»¥å¾ˆå¤šåœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨å…¶ç¼“å­˜èµ„æºï¼Œå› æ­¤å¯¹äºèŠ‚çœæµé‡æœ‰å¾ˆå¤§ä½œç”¨ã€‚

æµè§ˆå™¨ç¼“å­˜æ˜¯å°†æ–‡ä»¶ä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œåœ¨åŒä¸€ä¸ªä¼šè¯è¿‡ç¨‹ä¸­ä¼šæ£€æŸ¥ç¼“å­˜çš„å‰¯æœ¬æ˜¯å¦è¶³å¤Ÿæ–°ï¼Œåœ¨åé€€ç½‘é¡µæ—¶ï¼Œè®¿é—®è¿‡çš„èµ„æºå¯ä»¥ä»æµè§ˆå™¨ç¼“å­˜ä¸­æ‹¿å‡ºä½¿ç”¨ã€‚é€šè¿‡å‡å°‘æœåŠ¡å™¨å¤„ç†è¯·æ±‚çš„æ•°é‡ï¼Œç”¨æˆ·å°†è·å¾—æ›´å¿«çš„ä½“éªŒ

ä¸‹é¢æˆ‘å°±æ¥ç€é‡è®²ä¸‹ä¼ è¯´ä¸­çš„æµè§ˆå™¨ç¼“å­˜ã€‚

 

# æµè§ˆå™¨ç¼“å­˜ 

é¡µé¢çš„ç¼“å­˜çŠ¶æ€æ˜¯ç”± header å†³å®šçš„ï¼Œheader çš„å‚æ•°æœ‰å››ç§ï¼š

ä¸€ã€**Cache-Control**ï¼š

  1ã€**max-age**ï¼ˆå•ä½ä¸º sï¼‰æŒ‡å®šè®¾ç½®ç¼“å­˜æœ€å¤§çš„æœ‰æ•ˆæ—¶é—´ï¼Œå®šä¹‰çš„æ˜¯æ—¶é—´é•¿çŸ­ã€‚å½“æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€è¯·æ±‚åï¼Œåœ¨ max-age è¿™æ®µæ—¶é—´é‡Œæµè§ˆå™¨å°±ä¸ä¼šå†å‘æœåŠ¡å™¨å‘é€è¯·æ±‚äº†ã€‚

æˆ‘ä»¬æ¥æ‰¾ä¸ªèµ„æºçœ‹ä¸‹ã€‚æ¯”å¦‚ shang.qq.com ä¸Šçš„ css èµ„æºï¼Œmax-age=2592000ï¼Œä¹Ÿå°±æ˜¯è¯´ç¼“å­˜æœ‰æ•ˆæœŸä¸º 2592000 ç§’ï¼ˆä¹Ÿå°±æ˜¯ 30 å¤©ï¼‰ã€‚äºæ˜¯åœ¨ 30 å¤©å†…éƒ½ä¼šä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬çš„èµ„æºï¼Œå³ä½¿æœåŠ¡å™¨ä¸Šçš„èµ„æºå‘ç”Ÿäº†å˜åŒ–ï¼Œæµè§ˆå™¨ä¹Ÿä¸ä¼šå¾—åˆ°é€šçŸ¥ã€‚max-age ä¼šè¦†ç›–æ‰ Expiresï¼Œåé¢ä¼šæœ‰è®¨è®ºã€‚

[![å›¾ç‰‡2](http://www.alloyteam.com/wp-content/uploads/2016/03/%E5%9B%BE%E7%89%8722.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/å›¾ç‰‡22.png)

 

  2ã€**s-maxage**ï¼ˆå•ä½ä¸º sï¼‰åŒ max-ageï¼Œåªç”¨äºå…±äº«ç¼“å­˜ï¼ˆæ¯”å¦‚ CDN ç¼“å­˜ï¼‰ã€‚

æ¯”å¦‚ï¼Œå½“ s-maxage=60 æ—¶ï¼Œåœ¨è¿™ 60 ç§’ä¸­ï¼Œå³ä½¿æ›´æ–°äº† CDN çš„å†…å®¹ï¼Œæµè§ˆå™¨ä¹Ÿä¸ä¼šè¿›è¡Œè¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ max-age ç”¨äºæ™®é€šç¼“å­˜ï¼Œè€Œ s-maxage ç”¨äºä»£ç†ç¼“å­˜ã€‚å¦‚æœå­˜åœ¨ s-maxageï¼Œåˆ™ä¼šè¦†ç›–æ‰ max-age å’Œ Expires headerã€‚

  3ã€**public** æŒ‡å®šå“åº”ä¼šè¢«ç¼“å­˜ï¼Œå¹¶ä¸”åœ¨å¤šç”¨æˆ·é—´å…±äº«ã€‚ä¹Ÿå°±æ˜¯ä¸‹å›¾çš„æ„æ€ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®š public è¿˜æ˜¯ privateï¼Œåˆ™é»˜è®¤ä¸º publicã€‚

[![9](http://www.alloyteam.com/wp-content/uploads/2016/03/9.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/9.png)

  4ã€**private** å“åº”åªä½œä¸ºç§æœ‰çš„ç¼“å­˜ï¼ˆè§ä¸‹å›¾ï¼‰ï¼Œä¸èƒ½åœ¨ç”¨æˆ·é—´å…±äº«ã€‚å¦‚æœè¦æ±‚ HTTP è®¤è¯ï¼Œå“åº”ä¼šè‡ªåŠ¨è®¾ç½®ä¸º privateã€‚

[![10](http://www.alloyteam.com/wp-content/uploads/2016/03/10.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/10.png)

  5ã€**no-cache** æŒ‡å®šä¸ç¼“å­˜å“åº”ï¼Œè¡¨æ˜èµ„æºä¸è¿›è¡Œç¼“å­˜ï¼Œæ¯”å¦‚ï¼Œ

[![å›¾ç‰‡3](http://www.alloyteam.com/wp-content/uploads/2016/03/%E5%9B%BE%E7%89%8733.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/å›¾ç‰‡33.png)

ä½†æ˜¯è®¾ç½®äº† no-cache ä¹‹åå¹¶ä¸ä»£è¡¨æµè§ˆå™¨ä¸ç¼“å­˜ï¼Œè€Œæ˜¯åœ¨ç¼“å­˜å‰è¦å‘æœåŠ¡å™¨ç¡®è®¤èµ„æºæ˜¯å¦è¢«æ›´æ”¹ã€‚å› æ­¤æœ‰çš„æ—¶å€™åªè®¾ç½® no-cache é˜²æ­¢ç¼“å­˜è¿˜æ˜¯ä¸å¤Ÿä¿é™©ï¼Œè¿˜å¯ä»¥åŠ ä¸Š private æŒ‡ä»¤ï¼Œå°†è¿‡æœŸæ—¶é—´è®¾ä¸ºè¿‡å»çš„æ—¶é—´ã€‚

  6ã€**no-store** ç»å¯¹ç¦æ­¢ç¼“å­˜ï¼Œä¸€çœ‹å°±çŸ¥é“å¦‚æœç”¨äº†è¿™ä¸ªå‘½ä»¤å½“ç„¶å°±æ˜¯ä¸ä¼šè¿›è¡Œç¼“å­˜å•¦ï½æ¯æ¬¡è¯·æ±‚èµ„æºéƒ½è¦ä»æœåŠ¡å™¨é‡æ–°è·å–ã€‚

  7ã€**must-revalidate** æŒ‡å®šå¦‚æœé¡µé¢æ˜¯è¿‡æœŸçš„ï¼Œåˆ™å»æœåŠ¡å™¨è¿›è¡Œè·å–ã€‚è¿™ä¸ªæŒ‡ä»¤å¹¶ä¸å¸¸ç”¨ï¼Œå°±ä¸åšè¿‡å¤šçš„è®¨è®ºäº†ã€‚

äºŒã€**Expires**

â€‹    ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œç”¨æ¥æŒ‡å®šèµ„æºåˆ°æœŸçš„æ—¶é—´ï¼Œæ˜¯æœåŠ¡å™¨ç«¯çš„å…·ä½“çš„æ—¶é—´ç‚¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒExpires=max-age + è¯·æ±‚æ—¶é—´ï¼Œéœ€è¦å’Œ Last-modified ç»“åˆä½¿ç”¨ã€‚ä½†åœ¨ä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œcache-control çš„ä¼˜å…ˆçº§æ›´é«˜ã€‚ Expires æ˜¯ Web æœåŠ¡å™¨å“åº”æ¶ˆæ¯å¤´å­—æ®µï¼Œåœ¨å“åº” http è¯·æ±‚æ—¶å‘Šè¯‰æµè§ˆå™¨åœ¨è¿‡æœŸæ—¶é—´å‰æµè§ˆå™¨å¯ä»¥ç›´æ¥ä»æµè§ˆå™¨ç¼“å­˜å–æ•°æ®ï¼Œè€Œæ— éœ€å†æ¬¡è¯·æ±‚ã€‚

[![11](http://www.alloyteam.com/wp-content/uploads/2016/03/11.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/11.png)

ä¸‰ã€**Last-modified** 

â€‹    æœåŠ¡å™¨ç«¯æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ï¼Œéœ€è¦å’Œ cache-control å…±åŒä½¿ç”¨ï¼Œæ˜¯æ£€æŸ¥æœåŠ¡å™¨ç«¯èµ„æºæ˜¯å¦æ›´æ–°çš„ä¸€ç§æ–¹å¼ã€‚å½“æµè§ˆå™¨å†æ¬¡è¿›è¡Œè¯·æ±‚æ—¶ï¼Œä¼šå‘æœåŠ¡å™¨ä¼ é€ If-Modified-Since æŠ¥å¤´ï¼Œè¯¢é—® Last-Modified æ—¶é—´ç‚¹ä¹‹åèµ„æºæ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚å¦‚æœæ²¡æœ‰ä¿®æ”¹ï¼Œåˆ™è¿”å›ç ä¸º 304ï¼Œä½¿ç”¨ç¼“å­˜ï¼›å¦‚æœä¿®æ”¹è¿‡ï¼Œåˆ™å†æ¬¡å»æœåŠ¡å™¨è¯·æ±‚èµ„æºï¼Œè¿”å›ç å’Œé¦–æ¬¡è¯·æ±‚ç›¸åŒä¸º 200ï¼Œèµ„æºä¸ºæœåŠ¡å™¨æœ€æ–°èµ„æºã€‚

å¦‚ä¸‹å›¾ï¼Œæœ€åä¿®æ”¹æ—¶é—´ä¸º 2014 å¹´ 12 æœˆ 19 æ—¥æ˜ŸæœŸäº” 2 ç‚¹ 50 åˆ† 47 ç§’

[![å›¾ç‰‡4](http://www.alloyteam.com/wp-content/uploads/2016/03/%E5%9B%BE%E7%89%8741.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/å›¾ç‰‡41.png)

å››ã€**ETag**

â€‹     æ ¹æ®å®ä½“å†…å®¹ç”Ÿæˆä¸€æ®µ hash å­—ç¬¦ä¸²ï¼Œæ ‡è¯†èµ„æºçš„çŠ¶æ€ï¼Œç”±æœåŠ¡ç«¯äº§ç”Ÿã€‚æµè§ˆå™¨ä¼šå°†è¿™ä¸²å­—ç¬¦ä¸²ä¼ å›æœåŠ¡å™¨ï¼ŒéªŒè¯èµ„æºæ˜¯å¦å·²ç»ä¿®æ”¹ï¼Œå¦‚æœæ²¡æœ‰ä¿®æ”¹ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

[![12](http://www.alloyteam.com/wp-content/uploads/2016/03/12.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/12.png)

ä½¿ç”¨ ETag å¯ä»¥è§£å†³ Last-modified å­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼š

  aã€æŸäº›æœåŠ¡å™¨ä¸èƒ½ç²¾ç¡®å¾—åˆ°èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´ï¼Œè¿™æ ·å°±æ— æ³•é€šè¿‡æœ€åä¿®æ”¹æ—¶é—´åˆ¤æ–­èµ„æºæ˜¯å¦æ›´æ–° 

  bã€å¦‚æœèµ„æºä¿®æ”¹éå¸¸é¢‘ç¹ï¼Œåœ¨ç§’ä»¥ä¸‹çš„æ—¶é—´å†…è¿›è¡Œä¿®æ”¹ï¼Œè€Œ Last-modified åªèƒ½ç²¾ç¡®åˆ°ç§’ 

  cã€ä¸€äº›èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´æ”¹å˜äº†ï¼Œä½†æ˜¯å†…å®¹æ²¡æ”¹å˜ï¼Œä½¿ç”¨ ETag å°±è®¤ä¸ºèµ„æºè¿˜æ˜¯æ²¡æœ‰ä¿®æ”¹çš„ã€‚

 

# ä½¿ç”¨ç¼“å­˜æµç¨‹ 

è¿˜æ˜¯ç”¨å›¾è¯´è¯ï¼Œä¸‹é¢æ˜¯æˆ‘æ‰€æ€»ç»“çš„ä»æµè§ˆå™¨è¯·æ±‚åˆ°å±•ç¤ºèµ„æºçš„è¿‡ç¨‹ï¼š

[![å›¾ç‰‡6](http://www.alloyteam.com/wp-content/uploads/2016/03/%E5%9B%BE%E7%89%8761.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/å›¾ç‰‡61.png)

 

 



# cache-control æŒ‡ä»¤ä½¿ç”¨ 

è¯´äº†é‚£ä¹ˆå¤š cache-control çš„æŒ‡ä»¤ï¼Œé‚£ä¹ˆå¦‚ä½•é€‰æ‹©ä½¿ç”¨å“ªäº›æŒ‡ä»¤å‘¢ï¼Ÿæˆ‘è¿˜æ˜¯ä¸è¯´è¯==

[![å›¾ç‰‡5](http://www.alloyteam.com/wp-content/uploads/2016/03/%E5%9B%BE%E7%89%8751.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/å›¾ç‰‡51.png)

 

**é¢å¤–çš„**

é™¤äº†å¼€å¤´æåˆ°çš„é‚£ä¹ˆå¤šç¼“å­˜æ–¹å¼ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ç§æˆ‘ä»¬éƒ½ç†Ÿæ‚‰çš„ç¼“å­˜æ–¹å¼ï¼ŒLocalStorage å’Œ sessionStorageï¼ˆå¥½åƒæ˜¯ä¸¤ç§ 23333ï¼‰ã€‚

LocalStorage æ˜¯ä¸€ç§æœ¬åœ°å­˜å‚¨çš„å…¬å…±èµ„æºï¼ŒåŸŸåä¸‹å¾ˆå¤šåº”ç”¨å…±äº«è¿™ä»½èµ„æºä¼šæœ‰é£é™©ï¼›LocalStorage æ˜¯ä»¥é¡µé¢åŸŸååˆ’åˆ†çš„ï¼Œå¦‚æœæœ‰å¤šä¸ªç­‰ä»·åŸŸåä¹‹é—´çš„ LocalStorage ä¸äº’é€šï¼Œåˆ™ä¼šé€ æˆç¼“å­˜å¤šä»½æµªè´¹ã€‚

LocalStorage åœ¨ PC ä¸Šçš„å…¼å®¹æ€§ä¸å¤ªå¥½ï¼Œè€Œä¸”å½“ç½‘ç»œé€Ÿåº¦å¿«ã€åå•†ç¼“å­˜å“åº”å¿«æ—¶ä½¿ç”¨ localStorage çš„é€Ÿåº¦æ¯”ä¸ä¸Š 304ã€‚å¹¶ä¸”ä¸èƒ½ç¼“å­˜ css æ–‡ä»¶ã€‚è€Œç§»åŠ¨ç«¯ç”±äºç½‘é€Ÿæ…¢ï¼Œä½¿ç”¨ localStorage è¦å¿«äº 304ã€‚

 

åœ¨ html ä¸­åŠ è½½ä¸€ä¸ª png å›¾ï¼Œé¦–æ¬¡åŠ è½½çš„æ—¶å€™æ—¶é—´å¦‚ä¸‹å›¾ï¼Œ

[![å›¾ç‰‡7](http://www.alloyteam.com/wp-content/uploads/2016/03/%E5%9B%BE%E7%89%8771.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/å›¾ç‰‡71.png)

ç„¶è€Œå°†å›¾ç‰‡ä½¿ç”¨äº† LocalStorage å­˜å‚¨åï¼Œå†æ¬¡åˆ·æ–°ååŠ è½½æ—¶é—´ä¸º 0ã€‚

[![å›¾ç‰‡8](http://www.alloyteam.com/wp-content/uploads/2016/03/%E5%9B%BE%E7%89%8781.png)](http://www.alloyteam.com/wp-content/uploads/2016/03/å›¾ç‰‡81.png)

è€Œç›¸å¯¹ LocalStorage æ¥è¯´ï¼ŒSessionStorage çš„æ•°æ®åªå­˜å‚¨åˆ°ç‰¹å®šçš„ä¼šè¯ä¸­ï¼Œä¸å±äºæŒä¹…åŒ–çš„å­˜å‚¨ï¼Œæ‰€ä»¥å…³é—­æµè§ˆå™¨ä¼šæ¸…é™¤æ•°æ®ã€‚å’Œ localstorage å…·æœ‰ç›¸åŒçš„æ–¹æ³•ã€‚

 

åœ¨å‰ç«¯å¼€å‘ä¸­ç¼“å­˜æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œé‚£ä¹ˆä½¿ç”¨æ€æ ·çš„ç¼“å­˜æ–¹å¼æ›´é«˜æ•ˆã€è®©æˆ‘ä»¬é¡¹ç›®çš„æ€§èƒ½æ›´ä¼˜ï¼Œè¿˜æ˜¯éœ€è¦æˆ‘ä»¬ä»”ç»†æ–Ÿé…Œã€‚

é’ˆå¯¹æµè§ˆå™¨çš„httpç¼“å­˜çš„åˆ†æä¹Ÿç®—æ˜¯è€ç”Ÿå¸¸è°ˆäº†ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±ä¼šå†’å‡ºä¸€ç¯‡ä¸é”™çš„æ–‡ç« ï¼Œå…¶åŸç†ä¹Ÿæ˜¯å„å¤§å…¬å¸é¢è¯•æ—¶å‡ ä¹å¿…è€ƒçš„é—®é¢˜ã€‚

ä¹‹æ‰€ä»¥è¿˜å†™ä¸€ç¯‡è¿™æ ·çš„æ–‡ç« ï¼Œæ˜¯å› ä¸ºè¿‘æœŸéƒ½åœ¨ææ–°æŠ€æœ¯ï¼Œæƒ³â€œå›å½’â€ä¸‹åŸºç¡€ï¼Œä¹Ÿå¸Œæœ›å°½é‡æ€»ç»“çš„æ›´è¯¦å°½äº›ã€‚

é‚£ä¹ˆä½ æ˜¯å¦è¿˜éœ€è¦é˜…è¯»æœ¬ç¯‡æ–‡ç« å‘¢ï¼Ÿå¯ä»¥è¯•ç€å›ç­”ä¸‹é¢è¿™ä¸ªé—®é¢˜ï¼š

æˆ‘ä»¬åœ¨è®¿é—®ç™¾åº¦é¦–é¡µçš„æ—¶å€™ï¼Œä¼šå‘ç°ä¸ç®¡æ€ä¹ˆåˆ·æ–°é¡µé¢ï¼Œé™æ€èµ„æºåŸºæœ¬éƒ½æ˜¯è¿”å› 200*ï¼ˆfrom cacheï¼‰*ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201603/561179-20160331162129410-1428753698.gif)

éšä¾¿ç‚¹å¼€ä¸€ä¸ªé™æ€èµ„æºæ˜¯é…±çš„ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201603/561179-20160331162506613-1409729874.png)

å“å“Ÿæœ‰ResponseæŠ¥å¤´æ•°æ®å‘¢ï¼Œçœ‹æ¥æœåŠ¡å™¨ä¹Ÿæ­£å¸¸è¿”å›äº†etagä»€ä¹ˆé¬¼çš„åº”æœ‰å°½æœ‰ï¼Œé‚£çŠ¶æ€200ä¸æ˜¯åº”è¯¥å¯¹åº”çš„éç¼“å­˜çŠ¶æ€ä¹ˆï¼Ÿè¦from cacheçš„è¯ä¸æ˜¯åº”è¯¥è¿”å›304æ‰åˆç†ä¹ˆï¼Ÿ

éš¾é“æ˜¯åº¦å¨˜çš„æœåŠ¡å™¨æ•…éšœäº†å—ï¼Ÿ

å¦‚æœä½ çŸ¥é“ç­”æ¡ˆï¼Œé‚£å°±å¯ä»¥å¿½ç•¥æœ¬æ–‡äº†ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**httpæŠ¥æ–‡ä¸­ä¸ç¼“å­˜ç›¸å…³çš„é¦–éƒ¨å­—æ®µ**

æˆ‘ä»¬å…ˆæ¥ç…ä¸€çœ¼[RFC2616](https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html)è§„å®šçš„47ç§httpæŠ¥æ–‡é¦–éƒ¨å­—æ®µä¸­ä¸ç¼“å­˜ç›¸å…³çš„å­—æ®µï¼Œäº‹å…ˆäº†è§£ä¸€ä¸‹èƒ½è®©å’±åœ¨å¿ƒé‡Œæœ‰ä¸ªåº•ï¼š

**1. é€šç”¨é¦–éƒ¨å­—æ®µ**ï¼ˆå°±æ˜¯è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡éƒ½èƒ½ç”¨ä¸Šçš„å­—æ®µï¼‰

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160401161150504-1030837643.png)

**2. è¯·æ±‚é¦–éƒ¨å­—æ®µ**

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160401161240301-2050921595.png)

**3. å“åº”é¦–éƒ¨å­—æ®µ**

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160401161311394-1246877214.png)

**4. å®ä½“é¦–éƒ¨å­—æ®µ**

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160401171410441-767100632.png)

åç»­å¤§ä½“ä¹Ÿä¼šä¾æ¬¡ä»‹ç»å®ƒä»¬ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**åœºæ™¯æ¨¡æ‹Ÿ**

ä¸ºæ–¹ä¾¿æ¨¡æ‹Ÿå„ç§ç¼“å­˜æ•ˆæœï¼Œæˆ‘ä»¬å»ºä¸ªéå¸¸ç®€å•çš„åœºæ™¯ã€‚

**1. é¡µé¢æ–‡ä»¶**

æˆ‘ä»¬å»ºä¸ªéå¸¸ç®€å•çš„htmlé¡µé¢ï¼Œä¸Šé¢åªæœ‰ä¸€ä¸ªæœ¬åœ°æ ·å¼æ–‡ä»¶å’Œå›¾ç‰‡ï¼š

[![å¤åˆ¶ä»£ç ](http://images.cnblogs.com/cnblogs_com/vajoy/558869/o_copybutton.png)](javascript:void(0);)

```
<!DOCTYPE html>
<html>
<head>
<title>ç¼“å­˜æµ‹è¯•</title>
<link rel="stylesheet" href="css/reset.css">
</head>
<body>
<h1>å“¥åªæ˜¯ä¸€ä¸ªæ ‡é¢˜</h1>
<p><img src="img/dog.jpg" /></p>
</body>
</html>
```

[![å¤åˆ¶ä»£ç ](http://images.cnblogs.com/cnblogs_com/vajoy/558869/o_copybutton.png)](javascript:void(0);)

**2. é¦–éƒ¨å­—æ®µä¿®æ”¹**

æœ‰æ—¶å€™ä¸€äº›æµè§ˆå™¨ä¼šè‡ªè¡Œç»™è¯·æ±‚é¦–éƒ¨åŠ ä¸Šä¸€äº›å­—æ®µ*ï¼ˆå¦‚chromeä½¿ç”¨F5ä¼šå¼ºåˆ¶åŠ ä¸Šâ€œ\*cache-control:max-age=0\*â€ï¼‰*,ä¼šè¦†ç›–æ‰ä¸€äº›å­—æ®µ*ï¼ˆæ¯”å¦‚pragmaï¼‰*çš„åŠŸèƒ½ï¼›å¦å¤–æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›æœåŠ¡å™¨èƒ½å¤š/å°‘è¿”å›ä¸€äº›å“åº”å­—æ®µã€‚

è¿™ç§æƒ…å†µæˆ‘ä»¬å°±å¸Œæœ›å¯ä»¥æ‰‹åŠ¨æ¥ä¿®æ”¹è¯·æ±‚æˆ–å“åº”æŠ¥æ–‡ä¸Šçš„å†…å®¹äº†ã€‚é‚£ä¹ˆå¦‚ä½•å®ç°å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨[Fiddler](http://www.telerik.com/fiddler)æ¥å®Œæˆä»»åŠ¡ã€‚

åœ¨Fiddlerä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡â€œbpu XXXâ€æŒ‡ä»¤æ¥æ‹¦æˆªæŒ‡å®šè¯·æ±‚ï¼Œç„¶åæ‰‹åŠ¨ä¿®æ”¹è¯·æ±‚å†…å®¹å†å‘ç»™æœåŠ¡å™¨ã€ä¿®æ”¹å“åº”å†…å®¹å†å‘ç»™å®¢æˆ·ç«¯ã€‚

ä»¥æˆ‘ä»¬çš„exampleä¸ºä¾‹ï¼Œé¡µé¢æ–‡ä»¶èµ°nginxé€šè¿‡ http://localhost/ å¯ç›´æ¥è®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ‰§è¡Œâ€œbpu localhostâ€æ‹¦æˆªæ‰€æœ‰åœ°å€ä¸­å¸¦æœ‰è¯¥å­—æ ·çš„è¯·æ±‚ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160402211104644-1077762209.gif)

ç‚¹å‡»è¢«æ‹¦æˆªçš„è¯·æ±‚ï¼Œå¯ä»¥åœ¨å³æ ç›´æ¥ä¿®æ”¹æŠ¥æ–‡å†…å®¹ï¼ˆä¸ŠåŠåŒºåŸŸæ˜¯è¯·æ±‚æŠ¥æ–‡ï¼Œä¸‹åŠåŒºåŸŸæ˜¯å“åº”æŠ¥æ–‡ï¼‰ï¼Œç‚¹å‡»é»„è‰²çš„â€œBreak on Responseâ€æŒ‰é’®å¯ä»¥æ‰§è¡Œä¸‹ä¸€æ­¥ï¼ˆæŠŠè¯·æ±‚å‘ç»™æœåŠ¡å™¨ï¼‰ï¼Œç‚¹å‡»ç»¿è‰²çš„æŒ‰é’®â€œRun to Completionâ€å¯ä»¥ç›´æ¥å®Œæˆæ•´ä¸ªè¯·æ±‚è¿‡ç¨‹ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160402211444629-1768756452.gif)

é€šè¿‡è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾åœ°æ¨¡æ‹Ÿå‡ºå„ç§httpç¼“å­˜åœºæ™¯ã€‚

**3. æµè§ˆå™¨çš„å¼ºåˆ¶ç­–ç•¥**

å¦‚ä¸Šè¿°ï¼Œå½“ä¸‹å¤§å¤šæ•°æµè§ˆå™¨åœ¨ç‚¹å‡»åˆ·æ–°æŒ‰é’®æˆ–æŒ‰F5æ—¶ä¼šè‡ªè¡ŒåŠ ä¸Šâ€œCache-Control:max-age=0â€è¯·æ±‚å­—æ®µï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçº¦å®šæˆä¿—â€”â€”åæ–‡æåŠçš„â€œåˆ·æ–°â€å¤šæŒ‡çš„æ˜¯é€‰ä¸­urlåœ°å€æ å¹¶æŒ‰å›è½¦é”®*ï¼ˆè¿™æ ·ä¸ä¼šè¢«å¼ºè¡ŒåŠ ä¸ŠCache-Controlï¼‰*ã€‚

äº‹å®ä¸Šæœ‰çš„æµè§ˆå™¨è¿˜æœ‰ä¸€äº›æ›´å¥‡æ€ªçš„è¡Œä¸ºï¼Œåœ¨åç»­æˆ‘ä»¬å›ç­”æ–‡ç« å¼€å¤´é—®é¢˜çš„æ—¶å€™ä¼šæåˆ°ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**çŸ³å™¨æ—¶ä»£çš„ç¼“å­˜æ–¹å¼**

åœ¨ http1.0 æ—¶ä»£ï¼Œç»™å®¢æˆ·ç«¯è®¾å®šç¼“å­˜æ–¹å¼å¯é€šè¿‡ä¸¤ä¸ªå­—æ®µâ€”â€”â€œPragmaâ€å’Œâ€œExpiresâ€æ¥è§„èŒƒã€‚è™½ç„¶è¿™ä¸¤ä¸ªå­—æ®µæ—©å¯æŠ›å¼ƒï¼Œä½†ä¸ºäº†åšhttpåè®®çš„å‘ä¸‹å…¼å®¹ï¼Œä½ è¿˜æ˜¯å¯ä»¥çœ‹åˆ°å¾ˆå¤šç½‘ç«™ä¾æ—§ä¼šå¸¦ä¸Šè¿™ä¸¤ä¸ªå­—æ®µã€‚

**1. Pragma**

å½“è¯¥å­—æ®µå€¼ä¸ºâ€œno-cacheâ€çš„æ—¶å€™*ï¼ˆäº‹å®ä¸Šç°åœ¨RFCä¸­ä¹Ÿä»…æ ‡æ˜è¯¥å¯é€‰å€¼ï¼‰*ï¼Œä¼šçŸ¥ä¼šå®¢æˆ·ç«¯ä¸è¦å¯¹è¯¥èµ„æºè¯»ç¼“å­˜ï¼Œå³æ¯æ¬¡éƒ½å¾—å‘æœåŠ¡å™¨å‘ä¸€æ¬¡è¯·æ±‚æ‰è¡Œã€‚

Pragmaå±äºé€šç”¨é¦–éƒ¨å­—æ®µï¼Œåœ¨å®¢æˆ·ç«¯ä¸Šä½¿ç”¨æ—¶ï¼Œå¸¸è§„è¦æ±‚æˆ‘ä»¬å¾€htmlä¸ŠåŠ ä¸Šè¿™æ®µmetaå…ƒæ ‡ç­¾ï¼ˆè€Œä¸”å¯èƒ½è¿˜å¾—[åšäº›hackæ”¾åˆ°bodyåé¢å»](https://support.microsoft.com/zh-cn/kb/222064)ï¼‰ï¼š

```
<meta http-equiv="Pragma" content="no-cache">
```

å®ƒå‘Šè¯‰æµè§ˆå™¨æ¯æ¬¡è¯·æ±‚é¡µé¢æ—¶éƒ½ä¸è¦è¯»ç¼“å­˜ï¼Œéƒ½å¾—å¾€æœåŠ¡å™¨å‘ä¸€æ¬¡è¯·æ±‚æ‰è¡Œã€‚

BUT!!! äº‹å®ä¸Šè¿™ç§ç¦ç”¨ç¼“å­˜çš„å½¢å¼ç”¨å¤„å¾ˆæœ‰é™ï¼š

\1. ä»…æœ‰IEæ‰èƒ½è¯†åˆ«è¿™æ®µmetaæ ‡ç­¾å«ä¹‰ï¼Œå…¶å®ƒä¸»æµæµè§ˆå™¨ä»…èƒ½è¯†åˆ«â€œCache-Control: no-storeâ€çš„metaæ ‡ç­¾*ï¼ˆè§[å‡ºå¤„](http://securityevaluators.com/knowledge/case_studies/caching/)ï¼‰*ã€‚
\2. åœ¨IEä¸­è¯†åˆ«åˆ°è¯¥metaæ ‡ç­¾å«ä¹‰ï¼Œå¹¶ä¸ä¸€å®šä¼šåœ¨è¯·æ±‚å­—æ®µåŠ ä¸ŠPragmaï¼Œä½†çš„ç¡®ä¼šè®©å½“å‰é¡µé¢æ¯æ¬¡éƒ½å‘æ–°è¯·æ±‚*ï¼ˆä»…é™é¡µé¢ï¼Œé¡µé¢ä¸Šçš„èµ„æºåˆ™ä¸å—å½±å“ï¼‰*ã€‚

åšäº†æµ‹è¯•åå‘ç°ä¹Ÿçš„ç¡®å¦‚æ­¤ï¼Œè¿™ç§å®¢æˆ·ç«¯å®šä¹‰Pragmaçš„å½¢å¼åŸºæœ¬æ²¡èµ·åˆ°å¤šå°‘ä½œç”¨ã€‚

ä¸è¿‡å¦‚æœæ˜¯åœ¨å“åº”æŠ¥æ–‡ä¸ŠåŠ ä¸Šè¯¥å­—æ®µå°±ä¸ä¸€æ ·äº†ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160402224024176-1110075362.png)

å¦‚ä¸Šå›¾çº¢æ¡†éƒ¨åˆ†æ˜¯å†æ¬¡åˆ·æ–°é¡µé¢æ—¶ç”Ÿæˆçš„è¯·æ±‚ï¼Œè¿™è¯´æ˜ç¦ç”¨ç¼“å­˜ç”Ÿæ•ˆï¼Œé¢„è®¡æµè§ˆå™¨åœ¨æ”¶åˆ°æœåŠ¡å™¨çš„Pragmaå­—æ®µåä¼šå¯¹èµ„æºè¿›è¡Œæ ‡è®°ï¼Œç¦ç”¨å…¶ç¼“å­˜è¡Œä¸ºï¼Œè¿›è€Œåç»­æ¯æ¬¡åˆ·æ–°é¡µé¢å‡èƒ½é‡æ–°å‘å‡ºè¯·æ±‚è€Œä¸èµ°ç¼“å­˜ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**2. Expires**

æœ‰äº†Pragmaæ¥ç¦ç”¨ç¼“å­˜ï¼Œè‡ªç„¶ä¹Ÿéœ€è¦æœ‰ä¸ªä¸œè¥¿æ¥å¯ç”¨ç¼“å­˜å’Œå®šä¹‰ç¼“å­˜æ—¶é—´ï¼Œå¯¹http1.0è€Œè¨€ï¼ŒExpireså°±æ˜¯åšè¿™ä»¶äº‹çš„é¦–éƒ¨å­—æ®µã€‚

Expiresçš„å€¼å¯¹åº”ä¸€ä¸ªGMT*ï¼ˆæ ¼æ—å°¼æ²»æ—¶é—´ï¼‰*ï¼Œæ¯”å¦‚â€œMon, 22 Jul 2002 11:12:01 GMTâ€æ¥å‘Šè¯‰æµè§ˆå™¨èµ„æºç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœè¿˜æ²¡è¿‡è¯¥æ—¶é—´ç‚¹åˆ™ä¸å‘è¯·æ±‚ã€‚

åœ¨å®¢æˆ·ç«¯æˆ‘ä»¬åŒæ ·å¯ä»¥ä½¿ç”¨metaæ ‡ç­¾æ¥çŸ¥ä¼šIE*ï¼ˆä¹Ÿä»…æœ‰IEèƒ½è¯†åˆ«ï¼‰*é¡µé¢*ï¼ˆåŒæ ·ä¹Ÿåªå¯¹é¡µé¢æœ‰æ•ˆï¼Œå¯¹é¡µé¢ä¸Šçš„èµ„æºæ— æ•ˆï¼‰*ç¼“å­˜æ—¶é—´ï¼š

```
<meta http-equiv="expires" content="mon, 18 apr 2016 14:30:00 GMT">
```

å¦‚æœå¸Œæœ›åœ¨IEä¸‹é¡µé¢ä¸èµ°ç¼“å­˜ï¼Œå¸Œæœ›æ¯æ¬¡åˆ·æ–°é¡µé¢éƒ½èƒ½å‘æ–°è¯·æ±‚ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠâ€œcontentâ€é‡Œçš„å€¼å†™ä¸ºâ€œ-1â€æˆ–â€œ0â€ã€‚

æ³¨æ„çš„æ˜¯è¯¥æ–¹å¼ä»…ä»…ä½œä¸ºçŸ¥ä¼šIEç¼“å­˜æ—¶é—´çš„æ ‡è®°ï¼Œä½ å¹¶ä¸èƒ½åœ¨è¯·æ±‚æˆ–å“åº”æŠ¥æ–‡ä¸­æ‰¾åˆ°Expireså­—æ®µã€‚

å¦‚æœæ˜¯åœ¨æœåŠ¡ç«¯æŠ¥å¤´è¿”å›Expireså­—æ®µï¼Œåˆ™åœ¨ä»»ä½•æµè§ˆå™¨ä¸­éƒ½èƒ½æ­£ç¡®è®¾ç½®èµ„æºç¼“å­˜çš„æ—¶é—´ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160403120337051-1989638817.png)

åœ¨ä¸Šå›¾é‡Œï¼Œç¼“å­˜æ—¶é—´è®¾ç½®ä¸ºä¸€ä¸ªå·²è¿‡æœŸçš„æ—¶é—´ç‚¹*ï¼ˆè§çº¢æ¡†ï¼‰*ï¼Œåˆ™åˆ·æ–°é¡µé¢å°†é‡æ–°å‘é€è¯·æ±‚*ï¼ˆè§è“æ¡†ï¼‰*ã€‚

é‚£ä¹ˆå¦‚æœPragmaå’ŒExpiresä¸€èµ·ä¸Šé˜µçš„è¯ï¼Œå¬è°çš„ï¼Ÿæˆ‘ä»¬è¯•ä¸€è¯•å°±çŸ¥é“äº†ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160403122006566-1603115184.png)

æˆ‘ä»¬é€šè¿‡Pragmaç¦ç”¨ç¼“å­˜ï¼Œåˆç»™Expireså®šä¹‰ä¸€ä¸ªè¿˜æœªåˆ°æœŸçš„æ—¶é—´*ï¼ˆçº¢æ¡†ï¼‰*ï¼Œåˆ·æ–°é¡µé¢æ—¶å‘ç°å‡å‘èµ·äº†æ–°è¯·æ±‚*ï¼ˆè“æ¡†ï¼‰*ï¼Œè¿™æ„å‘³ç€Pragmaå­—æ®µçš„ä¼˜å…ˆçº§ä¼šæ›´é«˜ã€‚

BUTï¼Œå“åº”æŠ¥æ–‡ä¸­Expiresæ‰€å®šä¹‰çš„ç¼“å­˜æ—¶é—´æ˜¯ç›¸å¯¹æœåŠ¡å™¨ä¸Šçš„æ—¶é—´è€Œè¨€çš„ï¼Œå¦‚æœå®¢æˆ·ç«¯ä¸Šçš„æ—¶é—´è·ŸæœåŠ¡å™¨ä¸Šçš„æ—¶é—´ä¸ä¸€è‡´*ï¼ˆç‰¹åˆ«æ˜¯ç”¨æˆ·ä¿®æ”¹äº†è‡ªå·±ç”µè„‘çš„ç³»ç»Ÿæ—¶é—´ï¼‰*ï¼Œé‚£ç¼“å­˜æ—¶é—´å¯èƒ½å°±æ²¡å•¥æ„ä¹‰äº†ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**Cache-Control**

é’ˆå¯¹ä¸Šè¿°çš„â€œExpiresæ—¶é—´æ˜¯ç›¸å¯¹æœåŠ¡å™¨è€Œè¨€ï¼Œæ— æ³•ä¿è¯å’Œå®¢æˆ·ç«¯æ—¶é—´ç»Ÿä¸€â€çš„é—®é¢˜ï¼Œhttp1.1æ–°å¢äº† Cache-Control æ¥å®šä¹‰ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œè‹¥æŠ¥æ–‡ä¸­åŒæ—¶å‡ºç°äº† Pragmaã€Expires å’Œ Cache-Controlï¼Œä¼šä»¥ Cache-Control ä¸ºå‡†ã€‚

Cache-Controlä¹Ÿæ˜¯ä¸€ä¸ªé€šç”¨é¦–éƒ¨å­—æ®µï¼Œè¿™æ„å‘³ç€å®ƒèƒ½åˆ†åˆ«åœ¨è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡ä¸­ä½¿ç”¨ã€‚åœ¨RFCä¸­è§„èŒƒäº† Cache-Control çš„æ ¼å¼ä¸ºï¼š

```
"Cache-Control" ":" cache-directive
```

ä½œä¸ºè¯·æ±‚é¦–éƒ¨æ—¶ï¼Œcache-directive çš„å¯é€‰å€¼æœ‰ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160403173213113-100043029.png)

ä½œä¸ºå“åº”é¦–éƒ¨æ—¶ï¼Œcache-directive çš„å¯é€‰å€¼æœ‰ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160403181549941-1360231582.png)

æˆ‘ä»¬ä¾æ—§å¯ä»¥åœ¨HTMLé¡µé¢åŠ ä¸Šmetaæ ‡ç­¾æ¥ç»™è¯·æ±‚æŠ¥å¤´åŠ ä¸Š Cache-Control å­—æ®µï¼š

å¦å¤– Cache-Control å…è®¸è‡ªç”±ç»„åˆå¯é€‰å€¼ï¼Œä¾‹å¦‚ï¼š

```
Cache-Control: max-age=3600, must-revalidate
```

å®ƒæ„å‘³ç€è¯¥èµ„æºæ˜¯ä»åŸæœåŠ¡å™¨ä¸Šå–å¾—çš„ï¼Œä¸”å…¶ç¼“å­˜ï¼ˆæ–°é²œåº¦ï¼‰çš„æœ‰æ•ˆæ—¶é—´ä¸ºä¸€å°æ—¶ï¼Œåœ¨åç»­ä¸€å°æ—¶å†…ï¼Œç”¨æˆ·é‡æ–°è®¿é—®è¯¥èµ„æºåˆ™æ— é¡»å‘é€è¯·æ±‚ã€‚

å½“ç„¶è¿™ç§ç»„åˆçš„æ–¹å¼ä¹Ÿä¼šæœ‰äº›é™åˆ¶ï¼Œæ¯”å¦‚ no-cache å°±ä¸èƒ½å’Œ max-ageã€min-freshã€max-stale ä¸€èµ·æ­é…ä½¿ç”¨ã€‚

ç»„åˆçš„å½¢å¼è¿˜èƒ½åšä¸€äº›æµè§ˆå™¨è¡Œä¸ºä¸ä¸€è‡´çš„å…¼å®¹å¤„ç†ã€‚ä¾‹å¦‚åœ¨IEæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ no-cache æ¥é˜²æ­¢ç‚¹å‡»â€œåé€€â€æŒ‰é’®æ—¶é¡µé¢èµ„æºä»ç¼“å­˜åŠ è½½ï¼Œä½†åœ¨ Firefox ä¸­ï¼Œéœ€è¦ä½¿ç”¨ no-store æ‰èƒ½é˜²æ­¢å†å²å›é€€æ—¶æµè§ˆå™¨ä¸ä»ç¼“å­˜ä¸­å»è¯»å–æ•°æ®ï¼Œæ•…æˆ‘ä»¬åœ¨å“åº”æŠ¥å¤´åŠ ä¸Šå¦‚ä¸‹ç»„åˆå€¼å³å¯åšå…¼å®¹å¤„ç†ï¼š

```
Cache-Control: no-cache, no-store
```

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**ç¼“å­˜æ ¡éªŒå­—æ®µ**

ä¸Šè¿°çš„é¦–éƒ¨å­—æ®µå‡èƒ½è®©å®¢æˆ·ç«¯å†³å®šæ˜¯å¦å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œæ¯”å¦‚è®¾ç½®çš„ç¼“å­˜æ—¶é—´æœªè¿‡æœŸï¼Œé‚£ä¹ˆè‡ªç„¶ç›´æ¥ä»æœ¬åœ°ç¼“å­˜å–æ•°æ®å³å¯ï¼ˆåœ¨chromeä¸‹è¡¨ç°ä¸º200 from cacheï¼‰ï¼Œè‹¥ç¼“å­˜æ—¶é—´è¿‡æœŸäº†æˆ–èµ„æºä¸è¯¥ç›´æ¥èµ°ç¼“å­˜ï¼Œåˆ™ä¼šå‘è¯·æ±‚åˆ°æœåŠ¡å™¨å»ã€‚

æˆ‘ä»¬ç°åœ¨è¦è¯´çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘äº†è¯·æ±‚ï¼Œé‚£ä¹ˆæ˜¯å¦æ„å‘³ç€ä¸€å®šè¦è¯»å–å›è¯¥èµ„æºçš„æ•´ä¸ªå®ä½“å†…å®¹å‘¢ï¼Ÿ

æˆ‘ä»¬è¯•ç€è¿™ä¹ˆæƒ³â€”â€”å®¢æˆ·ç«¯ä¸ŠæŸä¸ªèµ„æºä¿å­˜çš„ç¼“å­˜æ—¶é—´è¿‡æœŸäº†ï¼Œä½†è¿™æ—¶å€™å…¶å®æœåŠ¡å™¨å¹¶æ²¡æœ‰æ›´æ–°è¿‡è¿™ä¸ªèµ„æºï¼Œå¦‚æœè¿™ä¸ªèµ„æºæ•°æ®é‡å¾ˆå¤§ï¼Œå®¢æˆ·ç«¯è¦æ±‚æœåŠ¡å™¨å†æŠŠè¿™ä¸ªä¸œè¥¿é‡æ–°å‘ä¸€éè¿‡æ¥ï¼Œæ˜¯å¦éå¸¸æµªè´¹å¸¦å®½å’Œæ—¶é—´å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé‚£ä¹ˆæ˜¯å¦æœ‰åŠæ³•è®©æœåŠ¡å™¨çŸ¥é“å®¢æˆ·ç«¯ç°åœ¨å­˜æœ‰çš„ç¼“å­˜æ–‡ä»¶ï¼Œå…¶å®è·Ÿè‡ªå·±æ‰€æœ‰çš„æ–‡ä»¶æ˜¯ä¸€è‡´çš„ï¼Œç„¶åç›´æ¥å‘Šè¯‰å®¢æˆ·ç«¯è¯´â€œè¿™ä¸œè¥¿ä½ ç›´æ¥ç”¨ç¼“å­˜é‡Œçš„å°±å¯ä»¥äº†ï¼Œæˆ‘è¿™è¾¹æ²¡æ›´æ–°è¿‡å‘¢ï¼Œå°±ä¸å†ä¼ ä¸€æ¬¡è¿‡å»äº†â€ã€‚

ä¸ºäº†è®©å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´èƒ½å®ç°ç¼“å­˜æ–‡ä»¶æ˜¯å¦æ›´æ–°çš„éªŒè¯ã€æå‡ç¼“å­˜çš„å¤ç”¨ç‡ï¼ŒHttp1.1æ–°å¢äº†å‡ ä¸ªé¦–éƒ¨å­—æ®µæ¥åšè¿™ä»¶äº‹æƒ…ã€‚

**1. Last-Modified**

æœåŠ¡å™¨å°†èµ„æºä¼ é€’ç»™å®¢æˆ·ç«¯æ—¶ï¼Œä¼šå°†èµ„æºæœ€åæ›´æ”¹çš„æ—¶é—´ä»¥â€œLast-Modified: GMTâ€çš„å½¢å¼åŠ åœ¨å®ä½“é¦–éƒ¨ä¸Šä¸€èµ·è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

å®¢æˆ·ç«¯ä¼šä¸ºèµ„æºæ ‡è®°ä¸Šè¯¥ä¿¡æ¯ï¼Œä¸‹æ¬¡å†æ¬¡è¯·æ±‚æ—¶ï¼Œä¼šæŠŠè¯¥ä¿¡æ¯é™„å¸¦åœ¨è¯·æ±‚æŠ¥æ–‡ä¸­ä¸€å¹¶å¸¦ç»™æœåŠ¡å™¨å»åšæ£€æŸ¥ï¼Œè‹¥ä¼ é€’çš„æ—¶é—´å€¼ä¸æœåŠ¡å™¨ä¸Šè¯¥èµ„æºæœ€ç»ˆä¿®æ”¹æ—¶é—´æ˜¯ä¸€è‡´çš„ï¼Œåˆ™è¯´æ˜è¯¥èµ„æºæ²¡æœ‰è¢«ä¿®æ”¹è¿‡ï¼Œç›´æ¥è¿”å›304çŠ¶æ€ç å³å¯ã€‚

è‡³äºä¼ é€’æ ‡è®°èµ·æ¥çš„æœ€ç»ˆä¿®æ”¹æ—¶é—´çš„è¯·æ±‚æŠ¥æ–‡é¦–éƒ¨å­—æ®µä¸€å…±æœ‰ä¸¤ä¸ªï¼š

**â‘´ If-Modified-Since: Last-Modified-value**

```
ç¤ºä¾‹ä¸º  If-Modified-Since: Thu, 31 Mar 2016 07:07:52 GMT
```

è¯¥è¯·æ±‚é¦–éƒ¨å‘Šè¯‰æœåŠ¡å™¨å¦‚æœå®¢æˆ·ç«¯ä¼ æ¥çš„æœ€åä¿®æ”¹æ—¶é—´ä¸æœåŠ¡å™¨ä¸Šçš„ä¸€è‡´ï¼Œåˆ™ç›´æ¥å›é€304 å’Œå“åº”æŠ¥å¤´å³å¯ã€‚

å½“å‰å„æµè§ˆå™¨å‡æ˜¯ä½¿ç”¨çš„è¯¥è¯·æ±‚é¦–éƒ¨æ¥å‘æœåŠ¡å™¨ä¼ é€’ä¿å­˜çš„ Last-Modified å€¼ã€‚

***\*â‘µ\** If-Unmodified-Since: Last-Modified-value**

å‘Šè¯‰æœåŠ¡å™¨ï¼Œè‹¥Last-Modifiedæ²¡æœ‰åŒ¹é…ä¸Š*ï¼ˆèµ„æºåœ¨æœåŠ¡ç«¯çš„æœ€åæ›´æ–°æ—¶é—´æ”¹å˜äº†ï¼‰*ï¼Œåˆ™åº”å½“è¿”å›412(Precondition Failed) çŠ¶æ€ç ç»™å®¢æˆ·ç«¯ã€‚

å½“é‡åˆ°ä¸‹é¢æƒ…å†µæ—¶ï¼ŒIf-Unmodified-Since å­—æ®µä¼šè¢«å¿½ç•¥ï¼š

```
1. Last-Modifiedå€¼å¯¹ä¸Šäº†ï¼ˆèµ„æºåœ¨æœåŠ¡ç«¯æ²¡æœ‰æ–°çš„ä¿®æ”¹ï¼‰ï¼›
2. æœåŠ¡ç«¯éœ€è¿”å›2XXå’Œ412ä¹‹å¤–çš„çŠ¶æ€ç ï¼›
3. ä¼ æ¥çš„æŒ‡å®šæ—¥æœŸä¸åˆæ³•
```

Last-Modified è¯´å¥½å´ä¹Ÿä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œå› ä¸ºå¦‚æœåœ¨æœåŠ¡å™¨ä¸Šï¼Œä¸€ä¸ªèµ„æºè¢«ä¿®æ”¹äº†ï¼Œä½†å…¶å®é™…å†…å®¹æ ¹æœ¬æ²¡å‘ç”Ÿæ”¹å˜ï¼Œä¼šå› ä¸ºLast-Modifiedæ—¶é—´åŒ¹é…ä¸ä¸Šè€Œè¿”å›äº†æ•´ä¸ªå®ä½“ç»™å®¢æˆ·ç«¯*ï¼ˆå³ä½¿å®¢æˆ·ç«¯ç¼“å­˜é‡Œæœ‰ä¸ªä¸€æ¨¡ä¸€æ ·çš„èµ„æºï¼‰*ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**2. ETag**

ä¸ºäº†è§£å†³ä¸Šè¿°Last-Modifiedå¯èƒ½å­˜åœ¨çš„ä¸å‡†ç¡®çš„é—®é¢˜ï¼ŒHttp1.1è¿˜æ¨å‡ºäº† ETag å®ä½“é¦–éƒ¨å­—æ®µã€‚

æœåŠ¡å™¨ä¼šé€šè¿‡æŸç§ç®—æ³•ï¼Œç»™èµ„æºè®¡ç®—å¾—å‡ºä¸€ä¸ªå”¯ä¸€æ ‡å¿—ç¬¦*ï¼ˆæ¯”å¦‚md5æ ‡å¿—ï¼‰*ï¼Œåœ¨æŠŠèµ„æºå“åº”ç»™å®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œä¼šåœ¨å®ä½“é¦–éƒ¨åŠ ä¸Šâ€œETag: å”¯ä¸€æ ‡è¯†ç¬¦â€ä¸€èµ·è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

å®¢æˆ·ç«¯ä¼šä¿ç•™è¯¥ ETag å­—æ®µï¼Œå¹¶åœ¨ä¸‹ä¸€æ¬¡è¯·æ±‚æ—¶å°†å…¶ä¸€å¹¶å¸¦è¿‡å»ç»™æœåŠ¡å™¨ã€‚æœåŠ¡å™¨åªéœ€è¦æ¯”è¾ƒå®¢æˆ·ç«¯ä¼ æ¥çš„ETagè·Ÿè‡ªå·±æœåŠ¡å™¨ä¸Šè¯¥èµ„æºçš„ETagæ˜¯å¦ä¸€è‡´ï¼Œå°±èƒ½å¾ˆå¥½åœ°åˆ¤æ–­èµ„æºç›¸å¯¹å®¢æˆ·ç«¯è€Œè¨€æ˜¯å¦è¢«ä¿®æ”¹è¿‡äº†ã€‚

å¦‚æœæœåŠ¡å™¨å‘ç°ETagåŒ¹é…ä¸ä¸Šï¼Œé‚£ä¹ˆç›´æ¥ä»¥å¸¸è§„GET 200å›åŒ…å½¢å¼å°†æ–°çš„èµ„æº*ï¼ˆå½“ç„¶ä¹ŸåŒ…æ‹¬äº†æ–°çš„ETagï¼‰*å‘ç»™å®¢æˆ·ç«¯ï¼›å¦‚æœETagæ˜¯ä¸€è‡´çš„ï¼Œåˆ™ç›´æ¥è¿”å›304çŸ¥ä¼šå®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜å³å¯ã€‚

é‚£ä¹ˆå®¢æˆ·ç«¯æ˜¯å¦‚ä½•æŠŠæ ‡è®°åœ¨èµ„æºä¸Šçš„ ETag ä¼ å»ç»™æœåŠ¡å™¨çš„å‘¢ï¼Ÿè¯·æ±‚æŠ¥æ–‡ä¸­æœ‰ä¸¤ä¸ªé¦–éƒ¨å­—æ®µå¯ä»¥å¸¦ä¸Š ETag å€¼ï¼š

**â‘´ If-None-Match: ETag-value**

```
ç¤ºä¾‹ä¸º  If-None-Match: "56fcccc8-1699"
```

å‘Šè¯‰æœåŠ¡ç«¯å¦‚æœ ETag æ²¡åŒ¹é…ä¸Šéœ€è¦é‡å‘èµ„æºæ•°æ®ï¼Œå¦åˆ™ç›´æ¥å›é€304 å’Œå“åº”æŠ¥å¤´å³å¯ã€‚

å½“å‰å„æµè§ˆå™¨å‡æ˜¯ä½¿ç”¨çš„è¯¥è¯·æ±‚é¦–éƒ¨æ¥å‘æœåŠ¡å™¨ä¼ é€’ä¿å­˜çš„ ETag å€¼ã€‚

**â‘µ If-Match: ETag-value**

å‘Šè¯‰æœåŠ¡å™¨å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ETagï¼Œæˆ–è€…æ”¶åˆ°äº†â€œ*â€å€¼è€Œå½“å‰å¹¶æ²¡æœ‰è¯¥èµ„æºå®ä½“ï¼Œåˆ™åº”å½“è¿”å›412(Precondition Failed) çŠ¶æ€ç ç»™å®¢æˆ·ç«¯ã€‚å¦åˆ™æœåŠ¡å™¨ç›´æ¥å¿½ç•¥è¯¥å­—æ®µã€‚

If-Match çš„ä¸€ä¸ªåº”ç”¨åœºæ™¯æ˜¯ï¼Œå®¢æˆ·ç«¯èµ°PUTæ–¹æ³•å‘æœåŠ¡ç«¯è¯·æ±‚ä¸Šä¼ /æ›´æ›¿èµ„æºï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡ If-Match ä¼ é€’èµ„æºçš„ETagã€‚

 

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœèµ„æºæ˜¯èµ°åˆ†å¸ƒå¼æœåŠ¡å™¨ï¼ˆæ¯”å¦‚CDNï¼‰å­˜å‚¨çš„æƒ…å†µï¼Œéœ€è¦è¿™äº›æœåŠ¡å™¨ä¸Šè®¡ç®—ETagå”¯ä¸€å€¼çš„ç®—æ³•ä¿æŒä¸€è‡´ï¼Œæ‰ä¸ä¼šå¯¼è‡´æ˜æ˜åŒä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨æœåŠ¡å™¨Aå’ŒæœåŠ¡å™¨Bä¸Šç”Ÿæˆçš„ETagå´ä¸ä¸€æ ·ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

å¦‚æœ Last-Modified å’Œ ETag åŒæ—¶è¢«ä½¿ç”¨ï¼Œåˆ™è¦æ±‚å®ƒä»¬çš„éªŒè¯éƒ½å¿…é¡»é€šè¿‡æ‰ä¼šè¿”å›304ï¼Œè‹¥å…¶ä¸­æŸä¸ªéªŒè¯æ²¡é€šè¿‡ï¼Œåˆ™æœåŠ¡å™¨ä¼šæŒ‰å¸¸è§„è¿”å›èµ„æºå®ä½“åŠ200çŠ¶æ€ç ã€‚

åœ¨è¾ƒæ–°çš„ nginx ä¸Šé»˜è®¤æ˜¯åŒæ—¶å¼€å¯äº†è¿™ä¸¤ä¸ªåŠŸèƒ½çš„ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160404021556078-697982021.gif)

ä¸Šå›¾çš„å‰ä¸‰æ¡è¯·æ±‚æ˜¯åŸå§‹è¯·æ±‚ï¼Œæ¥ç€çš„ä¸‰æ¡è¯·æ±‚æ˜¯åˆ·æ–°é¡µé¢åçš„æ–°è¯·æ±‚ï¼Œåœ¨å‘æ–°è¯·æ±‚ä¹‹å‰æˆ‘ä»¬ä¿®æ”¹äº† reset.css æ–‡ä»¶ï¼Œæ‰€ä»¥å®ƒçš„ Last-Modified å’Œ ETag å‡å‘ç”Ÿäº†æ”¹å˜ï¼ŒæœåŠ¡å™¨å› æ­¤è¿”å›äº†æ–°çš„æ–‡ä»¶ç»™å®¢æˆ·ç«¯*ï¼ˆçŠ¶æ€å€¼ä¸º200ï¼‰*ã€‚

è€Œ dog.jpg æˆ‘ä»¬æ²¡æœ‰åšä¿®æ”¹ï¼Œå…¶Last-Modified å’Œ ETagåœ¨æœåŠ¡ç«¯æ˜¯ä¿æŒä¸å˜çš„ï¼Œæ•…æœåŠ¡å™¨ç›´æ¥è¿”å›äº†304çŠ¶æ€ç è®©å®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ dog.jpg å³å¯ï¼Œæ²¡æœ‰æŠŠå®ä½“å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯*ï¼ˆå› ä¸ºæ²¡å¿…è¦ï¼‰*ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**ç¼“å­˜å®è·µ**

å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªé¡¹ç›®ä¸Šåšhttpç¼“å­˜çš„åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šæŠŠä¸Šè¿°æåŠçš„å¤§å¤šæ•°é¦–éƒ¨å­—æ®µå‡ä½¿ç”¨ä¸Šï¼Œä¾‹å¦‚ä½¿ç”¨ Expires æ¥å…¼å®¹æ—§çš„æµè§ˆå™¨ï¼Œä½¿ç”¨ Cache-Control æ¥æ›´ç²¾å‡†åœ°åˆ©ç”¨ç¼“å­˜ï¼Œç„¶åå¼€å¯ ETag è·Ÿ Last-Modified åŠŸèƒ½è¿›ä¸€æ­¥å¤ç”¨ç¼“å­˜å‡å°‘æµé‡ã€‚

é‚£ä¹ˆè¿™é‡Œä¼šæœ‰ä¸€ä¸ªå°é—®é¢˜â€”â€”Expires å’Œ Cache-Control çš„å€¼åº”è®¾ç½®ä¸ºå¤šå°‘åˆé€‚å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ä¸ä¼šæœ‰è¿‡äºç²¾å‡†çš„å€¼ï¼Œå‡éœ€è¦è¿›è¡ŒæŒ‰éœ€è¯„ä¼°ã€‚

ä¾‹å¦‚é¡µé¢é“¾æ¥çš„è¯·æ±‚å¸¸è§„æ˜¯æ— é¡»åšé•¿æ—¶é—´ç¼“å­˜çš„ï¼Œä»è€Œä¿è¯å›é€€åˆ°é¡µé¢æ—¶èƒ½é‡æ–°å‘å‡ºè¯·æ±‚ï¼Œç™¾åº¦é¦–é¡µæ˜¯ç”¨çš„ Cache-Control:privateï¼Œè…¾è®¯é¦–é¡µåˆ™æ˜¯è®¾å®šäº†60ç§’çš„ç¼“å­˜ï¼Œå³ Cache-Control:max-age=60ã€‚

è€Œé™æ€èµ„æºéƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯å›¾ç‰‡èµ„æºï¼Œé€šå¸¸ä¼šè®¾å®šä¸€ä¸ªè¾ƒé•¿çš„ç¼“å­˜æ—¶é—´ï¼Œè€Œä¸”è¿™ä¸ªæ—¶é—´æœ€å¥½æ˜¯å¯ä»¥åœ¨å®¢æˆ·ç«¯çµæ´»ä¿®æ”¹çš„ã€‚ä»¥è…¾è®¯çš„æŸå¼ å›¾ç‰‡ä¸ºä¾‹ï¼š

```
http://i.gtimg.cn/vipstyle/vipportal/v4/img/common/logo.png?max_age=2592000
```

å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ç»™å›¾ç‰‡åŠ ä¸Šâ€œmax_ageâ€çš„å‚æ•°æ¥å®šä¹‰æœåŠ¡å™¨è¿”å›çš„ç¼“å­˜æ—¶é—´ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160404115556000-838597877.png)

å½“ç„¶è¿™éœ€è¦æœ‰ä¸€ä¸ªå‰æâ€”â€”é™æ€èµ„æºèƒ½ç¡®ä¿é•¿æ—¶é—´ä¸åšæ”¹åŠ¨ã€‚å¦‚æœä¸€ä¸ªè„šæœ¬æ–‡ä»¶å“åº”ç»™å®¢æˆ·ç«¯å¹¶åšäº†é•¿æ—¶é—´çš„ç¼“å­˜ï¼Œè€ŒæœåŠ¡ç«¯åœ¨è¿‘æœŸä¿®æ”¹äº†è¯¥æ–‡ä»¶çš„è¯ï¼Œç¼“å­˜äº†æ­¤è„šæœ¬çš„å®¢æˆ·ç«¯å°†æ— æ³•åŠæ—¶è·å¾—æ–°çš„æ•°æ®ã€‚

è§£å†³è¯¥å›°æ‰°çš„åŠæ³•ä¹Ÿç®€å•â€”â€”æŠŠæœåŠ¡ä¾§ETagçš„é‚£ä¸€å¥—ä¹Ÿæ¬åˆ°å‰ç«¯æ¥ç”¨â€”â€”é¡µé¢çš„é™æ€èµ„æºä»¥ç‰ˆæœ¬å½¢å¼å‘å¸ƒï¼Œå¸¸ç”¨çš„æ–¹æ³•æ˜¯åœ¨æ–‡ä»¶åæˆ–å‚æ•°å¸¦ä¸Šä¸€ä¸²md5æˆ–æ—¶é—´æ ‡è®°ç¬¦ï¼š

```
https://hm.baidu.com/hm.js?e23800c454aa573c0ccb16b52665ac26
http://tb1.bdstatic.com/tb/_/tbean_safe_ajax_94e7ca2.js
http://img1.gtimg.com/ninja/2/2016/04/ninja145972803357449.jpg
```

å¦‚æœæ–‡ä»¶è¢«ä¿®æ”¹äº†ï¼Œæ‰æ›´æ”¹å…¶æ ‡è®°ç¬¦å†…å®¹ï¼Œè¿™æ ·èƒ½ç¡®ä¿å®¢æˆ·ç«¯èƒ½åŠæ—¶ä»æœåŠ¡å™¨æ”¶å–åˆ°æ–°ä¿®æ”¹çš„æ–‡ä»¶ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**å…³äºå¼€å¤´çš„é—®é¢˜**

ç°åœ¨å›è¿‡å¤´æ¥çœ‹æ–‡ç« å¼€å¤´çš„é—®é¢˜ï¼Œå¯èƒ½ä¼šè§‰å¾—ç­”æ¡ˆå¾ˆå®¹æ˜“å›ç­”å‡ºæ¥ã€‚

ç™¾åº¦é¦–é¡µçš„èµ„æºåœ¨åˆ·æ–°åå®é™…æ²¡æœ‰å‘é€ä»»ä½•è¯·æ±‚ï¼Œå› ä¸º Cache-Control å®šä¹‰çš„ç¼“å­˜æ—¶é—´æ®µè¿˜æ²¡åˆ°æœŸã€‚åœ¨Chromeä¸­å³ä½¿æ²¡å‘é€è¯·æ±‚ï¼Œä½†åªè¦ä»æœ¬åœ°çš„ç¼“å­˜ä¸­å–ï¼Œéƒ½ä¼šåœ¨Networké¢æ¿æ˜¾ç¤ºä¸€æ¡çŠ¶æ€ä¸º200ä¸”æ³¨æ˜â€œfrom cacheâ€çš„ä¼ªè¯·æ±‚ï¼Œå…¶Responseå†…å®¹åªæ˜¯ä¸Šä¸€æ¬¡å›åŒ…ç•™ä¸‹çš„æ•°æ®ã€‚

ç„¶è€Œè¿™å¹¶ä¸æ˜¯é—®é¢˜çš„å…¨éƒ¨ç­”æ¡ˆï¼Œæˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼Œåœ¨Chromeä¸­å¦‚æœç‚¹å‡»â€œåˆ·æ–°â€æŒ‰é’®ï¼ŒChromeä¼šå¼ºåˆ¶ç»™æ‰€æœ‰èµ„æºåŠ ä¸Šâ€œCache-Control: max-age=0â€çš„è¯·æ±‚é¦–éƒ¨å¹¶å‘æœåŠ¡å™¨å‘é€éªŒè¯è¯·æ±‚çš„ï¼Œè€Œåœ¨æ–‡ç« å¼€å¤´çš„åŠ¨å›¾ä¸­ï¼Œæˆ‘ä»¬çš„ç¡®ç‚¹å‡»äº†â€œåˆ·æ–°â€æŒ‰é’®ï¼Œå´ä¸è§æµè§ˆå™¨å‘å»æ–°è¯·æ±‚*ï¼ˆå¹¶è¿”å›304ï¼‰*ã€‚

å…³äºè¿™ä¸ªé—®é¢˜å…¶å®åœ¨ç»„å†…è·Ÿå°ä¼™ä¼´ä»¬è®¨è®ºè¿‡ï¼Œé€šè¿‡FiddleræŠ“åŒ…å‘ç°ï¼Œå¦‚æœå…³é—­Chromeçš„å¼€å‘è€…é¢æ¿å†ç‚¹å‡»â€œåˆ·æ–°â€æŒ‰é’®ï¼Œæµè§ˆå™¨æ˜¯ä¼šæŒ‰é¢„æœŸå‘é€éªŒè¯è¯·æ±‚ä¸”æ¥æ”¶è¿”å›çš„304å“åº”çš„ï¼Œå¦å¤–è¿™ä¸ªå¥‡æ€ªçš„æƒ…å†µåœ¨ä¸åŒçš„ç½‘ç«™ç”šè‡³ä¸åŒçš„ç”µè„‘ä¸‹å‡ºç°é¢‘ç‡éƒ½ä¸ä¸€è‡´ï¼Œæ‰€ä»¥æš‚æ—¶å°†å…¶å½’å’äºæµè§ˆå™¨çš„æ€ªå¼‚ååº”ã€‚

é‚£ä¹ˆæœ‰è¿™ä¹ˆä¸€ä¸ªé—®é¢˜â€”â€”æ˜¯å¦æœ‰åŠæ³•åœ¨æµè§ˆå™¨ç‚¹å‡»â€œåˆ·æ–°â€æŒ‰é’®çš„æ—¶å€™ä¸è®©æµè§ˆå™¨å»å‘æ–°çš„éªŒè¯è¯·æ±‚å‘¢ï¼Ÿ

åŠæ³•è¿˜æ˜¯æœ‰çš„ï¼Œå°±æ˜¯ä¸æ€ä¹ˆå®ç”¨â€”â€”åœ¨é¡µé¢åŠ è½½å®Œæ¯•åé€šè¿‡è„šæœ¬åŠ¨æ€åœ°æ·»åŠ èµ„æºï¼š

[![å¤åˆ¶ä»£ç ](http://images.cnblogs.com/cnblogs_com/vajoy/558869/o_copybutton.png)](javascript:void(0);)

```
$(window).load(function() {
      var bg='http://img.infinitynewtab.com/wallpaper/100.jpg';
      setTimeout(function() {  //setTimeoutæ˜¯å¿…é¡»çš„
       $('#bgOut').css('background-image', 'url('+bg+')');
      },0);
});
```

[![å¤åˆ¶ä»£ç ](http://images.cnblogs.com/cnblogs_com/vajoy/558869/o_copybutton.png)](javascript:void(0);)

å‡ºå¤„æ¥è‡ª[çŸ¥ä¹](https://www.zhihu.com/question/28725359/answer/41960936)ï¼Œæ›´å…·ä½“çš„è§£é‡Šå¯ä»¥å»çœ‹çœ‹ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**å…¶å®ƒç›¸å…³çš„é¦–éƒ¨å­—æ®µ**

äº‹å®ä¸Šè¾ƒå¸¸ç”¨å’Œé‡è¦çš„ç¼“å­˜ç›¸å…³å­—æ®µæˆ‘ä»¬éƒ½ä»‹ç»å®Œäº†ï¼Œè¿™é‡Œé¡ºå¸¦è®²è®²å‡ ä¸ªè·Ÿç¼“å­˜æœ‰å…³ç³»ï¼Œä½†æ²¡é‚£ä¹ˆä¸»è¦çš„å“åº”é¦–éƒ¨å­—æ®µã€‚

**1. Vary**

â€œvaryâ€æœ¬èº«æ˜¯â€œå˜åŒ–â€çš„æ„æ€ï¼Œè€Œåœ¨httpæŠ¥æ–‡ä¸­æ›´è¶‹äºæ˜¯â€œvary fromâ€*ï¼ˆä¸ã€‚ã€‚ã€‚ä¸åŒï¼‰*çš„å«ä¹‰ï¼Œå®ƒè¡¨ç¤ºæœåŠ¡ç«¯ä¼šä»¥ä»€ä¹ˆåŸºå‡†å­—æ®µæ¥åŒºåˆ†ã€ç­›é€‰ç¼“å­˜ç‰ˆæœ¬ã€‚

æˆ‘ä»¬å…ˆè€ƒè™‘è¿™ä¹ˆä¸€ä¸ªé—®é¢˜â€”â€”åœ¨æœåŠ¡ç«¯æœ‰ç€è¿™ä¹ˆä¸€ä¸ªåœ°å€ï¼Œå¦‚æœæ˜¯IEç”¨æˆ·åˆ™è¿”å›é’ˆå¯¹IEå¼€å‘çš„å†…å®¹ï¼Œå¦åˆ™è¿”å›å¦ä¸€ä¸ªä¸»æµæµè§ˆå™¨ç‰ˆæœ¬çš„å†…å®¹ã€‚è¿™å¾ˆç®€å•ï¼ŒæœåŠ¡ç«¯è·å–åˆ°è¯·æ±‚çš„ User-Agent å­—æ®µåšå¤„ç†å³å¯ã€‚ä½†æ˜¯ç”¨æˆ·è¯·æ±‚çš„æ˜¯ä»£ç†æœåŠ¡å™¨è€ŒéåŸæœåŠ¡å™¨ï¼Œä¸”ä»£ç†æœåŠ¡å™¨å¦‚æœç›´æ¥æŠŠç¼“å­˜çš„IEç‰ˆæœ¬èµ„æºå‘ç»™äº†éIEçš„å®¢æˆ·ç«¯ï¼Œè¿™å°±å‡ºé—®é¢˜äº†ã€‚

å› æ­¤ Vary ä¾¿æ˜¯ç€æ‰‹å¤„ç†è¯¥é—®é¢˜çš„é¦–éƒ¨å­—æ®µï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å“åº”æŠ¥æ–‡åŠ ä¸Šï¼š

```
Vary: User-Agent
```

ä¾¿èƒ½çŸ¥ä¼šä»£ç†æœåŠ¡å™¨éœ€è¦ä»¥ User-Agent è¿™ä¸ªè¯·æ±‚é¦–éƒ¨å­—æ®µæ¥åŒºåˆ«ç¼“å­˜ç‰ˆæœ¬ï¼Œé˜²æ­¢ä¼ é€’ç»™å®¢æˆ·ç«¯çš„ç¼“å­˜ä¸æ­£ç¡®ã€‚

Vary ä¹Ÿæ¥å—æ¡ä»¶ç»„åˆçš„å½¢å¼ï¼š

```
Vary: User-Agent, Accept-Encoding
```

è¿™æ„å‘³ç€æœåŠ¡å™¨åº”ä»¥ User-Agent å’Œ Accept-Encoding ä¸¤ä¸ªè¯·æ±‚é¦–éƒ¨å­—æ®µæ¥åŒºåˆ†ç¼“å­˜ç‰ˆæœ¬ã€‚

![img](https://images.cnblogs.com/cnblogs_com/vajoy/558869/o_div.jpg)

**2. Date å’Œ Age**

HTTPå¹¶æ²¡æœ‰æä¾›æŸç§æ–¹æ³•æ¥å¸®ç”¨æˆ·åŒºåˆ†å…¶æ”¶åˆ°çš„èµ„æºæ˜¯å¦å‘½ä¸­äº†ä»£ç†æœåŠ¡å™¨çš„ç¼“å­˜ï¼Œä½†åœ¨å®¢æˆ·ç«¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®—å“åº”æŠ¥æ–‡ä¸­çš„ Date å’Œ Age å­—æ®µæ¥å¾—åˆ°ç­”æ¡ˆã€‚

Date ç†æ‰€å½“ç„¶æ˜¯åŸæœåŠ¡å™¨å‘é€è¯¥èµ„æºå“åº”æŠ¥æ–‡çš„æ—¶é—´ï¼ˆGMTæ ¼å¼ï¼‰ï¼Œå¦‚æœä½ å‘ç° Date çš„æ—¶é—´ä¸â€œå½“å‰æ—¶é—´â€å·®åˆ«è¾ƒå¤§ï¼Œæˆ–è€…è¿ç»­F5åˆ·æ–°å‘ç° Date çš„å€¼éƒ½æ²¡å˜åŒ–ï¼Œåˆ™è¯´æ˜ä½ å½“å‰è¯·æ±‚æ˜¯å‘½ä¸­äº†ä»£ç†æœåŠ¡å™¨çš„ç¼“å­˜ã€‚

ä¸Šè¿°çš„â€œå½“å‰æ—¶é—´â€è‡ªç„¶æ˜¯ç›¸å¯¹äºåŸæœåŠ¡å™¨è€Œè¨€çš„æ—¶é—´ï¼Œé‚£ä¹ˆå¦‚ä½•è·æ‚‰åŸæœåŠ¡å™¨çš„å½“å‰æ—¶é—´å‘¢ï¼Ÿ

å¸¸è§„ä»é¡µé¢åœ°å€è¯·æ±‚çš„å“åº”æŠ¥æ–‡ä¸­å¯è·å¾—ï¼Œä»¥åšå®¢å›­é¦–é¡µä¸ºä¾‹ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160404150618953-1983755602.png)

æ¯æ¬¡ä½ åˆ·æ–°é¡µé¢ï¼Œæµè§ˆå™¨éƒ½ä¼šé‡æ–°å‘å‡ºè¿™æ¡urlçš„è¯·æ±‚ï¼Œä½ ä¼šå‘ç°å…¶ Date å€¼æ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œè¿™è¯´æ˜è¯¥é“¾æ¥æ²¡æœ‰å‘½ä¸­ç¼“å­˜ï¼Œéƒ½æ˜¯ä»åŸæœåŠ¡å™¨è¿”å›è¿‡æ¥çš„æ•°æ®ã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥æ‹¿é¡µé¢ä¸Šå…¶å®ƒé™æ€èµ„æºè¯·æ±‚å›åŒ…ä¸­çš„ Date ä¸å…¶è¿›è¡Œå¯¹æ¯”ï¼Œè‹¥é™æ€èµ„æºçš„ Date æ—©äºåŸæœåŠ¡ç«¯æ—¶é—´ï¼Œåˆ™è¯´æ˜å‘½ä¸­äº†ä»£ç†æœåŠ¡å™¨ç¼“å­˜ã€‚

é€šå¸¸è¿˜æ»¡è¶³è¿™ä¹ˆä¸ªæ¡ä»¶ï¼š

```
é™æ€èµ„æºAge + é™æ€èµ„æºDate = åŸæœåŠ¡ç«¯Date
```

è¿™é‡Œçš„ Age ä¹Ÿæ˜¯å“åº”æŠ¥æ–‡ä¸­çš„é¦–éƒ¨å­—æ®µï¼Œå®ƒè¡¨ç¤ºè¯¥æ–‡ä»¶åœ¨ä»£ç†æœåŠ¡å™¨ä¸­å­˜åœ¨çš„æ—¶é—´*ï¼ˆç§’ï¼‰*ï¼Œå¦‚æ–‡ä»¶è¢«ä¿®æ”¹æˆ–æ›¿æ¢ï¼ŒAgeä¼šé‡æ–°ç”±0å¼€å§‹ç´¯è®¡ã€‚

æˆ‘ä»¬åœ¨ä¸Šé¢é‚£å¼ åšå®¢å›­é¦–é¡µæŠ¥æ–‡æˆªå›¾çš„åŒä¸ªåœºæ™¯ä¸‹ï¼Œçœ‹çœ‹æŸä¸ªæ–‡ä»¶ï¼ˆjQuery.jsï¼‰å‘½ä¸­ä»£ç†æœåŠ¡å™¨ç¼“å­˜çš„å›åŒ…æ•°æ®ï¼š

![img](https://images2015.cnblogs.com/blog/561179/201604/561179-20160404150719593-444457092.png)

ä¼šå‘ç°å®ƒæ»¡è¶³æˆ‘ä»¬ä¸Šè¿°çš„è§„åˆ™ï¼š

```
//return true
new Date('Mon, 04 Apr 2016 07:03:17 GMT')/1000 == new Date('Sat, 19 Dec 2015 01:29:14 GMT')/1000 + 9264843
```

ä¸è¿‡è¿™æ¡è§„åˆ™ä¹Ÿä¸ä¸€å®šå‡†ç¡®ï¼Œç‰¹åˆ«æ˜¯å½“åŸæœåŠ¡å™¨ç»å¸¸ä¿®æ”¹ç³»ç»Ÿæ—¶é—´çš„æƒ…å†µä¸‹ã€‚

## 1.é‡è¦æ€§

å½“æˆ‘ä»¬é¢è¯•çš„æ—¶å€™ï¼Œå‰ç«¯æ€§èƒ½ä¼˜åŒ–æ–¹é¢ç®—æ˜¯å¿…è€ƒçš„çŸ¥è¯†ç‚¹ï¼Œä½†æ˜¯å·¥ä½œä¸­æˆ‘ä»¬åˆå¾ˆå°‘ä¼šé‡ç‚¹çš„å¯¹é¡¹ç›®è¿›è¡Œå‰ç«¯ä¼˜åŒ–ï¼Œå®ƒçœŸçš„ä¸é‡è¦å—ï¼Ÿ

å¦‚æœæˆ‘ä»¬å¯ä»¥å°†åç«¯å“åº”æ—¶é—´ç¼©çŸ­ä¸€åŠï¼Œæ•´ä½“å“åº”æ—¶é—´åªèƒ½å‡å°‘5%~10%ã€‚è€Œå¦‚æœå…³æ³¨å‰ç«¯æ€§èƒ½ï¼ŒåŒæ ·æ˜¯å°†å…¶å“åº”æ—¶é—´å‡å°‘ä¸€åŠï¼Œåˆ™æ•´ä½“å“åº”æ—¶é—´å¯ä»¥å‡å°‘40%~45%ã€‚

æ”¹è¿›å‰ç«¯é€šå¸¸åªéœ€è¦è¾ƒå°‘çš„æ—¶é—´å’Œèµ„æºï¼Œå‡å°‘åç«¯å»¶è¿Ÿä¼šå¸¦æ¥å¾ˆå¤§çš„æ”¹åŠ¨ã€‚

åªæœ‰10%~20%çš„æœ€ç»ˆç”¨æˆ·å“åº”æ—¶é—´èŠ±åœ¨äº†ä¸‹è½½HTMLæ–‡æ¡£ä¸Šï¼Œå…¶ä½™çš„80%~90%æ—¶é—´èŠ±åœ¨äº†ä¸‹è½½é¡µé¢ä¸­çš„æ‰€æœ‰ç»„ä»¶ä¸Šã€‚

## 2.å®šä½

### 2.1 æŠ€æœ¯ä¸Šçš„é€‰æ‹©

åœ¨å‰ç«¯æ—¥å¸¸å¼€å‘ä¸­ï¼ŒæŠ€æœ¯ä¸Šçš„é€‰æ‹©æ˜¯éå¸¸é‡è¦çš„ã€‚ä¸ºä»€ä¹ˆè¦è®²è¿™ä¸ªå‘¢ï¼Ÿå› ä¸ºç°è±¡é¢‘å‘ã€‚

å‰ç«¯å·¥ç¨‹åŒ–ä¸¥é‡çš„å½“ä¸‹ï¼Œè½»é‡åŒ–çš„æ¡†æ¶æ…¢æ…¢è¢«é—å¿˜æ‰äº†ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰çš„ä¸šåŠ¡åœºæ™¯éƒ½é€‚åˆä½¿ç”¨å·¥ç¨‹åŒ–æ¡†æ¶ï¼Œreact/vue å¹¶ä¸è½»é‡ã€‚

> å¤æ‚çš„æ¡†æ¶æ˜¯ä¸ºäº†è§£å†³å¤æ‚çš„ä¸šåŠ¡

å¦‚æœç ”å‘h5ã€PCå±•ç¤ºç­‰åœºæ™¯ç®€å•çš„ä¸šåŠ¡æ—¶å€™ï¼ŒjavascriptåŸç”Ÿ é…åˆä¸€äº›è½»é‡åŒ–æ’ä»¶æ›´é€‚åˆã€‚

å¤šé¡µé¢åº”ç”¨ä¹Ÿå¹¶ä¸éƒ½æ˜¯ç¼ºç‚¹ã€‚æ ¹æ®ä¸šåŠ¡ä¸åŒè€Œé€‰æ‹©ä¸ä¸€æ ·çš„æŠ€æœ¯æ˜¯éå¸¸é‡è¦çš„ï¼Œæ˜¯æ¯ä¸ªå‰ç«¯éƒ½åº”è¯¥åæ€çš„äº‹æƒ…ã€‚

è¿™æ–¹é¢æ˜¯å¯¼è‡´å¡é¡¿çš„å…³é”®é—®é¢˜ã€‚

### 2.2 NetWork

æˆ‘ä»¬çš„è€æœ‹å‹NetWorkæƒ³å¿…å‰ç«¯åŒå­¦éƒ½å¾ˆç†Ÿæ‚‰ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹networké¢æ¿

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87dbcd5fcd6c46b6b8b153f570e183ed~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ä»é¢æ¿ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹å‡ºä¸€äº›ä¿¡æ¯ï¼š

- è¯·æ±‚èµ„æºsize
- è¯·æ±‚èµ„æºæ—¶é•¿
- è¯·æ±‚èµ„æºæ•°é‡
- æ¥å£å“åº”æ—¶é•¿
- æ¥å£å‘èµ·æ•°é‡
- æ¥å£æŠ¥æ–‡size
- æ¥å£å“åº”çŠ¶æ€
- ç€‘å¸ƒå›¾

**ç€‘å¸ƒå›¾**æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

ç€‘å¸ƒå›¾å°±æ˜¯ä¸Šæ–¹å›¾ç‰‡åé¢çš„**waterfall**çºµåˆ—

ç€‘å¸ƒå›¾æ˜¯ä¸€ä¸ªçº§è”å›¾, å±•ç¤ºäº†æµè§ˆå™¨å¦‚ä½•åŠ è½½èµ„æºå¹¶æ¸²æŸ“æˆç½‘é¡µ. å›¾ä¸­çš„æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€æ¬¡å•ç‹¬çš„æµè§ˆå™¨è¯·æ±‚. è¿™ä¸ªå›¾è¶Šé•¿, è¯´æ˜åŠ è½½ç½‘é¡µè¿‡ç¨‹ä¸­æ‰€å‘çš„è¯·æ±‚è¶Šå¤š. æ¯ä¸€è¡Œçš„å®½åº¦, ä»£è¡¨æµè§ˆå™¨å‘å‡ºè¯·æ±‚å¹¶ä¸‹è½½è¯¥èµ„æºçš„è¿‡ç¨‹ä¸­æ‰€è€—è´¹çš„æ—¶é—´ã€‚å®ƒçš„ä¾§é‡ç‚¹åœ¨äºåˆ†æç½‘è·¯é“¾è·¯

ç€‘å¸ƒå›¾é¢œè‰²è¯´æ˜ï¼š

- **DNS Lookup** [æ·±ç»¿è‰²] - åœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨è¿›è¡Œé€šä¿¡ä¹‹å‰, å¿…é¡»ç»è¿‡DNSæŸ¥è¯¢, å°†åŸŸåè½¬æ¢æˆIPåœ°å€. åœ¨è¿™ä¸ªé˜¶æ®µ, ä½ å¯ä»¥å¤„ç†çš„ä¸œè¥¿å¾ˆå°‘. ä½†å¹¸è¿çš„æ˜¯, å¹¶éæ‰€æœ‰çš„è¯·æ±‚éƒ½éœ€è¦ç»è¿‡è¿™ä¸€é˜¶æ®µ.
- **Initial Connection** [æ©™è‰²] - åœ¨æµè§ˆå™¨å‘é€è¯·æ±‚ä¹‹å‰, å¿…é¡»å»ºç«‹TCPè¿æ¥. è¿™ä¸ªè¿‡ç¨‹ä»…ä»…å‘ç”Ÿåœ¨ç€‘å¸ƒå›¾ä¸­çš„å¼€å¤´å‡ è¡Œ, å¦åˆ™è¿™å°±æ˜¯ä¸ªæ€§èƒ½é—®é¢˜(åè¾¹ç»†è¯´).
- SSL/TLS Negotiation [ç´«è‰²] - å¦‚æœä½ çš„é¡µé¢æ˜¯é€šè¿‡SSL/TLSè¿™ç±»å®‰å…¨åè®®åŠ è½½èµ„æº, è¿™æ®µæ—¶é—´å°±æ˜¯æµè§ˆå™¨å»ºç«‹å®‰å…¨è¿æ¥çš„è¿‡ç¨‹. ç›®å‰Googleå°†HTTPSä½œä¸ºå…¶ æœç´¢æ’åå› ç´  ä¹‹ä¸€, SSL/TLS åå•†çš„ä½¿ç”¨å˜å¾—è¶Šæ¥è¶Šæ™®éäº†.
- **Time To First Byte (TTFB)** [ç»¿è‰²] - TTFB æ˜¯æµè§ˆå™¨è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨çš„æ—¶é—´+æœåŠ¡å™¨å¤„ç†è¯·æ±‚æ—¶é—´+å“åº”æŠ¥æ–‡çš„ç¬¬ä¸€å­—èŠ‚åˆ°è¾¾æµè§ˆå™¨çš„æ—¶é—´. æˆ‘ä»¬ç”¨è¿™ä¸ªæŒ‡æ ‡æ¥åˆ¤æ–­ä½ çš„webæœåŠ¡å™¨æ˜¯å¦æ€§èƒ½ä¸å¤Ÿ, æˆ–è€…è¯´ä½ æ˜¯å¦éœ€è¦ä½¿ç”¨CDN.
- **Downloading (è“è‰²)** - è¿™æ˜¯æµè§ˆå™¨ç”¨æ¥ä¸‹è½½èµ„æºæ‰€ç”¨çš„æ—¶é—´. è¿™æ®µæ—¶é—´è¶Šé•¿, è¯´æ˜èµ„æºè¶Šå¤§. ç†æƒ³æƒ…å†µä¸‹, ä½ å¯ä»¥é€šè¿‡æ§åˆ¶èµ„æºçš„å¤§å°æ¥æ§åˆ¶è¿™æ®µæ—¶é—´çš„é•¿åº¦.

é‚£ä¹ˆé™¤äº†ç€‘å¸ƒå›¾çš„é•¿åº¦å¤–ï¼Œæˆ‘ä»¬å¦‚ä½•æ‰èƒ½åˆ¤æ–­ä¸€ä¸ªç€‘å¸ƒå›¾çš„çŠ¶æ€æ˜¯**å¥åº·**çš„å‘¢ï¼Ÿ

- é¦–å…ˆ, å‡å°‘æ‰€æœ‰èµ„æºçš„åŠ è½½æ—¶é—´. äº¦å³å‡å°ç€‘å¸ƒå›¾çš„å®½åº¦. ç€‘å¸ƒå›¾è¶Šçª„, ç½‘ç«™çš„è®¿é—®é€Ÿåº¦è¶Šå¿«.
- å…¶æ¬¡, å‡å°‘è¯·æ±‚æ•°é‡ ä¹Ÿå°±æ˜¯é™ä½ç€‘å¸ƒå›¾çš„é«˜åº¦. ç€‘å¸ƒå›¾è¶ŠçŸ®è¶Šå¥½.
- æœ€å, é€šè¿‡ä¼˜åŒ–èµ„æºè¯·æ±‚é¡ºåºæ¥åŠ å¿«æ¸²æŸ“æ—¶é—´. ä»å›¾ä¸Šçœ‹, å°±æ˜¯å°†ç»¿è‰²çš„"å¼€å§‹æ¸²æŸ“"çº¿å‘å·¦ç§». è¿™æ¡çº¿å‘å·¦ç§»åŠ¨çš„è¶Šè¿œè¶Šå¥½.

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»networkçš„è§’åº¦å»æ’æŸ¥â€œæ…¢â€çš„é—®é¢˜ã€‚

### 2.3 webpack-bundle-analyzer

é¡¹ç›®æ„å»ºåç”Ÿæˆçš„bundleåŒ…æ˜¯å‹ç¼©åçš„ã€‚webpack-bundle-analyzeræ˜¯ä¸€æ¬¾åŒ…åˆ†æå·¥å…·ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å®ƒèƒ½å¸¦æ¥çš„æ•ˆæœã€‚å¦‚ä¸‹å›¾ï¼š

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9917c642fa5a4045839b4d0af2c299b2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ä»ä¸Šå›¾æ¥çœ‹ï¼Œæˆ‘ä»¬çš„bundleåŒ…è¢«è§£æçš„ä¸€è§ˆæ— ä½™ã€‚å…¶ä¸­æ¨¡å—é¢ç§¯å çš„è¶Šå¤§è¯´æ˜åœ¨bundleåŒ…ä¸­sizeè¶Šå¤§ã€‚å°±å€¼å¾—æ³¨æ„äº†ï¼Œé‡ç‚¹ä¼˜åŒ–ä¸€ä¸‹ã€‚

å®ƒèƒ½å¤Ÿæ’æŸ¥å‡ºæ¥çš„ä¿¡æ¯æœ‰

- æ˜¾ç¤ºåŒ…ä¸­æ‰€æœ‰æ‰“å…¥çš„æ¨¡å—
- æ˜¾ç¤ºæ¨¡å—size åŠ gzipåçš„size

æ’æŸ¥åŒ…ä¸­çš„æ¨¡å—æƒ…å½¢æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œé€šè¿‡webpack-bundle-analyzeræ¥æ’æŸ¥å‡ºä¸€äº›æ— ç”¨çš„æ¨¡å—ï¼Œè¿‡å¤§çš„æ¨¡å—ã€‚ç„¶åè¿›è¡Œä¼˜åŒ–ã€‚ä»¥å‡å°‘æˆ‘ä»¬çš„bundleåŒ…sizeï¼Œå‡å°‘åŠ è½½æ—¶é•¿ã€‚

å®‰è£…

```csharp
# NPM 
npm install --save-dev webpack-bundle-analyzer
# Yarn 
yarn add -D webpack-bundle-analyzer
å¤åˆ¶ä»£ç 
å¤åˆ¶ä»£ç 
```

ä½¿ç”¨(as a Webpack-Plugin)

```ini
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;
 
module.exports = {
  plugins: [
    new BundleAnalyzerPlugin()
  ]
}
å¤åˆ¶ä»£ç 
å¤åˆ¶ä»£ç 
```

ç„¶åæ„å»ºåŒ…å®Œæ¯•åä¼šè‡ªåŠ¨å¼¹å‡ºä¸€ä¸ªçª—å£å±•ç¤ºä¸Šå›¾ä¿¡æ¯ã€‚

### 2.4 Performance

chromeè‡ªå¸¦çš„performanceæ¨¡å—ã€‚å…ˆé™„ä¸Šä¸€ä¸ªå®˜ç½‘æ–‡æ¡£ä¼ é€é—¨ï¼š[Performance](https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ftools%2Fchrome-devtools%2Fevaluate-performance%2F%3Futm_source%3Ddevtools)

å¯ä»¥æ£€æµ‹å¾ˆå¤šæ–¹é¢çš„æ•°æ®ï¼Œå¤šæ•°æƒ…å†µçš„æ€§èƒ½æ’æŸ¥ä¸Šç”¨çš„æ¯”è¾ƒå¤šã€‚å¦‚æœæƒ³è¦æ·±å…¥äº†è§£çš„åŒå­¦å»ºè®®å»çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¯´ä¸€ä¸‹åœ¨performanceé¢æ¿ä¸­å¦‚ä½•æ’å·®â€œæ…¢â€çš„é—®é¢˜ï¼Œå®ƒç»™æˆ‘ä»¬æä¾›äº†å“ªäº›ä¿¡æ¯å‘¢ã€‚å…ˆé™„ä¸Šä¸€å¼ performanceçš„é¢æ¿å›¾ç‰‡ã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3027b177f77f49e3866eeecedefaa70b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ä»ä¸Šå›¾ä¸­å¯ä»¥åˆ†æå‡ºä¸€äº›æŒ‡æ ‡

- FCP/LCP æ—¶é—´æ˜¯å¦è¿‡é•¿ï¼Ÿ
- è¯·æ±‚å¹¶å‘æƒ…å†µ æ˜¯å¦å¹¶å‘é¢‘ç¹ï¼Ÿ
- è¯·æ±‚å‘èµ·é¡ºåº è¯·æ±‚å‘èµ·é¡ºåºæ˜¯å¦ä¸å¯¹ï¼Ÿ
- javascriptæ‰§è¡Œæƒ…å†µ javascriptæ‰§è¡Œæ˜¯å¦è¿‡æ…¢ï¼Ÿ

è¿™äº›æŒ‡æ ‡å°±æ˜¯æˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„ï¼Œå½“ç„¶performanceçš„åŠŸèƒ½å¹¶ä¸æ­¢äºæ­¤ã€‚

å…ˆè®°ä½å¦‚ä½•è·å–åˆ°è¿™äº›æŒ‡æ ‡ï¼Œåé¢æ¥ä¸€ä¸€è¿›è¡Œè§£æä¼˜åŒ–ã€‚

### 2.5 æ€§èƒ½ç›‘è§†å™¨

é¦–å…ˆæ‰“å¼€F12ï¼ŒéšåæŒ‰å¿«æ·é”® Ctrl + Shift + Pï¼Œç„¶åè¾“å…¥æ€§èƒ½ç›‘è§†å™¨/monitorã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0eb7de07f7e24bf281a1ecb7767f7f91~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

æ•°æ®éå¸¸ç›´è§‚ï¼Œæµè§ˆç½‘é¡µçš„æ—¶å€™å¯ä»¥æ‰“å¼€ï¼Œä»¥ä¾›å‚è€ƒã€‚

### 2.6 JavaScriptæ€§èƒ½å‰–æå™¨

é¦–å…ˆæ‰“å¼€F12ï¼ŒéšåæŒ‰å¿«æ·é”® Ctrl + Shift + Pï¼Œç„¶åè¾“å…¥æ€§èƒ½å‰–æå™¨/profilerã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f639b2cea40d4146bf5da141abdc3dca~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

æˆ‘ä»¬ç‚¹å‡»å¼€å§‹åæµè§ˆæˆ‘ä»¬çš„ç½‘é¡µï¼Œå°±ä¼šå‡ºç°ä¸€ä»½æ€§èƒ½å‰–ææŠ¥å‘Šã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c254a83dcd4f447c8889aa8347552b26~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

### 2.7 Recorder

è¿™æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„åŠŸèƒ½ï¼ŒRecorderé¡¾åæ€ä¹‰---è®°å½•å‘˜ï¼Œä»–å¯ä»¥è®°å½•ä¸‹ç”¨æˆ·å’Œç½‘é¡µçš„äº¤äº’(æ„å¿µè‰¾ç‰¹äº†ä¸‹å…¬å¸çš„äº¤äº’)ã€‚

é¦–å…ˆæ‰“å¼€F12ï¼ŒéšåæŒ‰å¿«æ·é”® Ctrl + Shift + Pï¼Œç„¶åè¾“å…¥Recorderã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07564a7ffc9342da8c38132238b3a0d6~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

ç‚¹å‡»å¼€å§‹ï¼Œç„¶åè¾“å…¥æœ¬æ¬¡æ“ä½œåç§°ï¼š æ˜é‡‘é»‘è‰²çš„æ«ä¸»é¡µäº¤äº’æ¢³ç†ã€‚

ç„¶åæˆ‘ä»¬å°±å¯ä»¥åˆ°å¤„ç‚¹ç‚¹çœ‹ï¼Œå°±ä¼šè®°å½•ä¸‹æˆ‘ä»¬çš„æ“ä½œã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90eff186e25d4b03a6c6b8bc9fc08c7c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

ç‚¹å‡»ç»“æŸä¹‹åå¯ä»¥ç»“æŸå½•åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å›è®¿æˆ‘ä»¬çš„æ“ä½œï¼Œè¿˜å¯ä»¥å¯¹æˆ‘ä»¬çš„æ“ä½œè¿›è¡Œåˆ†æã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/709b8212d7a9445ba6e779d711a43bf1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

åˆ†æä¸­åŒ…æ‹¬äº†å±å¹•æˆªå›¾ï¼Œå†…å­˜ï¼Œç½‘é¡µæŒ‡æ ‡ï¼Œå¦¥å¦¥çš„ç²¾å·¥åˆ©å™¨ã€‚

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b7a81b01114447ebad8434cdc2b82c3a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

ä»è¿™é‡Œæˆ‘ä»¬ä¼šäº†è§£åˆ°å¾ˆå¤šï¼Œæ¯”å¦‚äº‹ä»¶æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“æˆ‘ä»¬è§¦å‘æ“ä½œåéƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚

![img](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3d87b39658740d2bdcf4d088b421495~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

è€Œè°ƒç”¨æ ‘ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å¼‚æ­¥ä»»åŠ¡ï¼Œå®šæ—¶å™¨ï¼ŒåŠ¨ç”»å¸§ï¼Œåƒåœ¾å›æ”¶ç­‰çš„æ‰§è¡Œã€‚

![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ce0943327684a8e8a1c8bdfe93baddd~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

**Recorder**ç¡®å®å¯¹æˆ‘ä»¬ç½‘é¡µåˆ†ææœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚

### 2.8 PerformanceNavigationTiming

è·å–å„ä¸ªé˜¶æ®µçš„å“åº”æ—¶é—´ï¼Œæˆ‘ä»¬æ‰€è¦ç”¨åˆ°çš„æ¥å£æ˜¯**PerformanceNavigationTiming**æ¥å£ã€‚

**PerformanceNavigationTiming** æä¾›äº†ç”¨äºå­˜å‚¨å’Œæ£€ç´¢æœ‰å…³æµè§ˆå™¨æ–‡æ¡£äº‹ä»¶çš„æŒ‡æ ‡çš„æ–¹æ³•å’Œå±æ€§ã€‚ ä¾‹å¦‚ï¼Œæ­¤æ¥å£å¯ç”¨äºç¡®å®šåŠ è½½æˆ–å¸è½½æ–‡æ¡£éœ€è¦å¤šå°‘æ—¶é—´ã€‚

```javascript
function showNavigationDetails() {
  const [entry] = performance.getEntriesByType("navigation");
  console.table(entry.toJSON());
}
å¤åˆ¶ä»£ç 
```

ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–å„ä¸ªé˜¶æ®µçš„å“åº”æ—¶é—´ï¼Œå¦‚å›¾ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6aaeb84f30b24d7bafec2747e4ee46aa~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

**å‚æ•°è¯´æ˜**

navigationStart åŠ è½½èµ·å§‹æ—¶é—´
 redirectStart é‡å®šå‘å¼€å§‹æ—¶é—´ï¼ˆå¦‚æœå‘ç”Ÿäº†HTTPé‡å®šå‘ï¼Œæ¯æ¬¡é‡å®šå‘éƒ½å’Œå½“å‰æ–‡æ¡£åŒåŸŸçš„è¯ï¼Œå°±è¿”å›å¼€å§‹é‡å®šå‘çš„fetchStartçš„å€¼ã€‚å…¶ä»–æƒ…å†µï¼Œåˆ™è¿”å›0ï¼‰
 redirectEnd é‡å®šå‘ç»“æŸæ—¶é—´ï¼ˆå¦‚æœå‘ç”Ÿäº†HTTPé‡å®šå‘ï¼Œæ¯æ¬¡é‡å®šå‘éƒ½å’Œå½“å‰æ–‡æ¡£åŒåŸŸçš„è¯ï¼Œå°±è¿”å›æœ€åä¸€æ¬¡é‡å®šå‘æ¥å—å®Œæ•°æ®çš„æ—¶é—´ã€‚å…¶ä»–æƒ…å†µåˆ™è¿”å›0ï¼‰
 fetchStart æµè§ˆå™¨å‘èµ·èµ„æºè¯·æ±‚æ—¶ï¼Œå¦‚æœæœ‰ç¼“å­˜ï¼Œåˆ™è¿”å›è¯»å–ç¼“å­˜çš„å¼€å§‹æ—¶é—´
 domainLookupStart æŸ¥è¯¢DNSçš„å¼€å§‹æ—¶é—´ã€‚å¦‚æœè¯·æ±‚æ²¡æœ‰å‘èµ·DNSè¯·æ±‚ï¼Œå¦‚keep-aliveï¼Œç¼“å­˜ç­‰ï¼Œåˆ™è¿”å›fetchStart
 domainLookupEnd æŸ¥è¯¢DNSçš„ç»“æŸæ—¶é—´ã€‚å¦‚æœæ²¡æœ‰å‘èµ·DNSè¯·æ±‚ï¼ŒåŒä¸Š
 connectStart å¼€å§‹å»ºç«‹TCPè¯·æ±‚çš„æ—¶é—´ã€‚å¦‚æœè¯·æ±‚æ˜¯keep-aliveï¼Œç¼“å­˜ç­‰ï¼Œåˆ™è¿”å›domainLookupEnd
 (secureConnectionStart) å¦‚æœåœ¨è¿›è¡ŒTLSæˆ–SSLï¼Œåˆ™è¿”å›æ¡æ‰‹æ—¶é—´
 connectEnd å®ŒæˆTCPé“¾æ¥çš„æ—¶é—´ã€‚å¦‚æœæ˜¯keep-aliveï¼Œç¼“å­˜ç­‰ï¼ŒåŒconnectStart
 requestStart å‘èµ·è¯·æ±‚çš„æ—¶é—´
 responseStart æœåŠ¡å™¨å¼€å§‹å“åº”çš„æ—¶é—´
 domLoading ä»å›¾ä¸­çœ‹æ˜¯å¼€å§‹æ¸²æŸ“domçš„æ—¶é—´ï¼Œå…·ä½“æœªçŸ¥
 domInteractive æœªçŸ¥
 domContentLoadedEventStart å¼€å§‹è§¦å‘DomContentLoadedEventäº‹ä»¶çš„æ—¶é—´
 domContentLoadedEventEnd DomContentLoadedEventäº‹ä»¶ç»“æŸçš„æ—¶é—´
 domComplete ä»å›¾ä¸­çœ‹æ˜¯domæ¸²æŸ“å®Œæˆæ—¶é—´ï¼Œå…·ä½“æœªçŸ¥
 loadEventStart è§¦å‘loadçš„æ—¶é—´ï¼Œå¦‚æ²¡æœ‰åˆ™è¿”å›0
 loadEventEnd loadäº‹ä»¶æ‰§è¡Œå®Œçš„æ—¶é—´ï¼Œå¦‚æ²¡æœ‰åˆ™è¿”å›0
 unloadEventStart unloadäº‹ä»¶è§¦å‘çš„æ—¶é—´
 unloadEventEnd unloadäº‹ä»¶æ‰§è¡Œå®Œçš„æ—¶é—´

**å…³äºæˆ‘ä»¬çš„Webæ€§èƒ½ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°çš„æ—¶é—´å‚æ•°ï¼š**

DNSè§£ææ—¶é—´ï¼š domainLookupEnd - domainLookupStart
 TCPå»ºç«‹è¿æ¥æ—¶é—´ï¼š connectEnd - connectStart
 ç™½å±æ—¶é—´ï¼š responseStart - navigationStart
 domæ¸²æŸ“å®Œæˆæ—¶é—´ï¼š domContentLoadedEventEnd - navigationStart
 é¡µé¢onloadæ—¶é—´ï¼š loadEventEnd - navigationStart

æ ¹æ®è¿™äº›æ—¶é—´å‚æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­å“ªä¸€é˜¶æ®µå¯¹æ€§èƒ½æœ‰å½±å“ã€‚

### 2.9 æŠ“åŒ…

æœ‰ä¸€äº›ä¸šåŠ¡çŠ¶å†µæ˜¯æ²¡æœ‰ä¸Šè¿°çš„ä¸€äº›è°ƒè¯•å·¥å…·è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æŠ“åŒ…å·¥å…·è¿›è¡Œå¯¹é¡µé¢ä¿¡æ¯å¯¹æŠ“å–ï¼Œä¸Šè¿°æˆ‘ä»¬é€šè¿‡chromeå·¥å…·æ’æŸ¥å‡ºæ¥çš„æŒ‡æ ‡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŠ“åŒ…å·¥å…·è¿›è¡ŒæŠ“å–ã€‚

è¿™é‡Œæˆ‘æ¨èä¸€æ¬¾æŠ“åŒ…å·¥å…·[charles](https://link.juejin.cn?target=https%3A%2F%2Fwww.charlesproxy.com%2F)ã€‚

### 2.10 æ€§èƒ½æµ‹è¯•å·¥å…·

2.7.1 Pingdom

2.7.2 Load Impact

2.7.3 WebPage Test

2.7.4 Octa Gate Site Timer

2.7.5 Free Speed Test

## 3.ä¼˜åŒ–

å‰ç«¯çš„ä¼˜åŒ–ç§ç±»ç¹å¤šï¼Œä¸»è¦åŒ…å«ä¸‰ä¸ªæ–¹é¢çš„ä¼˜åŒ–ï¼šç½‘ç»œä¼˜åŒ–ï¼ˆå¯¹åŠ è½½æ—¶æ‰€æ¶ˆè€—çš„ç½‘ç»œèµ„æºä¼˜åŒ–ï¼‰ï¼Œä»£ç ä¼˜åŒ–ï¼ˆèµ„æºåŠ è½½å®Œåï¼Œè„šæœ¬è§£é‡Šæ‰§è¡Œçš„é€Ÿåº¦ï¼‰ï¼Œæ¡†æ¶ä¼˜åŒ–ï¼ˆé€‰æ‹©æ€§èƒ½è¾ƒå¥½çš„æ¡†æ¶ï¼Œæ¯”å¦‚[benchmark](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%3A%2F%2Fstefankrause.net%2Fjs-frameworks-benchmark8%2Ftable.html)ï¼‰ã€‚

### 3.1 tree shaking

ä¸­æ–‡ï¼ˆæ‘‡æ ‘ï¼‰ï¼Œwebpackæ„å»ºä¼˜åŒ–ä¸­é‡è¦ä¸€ç¯ã€‚æ‘‡æ ‘ç”¨äºæ¸…é™¤æˆ‘ä»¬é¡¹ç›®ä¸­çš„ä¸€äº›æ— ç”¨ä»£ç ï¼Œå®ƒä¾èµ–äºESä¸­çš„æ¨¡å—è¯­æ³•ã€‚

æ¯”å¦‚æ—¥å¸¸ä½¿ç”¨lodashçš„æ—¶å€™

```javascript
import _ from 'lodash'
å¤åˆ¶ä»£ç 
å¤åˆ¶ä»£ç 
```

å¦‚æœå¦‚ä¸Šå¼•ç”¨lodashåº“ï¼Œåœ¨æ„å»ºåŒ…çš„æ—¶å€™æ˜¯ä¼šæŠŠæ•´ä¸ªlodashåŒ…æ‰“å…¥åˆ°æˆ‘ä»¬çš„bundleåŒ…ä¸­çš„ã€‚

```javascript
import _isEmpty from 'lodash/isEmpty';
å¤åˆ¶ä»£ç 
å¤åˆ¶ä»£ç 
```

å¦‚æœå¦‚ä¸Šå¼•ç”¨lodashåº“ï¼Œåœ¨æ„å»ºåŒ…çš„æ—¶å€™åªä¼šæŠŠisEmptyè¿™ä¸ªæ–¹æ³•æŠ½ç¦»å‡ºæ¥å†æ‰“å…¥åˆ°æˆ‘ä»¬çš„bundleåŒ…ä¸­ã€‚

è¿™æ ·çš„åŒ–å°±ä¼šå¤§å¤§å‡å°‘æˆ‘ä»¬åŒ…çš„sizeã€‚æ‰€ä»¥åœ¨æ—¥å¸¸å¼•ç”¨ç¬¬ä¸‰æ–¹åº“çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„å¯¼å…¥çš„æ–¹å¼ã€‚

å¦‚ä½•å¼€å¯æ‘‡æ ‘

åœ¨webpack4.x ä¸­é»˜è®¤å¯¹tree-shakingè¿›è¡Œäº†æ”¯æŒã€‚ åœ¨webpack2.x ä¸­ä½¿ç”¨tree-shakingï¼š[ä¼ é€é—¨](https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F28725181)

### 3.2 split chunks

ä¸­æ–‡ï¼ˆåˆ†åŒ…ï¼‰

åœ¨æ²¡é…ç½®ä»»ä½•ä¸œè¥¿çš„æƒ…å†µä¸‹ï¼Œwebpack 4 å°±æ™ºèƒ½çš„å¸®ä½ åšäº†ä»£ç åˆ†åŒ…ã€‚å…¥å£æ–‡ä»¶ä¾èµ–çš„æ–‡ä»¶éƒ½è¢«æ‰“åŒ…è¿›äº†main.jsï¼Œé‚£äº›å¤§äº 30kb çš„ç¬¬ä¸‰æ–¹åŒ…ï¼Œå¦‚ï¼šechartsã€xlsxã€dropzoneç­‰éƒ½è¢«å•ç‹¬æ‰“åŒ…æˆäº†ä¸€ä¸ªä¸ªç‹¬ç«‹ bundleã€‚

å…¶å®ƒè¢«æˆ‘ä»¬è®¾ç½®äº†å¼‚æ­¥åŠ è½½çš„é¡µé¢æˆ–è€…ç»„ä»¶å˜æˆäº†ä¸€ä¸ªä¸ªchunkï¼Œä¹Ÿå°±æ˜¯è¢«æ‰“åŒ…æˆç‹¬ç«‹çš„bundleã€‚

å®ƒå†…ç½®çš„ä»£ç åˆ†å‰²ç­–ç•¥æ˜¯è¿™æ ·çš„ï¼š

- æ–°çš„ chunk æ˜¯å¦è¢«å…±äº«æˆ–è€…æ˜¯æ¥è‡ª node_modules çš„æ¨¡å—
- æ–°çš„ chunk ä½“ç§¯åœ¨å‹ç¼©ä¹‹å‰æ˜¯å¦å¤§äº 30kb
- æŒ‰éœ€åŠ è½½ chunk çš„å¹¶å‘è¯·æ±‚æ•°é‡å°äºç­‰äº 5 ä¸ª
- é¡µé¢åˆå§‹åŠ è½½æ—¶çš„å¹¶å‘è¯·æ±‚æ•°é‡å°äºç­‰äº 3 ä¸ª

å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„é¡¹ç›®ç¯å¢ƒæ¥æ›´æ”¹é…ç½®ã€‚é…ç½®ä»£ç å¦‚ä¸‹ï¼š

```php
splitChunks({
  cacheGroups: {
    vendors: {
      name: `chunk-vendors`,
      test: /[\\/]node_modules[\\/]/,
      priority: -10,
      chunks: 'initial',
    },
    dll: {
      name: `chunk-dll`,
      test: /[\\/]bizcharts|[\\/]\@antv[\\/]data-set/,
      priority: 15,
      chunks: 'all',
      reuseExistingChunk: true
    },
    common: {
      name: `chunk-common`,
      minChunks: 2,
      priority: -20,
      chunks: 'all',
      reuseExistingChunk: true
    },
  }
})
å¤åˆ¶ä»£ç 
å¤åˆ¶ä»£ç 
```

æ²¡æœ‰ä½¿ç”¨webpack4.xç‰ˆæœ¬çš„é¡¹ç›®ï¼Œä¾ç„¶å¯ä»¥é€šè¿‡**æŒ‰éœ€åŠ è½½**çš„å½¢å¼è¿›è¡Œåˆ†åŒ…ï¼Œä½¿å¾—æˆ‘ä»¬çš„åŒ…åˆ†æ•£å¼€ï¼Œæå‡åŠ è½½æ€§èƒ½ã€‚

æŒ‰éœ€åŠ è½½ä¹Ÿæ˜¯ä»¥å‰åˆ†åŒ…çš„é‡è¦æ‰‹æ®µä¹‹ä¸€

è¿™é‡Œæ¨èä¸€ç¯‡éå¸¸å¥½çš„æ–‡ç« ï¼š[webpackå¦‚ä½•ä½¿ç”¨æŒ‰éœ€åŠ è½½](https://juejin.im/post/6844903718387875847)

### 3.3 æ‹†åŒ…

ä¸3.2çš„åˆ†åŒ…ä¸åŒã€‚å¤§å®¶å¯èƒ½æ²¡å‘ç°ï¼Œä¸Šé¢2.3çš„bundleåŒ…è§£æä¸­æœ‰ä¸ªæœ‰è¶£çš„ç°è±¡ï¼Œä¸Šé¢é¡¹ç›®çš„æŠ€æœ¯æ ˆæ˜¯reactï¼Œä½†æ˜¯bundleåŒ…ä¸­å¹¶æ²¡æœ‰reactã€react-domã€react-routerç­‰ã€‚

å› ä¸ºæŠŠè¿™äº›æ’ä»¶â€œæ‹†â€å¼€äº†ã€‚å¹¶æ²¡æœ‰ä¸€èµ·æ‰“åœ¨bundleä¸­ã€‚è€Œæ˜¯æ”¾åœ¨äº†CDNä¸Šã€‚ä¸‹é¢æˆ‘ä¸¾ä¸€ä¸ªä¾‹å­æ¥è§£é‡Šä¸€ä¸‹ã€‚

å‡è®¾ï¼šåŸæœ¬bundleåŒ…ä¸º2Mï¼Œä¸€æ¬¡è¯·æ±‚æ‹‰å–ã€‚æ‹†åˆ†ä¸º bundleï¼ˆ1Mï¼‰ + reactæ¡¶ï¼ˆCDNï¼‰ï¼ˆ1Mï¼‰ ä¸¤æ¬¡è¯·æ±‚å¹¶å‘æ‹‰å–ã€‚

ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œ1+1çš„æ¨¡å¼æ‹‰å–èµ„æºæ›´å¿«ã€‚

æ¢ä¸€ä¸ªè§’åº¦æ¥è¯´ï¼Œå…¨é‡éƒ¨ç½²é¡¹ç›®çš„æƒ…å†µï¼Œæ¯æ¬¡éƒ¨ç½²bundleåŒ…éƒ½å°†é‡æ–°æ‹‰å–ã€‚æ¯”è¾ƒæµªè´¹èµ„æºã€‚reactæ¡¶çš„æ–¹å¼å¯ä»¥å‘½ä¸­å¼ºç¼“å­˜ï¼Œè¿™æ ·çš„åŒ–ï¼Œå°±ç®—å…¨é‡éƒ¨ç½²ä¹Ÿåªéœ€è¦é‡æ–°æ‹‰å–å·¦ä¾§1Mçš„bundleåŒ…å³å¯ï¼ŒèŠ‚çœäº†æœåŠ¡å™¨èµ„æºã€‚ä¼˜åŒ–äº†åŠ è½½é€Ÿåº¦ã€‚

æ³¨æ„ï¼šåœ¨æœ¬åœ°å¼€å‘è¿‡ç¨‹ä¸­ï¼Œreactç­‰èµ„æºå»ºè®®ä¸è¦å¼•å…¥CDNï¼Œå¼€å‘è¿‡ç¨‹ä¸­åˆ·æ–°é¢‘ç¹ï¼Œä¼šå¢åŠ CDNæœåŠ¡å…¶å‹åŠ›ï¼Œèµ°æœ¬åœ°å°±å¥½ã€‚

### 3.4 gzip

æœåŠ¡ç«¯é…ç½®gzipå‹ç¼©åå¯å¤§å¤§ç¼©å‡èµ„æºå¤§å°ã€‚

Nginxé…ç½®æ–¹å¼

```ini
http {
  gzip on;
  gzip_buffers 32 4K;
  gzip_comp_level 6;
  gzip_min_length 100;
  gzip_types application/javascript text/css text/xml;
  gzip_disable "MSIE [1-6]\.";
  gzip_vary on;
}
å¤åˆ¶ä»£ç 
å¤åˆ¶ä»£ç 
```

é…ç½®å®Œæˆååœ¨response headerä¸­å¯ä»¥æŸ¥çœ‹ã€‚ ![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47900b771d2449628ad7a5f83f95d64c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

### 3.5 å›¾ç‰‡å‹ç¼©

å¼€å‘ä¸­æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªç¯èŠ‚ï¼Œæˆ‘å¸è‡ªå·±çš„å›¾åºŠå·¥å…·æ˜¯è‡ªå¸¦å‹ç¼©åŠŸèƒ½çš„ï¼Œå‹ç¼©åç›´æ¥ä¸Šä¼ åˆ°CDNä¸Šã€‚

å¦‚æœå…¬å¸æ²¡æœ‰å›¾åºŠå·¥å…·ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å‹ç¼©å›¾ç‰‡å‘¢ï¼Ÿæˆ‘æ¨èå‡ ç§æˆ‘å¸¸ç”¨çš„æ–¹å¼

- [æ™ºå›¾å‹ç¼©](https://link.juejin.cn?target=https%3A%2F%2Fzhitu.isux.us%2F) (ç™¾åº¦å¾ˆéš¾æœåˆ°å®˜ç½‘äº†ï¼Œå…è´¹ã€æ‰¹é‡ã€å¥½ç”¨)
- [tinypng](https://link.juejin.cn?target=https%3A%2F%2Ftinypng.com%2F)(å…è´¹ã€æ‰¹é‡ã€é€Ÿåº¦å—)
- fireworkså·¥å…·å‹ç¼©åƒç´ ç‚¹å’Œå°ºå¯¸ (è‡ªå·±åŠ¨æ‰‹ï¼ŒæŒæ¡å°ºåº¦)
- æ‰¾UIå‹ç¼©åå‘ç»™ä½ 

å›¾ç‰‡å‹ç¼©æ˜¯å¸¸ç”¨çš„æ‰‹æ³•ï¼Œå› ä¸ºè®¾å¤‡åƒç´ ç‚¹çš„å…³ç³»ï¼ŒUIç»™äºˆçš„å›¾ç‰‡ä¸€èˆ¬éƒ½æ˜¯ x2ï¼Œx4çš„ï¼Œæ‰€ä»¥å‹ç¼©å°±éå¸¸æœ‰å¿…è¦ã€‚

### 3.6 å›¾ç‰‡åˆ†å‰²

å¦‚æœé¡µé¢ä¸­æœ‰ä¸€å¼ æ•ˆæœå›¾ï¼Œæ¯”å¦‚çœŸæœºæ¸²æŸ“å›¾ï¼ŒUIæ‰‹æ‹¿ç€åˆ€ä¸è®©ä½ å‹ç¼©ã€‚è¿™æ—¶å€™ä¸å¦¨è€ƒè™‘ä¸€ä¸‹åˆ†å‰²å›¾ç‰‡ã€‚

å»ºè®®å•å¼ åœŸå›¾ç‰‡çš„å¤§å°ä¸è¦è¶…è¿‡100kï¼Œæˆ‘ä»¬åœ¨åˆ†å‰²å®Œå›¾ç‰‡åï¼Œé€šè¿‡å¸ƒå±€å†æ‹¼æ¥åœ¨ä¸€èµ·ã€‚å¯ä»¥å›¾ç‰‡åŠ è½½æ•ˆç‡ã€‚

è¿™é‡Œæ³¨æ„ä¸€ç‚¹ï¼Œåˆ†å‰²åçš„æ¯å¼ å›¾ç‰‡ä¸€å®šè¦ç»™heightï¼Œå¦åˆ™ç½‘é€Ÿæ…¢çš„æƒ…å†µä¸‹æ ·å¼ä¼šå¡Œé™·ã€‚

### 3.7 sprite

å—æ–¹å«ç²¾çµå›¾ï¼ŒåŒ—æ–¹å«é›ªç¢§å›¾ã€‚è¿™ä¸ªç°è±¡å°±å¾ˆæœ‰è¶£ã€‚

åœ¨ç½‘ç«™ä¸­æœ‰å¾ˆå¤šå°å›¾ç‰‡çš„æ—¶å€™ï¼Œä¸€å®šè¦æŠŠè¿™äº›å°å›¾ç‰‡åˆå¹¶ä¸ºä¸€å¼ å¤§çš„å›¾ç‰‡ï¼Œç„¶åé€šè¿‡backgroundåˆ†å‰²åˆ°éœ€è¦å±•ç¤ºçš„å›¾ç‰‡ã€‚

è¿™æ ·çš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…ˆæ¥æ™®åŠä¸€ä¸ªè§„åˆ™

æµè§ˆå™¨è¯·æ±‚èµ„æºçš„æ—¶å€™ï¼ŒåŒæºåŸŸåè¯·æ±‚èµ„æºçš„æ—¶å€™æœ‰æœ€å¤§å¹¶å‘é™åˆ¶ï¼Œchromeä¸º6ä¸ªï¼Œå°±æ¯”å¦‚ä½ çš„é¡µé¢ä¸Šæœ‰10ä¸ªç›¸åŒCDNåŸŸåå°å›¾ç‰‡ï¼Œé‚£ä¹ˆéœ€è¦å‘èµ·10æ¬¡è¯·æ±‚å»æ‹‰å–ï¼Œåˆ†ä¸¤æ¬¡å¹¶å‘ã€‚ç¬¬ä¸€æ¬¡å¹¶å‘è¯·æ±‚å›æ¥åï¼Œå‘èµ·ç¬¬äºŒæ¬¡å¹¶å‘ã€‚

å¦‚æœä½ æŠŠ10ä¸ªå°å›¾ç‰‡åˆå¹¶ä¸ºä¸€å¼ å¤§å›¾ç‰‡çš„ç”»ï¼Œé‚£ä¹ˆåªç”¨ä¸€æ¬¡è¯·æ±‚å³å¯æ‹‰å–ä¸‹æ¥10ä¸ªå°å›¾ç‰‡çš„èµ„æºã€‚å‡å°‘æœåŠ¡å™¨å‹åŠ›ï¼Œå‡å°‘å¹¶å‘ï¼Œå‡å°‘è¯·æ±‚æ¬¡æ•°ã€‚

é™„ä¸Šä¸€ä¸ªspriteçš„ä¾‹å­ã€‚

![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f42fbdef05c34d5ca1c1a3e3b0515ec5~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

### 3.8 CDN

ä¸­æ–‡ï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰ï¼ŒæœåŠ¡å™¨æ˜¯ä¸­å¿ƒåŒ–çš„ï¼ŒCDNæ˜¯â€œå»ä¸­å¿ƒåŒ–çš„â€ã€‚

åœ¨é¡¹ç›®ä¸­æœ‰å¾ˆå¤šä¸œè¥¿éƒ½æ˜¯æ”¾åœ¨CDNä¸Šçš„ï¼Œæ¯”å¦‚ï¼šé™æ€æ–‡ä»¶ï¼ŒéŸ³é¢‘ï¼Œè§†é¢‘ï¼Œjsèµ„æºï¼Œå›¾ç‰‡ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆç”¨CDNä¼šè®©èµ„æºåŠ è½½å˜å¿«å‘¢ï¼Ÿ

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š

> ä»¥å‰ä¹°ç«è½¦ç¥¨å¤§å®¶éƒ½åªèƒ½å»ç«è½¦ç«™ä¹°ï¼Œåæ¥æˆ‘ä»¬ä¹°ç«è½¦ç¥¨å°±å¯ä»¥åœ¨æ¥¼ä¸‹çš„ç«è½¦ç¥¨ä»£å”®ç‚¹ä¹°äº†ã€‚

ä½ ç»†å“ã€‚

æ‰€ä»¥é™æ€èµ„æºåº¦å»ºè®®æ”¾åœ¨CDNä¸Šï¼Œå¯ä»¥åŠ å¿«èµ„æºåŠ è½½çš„é€Ÿåº¦ã€‚

### 3.9 æ‡’åŠ è½½

æ‡’åŠ è½½ä¹Ÿå«å»¶è¿ŸåŠ è½½ï¼ŒæŒ‡çš„æ˜¯åœ¨é•¿ç½‘é¡µä¸­å»¶è¿ŸåŠ è½½å›¾åƒï¼Œæ˜¯ä¸€ç§éå¸¸å¥½çš„ä¼˜åŒ–ç½‘é¡µæ€§èƒ½çš„æ–¹å¼ã€‚

å½“å¯è§†åŒºåŸŸæ²¡æœ‰æ»šåˆ°èµ„æºéœ€è¦åŠ è½½çš„åœ°æ–¹æ—¶å€™ï¼Œå¯è§†åŒºåŸŸå¤–çš„èµ„æºå°±ä¸ä¼šåŠ è½½ã€‚

å¯ä»¥å‡å°‘æœåŠ¡å™¨è´Ÿè½½ï¼Œå¸¸é€‚ç”¨äºå›¾ç‰‡å¾ˆå¤šï¼Œé¡µé¢è¾ƒé•¿çš„ä¸šåŠ¡åœºæ™¯ä¸­ã€‚

å¦‚ä½•ä½¿ç”¨æ‡’åŠ è½½å‘¢ï¼Ÿ

- [å›¾ç‰‡æ‡’åŠ è½½](https://juejin.im/post/6844903688390049800)
- [layzr.js](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcallmecavs%2Flayzr.js)

### 3.10 iconfont

ä¸­æ–‡ï¼ˆå­—ä½“å›¾è¡¨ï¼‰ï¼Œç°åœ¨æ¯”è¾ƒæµè¡Œçš„ä¸€ç§ç”¨æ³•ã€‚ä½¿ç”¨å­—ä½“å›¾è¡¨æœ‰å‡ ç§å¥½å¤„

- çŸ¢é‡
- è½»é‡
- æ˜“ä¿®æ”¹
- ä¸å ç”¨å›¾ç‰‡èµ„æºè¯·æ±‚ã€‚

å°±åƒä¸Šé¢è¯´çš„é›ªç¢§å›¾ï¼Œå¦‚æœéƒ½ç”¨å­—ä½“å›¾æ ‡æ¥æ›¿æ¢çš„ç”»ï¼Œä¸€æ¬¡è¯·æ±‚éƒ½å…äº†ï¼Œå¯ä»¥ç›´æ¥æ‰“åˆ°bundleåŒ…ä¸­ã€‚

ä½¿ç”¨å‰ææ˜¯UIç»™ç‚¹åŠ›ï¼Œè®¾è®¡è¶‹å‘äºå­—ä½“å›¾æ ‡ï¼Œæå‰ç»™å¥½èµ„æºï¼Œå»ºç«‹å¥½å­—ä½“å›¾æ ‡åº“ã€‚

### 3.11 é€»è¾‘åç§»

é€»è¾‘åç§»æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§çš„ä¼˜åŒ–æ‰‹æ®µã€‚ç”¨ä¸€ä¸ªæ‰“å¼€æ–‡ç« ç½‘ç«™çš„æ“ä½œæ¥ä¸¾ä¸ªä¾‹å­ã€‚

æ²¡æœ‰é€»è¾‘åç§»å¤„ç†çš„è¯·æ±‚é¡ºåºæ˜¯è¿™ä¸ªæ ·å­çš„

![img](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/46f8e43dbe2345af85aa232e59a79fc1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

é¡µé¢çš„å±•ç¤ºä¸»ä½“æ˜¯æ–‡ç« å±•ç¤ºï¼Œå¦‚æœæ–‡ç« å±•ç¤ºçš„è¯·æ±‚é åäº†ï¼Œé‚£ä¹ˆæ¸²æŸ“æ–‡ç« å‡ºæ¥çš„æ—¶é—´å¿…ç„¶é åï¼Œå› ä¸ºæœ‰å¯èƒ½å› ä¸ºè¯·æ±‚é˜»å¡ç­‰æƒ…å†µï¼Œå½±å“è¯·æ±‚å“åº”æƒ…å†µï¼Œå¦‚æœè¶…è¿‡ä¸€æ¬¡å¹¶å‘çš„æƒ…å†µçš„è¯ï¼Œä¼šæ›´åŠ çš„æ…¢ã€‚å¦‚å›¾çš„è¿™ç§æƒ…å†µä¹Ÿæ˜¯åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­å‘ç”Ÿè¿‡çš„ã€‚

å¾ˆæ˜æ˜¾æˆ‘ä»¬åº”è¯¥æŠŠä¸»ä½“â€œè¯·æ±‚æ–‡ç« â€æ¥å£å‰ç§»ï¼ŒæŠŠä¸€äº›éä¸»ä½“çš„è¯·æ±‚é€»è¾‘åç§»ã€‚è¿™æ ·çš„è¯å¯ä»¥å°½å¿«çš„æŠŠä¸»ä½“æ¸²æŸ“å‡ºæ¥ï¼Œå°±ä¼šå¿«å¾ˆå¤šã€‚

ä¼˜åŒ–åçš„é¡ºåºæ˜¯è¿™ä¸ªæ ·å­çš„ã€‚

![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d161a61ec94d42ed9b48cf3b00eb12fa~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

åœ¨å¹³å¸¸çš„å¼€å‘ä¸­å»ºè®®æ—¶å¸¸æ³¨æ„é€»è¾‘åç§»çš„æƒ…å†µï¼Œçªå‡ºä¸»ä½“é€»è¾‘ã€‚å¯ä»¥æå¤§çš„æå‡ç”¨æˆ·ä½“éªŒã€‚

### 3.12 ç®—æ³•å¤æ‚åº¦

åœ¨æ•°æ®é‡å¤§çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œéœ€è¦ç€é‡æ³¨æ„ç®—æ³•å¤æ‚åº¦é—®é¢˜ã€‚

åœ¨è¿™ä¸ªæ–¹é¢å¯ä»¥å‚è€ƒ[Javascriptç®—æ³•ä¹‹å¤æ‚åº¦åˆ†æ](https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2Fffbb25380904)è¿™ç¯‡æ–‡ç« ã€‚

å¦‚ä¸Šé¢Performanceè§£æå‡ºçš„Javascriptæ‰§è¡ŒæŒ‡æ ‡ä¸Šï¼Œå¯ä»¥æ¨æµ‹å‡ºæ¥ä½ çš„codeæ‰§è¡Œæ•ˆç‡å¦‚ä½•ï¼Œå¦‚æœæ‰§è¡Œæ—¶é—´è¿‡é•¿å°±è¦è€ƒè™‘ä¸€ä¸‹æ˜¯å¦è¦ä¼˜åŒ–ä¸€ä¸‹å¤æ‚åº¦äº†ã€‚

> åœ¨æ—¶é—´æ¢ç©ºé—´ï¼Œç©ºé—´æ¢æ—¶é—´çš„é€‰æ‹©ä¸Šï¼Œè¦æ ¹æ®ä¸šåŠ¡åœºæ™¯æ¥è¿›è¡Œå–èˆã€‚

### 3.13 ç»„ä»¶æ¸²æŸ“

æ‹¿reactä¸¾ä¾‹ï¼Œç»„ä»¶åˆ†å‰²æ–¹é¢ä¸è¦å¤ªæ·±ã€‚éœ€è¦æ§åˆ¶ç»„ä»¶çš„æ¸²æŸ“ï¼Œå°¤å…¶æ˜¯æ·±å±‚ç»„ä»¶çš„renderã€‚

è€ç”Ÿå¸¸è°ˆçš„è¯é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€äº›æ–¹å¼æ¥ä¼˜åŒ–ç»„ä»¶æ¸²æŸ“

- å£°æ˜å‘¨æœŸæ§åˆ¶ - æ¯”å¦‚reactçš„shouldComponentUpdateæ¥æ§åˆ¶ç»„ä»¶æ¸²æŸ“ã€‚
- å®˜ç½‘æä¾›çš„api- PureComponent
- æ§åˆ¶æ³¨å…¥ç»„ä»¶çš„å‚æ•°
- åˆ†é…ç»„ä»¶å”¯ä¸€key

æ²¡æœ‰å¿…è¦çš„æ¸²æŸ“æ˜¯å¯¹æ€§èƒ½çš„æå¤§æµªè´¹ã€‚

### 3.14 node middleware

ä¸­æ–‡ï¼ˆnode ä¸­é—´ä»¶ï¼‰

ä¸­é—´ä»¶ä¸»è¦æ˜¯æŒ‡å°è£…æ‰€æœ‰Httpè¯·æ±‚ç»†èŠ‚å¤„ç†çš„æ–¹æ³•ã€‚ä¸€æ¬¡Httpè¯·æ±‚é€šå¸¸åŒ…å«å¾ˆå¤šå·¥ä½œï¼Œå¦‚è®°å½•æ—¥å¿—ã€ipè¿‡æ»¤ã€æŸ¥è¯¢å­—ç¬¦ä¸²ã€è¯·æ±‚ä½“è§£æã€Cookieå¤„ç†ã€æƒé™éªŒè¯ã€å‚æ•°éªŒè¯ã€å¼‚å¸¸å¤„ç†ç­‰ï¼Œä½†å¯¹äºWebåº”ç”¨è€Œè¨€ï¼Œå¹¶ä¸å¸Œæœ›æ¥è§¦åˆ°è¿™ä¹ˆå¤šç»†èŠ‚æ€§çš„å¤„ç†ï¼Œå› æ­¤å¼•å…¥ä¸­é—´ä»¶æ¥ç®€åŒ–å’Œéš”ç¦»è¿™äº›åŸºç¡€è®¾æ–½ä¸ä¸šåŠ¡é€»è¾‘ä¹‹é—´çš„ç»†èŠ‚ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿå…³æ³¨åœ¨ä¸šåŠ¡çš„å¼€å‘ä¸Šï¼Œä»¥è¾¾åˆ°æå‡å¼€å‘æ•ˆç‡çš„ç›®çš„ã€‚

ä½¿ç”¨node middlewareåˆå¹¶è¯·æ±‚ã€‚å‡å°‘è¯·æ±‚æ¬¡æ•°ã€‚è¿™ç§æ–¹å¼ä¹Ÿæ˜¯éå¸¸å®ç”¨çš„ã€‚

### 3.15 web worker

Web Worker çš„ä½œç”¨ï¼Œå°±æ˜¯ä¸º JavaScript åˆ›é€ å¤šçº¿ç¨‹ç¯å¢ƒï¼Œå…è®¸ä¸»çº¿ç¨‹åˆ›å»º Worker çº¿ç¨‹ï¼Œå°†ä¸€äº›ä»»åŠ¡åˆ†é…ç»™åè€…è¿è¡Œã€‚åœ¨ä¸»çº¿ç¨‹è¿è¡Œçš„åŒæ—¶ï¼ŒWorker çº¿ç¨‹åœ¨åå°è¿è¡Œï¼Œä¸¤è€…äº’ä¸å¹²æ‰°ã€‚ç­‰åˆ° Worker çº¿ç¨‹å®Œæˆè®¡ç®—ä»»åŠ¡ï¼Œå†æŠŠç»“æœè¿”å›ç»™ä¸»çº¿ç¨‹ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œä¸€äº›è®¡ç®—å¯†é›†å‹æˆ–é«˜å»¶è¿Ÿçš„ä»»åŠ¡ï¼Œè¢« Worker çº¿ç¨‹è´Ÿæ‹…äº†ï¼Œä¸»çº¿ç¨‹ï¼ˆé€šå¸¸è´Ÿè´£ UI äº¤äº’ï¼‰å°±ä¼šå¾ˆæµç•…ï¼Œä¸ä¼šè¢«é˜»å¡æˆ–æ‹–æ…¢ã€‚

åˆç†å®ç”¨web workerå¯ä»¥ä¼˜åŒ–å¤æ‚è®¡ç®—ä»»åŠ¡ã€‚è¿™é‡Œç›´æ¥æŠ›é˜®ä¸€å³°çš„å…¥é—¨æ–‡ç« ï¼š[ä¼ é€é—¨](https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2018%2F07%2Fweb-worker.html)

### 3.16 ç¼“å­˜

ç¼“å­˜çš„åŸç†å°±æ˜¯æ›´å¿«è¯»å†™çš„å­˜å‚¨ä»‹è´¨+å‡å°‘IO+å‡å°‘CPUè®¡ç®—=æ€§èƒ½ä¼˜åŒ–ã€‚è€Œæ€§èƒ½ä¼˜åŒ–çš„ç¬¬ä¸€å®šå¾‹å°±æ˜¯ï¼šä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ç¼“å­˜ã€‚

ç¼“å­˜çš„ä¸»è¦æ‰‹æ®µæœ‰ï¼šæµè§ˆå™¨ç¼“å­˜ã€CDNã€åå‘ä»£ç†ã€æœ¬åœ°ç¼“å­˜ã€åˆ†å¸ƒå¼ç¼“å­˜ã€æ•°æ®åº“ç¼“å­˜ã€‚

### 3.17 GPUæ¸²æŸ“

æ¯ä¸ªç½‘é¡µæˆ–å¤šæˆ–å°‘éƒ½æ¶‰åŠåˆ°ä¸€äº›CSSåŠ¨ç”»ï¼Œé€šå¸¸ç®€å•çš„åŠ¨ç”»å¯¹äºæ€§èƒ½çš„å½±å“å¾®ä¹å…¶å¾®ï¼Œç„¶è€Œå¦‚æœæ¶‰åŠåˆ°ç¨æ˜¾å¤æ‚çš„åŠ¨ç”»ï¼Œä¸å½“çš„å¤„ç†æ–¹å¼ä¼šä½¿æ€§èƒ½é—®é¢˜å˜å¾—ååˆ†çªå‡ºã€‚

åƒChrome, FireFox, Safari, IE9+å’Œæœ€æ–°ç‰ˆæœ¬çš„Operaéƒ½æ”¯æŒGPUåŠ é€Ÿï¼Œå½“å®ƒä»¬æ£€æµ‹åˆ°é¡µé¢ä¸­æŸä¸ªDOMå…ƒç´ åº”ç”¨äº†æŸäº›CSSè§„åˆ™æ—¶å°±ä¼šå¼€å¯ã€‚

è™½ç„¶æˆ‘ä»¬å¯èƒ½ä¸æƒ³å¯¹å…ƒç´ åº”ç”¨3Då˜æ¢ï¼Œå¯æˆ‘ä»¬ä¸€æ ·å¯ä»¥å¼€å¯3Då¼•æ“ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ç”¨`transform: translateZ(0)` æ¥å¼€å¯GPUåŠ é€Ÿ ã€‚

åªå¯¹æˆ‘ä»¬éœ€è¦å®ç°åŠ¨ç”»æ•ˆæœçš„å…ƒç´ åº”ç”¨ä»¥ä¸Šæ–¹æ³•ï¼Œå¦‚æœä»…ä»…ä¸ºäº†å¼€å¯ç¡¬ä»¶åŠ é€Ÿè€Œéšä¾¿ä¹±ç”¨ï¼Œé‚£æ˜¯ä¸åˆç†çš„ã€‚

### 3.18 Ajaxå¯ç¼“å­˜

Ajaxåœ¨å‘é€çš„æ•°æ®æˆåŠŸåï¼Œä¸ºäº†æé«˜é¡µé¢çš„å“åº”é€Ÿåº¦å’Œç”¨æˆ·ä½“éªŒï¼Œä¼šæŠŠè¯·æ±‚çš„URLå’Œè¿”å›çš„å“åº”ç»“æœä¿å­˜åœ¨ç¼“å­˜å†…ï¼Œå½“ä¸‹ä¸€æ¬¡è°ƒç”¨Ajaxå‘é€ç›¸åŒçš„è¯·æ±‚ï¼ˆURLå’Œå‚æ•°å®Œå…¨ç›¸åŒï¼‰æ—¶ï¼Œå®ƒå°±ä¼šç›´æ¥ä»ç¼“å­˜ä¸­æ‹¿æ•°æ®ã€‚

åœ¨è¿›è¡ŒAjaxè¯·æ±‚çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©å°½é‡ä½¿ç”¨getæ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥ä½¿ç”¨å®¢æˆ·ç«¯çš„ç¼“å­˜ï¼Œæé«˜è¯·æ±‚é€Ÿåº¦ã€‚

### 3.19 Resource Hints

Resource Hints(èµ„æºé¢„åŠ è½½)æ˜¯éå¸¸å¥½çš„ä¸€ç§æ€§èƒ½ä¼˜åŒ–æ–¹æ³•ï¼Œå¯ä»¥å¤§å¤§é™ä½é¡µé¢åŠ è½½æ—¶é—´ï¼Œç»™ç”¨æˆ·æ›´åŠ æµç•…çš„ç”¨æˆ·ä½“éªŒã€‚

ç°ä»£æµè§ˆå™¨ä½¿ç”¨å¤§é‡é¢„æµ‹ä¼˜åŒ–æŠ€æœ¯æ¥é¢„æµ‹ç”¨æˆ·è¡Œä¸ºå’Œæ„å›¾ï¼Œè¿™äº›æŠ€æœ¯æœ‰é¢„è¿æ¥ã€èµ„æºä¸è·å–ã€èµ„æºé¢„æ¸²æŸ“ç­‰ã€‚

Resource Hints çš„æ€è·¯æœ‰å¦‚ä¸‹ä¸¤ä¸ªï¼š

- å½“å‰å°†è¦è·å–èµ„æºçš„åˆ—è¡¨
- é€šè¿‡å½“å‰é¡µé¢æˆ–åº”ç”¨çš„çŠ¶æ€ã€ç”¨æˆ·å†å²è¡Œä¸ºæˆ– session é¢„æµ‹ç”¨æˆ·è¡Œä¸ºåŠå¿…éœ€çš„èµ„æº

å®ç°Resource Hintsçš„æ–¹æ³•æœ‰å¾ˆå¤šç§ï¼Œå¯åˆ†ä¸ºåŸºäº link æ ‡ç­¾çš„ DNS-prefetchã€subresourceã€preloadã€ prefetchã€preconnectã€prerenderï¼Œå’Œæœ¬åœ°å­˜å‚¨ localStorageã€‚

### 3.20 SSR

æ¸²æŸ“è¿‡ç¨‹åœ¨æœåŠ¡å™¨ç«¯å®Œæˆï¼Œæœ€ç»ˆçš„æ¸²æŸ“ç»“æœ HTML é¡µé¢é€šè¿‡ HTTP åè®®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œåˆè¢«è®¤ä¸ºæ˜¯â€˜åŒæ„'æˆ–â€˜é€šç”¨'ï¼Œå¦‚æœä½ çš„é¡¹ç›®æœ‰å¤§é‡çš„detailé¡µé¢ï¼Œç›¸äº’ç‰¹åˆ«é¢‘ç¹ï¼Œå»ºè®®é€‰æ‹©æœåŠ¡ç«¯æ¸²æŸ“ã€‚

æœåŠ¡ç«¯æ¸²æŸ“(SSR)é™¤äº†SEOè¿˜æœ‰å¾ˆå¤šæ—¶å€™ç”¨ä½œé¦–å±ä¼˜åŒ–ï¼ŒåŠ å¿«é¦–å±é€Ÿåº¦ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚ä½†æ˜¯å¯¹æœåŠ¡å™¨æœ‰è¦æ±‚ï¼Œç½‘ç»œä¼ è¾“æ•°æ®é‡å¤§ï¼Œå ç”¨éƒ¨åˆ†æœåŠ¡å™¨è¿ç®—èµ„æºã€‚

Vueçš„Nuxt.jså’ŒReactçš„next.jséƒ½æ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„æ–¹æ³•ã€‚

### 3.21 UNPKG

UNPKGæ˜¯ä¸€ä¸ªæä¾›npmåŒ…è¿›è¡ŒCDNåŠ é€Ÿçš„ç«™ç‚¹ï¼Œå› æ­¤ï¼Œå¯ä»¥å°†ä¸€äº›æ¯”è¾ƒå›ºå®šäº†ä¾èµ–å†™å…¥htmlæ¨¡ç‰ˆä¸­ï¼Œä»è€Œæé«˜ç½‘é¡µçš„æ€§èƒ½ã€‚é¦–å…ˆï¼Œéœ€è¦å°†è¿™äº›ä¾èµ–å£°æ˜ä¸ºexternalï¼Œä»¥ä¾¿webpackæ‰“åŒ…æ—¶ä¸ä»node_modulesä¸­åŠ è½½è¿™äº›èµ„æºï¼Œé…ç½®å¦‚ä¸‹ï¼š

```css
externals: { 'react': 'React' }
å¤åˆ¶ä»£ç 
```

å…¶æ¬¡ï¼Œä½ éœ€è¦å°†æ‰€ä¾èµ–çš„èµ„æºå†™åœ¨htmlæ¨¡ç‰ˆä¸­ï¼Œè¿™ä¸€æ­¥éœ€è¦ç”¨åˆ°[html-webpack-plugin](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fjantimon%2Fhtml-webpack-plugin)ã€‚ä¸‹é¢æ˜¯ä¸€æ®µç¤ºä¾‹ï¼š

```javascript
<% if (htmlWebpackPlugin.options.node_env === 'development') { %>
  <script src="https://unpkg.com/react@16.7.0/umd/react.development.js"></script>
<% } else { %>
  <script src="https://unpkg.com/react@16.7.0/umd/react.production.min.js"></script>
<% } %>
å¤åˆ¶ä»£ç 
```

è¿™æ®µä»£ç éœ€è¦æ³¨å…¥node_envï¼Œä»¥ä¾¿åœ¨å¼€å‘çš„æ—¶å€™èƒ½å¤Ÿè·å¾—æ›´å‹å¥½çš„é”™è¯¯æç¤ºã€‚ä¹Ÿå¯ä»¥é€‰æ‹©ä¸€äº›æ¯”è¾ƒè‡ªåŠ¨çš„åº“ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆè¿™ä¸ªè¿‡ç¨‹ï¼Œæ¯”å¦‚[webpack-cdn-plugin](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fwebpack-cdn-plugin)ï¼Œæˆ–è€…[dynamic-cdn-webpack-plugin](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fmastilver%2Fdynamic-cdn-webpack-plugin)ã€‚

### 3.22 åŸŸåå‘æ•£ä¸æ”¶æ•›

æµè§ˆå™¨æœ‰å¹¶å‘é™åˆ¶ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢DDoSæ”»å‡»ã€‚

> åˆ†å¸ƒå¼æ‹’ç»æœåŠ¡æ”»å‡»DDoSæ˜¯ä¸€ç§åŸºäºDoSçš„ç‰¹æ®Šå½¢å¼çš„æ‹’ç»æœåŠ¡æ”»å‡»ï¼Œæ˜¯ä¸€ç§åˆ†å¸ƒçš„ã€ååŒçš„å¤§è§„æ¨¡æ”»å‡»æ–¹å¼ã€‚å•ä¸€çš„DoSæ”»å‡»ä¸€èˆ¬æ˜¯é‡‡ç”¨ä¸€å¯¹ä¸€æ–¹å¼çš„ï¼Œå®ƒåˆ©ç”¨ç½‘ç»œåè®®å’Œæ“ä½œç³»ç»Ÿçš„ä¸€äº›ç¼ºé™·ï¼Œé‡‡ç”¨æ¬ºéª—å’Œä¼ªè£…çš„ç­–ç•¥æ¥è¿›è¡Œç½‘ç»œæ”»å‡»ï¼Œä½¿ç½‘ç«™æœåŠ¡å™¨å……æ–¥å¤§é‡è¦æ±‚å›å¤çš„ä¿¡æ¯ï¼Œæ¶ˆè€—ç½‘ç»œå¸¦å®½æˆ–ç³»ç»Ÿèµ„æºï¼Œå¯¼è‡´ç½‘ç»œæˆ–ç³»ç»Ÿä¸èƒœè´Ÿè·ä»¥è‡³äºç˜«ç—ªè€Œåœæ­¢æä¾›æ­£å¸¸çš„ç½‘ç»œæœåŠ¡ã€‚ä¸DoSæ”»å‡»ç”±å•å°ä¸»æœºå‘èµ·æ”»å‡»ç›¸æ¯”è¾ƒï¼Œåˆ†å¸ƒå¼æ‹’ç»æœåŠ¡æ”»å‡»DDoSæ˜¯å€ŸåŠ©æ•°ç™¾ã€ç”šè‡³æ•°åƒå°è¢«å…¥ä¾µåå®‰è£…äº†æ”»å‡»è¿›ç¨‹çš„ä¸»æœºåŒæ—¶å‘èµ·çš„é›†å›¢è¡Œä¸ºã€‚

åŸŸåæ”¶æ•›ï¼šå°±æ˜¯å°†é™æ€èµ„æºæ”¾åœ¨ä¸€ä¸ªåŸŸåä¸‹ï¼Œå‡å°‘DNSè§£æçš„å¼€é”€ã€‚

åŸŸåå‘æ•£ï¼šæ˜¯å°†é™æ€èµ„æºæ”¾åœ¨å¤šä¸ªå­åŸŸåä¸‹ï¼Œå°±å¯ä»¥å¤šçº¿ç¨‹ä¸‹è½½ï¼Œæé«˜å¹¶è¡Œåº¦ï¼Œä½¿å®¢æˆ·ç«¯åŠ è½½é™æ€èµ„æºæ›´åŠ è¿…é€Ÿã€‚

åŸŸåå‘æ•£æ˜¯PCç«¯ä¸ºäº†åˆ©ç”¨æµè§ˆå™¨çš„å¤šçº¿ç¨‹å¹¶è¡Œä¸‹è½½èƒ½åŠ›ã€‚

è€ŒåŸŸåæ”¶æ•›å¤šç”¨ä¸ç§»åŠ¨ç«¯ï¼Œæé«˜æ€§èƒ½ï¼Œå› ä¸ºdnsè§£ææ˜¯æ˜¯ä»åå‘å‰è¿­ä»£è§£æï¼Œå¦‚æœåŸŸåè¿‡å¤šæ€§èƒ½ä¼šä¸‹é™ï¼Œå¢åŠ DNSçš„è§£æå¼€é”€ã€‚

æ‰‹æœºç«¯é¡µé¢åŠ è½½æ•°å’ŒåŸŸååˆ†æ•£æ•°çš„å…³ç³»ï¼š

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f5683d781c345d9af5a5f5e20211080~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3b29010536b48a0a6637afca21c38a9~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

ç°åœ¨ï¼Œå„å¤§æµè§ˆå™¨éƒ½å·²ç»æå‡äº†èµ„æºçš„ä¸‹è½½æ•°ï¼Œæ‰€ä»¥ï¼ŒåŸŸååˆ†æ•£çš„å¿…è¦æ€§ä¹Ÿå°±æ²¡è¿™ä¹ˆå¤§äº†. å¯ä»¥ä»ä¸Šè¡¨çœ‹å‡ºï¼Œåœ¨2ä¸ªåŸŸååˆ†æ•£æ¡ä»¶ä¸‹ï¼Œç½‘é¡µçš„åŠ è½½é€Ÿåº¦æå‡è¾ƒå¤§ï¼Œè€Œç¬¬ä¸‰ä¸ªä»¥åå°±æ¯”è¾ƒæ…¢äº†ã€‚ æ‰€ä»¥ï¼Œ ä¸€èˆ¬æ¥è¯´ï¼ŒåŸŸååˆ†æ•£çš„æ•°é‡æœ€å¥½åœ¨3ä»¥ä¸‹ã€‚

è¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡å¢åŠ åŸŸåæ¥è§£é™¤å¹¶å‘é™åˆ¶ï¼Œé‚£æœ‰æ²¡æœ‰æ–¹æ³•ä¸ç”¨å¢åŠ åŸŸåæ¥è§£é™¤å¹¶å‘é™åˆ¶å‘¢ï¼Ÿ

**SPDYã€‚**

### 3.23 SPYD

SPDYæ˜¯googleä¸»å¯¼çš„ä¸€ç§æ–°å‹é€šä¿¡æ–¹å¼.ä¸»è¦çš„ç‰¹ç‚¹å°±æ˜¯å¤šè·¯å¤ç”¨. ä»–çš„ç›®çš„å°±æ˜¯è‡´åŠ›äºå–æ¶ˆmax connections ä¸Šé™. ä¸è¿‡ç”±äºæ¨å¹¿æ—¶é—´çŸ­ï¼Œå…¨ä¸–ç•Œä½¿ç”¨çš„ç½‘é¡µæ•°éƒ½æ¯”è¾ƒå°‘. ä½†ï¼Œæ®chromiumç»Ÿè®¡ï¼Œä½¿ç”¨äº†SPDYç½‘é¡µé€Ÿç‡ å·®ä¸å¤šæå‡äº† [28%~64%](https://link.juejin.cn?target=http%3A%2F%2Fwww.chromium.org%2Fspdy%2Fspdy-whitepaper) å·¦å³. æ‰€ä»¥,è¯´SPDYçš„å‡ºç°ï¼Œå¯ä»¥è®©åŸŸåå‘æ•£çš„å­˜åœ¨å˜çš„æ¯«æ— ä»·å€¼.

SPDY åè®®èƒ½å¤Ÿå®Œæˆå¤šè·¯å¤ç”¨çš„åŠ å¯†å…¨åŒå·¥é€šé“ï¼Œæ˜¾è‘—æé«˜éwifiç¯å¢ƒä¸‹çš„ç½‘ç»œä½“éªŒã€‚

é‚£SPDYå…·ä½“çš„ä¼˜åŠ¿åœ¨å“ªé‡Œ.

- è§£å†³äº†HTTPåªèƒ½ One request per connection. å½“è¿æ¥å®Œæˆåï¼Œå¯ä»¥å®ç°å¹¶è¡Œä¸‹è½½å¤šä¸ªèµ„æºæ–‡ä»¶
- æœåŠ¡å™¨æ¨çš„æŠ€æœ¯, å’ŒSSEçš„ç†å¿µç±»ä¼¼ï¼Œä¸è¿‡æ›´é åº•å±‚ã€‚ç›´æ¥å¯ä»¥å®ç°æ— éœ€ç”¨æˆ·ç­‰å¾…ï¼Œç›´æ¥åå°å‘èµ„æº(æ„Ÿè§‰å°±åƒå†™APPäº†ï¼Œæœ‰æœ¨æœ‰)
- è¯·æ±‚å¤´çš„å¤ç”¨. å½“ä½ å‰å‡ æ¬¡çš„è¯·æ±‚å¤´å†…å®¹æ²¡å¤šå¤§å˜åŒ–çš„æ—¶å€™ï¼Œå°±ä¼šçœå»å‡ ä¸ªç›¸åŒçš„,å®ç°Header Compression
- æ•°æ®å‹ç¼©: åœ¨HTTP1.1 æœ‰ Content-Encoding: gzip, Transfer-Encoding: chunked. æ¥æ˜¾å¼è¡¨æ˜å¼€å¯æ–‡æœ¬å‹ç¼©ã€‚
- å¼ºåˆ¶ä½¿ç”¨SSLä¼ è¾“åè®®: Google è®¤ä¸º Web å°†æ¥çš„å‘å±•æ–¹å‘ä¸€å®šæ˜¯å®‰å…¨çš„ç½‘ç»œé“¾æ¥ï¼Œæ‰€æœ‰è¯·æ±‚ SSL åŠ å¯†åï¼Œä¿¡æ¯ä¼ è¾“æ›´åŠ å®‰å…¨ã€‚

é‚£å¦‚ä½•å¼€å¯SPDYå‘¢? ä½¿ç”¨nginxçš„ç”¨æˆ·ï¼Œå¯ä»¥ä¸‹è½½ä¸€ä¸ª[ngx_http_spdy_module](https://link.juejin.cn?target=http%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_spdy_module.html) çš„æ¨¡å—. ä½¿ç”¨apacheçš„ç”¨æˆ·ï¼Œå¯ä»¥ä¸‹è½½ä¸€ä¸ª [mod_spdy module](https://link.juejin.cn?target=http%3A%2F%2Fgoogledevelopers.blogspot.jp%2F2014%2F06%2Fmodspdy-is-now-apache-project.html) çš„æ¨¡å—.

## 4.æ€»ç»“

è¿˜æœ‰ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„ä¼˜åŒ–æ–¹æ³•æˆ‘æ²¡æœ‰åˆ—ä¸¾å‡ºæ¥ï¼Œä¾‹å¦‚å°†æ ·å¼è¡¨æ”¾åœ¨é¡¶éƒ¨ï¼Œå°†è„šæœ¬æ”¾åœ¨åº•éƒ¨ï¼Œå‡å°‘é‡ç»˜ï¼ŒæŒ‰éœ€åŠ è½½ï¼Œæ¨¡å—åŒ–ç­‰ã€‚æ–¹æ³•å¾ˆå¤šï¼Œå¯¹ç—‡ä¸‹è¯æ‰æ˜¯å…³é”®ã€‚



ä½œè€…ï¼šé»‘è‰²çš„æ«
é“¾æ¥ï¼šhttps://juejin.cn/post/6904517485349830670
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

## èƒŒæ™¯

> é¢†å¯¼ï¼šè¿™ä¸ªæ€ä¹ˆä¸€ç›´åœ¨loadingï¼Œæ‰“å¼€è¿™ä¹ˆé•¿æ—¶é—´
> æˆ‘ï¼šåˆæ¬¡åŠ è½½å°±æ˜¯æœ‰äº›æ…¢ï¼Œä½ çœ‹è¿™é‡Œæœ‰æç¤ºæ€§æ–‡å­—
> é¢†å¯¼ï¼šè¿™ä½“éªŒå¤ªå·®äº†ï¼Œæƒ³åŠæ³•ä¼˜åŒ–ä¸€ä¸‹
> æˆ‘ï¼šè¿™é¡¹ç›®å¤ªå¤§äº†ï¼Œè¿‘ä¸¤ç™¾ä¸ªé¡µé¢çš„ç³»ç»Ÿâ€¦â€¦
> åç«¯åŒå­¦ï¼šé‚£æ·˜å®ï¼Œé˜¿é‡Œäº‘é‚£é¡µé¢ä¸æ¯”å’±ä»¬è¿™ä¸ªç³»ç»Ÿé¡µé¢å¤š?
> é¢†å¯¼ï¼š(é¢†å¯¼ç¥äº†æˆ‘ä¸€çœ¼)
> æˆ‘ï¼šå¥½çš„ï¼Œé¢†å¯¼ï¼ˆå˜´ä¸Šç¬‘å˜»å˜»å¿ƒé‡ŒMMPï¼‰

![WechatIMG159.jpeg](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b175ef5dbb214b3ba04d1c9165248615~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?) ~~**ä»¥ä¸Šå†…å®¹ä¸ºäº†èŠ‚ç›®æ•ˆæœï¼Œçº¯å±è™šæ„ï¼Œæœ¬æ¬¡ä¼˜åŒ–å®Œå…¨æ˜¯å‡ºäºå¯¹æŠ€æœ¯çš„çƒ­çˆ±ä»¥åŠå·¥ä½œçš„çƒ­å¿±**~~

ä¸‹é¢æˆ‘ä»¬å¯¹é¡¹ç›®è¿›è¡Œä¼˜åŒ–ï¼Œå…ˆå‰§é€ä¸€ä¸‹ç»“æœï¼Œä»¥åŸºç¡€çš„Vue Cli3çš„é¡¹ç›®ä¸ºä¾‹ï¼š

| ä¼˜åŒ–é¡¹       | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
| ------------ | ------ | ------ |
| é¦–å±åŠ è½½æ—¶é—´ | 30s+   | 2.5s   |
| æ‰“åŒ…åçš„å¤§å° | 28.9M  | 1M     |

```
æ ¹æ®å¸¸è§„çš„æ“ä½œæ€è·¯ï¼Œæˆ‘ä»¬ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è€ƒè™‘ä¼˜åŒ–ï¼š
```

## WEBPACK

### `sourceMap`

ç”Ÿäº§ç¯å¢ƒä¸‹å…³é—­`productionSourceMap`ã€`css sourceMap`ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªä¸œè¥¿æ˜¯æ˜ å°„æºæ–‡ä»¶çš„ä¸¤ä¸ªé…ç½®ï¼Œä½œç”¨æ˜¯ç”¨æ¥æ–­ç‚¹è°ƒè¯•ç”¨çš„ï¼Œæ‰€ä»¥ç”Ÿäº§ç¯å¢ƒæ ¹æœ¬ä¸éœ€è¦åšè¿™æ ·çš„æ˜ å°„ã€‚

```js
    // vue.config.js
    const isProduction = process.env.NODE_ENV === 'production'
    // åˆ¤æ–­æ˜¯å¦æ˜¯ç”Ÿäº§ç¯å¢ƒ
    module.exports = {
        productionSourceMap: !isProduction, //å…³é—­ç”Ÿäº§ç¯å¢ƒä¸‹çš„SourceMapæ˜ å°„æ–‡ä»¶
        css: {
            sourceMap: !isProduction, // css sourceMap é…ç½®
            loaderOptions: {
                ...
            }
        },
        ...
    }
å¤åˆ¶ä»£ç 
```

### webpack-bundle-analyzer

```
webpack-bundle-analyzer`æ˜¯webpackåŒ…åˆ†æçš„ç¥å™¨æ’ä»¶ï¼Œå®‰è£… `webpack-bundle-analyzer` æ’ä»¶ï¼Œæ‰“åŒ…åä¼šç”Ÿäº§ä¸€ä¸ªæœ¬åœ°æœåŠ¡ï¼Œæ¸…æ¥šçš„å±•ç¤ºæ‰“åŒ…æ–‡ä»¶çš„åŒ…å«å…³ç³»å’Œå¤§å°ï¼Œæ‰€ä»¥æˆ‘ä»¬åºŸè¯ä¸å¤šï¼Œç›´æ¥`npm install webpack-bundle-analyzer -D
    // vue.config.js
    module.exports = {     
       chainWebpack: (config) => {
            // åˆ†ææ‰“åŒ…å¤§å°
            if (process.env.npm_config_report) {
              config.plugin('webpack-bundle-analyzer')
                .use(require('webpack-bundle-analyzer').BundleAnalyzerPlugin)
                .end();
            }
       }
    }
    
    // package.json
    {
      "name": "name",
      "version": "0.0.1",
      "scripts": {
        "report": "set npm_config_report=true && vue-cli-service build",
      },
      ...
     }

å¤åˆ¶ä»£ç 
```

æ¥ä¸‹æ¥ç›´æ¥è·‘ `npm run report`, æµè§ˆå™¨åœ¨æ‰“åŒ…çš„åŒæ—¶ä¼šè¾“å‡ºä¸‹é¢ä¸€ä¸ªä¾èµ–åŒ…å…³ç³»çš„æŠ¥å‘Šï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6dfa670854724633a2b4feeec7ed3482~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0d8e136afe4486b98b364c6c24d51da~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/834e97d5e5b2425a8a7b055f5fd88e76~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?) æ‰“å¼€å¯¹åº”çš„distä¸€çœ‹ï¼Œå¥½å®¶ä¼™ï¼Œdistæ–‡ä»¶28.9Mï¼Œç€å®æœ‰ç‚¹å„¿å¤§ï¼Œå–å£æ°´å‹å‹æƒŠï¼Œç»§ç»­éªšæ“ä½œ

### externals

æ ¹æ®åˆ†ææŠ¥å‘Šï¼Œç›´è§‚çš„çœ‹åˆ°node_modulesé‡Œé¢æœ‰å‡ ä¸ªæ¯”è¾ƒå¤§çš„åŒ…ï¼Œæˆ‘ä»¬å¤„ç†ä¸€ä¸‹ï¼Œæ¯”å¦‚echartsã€element-uiã€lodashã€mockç­‰ï¼Œè€Œexternalså¯ä»¥ç”¨æ¥**é˜²æ­¢**å°†æŸäº› `import` çš„åŒ…(package)**æ‰“åŒ…**åˆ° bundle ä¸­ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶(runtime)å†å»ä»å¤–éƒ¨è·å–è¿™äº›*æ‰©å±•ä¾èµ–(external dependencies)*

```JavaScript
    // vue.config.js
    ....
    chainWebpack: (config) => {
        ....
        //å¿½ç•¥çš„æ‰“åŒ…æ–‡ä»¶
        config.externals({
          'vue': 'Vue',
          'vue-router': 'VueRouter',
          'vuex': 'Vuex',
          'axios': 'axios',
          'element-ui': 'ELEMENT',
          'echarts': 'echarts',
          'lodash': 'lodash',
          'mock': 'mock'
        });
        ....
    }
å¤åˆ¶ä»£ç 
```

### æ‹†åŒ…

ä¸€ä¸ªå…¥å£app.jså¥½å‡ å…†ï¼Œè¿™åŠ è½½èµ·æ¥å¤šè´¹åŠ²ï¼Œæ€ªä¸å¾—åˆšæ‰é¢†å¯¼æ‰“å¼€ç³»ç»Ÿçš„æ—¶å€™é‚£ä¹ˆæ…¢

```js
// vue.config.js
....
chainWebpack: (config) => {
    ...
    config.optimization && config.optimization.splitChunks({
        // æ‹†åŒ…é…ç½® 
        chunks: 'all', //ä¸‰é€‰ä¸€ï¼š"initial" åˆå§‹åŒ–ï¼Œ"all"(é»˜è®¤å°±æ˜¯all)ï¼Œ"async"ï¼ˆåŠ¨æ€åŠ è½½ï¼‰ 
        minSize: 30000, // å½¢æˆä¸€ä¸ªæ–°ä»£ç å—æœ€å°çš„ä½“ç§¯,åªæœ‰ >= minSize çš„bundleä¼šè¢«æ‹†åˆ†å‡ºæ¥ 30000
        maxSize: 0, //æ‹†åˆ†ä¹‹å‰æœ€å¤§çš„æ•°å€¼ï¼Œé»˜è®¤ä¸º0ï¼Œå³ä¸åšé™åˆ¶
        minChunks: 1, //å¼•å…¥æ¬¡æ•°ï¼Œå¦‚æœä¸º2 é‚£ä¹ˆä¸€ä¸ªèµ„æºæœ€å°‘è¢«å¼•ç”¨ä¸¤æ¬¡æ‰å¯ä»¥è¢«æ‹†åˆ†å‡ºæ¥
        maxAsyncRequests: 5, // æŒ‰éœ€åŠ è½½çš„æœ€å¤§å¹¶è¡Œè¯·æ±‚æ•°
        maxInitialRequests: 3, // ä¸€ä¸ªå…¥å£æœ€å¤§å¹¶è¡Œè¯·æ±‚æ•°
        automaticNameDelimiter: '~', // æ–‡ä»¶åçš„è¿æ¥ç¬¦
        name: true,
        cacheGroups: {
        // node_modulesæ¨¡å—åŒ…
        vendors: {
          test: /[\\/]node_modules[\\/]/,
          name: 'chunk-vendors',
          // name(module) {
          //   const packageName = module.context.match(/[\\/]node_modules[\\/](.*?)([\\/]|$)/)[1];
          //   return `chunk.${packageName.replace('@', '')}`;
          // },
          chunks: 'all',
          priority: -10,
        },
        // UIåº“å•ç‹¬æ‹†åŒ…
        elementUI: {
          name: 'chunk-elementUI',
          priority: 20, //  the weight needs to be larger than libs and app or it will be packaged into libs or app
          test: /[\\/]node_modules[\\/]_?element-ui(.*)/
        },
        // å…±äº«æ¨¡å—
        common: {
          name: 'chunk-common',
          minChunks: 2,
          maxSize: 1024, //æ‹†åˆ†ä¹‹å‰æœ€å¤§çš„æ•°å€¼ï¼Œé»˜è®¤ä¸º0ï¼Œå³ä¸åšé™åˆ¶
          priority: -20,
          reuseExistingChunk: true
        }
        }
    });
    ...
}
...
å¤åˆ¶ä»£ç 
```

### å‹ç¼©jså’Œcss

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ webpack v5 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œæ˜¯å¼€ç®±æœºå¸¦çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä½ çš„webpackæ˜¯5ä»¥ä¸‹æˆ–åˆ™å¸Œæœ›è‡ªå®šä¹‰é…ç½®ï¼Œé‚£ä¹ˆéœ€è¦å®‰è£… `terser-webpack-plugin`ã€‚å¦‚æœä½¿ç”¨ webpack v4ï¼Œåˆ™å¿…é¡»å®‰è£… `terser-webpack-plugin` v4 çš„ç‰ˆæœ¬ã€‚

```JavaScript
// vue.config.js
const TerserJSPlugin = require('terser-webpack-plugin');
....
chainWebpack: (config) => {
    // å¼€å¯jsã€csså‹ç¼©
    config.plugin('TerserJSPlugin')
      .use(new TerserJSPlugin({
        terserOptions: {
          output: {
            comments: false // å»æ‰æ³¨é‡Š
          },
          warnings: false,
          compress: {
            // eslint-disable-next-line camelcase
            drop_console: true,
            // eslint-disable-next-line camelcase
            drop_debugger: true,
            // pure_funcs: ['console.log'] // ç§»é™¤console
          }
        }
      }));
}
å¤åˆ¶ä»£ç 
```

### å›¾ç‰‡å‹ç¼©

å®‰è£…å›¾ç‰‡å‹ç¼©çš„loader[image-webpack-loader](https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fimage-webpack-loader) ç›´æ¥ç»ˆç«¯`npm install image-webpack-loader -D`

```bash
// vue.config.js
...
module.exports = {
    ...
    chainWebpack: config => {
        config.module 
            .rule('images')
              .use('image-webpack-loader') 
                  .loader('image-webpack-loader') 
                  .options({ 
                      bypassOnDebug: true, // webpack  'debug' æ¨¡å¼ä¸‹ä¸æ‰§è¡Œ
                  }) 
              .end() 
            .end()

    }
    ...
}

å¤åˆ¶ä»£ç 
```

### å¼€å¯Gzipå‹ç¼©

```JavaScript
// æ‰“åŒ…å‹ç¼©é™æ€æ–‡ä»¶æ’ä»¶
const CompressionWebpackPlugin = require("compression-webpack-plugin")
...
module.exports = {
    ...
    chainWebpack: config => {
        //ç”Ÿäº§ç¯å¢ƒå¼€å¯js/csså‹ç¼©
        if (isProduction) {
            config.plugin('CompressionWebpackPlugin').use(new CompressionWebpackPlugin({
                test: /\.(js)$/, // åŒ¹é…æ–‡ä»¶å
                threshold: 10240, // å¯¹è¶…è¿‡10kçš„æ•°æ®å‹ç¼©
                minRatio: 0.8,
                deleteOriginalAssets: true // åˆ é™¤æºæ–‡ä»¶
            }))
        }
    }
    ...
}
å¤åˆ¶ä»£ç 
```

å¯¹ç”¨æœåŠ¡ç«¯Nginxé…ç½®

```bash
# nginxå‰ç«¯é™æ€èµ„æºé…ç½®  // data/docker/nginx/conf.d 
server { 
    listen 8080; 
    server_name _;
    gzip_static on; // å¼€å¯gzipå‹ç¼©
    client_max_body_size 500m; 
    root /data/****/web/dist; 
    index index.html; 
    location ^~ /api { 
        proxy_pass http://***.**.**.***:8080/; 
        proxy_set_header Host ***.**.**.***; 
        proxy_set_header X-Real-IP $remote_addr; 
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
    } 
}


å¤åˆ¶ä»£ç 
```

### å¢åŠ cache-loader

ç”±äºé¡¹ç›®åºå¤§ï¼Œä¹‹å‰æ‰“åŒ…æ—¶é—´å°±å¾ˆé•¿ï¼Œæ‰“åŒ…æ—¶é—´çš„å¤§éƒ¨åˆ†éƒ½åœ¨`npm install`å’Œå„ç§`loader`çš„æ‰§è¡Œä¸Šï¼Œå¦‚æœä¸ç”¨æ¯æ¬¡æ‰“åŒ…éƒ½ä»0å¼€å§‹æ‰§è¡Œçš„è¯ä¼šå¿«å¾ˆå¤šã€‚é¦–å…ˆå¯ä»¥åœ¨`loader`ä¹‹å‰åŠ ä¸Š`cache-loader`ï¼Œè¿™æ ·è¿™ä¸ª`loader`æ‰§è¡Œè¿‡ä¸€æ¬¡åçš„æ•°æ®ä¼šç¼“å­˜åœ¨`node_modules/.cache`ç›®å½•ä¸‹ï¼Œä¸‹æ¬¡å†æ‰“åŒ…å°±ä¼šåˆ©ç”¨ç¼“å­˜ã€‚

```bash
// vue.config.js
...
module.exports = {
    ...
    config.module
          .rule('images')
            // ç»™ image-webpack-loader åŠ ä¸Šç¼“å­˜æ¥åŠ å¿«ç¼–è¯‘
            .use('cache-loader')
              .before('url-loader')
              .loader('cache-loader')
              .options({
                cacheDirectory: path.join(__dirname, 'node_modules/.cache/image-webpack-loader'),
              })
    ...
}
å¤åˆ¶ä»£ç 
æ³¨æ„ï¼šåªæœ‰æ‰§è¡Œæ—¶é—´å¾ˆé•¿çš„loaderæ‰é€‚åˆç”¨ç¼“å­˜ï¼Œå› ä¸ºè¯»å†™æ–‡ä»¶ä¹Ÿæ˜¯æœ‰å¼€é”€çš„ï¼Œæ»¥ç”¨åè€Œä¼šå¯¼è‡´å˜æ…¢
```

## CDN

å¯¹äºé¡¹ç›®ç”¨åˆ°çš„é™æ€èµ„æºï¼Œæ¯”å¦‚å›¾ç‰‡ï¼Œé™æ€èµ„æºåº“ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠæ–‡ä»¶ç»™ç”©åˆ°CDNä¸Š

```html
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.10/vue.min.js" charset="utf-8"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/vuex/3.1.1/vuex.min.js" charset="utf-8"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/vue-router/3.0.1/vue-router.min.js" charset="utf-8"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.17.1/axios.min.js" charset="utf-8"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.3/index.min.js" charset="utf-8"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.1.2/echarts.min.js" charset="utf-8"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js" charset="utf-8"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Mock.js/1.0.1-beta3/mock-min.js" charset="utf-8"></script>
å¤åˆ¶ä»£ç 
```

## æŒ‰éœ€åŠ è½½

æˆ‘ä»¬å¼•ç”¨æŸä¸€äº›ç¬¬ä¸‰æ–¹ä½¿ç”¨å°‘é‡åŠŸèƒ½çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©æŒ‰éœ€åŠ è½½ï¼Œä¸¾ä¸ªä¾‹å­ï¼š æ¯”å¦‚å¼•ç”¨lodashçš„æ—¶å€™ï¼Œå¦‚æœæƒ³è¦æŒ‰éœ€åŠ è½½ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨[webpack-lodash-plugin](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flodash%2Flodash-webpack-plugin%23readme)å’Œ[babel-plugin-lodash](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flodash%2Fbabel-plugin-lodash)ï¼ŒæŒ‰éœ€åŠ è½½å¯ä»¥èŠ‚çœè¿‘1Mçš„ç©ºé—´å¤§å°

```JavaScript
    // ä½¿ç”¨å‰ï¼Œéœ€è¦æ‰‹åŠ¨å¼•å…¥æŒ‡å®šçš„æ¨¡å—
    const isElement = require('lodash/isElement');
    const debounce = require('lodash/debounce');

    // ä½¿ç”¨åï¼Œæ”¾å¿ƒå¼•å…¥
    import { isElement, debounce } from 'lodash'
å¤åˆ¶ä»£ç 
```

## ç¼“å­˜

æˆ‘ä»¬æ¯æ¬¡æ‰“åŒ…ï¼Œè·Ÿä¸Šæ¬¡ç›¸æ¯”ï¼Œæ”¹å˜çš„ä¸œè¥¿æ€»æ˜¯ç›¸å¯¹å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œä¸å˜çš„ä¸œè¥¿æ²¡å¿…è¦æ¯æ¬¡éƒ½é‡æ–°æ‰“åŒ…ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘åˆ©ç”¨åŒ…çš„ç¼“å­˜ï¼Œæ¥ç¼©çŸ­æ„å»ºçš„æ—¶é—´

```JavaScript
module.exports = {
  ...
  configureWebpack: (config) => {
    config.cache = {
      type: "filesystem",
      allowCollectingMemory: true,
      buildDependencies: {
        config: [__filename],
      },
      name: `${process.env.NODE_ENV || "development"}-cache`,
    };
  }
  ...
}
å¤åˆ¶ä»£ç 
```

å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æµè§ˆå™¨ç¼“å­˜ï¼Œä»¥åŠæœåŠ¡å™¨ç¼“å­˜ï¼ŒRedisç¼“å­˜ï¼Œå»åŠ é€Ÿæˆ‘ä»¬çš„ç³»ç»Ÿå“åº”é€Ÿåº¦ï¼Œæ¯”å¦‚é…åˆåç«¯åŒå­¦åˆ©ç”¨å¼ºç¼“å­˜æˆ–è€…åå•†ç¼“å­˜ï¼Œåˆç†çš„å¯¹å®¢æˆ·ç«¯è¯·æ±‚è¿›è¡Œç¼“å­˜ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æœåŠ¡å™¨å¯¹webèµ„æºä»£ç†çš„æ—¶å€™ï¼Œå¯¹å…¥å£çš„html.index ä¸€å®šä¸è¦åšç¼“å­˜ï¼Œå› ä¸ºæ¯æ¬¡æ›´æ–°è¿™ä¸ªå…¥å£ä¾èµ–çš„ä¸€äº›jså’Œcsséƒ½ä¼šæ ¹æ®hashæŒ‡çº¹æœ‰ä¿®æ”¹ï¼Œæœ‰ç¼“å­˜çš„è¯å°±ä¼šé€ æˆæ¯æ¬¡å‘å¸ƒç”¨æˆ·éƒ½è¦æ¸…ç©ºæµè§ˆå™¨ç¼“å­˜åŠ è½½æ‰èƒ½çœ‹åˆ°æœ€æ–°çš„å†…å®¹

```bash
# nginxå‰ç«¯é™æ€èµ„æºé…ç½®  // data/docker/nginx/conf.d 
server { 
    listen 8080; 
    server_name _;
    gzip_static on; // å¼€å¯gzipå‹ç¼©
    client_max_body_size 500m; 
    root /data/****/web/dist; 
    index index.html; 
    location ^~ /api { 
        proxy_pass http://***.**.**.***:8080/; 
        proxy_set_header Host ***.**.**.***; 
        proxy_set_header X-Real-IP $remote_addr; 
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
    } 
    location = /index.html {
        add_header Cache-Control "no-cache,no-store";
    }
}

å¤åˆ¶ä»£ç 
```

## å…¶ä»–ä¸€äº›ä¼˜åŒ–

å…¶å®å¤šæ•°é¡¹ç›®çš„æ€§èƒ½é—®é¢˜æœ‰å¾ˆå¤šæ˜¯å¹³æ—¶å†™ä»£ç æ—¶ä¸€äº›ä¸æ³¨æ„æˆ–è€…æ˜¯èµ¶é¡¹ç›®æ‡’å¾—è´¹åŠ²ï¼Œä¸€ç‚¹ä¸€ç‚¹ç§¯ç´¯çš„ï¼Œæ—¶é—´é•¿äº†å°±è¶Šéš¾è¿›è¡Œä¼˜åŒ–ï¼Œé€æ¸å½¢æˆè®©äººå¤´ç–¼æˆ–è€…éš¾ä»¥ç»´æŠ¤çš„ç¡¬éª¨å¤´ã€‚å¹³æ—¶æˆ‘ä»¬ä¸€èˆ¬éƒ½åº”è¯¥æ³¨æ„ï¼š

- è·¯ç”±ã€å›¾ç‰‡æ‡’åŠ è½½ï¼Œç¬¬ä¸‰æ–¹æŒ‰éœ€åŠ è½½
- tabs æ‡’åŠ è½½ï¼ˆåˆ‡æ¢åˆ°å¯¹åº”tabæ—¶å†æ¸²æŸ“ï¼‰
- keep-aliveç¼“å­˜é¡µé¢ï¼Œå¢åŠ è®¿é—®é€Ÿåº¦
- å¦‚æœåˆ—è¡¨çº¯ç²¹æ˜¯æ˜¾ç¤ºæ•°æ®ï¼Œä¸ä¼šæœ‰æ”¹å˜ï¼Œæ•°æ®å°±ä¸éœ€è¦å“åº”å¼ï¼Œå¯ä»¥ä½¿ç”¨Object.freezeæ–¹æ³•è¿›è¡Œå†»ç»“
- å­ç»„ä»¶ä¸­æœ‰ä¸€äº›æ¯”è¾ƒè€—æ—¶çš„å°±å•ç‹¬åˆ†å‰²æˆä¸ºä¸€ä¸ªç»„ä»¶ï¼Œè‡ªå·±åšè‡ªå·±çš„æ¸²æŸ“ï¼Œä¸ä¼šå½±å“å…¶ä»–çš„ç»„ä»¶
- â€¦â€¦

## ç»“è¯­

å†æ¥å›é¡¾ä¸€ä¸‹ä¼˜åŒ–å‰åçš„å¯¹æ¯”

| ä¼˜åŒ–é¡¹       | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
| ------------ | ------ | ------ |
| é¦–å±åŠ è½½æ—¶é—´ | 30s+   | 2.5s   |
| æ‰“åŒ…åçš„å¤§å° | 28.9M  | 1M     |

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95dceb5b6d0547ee8a5f617112d04739~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f936404c03243e5898ab0dc7a1ac739~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/692acd6501a64d6ea1c0b8cb0f5048dd~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)



# æºç è§£è¯»

ç»è¿‡ä¸Šä¸€ç¯‡æ–‡ç« çš„å­¦ä¹ ï¼Œç›¸ä¿¡å…³äº `å“åº”å¼åŸç†` æºç é˜…è¯»çš„å…¥å£ä½ç½®å¤§å®¶éƒ½å·²ç»çŸ¥é“äº†ï¼Œå°±æ˜¯åˆå§‹åŒ–è¿‡ç¨‹ä¸­å¤„ç†æ•°æ®å“åº”å¼è¿™ä¸€æ­¥ï¼Œå³è°ƒç”¨ `initState` æ–¹æ³•ï¼Œåœ¨ `/src/core/instance/init.js` æ–‡ä»¶ä¸­ã€‚

## initState

> /src/core/instance/state.js

```javascript
/**
 * ä¸¤ä»¶äº‹ï¼š
 *   æ•°æ®å“åº”å¼çš„å…¥å£ï¼šåˆ†åˆ«å¤„ç† propsã€methodsã€dataã€computedã€watch
 *   ä¼˜å…ˆçº§ï¼špropsã€methodsã€dataã€computed å¯¹è±¡ä¸­çš„å±æ€§ä¸èƒ½å‡ºç°é‡å¤ï¼Œä¼˜å…ˆçº§å’Œåˆ—å‡ºé¡ºåºä¸€è‡´
 *         å…¶ä¸­ computed ä¸­çš„ key ä¸èƒ½å’Œ propsã€data ä¸­çš„ key é‡å¤ï¼Œmethods ä¸å½±å“
 */
export function initState (vm: Component) {
  vm._watchers = []
  const opts = vm.$options
  // å¤„ç† props å¯¹è±¡ï¼Œä¸º props å¯¹è±¡çš„æ¯ä¸ªå±æ€§è®¾ç½®å“åº”å¼ï¼Œå¹¶å°†å…¶ä»£ç†åˆ° vm å®ä¾‹ä¸Š
  if (opts.props) initProps(vm, opts.props)
  // å¤„ç† methos å¯¹è±¡ï¼Œæ ¡éªŒæ¯ä¸ªå±æ€§çš„å€¼æ˜¯å¦ä¸ºå‡½æ•°ã€å’Œ props å±æ€§æ¯”å¯¹è¿›è¡Œåˆ¤é‡å¤„ç†ï¼Œæœ€åå¾—åˆ° vm[key] = methods[key]
  if (opts.methods) initMethods(vm, opts.methods)
  /**
   * åšäº†ä¸‰ä»¶äº‹
   *   1ã€åˆ¤é‡å¤„ç†ï¼Œdata å¯¹è±¡ä¸Šçš„å±æ€§ä¸èƒ½å’Œ propsã€methods å¯¹è±¡ä¸Šçš„å±æ€§ç›¸åŒ
   *   2ã€ä»£ç† data å¯¹è±¡ä¸Šçš„å±æ€§åˆ° vm å®ä¾‹
   *   3ã€ä¸º data å¯¹è±¡çš„ä¸Šæ•°æ®è®¾ç½®å“åº”å¼ 
   */
  if (opts.data) {
    initData(vm)
  } else {
    observe(vm._data = {}, true /* asRootData */)
  }
  /**
   * ä¸‰ä»¶äº‹ï¼š
   *   1ã€ä¸º computed[key] åˆ›å»º watcher å®ä¾‹ï¼Œé»˜è®¤æ˜¯æ‡’æ‰§è¡Œ
   *   2ã€ä»£ç† computed[key] åˆ° vm å®ä¾‹
   *   3ã€åˆ¤é‡ï¼Œcomputed ä¸­çš„ key ä¸èƒ½å’Œ dataã€props ä¸­çš„å±æ€§é‡å¤
   */
  if (opts.computed) initComputed(vm, opts.computed)
  /**
   * ä¸‰ä»¶äº‹ï¼š
   *   1ã€å¤„ç† watch å¯¹è±¡
   *   2ã€ä¸º æ¯ä¸ª watch.key åˆ›å»º watcher å®ä¾‹ï¼Œkey å’Œ watcher å®ä¾‹å¯èƒ½æ˜¯ ä¸€å¯¹å¤š çš„å…³ç³»
   *   3ã€å¦‚æœè®¾ç½®äº† immediateï¼Œåˆ™ç«‹å³æ‰§è¡Œ å›è°ƒå‡½æ•°
   */
  if (opts.watch && opts.watch !== nativeWatch) {
    initWatch(vm, opts.watch)
  }
    
  /**
   * å…¶å®åˆ°è¿™é‡Œä¹Ÿèƒ½çœ‹å‡ºï¼Œcomputed å’Œ watch åœ¨æœ¬è´¨æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œéƒ½æ˜¯é€šè¿‡ watcher å»å®ç°çš„å“åº”å¼
   * éè¦è¯´æœ‰åŒºåˆ«ï¼Œé‚£ä¹Ÿåªæ˜¯åœ¨ä½¿ç”¨æ–¹å¼ä¸Šçš„åŒºåˆ«ï¼Œç®€å•æ¥è¯´ï¼š
   *   1ã€watchï¼šé€‚ç”¨äºå½“æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œå¼‚æ­¥æˆ–è€…å¼€é”€è¾ƒå¤§çš„æ“ä½œæ—¶ä½¿ç”¨ï¼Œå³éœ€è¦é•¿æ—¶é—´ç­‰å¾…çš„æ“ä½œå¯ä»¥æ”¾åœ¨ watch ä¸­
   *   2ã€computedï¼šå…¶ä¸­å¯ä»¥ä½¿ç”¨å¼‚æ­¥æ–¹æ³•ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚æ‰€ä»¥ computed æ›´é€‚åˆåšä¸€äº›åŒæ­¥è®¡ç®—
   */
}

å¤åˆ¶ä»£ç 
```

## initProps

> src/core/instance/state.js

```javascript
// å¤„ç† props å¯¹è±¡ï¼Œä¸º props å¯¹è±¡çš„æ¯ä¸ªå±æ€§è®¾ç½®å“åº”å¼ï¼Œå¹¶å°†å…¶ä»£ç†åˆ° vm å®ä¾‹ä¸Š
function initProps (vm: Component, propsOptions: Object) {
  const propsData = vm.$options.propsData || {}
  const props = vm._props = {}
  // ç¼“å­˜ props çš„æ¯ä¸ª keyï¼Œæ€§èƒ½ä¼˜åŒ–
  // cache prop keys so that future props updates can iterate using Array
  // instead of dynamic object key enumeration.
  const keys = vm.$options._propKeys = []
  const isRoot = !vm.$parent
  // root instance props should be converted
  if (!isRoot) {
    toggleObserving(false)
  }
  // éå† props å¯¹è±¡
  for (const key in propsOptions) {
    // ç¼“å­˜ key
    keys.push(key)
    // è·å– props[key] çš„é»˜è®¤å€¼
    const value = validateProp(key, propsOptions, propsData, vm)
    // ä¸º props çš„æ¯ä¸ª key æ˜¯è®¾ç½®æ•°æ®å“åº”å¼
    defineReactive(props, key, value)
    // static props are already proxied on the component's prototype
    // during Vue.extend(). We only need to proxy props defined at
    // instantiation here.
    if (!(key in vm)) {
      // ä»£ç† key åˆ° vm å¯¹è±¡ä¸Š
      proxy(vm, `_props`, key)
    }
  }
  toggleObserving(true)
}

å¤åˆ¶ä»£ç 
```

## proxy

> /src/core/instance/state.js

```javascript
// è®¾ç½®ä»£ç†ï¼Œå°† key ä»£ç†åˆ° target ä¸Š
export function proxy (target: Object, sourceKey: string, key: string) {
  sharedPropertyDefinition.get = function proxyGetter () {
    return this[sourceKey][key]
  }
  sharedPropertyDefinition.set = function proxySetter (val) {
    this[sourceKey][key] = val
  }
  Object.defineProperty(target, key, sharedPropertyDefinition)
}

å¤åˆ¶ä»£ç 
```

## initMethods

> /src/core/instance/state.js

```javascript
/**
 * åšäº†ä»¥ä¸‹ä¸‰ä»¶äº‹ï¼Œå…¶å®æœ€å…³é”®çš„å°±æ˜¯ç¬¬ä¸‰ä»¶äº‹æƒ…
 *   1ã€æ ¡éªŒ methoss[key]ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°
 *   2ã€åˆ¤é‡
 *         methods ä¸­çš„ key ä¸èƒ½å’Œ props ä¸­çš„ key ç›¸åŒ
 *         methos ä¸­çš„ key ä¸ Vue å®ä¾‹ä¸Šå·²æœ‰çš„æ–¹æ³•é‡å ï¼Œä¸€èˆ¬æ˜¯ä¸€äº›å†…ç½®æ–¹æ³•ï¼Œæ¯”å¦‚ä»¥ $ å’Œ _ å¼€å¤´çš„æ–¹æ³•
 *   3ã€å°† methods[key] æ”¾åˆ° vm å®ä¾‹ä¸Šï¼Œå¾—åˆ° vm[key] = methods[key]
 */
function initMethods (vm: Component, methods: Object) {
  // è·å– props é…ç½®é¡¹
  const props = vm.$options.props
  // éå† methods å¯¹è±¡
  for (const key in methods) {
    if (process.env.NODE_ENV !== 'production') {
      if (typeof methods[key] !== 'function') {
        warn(
          `Method "${key}" has type "${typeof methods[key]}" in the component definition. ` +
          `Did you reference the function correctly?`,
          vm
        )
      }
      if (props && hasOwn(props, key)) {
        warn(
          `Method "${key}" has already been defined as a prop.`,
          vm
        )
      }
      if ((key in vm) && isReserved(key)) {
        warn(
          `Method "${key}" conflicts with an existing Vue instance method. ` +
          `Avoid defining component methods that start with _ or $.`
        )
      }
    }
    vm[key] = typeof methods[key] !== 'function' ? noop : bind(methods[key], vm)
  }
}

å¤åˆ¶ä»£ç 
```

## initData

> src/core/instance/state.js

```javascript
/**
 * åšäº†ä¸‰ä»¶äº‹
 *   1ã€åˆ¤é‡å¤„ç†ï¼Œdata å¯¹è±¡ä¸Šçš„å±æ€§ä¸èƒ½å’Œ propsã€methods å¯¹è±¡ä¸Šçš„å±æ€§ç›¸åŒ
 *   2ã€ä»£ç† data å¯¹è±¡ä¸Šçš„å±æ€§åˆ° vm å®ä¾‹
 *   3ã€ä¸º data å¯¹è±¡çš„ä¸Šæ•°æ®è®¾ç½®å“åº”å¼ 
 */
function initData (vm: Component) {
  // å¾—åˆ° data å¯¹è±¡
  let data = vm.$options.data
  data = vm._data = typeof data === 'function'
    ? getData(data, vm)
    : data || {}
  if (!isPlainObject(data)) {
    data = {}
    process.env.NODE_ENV !== 'production' && warn(
      'data functions should return an object:\n' +
      'https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function',
      vm
    )
  }
  /**
   * ä¸¤ä»¶äº‹
   *   1ã€åˆ¤é‡å¤„ç†ï¼Œdata å¯¹è±¡ä¸Šçš„å±æ€§ä¸èƒ½å’Œ propsã€methods å¯¹è±¡ä¸Šçš„å±æ€§ç›¸åŒ
   *   2ã€ä»£ç† data å¯¹è±¡ä¸Šçš„å±æ€§åˆ° vm å®ä¾‹
   */
  const keys = Object.keys(data)
  const props = vm.$options.props
  const methods = vm.$options.methods
  let i = keys.length
  while (i--) {
    const key = keys[i]
    if (process.env.NODE_ENV !== 'production') {
      if (methods && hasOwn(methods, key)) {
        warn(
          `Method "${key}" has already been defined as a data property.`,
          vm
        )
      }
    }
    if (props && hasOwn(props, key)) {
      process.env.NODE_ENV !== 'production' && warn(
        `The data property "${key}" is already declared as a prop. ` +
        `Use prop default value instead.`,
        vm
      )
    } else if (!isReserved(key)) {
      proxy(vm, `_data`, key)
    }
  }
  // ä¸º data å¯¹è±¡ä¸Šçš„æ•°æ®è®¾ç½®å“åº”å¼
  observe(data, true /* asRootData */)
}

export function getData (data: Function, vm: Component): any {
  // #7573 disable dep collection when invoking data getters
  pushTarget()
  try {
    return data.call(vm, vm)
  } catch (e) {
    handleError(e, vm, `data()`)
    return {}
  } finally {
    popTarget()
  }
}

å¤åˆ¶ä»£ç 
```

## initComputed

> /src/core/instance/state.js

```javascript
const computedWatcherOptions = { lazy: true }

/**
 * ä¸‰ä»¶äº‹ï¼š
 *   1ã€ä¸º computed[key] åˆ›å»º watcher å®ä¾‹ï¼Œé»˜è®¤æ˜¯æ‡’æ‰§è¡Œ
 *   2ã€ä»£ç† computed[key] åˆ° vm å®ä¾‹
 *   3ã€åˆ¤é‡ï¼Œcomputed ä¸­çš„ key ä¸èƒ½å’Œ dataã€props ä¸­çš„å±æ€§é‡å¤
 * @param {*} computed = {
 *   key1: function() { return xx },
 *   key2: {
 *     get: function() { return xx },
 *     set: function(val) {}
 *   }
 * }
 */
function initComputed (vm: Component, computed: Object) {
  // $flow-disable-line
  const watchers = vm._computedWatchers = Object.create(null)
  // computed properties are just getters during SSR
  const isSSR = isServerRendering()

  // éå† computed å¯¹è±¡
  for (const key in computed) {
    // è·å– key å¯¹åº”çš„å€¼ï¼Œå³ getter å‡½æ•°
    const userDef = computed[key]
    const getter = typeof userDef === 'function' ? userDef : userDef.get
    if (process.env.NODE_ENV !== 'production' && getter == null) {
      warn(
        `Getter is missing for computed property "${key}".`,
        vm
      )
    }

    if (!isSSR) {
      // ä¸º computed å±æ€§åˆ›å»º watcher å®ä¾‹
      watchers[key] = new Watcher(
        vm,
        getter || noop,
        noop,
        // é…ç½®é¡¹ï¼Œcomputed é»˜è®¤æ˜¯æ‡’æ‰§è¡Œ
        computedWatcherOptions
      )
    }

    if (!(key in vm)) {
      // ä»£ç† computed å¯¹è±¡ä¸­çš„å±æ€§åˆ° vm å®ä¾‹
      // è¿™æ ·å°±å¯ä»¥ä½¿ç”¨ vm.computedKey è®¿é—®è®¡ç®—å±æ€§äº†
      defineComputed(vm, key, userDef)
    } else if (process.env.NODE_ENV !== 'production') {
      // éç”Ÿäº§ç¯å¢ƒæœ‰ä¸€ä¸ªåˆ¤é‡å¤„ç†ï¼Œcomputed å¯¹è±¡ä¸­çš„å±æ€§ä¸èƒ½å’Œ dataã€props ä¸­çš„å±æ€§ç›¸åŒ
      if (key in vm.$data) {
        warn(`The computed property "${key}" is already defined in data.`, vm)
      } else if (vm.$options.props && key in vm.$options.props) {
        warn(`The computed property "${key}" is already defined as a prop.`, vm)
      }
    }
  }
}

/**
 * ä»£ç† computed å¯¹è±¡ä¸­çš„ key åˆ° targetï¼ˆvmï¼‰ä¸Š
 */
export function defineComputed (
  target: any,
  key: string,
  userDef: Object | Function
) {
  const shouldCache = !isServerRendering()
  // æ„é€ å±æ€§æè¿°ç¬¦(getã€set)
  if (typeof userDef === 'function') {
    sharedPropertyDefinition.get = shouldCache
      ? createComputedGetter(key)
      : createGetterInvoker(userDef)
    sharedPropertyDefinition.set = noop
  } else {
    sharedPropertyDefinition.get = userDef.get
      ? shouldCache && userDef.cache !== false
        ? createComputedGetter(key)
        : createGetterInvoker(userDef.get)
      : noop
    sharedPropertyDefinition.set = userDef.set || noop
  }
  if (process.env.NODE_ENV !== 'production' &&
      sharedPropertyDefinition.set === noop) {
    sharedPropertyDefinition.set = function () {
      warn(
        `Computed property "${key}" was assigned to but it has no setter.`,
        this
      )
    }
  }
  // æ‹¦æˆªå¯¹ target.key çš„è®¿é—®å’Œè®¾ç½®
  Object.defineProperty(target, key, sharedPropertyDefinition)
}

/**
 * @returns è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨è®¿é—® vm.computedProperty æ—¶ä¼šè¢«æ‰§è¡Œï¼Œç„¶åè¿”å›æ‰§è¡Œç»“æœ
 */
function createComputedGetter (key) {
  // computed å±æ€§å€¼ä¼šç¼“å­˜çš„åŸç†ä¹Ÿæ˜¯åœ¨è¿™é‡Œç»“åˆ watcher.dirtyã€watcher.evalauteã€watcher.update å®ç°çš„
  return function computedGetter () {
    // å¾—åˆ°å½“å‰ key å¯¹åº”çš„ watcher
    const watcher = this._computedWatchers && this._computedWatchers[key]
    if (watcher) {
      // è®¡ç®— key å¯¹åº”çš„å€¼ï¼Œé€šè¿‡æ‰§è¡Œ computed.key çš„å›è°ƒå‡½æ•°æ¥å¾—åˆ°
      // watcher.dirty å±æ€§å°±æ˜¯å¤§å®¶å¸¸è¯´çš„ computed è®¡ç®—ç»“æœä¼šç¼“å­˜çš„åŸç†
      // <template>
      //   <div>{{ computedProperty }}</div>
      //   <div>{{ computedProperty }}</div>
      // </template>
      // åƒè¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨é¡µé¢çš„ä¸€æ¬¡æ¸²æŸ“ä¸­ï¼Œä¸¤ä¸ª dom ä¸­çš„ computedProperty åªæœ‰ç¬¬ä¸€ä¸ª
      // ä¼šæ‰§è¡Œ computed.computedProperty çš„å›è°ƒå‡½æ•°è®¡ç®—å®é™…çš„å€¼ï¼Œ
      // å³æ‰§è¡Œ watcher.evalauteï¼Œè€Œç¬¬äºŒä¸ªå°±ä¸èµ°è®¡ç®—è¿‡ç¨‹äº†ï¼Œ
      // å› ä¸ºä¸Šä¸€æ¬¡æ‰§è¡Œ watcher.evalute æ—¶æŠŠ watcher.dirty ç½®ä¸ºäº† falseï¼Œ
      // å¾…é¡µé¢æ›´æ–°åï¼Œwathcer.update æ–¹æ³•ä¼šå°† watcher.dirty é‡æ–°ç½®ä¸º trueï¼Œ
      // ä¾›ä¸‹æ¬¡é¡µé¢æ›´æ–°æ—¶é‡æ–°è®¡ç®— computed.key çš„ç»“æœ
      if (watcher.dirty) {
        watcher.evaluate()
      }
      if (Dep.target) {
        watcher.depend()
      }
      return watcher.value
    }
  }
}

/**
 * åŠŸèƒ½åŒ createComputedGetter ä¸€æ ·
 */
function createGetterInvoker(fn) {
  return function computedGetter () {
    return fn.call(this, this)
  }
}

å¤åˆ¶ä»£ç 
```

## initWatch

> /src/core/instance/state.js

```javascript
/**
 * å¤„ç† watch å¯¹è±¡çš„å…¥å£ï¼Œåšäº†ä¸¤ä»¶äº‹ï¼š
 *   1ã€éå† watch å¯¹è±¡
 *   2ã€è°ƒç”¨ createWatcher å‡½æ•°
 * @param {*} watch = {
 *   'key1': function(val, oldVal) {},
 *   'key2': 'this.methodName',
 *   'key3': {
 *     handler: function(val, oldVal) {},
 *     deep: true
 *   },
 *   'key4': [
 *     'this.methodNanme',
 *     function handler1() {},
 *     {
 *       handler: function() {},
 *       immediate: true
 *     }
 *   ],
 *   'key.key5' { ... }
 * }
 */
function initWatch (vm: Component, watch: Object) {
  // éå† watch å¯¹è±¡
  for (const key in watch) {
    const handler = watch[key]
    if (Array.isArray(handler)) {
      // handler ä¸ºæ•°ç»„ï¼Œéå†æ•°ç»„ï¼Œè·å–å…¶ä¸­çš„æ¯ä¸€é¡¹ï¼Œç„¶åè°ƒç”¨ createWatcher
      for (let i = 0; i < handler.length; i++) {
        createWatcher(vm, key, handler[i])
      }
    } else {
      createWatcher(vm, key, handler)
    }
  }
}

/**
 * ä¸¤ä»¶äº‹ï¼š
 *   1ã€å…¼å®¹æ€§å¤„ç†ï¼Œä¿è¯ handler è‚¯å®šæ˜¯ä¸€ä¸ªå‡½æ•°
 *   2ã€è°ƒç”¨ $watch 
 * @returns 
 */
function createWatcher (
  vm: Component,
  expOrFn: string | Function,
  handler: any,
  options?: Object
) {
  // å¦‚æœ handler ä¸ºå¯¹è±¡ï¼Œåˆ™è·å–å…¶ä¸­çš„ handler é€‰é¡¹çš„å€¼
  if (isPlainObject(handler)) {
    options = handler
    handler = handler.handler
  }
  // å¦‚æœ hander ä¸ºå­—ç¬¦ä¸²ï¼Œåˆ™è¯´æ˜æ˜¯ä¸€ä¸ª methods æ–¹æ³•ï¼Œè·å– vm[handler]
  if (typeof handler === 'string') {
    handler = vm[handler]
  }
  return vm.$watch(expOrFn, handler, options)
}

/**
 * åˆ›å»º watcherï¼Œè¿”å› unwatchï¼Œå…±å®Œæˆå¦‚ä¸‹ 5 ä»¶äº‹ï¼š
 *   1ã€å…¼å®¹æ€§å¤„ç†ï¼Œä¿è¯æœ€å new Watcher æ—¶çš„ cb ä¸ºå‡½æ•°
 *   2ã€æ ‡ç¤ºç”¨æˆ· watcher
 *   3ã€åˆ›å»º watcher å®ä¾‹
 *   4ã€å¦‚æœè®¾ç½®äº† immediateï¼Œåˆ™ç«‹å³æ‰§è¡Œä¸€æ¬¡ cb
 *   5ã€è¿”å› unwatch
 * @param {*} expOrFn key
 * @param {*} cb å›è°ƒå‡½æ•°
 * @param {*} options é…ç½®é¡¹ï¼Œç”¨æˆ·ç›´æ¥è°ƒç”¨ this.$watch æ—¶å¯èƒ½ä¼šä¼ é€’ä¸€ä¸ª é…ç½®é¡¹
 * @returns è¿”å› unwatch å‡½æ•°ï¼Œç”¨äºå–æ¶ˆ watch ç›‘å¬
 */
Vue.prototype.$watch = function (
  expOrFn: string | Function,
  cb: any,
  options?: Object
): Function {
  const vm: Component = this
  // å…¼å®¹æ€§å¤„ç†ï¼Œå› ä¸ºç”¨æˆ·è°ƒç”¨ vm.$watch æ—¶è®¾ç½®çš„ cb å¯èƒ½æ˜¯å¯¹è±¡
  if (isPlainObject(cb)) {
    return createWatcher(vm, expOrFn, cb, options)
  }
  // options.user è¡¨ç¤ºç”¨æˆ· watcherï¼Œè¿˜æœ‰æ¸²æŸ“ watcherï¼Œå³ updateComponent æ–¹æ³•ä¸­å®ä¾‹åŒ–çš„ watcher
  options = options || {}
  options.user = true
  // åˆ›å»º watcher
  const watcher = new Watcher(vm, expOrFn, cb, options)
  // å¦‚æœç”¨æˆ·è®¾ç½®äº† immediate ä¸º trueï¼Œåˆ™ç«‹å³æ‰§è¡Œä¸€æ¬¡å›è°ƒå‡½æ•°
  if (options.immediate) {
    try {
      cb.call(vm, watcher.value)
    } catch (error) {
      handleError(error, vm, `callback for immediate watcher "${watcher.expression}"`)
    }
  }
  // è¿”å›ä¸€ä¸ª unwatch å‡½æ•°ï¼Œç”¨äºè§£é™¤ç›‘å¬
  return function unwatchFn () {
    watcher.teardown()
  }
}
å¤åˆ¶ä»£ç 
```

## observe

> /src/core/observer/index.js

```javascript
/**
 * å“åº”å¼å¤„ç†çš„çœŸæ­£å…¥å£
 * ä¸ºå¯¹è±¡åˆ›å»ºè§‚å¯Ÿè€…å®ä¾‹ï¼Œå¦‚æœå¯¹è±¡å·²ç»è¢«è§‚å¯Ÿè¿‡ï¼Œåˆ™è¿”å›å·²æœ‰çš„è§‚å¯Ÿè€…å®ä¾‹ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„è§‚å¯Ÿè€…å®ä¾‹
 * @param {*} value å¯¹è±¡ => {}
 */
export function observe (value: any, asRootData: ?boolean): Observer | void {
  // éå¯¹è±¡å’Œ VNode å®ä¾‹ä¸åšå“åº”å¼å¤„ç†
  if (!isObject(value) || value instanceof VNode) {
    return
  }
  let ob: Observer | void
  if (hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {
    // å¦‚æœ value å¯¹è±¡ä¸Šå­˜åœ¨ __ob__ å±æ€§ï¼Œåˆ™è¡¨ç¤ºå·²ç»åšè¿‡è§‚å¯Ÿäº†ï¼Œç›´æ¥è¿”å› __ob__ å±æ€§
    ob = value.__ob__
  } else if (
    shouldObserve &&
    !isServerRendering() &&
    (Array.isArray(value) || isPlainObject(value)) &&
    Object.isExtensible(value) &&
    !value._isVue
  ) {
    // åˆ›å»ºè§‚å¯Ÿè€…å®ä¾‹
    ob = new Observer(value)
  }
  if (asRootData && ob) {
    ob.vmCount++
  }
  return ob
}

å¤åˆ¶ä»£ç 
```

## Observer

> /src/core/observer/index.js

```javascript
/**
 * è§‚å¯Ÿè€…ç±»ï¼Œä¼šè¢«é™„åŠ åˆ°æ¯ä¸ªè¢«è§‚å¯Ÿçš„å¯¹è±¡ä¸Šï¼Œvalue.__ob__ = this
 * è€Œå¯¹è±¡çš„å„ä¸ªå±æ€§åˆ™ä¼šè¢«è½¬æ¢æˆ getter/setterï¼Œå¹¶æ”¶é›†ä¾èµ–å’Œé€šçŸ¥æ›´æ–°
 */
export class Observer {
  value: any;
  dep: Dep;
  vmCount: number; // number of vms that have this object as root $data

  constructor (value: any) {
    this.value = value
    // å®ä¾‹è¯ä¸€ä¸ª dep
    this.dep = new Dep()
    this.vmCount = 0
    // åœ¨ value å¯¹è±¡ä¸Šè®¾ç½® __ob__ å±æ€§
    def(value, '__ob__', this)
    if (Array.isArray(value)) {
      /**
       * value ä¸ºæ•°ç»„
       * hasProto = '__proto__' in {}
       * ç”¨äºåˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜åœ¨ __proto__ å±æ€§ï¼Œé€šè¿‡ obj.__proto__ å¯ä»¥è®¿é—®å¯¹è±¡çš„åŸå‹é“¾
       * ä½†ç”±äº __proto__ ä¸æ˜¯æ ‡å‡†å±æ€§ï¼Œæ‰€ä»¥æœ‰äº›æµè§ˆå™¨ä¸æ”¯æŒï¼Œæ¯”å¦‚ IE6-10ï¼ŒOpera10.1
       * ä¸ºä»€ä¹ˆè¦åˆ¤æ–­ï¼Œæ˜¯å› ä¸ºä¸€ä¼šå„¿è¦é€šè¿‡ __proto__ æ“ä½œæ•°æ®çš„åŸå‹é“¾
       * è¦†ç›–æ•°ç»„é»˜è®¤çš„ä¸ƒä¸ªåŸå‹æ–¹æ³•ï¼Œä»¥å®ç°æ•°ç»„å“åº”å¼
       */
      if (hasProto) {
        // æœ‰ __proto__
        protoAugment(value, arrayMethods)
      } else {
        copyAugment(value, arrayMethods, arrayKeys)
      }
      this.observeArray(value)
    } else {
      // value ä¸ºå¯¹è±¡ï¼Œä¸ºå¯¹è±¡çš„æ¯ä¸ªå±æ€§ï¼ˆåŒ…æ‹¬åµŒå¥—å¯¹è±¡ï¼‰è®¾ç½®å“åº”å¼
      this.walk(value)
    }
  }

  /**
   * éå†å¯¹è±¡ä¸Šçš„æ¯ä¸ª keyï¼Œä¸ºæ¯ä¸ª key è®¾ç½®å“åº”å¼
   * ä»…å½“å€¼ä¸ºå¯¹è±¡æ—¶æ‰ä¼šèµ°è¿™é‡Œ
   */
  walk (obj: Object) {
    const keys = Object.keys(obj)
    for (let i = 0; i < keys.length; i++) {
      defineReactive(obj, keys[i])
    }
  }

  /**
   * éå†æ•°ç»„ï¼Œä¸ºæ•°ç»„çš„æ¯ä¸€é¡¹è®¾ç½®è§‚å¯Ÿï¼Œå¤„ç†æ•°ç»„å…ƒç´ ä¸ºå¯¹è±¡çš„æƒ…å†µ
   */
  observeArray (items: Array<any>) {
    for (let i = 0, l = items.length; i < l; i++) {
      observe(items[i])
    }
  }
}

å¤åˆ¶ä»£ç 
```

## defineReactive

> /src/core/observer/index.js

```javascript
/**
 * æ‹¦æˆª obj[key] çš„è¯»å–å’Œè®¾ç½®æ“ä½œï¼š
 *   1ã€åœ¨ç¬¬ä¸€æ¬¡è¯»å–æ—¶æ”¶é›†ä¾èµ–ï¼Œæ¯”å¦‚æ‰§è¡Œ render å‡½æ•°ç”Ÿæˆè™šæ‹Ÿ DOM æ—¶ä¼šæœ‰è¯»å–æ“ä½œ
 *   2ã€åœ¨æ›´æ–°æ—¶è®¾ç½®æ–°å€¼å¹¶é€šçŸ¥ä¾èµ–æ›´æ–°
 */
export function defineReactive (
  obj: Object,
  key: string,
  val: any,
  customSetter?: ?Function,
  shallow?: boolean
) {
  // å®ä¾‹åŒ– depï¼Œä¸€ä¸ª key ä¸€ä¸ª dep
  const dep = new Dep()

  // è·å– obj[key] çš„å±æ€§æè¿°ç¬¦ï¼Œå‘ç°å®ƒæ˜¯ä¸å¯é…ç½®å¯¹è±¡çš„è¯ç›´æ¥ return
  const property = Object.getOwnPropertyDescriptor(obj, key)
  if (property && property.configurable === false) {
    return
  }

  // è®°å½• getter å’Œ setterï¼Œè·å– val å€¼
  const getter = property && property.get
  const setter = property && property.set
  if ((!getter || setter) && arguments.length === 2) {
    val = obj[key]
  }

  // é€’å½’è°ƒç”¨ï¼Œå¤„ç† val å³ obj[key] çš„å€¼ä¸ºå¯¹è±¡çš„æƒ…å†µï¼Œä¿è¯å¯¹è±¡ä¸­çš„æ‰€æœ‰ key éƒ½è¢«è§‚å¯Ÿ
  let childOb = !shallow && observe(val)
  // å“åº”å¼æ ¸å¿ƒ
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    // get æ‹¦æˆªå¯¹ obj[key] çš„è¯»å–æ“ä½œ
    get: function reactiveGetter () {
      const value = getter ? getter.call(obj) : val
      /**
       * Dep.target ä¸º Dep ç±»çš„ä¸€ä¸ªé™æ€å±æ€§ï¼Œå€¼ä¸º watcherï¼Œåœ¨å®ä¾‹åŒ– Watcher æ—¶ä¼šè¢«è®¾ç½®
       * å®ä¾‹åŒ– Watcher æ—¶ä¼šæ‰§è¡Œ new Watcher æ—¶ä¼ é€’çš„å›è°ƒå‡½æ•°ï¼ˆcomputed é™¤å¤–ï¼Œå› ä¸ºå®ƒæ‡’æ‰§è¡Œï¼‰
       * è€Œå›è°ƒå‡½æ•°ä¸­å¦‚æœæœ‰ vm.key çš„è¯»å–è¡Œä¸ºï¼Œåˆ™ä¼šè§¦å‘è¿™é‡Œçš„ è¯»å– æ‹¦æˆªï¼Œè¿›è¡Œä¾èµ–æ”¶é›†
       * å›è°ƒå‡½æ•°æ‰§è¡Œå®Œä»¥ååˆä¼šå°† Dep.target è®¾ç½®ä¸º nullï¼Œé¿å…è¿™é‡Œé‡å¤æ”¶é›†ä¾èµ–
       */
      if (Dep.target) {
        // ä¾èµ–æ”¶é›†ï¼Œåœ¨ dep ä¸­æ·»åŠ  watcherï¼Œä¹Ÿåœ¨ watcher ä¸­æ·»åŠ  dep
        dep.depend()
        // childOb è¡¨ç¤ºå¯¹è±¡ä¸­åµŒå¥—å¯¹è±¡çš„è§‚å¯Ÿè€…å¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨ä¹Ÿå¯¹å…¶è¿›è¡Œä¾èµ–æ”¶é›†
        if (childOb) {
          // è¿™å°±æ˜¯ this.key.chidlKey è¢«æ›´æ–°æ—¶èƒ½è§¦å‘å“åº”å¼æ›´æ–°çš„åŸå› 
          childOb.dep.depend()
          // å¦‚æœæ˜¯ obj[key] æ˜¯ æ•°ç»„ï¼Œåˆ™è§¦å‘æ•°ç»„å“åº”å¼
          if (Array.isArray(value)) {
            // ä¸ºæ•°ç»„é¡¹ä¸ºå¯¹è±¡çš„é¡¹æ·»åŠ ä¾èµ–
            dependArray(value)
          }
        }
      }
      return value
    },
    // set æ‹¦æˆªå¯¹ obj[key] çš„è®¾ç½®æ“ä½œ
    set: function reactiveSetter (newVal) {
      // æ—§çš„ obj[key]
      const value = getter ? getter.call(obj) : val
      // å¦‚æœæ–°è€å€¼ä¸€æ ·ï¼Œåˆ™ç›´æ¥ returnï¼Œä¸è·Ÿæ–°æ›´ä¸è§¦å‘å“åº”å¼æ›´æ–°è¿‡ç¨‹
      /* eslint-disable no-self-compare */
      if (newVal === value || (newVal !== newVal && value !== value)) {
        return
      }
      /* eslint-enable no-self-compare */
      if (process.env.NODE_ENV !== 'production' && customSetter) {
        customSetter()
      }
      // setter ä¸å­˜åœ¨è¯´æ˜è¯¥å±æ€§æ˜¯ä¸€ä¸ªåªè¯»å±æ€§ï¼Œç›´æ¥ return
      // #7981: for accessor properties without setter
      if (getter && !setter) return
      // è®¾ç½®æ–°å€¼
      if (setter) {
        setter.call(obj, newVal)
      } else {
        val = newVal
      }
      // å¯¹æ–°å€¼è¿›è¡Œè§‚å¯Ÿï¼Œè®©æ–°å€¼ä¹Ÿæ˜¯å“åº”å¼çš„
      childOb = !shallow && observe(newVal)
      // ä¾èµ–é€šçŸ¥æ›´æ–°
      dep.notify()
    }
  })
}

å¤åˆ¶ä»£ç 
```

### dependArray

> /src/core/observer/index.js

```javascript
/**
 * éå†æ¯ä¸ªæ•°ç»„å…ƒç´ ï¼Œé€’å½’å¤„ç†æ•°ç»„é¡¹ä¸ºå¯¹è±¡çš„æƒ…å†µï¼Œä¸ºå…¶æ·»åŠ ä¾èµ–
 * å› ä¸ºå‰é¢çš„é€’å½’é˜¶æ®µæ— æ³•ä¸ºæ•°ç»„ä¸­çš„å¯¹è±¡å…ƒç´ æ·»åŠ ä¾èµ–
 */
function dependArray (value: Array<any>) {
  for (let e, i = 0, l = value.length; i < l; i++) {
    e = value[i]
    e && e.__ob__ && e.__ob__.dep.depend()
    if (Array.isArray(e)) {
      dependArray(e)
    }
  }
}

å¤åˆ¶ä»£ç 
```

## æ•°ç»„å“åº”å¼

> src/core/observer/array.js

```javascript
/**
 * å®šä¹‰ arrayMethods å¯¹è±¡ï¼Œç”¨äºå¢å¼º Array.prototype
 * å½“è®¿é—® arrayMethods å¯¹è±¡ä¸Šçš„é‚£ä¸ƒä¸ªæ–¹æ³•æ—¶ä¼šè¢«æ‹¦æˆªï¼Œä»¥å®ç°æ•°ç»„å“åº”å¼
 */
import { def } from '../util/index'

// å¤‡ä»½ æ•°ç»„ åŸå‹å¯¹è±¡
const arrayProto = Array.prototype
// é€šè¿‡ç»§æ‰¿çš„æ–¹å¼åˆ›å»ºæ–°çš„ arrayMethods
export const arrayMethods = Object.create(arrayProto)

// æ“ä½œæ•°ç»„çš„ä¸ƒä¸ªæ–¹æ³•ï¼Œè¿™ä¸ƒä¸ªæ–¹æ³•å¯ä»¥æ”¹å˜æ•°ç»„è‡ªèº«
const methodsToPatch = [
  'push',
  'pop',
  'shift',
  'unshift',
  'splice',
  'sort',
  'reverse'
]

/**
 * æ‹¦æˆªå˜å¼‚æ–¹æ³•å¹¶è§¦å‘äº‹ä»¶
 */
methodsToPatch.forEach(function (method) {
  // cache original method
  // ç¼“å­˜åŸç”Ÿæ–¹æ³•ï¼Œæ¯”å¦‚ push
  const original = arrayProto[method]
  // def å°±æ˜¯ Object.definePropertyï¼Œæ‹¦æˆª arrayMethods.method çš„è®¿é—®
  def(arrayMethods, method, function mutator (...args) {
    // å…ˆæ‰§è¡ŒåŸç”Ÿæ–¹æ³•ï¼Œæ¯”å¦‚ push.apply(this, args)
    const result = original.apply(this, args)
    const ob = this.__ob__
    // å¦‚æœ method æ˜¯ä»¥ä¸‹ä¸‰ä¸ªä¹‹ä¸€ï¼Œè¯´æ˜æ˜¯æ–°æ’å…¥äº†å…ƒç´ 
    let inserted
    switch (method) {
      case 'push':
      case 'unshift':
        inserted = args
        break
      case 'splice':
        inserted = args.slice(2)
        break
    }
    // å¯¹æ–°æ’å…¥çš„å…ƒç´ åšå“åº”å¼å¤„ç†
    if (inserted) ob.observeArray(inserted)
    // é€šçŸ¥æ›´æ–°
    ob.dep.notify()
    return result
  })
})


å¤åˆ¶ä»£ç 
```

### def

> /src/core/util/lang.js

```javascript
/**
 * Define a property.
 */
export function def (obj: Object, key: string, val: any, enumerable?: boolean) {
  Object.defineProperty(obj, key, {
    value: val,
    enumerable: !!enumerable,
    writable: true,
    configurable: true
  })
}

å¤åˆ¶ä»£ç 
```

### protoAugment

> /src/core/observer/index.js

```javascript
/**
 * è®¾ç½® target.__proto__ çš„åŸå‹å¯¹è±¡ä¸º src
 * æ¯”å¦‚ æ•°ç»„å¯¹è±¡ï¼Œarr.__proto__ = arrayMethods
 */
function protoAugment (target, src: Object) {
  /* eslint-disable no-proto */
  target.__proto__ = src
  /* eslint-enable no-proto */
}

å¤åˆ¶ä»£ç 
```

### copyAugment

> /src/core/observer/index.js

```javascript
/**
 * åœ¨ç›®æ ‡å¯¹è±¡ä¸Šå®šä¹‰æŒ‡å®šå±æ€§
 * æ¯”å¦‚æ•°ç»„ï¼šä¸ºæ•°ç»„å¯¹è±¡å®šä¹‰é‚£ä¸ƒä¸ªæ–¹æ³•
 */
function copyAugment (target: Object, src: Object, keys: Array<string>) {
  for (let i = 0, l = keys.length; i < l; i++) {
    const key = keys[i]
    def(target, key, src[key])
  }
}

å¤åˆ¶ä»£ç 
```

## Dep

> /src/core/observer/dep.js

```javascript
import type Watcher from './watcher'
import { remove } from '../util/index'
import config from '../config'

let uid = 0

/**
 * ä¸€ä¸ª dep å¯¹åº”ä¸€ä¸ª obj.key
 * åœ¨è¯»å–å“åº”å¼æ•°æ®æ—¶ï¼Œè´Ÿè´£æ”¶é›†ä¾èµ–ï¼Œæ¯ä¸ª depï¼ˆæˆ–è€…è¯´ obj.keyï¼‰ä¾èµ–çš„ watcher æœ‰å“ªäº›
 * åœ¨å“åº”å¼æ•°æ®æ›´æ–°æ—¶ï¼Œè´Ÿè´£é€šçŸ¥ dep ä¸­é‚£äº› watcher å»æ‰§è¡Œ update æ–¹æ³•
 */
export default class Dep {
  static target: ?Watcher;
  id: number;
  subs: Array<Watcher>;

  constructor () {
    this.id = uid++
    this.subs = []
  }

  // åœ¨ dep ä¸­æ·»åŠ  watcher
  addSub (sub: Watcher) {
    this.subs.push(sub)
  }

  removeSub (sub: Watcher) {
    remove(this.subs, sub)
  }

  // åƒ watcher ä¸­æ·»åŠ  dep
  depend () {
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  /**
   * é€šçŸ¥ dep ä¸­çš„æ‰€æœ‰ watcherï¼Œæ‰§è¡Œ watcher.update() æ–¹æ³•
   */
  notify () {
    // stabilize the subscriber list first
    const subs = this.subs.slice()
    if (process.env.NODE_ENV !== 'production' && !config.async) {
      // subs aren't sorted in scheduler if not running async
      // we need to sort them now to make sure they fire in correct
      // order
      subs.sort((a, b) => a.id - b.id)
    }
    // éå† dep ä¸­å­˜å‚¨çš„ watcherï¼Œæ‰§è¡Œ watcher.update()
    for (let i = 0, l = subs.length; i < l; i++) {
      subs[i].update()
    }
  }
}

/**
 * å½“å‰æ­£åœ¨æ‰§è¡Œçš„ watcherï¼ŒåŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ª watcher åœ¨æ‰§è¡Œ
 * Dep.target = å½“å‰æ­£åœ¨æ‰§è¡Œçš„ watcher
 * é€šè¿‡è°ƒç”¨ pushTarget æ–¹æ³•å®Œæˆèµ‹å€¼ï¼Œè°ƒç”¨ popTarget æ–¹æ³•å®Œæˆé‡ç½®ï¼ˆnull)
 */
Dep.target = null
const targetStack = []

// åœ¨éœ€è¦è¿›è¡Œä¾èµ–æ”¶é›†çš„æ—¶å€™è°ƒç”¨ï¼Œè®¾ç½® Dep.target = watcher
export function pushTarget (target: ?Watcher) {
  targetStack.push(target)
  Dep.target = target
}

// ä¾èµ–æ”¶é›†ç»“æŸè°ƒç”¨ï¼Œè®¾ç½® Dep.target = null
export function popTarget () {
  targetStack.pop()
  Dep.target = targetStack[targetStack.length - 1]
}

å¤åˆ¶ä»£ç 
```

## Watcher

> /src/core/observer/watcher.js

```javascript
/**
 * ä¸€ä¸ªç»„ä»¶ä¸€ä¸ª watcherï¼ˆæ¸²æŸ“ watcherï¼‰æˆ–è€…ä¸€ä¸ªè¡¨è¾¾å¼ä¸€ä¸ª watcherï¼ˆç”¨æˆ·watcherï¼‰
 * å½“æ•°æ®æ›´æ–°æ—¶ watcher ä¼šè¢«è§¦å‘ï¼Œè®¿é—® this.computedProperty æ—¶ä¹Ÿä¼šè§¦å‘ watcher
 */
export default class Watcher {
  vm: Component;
  expression: string;
  cb: Function;
  id: number;
  deep: boolean;
  user: boolean;
  lazy: boolean;
  sync: boolean;
  dirty: boolean;
  active: boolean;
  deps: Array<Dep>;
  newDeps: Array<Dep>;
  depIds: SimpleSet;
  newDepIds: SimpleSet;
  before: ?Function;
  getter: Function;
  value: any;

  constructor (
    vm: Component,
    expOrFn: string | Function,
    cb: Function,
    options?: ?Object,
    isRenderWatcher?: boolean
  ) {
    this.vm = vm
    if (isRenderWatcher) {
      vm._watcher = this
    }
    vm._watchers.push(this)
    // options
    if (options) {
      this.deep = !!options.deep
      this.user = !!options.user
      this.lazy = !!options.lazy
      this.sync = !!options.sync
      this.before = options.before
    } else {
      this.deep = this.user = this.lazy = this.sync = false
    }
    this.cb = cb
    this.id = ++uid // uid for batching
    this.active = true
    this.dirty = this.lazy // for lazy watchers
    this.deps = []
    this.newDeps = []
    this.depIds = new Set()
    this.newDepIds = new Set()
    this.expression = process.env.NODE_ENV !== 'production'
      ? expOrFn.toString()
      : ''
    // parse expression for getter
    if (typeof expOrFn === 'function') {
      this.getter = expOrFn
    } else {
      // this.getter = function() { return this.xx }
      // åœ¨ this.get ä¸­æ‰§è¡Œ this.getter æ—¶ä¼šè§¦å‘ä¾èµ–æ”¶é›†
      // å¾…åç»­ this.xx æ›´æ–°æ—¶å°±ä¼šè§¦å‘å“åº”å¼
      this.getter = parsePath(expOrFn)
      if (!this.getter) {
        this.getter = noop
        process.env.NODE_ENV !== 'production' && warn(
          `Failed watching path: "${expOrFn}" ` +
          'Watcher only accepts simple dot-delimited paths. ' +
          'For full control, use a function instead.',
          vm
        )
      }
    }
    this.value = this.lazy
      ? undefined
      : this.get()
  }

  /**
   * æ‰§è¡Œ this.getterï¼Œå¹¶é‡æ–°æ”¶é›†ä¾èµ–
   * this.getter æ˜¯å®ä¾‹åŒ– watcher æ—¶ä¼ é€’çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¸€ä¸ªå‡½æ•°æˆ–è€…å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ï¼šupdateComponent æˆ–è€… parsePath è¿”å›çš„è¯»å– this.xx å±æ€§å€¼çš„å‡½æ•°
   * ä¸ºä»€ä¹ˆè¦é‡æ–°æ”¶é›†ä¾èµ–ï¼Ÿ
   *   å› ä¸ºè§¦å‘æ›´æ–°è¯´æ˜æœ‰å“åº”å¼æ•°æ®è¢«æ›´æ–°äº†ï¼Œä½†æ˜¯è¢«æ›´æ–°çš„æ•°æ®è™½ç„¶å·²ç»ç»è¿‡ observe è§‚å¯Ÿäº†ï¼Œä½†æ˜¯å´æ²¡æœ‰è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œ
   *   æ‰€ä»¥ï¼Œåœ¨æ›´æ–°é¡µé¢æ—¶ï¼Œä¼šé‡æ–°æ‰§è¡Œä¸€æ¬¡ render å‡½æ•°ï¼Œæ‰§è¡ŒæœŸé—´ä¼šè§¦å‘è¯»å–æ“ä½œï¼Œè¿™æ—¶å€™è¿›è¡Œä¾èµ–æ”¶é›†
   */
  get () {
    // æ‰“å¼€ Dep.targetï¼ŒDep.target = this
    pushTarget(this)
    // value ä¸ºå›è°ƒå‡½æ•°æ‰§è¡Œçš„ç»“æœ
    let value
    const vm = this.vm
    try {
      // æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œæ¯”å¦‚ updateComponentï¼Œè¿›å…¥ patch é˜¶æ®µ
      value = this.getter.call(vm, vm)
    } catch (e) {
      if (this.user) {
        handleError(e, vm, `getter for watcher "${this.expression}"`)
      } else {
        throw e
      }
    } finally {
      // "touch" every property so they are all tracked as
      // dependencies for deep watching
      if (this.deep) {
        traverse(value)
      }
      // å…³é—­ Dep.targetï¼ŒDep.target = null
      popTarget()
      this.cleanupDeps()
    }
    return value
  }

  /**
   * Add a dependency to this directive.
   * ä¸¤ä»¶äº‹ï¼š
   *   1ã€æ·»åŠ  dep ç»™è‡ªå·±ï¼ˆwatcherï¼‰
   *   2ã€æ·»åŠ è‡ªå·±ï¼ˆwatcherï¼‰åˆ° dep
   */
  addDep (dep: Dep) {
    // åˆ¤é‡ï¼Œå¦‚æœ dep å·²ç»å­˜åœ¨åˆ™ä¸é‡å¤æ·»åŠ 
    const id = dep.id
    if (!this.newDepIds.has(id)) {
      // ç¼“å­˜ dep.idï¼Œç”¨äºåˆ¤é‡
      this.newDepIds.add(id)
      // æ·»åŠ  dep
      this.newDeps.push(dep)
      // é¿å…åœ¨ dep ä¸­é‡å¤æ·»åŠ  watcherï¼Œthis.depIds çš„è®¾ç½®åœ¨ cleanupDeps æ–¹æ³•ä¸­
      if (!this.depIds.has(id)) {
        // æ·»åŠ  watcher è‡ªå·±åˆ° dep
        dep.addSub(this)
      }
    }
  }

  /**
   * Clean up for dependency collection.
   */
  cleanupDeps () {
    let i = this.deps.length
    while (i--) {
      const dep = this.deps[i]
      if (!this.newDepIds.has(dep.id)) {
        dep.removeSub(this)
      }
    }
    let tmp = this.depIds
    this.depIds = this.newDepIds
    this.newDepIds = tmp
    this.newDepIds.clear()
    tmp = this.deps
    this.deps = this.newDeps
    this.newDeps = tmp
    this.newDeps.length = 0
  }

  /**
   * æ ¹æ® watcher é…ç½®é¡¹ï¼Œå†³å®šæ¥ä¸‹æ¥æ€ä¹ˆèµ°ï¼Œä¸€èˆ¬æ˜¯ queueWatcher
   */
  update () {
    /* istanbul ignore else */
    if (this.lazy) {
      // æ‡’æ‰§è¡Œæ—¶èµ°è¿™é‡Œï¼Œæ¯”å¦‚ computed

      // å°† dirty ç½®ä¸º trueï¼Œå¯ä»¥è®© computedGetter æ‰§è¡Œæ—¶é‡æ–°è®¡ç®— computed å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ
      this.dirty = true
    } else if (this.sync) {
      // åŒæ­¥æ‰§è¡Œï¼Œåœ¨ä½¿ç”¨ vm.$watch æˆ–è€… watch é€‰é¡¹æ—¶å¯ä»¥ä¼ ä¸€ä¸ª sync é€‰é¡¹ï¼Œ
      // å½“ä¸º true æ—¶åœ¨æ•°æ®æ›´æ–°æ—¶è¯¥ watcher å°±ä¸èµ°å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—ï¼Œç›´æ¥æ‰§è¡Œ this.run 
      // æ–¹æ³•è¿›è¡Œæ›´æ–°
      // è¿™ä¸ªå±æ€§åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ²¡æœ‰å‡ºç°
      this.run()
    } else {
      // æ›´æ–°æ—¶ä¸€èˆ¬éƒ½è¿™é‡Œï¼Œå°† watcher æ”¾å…¥ watcher é˜Ÿåˆ—
      queueWatcher(this)
    }
  }

  /**
   * ç”± åˆ·æ–°é˜Ÿåˆ—å‡½æ•° flushSchedulerQueue è°ƒç”¨ï¼Œå®Œæˆå¦‚ä¸‹å‡ ä»¶äº‹ï¼š
   *   1ã€æ‰§è¡Œå®ä¾‹åŒ– watcher ä¼ é€’çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ŒupdateComponent æˆ–è€… è·å– this.xx çš„ä¸€ä¸ªå‡½æ•°(parsePath è¿”å›çš„å‡½æ•°)
   *   2ã€æ›´æ–°æ—§å€¼ä¸ºæ–°å€¼
   *   3ã€æ‰§è¡Œå®ä¾‹åŒ– watcher æ—¶ä¼ é€’çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ¯”å¦‚ç”¨æˆ· watcher çš„å›è°ƒå‡½æ•°
   */
  run () {
    if (this.active) {
      // è°ƒç”¨ this.get æ–¹æ³•
      const value = this.get()
      if (
        value !== this.value ||
        // Deep watchers and watchers on Object/Arrays should fire even
        // when the value is the same, because the value may
        // have mutated.
        isObject(value) ||
        this.deep
      ) {
        // æ›´æ–°æ—§å€¼ä¸ºæ–°å€¼
        const oldValue = this.value
        this.value = value

        if (this.user) {
          // å¦‚æœæ˜¯ç”¨æˆ· watcherï¼Œåˆ™æ‰§è¡Œç”¨æˆ·ä¼ é€’çš„ç¬¬ä¸‰ä¸ªå‚æ•° â€”â€” å›è°ƒå‡½æ•°ï¼Œå‚æ•°ä¸º val å’Œ oldVal
          try {
            this.cb.call(this.vm, value, oldValue)
          } catch (e) {
            handleError(e, this.vm, `callback for watcher "${this.expression}"`)
          }
        } else {
          // æ¸²æŸ“ watcherï¼Œthis.cb = noopï¼Œä¸€ä¸ªç©ºå‡½æ•°
          this.cb.call(this.vm, value, oldValue)
        }
      }
    }
  }

  /**
   * æ‡’æ‰§è¡Œçš„ watcher ä¼šè°ƒç”¨è¯¥æ–¹æ³•
   *   æ¯”å¦‚ï¼šcomputedï¼Œåœ¨è·å– vm.computedProperty çš„å€¼æ—¶ä¼šè°ƒç”¨è¯¥æ–¹æ³•
   * ç„¶åæ‰§è¡Œ this.getï¼Œå³ watcher çš„å›è°ƒå‡½æ•°ï¼Œå¾—åˆ°è¿”å›å€¼
   * this.dirty è¢«ç½®ä¸º falseï¼Œä½œç”¨æ˜¯é¡µé¢åœ¨æœ¬æ¬¡æ¸²æŸ“ä¸­åªä¼šä¸€æ¬¡ computed.key çš„å›è°ƒå‡½æ•°ï¼Œ
   *   è¿™ä¹Ÿæ˜¯å¤§å®¶å¸¸è¯´çš„ computed å’Œ methods åŒºåˆ«ä¹‹ä¸€æ˜¯ computed æœ‰ç¼“å­˜çš„åŸç†æ‰€åœ¨
   * è€Œé¡µé¢æ›´æ–°åä¼š this.dirty ä¼šè¢«é‡æ–°ç½®ä¸º trueï¼Œè¿™ä¸€æ­¥æ˜¯åœ¨ this.update æ–¹æ³•ä¸­å®Œæˆçš„
   */
  evaluate () {
    this.value = this.get()
    this.dirty = false
  }

  /**
   * Depend on all deps collected by this watcher.
   */
  depend () {
    let i = this.deps.length
    while (i--) {
      this.deps[i].depend()
    }
  }

  /**
   * Remove self from all dependencies' subscriber list.
   */
  teardown () {
    if (this.active) {
      // remove self from vm's watcher list
      // this is a somewhat expensive operation so we skip it
      // if the vm is being destroyed.
      if (!this.vm._isBeingDestroyed) {
        remove(this.vm._watchers, this)
      }
      let i = this.deps.length
      while (i--) {
        this.deps[i].removeSub(this)
      }
      this.active = false
    }
  }
}

å¤åˆ¶ä»£ç 
```

# æ€»ç»“

**é¢è¯•å®˜ é—®**ï¼šVue å“åº”å¼åŸç†æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

**ç­”**ï¼š

- å“åº”å¼çš„æ ¸å¿ƒæ˜¯é€šè¿‡ `Object.defineProperty` æ‹¦æˆªå¯¹æ•°æ®çš„è®¿é—®å’Œè®¾ç½®
- å“åº”å¼çš„æ•°æ®åˆ†ä¸ºä¸¤ç±»ï¼š
  - å¯¹è±¡ï¼Œå¾ªç¯éå†å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œä¸ºæ¯ä¸ªå±æ€§è®¾ç½® getterã€setterï¼Œä»¥è¾¾åˆ°æ‹¦æˆªè®¿é—®å’Œè®¾ç½®çš„ç›®çš„ï¼Œå¦‚æœå±æ€§å€¼ä¾æ—§ä¸ºå¯¹è±¡ï¼Œåˆ™é€’å½’ä¸ºå±æ€§å€¼ä¸Šçš„æ¯ä¸ª key è®¾ç½® getterã€setter
    - è®¿é—®æ•°æ®æ—¶ï¼ˆobj.key)è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œåœ¨ dep ä¸­å­˜å‚¨ç›¸å…³çš„ watcher
    - è®¾ç½®æ•°æ®æ—¶ç”± dep é€šçŸ¥ç›¸å…³çš„ watcher å»æ›´æ–°
  - æ•°ç»„ï¼Œå¢å¼ºæ•°ç»„çš„é‚£ 7 ä¸ªå¯ä»¥æ›´æ”¹è‡ªèº«çš„åŸå‹æ–¹æ³•ï¼Œç„¶åæ‹¦æˆªå¯¹è¿™äº›æ–¹æ³•çš„æ“ä½œ
    - æ·»åŠ æ–°æ•°æ®æ—¶è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œç„¶åç”± dep é€šçŸ¥ watcher å»æ›´æ–°
    - åˆ é™¤æ•°æ®æ—¶ï¼Œä¹Ÿè¦ç”± dep é€šçŸ¥ watcher å»æ›´æ–°

**é¢è¯•å®˜ é—®**ï¼šmethodsã€computed å’Œ watch æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**ç­”**ï¼š

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <title>methodsã€computedã€watch æœ‰ä»€ä¹ˆåŒºåˆ«</title>
</head>

<body>
  <div id="app">
    <!-- methods -->
    <div>{{ returnMsg() }}</div>
    <div>{{ returnMsg() }}</div>
    <!-- computed -->
    <div>{{ getMsg }}</div>
    <div>{{ getMsg }}</div>
  </div>
  <script src="../../dist/vue.js"></script>
  <script>
    new Vue({
    el: '#app',
    data: {
      msg: 'test'
    },
    mounted() {
      setTimeout(() => {
        this.msg = 'msg is changed'
      }, 1000)
    },
    methods: {
      returnMsg() {
        console.log('methods: returnMsg')
        return this.msg
      }
    },
    computed: {
      getMsg() {
        console.log('computed: getMsg')
        return this.msg + ' hello computed'
      }
    },
    watch: {
      msg: function(val, oldVal) {
        console.log('watch: msg')
        new Promise(resolve => {
          setTimeout(() => {
            this.msg = 'msg is changed by watch'
          }, 1000)
        })
      }
    }
  })
  </script>
</body>

</html>

å¤åˆ¶ä»£ç 
```

![methodsComputedWatch.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c957654bb484ae7ba4ace1b912cff03~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ç¤ºä¾‹å…¶å®å°±æ˜¯ç­”æ¡ˆäº†

- ä½¿ç”¨åœºæ™¯

  - methods ä¸€èˆ¬ç”¨äºå°è£…ä¸€äº›è¾ƒä¸ºå¤æ‚çš„å¤„ç†é€»è¾‘ï¼ˆåŒæ­¥ã€å¼‚æ­¥ï¼‰
  - computed ä¸€èˆ¬ç”¨äºå°è£…ä¸€äº›ç®€å•çš„åŒæ­¥é€»è¾‘ï¼Œå°†ç»è¿‡å¤„ç†çš„æ•°æ®è¿”å›ï¼Œç„¶åæ˜¾ç¤ºåœ¨æ¨¡ç‰ˆä¸­ï¼Œä»¥å‡è½»æ¨¡ç‰ˆçš„é‡é‡
  - watch ä¸€èˆ¬ç”¨äºå½“éœ€è¦åœ¨æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œå¼‚æ­¥æˆ–å¼€é”€è¾ƒå¤§çš„æ“ä½œ

- åŒºåˆ«

  - methods VS computed

    > é€šè¿‡ç¤ºä¾‹ä¼šå‘ç°ï¼Œå¦‚æœåœ¨ä¸€æ¬¡æ¸²æŸ“ä¸­ï¼Œæœ‰å¤šä¸ªåœ°æ–¹ä½¿ç”¨äº†åŒä¸€ä¸ª methods æˆ– computed å±æ€§ï¼Œmethods ä¼šè¢«æ‰§è¡Œå¤šæ¬¡ï¼Œè€Œ computed çš„å›è°ƒå‡½æ•°åˆ™åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚

    > é€šè¿‡é˜…è¯»æºç æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ä¸€æ¬¡æ¸²æŸ“ä¸­ï¼Œå¤šæ¬¡è®¿é—® computedPropertyï¼Œåªä¼šåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ computed å±æ€§çš„å›è°ƒå‡½æ•°ï¼Œåç»­çš„å…¶å®ƒè®¿é—®ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ç¬¬ä¸€æ¬¡çš„æ‰§è¡Œç»“æœï¼ˆwatcher.valueï¼‰ï¼Œè€Œè¿™ä¸€åˆ‡çš„å®ç°åŸç†åˆ™æ˜¯é€šè¿‡å¯¹ watcher.dirty å±æ€§çš„æ§åˆ¶å®ç°çš„ã€‚è€Œ methodsï¼Œæ¯ä¸€æ¬¡çš„è®¿é—®åˆ™æ˜¯ç®€å•çš„æ–¹æ³•è°ƒç”¨ï¼ˆthis.xxMethodsï¼‰ã€‚

  - computed VS watch

    > é€šè¿‡é˜…è¯»æºç æˆ‘ä»¬çŸ¥é“ï¼Œcomputed å’Œ watch çš„æœ¬è´¨æ˜¯ä¸€æ ·çš„ï¼Œå†…éƒ¨éƒ½æ˜¯é€šè¿‡ Watcher æ¥å®ç°çš„ï¼Œå…¶å®æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œéè¦è¯´åŒºåˆ«çš„åŒ–å°±ä¸¤ç‚¹ï¼š1ã€ä½¿ç”¨åœºæ™¯ä¸Šçš„åŒºåˆ«ï¼Œ2ã€computed é»˜è®¤æ˜¯æ‡’æ‰§è¡Œçš„ï¼Œåˆ‡ä¸å¯æ›´æ”¹ã€‚

  - methods VS watch

    > methods å’Œ watch ä¹‹é—´å…¶å®æ²¡ä»€ä¹ˆå¯æ¯”çš„ï¼Œå®Œå…¨æ˜¯ä¸¤ä¸ªä¸œè¥¿ï¼Œä¸è¿‡åœ¨ä½¿ç”¨ä¸Šå¯ä»¥æŠŠ watch ä¸­ä¸€äº›é€»è¾‘æŠ½åˆ° methods ä¸­ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§ã€‚



ä½œè€…ï¼šææ°¸å®
é“¾æ¥ï¼šhttps://juejin.cn/post/6950826293923414047
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

# æ‰¾å…¥å£

æƒ³çŸ¥é“ `new Vue(options)` éƒ½åšäº†ä»€ä¹ˆï¼Œå°±å¾—å…ˆæ‰¾åˆ° Vue çš„æ„é€ å‡½æ•°æ˜¯åœ¨å“ªå£°æ˜çš„ï¼Œæœ‰ä¸¤ä¸ªåŠæ³•ï¼š

- ä» rollup é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°ç¼–è¯‘çš„å…¥å£ï¼Œç„¶åä¸€æ­¥æ­¥æ‰¾åˆ° Vue æ„é€ å‡½æ•°ï¼Œè¿™ç§æ–¹å¼ **è´¹åŠ²**
- é€šè¿‡ç¼–å†™ç¤ºä¾‹ä»£ç ï¼Œç„¶åæ‰“æ–­ç‚¹çš„æ–¹å¼ï¼Œä¸€æ­¥åˆ°ä½ï¼Œ**ç®€å•**

æˆ‘ä»¬å°±é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œå†™ç¤ºä¾‹ï¼Œæ‰“æ–­ç‚¹ï¼Œä¸€æ­¥åˆ°ä½ã€‚

- åœ¨ `/examples` ç›®å½•ä¸‹å¢åŠ ä¸€ä¸ªç¤ºä¾‹æ–‡ä»¶ â€”â€” `test.html`ï¼Œåœ¨æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vue æºç è§£è¯»</title>
</head>
<body>
  <div id="app">
    {{ msg }}
  </div>
  <script src="../dist/vue.js"></script>
  <script>
    debugger
    new Vue({
      el: '#app',
      data: {
        msg: 'hello vue'
      }
    })
  </script>
</body>
</html>
å¤åˆ¶ä»£ç 
```

- åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ§åˆ¶å°ï¼Œç„¶åæ‰“å¼€ `test.html`ï¼Œåˆ™ä¼šè¿›å…¥æ–­ç‚¹è°ƒè¯•ï¼Œç„¶åæ‰¾åˆ° Vue æ„é€ å‡½æ•°æ‰€åœ¨çš„æ–‡ä»¶

![Mar-26-2021 08-30-52.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d839ea6f3e5d4adcaf1ea9a8f6ff1a70~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å¾—åˆ° Vue æ„é€ å‡½æ•°åœ¨ `/src/core/instance/index.js` æ–‡ä»¶ä¸­ï¼Œæ¥ä¸‹æ¥æ­£å¼å¼€å§‹æºç é˜…è¯»ï¼Œå¸¦ç€ç›®æ ‡å»é˜…è¯»ã€‚

> åœ¨é˜…è¯»è¿‡ç¨‹ä¸­å¦‚é‡åˆ°çœ‹ä¸æ˜ç™½çš„åœ°æ–¹ï¼Œå¯é€šè¿‡ç¼–å†™ç¤ºä¾‹ä»£ç ï¼Œç„¶åä½¿ç”¨æµè§ˆå™¨çš„è°ƒè¯•åŠŸèƒ½è¿›è¡Œä¸€æ­¥æ­¥è°ƒè¯•ï¼Œé…åˆç†è§£ï¼Œå¦‚æœè¿˜æ˜¯ç†è§£ä¸äº†ï¼Œå°±åšä¸ªå¤‡æ³¨ç»§ç»­å‘åçœ‹ï¼Œä¹Ÿè®¸ä½ çœ‹åˆ°å…¶å®ƒåœ°æ–¹ï¼Œå°±çªç„¶æ˜ç™½è¿™ä¸ªåœ°æ–¹åœ¨åšä»€ä¹ˆï¼Œæˆ–è€…å›å¤´å†æ¥çœ‹ï¼Œå°±ä¼šæ‡‚äº†ï¼Œæºç è¿™ä¸ªä¸œè¥¿ï¼Œä¸€å®šè¦å¤šçœ‹ï¼Œè¦æƒ³ç²¾é€šï¼Œä¸€éä¸¤éè‚¯å®šæ˜¯ä¸å¤Ÿçš„

# æºç è§£è¯» â€”â€” Vue åˆå§‹åŒ–è¿‡ç¨‹

## Vue

> /src/core/instance/index.js

```javascript
import { initMixin } from './init'

// Vue æ„é€ å‡½æ•°
function Vue (options) {
  // è°ƒç”¨ Vue.prototype._init æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯åœ¨ initMixin ä¸­å®šä¹‰çš„
  this._init(options)
}

// å®šä¹‰ Vue.prototype._init æ–¹æ³•
initMixin(Vue)

export default Vue
å¤åˆ¶ä»£ç 
```

## Vue.prototype._init

> /src/core/instance/init.js

```javascript
/**
 * å®šä¹‰ Vue.prototype._init æ–¹æ³• 
 * @param {*} Vue Vue æ„é€ å‡½æ•°
 */
export function initMixin (Vue: Class<Component>) {
  // è´Ÿè´£ Vue çš„åˆå§‹åŒ–è¿‡ç¨‹
  Vue.prototype._init = function (options?: Object) {
    // vue å®ä¾‹
    const vm: Component = this
    // æ¯ä¸ª vue å®ä¾‹éƒ½æœ‰ä¸€ä¸ª _uidï¼Œå¹¶ä¸”æ˜¯ä¾æ¬¡é€’å¢çš„
    vm._uid = uid++

    // a flag to avoid this being observed
    vm._isVue = true
    // å¤„ç†ç»„ä»¶é…ç½®é¡¹
    if (options && options._isComponent) {
      /**
       * æ¯ä¸ªå­ç»„ä»¶åˆå§‹åŒ–æ—¶èµ°è¿™é‡Œï¼Œè¿™é‡Œåªåšäº†ä¸€äº›æ€§èƒ½ä¼˜åŒ–
       * å°†ç»„ä»¶é…ç½®å¯¹è±¡ä¸Šçš„ä¸€äº›æ·±å±‚æ¬¡å±æ€§æ”¾åˆ° vm.$options é€‰é¡¹ä¸­ï¼Œä»¥æé«˜ä»£ç çš„æ‰§è¡Œæ•ˆç‡
       */
      initInternalComponent(vm, options)
    } else {
      /**
       * åˆå§‹åŒ–æ ¹ç»„ä»¶æ—¶èµ°è¿™é‡Œï¼Œåˆå¹¶ Vue çš„å…¨å±€é…ç½®åˆ°æ ¹ç»„ä»¶çš„å±€éƒ¨é…ç½®ï¼Œæ¯”å¦‚ Vue.component æ³¨å†Œçš„å…¨å±€ç»„ä»¶ä¼šåˆå¹¶åˆ° æ ¹å®ä¾‹çš„ components é€‰é¡¹ä¸­
       * è‡³äºæ¯ä¸ªå­ç»„ä»¶çš„é€‰é¡¹åˆå¹¶åˆ™å‘ç”Ÿåœ¨ä¸¤ä¸ªåœ°æ–¹ï¼š
       *   1ã€Vue.component æ–¹æ³•æ³¨å†Œçš„å…¨å±€ç»„ä»¶åœ¨æ³¨å†Œæ—¶åšäº†é€‰é¡¹åˆå¹¶
       *   2ã€{ components: { xx } } æ–¹å¼æ³¨å†Œçš„å±€éƒ¨ç»„ä»¶åœ¨æ‰§è¡Œç¼–è¯‘å™¨ç”Ÿæˆçš„ render å‡½æ•°æ—¶åšäº†é€‰é¡¹åˆå¹¶ï¼ŒåŒ…æ‹¬æ ¹ç»„ä»¶ä¸­çš„ components é…ç½®
       */
      vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor),
        options || {},
        vm
      )
    }
    /* istanbul ignore else */
    if (process.env.NODE_ENV !== 'production') {
      // è®¾ç½®ä»£ç†ï¼Œå°† vm å®ä¾‹ä¸Šçš„å±æ€§ä»£ç†åˆ° vm._renderProxy
      initProxy(vm)
    } else {
      vm._renderProxy = vm
    }
    // expose real self
    vm._self = vm
    // åˆå§‹åŒ–ç»„ä»¶å®ä¾‹å…³ç³»å±æ€§ï¼Œæ¯”å¦‚ $parentã€$childrenã€$rootã€$refs ç­‰
    initLifecycle(vm)
    /**
     * åˆå§‹åŒ–è‡ªå®šä¹‰äº‹ä»¶ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ <comp @click="handleClick" /> ä¸Šæ³¨å†Œçš„äº‹ä»¶ï¼Œç›‘å¬è€…ä¸æ˜¯çˆ¶ç»„ä»¶ï¼Œ
     * è€Œæ˜¯å­ç»„ä»¶æœ¬èº«ï¼Œä¹Ÿå°±æ˜¯è¯´äº‹ä»¶çš„æ´¾å‘å’Œç›‘å¬è€…éƒ½æ˜¯å­ç»„ä»¶æœ¬èº«ï¼Œå’Œçˆ¶ç»„ä»¶æ— å…³
     */
    initEvents(vm)
    // è§£æç»„ä»¶çš„æ’æ§½ä¿¡æ¯ï¼Œå¾—åˆ° vm.$slotï¼Œå¤„ç†æ¸²æŸ“å‡½æ•°ï¼Œå¾—åˆ° vm.$createElement æ–¹æ³•ï¼Œå³ h å‡½æ•°
    initRender(vm)
    // è°ƒç”¨ beforeCreate é’©å­å‡½æ•°
    callHook(vm, 'beforeCreate')
    // åˆå§‹åŒ–ç»„ä»¶çš„ inject é…ç½®é¡¹ï¼Œå¾—åˆ° result[key] = val å½¢å¼çš„é…ç½®å¯¹è±¡ï¼Œç„¶åå¯¹ç»“æœæ•°æ®è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œå¹¶ä»£ç†æ¯ä¸ª key åˆ° vm å®ä¾‹
    initInjections(vm) // resolve injections before data/props
    // æ•°æ®å“åº”å¼çš„é‡ç‚¹ï¼Œå¤„ç† propsã€methodsã€dataã€computedã€watch
    initState(vm)
    // è§£æç»„ä»¶é…ç½®é¡¹ä¸Šçš„ provide å¯¹è±¡ï¼Œå°†å…¶æŒ‚è½½åˆ° vm._provided å±æ€§ä¸Š
    initProvide(vm) // resolve provide after data/props
    // è°ƒç”¨ created é’©å­å‡½æ•°
    callHook(vm, 'created')

    // å¦‚æœå‘ç°é…ç½®é¡¹ä¸Šæœ‰ el é€‰é¡¹ï¼Œåˆ™è‡ªåŠ¨è°ƒç”¨ $mount æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰äº† el é€‰é¡¹ï¼Œå°±ä¸éœ€è¦å†æ‰‹åŠ¨è°ƒç”¨ $mountï¼Œåä¹‹ï¼Œæ²¡æœ‰ el åˆ™å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ $mount
    if (vm.$options.el) {
      // è°ƒç”¨ $mount æ–¹æ³•ï¼Œè¿›å…¥æŒ‚è½½é˜¶æ®µ
      vm.$mount(vm.$options.el)
    }
  }
}

å¤åˆ¶ä»£ç 
```

## resolveConstructorOptions

> /src/core/instance/init.js

```javascript
/**
 * ä»ç»„ä»¶æ„é€ å‡½æ•°ä¸­è§£æé…ç½®å¯¹è±¡ optionsï¼Œå¹¶åˆå¹¶åŸºç±»é€‰é¡¹
 * @param {*} Ctor 
 * @returns 
 */
export function resolveConstructorOptions (Ctor: Class<Component>) {
  // é…ç½®é¡¹ç›®
  let options = Ctor.options
  if (Ctor.super) {
    // å­˜åœ¨åŸºç±»ï¼Œé€’å½’è§£æåŸºç±»æ„é€ å‡½æ•°çš„é€‰é¡¹
    const superOptions = resolveConstructorOptions(Ctor.super)
    const cachedSuperOptions = Ctor.superOptions
    if (superOptions !== cachedSuperOptions) {
      // è¯´æ˜åŸºç±»æ„é€ å‡½æ•°é€‰é¡¹å·²ç»å‘ç”Ÿæ”¹å˜ï¼Œéœ€è¦é‡æ–°è®¾ç½®
      Ctor.superOptions = superOptions
      // æ£€æŸ¥ Ctor.options ä¸Šæ˜¯å¦æœ‰ä»»ä½•åæœŸä¿®æ”¹/é™„åŠ çš„é€‰é¡¹ï¼ˆï¼ƒ4976ï¼‰
      const modifiedOptions = resolveModifiedOptions(Ctor)
      // å¦‚æœå­˜åœ¨è¢«ä¿®æ”¹æˆ–å¢åŠ çš„é€‰é¡¹ï¼Œåˆ™åˆå¹¶ä¸¤ä¸ªé€‰é¡¹
      if (modifiedOptions) {
        extend(Ctor.extendOptions, modifiedOptions)
      }
      // é€‰é¡¹åˆå¹¶ï¼Œå°†åˆå¹¶ç»“æœèµ‹å€¼ä¸º Ctor.options
      options = Ctor.options = mergeOptions(superOptions, Ctor.extendOptions)
      if (options.name) {
        options.components[options.name] = Ctor
      }
    }
  }
  return options
}

å¤åˆ¶ä»£ç 
```

## resolveModifiedOptions

> /src/core/instance/init.js

```javascript
/**
 * è§£ææ„é€ å‡½æ•°é€‰é¡¹ä¸­åç»­è¢«ä¿®æ”¹æˆ–è€…å¢åŠ çš„é€‰é¡¹
 */
function resolveModifiedOptions (Ctor: Class<Component>): ?Object {
  let modified
  // æ„é€ å‡½æ•°é€‰é¡¹
  const latest = Ctor.options
  // å¯†å°çš„æ„é€ å‡½æ•°é€‰é¡¹ï¼Œå¤‡ä»½
  const sealed = Ctor.sealedOptions
  // å¯¹æ¯”ä¸¤ä¸ªé€‰é¡¹ï¼Œè®°å½•ä¸ä¸€è‡´çš„é€‰é¡¹
  for (const key in latest) {
    if (latest[key] !== sealed[key]) {
      if (!modified) modified = {}
      modified[key] = latest[key]
    }
  }
  return modified
}

å¤åˆ¶ä»£ç 
```

## mergeOptions

> /src/core/util/options.js

```javascript
/**
 * åˆå¹¶ä¸¤ä¸ªé€‰é¡¹ï¼Œå‡ºç°ç›¸åŒé…ç½®é¡¹æ—¶ï¼Œå­é€‰é¡¹ä¼šè¦†ç›–çˆ¶é€‰é¡¹çš„é…ç½®
 */
export function mergeOptions (
  parent: Object,
  child: Object,
  vm?: Component
): Object {
  if (process.env.NODE_ENV !== 'production') {
    checkComponents(child)
  }

  if (typeof child === 'function') {
    child = child.options
  }

  // æ ‡å‡†åŒ– propsã€injectã€directive é€‰é¡¹ï¼Œæ–¹ä¾¿åç»­ç¨‹åºçš„å¤„ç†
  normalizeProps(child, vm)
  normalizeInject(child, vm)
  normalizeDirectives(child)

  // å¤„ç†åŸå§‹ child å¯¹è±¡ä¸Šçš„ extends å’Œ mixinsï¼Œåˆ†åˆ«æ‰§è¡Œ mergeOptionsï¼Œå°†è¿™äº›ç»§æ‰¿è€Œæ¥çš„é€‰é¡¹åˆå¹¶åˆ° parent
  // mergeOptions å¤„ç†è¿‡çš„å¯¹è±¡ä¼šå«æœ‰ _base å±æ€§
  if (!child._base) {
    if (child.extends) {
      parent = mergeOptions(parent, child.extends, vm)
    }
    if (child.mixins) {
      for (let i = 0, l = child.mixins.length; i < l; i++) {
        parent = mergeOptions(parent, child.mixins[i], vm)
      }
    }
  }

  const options = {}
  let key
  // éå† çˆ¶é€‰é¡¹
  for (key in parent) {
    mergeField(key)
  }

  // éå† å­é€‰é¡¹ï¼Œå¦‚æœçˆ¶é€‰é¡¹ä¸å­˜åœ¨è¯¥é…ç½®ï¼Œåˆ™åˆå¹¶ï¼Œå¦åˆ™è·³è¿‡ï¼Œå› ä¸ºçˆ¶å­æ‹¥æœ‰åŒä¸€ä¸ªå±æ€§çš„æƒ…å†µåœ¨ä¸Šé¢å¤„ç†çˆ¶é€‰é¡¹æ—¶å·²ç»å¤„ç†è¿‡äº†ï¼Œç”¨çš„å­é€‰é¡¹çš„å€¼
  for (key in child) {
    if (!hasOwn(parent, key)) {
      mergeField(key)
    }
  }

  // åˆå¹¶é€‰é¡¹ï¼ŒchildVal ä¼˜å…ˆçº§é«˜äº parentVal
  function mergeField (key) {
    // strats = Object.create(null)
    const strat = strats[key] || defaultStrat
    // å€¼ä¸ºå¦‚æœ childVal å­˜åœ¨åˆ™ä¼˜å…ˆä½¿ç”¨ childValï¼Œå¦åˆ™ä½¿ç”¨ parentVal
    options[key] = strat(parent[key], child[key], vm, key)
  }
  return options
}

å¤åˆ¶ä»£ç 
```

## initInjections

> /src/core/instance/inject.js

```javascript
/**
 * åˆå§‹åŒ– inject é…ç½®é¡¹
 *   1ã€å¾—åˆ° result[key] = val
 *   2ã€å¯¹ç»“æœæ•°æ®è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œä»£ç†æ¯ä¸ª key åˆ° vm å®ä¾‹
 */
export function initInjections (vm: Component) {
  // è§£æ inject é…ç½®é¡¹ï¼Œç„¶åä»ç¥–ä»£ç»„ä»¶çš„é…ç½®ä¸­æ‰¾åˆ° é…ç½®é¡¹ä¸­æ¯ä¸€ä¸ª key å¯¹åº”çš„ valï¼Œæœ€åå¾—åˆ° result[key] = val çš„ç»“æœ
  const result = resolveInject(vm.$options.inject, vm)
  // å¯¹ result åš æ•°æ®å“åº”å¼å¤„ç†ï¼Œä¹Ÿæœ‰ä»£ç† inject é…ç½®ä¸­æ¯ä¸ª key åˆ° vm å®ä¾‹çš„ä½œç”¨ã€‚
  // ä¸ä¸å»ºè®®åœ¨å­ç»„ä»¶å»æ›´æ”¹è¿™äº›æ•°æ®ï¼Œå› ä¸ºä¸€æ—¦ç¥–ä»£ç»„ä»¶ä¸­ æ³¨å…¥çš„ provide å‘ç”Ÿæ›´æ”¹ï¼Œä½ åœ¨ç»„ä»¶ä¸­åšçš„æ›´æ”¹å°±ä¼šè¢«è¦†ç›–
  if (result) {
    toggleObserving(false)
    Object.keys(result).forEach(key => {
      /* istanbul ignore else */
      if (process.env.NODE_ENV !== 'production') {
        defineReactive(vm, key, result[key], () => {
          warn(
            `Avoid mutating an injected value directly since the changes will be ` +
            `overwritten whenever the provided component re-renders. ` +
            `injection being mutated: "${key}"`,
            vm
          )
        })
      } else {
        defineReactive(vm, key, result[key])
      }
    })
    toggleObserving(true)
  }
}

å¤åˆ¶ä»£ç 
```

## resolveInject

> /src/core/instance/inject.js

```javascript
/**
 * è§£æ inject é…ç½®é¡¹ï¼Œä»ç¥–ä»£ç»„ä»¶çš„ provide é…ç½®ä¸­æ‰¾åˆ° key å¯¹åº”çš„å€¼ï¼Œå¦åˆ™ç”¨ é»˜è®¤å€¼ï¼Œæœ€åå¾—åˆ° result[key] = val
 * inject å¯¹è±¡è‚¯å®šæ˜¯ä»¥ä¸‹è¿™ä¸ªç»“æ„ï¼Œå› ä¸ºåœ¨ åˆå¹¶ é€‰é¡¹æ—¶å¯¹ç»„ä»¶é…ç½®å¯¹è±¡åšäº†æ ‡å‡†åŒ–å¤„ç†
 * @param {*} inject = {
 *  key: {
 *    from: provideKey,
 *    default: xx
 *  }
 * }
 */
export function resolveInject (inject: any, vm: Component): ?Object {
  if (inject) {
    // inject is :any because flow is not smart enough to figure out cached
    const result = Object.create(null)
    // inject é…ç½®é¡¹çš„æ‰€æœ‰çš„ key
    const keys = hasSymbol
      ? Reflect.ownKeys(inject)
      : Object.keys(inject)

    // éå† key
    for (let i = 0; i < keys.length; i++) {
      const key = keys[i]
      // è·³è¿‡ __ob__ å¯¹è±¡
      // #6574 in case the inject object is observed...
      if (key === '__ob__') continue
      // æ‹¿åˆ° provide ä¸­å¯¹åº”çš„ key
      const provideKey = inject[key].from
      let source = vm
      // éå†æ‰€æœ‰çš„ç¥–ä»£ç»„ä»¶ï¼Œç›´åˆ° æ ¹ç»„ä»¶ï¼Œæ‰¾åˆ° provide ä¸­å¯¹åº” key çš„å€¼ï¼Œæœ€åå¾—åˆ° result[key] = provide[provideKey]
      while (source) {
        if (source._provided && hasOwn(source._provided, provideKey)) {
          result[key] = source._provided[provideKey]
          break
        }
        source = source.$parent
      }
      // å¦‚æœä¸Šä¸€ä¸ªå¾ªç¯æœªæ‰¾åˆ°ï¼Œåˆ™é‡‡ç”¨ inject[key].defaultï¼Œå¦‚æœæ²¡æœ‰è®¾ç½® default å€¼ï¼Œåˆ™æŠ›å‡ºé”™è¯¯
      if (!source) {
        if ('default' in inject[key]) {
          const provideDefault = inject[key].default
          result[key] = typeof provideDefault === 'function'
            ? provideDefault.call(vm)
            : provideDefault
        } else if (process.env.NODE_ENV !== 'production') {
          warn(`Injection "${key}" not found`, vm)
        }
      }
    }
    return result
  }
}

å¤åˆ¶ä»£ç 
```

## initProvide

> /src/core/instance/inject.js

```javascript
/**
 * è§£æç»„ä»¶é…ç½®é¡¹ä¸Šçš„ provide å¯¹è±¡ï¼Œå°†å…¶æŒ‚è½½åˆ° vm._provided å±æ€§ä¸Š 
 */
export function initProvide (vm: Component) {
  const provide = vm.$options.provide
  if (provide) {
    vm._provided = typeof provide === 'function'
      ? provide.call(vm)
      : provide
  }
}

å¤åˆ¶ä»£ç 
```

# æ€»ç»“

Vue çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼ˆnew Vue(options)ï¼‰éƒ½åšäº†ä»€ä¹ˆï¼Ÿ

- å¤„ç†ç»„ä»¶é…ç½®é¡¹
  - åˆå§‹åŒ–æ ¹ç»„ä»¶æ—¶è¿›è¡Œäº†é€‰é¡¹åˆå¹¶æ“ä½œï¼Œå°†å…¨å±€é…ç½®åˆå¹¶åˆ°æ ¹ç»„ä»¶çš„å±€éƒ¨é…ç½®ä¸Š
  - åˆå§‹åŒ–æ¯ä¸ªå­ç»„ä»¶æ—¶åšäº†ä¸€äº›æ€§èƒ½ä¼˜åŒ–ï¼Œå°†ç»„ä»¶é…ç½®å¯¹è±¡ä¸Šçš„ä¸€äº›æ·±å±‚æ¬¡å±æ€§æ”¾åˆ° vm.$options é€‰é¡¹ä¸­ï¼Œä»¥æé«˜ä»£ç çš„æ‰§è¡Œæ•ˆç‡
- åˆå§‹åŒ–ç»„ä»¶å®ä¾‹çš„å…³ç³»å±æ€§ï¼Œæ¯”å¦‚ $parentã€$childrenã€$rootã€$refs ç­‰
- å¤„ç†è‡ªå®šä¹‰äº‹ä»¶
- è°ƒç”¨ beforeCreate é’©å­å‡½æ•°
- åˆå§‹åŒ–ç»„ä»¶çš„ inject é…ç½®é¡¹ï¼Œå¾—åˆ° `ret[key] = val` å½¢å¼çš„é…ç½®å¯¹è±¡ï¼Œç„¶åå¯¹è¯¥é…ç½®å¯¹è±¡è¿›è¡Œæµ…å±‚çš„å“åº”å¼å¤„ç†ï¼ˆåªå¤„ç†äº†å¯¹è±¡ç¬¬ä¸€å±‚æ•°æ®ï¼‰ï¼Œå¹¶ä»£ç†æ¯ä¸ª key åˆ° vm å®ä¾‹ä¸Š
- æ•°æ®å“åº”å¼ï¼Œå¤„ç† propsã€methodsã€dataã€computedã€watch ç­‰é€‰é¡¹
- è§£æç»„ä»¶é…ç½®é¡¹ä¸Šçš„ provide å¯¹è±¡ï¼Œå°†å…¶æŒ‚è½½åˆ° vm._provided å±æ€§ä¸Š
- è°ƒç”¨ created é’©å­å‡½æ•°
- å¦‚æœå‘ç°é…ç½®é¡¹ä¸Šæœ‰ el é€‰é¡¹ï¼Œåˆ™è‡ªåŠ¨è°ƒç”¨ $mount æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰äº† el é€‰é¡¹ï¼Œå°±ä¸éœ€è¦å†æ‰‹åŠ¨è°ƒç”¨ $mount æ–¹æ³•ï¼Œåä¹‹ï¼Œæ²¡æä¾› el é€‰é¡¹åˆ™å¿…é¡»è°ƒç”¨ $mount
- æ¥ä¸‹æ¥åˆ™è¿›å…¥æŒ‚è½½é˜¶æ®µ

# é“¾æ¥

- [é…å¥—è§†é¢‘ï¼Œå…³æ³¨å¾®ä¿¡å…¬ä¼—å·å›å¤](https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fliyongning%2Ftypora-image-bed%2Fraw%2Fmaster%2F202202171742614.jpg)ï¼š"ç²¾é€š Vue æŠ€æœ¯æ ˆæºç åŸç†è§†é¢‘ç‰ˆ" è·å–
- [ç²¾é€š Vue æŠ€æœ¯æ ˆæºç åŸç† ä¸“æ ](https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzA3NTk4NjQ1OQ%3D%3D%26action%3Dgetalbum%26album_id%3D2273541436891693065%23wechat_redirect)
- [github ä»“åº“ liyongning/Vue](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyongning%2FVue) æ¬¢è¿ Star

æ„Ÿè°¢å„ä½çš„ï¼š**ç‚¹èµ**ã€**æ”¶è—**å’Œ**è¯„è®º**ï¼Œæˆ‘ä»¬ä¸‹æœŸè§ã€‚



ä½œè€…ï¼šææ°¸å®
é“¾æ¥ï¼šhttps://juejin.cn/post/6950084496515399717
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚